{"version":3,"file":"excalibur.min.js","mappings":"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,KAAKw/F,YAGH3vC,eAAWx4D,GACpB2I,KAAKw/F,YAAcnoG,EAGVm5D,yBACT,OAAOxwD,KAAKy/F,oBAGHjvC,uBAAmBn5D,GAC5B2I,KAAKy/F,oBAAsBpoG,EAGlB83D,iBACT,OAAOnvD,KAAK0/F,YAGHvwC,eAAW93D,GACpB2I,KAAK0/F,YAAcroG,EAGVo5D,kBACT,OAAOzwD,KAAK2/F,aAGHlvC,gBAAYp5D,GACrB2I,KAAK2/F,aAAetoG,GCzkBxB,IAAYwoG,GCGAC,GCmTAC,GAsEAC,GC/XAC,GCEAC,GCAAC,GCAAC,INCZ,SAAYP,GAKV,kBAKA,sBAVF,CAAYA,KAAAA,GAAY,KCGxB,SAAYC,GAEV,iBACA,iBACA,iBACA,iBACA,iBACA,iBACA,iBACA,iBACA,iBACA,iBACA,qBACA,+BACA,+BACA,2BAEA,6BACA,oBACA,oBACA,oBACA,oBACA,oBACA,oBACA,oBACA,oBACA,oBACA,oBACA,wBACA,kCACA,kCACA,8BAEA,gCAGA,oBACA,wBACA,0BACA,oBACA,sBACA,4BACA,8BACA,sBACA,wBAGA,gBACA,gBACA,gBACA,gBACA,gBACA,gBACA,gBACA,gBACA,gBACA,gBACA,kBACA,kBACA,kBACA,kBACA,kBACA,kBACA,kBACA,kBACA,kBACA,kBAGA,UACA,UACA,UACA,UACA,UACA,UACA,UACA,UACA,UACA,YACA,YACA,YAGA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cAGA,wBACA,gBACA,gBACA,gBACA,kBACA,gBACA,gBACA,4BACA,wBACA,8BACA,wBAGA,eACA,mBACA,mBACA,qBACA,oBACA,wBACA,wBACA,0BAGA,gBACA,wBACA,kBACA,eACA,k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","sources":["webpack://ex/webpack/universalModuleDefinition","webpack://ex/../../node_modules/core-js/es/array/sort.js","webpack://ex/../../node_modules/core-js/es/object/keys.js","webpack://ex/../../node_modules/core-js/internals/a-callable.js","webpack://ex/../../node_modules/core-js/internals/an-object.js","webpack://ex/../../node_modules/core-js/internals/array-includes.js","webpack://ex/../../node_modules/core-js/internals/array-method-is-strict.js","webpack://ex/../../node_modules/core-js/internals/array-slice-simple.js","webpack://ex/../../node_modules/core-js/internals/array-sort.js","webpack://ex/../../node_modules/core-js/internals/classof-raw.js","webpack://ex/../../node_modules/core-js/internals/classof.js","webpack://ex/../../node_modules/core-js/internals/copy-constructor-properties.js","webpack://ex/../../node_modules/core-js/internals/create-non-enumerable-property.js","webpack://ex/../../node_modules/core-js/internals/create-property-descriptor.js","webpack://ex/../../node_modules/core-js/internals/create-property.js","webpack://ex/../../node_modules/core-js/internals/define-built-in.js","webpack://ex/../../node_modules/core-js/internals/define-global-property.js","webpack://ex/../../node_modules/core-js/internals/delete-property-or-throw.js","webpack://ex/../../node_modules/core-js/internals/descriptors.js","webpack://ex/../../node_modules/core-js/internals/document-create-element.js","webpack://ex/../../node_modules/core-js/internals/engine-ff-version.js","webpack://ex/../../node_modules/core-js/internals/engine-is-ie-or-edge.js","webpack://ex/../../node_modules/core-js/internals/engine-user-agent.js","webpack://ex/../../node_modules/core-js/internals/engine-v8-version.js","webpack://ex/../../node_modules/core-js/internals/engine-webkit-version.js","webpack://ex/../../node_modules/core-js/internals/entry-unbind.js","webpack://ex/../../node_modules/core-js/internals/enum-bug-keys.js","webpack://ex/../../node_modules/core-js/internals/export.js","webpack://ex/../../node_modules/core-js/internals/fails.js","webpack://ex/../../node_modules/core-js/internals/function-bind-native.js","webpack://ex/../../node_modules/core-js/internals/function-call.js","webpack://ex/../../node_modules/core-js/internals/function-name.js","webpack://ex/../../node_modules/core-js/internals/function-uncurry-this.js","webpack://ex/../../node_modules/core-js/internals/get-built-in.js","webpack://ex/../../node_modules/core-js/internals/get-method.js","webpack://ex/../../node_modules/core-js/internals/global.js","webpack://ex/../../node_modules/core-js/internals/has-own-property.js","webpack://ex/../../node_modules/core-js/internals/hidden-keys.js","webpack://ex/../../node_modules/core-js/internals/ie8-dom-define.js","webpack://ex/../../node_modules/core-js/internals/indexed-object.js","webpack://ex/../../node_modules/core-js/internals/inspect-source.js","webpack://ex/../../node_modules/core-js/internals/internal-state.js","webpack://ex/../../node_modules/core-js/internals/is-callable.js","webpack://ex/../../node_modules/core-js/internals/is-forced.js","webpack://ex/../../node_modules/core-js/internals/is-object.js","webpack://ex/../../node_modules/core-js/internals/is-pure.js","webpack://ex/../../node_modules/core-js/internals/is-symbol.js","webpack://ex/../../node_modules/core-js/internals/length-of-array-like.js","webpack://ex/../../node_modules/core-js/internals/make-built-in.js","webpack://ex/../../node_modules/core-js/internals/math-trunc.js","webpack://ex/../../node_modules/core-js/internals/native-symbol.js","webpack://ex/../../node_modules/core-js/internals/native-weak-map.js","webpack://ex/../../node_modules/core-js/internals/object-define-property.js","webpack://ex/../../node_modules/core-js/internals/object-get-own-property-descriptor.js","webpack://ex/../../node_modules/core-js/internals/object-get-own-property-names.js","webpack://ex/../../node_modules/core-js/internals/object-get-own-property-symbols.js","webpack://ex/../../node_modules/core-js/internals/object-is-prototype-of.js","webpack://ex/../../node_modules/core-js/internals/object-keys-internal.js","webpack://ex/../../node_modules/core-js/internals/object-keys.js","webpack://ex/../../node_modules/core-js/internals/object-property-is-enumerable.js","webpack://ex/../../node_modules/core-js/internals/ordinary-to-primitive.js","webpack://ex/../../node_modules/core-js/internals/own-keys.js","webpack://ex/../../node_modules/core-js/internals/path.js","webpack://ex/../../node_modules/core-js/internals/require-object-coercible.js","webpack://ex/../../node_modules/core-js/internals/shared-key.js","webpack://ex/../../node_modules/core-js/internals/shared-store.js","webpack://ex/../../node_modules/core-js/internals/shared.js","webpack://ex/../../node_modules/core-js/internals/to-absolute-index.js","webpack://ex/../../node_modules/core-js/internals/to-indexed-object.js","webpack://ex/../../node_modules/core-js/internals/to-integer-or-infinity.js","webpack://ex/../../node_modules/core-js/internals/to-length.js","webpack://ex/../../node_modules/core-js/internals/to-object.js","webpack://ex/../../node_modules/core-js/internals/to-primitive.js","webpack://ex/../../node_modules/core-js/internals/to-property-key.js","webpack://ex/../../node_modules/core-js/internals/to-string-tag-support.js","webpack://ex/../../node_modules/core-js/internals/to-string.js","webpack://ex/../../node_modules/core-js/internals/try-to-string.js","webpack://ex/../../node_modules/core-js/internals/uid.js","webpack://ex/../../node_modules/core-js/internals/use-symbol-as-uid.js","webpack://ex/../../node_modules/core-js/internals/v8-prototype-define-bug.js","webpack://ex/../../node_modules/core-js/internals/well-known-symbol.js","webpack://ex/../../node_modules/core-js/modules/es.array.sort.js","webpack://ex/../../node_modules/core-js/modules/es.object.keys.js","webpack://ex/./Loader.css","webpack://ex/./Util/Toaster.css","webpack://ex/../../node_modules/css-loader/dist/runtime/api.js","webpack://ex/../../node_modules/css-loader/dist/runtime/sourceMaps.js","webpack://ex/webpack/bootstrap","webpack://ex/webpack/runtime/compat get default export","webpack://ex/webpack/runtime/define property getters","webpack://ex/webpack/runtime/global","webpack://ex/webpack/runtime/hasOwnProperty shorthand","webpack://ex/webpack/runtime/make namespace object","webpack://ex/./Polyfill.ts","webpack://ex/./Flags.ts","webpack://ex/./Id.ts","webpack://ex/./Math/Random.ts","webpack://ex/./Math/util.ts","webpack://ex/./Math/vector.ts","webpack://ex/./Util/Log.ts","webpack://ex/./Collision/Side.ts","webpack://ex/./Math/matrix.ts","webpack://ex/./Events.ts","webpack://ex/./Graphics/Filtering.ts","webpack://ex/./Color.ts","webpack://ex/./Collision/BoundingBox.ts","webpack://ex/./Util/Future.ts","webpack://ex/./Util/Util.ts","webpack://ex/./Math/affine-matrix.ts","webpack://ex/./Graphics/Context/transform-stack.ts","webpack://ex/./Graphics/Context/state-stack.ts","webpack://ex/./EventDispatcher.ts","webpack://ex/./Resources/Resource.ts","webpack://ex/./Util/Watch.ts","webpack://ex/./Graphics/Graphic.ts","webpack://ex/./Graphics/Sprite.ts","webpack://ex/./Graphics/Context/texture-loader.ts","webpack://ex/./Graphics/ImageSource.ts","webpack://ex/./Graphics/SpriteSheet.ts","webpack://ex/./Graphics/SpriteFont.ts","webpack://ex/./Graphics/Context/debug-text.ts","webpack://ex/./Graphics/Context/debug-font.png","webpack://ex/./Graphics/Context/render-source.ts","webpack://ex/./Graphics/Context/render-target.ts","webpack://ex/./Graphics/Context/webgl-adapter.ts","webpack://ex/./Graphics/Context/webgl-util.ts","webpack://ex/./Graphics/Context/shader.ts","webpack://ex/./Graphics/Context/vertex-buffer.ts","webpack://ex/./Graphics/Context/vertex-layout.ts","webpack://ex/./Graphics/GraphicsDiagnostics.ts","webpack://ex/./Graphics/Context/line-renderer/line-renderer.ts","webpack://ex/./Graphics/Context/line-renderer/line-vertex.glsl","webpack://ex/./Graphics/Context/line-renderer/line-fragment.glsl","webpack://ex/./Graphics/Context/point-renderer/point-renderer.ts","webpack://ex/./Graphics/Context/point-renderer/point-vertex.glsl","webpack://ex/./Graphics/Context/point-renderer/point-fragment.glsl","webpack://ex/./Graphics/Context/screen-pass-painter/screen-pass-painter.ts","webpack://ex/./Graphics/Context/screen-pass-painter/screen-vertex.glsl","webpack://ex/./Graphics/Context/screen-pass-painter/screen-fragment.glsl","webpack://ex/./Graphics/Context/quad-index-buffer.ts","webpack://ex/./Graphics/Context/image-renderer/image-renderer.ts","webpack://ex/./Graphics/Context/image-renderer/image-renderer.frag.glsl","webpack://ex/./Graphics/Context/image-renderer/image-renderer.vert.glsl","webpack://ex/./Graphics/Context/rectangle-renderer/rectangle-renderer.ts","webpack://ex/./Graphics/Context/rectangle-renderer/rectangle-renderer.frag.glsl","webpack://ex/./Graphics/Context/rectangle-renderer/rectangle-renderer.vert.glsl","webpack://ex/./Graphics/Context/circle-renderer/circle-renderer.ts","webpack://ex/./Graphics/Context/circle-renderer/circle-renderer.frag.glsl","webpack://ex/./Graphics/Context/circle-renderer/circle-renderer.vert.glsl","webpack://ex/./Util/Pool.ts","webpack://ex/./Graphics/Context/draw-call.ts","webpack://ex/./Graphics/Context/ExcaliburGraphicsContextWebGL.ts","webpack://ex/./Graphics/Context/ExcaliburGraphicsContext2DCanvas.ts","webpack://ex/./Screen.ts","webpack://ex/./Resources/Sound/AudioContext.ts","webpack://ex/./Util/WebAudio.ts","webpack://ex/./Class.ts","webpack://ex/./Util/DrawUtil.ts","webpack://ex/./Graphics/Raster.ts","webpack://ex/./Graphics/Canvas.ts","webpack://ex/./Interfaces/AudioImplementation.ts","webpack://ex/./Util/StateMachine.ts","webpack://ex/./Resources/Sound/WebAudioInstance.ts","webpack://ex/./Events/MediaEvents.ts","webpack://ex/./Util/Sound.ts","webpack://ex/./Resources/Sound/Sound.ts","webpack://ex/./Loader.ts","webpack://ex/./Loader.logo.png","webpack://ex/./Util/Detector.ts","webpack://ex/./Collision/CollisionType.ts","webpack://ex/./Util/Decorators.ts","webpack://ex/./Collision/Physics.ts","webpack://ex/./Math/coord-plane.ts","webpack://ex/./Math/vector-view.ts","webpack://ex/./Math/watch-vector.ts","webpack://ex/./Math/transform.ts","webpack://ex/./EntityComponentSystem/Component.ts","webpack://ex/./Util/Observable.ts","webpack://ex/./EntityComponentSystem/Components/TransformComponent.ts","webpack://ex/./EntityComponentSystem/Components/MotionComponent.ts","webpack://ex/./Collision/Group/CollisionGroup.ts","webpack://ex/./Collision/Detection/Pair.ts","webpack://ex/./Math/projection.ts","webpack://ex/./Collision/Detection/DynamicTree.ts","webpack://ex/./Math/ray.ts","webpack://ex/./Collision/Detection/DynamicTreeCollisionProcessor.ts","webpack://ex/./Collision/Colliders/Collider.ts","webpack://ex/./Collision/Colliders/CompositeCollider.ts","webpack://ex/./Math/line-segment.ts","webpack://ex/./Collision/Colliders/ClosestLineJumpTable.ts","webpack://ex/./Collision/Colliders/CircleCollider.ts","webpack://ex/./Collision/Detection/CollisionContact.ts","webpack://ex/./Collision/Colliders/SeparatingAxis.ts","webpack://ex/./Collision/Colliders/CollisionJumpTable.ts","webpack://ex/./Collision/Colliders/EdgeCollider.ts","webpack://ex/./Collision/Colliders/PolygonCollider.ts","webpack://ex/./Collision/Colliders/Shape.ts","webpack://ex/./Collision/ColliderComponent.ts","webpack://ex/./Collision/BodyComponent.ts","webpack://ex/./Actions/RotationType.ts","webpack://ex/./Graphics/FontCommon.ts","webpack://ex/./Camera.ts","webpack://ex/./EntityComponentSystem/Entity.ts","webpack://ex/./Graphics/GraphicsComponent.ts","webpack://ex/./Graphics/Rectangle.ts","webpack://ex/./Graphics/Circle.ts","webpack://ex/./Input/PointerComponent.ts","webpack://ex/./Util/EasingFunctions.ts","webpack://ex/./Actions/ActionQueue.ts","webpack://ex/./Actions/Action/Repeat.ts","webpack://ex/./Actions/Action/RepeatForever.ts","webpack://ex/./Actions/Action/MoveBy.ts","webpack://ex/./Actions/Action/MoveTo.ts","webpack://ex/./Actions/Action/RotateTo.ts","webpack://ex/./Actions/Action/RotateBy.ts","webpack://ex/./Actions/Action/ScaleTo.ts","webpack://ex/./Actions/Action/ScaleBy.ts","webpack://ex/./Actions/Action/CallMethod.ts","webpack://ex/./Actions/Action/EaseTo.ts","webpack://ex/./Actions/Action/EaseBy.ts","webpack://ex/./Actions/Action/Blink.ts","webpack://ex/./Actions/Action/Fade.ts","webpack://ex/./Actions/Action/Delay.ts","webpack://ex/./Actions/Action/Die.ts","webpack://ex/./Actions/Action/Follow.ts","webpack://ex/./Actions/Action/Meet.ts","webpack://ex/./Actions/ActionContext.ts","webpack://ex/./Actions/ActionsComponent.ts","webpack://ex/./Graphics/Font.ts","webpack://ex/./Graphics/Text.ts","webpack://ex/./Actor.ts","webpack://ex/./ScreenElement.ts","webpack://ex/./Timer.ts","webpack://ex/./Graphics/ParallaxComponent.ts","webpack://ex/./Graphics/DebugGraphicsComponent.ts","webpack://ex/./TileMap/TileMap.ts","webpack://ex/./Trigger.ts","webpack://ex/./EntityComponentSystem/System.ts","webpack://ex/./EntityComponentSystem/EntityManager.ts","webpack://ex/./EntityComponentSystem/Util.ts","webpack://ex/./EntityComponentSystem/Query.ts","webpack://ex/./EntityComponentSystem/QueryManager.ts","webpack://ex/./EntityComponentSystem/SystemManager.ts","webpack://ex/./EntityComponentSystem/World.ts","webpack://ex/./Collision/Integrator.ts","webpack://ex/./Collision/MotionSystem.ts","webpack://ex/./Collision/Solver/ArcadeSolver.ts","webpack://ex/./Collision/Solver/ContactConstraintPoint.ts","webpack://ex/./Collision/Solver/RealisticSolver.ts","webpack://ex/./Collision/CollisionSystem.ts","webpack://ex/./Graphics/Animation.ts","webpack://ex/./Particles.ts","webpack://ex/./Graphics/PostProcessor/ColorBlindnessMode.ts","webpack://ex/./Graphics/GraphicsGroup.ts","webpack://ex/./Configurable.ts","webpack://ex/./Graphics/GraphicsSystem.ts","webpack://ex/./Debug/DebugSystem.ts","webpack://ex/./Input/PointerSystem.ts","webpack://ex/./Actions/ActionsSystem.ts","webpack://ex/./TileMap/IsometricEntityComponent.ts","webpack://ex/./TileMap/IsometricEntitySystem.ts","webpack://ex/./Graphics/OffscreenSystem.ts","webpack://ex/./Scene.ts","webpack://ex/./Graphics/PostProcessor/ScreenShader.ts","webpack://ex/./Graphics/PostProcessor/ColorBlindnessPostProcessor.ts","webpack://ex/./Graphics/PostProcessor/color-blind-fragment.glsl","webpack://ex/./Debug/DebugFlags.ts","webpack://ex/./Debug/Debug.ts","webpack://ex/./Input/PointerScope.ts","webpack://ex/./Input/Keyboard.ts","webpack://ex/./Input/Gamepad.ts","webpack://ex/./Input/WheelDeltaMode.ts","webpack://ex/./Input/NativePointerButton.ts","webpack://ex/./Input/PointerButton.ts","webpack://ex/./Input/PointerType.ts","webpack://ex/./Util/Browser.ts","webpack://ex/./Math/global-coordinates.ts","webpack://ex/./Input/PointerEvent.ts","webpack://ex/./Input/WheelEvent.ts","webpack://ex/./Input/PointerAbstraction.ts","webpack://ex/./Input/PointerEventReceiver.ts","webpack://ex/./Util/Fps.ts","webpack://ex/./Util/Clock.ts","webpack://ex/./Engine.ts","webpack://ex/./Util/Toaster.ts","webpack://ex/./Label.ts","webpack://ex/./TileMap/IsometricMap.ts","webpack://ex/./Actions/Action/ActionSequence.ts","webpack://ex/./Actions/Action/ParallelActions.ts","webpack://ex/./Collision/Group/CollisionGroupManager.ts","webpack://ex/./Interfaces/LifecycleEvents.ts","webpack://ex/./Resources/Gif.ts","webpack://ex/./Graphics/Line.ts","webpack://ex/./Graphics/Polygon.ts","webpack://ex/./Util/Semaphore.ts","webpack://ex/./index.ts"],"sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"ex\"] = factory();\n\telse\n\t\troot[\"ex\"] = factory();\n})(self, () => {\nreturn ","require('../../modules/es.array.sort');\nvar entryUnbind = require('../../internals/entry-unbind');\n\nmodule.exports = entryUnbind('Array', 'sort');\n","require('../../modules/es.object.keys');\nvar path = require('../../internals/path');\n\nmodule.exports = path.Object.keys;\n","var isCallable = require('../internals/is-callable');\nvar tryToString = require('../internals/try-to-string');\n\nvar $TypeError = TypeError;\n\n// `Assert: IsCallable(argument) is true`\nmodule.exports = function (argument) {\n  if (isCallable(argument)) return argument;\n  throw $TypeError(tryToString(argument) + ' is not a function');\n};\n","var isObject = require('../internals/is-object');\n\nvar $String = String;\nvar $TypeError = TypeError;\n\n// `Assert: Type(argument) is Object`\nmodule.exports = function (argument) {\n  if (isObject(argument)) return argument;\n  throw $TypeError($String(argument) + ' is not an object');\n};\n","var toIndexedObject = require('../internals/to-indexed-object');\nvar toAbsoluteIndex = require('../internals/to-absolute-index');\nvar lengthOfArrayLike = require('../internals/length-of-array-like');\n\n// `Array.prototype.{ indexOf, includes }` methods implementation\nvar createMethod = function (IS_INCLUDES) {\n  return function ($this, el, fromIndex) {\n    var O = toIndexedObject($this);\n    var length = lengthOfArrayLike(O);\n    var index = toAbsoluteIndex(fromIndex, length);\n    var value;\n    // Array#includes uses SameValueZero equality algorithm\n    // eslint-disable-next-line no-self-compare -- NaN check\n    if (IS_INCLUDES && el != el) while (length > index) {\n      value = O[index++];\n      // eslint-disable-next-line no-self-compare -- NaN check\n      if (value != value) return true;\n    // Array#indexOf ignores holes, Array#includes - not\n    } else for (;length > index; index++) {\n      if ((IS_INCLUDES || index in O) && O[index] === el) return IS_INCLUDES || index || 0;\n    } return !IS_INCLUDES && -1;\n  };\n};\n\nmodule.exports = {\n  // `Array.prototype.includes` method\n  // https://tc39.es/ecma262/#sec-array.prototype.includes\n  includes: createMethod(true),\n  // `Array.prototype.indexOf` method\n  // https://tc39.es/ecma262/#sec-array.prototype.indexof\n  indexOf: createMethod(false)\n};\n","'use strict';\nvar fails = require('../internals/fails');\n\nmodule.exports = function (METHOD_NAME, argument) {\n  var method = [][METHOD_NAME];\n  return !!method && fails(function () {\n    // eslint-disable-next-line no-useless-call -- required for testing\n    method.call(null, argument || function () { return 1; }, 1);\n  });\n};\n","var toAbsoluteIndex = require('../internals/to-absolute-index');\nvar lengthOfArrayLike = require('../internals/length-of-array-like');\nvar createProperty = require('../internals/create-property');\n\nvar $Array = Array;\nvar max = Math.max;\n\nmodule.exports = function (O, start, end) {\n  var length = lengthOfArrayLike(O);\n  var k = toAbsoluteIndex(start, length);\n  var fin = toAbsoluteIndex(end === undefined ? length : end, length);\n  var result = $Array(max(fin - k, 0));\n  for (var n = 0; k < fin; k++, n++) createProperty(result, n, O[k]);\n  result.length = n;\n  return result;\n};\n","var arraySlice = require('../internals/array-slice-simple');\n\nvar floor = Math.floor;\n\nvar mergeSort = function (array, comparefn) {\n  var length = array.length;\n  var middle = floor(length / 2);\n  return length < 8 ? insertionSort(array, comparefn) : merge(\n    array,\n    mergeSort(arraySlice(array, 0, middle), comparefn),\n    mergeSort(arraySlice(array, middle), comparefn),\n    comparefn\n  );\n};\n\nvar insertionSort = function (array, comparefn) {\n  var length = array.length;\n  var i = 1;\n  var element, j;\n\n  while (i < length) {\n    j = i;\n    element = array[i];\n    while (j && comparefn(array[j - 1], element) > 0) {\n      array[j] = array[--j];\n    }\n    if (j !== i++) array[j] = element;\n  } return array;\n};\n\nvar merge = function (array, left, right, comparefn) {\n  var llength = left.length;\n  var rlength = right.length;\n  var lindex = 0;\n  var rindex = 0;\n\n  while (lindex < llength || rindex < rlength) {\n    array[lindex + rindex] = (lindex < llength && rindex < rlength)\n      ? comparefn(left[lindex], right[rindex]) <= 0 ? left[lindex++] : right[rindex++]\n      : lindex < llength ? left[lindex++] : right[rindex++];\n  } return array;\n};\n\nmodule.exports = mergeSort;\n","var uncurryThis = require('../internals/function-uncurry-this');\n\nvar toString = uncurryThis({}.toString);\nvar stringSlice = uncurryThis(''.slice);\n\nmodule.exports = function (it) {\n  return stringSlice(toString(it), 8, -1);\n};\n","var TO_STRING_TAG_SUPPORT = require('../internals/to-string-tag-support');\nvar isCallable = require('../internals/is-callable');\nvar classofRaw = require('../internals/classof-raw');\nvar wellKnownSymbol = require('../internals/well-known-symbol');\n\nvar TO_STRING_TAG = wellKnownSymbol('toStringTag');\nvar $Object = Object;\n\n// ES3 wrong here\nvar CORRECT_ARGUMENTS = classofRaw(function () { return arguments; }()) == 'Arguments';\n\n// fallback for IE11 Script Access Denied error\nvar tryGet = function (it, key) {\n  try {\n    return it[key];\n  } catch (error) { /* empty */ }\n};\n\n// getting tag from ES6+ `Object.prototype.toString`\nmodule.exports = TO_STRING_TAG_SUPPORT ? classofRaw : function (it) {\n  var O, tag, result;\n  return it === undefined ? 'Undefined' : it === null ? 'Null'\n    // @@toStringTag case\n    : typeof (tag = tryGet(O = $Object(it), TO_STRING_TAG)) == 'string' ? tag\n    // builtinTag case\n    : CORRECT_ARGUMENTS ? classofRaw(O)\n    // ES3 arguments fallback\n    : (result = classofRaw(O)) == 'Object' && isCallable(O.callee) ? 'Arguments' : result;\n};\n","var hasOwn = require('../internals/has-own-property');\nvar ownKeys = require('../internals/own-keys');\nvar getOwnPropertyDescriptorModule = require('../internals/object-get-own-property-descriptor');\nvar definePropertyModule = require('../internals/object-define-property');\n\nmodule.exports = function (target, source, exceptions) {\n  var keys = ownKeys(source);\n  var defineProperty = definePropertyModule.f;\n  var getOwnPropertyDescriptor = getOwnPropertyDescriptorModule.f;\n  for (var i = 0; i < keys.length; i++) {\n    var key = keys[i];\n    if (!hasOwn(target, key) && !(exceptions && hasOwn(exceptions, key))) {\n      defineProperty(target, key, getOwnPropertyDescriptor(source, key));\n    }\n  }\n};\n","var DESCRIPTORS = require('../internals/descriptors');\nvar definePropertyModule = require('../internals/object-define-property');\nvar createPropertyDescriptor = require('../internals/create-property-descriptor');\n\nmodule.exports = DESCRIPTORS ? function (object, key, value) {\n  return definePropertyModule.f(object, key, createPropertyDescriptor(1, value));\n} : function (object, key, value) {\n  object[key] = value;\n  return object;\n};\n","module.exports = function (bitmap, value) {\n  return {\n    enumerable: !(bitmap & 1),\n    configurable: !(bitmap & 2),\n    writable: !(bitmap & 4),\n    value: value\n  };\n};\n","'use strict';\nvar toPropertyKey = require('../internals/to-property-key');\nvar definePropertyModule = require('../internals/object-define-property');\nvar createPropertyDescriptor = require('../internals/create-property-descriptor');\n\nmodule.exports = function (object, key, value) {\n  var propertyKey = toPropertyKey(key);\n  if (propertyKey in object) definePropertyModule.f(object, propertyKey, createPropertyDescriptor(0, value));\n  else object[propertyKey] = value;\n};\n","var isCallable = require('../internals/is-callable');\nvar definePropertyModule = require('../internals/object-define-property');\nvar makeBuiltIn = require('../internals/make-built-in');\nvar defineGlobalProperty = require('../internals/define-global-property');\n\nmodule.exports = function (O, key, value, options) {\n  if (!options) options = {};\n  var simple = options.enumerable;\n  var name = options.name !== undefined ? options.name : key;\n  if (isCallable(value)) makeBuiltIn(value, name, options);\n  if (options.global) {\n    if (simple) O[key] = value;\n    else defineGlobalProperty(key, value);\n  } else {\n    try {\n      if (!options.unsafe) delete O[key];\n      else if (O[key]) simple = true;\n    } catch (error) { /* empty */ }\n    if (simple) O[key] = value;\n    else definePropertyModule.f(O, key, {\n      value: value,\n      enumerable: false,\n      configurable: !options.nonConfigurable,\n      writable: !options.nonWritable\n    });\n  } return O;\n};\n","var global = require('../internals/global');\n\n// eslint-disable-next-line es-x/no-object-defineproperty -- safe\nvar defineProperty = Object.defineProperty;\n\nmodule.exports = function (key, value) {\n  try {\n    defineProperty(global, key, { value: value, configurable: true, writable: true });\n  } catch (error) {\n    global[key] = value;\n  } return value;\n};\n","'use strict';\nvar tryToString = require('../internals/try-to-string');\n\nvar $TypeError = TypeError;\n\nmodule.exports = function (O, P) {\n  if (!delete O[P]) throw $TypeError('Cannot delete property ' + tryToString(P) + ' of ' + tryToString(O));\n};\n","var fails = require('../internals/fails');\n\n// Detect IE8's incomplete defineProperty implementation\nmodule.exports = !fails(function () {\n  // eslint-disable-next-line es-x/no-object-defineproperty -- required for testing\n  return Object.defineProperty({}, 1, { get: function () { return 7; } })[1] != 7;\n});\n","var global = require('../internals/global');\nvar isObject = require('../internals/is-object');\n\nvar document = global.document;\n// typeof document.createElement is 'object' in old IE\nvar EXISTS = isObject(document) && isObject(document.createElement);\n\nmodule.exports = function (it) {\n  return EXISTS ? document.createElement(it) : {};\n};\n","var userAgent = require('../internals/engine-user-agent');\n\nvar firefox = userAgent.match(/firefox\\/(\\d+)/i);\n\nmodule.exports = !!firefox && +firefox[1];\n","var UA = require('../internals/engine-user-agent');\n\nmodule.exports = /MSIE|Trident/.test(UA);\n","var getBuiltIn = require('../internals/get-built-in');\n\nmodule.exports = getBuiltIn('navigator', 'userAgent') || '';\n","var global = require('../internals/global');\nvar userAgent = require('../internals/engine-user-agent');\n\nvar process = global.process;\nvar Deno = global.Deno;\nvar versions = process && process.versions || Deno && Deno.version;\nvar v8 = versions && versions.v8;\nvar match, version;\n\nif (v8) {\n  match = v8.split('.');\n  // in old Chrome, versions of V8 isn't V8 = Chrome / 10\n  // but their correct versions are not interesting for us\n  version = match[0] > 0 && match[0] < 4 ? 1 : +(match[0] + match[1]);\n}\n\n// BrowserFS NodeJS `process` polyfill incorrectly set `.v8` to `0.0`\n// so check `userAgent` even if `.v8` exists, but 0\nif (!version && userAgent) {\n  match = userAgent.match(/Edge\\/(\\d+)/);\n  if (!match || match[1] >= 74) {\n    match = userAgent.match(/Chrome\\/(\\d+)/);\n    if (match) version = +match[1];\n  }\n}\n\nmodule.exports = version;\n","var userAgent = require('../internals/engine-user-agent');\n\nvar webkit = userAgent.match(/AppleWebKit\\/(\\d+)\\./);\n\nmodule.exports = !!webkit && +webkit[1];\n","var global = require('../internals/global');\nvar uncurryThis = require('../internals/function-uncurry-this');\n\nmodule.exports = function (CONSTRUCTOR, METHOD) {\n  return uncurryThis(global[CONSTRUCTOR].prototype[METHOD]);\n};\n","// IE8- don't enum bug keys\nmodule.exports = [\n  'constructor',\n  'hasOwnProperty',\n  'isPrototypeOf',\n  'propertyIsEnumerable',\n  'toLocaleString',\n  'toString',\n  'valueOf'\n];\n","var global = require('../internals/global');\nvar getOwnPropertyDescriptor = require('../internals/object-get-own-property-descriptor').f;\nvar createNonEnumerableProperty = require('../internals/create-non-enumerable-property');\nvar defineBuiltIn = require('../internals/define-built-in');\nvar defineGlobalProperty = require('../internals/define-global-property');\nvar copyConstructorProperties = require('../internals/copy-constructor-properties');\nvar isForced = require('../internals/is-forced');\n\n/*\n  options.target         - name of the target object\n  options.global         - target is the global object\n  options.stat           - export as static methods of target\n  options.proto          - export as prototype methods of target\n  options.real           - real prototype method for the `pure` version\n  options.forced         - export even if the native feature is available\n  options.bind           - bind methods to the target, required for the `pure` version\n  options.wrap           - wrap constructors to preventing global pollution, required for the `pure` version\n  options.unsafe         - use the simple assignment of property instead of delete + defineProperty\n  options.sham           - add a flag to not completely full polyfills\n  options.enumerable     - export as enumerable property\n  options.dontCallGetSet - prevent calling a getter on target\n  options.name           - the .name of the function if it does not match the key\n*/\nmodule.exports = function (options, source) {\n  var TARGET = options.target;\n  var GLOBAL = options.global;\n  var STATIC = options.stat;\n  var FORCED, target, key, targetProperty, sourceProperty, descriptor;\n  if (GLOBAL) {\n    target = global;\n  } else if (STATIC) {\n    target = global[TARGET] || defineGlobalProperty(TARGET, {});\n  } else {\n    target = (global[TARGET] || {}).prototype;\n  }\n  if (target) for (key in source) {\n    sourceProperty = source[key];\n    if (options.dontCallGetSet) {\n      descriptor = getOwnPropertyDescriptor(target, key);\n      targetProperty = descriptor && descriptor.value;\n    } else targetProperty = target[key];\n    FORCED = isForced(GLOBAL ? key : TARGET + (STATIC ? '.' : '#') + key, options.forced);\n    // contained in target\n    if (!FORCED && targetProperty !== undefined) {\n      if (typeof sourceProperty == typeof targetProperty) continue;\n      copyConstructorProperties(sourceProperty, targetProperty);\n    }\n    // add a flag to not completely full polyfills\n    if (options.sham || (targetProperty && targetProperty.sham)) {\n      createNonEnumerableProperty(sourceProperty, 'sham', true);\n    }\n    defineBuiltIn(target, key, sourceProperty, options);\n  }\n};\n","module.exports = function (exec) {\n  try {\n    return !!exec();\n  } catch (error) {\n    return true;\n  }\n};\n","var fails = require('../internals/fails');\n\nmodule.exports = !fails(function () {\n  // eslint-disable-next-line es-x/no-function-prototype-bind -- safe\n  var test = (function () { /* empty */ }).bind();\n  // eslint-disable-next-line no-prototype-builtins -- safe\n  return typeof test != 'function' || test.hasOwnProperty('prototype');\n});\n","var NATIVE_BIND = require('../internals/function-bind-native');\n\nvar call = Function.prototype.call;\n\nmodule.exports = NATIVE_BIND ? call.bind(call) : function () {\n  return call.apply(call, arguments);\n};\n","var DESCRIPTORS = require('../internals/descriptors');\nvar hasOwn = require('../internals/has-own-property');\n\nvar FunctionPrototype = Function.prototype;\n// eslint-disable-next-line es-x/no-object-getownpropertydescriptor -- safe\nvar getDescriptor = DESCRIPTORS && Object.getOwnPropertyDescriptor;\n\nvar EXISTS = hasOwn(FunctionPrototype, 'name');\n// additional protection from minified / mangled / dropped function names\nvar PROPER = EXISTS && (function something() { /* empty */ }).name === 'something';\nvar CONFIGURABLE = EXISTS && (!DESCRIPTORS || (DESCRIPTORS && getDescriptor(FunctionPrototype, 'name').configurable));\n\nmodule.exports = {\n  EXISTS: EXISTS,\n  PROPER: PROPER,\n  CONFIGURABLE: CONFIGURABLE\n};\n","var NATIVE_BIND = require('../internals/function-bind-native');\n\nvar FunctionPrototype = Function.prototype;\nvar bind = FunctionPrototype.bind;\nvar call = FunctionPrototype.call;\nvar uncurryThis = NATIVE_BIND && bind.bind(call, call);\n\nmodule.exports = NATIVE_BIND ? function (fn) {\n  return fn && uncurryThis(fn);\n} : function (fn) {\n  return fn && function () {\n    return call.apply(fn, arguments);\n  };\n};\n","var global = require('../internals/global');\nvar isCallable = require('../internals/is-callable');\n\nvar aFunction = function (argument) {\n  return isCallable(argument) ? argument : undefined;\n};\n\nmodule.exports = function (namespace, method) {\n  return arguments.length < 2 ? aFunction(global[namespace]) : global[namespace] && global[namespace][method];\n};\n","var aCallable = require('../internals/a-callable');\n\n// `GetMethod` abstract operation\n// https://tc39.es/ecma262/#sec-getmethod\nmodule.exports = function (V, P) {\n  var func = V[P];\n  return func == null ? undefined : aCallable(func);\n};\n","var check = function (it) {\n  return it && it.Math == Math && it;\n};\n\n// https://github.com/zloirock/core-js/issues/86#issuecomment-115759028\nmodule.exports =\n  // eslint-disable-next-line es-x/no-global-this -- safe\n  check(typeof globalThis == 'object' && globalThis) ||\n  check(typeof window == 'object' && window) ||\n  // eslint-disable-next-line no-restricted-globals -- safe\n  check(typeof self == 'object' && self) ||\n  check(typeof global == 'object' && global) ||\n  // eslint-disable-next-line no-new-func -- fallback\n  (function () { return this; })() || Function('return this')();\n","var uncurryThis = require('../internals/function-uncurry-this');\nvar toObject = require('../internals/to-object');\n\nvar hasOwnProperty = uncurryThis({}.hasOwnProperty);\n\n// `HasOwnProperty` abstract operation\n// https://tc39.es/ecma262/#sec-hasownproperty\n// eslint-disable-next-line es-x/no-object-hasown -- safe\nmodule.exports = Object.hasOwn || function hasOwn(it, key) {\n  return hasOwnProperty(toObject(it), key);\n};\n","module.exports = {};\n","var DESCRIPTORS = require('../internals/descriptors');\nvar fails = require('../internals/fails');\nvar createElement = require('../internals/document-create-element');\n\n// Thanks to IE8 for its funny defineProperty\nmodule.exports = !DESCRIPTORS && !fails(function () {\n  // eslint-disable-next-line es-x/no-object-defineproperty -- required for testing\n  return Object.defineProperty(createElement('div'), 'a', {\n    get: function () { return 7; }\n  }).a != 7;\n});\n","var uncurryThis = require('../internals/function-uncurry-this');\nvar fails = require('../internals/fails');\nvar classof = require('../internals/classof-raw');\n\nvar $Object = Object;\nvar split = uncurryThis(''.split);\n\n// fallback for non-array-like ES3 and non-enumerable old V8 strings\nmodule.exports = fails(function () {\n  // throws an error in rhino, see https://github.com/mozilla/rhino/issues/346\n  // eslint-disable-next-line no-prototype-builtins -- safe\n  return !$Object('z').propertyIsEnumerable(0);\n}) ? function (it) {\n  return classof(it) == 'String' ? split(it, '') : $Object(it);\n} : $Object;\n","var uncurryThis = require('../internals/function-uncurry-this');\nvar isCallable = require('../internals/is-callable');\nvar store = require('../internals/shared-store');\n\nvar functionToString = uncurryThis(Function.toString);\n\n// this helper broken in `core-js@3.4.1-3.4.4`, so we can't use `shared` helper\nif (!isCallable(store.inspectSource)) {\n  store.inspectSource = function (it) {\n    return functionToString(it);\n  };\n}\n\nmodule.exports = store.inspectSource;\n","var NATIVE_WEAK_MAP = require('../internals/native-weak-map');\nvar global = require('../internals/global');\nvar uncurryThis = require('../internals/function-uncurry-this');\nvar isObject = require('../internals/is-object');\nvar createNonEnumerableProperty = require('../internals/create-non-enumerable-property');\nvar hasOwn = require('../internals/has-own-property');\nvar shared = require('../internals/shared-store');\nvar sharedKey = require('../internals/shared-key');\nvar hiddenKeys = require('../internals/hidden-keys');\n\nvar OBJECT_ALREADY_INITIALIZED = 'Object already initialized';\nvar TypeError = global.TypeError;\nvar WeakMap = global.WeakMap;\nvar set, get, has;\n\nvar enforce = function (it) {\n  return has(it) ? get(it) : set(it, {});\n};\n\nvar getterFor = function (TYPE) {\n  return function (it) {\n    var state;\n    if (!isObject(it) || (state = get(it)).type !== TYPE) {\n      throw TypeError('Incompatible receiver, ' + TYPE + ' required');\n    } return state;\n  };\n};\n\nif (NATIVE_WEAK_MAP || shared.state) {\n  var store = shared.state || (shared.state = new WeakMap());\n  var wmget = uncurryThis(store.get);\n  var wmhas = uncurryThis(store.has);\n  var wmset = uncurryThis(store.set);\n  set = function (it, metadata) {\n    if (wmhas(store, it)) throw new TypeError(OBJECT_ALREADY_INITIALIZED);\n    metadata.facade = it;\n    wmset(store, it, metadata);\n    return metadata;\n  };\n  get = function (it) {\n    return wmget(store, it) || {};\n  };\n  has = function (it) {\n    return wmhas(store, it);\n  };\n} else {\n  var STATE = sharedKey('state');\n  hiddenKeys[STATE] = true;\n  set = function (it, metadata) {\n    if (hasOwn(it, STATE)) throw new TypeError(OBJECT_ALREADY_INITIALIZED);\n    metadata.facade = it;\n    createNonEnumerableProperty(it, STATE, metadata);\n    return metadata;\n  };\n  get = function (it) {\n    return hasOwn(it, STATE) ? it[STATE] : {};\n  };\n  has = function (it) {\n    return hasOwn(it, STATE);\n  };\n}\n\nmodule.exports = {\n  set: set,\n  get: get,\n  has: has,\n  enforce: enforce,\n  getterFor: getterFor\n};\n","// `IsCallable` abstract operation\n// https://tc39.es/ecma262/#sec-iscallable\nmodule.exports = function (argument) {\n  return typeof argument == 'function';\n};\n","var fails = require('../internals/fails');\nvar isCallable = require('../internals/is-callable');\n\nvar replacement = /#|\\.prototype\\./;\n\nvar isForced = function (feature, detection) {\n  var value = data[normalize(feature)];\n  return value == POLYFILL ? true\n    : value == NATIVE ? false\n    : isCallable(detection) ? fails(detection)\n    : !!detection;\n};\n\nvar normalize = isForced.normalize = function (string) {\n  return String(string).replace(replacement, '.').toLowerCase();\n};\n\nvar data = isForced.data = {};\nvar NATIVE = isForced.NATIVE = 'N';\nvar POLYFILL = isForced.POLYFILL = 'P';\n\nmodule.exports = isForced;\n","var isCallable = require('../internals/is-callable');\n\nmodule.exports = function (it) {\n  return typeof it == 'object' ? it !== null : isCallable(it);\n};\n","module.exports = false;\n","var getBuiltIn = require('../internals/get-built-in');\nvar isCallable = require('../internals/is-callable');\nvar isPrototypeOf = require('../internals/object-is-prototype-of');\nvar USE_SYMBOL_AS_UID = require('../internals/use-symbol-as-uid');\n\nvar $Object = Object;\n\nmodule.exports = USE_SYMBOL_AS_UID ? function (it) {\n  return typeof it == 'symbol';\n} : function (it) {\n  var $Symbol = getBuiltIn('Symbol');\n  return isCallable($Symbol) && isPrototypeOf($Symbol.prototype, $Object(it));\n};\n","var toLength = require('../internals/to-length');\n\n// `LengthOfArrayLike` abstract operation\n// https://tc39.es/ecma262/#sec-lengthofarraylike\nmodule.exports = function (obj) {\n  return toLength(obj.length);\n};\n","var fails = require('../internals/fails');\nvar isCallable = require('../internals/is-callable');\nvar hasOwn = require('../internals/has-own-property');\nvar DESCRIPTORS = require('../internals/descriptors');\nvar CONFIGURABLE_FUNCTION_NAME = require('../internals/function-name').CONFIGURABLE;\nvar inspectSource = require('../internals/inspect-source');\nvar InternalStateModule = require('../internals/internal-state');\n\nvar enforceInternalState = InternalStateModule.enforce;\nvar getInternalState = InternalStateModule.get;\n// eslint-disable-next-line es-x/no-object-defineproperty -- safe\nvar defineProperty = Object.defineProperty;\n\nvar CONFIGURABLE_LENGTH = DESCRIPTORS && !fails(function () {\n  return defineProperty(function () { /* empty */ }, 'length', { value: 8 }).length !== 8;\n});\n\nvar TEMPLATE = String(String).split('String');\n\nvar makeBuiltIn = module.exports = function (value, name, options) {\n  if (String(name).slice(0, 7) === 'Symbol(') {\n    name = '[' + String(name).replace(/^Symbol\\(([^)]*)\\)/, '$1') + ']';\n  }\n  if (options && options.getter) name = 'get ' + name;\n  if (options && options.setter) name = 'set ' + name;\n  if (!hasOwn(value, 'name') || (CONFIGURABLE_FUNCTION_NAME && value.name !== name)) {\n    if (DESCRIPTORS) defineProperty(value, 'name', { value: name, configurable: true });\n    else value.name = name;\n  }\n  if (CONFIGURABLE_LENGTH && options && hasOwn(options, 'arity') && value.length !== options.arity) {\n    defineProperty(value, 'length', { value: options.arity });\n  }\n  try {\n    if (options && hasOwn(options, 'constructor') && options.constructor) {\n      if (DESCRIPTORS) defineProperty(value, 'prototype', { writable: false });\n    // in V8 ~ Chrome 53, prototypes of some methods, like `Array.prototype.values`, are non-writable\n    } else if (value.prototype) value.prototype = undefined;\n  } catch (error) { /* empty */ }\n  var state = enforceInternalState(value);\n  if (!hasOwn(state, 'source')) {\n    state.source = TEMPLATE.join(typeof name == 'string' ? name : '');\n  } return value;\n};\n\n// add fake Function#toString for correct work wrapped methods / constructors with methods like LoDash isNative\n// eslint-disable-next-line no-extend-native -- required\nFunction.prototype.toString = makeBuiltIn(function toString() {\n  return isCallable(this) && getInternalState(this).source || inspectSource(this);\n}, 'toString');\n","var ceil = Math.ceil;\nvar floor = Math.floor;\n\n// `Math.trunc` method\n// https://tc39.es/ecma262/#sec-math.trunc\n// eslint-disable-next-line es-x/no-math-trunc -- safe\nmodule.exports = Math.trunc || function trunc(x) {\n  var n = +x;\n  return (n > 0 ? floor : ceil)(n);\n};\n","/* eslint-disable es-x/no-symbol -- required for testing */\nvar V8_VERSION = require('../internals/engine-v8-version');\nvar fails = require('../internals/fails');\n\n// eslint-disable-next-line es-x/no-object-getownpropertysymbols -- required for testing\nmodule.exports = !!Object.getOwnPropertySymbols && !fails(function () {\n  var symbol = Symbol();\n  // Chrome 38 Symbol has incorrect toString conversion\n  // `get-own-property-symbols` polyfill symbols converted to object are not Symbol instances\n  return !String(symbol) || !(Object(symbol) instanceof Symbol) ||\n    // Chrome 38-40 symbols are not inherited from DOM collections prototypes to instances\n    !Symbol.sham && V8_VERSION && V8_VERSION < 41;\n});\n","var global = require('../internals/global');\nvar isCallable = require('../internals/is-callable');\nvar inspectSource = require('../internals/inspect-source');\n\nvar WeakMap = global.WeakMap;\n\nmodule.exports = isCallable(WeakMap) && /native code/.test(inspectSource(WeakMap));\n","var DESCRIPTORS = require('../internals/descriptors');\nvar IE8_DOM_DEFINE = require('../internals/ie8-dom-define');\nvar V8_PROTOTYPE_DEFINE_BUG = require('../internals/v8-prototype-define-bug');\nvar anObject = require('../internals/an-object');\nvar toPropertyKey = require('../internals/to-property-key');\n\nvar $TypeError = TypeError;\n// eslint-disable-next-line es-x/no-object-defineproperty -- safe\nvar $defineProperty = Object.defineProperty;\n// eslint-disable-next-line es-x/no-object-getownpropertydescriptor -- safe\nvar $getOwnPropertyDescriptor = Object.getOwnPropertyDescriptor;\nvar ENUMERABLE = 'enumerable';\nvar CONFIGURABLE = 'configurable';\nvar WRITABLE = 'writable';\n\n// `Object.defineProperty` method\n// https://tc39.es/ecma262/#sec-object.defineproperty\nexports.f = DESCRIPTORS ? V8_PROTOTYPE_DEFINE_BUG ? function defineProperty(O, P, Attributes) {\n  anObject(O);\n  P = toPropertyKey(P);\n  anObject(Attributes);\n  if (typeof O === 'function' && P === 'prototype' && 'value' in Attributes && WRITABLE in Attributes && !Attributes[WRITABLE]) {\n    var current = $getOwnPropertyDescriptor(O, P);\n    if (current && current[WRITABLE]) {\n      O[P] = Attributes.value;\n      Attributes = {\n        configurable: CONFIGURABLE in Attributes ? Attributes[CONFIGURABLE] : current[CONFIGURABLE],\n        enumerable: ENUMERABLE in Attributes ? Attributes[ENUMERABLE] : current[ENUMERABLE],\n        writable: false\n      };\n    }\n  } return $defineProperty(O, P, Attributes);\n} : $defineProperty : function defineProperty(O, P, Attributes) {\n  anObject(O);\n  P = toPropertyKey(P);\n  anObject(Attributes);\n  if (IE8_DOM_DEFINE) try {\n    return $defineProperty(O, P, Attributes);\n  } catch (error) { /* empty */ }\n  if ('get' in Attributes || 'set' in Attributes) throw $TypeError('Accessors not supported');\n  if ('value' in Attributes) O[P] = Attributes.value;\n  return O;\n};\n","var DESCRIPTORS = require('../internals/descriptors');\nvar call = require('../internals/function-call');\nvar propertyIsEnumerableModule = require('../internals/object-property-is-enumerable');\nvar createPropertyDescriptor = require('../internals/create-property-descriptor');\nvar toIndexedObject = require('../internals/to-indexed-object');\nvar toPropertyKey = require('../internals/to-property-key');\nvar hasOwn = require('../internals/has-own-property');\nvar IE8_DOM_DEFINE = require('../internals/ie8-dom-define');\n\n// eslint-disable-next-line es-x/no-object-getownpropertydescriptor -- safe\nvar $getOwnPropertyDescriptor = Object.getOwnPropertyDescriptor;\n\n// `Object.getOwnPropertyDescriptor` method\n// https://tc39.es/ecma262/#sec-object.getownpropertydescriptor\nexports.f = DESCRIPTORS ? $getOwnPropertyDescriptor : function getOwnPropertyDescriptor(O, P) {\n  O = toIndexedObject(O);\n  P = toPropertyKey(P);\n  if (IE8_DOM_DEFINE) try {\n    return $getOwnPropertyDescriptor(O, P);\n  } catch (error) { /* empty */ }\n  if (hasOwn(O, P)) return createPropertyDescriptor(!call(propertyIsEnumerableModule.f, O, P), O[P]);\n};\n","var internalObjectKeys = require('../internals/object-keys-internal');\nvar enumBugKeys = require('../internals/enum-bug-keys');\n\nvar hiddenKeys = enumBugKeys.concat('length', 'prototype');\n\n// `Object.getOwnPropertyNames` method\n// https://tc39.es/ecma262/#sec-object.getownpropertynames\n// eslint-disable-next-line es-x/no-object-getownpropertynames -- safe\nexports.f = Object.getOwnPropertyNames || function getOwnPropertyNames(O) {\n  return internalObjectKeys(O, hiddenKeys);\n};\n","// eslint-disable-next-line es-x/no-object-getownpropertysymbols -- safe\nexports.f = Object.getOwnPropertySymbols;\n","var uncurryThis = require('../internals/function-uncurry-this');\n\nmodule.exports = uncurryThis({}.isPrototypeOf);\n","var uncurryThis = require('../internals/function-uncurry-this');\nvar hasOwn = require('../internals/has-own-property');\nvar toIndexedObject = require('../internals/to-indexed-object');\nvar indexOf = require('../internals/array-includes').indexOf;\nvar hiddenKeys = require('../internals/hidden-keys');\n\nvar push = uncurryThis([].push);\n\nmodule.exports = function (object, names) {\n  var O = toIndexedObject(object);\n  var i = 0;\n  var result = [];\n  var key;\n  for (key in O) !hasOwn(hiddenKeys, key) && hasOwn(O, key) && push(result, key);\n  // Don't enum bug & hidden keys\n  while (names.length > i) if (hasOwn(O, key = names[i++])) {\n    ~indexOf(result, key) || push(result, key);\n  }\n  return result;\n};\n","var internalObjectKeys = require('../internals/object-keys-internal');\nvar enumBugKeys = require('../internals/enum-bug-keys');\n\n// `Object.keys` method\n// https://tc39.es/ecma262/#sec-object.keys\n// eslint-disable-next-line es-x/no-object-keys -- safe\nmodule.exports = Object.keys || function keys(O) {\n  return internalObjectKeys(O, enumBugKeys);\n};\n","'use strict';\nvar $propertyIsEnumerable = {}.propertyIsEnumerable;\n// eslint-disable-next-line es-x/no-object-getownpropertydescriptor -- safe\nvar getOwnPropertyDescriptor = Object.getOwnPropertyDescriptor;\n\n// Nashorn ~ JDK8 bug\nvar NASHORN_BUG = getOwnPropertyDescriptor && !$propertyIsEnumerable.call({ 1: 2 }, 1);\n\n// `Object.prototype.propertyIsEnumerable` method implementation\n// https://tc39.es/ecma262/#sec-object.prototype.propertyisenumerable\nexports.f = NASHORN_BUG ? function propertyIsEnumerable(V) {\n  var descriptor = getOwnPropertyDescriptor(this, V);\n  return !!descriptor && descriptor.enumerable;\n} : $propertyIsEnumerable;\n","var call = require('../internals/function-call');\nvar isCallable = require('../internals/is-callable');\nvar isObject = require('../internals/is-object');\n\nvar $TypeError = TypeError;\n\n// `OrdinaryToPrimitive` abstract operation\n// https://tc39.es/ecma262/#sec-ordinarytoprimitive\nmodule.exports = function (input, pref) {\n  var fn, val;\n  if (pref === 'string' && isCallable(fn = input.toString) && !isObject(val = call(fn, input))) return val;\n  if (isCallable(fn = input.valueOf) && !isObject(val = call(fn, input))) return val;\n  if (pref !== 'string' && isCallable(fn = input.toString) && !isObject(val = call(fn, input))) return val;\n  throw $TypeError(\"Can't convert object to primitive value\");\n};\n","var getBuiltIn = require('../internals/get-built-in');\nvar uncurryThis = require('../internals/function-uncurry-this');\nvar getOwnPropertyNamesModule = require('../internals/object-get-own-property-names');\nvar getOwnPropertySymbolsModule = require('../internals/object-get-own-property-symbols');\nvar anObject = require('../internals/an-object');\n\nvar concat = uncurryThis([].concat);\n\n// all object keys, includes non-enumerable and symbols\nmodule.exports = getBuiltIn('Reflect', 'ownKeys') || function ownKeys(it) {\n  var keys = getOwnPropertyNamesModule.f(anObject(it));\n  var getOwnPropertySymbols = getOwnPropertySymbolsModule.f;\n  return getOwnPropertySymbols ? concat(keys, getOwnPropertySymbols(it)) : keys;\n};\n","var global = require('../internals/global');\n\nmodule.exports = global;\n","var $TypeError = TypeError;\n\n// `RequireObjectCoercible` abstract operation\n// https://tc39.es/ecma262/#sec-requireobjectcoercible\nmodule.exports = function (it) {\n  if (it == undefined) throw $TypeError(\"Can't call method on \" + it);\n  return it;\n};\n","var shared = require('../internals/shared');\nvar uid = require('../internals/uid');\n\nvar keys = shared('keys');\n\nmodule.exports = function (key) {\n  return keys[key] || (keys[key] = uid(key));\n};\n","var global = require('../internals/global');\nvar defineGlobalProperty = require('../internals/define-global-property');\n\nvar SHARED = '__core-js_shared__';\nvar store = global[SHARED] || defineGlobalProperty(SHARED, {});\n\nmodule.exports = store;\n","var IS_PURE = require('../internals/is-pure');\nvar store = require('../internals/shared-store');\n\n(module.exports = function (key, value) {\n  return store[key] || (store[key] = value !== undefined ? value : {});\n})('versions', []).push({\n  version: '3.23.3',\n  mode: IS_PURE ? 'pure' : 'global',\n  copyright: ' 2014-2022 Denis Pushkarev (zloirock.ru)',\n  license: 'https://github.com/zloirock/core-js/blob/v3.23.3/LICENSE',\n  source: 'https://github.com/zloirock/core-js'\n});\n","var toIntegerOrInfinity = require('../internals/to-integer-or-infinity');\n\nvar max = Math.max;\nvar min = Math.min;\n\n// Helper for a popular repeating case of the spec:\n// Let integer be ? ToInteger(index).\n// If integer < 0, let result be max((length + integer), 0); else let result be min(integer, length).\nmodule.exports = function (index, length) {\n  var integer = toIntegerOrInfinity(index);\n  return integer < 0 ? max(integer + length, 0) : min(integer, length);\n};\n","// toObject with fallback for non-array-like ES3 strings\nvar IndexedObject = require('../internals/indexed-object');\nvar requireObjectCoercible = require('../internals/require-object-coercible');\n\nmodule.exports = function (it) {\n  return IndexedObject(requireObjectCoercible(it));\n};\n","var trunc = require('../internals/math-trunc');\n\n// `ToIntegerOrInfinity` abstract operation\n// https://tc39.es/ecma262/#sec-tointegerorinfinity\nmodule.exports = function (argument) {\n  var number = +argument;\n  // eslint-disable-next-line no-self-compare -- NaN check\n  return number !== number || number === 0 ? 0 : trunc(number);\n};\n","var toIntegerOrInfinity = require('../internals/to-integer-or-infinity');\n\nvar min = Math.min;\n\n// `ToLength` abstract operation\n// https://tc39.es/ecma262/#sec-tolength\nmodule.exports = function (argument) {\n  return argument > 0 ? min(toIntegerOrInfinity(argument), 0x1FFFFFFFFFFFFF) : 0; // 2 ** 53 - 1 == 9007199254740991\n};\n","var requireObjectCoercible = require('../internals/require-object-coercible');\n\nvar $Object = Object;\n\n// `ToObject` abstract operation\n// https://tc39.es/ecma262/#sec-toobject\nmodule.exports = function (argument) {\n  return $Object(requireObjectCoercible(argument));\n};\n","var call = require('../internals/function-call');\nvar isObject = require('../internals/is-object');\nvar isSymbol = require('../internals/is-symbol');\nvar getMethod = require('../internals/get-method');\nvar ordinaryToPrimitive = require('../internals/ordinary-to-primitive');\nvar wellKnownSymbol = require('../internals/well-known-symbol');\n\nvar $TypeError = TypeError;\nvar TO_PRIMITIVE = wellKnownSymbol('toPrimitive');\n\n// `ToPrimitive` abstract operation\n// https://tc39.es/ecma262/#sec-toprimitive\nmodule.exports = function (input, pref) {\n  if (!isObject(input) || isSymbol(input)) return input;\n  var exoticToPrim = getMethod(input, TO_PRIMITIVE);\n  var result;\n  if (exoticToPrim) {\n    if (pref === undefined) pref = 'default';\n    result = call(exoticToPrim, input, pref);\n    if (!isObject(result) || isSymbol(result)) return result;\n    throw $TypeError(\"Can't convert object to primitive value\");\n  }\n  if (pref === undefined) pref = 'number';\n  return ordinaryToPrimitive(input, pref);\n};\n","var toPrimitive = require('../internals/to-primitive');\nvar isSymbol = require('../internals/is-symbol');\n\n// `ToPropertyKey` abstract operation\n// https://tc39.es/ecma262/#sec-topropertykey\nmodule.exports = function (argument) {\n  var key = toPrimitive(argument, 'string');\n  return isSymbol(key) ? key : key + '';\n};\n","var wellKnownSymbol = require('../internals/well-known-symbol');\n\nvar TO_STRING_TAG = wellKnownSymbol('toStringTag');\nvar test = {};\n\ntest[TO_STRING_TAG] = 'z';\n\nmodule.exports = String(test) === '[object z]';\n","var classof = require('../internals/classof');\n\nvar $String = String;\n\nmodule.exports = function (argument) {\n  if (classof(argument) === 'Symbol') throw TypeError('Cannot convert a Symbol value to a string');\n  return $String(argument);\n};\n","var $String = String;\n\nmodule.exports = function (argument) {\n  try {\n    return $String(argument);\n  } catch (error) {\n    return 'Object';\n  }\n};\n","var uncurryThis = require('../internals/function-uncurry-this');\n\nvar id = 0;\nvar postfix = Math.random();\nvar toString = uncurryThis(1.0.toString);\n\nmodule.exports = function (key) {\n  return 'Symbol(' + (key === undefined ? '' : key) + ')_' + toString(++id + postfix, 36);\n};\n","/* eslint-disable es-x/no-symbol -- required for testing */\nvar NATIVE_SYMBOL = require('../internals/native-symbol');\n\nmodule.exports = NATIVE_SYMBOL\n  && !Symbol.sham\n  && typeof Symbol.iterator == 'symbol';\n","var DESCRIPTORS = require('../internals/descriptors');\nvar fails = require('../internals/fails');\n\n// V8 ~ Chrome 36-\n// https://bugs.chromium.org/p/v8/issues/detail?id=3334\nmodule.exports = DESCRIPTORS && fails(function () {\n  // eslint-disable-next-line es-x/no-object-defineproperty -- required for testing\n  return Object.defineProperty(function () { /* empty */ }, 'prototype', {\n    value: 42,\n    writable: false\n  }).prototype != 42;\n});\n","var global = require('../internals/global');\nvar shared = require('../internals/shared');\nvar hasOwn = require('../internals/has-own-property');\nvar uid = require('../internals/uid');\nvar NATIVE_SYMBOL = require('../internals/native-symbol');\nvar USE_SYMBOL_AS_UID = require('../internals/use-symbol-as-uid');\n\nvar WellKnownSymbolsStore = shared('wks');\nvar Symbol = global.Symbol;\nvar symbolFor = Symbol && Symbol['for'];\nvar createWellKnownSymbol = USE_SYMBOL_AS_UID ? Symbol : Symbol && Symbol.withoutSetter || uid;\n\nmodule.exports = function (name) {\n  if (!hasOwn(WellKnownSymbolsStore, name) || !(NATIVE_SYMBOL || typeof WellKnownSymbolsStore[name] == 'string')) {\n    var description = 'Symbol.' + name;\n    if (NATIVE_SYMBOL && hasOwn(Symbol, name)) {\n      WellKnownSymbolsStore[name] = Symbol[name];\n    } else if (USE_SYMBOL_AS_UID && symbolFor) {\n      WellKnownSymbolsStore[name] = symbolFor(description);\n    } else {\n      WellKnownSymbolsStore[name] = createWellKnownSymbol(description);\n    }\n  } return WellKnownSymbolsStore[name];\n};\n","'use strict';\nvar $ = require('../internals/export');\nvar uncurryThis = require('../internals/function-uncurry-this');\nvar aCallable = require('../internals/a-callable');\nvar toObject = require('../internals/to-object');\nvar lengthOfArrayLike = require('../internals/length-of-array-like');\nvar deletePropertyOrThrow = require('../internals/delete-property-or-throw');\nvar toString = require('../internals/to-string');\nvar fails = require('../internals/fails');\nvar internalSort = require('../internals/array-sort');\nvar arrayMethodIsStrict = require('../internals/array-method-is-strict');\nvar FF = require('../internals/engine-ff-version');\nvar IE_OR_EDGE = require('../internals/engine-is-ie-or-edge');\nvar V8 = require('../internals/engine-v8-version');\nvar WEBKIT = require('../internals/engine-webkit-version');\n\nvar test = [];\nvar un$Sort = uncurryThis(test.sort);\nvar push = uncurryThis(test.push);\n\n// IE8-\nvar FAILS_ON_UNDEFINED = fails(function () {\n  test.sort(undefined);\n});\n// V8 bug\nvar FAILS_ON_NULL = fails(function () {\n  test.sort(null);\n});\n// Old WebKit\nvar STRICT_METHOD = arrayMethodIsStrict('sort');\n\nvar STABLE_SORT = !fails(function () {\n  // feature detection can be too slow, so check engines versions\n  if (V8) return V8 < 70;\n  if (FF && FF > 3) return;\n  if (IE_OR_EDGE) return true;\n  if (WEBKIT) return WEBKIT < 603;\n\n  var result = '';\n  var code, chr, value, index;\n\n  // generate an array with more 512 elements (Chakra and old V8 fails only in this case)\n  for (code = 65; code < 76; code++) {\n    chr = String.fromCharCode(code);\n\n    switch (code) {\n      case 66: case 69: case 70: case 72: value = 3; break;\n      case 68: case 71: value = 4; break;\n      default: value = 2;\n    }\n\n    for (index = 0; index < 47; index++) {\n      test.push({ k: chr + index, v: value });\n    }\n  }\n\n  test.sort(function (a, b) { return b.v - a.v; });\n\n  for (index = 0; index < test.length; index++) {\n    chr = test[index].k.charAt(0);\n    if (result.charAt(result.length - 1) !== chr) result += chr;\n  }\n\n  return result !== 'DGBEFHACIJK';\n});\n\nvar FORCED = FAILS_ON_UNDEFINED || !FAILS_ON_NULL || !STRICT_METHOD || !STABLE_SORT;\n\nvar getSortCompare = function (comparefn) {\n  return function (x, y) {\n    if (y === undefined) return -1;\n    if (x === undefined) return 1;\n    if (comparefn !== undefined) return +comparefn(x, y) || 0;\n    return toString(x) > toString(y) ? 1 : -1;\n  };\n};\n\n// `Array.prototype.sort` method\n// https://tc39.es/ecma262/#sec-array.prototype.sort\n$({ target: 'Array', proto: true, forced: FORCED }, {\n  sort: function sort(comparefn) {\n    if (comparefn !== undefined) aCallable(comparefn);\n\n    var array = toObject(this);\n\n    if (STABLE_SORT) return comparefn === undefined ? un$Sort(array) : un$Sort(array, comparefn);\n\n    var items = [];\n    var arrayLength = lengthOfArrayLike(array);\n    var itemsLength, index;\n\n    for (index = 0; index < arrayLength; index++) {\n      if (index in array) push(items, array[index]);\n    }\n\n    internalSort(items, getSortCompare(comparefn));\n\n    itemsLength = items.length;\n    index = 0;\n\n    while (index < itemsLength) array[index] = items[index++];\n    while (index < arrayLength) deletePropertyOrThrow(array, index++);\n\n    return array;\n  }\n});\n","var $ = require('../internals/export');\nvar toObject = require('../internals/to-object');\nvar nativeKeys = require('../internals/object-keys');\nvar fails = require('../internals/fails');\n\nvar FAILS_ON_PRIMITIVES = fails(function () { nativeKeys(1); });\n\n// `Object.keys` method\n// https://tc39.es/ecma262/#sec-object.keys\n$({ target: 'Object', stat: true, forced: FAILS_ON_PRIMITIVES }, {\n  keys: function keys(it) {\n    return nativeKeys(toObject(it));\n  }\n});\n","// Imports\nimport ___CSS_LOADER_API_SOURCEMAP_IMPORT___ from \"../../node_modules/css-loader/dist/runtime/sourceMaps.js\";\nimport ___CSS_LOADER_API_IMPORT___ from \"../../node_modules/css-loader/dist/runtime/api.js\";\nvar ___CSS_LOADER_EXPORT___ = ___CSS_LOADER_API_IMPORT___(___CSS_LOADER_API_SOURCEMAP_IMPORT___);\n// Module\n___CSS_LOADER_EXPORT___.push([module.id, \"/* Buttons styles start */\\r\\n\\r\\nbutton#excalibur-play {\\r\\n  display: inline-block;\\r\\n  position: relative;\\r\\n  z-index: 999;\\r\\n  border-radius: 6px;\\r\\n  border: none;\\r\\n  /*border: 3px solid;\\r\\n    border-color: white;\\r\\n    box-shadow: 0 0 10px #ccc;*/\\r\\n  padding: 1rem 1.5rem 1rem 4rem;\\r\\n  margin: 0;\\r\\n  text-decoration: none;\\r\\n  background: #00b233;\\r\\n  color: #ffffff;\\r\\n  font-family: sans-serif;\\r\\n  font-size: 2rem;\\r\\n  white-space: nowrap;\\r\\n  line-height: 1;\\r\\n  cursor: pointer;\\r\\n  text-align: center;\\r\\n  transition: background 250ms ease-in-out, transform 150ms ease;\\r\\n  -webkit-appearance: none;\\r\\n  -moz-appearance: none;\\r\\n\\r\\n  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\\r\\n  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\\r\\n  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\\r\\n  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\\r\\n  animation: excalibur-button-fadein 200ms;\\r\\n}\\r\\n\\r\\n/*\\r\\nbutton#excalibur-play {\\r\\n  display: none;\\r\\n}*/\\r\\n\\r\\nbutton#excalibur-play:after {\\r\\n  position: absolute;\\r\\n  content: '';\\r\\n  border: 8px solid;\\r\\n  border-color: transparent transparent transparent white;\\r\\n  left: 35px;\\r\\n  top: 24px;\\r\\n  width: 0;\\r\\n  height: 0;\\r\\n}\\r\\n\\r\\nbutton#excalibur-play:before {\\r\\n  position: absolute;\\r\\n  content: '';\\r\\n  border: 3px solid;\\r\\n  left: 19px;\\r\\n  top: 14px;\\r\\n  border-radius: 20px;\\r\\n  width: 30px;\\r\\n  height: 30px;\\r\\n}\\r\\n\\r\\nbutton#excalibur-play:hover,\\r\\nbutton#excalibur-play:focus {\\r\\n  background: #00982c;\\r\\n}\\r\\n\\r\\nbutton#excalibur-play:focus {\\r\\n  outline: 1px solid #fff;\\r\\n  outline-offset: -4px;\\r\\n}\\r\\n\\r\\nbutton#excalibur-play:active {\\r\\n  transform: scale(0.99);\\r\\n}\\r\\n\\r\\n@keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\\r\\n/* Firefox < 16 */\\r\\n@-moz-keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\\r\\n/* Safari, Chrome and Opera > 12.1 */\\r\\n@-webkit-keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\\r\\n/* Internet Explorer */\\r\\n@-ms-keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\\r\\n/* Opera < 12.1 */\\r\\n@-o-keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\", \"\",{\"version\":3,\"sources\":[\"webpack://./Loader.css\"],\"names\":[],\"mappings\":\"AAAA,yBAAyB;;AAEzB;EACE,qBAAqB;EACrB,kBAAkB;EAClB,YAAY;EACZ,kBAAkB;EAClB,YAAY;EACZ;;+BAE6B;EAC7B,8BAA8B;EAC9B,SAAS;EACT,qBAAqB;EACrB,mBAAmB;EACnB,cAAc;EACd,uBAAuB;EACvB,eAAe;EACf,mBAAmB;EACnB,cAAc;EACd,eAAe;EACf,kBAAkB;EAClB,8DAA8D;EAC9D,wBAAwB;EACxB,qBAAqB;;EAErB,gDAAgD,EAAE,oCAAoC;EACtF,6CAA6C,EAAE,iBAAiB;EAChE,4CAA4C,EAAE,sBAAsB;EACpE,2CAA2C,EAAE,iBAAiB;EAC9D,wCAAwC;AAC1C;;AAEA;;;EAGE;;AAEF;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,uDAAuD;EACvD,UAAU;EACV,SAAS;EACT,QAAQ;EACR,SAAS;AACX;;AAEA;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,UAAU;EACV,SAAS;EACT,mBAAmB;EACnB,WAAW;EACX,YAAY;AACd;;AAEA;;EAEE,mBAAmB;AACrB;;AAEA;EACE,uBAAuB;EACvB,oBAAoB;AACtB;;AAEA;EACE,sBAAsB;AACxB;;AAEA;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,oCAAoC;AACpC;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,sBAAsB;AACtB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF\",\"sourcesContent\":[\"/* Buttons styles start */\\r\\n\\r\\nbutton#excalibur-play {\\r\\n  display: inline-block;\\r\\n  position: relative;\\r\\n  z-index: 999;\\r\\n  border-radius: 6px;\\r\\n  border: none;\\r\\n  /*border: 3px solid;\\r\\n    border-color: white;\\r\\n    box-shadow: 0 0 10px #ccc;*/\\r\\n  padding: 1rem 1.5rem 1rem 4rem;\\r\\n  margin: 0;\\r\\n  text-decoration: none;\\r\\n  background: #00b233;\\r\\n  color: #ffffff;\\r\\n  font-family: sans-serif;\\r\\n  font-size: 2rem;\\r\\n  white-space: nowrap;\\r\\n  line-height: 1;\\r\\n  cursor: pointer;\\r\\n  text-align: center;\\r\\n  transition: background 250ms ease-in-out, transform 150ms ease;\\r\\n  -webkit-appearance: none;\\r\\n  -moz-appearance: none;\\r\\n\\r\\n  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\\r\\n  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\\r\\n  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\\r\\n  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\\r\\n  animation: excalibur-button-fadein 200ms;\\r\\n}\\r\\n\\r\\n/*\\r\\nbutton#excalibur-play {\\r\\n  display: none;\\r\\n}*/\\r\\n\\r\\nbutton#excalibur-play:after {\\r\\n  position: absolute;\\r\\n  content: '';\\r\\n  border: 8px solid;\\r\\n  border-color: transparent transparent transparent white;\\r\\n  left: 35px;\\r\\n  top: 24px;\\r\\n  width: 0;\\r\\n  height: 0;\\r\\n}\\r\\n\\r\\nbutton#excalibur-play:before {\\r\\n  position: absolute;\\r\\n  content: '';\\r\\n  border: 3px solid;\\r\\n  left: 19px;\\r\\n  top: 14px;\\r\\n  border-radius: 20px;\\r\\n  width: 30px;\\r\\n  height: 30px;\\r\\n}\\r\\n\\r\\nbutton#excalibur-play:hover,\\r\\nbutton#excalibur-play:focus {\\r\\n  background: #00982c;\\r\\n}\\r\\n\\r\\nbutton#excalibur-play:focus {\\r\\n  outline: 1px solid #fff;\\r\\n  outline-offset: -4px;\\r\\n}\\r\\n\\r\\nbutton#excalibur-play:active {\\r\\n  transform: scale(0.99);\\r\\n}\\r\\n\\r\\n@keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\\r\\n/* Firefox < 16 */\\r\\n@-moz-keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\\r\\n/* Safari, Chrome and Opera > 12.1 */\\r\\n@-webkit-keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\\r\\n/* Internet Explorer */\\r\\n@-ms-keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\\r\\n/* Opera < 12.1 */\\r\\n@-o-keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\"],\"sourceRoot\":\"\"}]);\n// Exports\nexport default ___CSS_LOADER_EXPORT___;\n","// Imports\nimport ___CSS_LOADER_API_SOURCEMAP_IMPORT___ from \"../../../node_modules/css-loader/dist/runtime/sourceMaps.js\";\nimport ___CSS_LOADER_API_IMPORT___ from \"../../../node_modules/css-loader/dist/runtime/api.js\";\nvar ___CSS_LOADER_EXPORT___ = ___CSS_LOADER_API_IMPORT___(___CSS_LOADER_API_SOURCEMAP_IMPORT___);\n// Module\n___CSS_LOADER_EXPORT___.push([module.id, \"\\r\\n#ex-toast-container {\\r\\n  position: absolute;\\r\\n  height: 0;\\r\\n  min-width: 50%;\\r\\n  left: 50%;\\r\\n  top: 0;\\r\\n}\\r\\n\\r\\n.ex-toast-message {\\r\\n  left: -50%;\\r\\n  position: relative;\\r\\n  display: flex;\\r\\n  justify-content: space-between;\\r\\n\\r\\n\\r\\n  padding: 10px;\\r\\n  margin-top: 5px;\\r\\n  font-size: 18px;\\r\\n  font-family: sans-serif;\\r\\n  border-radius: 6px;\\r\\n  border: 3px solid #b7b779;\\r\\n  background-color: rgb(253, 253, 192);\\r\\n}\\r\\n\\r\\n\\r\\n.ex-toast-message button {\\r\\n  align-self: flex-start;\\r\\n}\", \"\",{\"version\":3,\"sources\":[\"webpack://./Util/Toaster.css\"],\"names\":[],\"mappings\":\";AACA;EACE,kBAAkB;EAClB,SAAS;EACT,cAAc;EACd,SAAS;EACT,MAAM;AACR;;AAEA;EACE,UAAU;EACV,kBAAkB;EAClB,aAAa;EACb,8BAA8B;;;EAG9B,aAAa;EACb,eAAe;EACf,eAAe;EACf,uBAAuB;EACvB,kBAAkB;EAClB,yBAAyB;EACzB,oCAAoC;AACtC;;;AAGA;EACE,sBAAsB;AACxB\",\"sourcesContent\":[\"\\r\\n#ex-toast-container {\\r\\n  position: absolute;\\r\\n  height: 0;\\r\\n  min-width: 50%;\\r\\n  left: 50%;\\r\\n  top: 0;\\r\\n}\\r\\n\\r\\n.ex-toast-message {\\r\\n  left: -50%;\\r\\n  position: relative;\\r\\n  display: flex;\\r\\n  justify-content: space-between;\\r\\n\\r\\n\\r\\n  padding: 10px;\\r\\n  margin-top: 5px;\\r\\n  font-size: 18px;\\r\\n  font-family: sans-serif;\\r\\n  border-radius: 6px;\\r\\n  border: 3px solid #b7b779;\\r\\n  background-color: rgb(253, 253, 192);\\r\\n}\\r\\n\\r\\n\\r\\n.ex-toast-message button {\\r\\n  align-self: flex-start;\\r\\n}\"],\"sourceRoot\":\"\"}]);\n// Exports\nexport default ___CSS_LOADER_EXPORT___;\n","\"use strict\";\n\n/*\n  MIT License http://www.opensource.org/licenses/mit-license.php\n  Author Tobias Koppers @sokra\n*/\nmodule.exports = function (cssWithMappingToString) {\n  var list = []; // return the list of modules as css string\n\n  list.toString = function toString() {\n    return this.map(function (item) {\n      var content = \"\";\n      var needLayer = typeof item[5] !== \"undefined\";\n\n      if (item[4]) {\n        content += \"@supports (\".concat(item[4], \") {\");\n      }\n\n      if (item[2]) {\n        content += \"@media \".concat(item[2], \" {\");\n      }\n\n      if (needLayer) {\n        content += \"@layer\".concat(item[5].length > 0 ? \" \".concat(item[5]) : \"\", \" {\");\n      }\n\n      content += cssWithMappingToString(item);\n\n      if (needLayer) {\n        content += \"}\";\n      }\n\n      if (item[2]) {\n        content += \"}\";\n      }\n\n      if (item[4]) {\n        content += \"}\";\n      }\n\n      return content;\n    }).join(\"\");\n  }; // import a list of modules into the list\n\n\n  list.i = function i(modules, media, dedupe, supports, layer) {\n    if (typeof modules === \"string\") {\n      modules = [[null, modules, undefined]];\n    }\n\n    var alreadyImportedModules = {};\n\n    if (dedupe) {\n      for (var k = 0; k < this.length; k++) {\n        var id = this[k][0];\n\n        if (id != null) {\n          alreadyImportedModules[id] = true;\n        }\n      }\n    }\n\n    for (var _k = 0; _k < modules.length; _k++) {\n      var item = [].concat(modules[_k]);\n\n      if (dedupe && alreadyImportedModules[item[0]]) {\n        continue;\n      }\n\n      if (typeof layer !== \"undefined\") {\n        if (typeof item[5] === \"undefined\") {\n          item[5] = layer;\n        } else {\n          item[1] = \"@layer\".concat(item[5].length > 0 ? \" \".concat(item[5]) : \"\", \" {\").concat(item[1], \"}\");\n          item[5] = layer;\n        }\n      }\n\n      if (media) {\n        if (!item[2]) {\n          item[2] = media;\n        } else {\n          item[1] = \"@media \".concat(item[2], \" {\").concat(item[1], \"}\");\n          item[2] = media;\n        }\n      }\n\n      if (supports) {\n        if (!item[4]) {\n          item[4] = \"\".concat(supports);\n        } else {\n          item[1] = \"@supports (\".concat(item[4], \") {\").concat(item[1], \"}\");\n          item[4] = supports;\n        }\n      }\n\n      list.push(item);\n    }\n  };\n\n  return list;\n};","\"use strict\";\n\nmodule.exports = function (item) {\n  var content = item[1];\n  var cssMapping = item[3];\n\n  if (!cssMapping) {\n    return content;\n  }\n\n  if (typeof btoa === \"function\") {\n    var base64 = btoa(unescape(encodeURIComponent(JSON.stringify(cssMapping))));\n    var data = \"sourceMappingURL=data:application/json;charset=utf-8;base64,\".concat(base64);\n    var sourceMapping = \"/*# \".concat(data, \" */\");\n    var sourceURLs = cssMapping.sources.map(function (source) {\n      return \"/*# sourceURL=\".concat(cssMapping.sourceRoot || \"\").concat(source, \" */\");\n    });\n    return [content].concat(sourceURLs).concat([sourceMapping]).join(\"\\n\");\n  }\n\n  return [content].join(\"\\n\");\n};","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\tid: moduleId,\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.g = (function() {\n\tif (typeof globalThis === 'object') return globalThis;\n\ttry {\n\t\treturn this || new Function('return this')();\n\t} catch (e) {\n\t\tif (typeof window === 'object') return window;\n\t}\n})();","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","import 'core-js/es/array/sort';\r\nimport 'core-js/es/object/keys';\r\n\r\n/**\r\n * Polyfill adding function\r\n */\r\nexport function polyfill() {\r\n  /* istanbul ignore next */\r\n  if (typeof window === 'undefined') {\r\n    window = <any>{\r\n      audioContext: function () {\r\n        return;\r\n      }\r\n    };\r\n  }\r\n  /* istanbul ignore next */\r\n  if (typeof window !== 'undefined' && !window.requestAnimationFrame) {\r\n    (<any>window).requestAnimationFrame =\r\n      (<any>window).webkitRequestAnimationFrame ||\r\n      (<any>window).mozRequestAnimationFrame ||\r\n      function (callback: Function) {\r\n        window.setInterval(callback, 1000 / 60);\r\n      };\r\n  }\r\n  /* istanbul ignore next */\r\n  if (typeof window !== 'undefined' && !window.cancelAnimationFrame) {\r\n    (<any>window).cancelAnimationFrame =\r\n      (<any>window).webkitCancelAnimationFrame ||\r\n      (<any>window).mozCancelAnimationFrame ||\r\n      function () {\r\n        return;\r\n      };\r\n  }\r\n  /* istanbul ignore next */\r\n  if (typeof window !== 'undefined' && !(<any>window).AudioContext) {\r\n    if ((<any>window).webkitAudioContext) {\r\n      const ctx = (<any>window).webkitAudioContext;\r\n      const replaceMe = ctx.prototype.decodeAudioData;\r\n      (<any>window).webkitAudioContext.prototype.decodeAudioData = function (arrayBuffer: ArrayBuffer) {\r\n        return new Promise((resolve, reject) => {\r\n          replaceMe.call(this, arrayBuffer, resolve, reject);\r\n        });\r\n      };\r\n    }\r\n\r\n    (<any>window).AudioContext =\r\n      (<any>window).AudioContext ||\r\n      (<any>window).webkitAudioContext ||\r\n      (<any>window).mozAudioContext ||\r\n      (<any>window).msAudioContext ||\r\n      (<any>window).oAudioContext;\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  if (typeof window !== 'undefined' && !(<any>window).devicePixelRatio) {\r\n    (<any>window).devicePixelRatio = window.devicePixelRatio || 1;\r\n  }\r\n}\r\n","\r\n/**\r\n * Flags is a feature flag implementation for Excalibur. They can only be operated **before [[Engine]] construction**\r\n * after which they are frozen and are read-only.\r\n *\r\n * Flags are used to enable experimental or preview features in Excalibur.\r\n */\r\nexport class Flags {\r\n  private static _FROZEN = false;\r\n  private static _FLAGS: Record<string, boolean> = {};\r\n\r\n\r\n  /**\r\n   * Force excalibur to load the Canvas 2D graphics context fallback\r\n   *\r\n   * @warning not all features of excalibur are supported in the Canvas 2D fallback\r\n   */\r\n  public static useCanvasGraphicsContext() {\r\n    Flags.enable('use-canvas-context');\r\n  }\r\n\r\n  /**\r\n   * Freeze all flag modifications making them readonly\r\n   */\r\n  public static freeze() {\r\n    Flags._FROZEN = true;\r\n  }\r\n\r\n  /**\r\n   * Resets internal flag state, not meant to be called by users. Only used for testing.\r\n   *\r\n   * Calling this in your game is UNSUPPORTED\r\n   * @internal\r\n   */\r\n  public static _reset() {\r\n    Flags._FROZEN = false;\r\n    Flags._FLAGS = {};\r\n  }\r\n  /**\r\n   * Enable a specific feature flag by name. **Note: can only be set before [[Engine]] constructor time**\r\n   * @param flagName\r\n   */\r\n  public static enable(flagName: string): void {\r\n    if (this._FROZEN) {\r\n      throw Error('Feature flags can only be enabled before Engine constructor time');\r\n    }\r\n    Flags._FLAGS[flagName] = true;\r\n  }\r\n\r\n  /**\r\n   * Disable a specific feature flag by name. **Note: can only be set before [[Engine]] constructor time**\r\n   * @param flagName\r\n   */\r\n  public static disable(flagName: string): void {\r\n    if (this._FROZEN) {\r\n      throw Error('Feature flags can only be disabled before Engine constructor time');\r\n    }\r\n    Flags._FLAGS[flagName] = false;\r\n  }\r\n\r\n  /**\r\n   * Check if a flag is enabled. If the flag is disabled or does not exist `false` is returned\r\n   * @param flagName\r\n   */\r\n  public static isEnabled(flagName: string): boolean {\r\n    return !!Flags._FLAGS[flagName];\r\n  }\r\n\r\n  /**\r\n   * Show a list of currently known flags\r\n   */\r\n  public static show(): string[] {\r\n    return Object.keys(Flags._FLAGS);\r\n  }\r\n}\r\n","export type Id<T extends string> = {\r\n  type: T,\r\n  value: number\r\n};\r\n\r\n/**\r\n * Create a branded ID type from a number\r\n */\r\nexport function createId<T extends string>(type: T, value: number): Id<T> {\r\n  return { type, value };\r\n};\r\n","/**\r\n * @module\r\n * Pseudo-Random Utility\r\n *\r\n * A pseudo-random utility to add seeded random support for help in\r\n * generating things like terrain or reproducible randomness. Uses the\r\n * [Mersenne Twister](https://en.wikipedia.org/wiki/Mersenne_Twister) algorithm.\r\n */\r\n\r\n/**\r\n * 32-bit mask\r\n */\r\nconst BITMASK32: number = 0xffffffff;\r\n\r\n/**\r\n * Pseudo-random number generator following the Mersenne_Twister algorithm. Given a seed this generator will produce the same sequence\r\n * of numbers each time it is called.\r\n * See https://en.wikipedia.org/wiki/Mersenne_Twister for more details.\r\n * Uses the MT19937-32 (2002) implementation documented here http://www.math.sci.hiroshima-u.ac.jp/~m-mat/MT/MT2002/emt19937ar.html\r\n *\r\n * Api inspired by http://chancejs.com/# https://github.com/chancejs/chancejs\r\n */\r\nexport class Random {\r\n  // Separation point of one one word, the number of bits in the lower bitmask 0 <= r <= w-1\r\n  private _lowerMask: number = 0x7fffffff; // 31 bits same as _r\r\n  private _upperMask: number = 0x80000000; // 34 high bits\r\n\r\n  // Word size, 64 bits\r\n  private _w: number = 32;\r\n\r\n  // Degree of recurrence\r\n  private _n: number = 624;\r\n\r\n  // Middle word, an offset used in the recurrence defining the series x, 1<=m<n\r\n  private _m: number = 397;\r\n  // coefficients of teh rational normal form twist matrix\r\n  private _a: number = 0x9908b0df;\r\n\r\n  // tempering bit shifts and masks\r\n  private _u: number = 11;\r\n  private _s: number = 7;\r\n  private _b: number = 0x9d2c5680;\r\n  private _t: number = 15;\r\n  private _c: number = 0xefc60000;\r\n  private _l: number = 18;\r\n  private _f: number = 1812433253;\r\n\r\n  private _mt: number[];\r\n\r\n  private _index: number;\r\n\r\n  /**\r\n   * If no seed is specified, the Date.now() is used\r\n   */\r\n  constructor(public seed?: number) {\r\n    this._mt = new Array<number>(this._n);\r\n    // need to mask to support higher bit machines\r\n    this._mt[0] = (seed || Date.now()) >>> 0;\r\n\r\n    for (let i = 1; i < this._n; i++) {\r\n      const s = this._mt[i - 1] ^ (this._mt[i - 1] >>> (this._w - 2));\r\n      // numbers are bigger than the JS max safe int, add in 16-bit chunks to prevent IEEE rounding errors on high bits\r\n      this._mt[i] = (((this._f * ((s & 0xffff0000) >>> 16)) << 16) + this._f * (s & 0xffff) + i) >>> 0;\r\n    }\r\n    this._index = this._n;\r\n  }\r\n\r\n  /**\r\n   * Apply the twist\r\n   */\r\n  private _twist(): void {\r\n    const mag01 = [0x0, this._a];\r\n    let y = 0,\r\n      i = 0;\r\n    for (; i < this._n - this._m; i++) {\r\n      y = (this._mt[i] & this._upperMask) | (this._mt[i + 1] & this._lowerMask);\r\n      this._mt[i] = this._mt[i + this._m] ^ (y >>> 1) ^ (mag01[y & 0x1] & BITMASK32);\r\n    }\r\n    for (; i < this._n - 1; i++) {\r\n      y = (this._mt[i] & this._upperMask) | (this._mt[i + 1] & this._lowerMask);\r\n      this._mt[i] = this._mt[i + (this._m - this._n)] ^ (y >>> 1) ^ (mag01[y & 0x1] & BITMASK32);\r\n    }\r\n    y = (this._mt[this._n - 1] & this._upperMask) | (this._mt[0] & this._lowerMask);\r\n    this._mt[this._n - 1] = this._mt[this._m - 1] ^ (y >>> 1) ^ (mag01[y & 0x1] & BITMASK32);\r\n\r\n    this._index = 0;\r\n  }\r\n\r\n  /**\r\n   * Return next 32 bit integer number in sequence\r\n   */\r\n  public nextInt(): number {\r\n    if (this._index >= this._n) {\r\n      this._twist();\r\n    }\r\n\r\n    let y = this._mt[this._index++];\r\n\r\n    y ^= y >>> this._u;\r\n    y ^= (y << this._s) & this._b;\r\n    y ^= (y << this._t) & this._c;\r\n    y ^= y >>> this._l;\r\n\r\n    return y >>> 0;\r\n  }\r\n\r\n  /**\r\n   * Return a random floating point number between [0, 1)\r\n   */\r\n  public next(): number {\r\n    return this.nextInt() * (1.0 / 4294967296.0); // divided by 2^32\r\n  }\r\n\r\n  /**\r\n   * Return a random floating point in range [min, max) min is included, max is not included\r\n   */\r\n  public floating(min: number, max: number): number {\r\n    return (max - min) * this.next() + min;\r\n  }\r\n\r\n  /**\r\n   * Return a random integer in range [min, max] min is included, max is included.\r\n   * Implemented with rejection sampling, see https://medium.com/@betable/tifu-by-using-math-random-f1c308c4fd9d#.i13tdiu5a\r\n   */\r\n  public integer(min: number, max: number): number {\r\n    return Math.floor((max - min + 1) * this.next() + min);\r\n  }\r\n\r\n  /**\r\n   * Returns true or false randomly with 50/50 odds by default.\r\n   * By default the likelihood of returning a true is .5 (50%).\r\n   * @param likelihood takes values between [0, 1]\r\n   */\r\n  public bool(likelihood: number = 0.5): boolean {\r\n    return this.next() <= likelihood;\r\n  }\r\n\r\n  /**\r\n   * Returns one element from an array at random\r\n   */\r\n  public pickOne<T>(array: Array<T>): T {\r\n    return array[this.integer(0, array.length - 1)];\r\n  }\r\n\r\n  /**\r\n   * Returns a new array random picking elements from the original\r\n   * @param array Original array to pick from\r\n   * @param numPicks can be any positive number\r\n   * @param allowDuplicates indicates whether the returned set is allowed duplicates (it does not mean there will always be duplicates\r\n   * just that it is possible)\r\n   */\r\n  public pickSet<T>(array: Array<T>, numPicks: number, allowDuplicates: boolean = false): Array<T> {\r\n    if (allowDuplicates) {\r\n      return this._pickSetWithDuplicates(array, numPicks);\r\n    } else {\r\n      return this._pickSetWithoutDuplicates(array, numPicks);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns a new array randomly picking elements in the original (not reused)\r\n   * @param array Array to pick elements out of\r\n   * @param numPicks must be less than or equal to the number of elements in the array.\r\n   */\r\n  private _pickSetWithoutDuplicates<T>(array: Array<T>, numPicks: number): Array<T> {\r\n    if (numPicks > array.length || numPicks < 0) {\r\n      throw new Error('Invalid number of elements to pick, must pick a value 0 < n <= length');\r\n    }\r\n    if (numPicks === array.length) {\r\n      return array;\r\n    }\r\n\r\n    const result: Array<T> = new Array<T>(numPicks);\r\n    let currentPick = 0;\r\n    const tempArray = array.slice(0);\r\n    while (currentPick < numPicks) {\r\n      const index = this.integer(0, tempArray.length - 1);\r\n      result[currentPick++] = tempArray[index];\r\n      tempArray.splice(index, 1);\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Returns a new array random picking elements from the original allowing duplicates\r\n   * @param array Array to pick elements out of\r\n   * @param numPicks can be any positive number\r\n   */\r\n  private _pickSetWithDuplicates<T>(array: Array<T>, numPicks: number): Array<T> {\r\n    // Typescript numbers are all floating point, so do we add check for int? (or floor the input?)\r\n    if (numPicks < 0) {\r\n      throw new Error('Invalid number of elements to pick, must pick a value 0 <= n < MAX_INT');\r\n    }\r\n    const result = new Array<T>(numPicks);\r\n    for (let i = 0; i < numPicks; i++) {\r\n      result[i] = this.pickOne(array);\r\n    }\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Returns a new array that has its elements shuffled. Using the Fisher/Yates method\r\n   * https://en.wikipedia.org/wiki/Fisher%E2%80%93Yates_shuffle\r\n   */\r\n  public shuffle<T>(array: Array<T>): Array<T> {\r\n    const tempArray = array.slice(0);\r\n    let swap: T = null;\r\n    for (let i = 0; i < tempArray.length - 2; i++) {\r\n      const randomIndex = this.integer(i, tempArray.length - 1);\r\n      swap = tempArray[i];\r\n      tempArray[i] = tempArray[randomIndex];\r\n      tempArray[randomIndex] = swap;\r\n    }\r\n\r\n    return tempArray;\r\n  }\r\n\r\n  /**\r\n   * Generate a list of random integer numbers\r\n   * @param length the length of the final array\r\n   * @param min the minimum integer number to generate inclusive\r\n   * @param max the maximum integer number to generate inclusive\r\n   */\r\n  public range(length: number, min: number, max: number): Array<number> {\r\n    const result: Array<number> = new Array(length);\r\n    for (let i = 0; i < length; i++) {\r\n      result[i] = this.integer(min, max);\r\n    }\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Returns the result of a d4 dice roll\r\n   */\r\n  public d4() {\r\n    return this.integer(1, 4);\r\n  }\r\n\r\n  /**\r\n   * Returns the result of a d6 dice roll\r\n   */\r\n  public d6() {\r\n    return this.integer(1, 6);\r\n  }\r\n\r\n  /**\r\n   * Returns the result of a d8 dice roll\r\n   */\r\n  public d8() {\r\n    return this.integer(1, 8);\r\n  }\r\n\r\n  /**\r\n   * Returns the result of a d10 dice roll\r\n   */\r\n  public d10() {\r\n    return this.integer(1, 10);\r\n  }\r\n\r\n  /**\r\n   * Returns the result of a d12 dice roll\r\n   */\r\n  public d12() {\r\n    return this.integer(1, 12);\r\n  }\r\n\r\n  /**\r\n   * Returns the result of a d20 dice roll\r\n   */\r\n  public d20() {\r\n    return this.integer(1, 20);\r\n  }\r\n}\r\n","import { Random } from './Random';\r\n\r\n/**\r\n * Two PI constant\r\n */\r\nexport const TwoPI: number = Math.PI * 2;\r\n\r\n/**\r\n * Returns the fractional part of a number\r\n * @param x\r\n */\r\nexport function frac(x: number): number {\r\n  if (x >= 0) {\r\n    return x - Math.floor(x);\r\n  } else {\r\n    return x - Math.ceil(x);\r\n  }\r\n}\r\n\r\n/**\r\n * Returns the sign of a number, if 0 returns 0\r\n */\r\nexport function sign(val: number): number {\r\n  if (val === 0) {\r\n    return 0;\r\n  }\r\n  return val < 0 ? -1 : 1;\r\n};\r\n\r\n/**\r\n * Clamps a value between a min and max inclusive\r\n */\r\nexport function clamp(val: number, min: number, max: number) {\r\n  return Math.min(Math.max(min, val), max);\r\n}\r\n\r\n\r\n/**\r\n * Convert an angle to be the equivalent in the range [0, 2PI]\r\n */\r\nexport function canonicalizeAngle(angle: number): number {\r\n  let tmpAngle = angle;\r\n  if (angle > TwoPI) {\r\n    while (tmpAngle > TwoPI) {\r\n      tmpAngle -= TwoPI;\r\n    }\r\n  }\r\n\r\n  if (angle < 0) {\r\n    while (tmpAngle < 0) {\r\n      tmpAngle += TwoPI;\r\n    }\r\n  }\r\n  return tmpAngle;\r\n}\r\n\r\n/**\r\n * Convert radians to degrees\r\n */\r\nexport function toDegrees(radians: number): number {\r\n  return (180 / Math.PI) * radians;\r\n}\r\n\r\n/**\r\n * Convert degrees to radians\r\n */\r\nexport function toRadians(degrees: number): number {\r\n  return (degrees / 180) * Math.PI;\r\n}\r\n\r\n/**\r\n * Generate a range of numbers\r\n * For example: range(0, 5) -> [0, 1, 2, 3, 4, 5]\r\n * @param from inclusive\r\n * @param to inclusive\r\n */\r\nexport const range = (from: number, to: number) => Array.from(new Array(to - from + 1), (_x, i) => i + from);\r\n\r\n/**\r\n * Find a random floating point number in range\r\n */\r\nexport function randomInRange(min: number, max: number, random: Random = new Random()): number {\r\n  return random ? random.floating(min, max) : min + Math.random() * (max - min);\r\n}\r\n\r\n/**\r\n * Find a random integer in a range\r\n */\r\nexport function randomIntInRange(min: number, max: number, random: Random = new Random()): number {\r\n  return random ? random.integer(min, max) : Math.round(randomInRange(min, max));\r\n}","import { Clonable } from '../Interfaces/Clonable';\r\nimport { clamp } from './util';\r\n\r\n/**\r\n * A 2D vector on a plane.\r\n */\r\n\r\nexport class Vector implements Clonable<Vector> {\r\n  /**\r\n   * A (0, 0) vector\r\n   */\r\n  public static get Zero() {\r\n    return new Vector(0, 0);\r\n  }\r\n\r\n  /**\r\n   * A (1, 1) vector\r\n   */\r\n  public static get One() {\r\n    return new Vector(1, 1);\r\n  }\r\n\r\n  /**\r\n   * A (0.5, 0.5) vector\r\n   */\r\n  public static get Half() {\r\n    return new Vector(0.5, 0.5);\r\n  }\r\n\r\n  /**\r\n   * A unit vector pointing up (0, -1)\r\n   */\r\n  public static get Up() {\r\n    return new Vector(0, -1);\r\n  }\r\n\r\n  /**\r\n   * A unit vector pointing down (0, 1)\r\n   */\r\n  public static get Down() {\r\n    return new Vector(0, 1);\r\n  }\r\n\r\n  /**\r\n   * A unit vector pointing left (-1, 0)\r\n   */\r\n  public static get Left() {\r\n    return new Vector(-1, 0);\r\n  }\r\n  /**\r\n   * A unit vector pointing right (1, 0)\r\n   */\r\n  public static get Right() {\r\n    return new Vector(1, 0);\r\n  }\r\n\r\n  /**\r\n   * Returns a vector of unit length in the direction of the specified angle in Radians.\r\n   * @param angle The angle to generate the vector\r\n   */\r\n  public static fromAngle(angle: number) {\r\n    return new Vector(Math.cos(angle), Math.sin(angle));\r\n  }\r\n\r\n  /**\r\n   * Checks if vector is not null, undefined, or if any of its components are NaN or Infinity.\r\n   */\r\n  public static isValid(vec: Vector) {\r\n    if (vec === null || vec === undefined) {\r\n      return false;\r\n    }\r\n    if (isNaN(vec.x) || isNaN(vec.y)) {\r\n      return false;\r\n    }\r\n\r\n    if (vec.x === Infinity || vec.y === Infinity || vec.x === -Infinity || vec.y === -Infinity) {\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Calculates distance between two Vectors\r\n   * @param vec1\r\n   * @param vec2\r\n   */\r\n  public static distance(vec1: Vector, vec2: Vector) {\r\n    return Math.sqrt(Math.pow(vec1.x - vec2.x, 2) + Math.pow(vec1.y - vec2.y, 2));\r\n  }\r\n\r\n  public static min(vec1: Vector, vec2: Vector) {\r\n    return new Vector(Math.min(vec1.x, vec2.x), Math.min(vec1.y, vec2.y));\r\n  }\r\n\r\n  public static max(vec1: Vector, vec2: Vector) {\r\n    return new Vector(Math.max(vec1.x, vec2.x), Math.max(vec1.y, vec2.y));\r\n  }\r\n\r\n  /**\r\n   * @param x  X component of the Vector\r\n   * @param y  Y component of the Vector\r\n   */\r\n  constructor(x: number, y: number) {\r\n    this._x = x;\r\n    this._y = y;\r\n  }\r\n\r\n  protected _x = 0;\r\n  /**\r\n   * Get the x component of the vector\r\n   */\r\n  public get x(): number {\r\n    return this._x;\r\n  }\r\n\r\n  /**\r\n   * Set the x component, THIS MUTATES the current vector. It is usually better to create a new vector.\r\n   * @warning **Be very careful setting components on shared vectors, mutating shared vectors can cause hard to find bugs**\r\n   */\r\n  public set x(val: number) {\r\n    this._x = val;\r\n  }\r\n\r\n  protected _y = 0;\r\n  /**\r\n   * Get the y component of the vector\r\n   */\r\n  public get y(): number {\r\n    return this._y;\r\n  }\r\n\r\n  /**\r\n   * Set the y component, THIS MUTATES the current vector. It is usually better to create a new vector.\r\n   * @warning **Be very careful setting components on shared vectors, mutating shared vectors can cause hard to find bugs**\r\n   */\r\n  public set y(val: number) {\r\n    this._y = val;\r\n  }\r\n\r\n  /**\r\n   * Sets the x and y components at once, THIS MUTATES the current vector. It is usually better to create a new vector.\r\n   *\r\n   * @warning **Be very careful using this, mutating vectors can cause hard to find bugs**\r\n   */\r\n  setTo(x: number, y: number) {\r\n    (this.x as number) = x;\r\n    (this.y as number) = y;\r\n  }\r\n\r\n  /**\r\n   * Compares this point against another and tests for equality\r\n   * @param vector The other point to compare to\r\n   * @param tolerance Amount of euclidean distance off we are willing to tolerate\r\n   */\r\n  public equals(vector: Vector, tolerance: number = 0.001): boolean {\r\n    return Math.abs(this.x - vector.x) <= tolerance && Math.abs(this.y - vector.y) <= tolerance;\r\n  }\r\n\r\n  /**\r\n   * The distance to another vector. If no other Vector is specified, this will return the [[magnitude]].\r\n   * @param v  The other vector. Leave blank to use origin vector.\r\n   */\r\n  public distance(v?: Vector): number {\r\n    if (!v) {\r\n      return Math.sqrt(this.x * this.x + this.y * this.y);\r\n    }\r\n    const deltaX = this.x - v.x;\r\n    const deltaY = this.y - v.y;\r\n    return Math.sqrt(deltaX * deltaX + deltaY * deltaY);\r\n  }\r\n\r\n  public squareDistance(v?: Vector): number {\r\n    if (!v) {\r\n      v = Vector.Zero;\r\n    }\r\n    const deltaX = this.x - v.x;\r\n    const deltaY = this.y - v.y;\r\n    return deltaX * deltaX + deltaY * deltaY;\r\n  }\r\n\r\n  /**\r\n   * Clamps the current vector's magnitude mutating it\r\n   * @param magnitude\r\n   */\r\n  public clampMagnitude(magnitude: number): Vector {\r\n    const size = this.size;\r\n    const newSize = clamp(size, 0, magnitude);\r\n    this.size = newSize;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * The size (magnitude) of the Vector\r\n   */\r\n  public get size(): number {\r\n    return this.distance();\r\n  }\r\n\r\n  /**\r\n   * Setting the size mutates the current vector\r\n   *\r\n   * @warning Can be used to set the size of the vector, **be very careful using this, mutating vectors can cause hard to find bugs**\r\n   */\r\n  public set size(newLength: number) {\r\n    const v = this.normalize().scale(newLength);\r\n    this.setTo(v.x, v.y);\r\n  }\r\n\r\n  /**\r\n   * Normalizes a vector to have a magnitude of 1.\r\n   */\r\n  public normalize(): Vector {\r\n    const d = this.distance();\r\n    if (d > 0) {\r\n      return new Vector(this.x / d, this.y / d);\r\n    } else {\r\n      return new Vector(0, 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns the average (midpoint) between the current point and the specified\r\n   */\r\n  public average(vec: Vector): Vector {\r\n    return this.add(vec).scale(0.5);\r\n  }\r\n\r\n  /**\r\n   * Scales a vector's by a factor of size\r\n   * @param size  The factor to scale the magnitude by\r\n   * @param dest  Optionally provide a destination vector for the result\r\n   */\r\n  public scale(scale: Vector, dest?: Vector): Vector;\r\n  public scale(size: number, dest?: Vector): Vector;\r\n  public scale(sizeOrScale: number | Vector, dest?: Vector): Vector {\r\n    const result = dest || new Vector(0, 0);\r\n    if (sizeOrScale instanceof Vector) {\r\n      result.x = this.x * sizeOrScale.x;\r\n      result.y = this.y * sizeOrScale.y;\r\n    } else {\r\n      result.x = this.x * sizeOrScale;\r\n      result.y = this.y * sizeOrScale;\r\n    }\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Adds one vector to another\r\n   * @param v The vector to add\r\n   * @param dest Optionally copy the result into a provided vector\r\n   */\r\n  public add(v: Vector, dest?: Vector): Vector {\r\n    if (dest) {\r\n      dest.x = this.x + v.x;\r\n      dest.y = this.y + v.y;\r\n      return dest;\r\n    }\r\n    return new Vector(this.x + v.x, this.y + v.y);\r\n  }\r\n\r\n  /**\r\n   * Subtracts a vector from another, if you subtract vector `B.sub(A)` the resulting vector points from A -> B\r\n   * @param v The vector to subtract\r\n   */\r\n  public sub(v: Vector): Vector {\r\n    return new Vector(this.x - v.x, this.y - v.y);\r\n  }\r\n\r\n  /**\r\n   * Adds one vector to this one modifying the original\r\n   * @param v The vector to add\r\n   * @warning Be very careful using this, mutating vectors can cause hard to find bugs\r\n   */\r\n  public addEqual(v: Vector): Vector {\r\n    this.setTo(this.x + v.x, this.y + v.y);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Subtracts a vector from this one modifying the original\r\n   * @param v The vector to subtract\r\n   * @warning Be very careful using this, mutating vectors can cause hard to find bugs\r\n   */\r\n  public subEqual(v: Vector): Vector {\r\n    this.setTo(this.x - v.x, this.y - v.y);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Scales this vector by a factor of size and modifies the original\r\n   * @warning Be very careful using this, mutating vectors can cause hard to find bugs\r\n   */\r\n  public scaleEqual(size: number): Vector {\r\n    this.setTo(this.x * size, this.y * size);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Performs a dot product with another vector\r\n   * @param v  The vector to dot\r\n   */\r\n  public dot(v: Vector): number {\r\n    return this.x * v.x + this.y * v.y;\r\n  }\r\n\r\n  /**\r\n   * Performs a 2D cross product with scalar. 2D cross products with a scalar return a vector.\r\n   * @param v  The scalar to cross\r\n   */\r\n  public cross(v: number): Vector;\r\n  /**\r\n   * Performs a 2D cross product with another vector. 2D cross products return a scalar value not a vector.\r\n   * @param v  The vector to cross\r\n   */\r\n  public cross(v: Vector): number;\r\n  public cross(v: any): any {\r\n    if (v instanceof Vector) {\r\n      return this.x * v.y - this.y * v.x;\r\n    } else if (typeof v === 'number') {\r\n      return new Vector(v * this.y, -v * this.x);\r\n    }\r\n  }\r\n\r\n  static cross(num: number, vec: Vector): Vector {\r\n    return new Vector(-num * vec.y, num * vec.x);\r\n  }\r\n\r\n  /**\r\n   * Returns the perpendicular vector to this one\r\n   */\r\n  public perpendicular(): Vector {\r\n    return new Vector(this.y, -this.x);\r\n  }\r\n\r\n  /**\r\n   * Returns the normal vector to this one, same as the perpendicular of length 1\r\n   */\r\n  public normal(): Vector {\r\n    return this.perpendicular().normalize();\r\n  }\r\n\r\n  /**\r\n   * Negate the current vector\r\n   */\r\n  public negate(): Vector {\r\n    return this.scale(-1);\r\n  }\r\n\r\n  /**\r\n   * Returns the angle of this vector.\r\n   */\r\n  public toAngle(): number {\r\n    return Math.atan2(this.y, this.x);\r\n  }\r\n\r\n  /**\r\n   * Rotates the current vector around a point by a certain number of\r\n   * degrees in radians\r\n   */\r\n  public rotate(angle: number, anchor?: Vector): Vector {\r\n    if (!anchor) {\r\n      anchor = new Vector(0, 0);\r\n    }\r\n    const sinAngle = Math.sin(angle);\r\n    const cosAngle = Math.cos(angle);\r\n    const x = cosAngle * (this.x - anchor.x) - sinAngle * (this.y - anchor.y) + anchor.x;\r\n    const y = sinAngle * (this.x - anchor.x) + cosAngle * (this.y - anchor.y) + anchor.y;\r\n    return new Vector(x, y);\r\n  }\r\n\r\n  /**\r\n   * Creates new vector that has the same values as the previous.\r\n   */\r\n  public clone(dest?: Vector): Vector {\r\n    const v = dest ?? new Vector(0, 0);\r\n    v.x = this.x;\r\n    v.y = this.y;\r\n    return v;\r\n  }\r\n\r\n  /**\r\n   * Returns a string representation of the vector.\r\n   */\r\n  public toString(fixed?: number): string {\r\n    if (fixed) {\r\n      return `(${this.x.toFixed(fixed)}, ${this.y.toFixed(fixed)})`;\r\n    }\r\n    return `(${this.x}, ${this.y})`;\r\n  }\r\n}\r\n\r\n/**\r\n * Shorthand for creating new Vectors - returns a new Vector instance with the\r\n * provided X and Y components.\r\n *\r\n * @param x  X component of the Vector\r\n * @param y  Y component of the Vector\r\n */\r\nexport function vec(x: number, y: number): Vector {\r\n  return new Vector(x, y);\r\n}\r\n","/* eslint-disable no-console */\r\n/**\r\n * Logging level that Excalibur will tag\r\n */\r\nexport enum LogLevel {\r\n  Debug,\r\n  Info,\r\n  Warn,\r\n  Error,\r\n  Fatal\r\n}\r\n\r\n/**\r\n * Static singleton that represents the logging facility for Excalibur.\r\n * Excalibur comes built-in with a [[ConsoleAppender]] and [[ScreenAppender]].\r\n * Derive from [[Appender]] to create your own logging appenders.\r\n */\r\nexport class Logger {\r\n  private static _INSTANCE: Logger = null;\r\n  private _appenders: Appender[] = [];\r\n\r\n  constructor() {\r\n    if (Logger._INSTANCE) {\r\n      throw new Error('Logger is a singleton');\r\n    }\r\n    Logger._INSTANCE = this;\r\n    // Default console appender\r\n    Logger._INSTANCE.addAppender(new ConsoleAppender());\r\n    return Logger._INSTANCE;\r\n  }\r\n\r\n  /**\r\n   * Gets or sets the default logging level. Excalibur will only log\r\n   * messages if equal to or above this level. Default: [[LogLevel.Info]]\r\n   */\r\n  public defaultLevel: LogLevel = LogLevel.Info;\r\n\r\n  /**\r\n   * Gets the current static instance of Logger\r\n   */\r\n  public static getInstance(): Logger {\r\n    if (Logger._INSTANCE == null) {\r\n      Logger._INSTANCE = new Logger();\r\n    }\r\n    return Logger._INSTANCE;\r\n  }\r\n\r\n  /**\r\n   * Adds a new [[Appender]] to the list of appenders to write to\r\n   */\r\n  public addAppender(appender: Appender): void {\r\n    this._appenders.push(appender);\r\n  }\r\n\r\n  /**\r\n   * Clears all appenders from the logger\r\n   */\r\n  public clearAppenders(): void {\r\n    this._appenders.length = 0;\r\n  }\r\n\r\n  /**\r\n   * Logs a message at a given LogLevel\r\n   * @param level  The LogLevel`to log the message at\r\n   * @param args   An array of arguments to write to an appender\r\n   */\r\n  private _log(level: LogLevel, args: any[]): void {\r\n    if (level == null) {\r\n      level = this.defaultLevel;\r\n    }\r\n\r\n    const len = this._appenders.length;\r\n\r\n    for (let i = 0; i < len; i++) {\r\n      if (level >= this.defaultLevel) {\r\n        this._appenders[i].log(level, args);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Writes a log message at the [[LogLevel.Debug]] level\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public debug(...args: any[]): void {\r\n    this._log(LogLevel.Debug, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message at the [[LogLevel.Info]] level\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public info(...args: any[]): void {\r\n    this._log(LogLevel.Info, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message at the [[LogLevel.Warn]] level\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public warn(...args: any[]): void {\r\n    this._log(LogLevel.Warn, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message at the [[LogLevel.Error]] level\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public error(...args: any[]): void {\r\n    this._log(LogLevel.Error, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message at the [[LogLevel.Fatal]] level\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public fatal(...args: any[]): void {\r\n    this._log(LogLevel.Fatal, args);\r\n  }\r\n}\r\n\r\n/**\r\n * Contract for any log appender (such as console/screen)\r\n */\r\nexport interface Appender {\r\n  /**\r\n   * Logs a message at the given [[LogLevel]]\r\n   * @param level  Level to log at\r\n   * @param args   Arguments to log\r\n   */\r\n  log(level: LogLevel, args: any[]): void;\r\n}\r\n\r\n/**\r\n * Console appender for browsers (i.e. `console.log`)\r\n */\r\nexport class ConsoleAppender implements Appender {\r\n  /**\r\n   * Logs a message at the given [[LogLevel]]\r\n   * @param level  Level to log at\r\n   * @param args   Arguments to log\r\n   */\r\n  public log(level: LogLevel, args: any[]): void {\r\n    // Check for console support\r\n    if (!console && !console.log && console.warn && console.error) {\r\n      // todo maybe do something better than nothing\r\n      return;\r\n    }\r\n\r\n    // Create a new console args array\r\n    const consoleArgs: any[] = [];\r\n    consoleArgs.unshift.apply(consoleArgs, args);\r\n    consoleArgs.unshift('[' + LogLevel[level] + '] : ');\r\n\r\n    if (level < LogLevel.Warn) {\r\n      // Call .log for Debug/Info\r\n      if (console.log.apply) {\r\n        // this is required on some older browsers that don't support apply on console.log :(\r\n        console.log.apply(console, consoleArgs);\r\n      } else {\r\n        console.log(consoleArgs.join(' '));\r\n      }\r\n    } else if (level < LogLevel.Error) {\r\n      // Call .warn for Warn\r\n      if (console.warn.apply) {\r\n        console.warn.apply(console, consoleArgs);\r\n      } else {\r\n        console.warn(consoleArgs.join(' '));\r\n      }\r\n    } else {\r\n      // Call .error for Error/Fatal\r\n      if (console.error.apply) {\r\n        console.error.apply(console, consoleArgs);\r\n      } else {\r\n        console.error(consoleArgs.join(' '));\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * On-screen (canvas) appender\r\n */\r\nexport class ScreenAppender implements Appender {\r\n  // @todo Clean this up\r\n\r\n  private _messages: string[] = [];\r\n  private _canvas: HTMLCanvasElement;\r\n  private _ctx: CanvasRenderingContext2D;\r\n\r\n  /**\r\n   * @param width   Width of the screen appender in pixels\r\n   * @param height  Height of the screen appender in pixels\r\n   */\r\n  constructor(width?: number, height?: number) {\r\n    this._canvas = <HTMLCanvasElement>document.createElement('canvas');\r\n    this._canvas.width = width || window.innerWidth;\r\n    this._canvas.height = height || window.innerHeight;\r\n    this._canvas.style.position = 'absolute';\r\n    // eslint-disable-next-line\r\n    this._ctx = <CanvasRenderingContext2D>this._canvas.getContext('2d'); // eslint-disable-line\r\n    document.body.appendChild(this._canvas);\r\n  }\r\n\r\n  /**\r\n   * Logs a message at the given [[LogLevel]]\r\n   * @param level  Level to log at\r\n   * @param args   Arguments to log\r\n   */\r\n  public log(level: LogLevel, args: any[]): void {\r\n    const message = args.join(',');\r\n\r\n    this._ctx.clearRect(0, 0, this._canvas.width, this._canvas.height);\r\n\r\n    this._messages.unshift('[' + LogLevel[level] + '] : ' + message);\r\n\r\n    let pos = 10;\r\n    let opacity = 1.0;\r\n    for (let i = 0; i < this._messages.length; i++) {\r\n      this._ctx.fillStyle = 'rgba(255,255,255,' + opacity.toFixed(2) + ')';\r\n      this._ctx.fillText(this._messages[i], 200, pos);\r\n      pos += 10;\r\n      opacity = opacity > 0 ? opacity - 0.05 : 0;\r\n    }\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\r\n\r\n/**\r\n * An enum that describes the sides of an axis aligned box for collision\r\n */\r\nexport enum Side {\r\n  None = 'None',\r\n  Top = 'Top',\r\n  Bottom = 'Bottom',\r\n  Left = 'Left',\r\n  Right = 'Right'\r\n}\r\n\r\nexport module Side {\r\n  /**\r\n   * Returns the opposite side from the current\r\n   */\r\n  export function getOpposite(side: Side): Side {\r\n    if (side === Side.Top) {\r\n      return Side.Bottom;\r\n    }\r\n    if (side === Side.Bottom) {\r\n      return Side.Top;\r\n    }\r\n    if (side === Side.Left) {\r\n      return Side.Right;\r\n    }\r\n    if (side === Side.Right) {\r\n      return Side.Left;\r\n    }\r\n\r\n    return Side.None;\r\n  }\r\n\r\n  /**\r\n   * Given a vector, return the Side most in that direction (via dot product)\r\n   */\r\n  export function fromDirection(direction: Vector): Side {\r\n    const directions = [Vector.Left, Vector.Right, Vector.Up, Vector.Down];\r\n    const directionEnum = [Side.Left, Side.Right, Side.Top, Side.Bottom];\r\n\r\n    let max = -Number.MAX_VALUE;\r\n    let maxIndex = -1;\r\n    for (let i = 0; i < directions.length; i++) {\r\n      if (directions[i].dot(direction) > max) {\r\n        max = directions[i].dot(direction);\r\n        maxIndex = i;\r\n      }\r\n    }\r\n    return directionEnum[maxIndex];\r\n  }\r\n}\r\n","import { sign } from './util';\r\nimport { Vector, vec } from './vector';\r\nimport { canonicalizeAngle } from './util';\r\n\r\nexport enum MatrixLocations {\r\n  X = 12,\r\n  Y = 13\r\n}\r\n\r\n/**\r\n * Excalibur Matrix helper for 4x4 matrices\r\n *\r\n * Useful for webgl 4x4 matrices\r\n */\r\nexport class Matrix {\r\n  /**\r\n   *  4x4 matrix in column major order\r\n   *\r\n   * |         |         |          |          |\r\n   * | ------- | ------- | -------- | -------- |\r\n   * | data[0] | data[4] | data[8]  | data[12] |\r\n   * | data[1] | data[5] | data[9]  | data[13] |\r\n   * | data[2] | data[6] | data[10] | data[14] |\r\n   * | data[3] | data[7] | data[11] | data[15] |\r\n   *\r\n   */\r\n  public data: Float32Array = new Float32Array(16);\r\n\r\n  /**\r\n   * Creates an orthographic (flat non-perspective) projection\r\n   * https://en.wikipedia.org/wiki/Orthographic_projection\r\n   * @param left\r\n   * @param right\r\n   * @param bottom\r\n   * @param top\r\n   * @param near\r\n   * @param far\r\n   */\r\n  public static ortho(left: number, right: number, bottom: number, top: number, near: number, far: number): Matrix {\r\n    const mat = new Matrix();\r\n    mat.data[0] = 2 / (right - left);\r\n    mat.data[1] = 0;\r\n    mat.data[2] = 0;\r\n    mat.data[3] = 0;\r\n\r\n    mat.data[4] = 0;\r\n    mat.data[5] = 2 / (top - bottom);\r\n    mat.data[6] = 0;\r\n    mat.data[7] = 0;\r\n\r\n    mat.data[8] = 0;\r\n    mat.data[9] = 0;\r\n    mat.data[10] = -2 / (far - near);\r\n    mat.data[11] = 0;\r\n\r\n    mat.data[12] = -(right + left) / (right - left);\r\n    mat.data[13] = -(top + bottom) / (top - bottom);\r\n    mat.data[14] = -(far + near) / (far - near);\r\n    mat.data[15] = 1;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a new Matrix with the same data as the current 4x4\r\n   */\r\n  public clone(dest?: Matrix): Matrix {\r\n    const mat = dest || new Matrix();\r\n    mat.data[0] = this.data[0];\r\n    mat.data[1] = this.data[1];\r\n    mat.data[2] = this.data[2];\r\n    mat.data[3] = this.data[3];\r\n\r\n    mat.data[4] = this.data[4];\r\n    mat.data[5] = this.data[5];\r\n    mat.data[6] = this.data[6];\r\n    mat.data[7] = this.data[7];\r\n\r\n    mat.data[8] = this.data[8];\r\n    mat.data[9] = this.data[9];\r\n    mat.data[10] = this.data[10];\r\n    mat.data[11] = this.data[11];\r\n\r\n    mat.data[12] = this.data[12];\r\n    mat.data[13] = this.data[13];\r\n    mat.data[14] = this.data[14];\r\n    mat.data[15] = this.data[15];\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Converts the current matrix into a DOMMatrix\r\n   *\r\n   * This is useful when working with the browser Canvas context\r\n   * @returns {DOMMatrix} DOMMatrix\r\n   */\r\n  public toDOMMatrix(): DOMMatrix {\r\n    return new DOMMatrix([...this.data]);\r\n  }\r\n\r\n  public static fromFloat32Array(data: Float32Array) {\r\n    const matrix =  new Matrix();\r\n    matrix.data = data;\r\n    return matrix;\r\n  }\r\n\r\n  /**\r\n   * Creates a new identity matrix (a matrix that when applied does nothing)\r\n   */\r\n  public static identity(): Matrix {\r\n    const mat = new Matrix();\r\n    mat.data[0] = 1;\r\n    mat.data[1] = 0;\r\n    mat.data[2] = 0;\r\n    mat.data[3] = 0;\r\n\r\n    mat.data[4] = 0;\r\n    mat.data[5] = 1;\r\n    mat.data[6] = 0;\r\n    mat.data[7] = 0;\r\n\r\n    mat.data[8] = 0;\r\n    mat.data[9] = 0;\r\n    mat.data[10] = 1;\r\n    mat.data[11] = 0;\r\n\r\n    mat.data[12] = 0;\r\n    mat.data[13] = 0;\r\n    mat.data[14] = 0;\r\n    mat.data[15] = 1;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Resets the current matrix to the identity matrix, mutating it\r\n   * @returns {Matrix} Current matrix as identity\r\n   */\r\n  public reset(): Matrix {\r\n    const mat = this;\r\n    mat.data[0] = 1;\r\n    mat.data[1] = 0;\r\n    mat.data[2] = 0;\r\n    mat.data[3] = 0;\r\n\r\n    mat.data[4] = 0;\r\n    mat.data[5] = 1;\r\n    mat.data[6] = 0;\r\n    mat.data[7] = 0;\r\n\r\n    mat.data[8] = 0;\r\n    mat.data[9] = 0;\r\n    mat.data[10] = 1;\r\n    mat.data[11] = 0;\r\n\r\n    mat.data[12] = 0;\r\n    mat.data[13] = 0;\r\n    mat.data[14] = 0;\r\n    mat.data[15] = 1;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a brand new translation matrix at the specified 3d point\r\n   * @param x\r\n   * @param y\r\n   */\r\n  public static translation(x: number, y: number): Matrix {\r\n    const mat = Matrix.identity();\r\n    mat.data[12] = x;\r\n    mat.data[13] = y;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a brand new scaling matrix with the specified scaling factor\r\n   * @param sx\r\n   * @param sy\r\n   */\r\n  public static scale(sx: number, sy: number): Matrix {\r\n    const mat = Matrix.identity();\r\n    mat.data[0] = sx;\r\n    mat.data[5] = sy;\r\n    mat.data[10] = 1;\r\n    mat.data[15] = 1;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a brand new rotation matrix with the specified angle\r\n   * @param angleRadians\r\n   */\r\n  public static rotation(angleRadians: number): Matrix {\r\n    const mat = Matrix.identity();\r\n    mat.data[0] = Math.cos(angleRadians);\r\n    mat.data[4] = -Math.sin(angleRadians);\r\n    mat.data[1] = Math.sin(angleRadians);\r\n    mat.data[5] = Math.cos(angleRadians);\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Multiply the current matrix by a vector producing a new vector\r\n   * @param vector\r\n   * @param dest\r\n   */\r\n  multiply(vector: Vector, dest?: Vector): Vector;\r\n  /**\r\n   * Multiply the current matrix by another matrix producing a new matrix\r\n   * @param matrix\r\n   * @param dest\r\n   */\r\n  multiply(matrix: Matrix, dest?: Matrix): Matrix;\r\n  multiply(vectorOrMatrix: Vector | Matrix, dest?: Vector | Matrix): Vector | Matrix {\r\n    if (vectorOrMatrix instanceof Vector) {\r\n      const result = (dest as Vector) || new Vector(0, 0);\r\n      const vector = vectorOrMatrix;\r\n      // these shenanigans are to allow dest and vector to be the same instance\r\n      const resultX = vector.x * this.data[0] + vector.y * this.data[4] + this.data[12];\r\n      const resultY = vector.x * this.data[1] + vector.y * this.data[5] + this.data[13];\r\n\r\n      result.x = resultX;\r\n      result.y = resultY;\r\n      return result;\r\n    } else {\r\n      const result = (dest as Matrix) || new Matrix();\r\n      const other = vectorOrMatrix;\r\n      const a11 = this.data[0];\r\n      const a21 = this.data[1];\r\n      const a31 = this.data[2];\r\n      const a41 = this.data[3];\r\n\r\n      const a12 = this.data[4];\r\n      const a22 = this.data[5];\r\n      const a32 = this.data[6];\r\n      const a42 = this.data[7];\r\n\r\n      const a13 = this.data[8];\r\n      const a23 = this.data[9];\r\n      const a33 = this.data[10];\r\n      const a43 = this.data[11];\r\n\r\n      const a14 = this.data[12];\r\n      const a24 = this.data[13];\r\n      const a34 = this.data[14];\r\n      const a44 = this.data[15];\r\n\r\n      const b11 = other.data[0];\r\n      const b21 = other.data[1];\r\n      const b31 = other.data[2];\r\n      const b41 = other.data[3];\r\n\r\n      const b12 = other.data[4];\r\n      const b22 = other.data[5];\r\n      const b32 = other.data[6];\r\n      const b42 = other.data[7];\r\n\r\n      const b13 = other.data[8];\r\n      const b23 = other.data[9];\r\n      const b33 = other.data[10];\r\n      const b43 = other.data[11];\r\n\r\n      const b14 = other.data[12];\r\n      const b24 = other.data[13];\r\n      const b34 = other.data[14];\r\n      const b44 = other.data[15];\r\n\r\n      result.data[0] = a11 * b11 + a12 * b21 + a13 * b31 + a14 * b41;\r\n      result.data[1] = a21 * b11 + a22 * b21 + a23 * b31 + a24 * b41;\r\n      result.data[2] = a31 * b11 + a32 * b21 + a33 * b31 + a34 * b41;\r\n      result.data[3] = a41 * b11 + a42 * b21 + a43 * b31 + a44 * b41;\r\n\r\n      result.data[4] = a11 * b12 + a12 * b22 + a13 * b32 + a14 * b42;\r\n      result.data[5] = a21 * b12 + a22 * b22 + a23 * b32 + a24 * b42;\r\n      result.data[6] = a31 * b12 + a32 * b22 + a33 * b32 + a34 * b42;\r\n      result.data[7] = a41 * b12 + a42 * b22 + a43 * b32 + a44 * b42;\r\n\r\n      result.data[8] = a11 * b13 + a12 * b23 + a13 * b33 + a14 * b43;\r\n      result.data[9] = a21 * b13 + a22 * b23 + a23 * b33 + a24 * b43;\r\n      result.data[10] = a31 * b13 + a32 * b23 + a33 * b33 + a34 * b43;\r\n      result.data[11] = a41 * b13 + a42 * b23 + a43 * b33 + a44 * b43;\r\n\r\n      result.data[12] = a11 * b14 + a12 * b24 + a13 * b34 + a14 * b44;\r\n      result.data[13] = a21 * b14 + a22 * b24 + a23 * b34 + a24 * b44;\r\n      result.data[14] = a31 * b14 + a32 * b24 + a33 * b34 + a34 * b44;\r\n      result.data[15] = a41 * b14 + a42 * b24 + a43 * b34 + a44 * b44;\r\n\r\n      const s = this.getScale();\r\n      result._scaleSignX = sign(s.x) * sign(result._scaleSignX);\r\n      result._scaleSignY = sign(s.y) * sign(result._scaleSignY);\r\n\r\n      return result;\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * Applies translation to the current matrix mutating it\r\n   * @param x\r\n   * @param y\r\n   */\r\n  translate(x: number, y: number) {\r\n    const a11 = this.data[0];\r\n    const a21 = this.data[1];\r\n    const a31 = this.data[2];\r\n    const a41 = this.data[3];\r\n\r\n    const a12 = this.data[4];\r\n    const a22 = this.data[5];\r\n    const a32 = this.data[6];\r\n    const a42 = this.data[7];\r\n\r\n    const a13 = this.data[8];\r\n    const a23 = this.data[9];\r\n    const a33 = this.data[10];\r\n    const a43 = this.data[11];\r\n\r\n    const a14 = this.data[12];\r\n    const a24 = this.data[13];\r\n    const a34 = this.data[14];\r\n    const a44 = this.data[15];\r\n\r\n    // Doesn't change z\r\n    const z = 0;\r\n    const w = 1;\r\n    this.data[12] = a11 * x + a12 * y + a13 * z + a14 * w;\r\n    this.data[13] = a21 * x + a22 * y + a23 * z + a24 * w;\r\n    this.data[14] = a31 * x + a32 * y + a33 * z + a34 * w;\r\n    this.data[15] = a41 * x + a42 * y + a43 * z + a44 * w;\r\n\r\n    return this;\r\n  }\r\n\r\n  public setPosition(x: number, y: number) {\r\n    this.data[12] = x;\r\n    this.data[13] = y;\r\n  }\r\n\r\n  public getPosition(): Vector {\r\n    return vec(this.data[12], this.data[13]);\r\n  }\r\n\r\n  /**\r\n   * Applies rotation to the current matrix mutating it\r\n   * @param angle in Radians\r\n   */\r\n  rotate(angle: number) {\r\n    const a11 = this.data[0];\r\n    const a21 = this.data[1];\r\n    const a31 = this.data[2];\r\n    const a41 = this.data[3];\r\n\r\n    const a12 = this.data[4];\r\n    const a22 = this.data[5];\r\n    const a32 = this.data[6];\r\n    const a42 = this.data[7];\r\n\r\n    const sine = Math.sin(angle);\r\n    const cosine = Math.cos(angle);\r\n\r\n    this.data[0] = cosine * a11 + sine * a12;\r\n    this.data[1] = cosine * a21 + sine * a22;\r\n    this.data[2] = cosine * a31 + sine * a32;\r\n    this.data[3] = cosine * a41 + sine * a42;\r\n\r\n    this.data[4] = cosine * a12 - sine * a11;\r\n    this.data[5] = cosine * a22 - sine * a21;\r\n    this.data[6] = cosine * a32 - sine * a31;\r\n    this.data[7] = cosine * a42 - sine * a41;\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Applies scaling to the current matrix mutating it\r\n   * @param x\r\n   * @param y\r\n   */\r\n  scale(x: number, y: number) {\r\n    const a11 = this.data[0];\r\n    const a21 = this.data[1];\r\n    const a31 = this.data[2];\r\n    const a41 = this.data[3];\r\n\r\n    const a12 = this.data[4];\r\n    const a22 = this.data[5];\r\n    const a32 = this.data[6];\r\n    const a42 = this.data[7];\r\n\r\n    this.data[0] = a11 * x;\r\n    this.data[1] = a21 * x;\r\n    this.data[2] = a31 * x;\r\n    this.data[3] = a41 * x;\r\n\r\n    this.data[4] = a12 * y;\r\n    this.data[5] = a22 * y;\r\n    this.data[6] = a32 * y;\r\n    this.data[7] = a42 * y;\r\n\r\n    return this;\r\n  }\r\n\r\n  public setRotation(angle: number) {\r\n    const currentScale = this.getScale();\r\n    const sine = Math.sin(angle);\r\n    const cosine = Math.cos(angle);\r\n\r\n    this.data[0] = cosine * currentScale.x;\r\n    this.data[1] = sine * currentScale.y;\r\n    this.data[4] = -sine * currentScale.x;\r\n    this.data[5] = cosine * currentScale.y;\r\n  }\r\n\r\n  public getRotation(): number {\r\n    const angle = Math.atan2(this.data[1] / this.getScaleY(), this.data[0] / this.getScaleX());\r\n    return canonicalizeAngle(angle);\r\n  }\r\n\r\n  public getScaleX(): number {\r\n    // absolute scale of the matrix (we lose sign so need to add it back)\r\n    const xscale = vec(this.data[0], this.data[4]).size;\r\n    return this._scaleSignX * xscale;\r\n  }\r\n\r\n  public getScaleY(): number {\r\n    // absolute scale of the matrix (we lose sign so need to add it back)\r\n    const yscale = vec(this.data[1], this.data[5]).size;\r\n    return this._scaleSignY * yscale;\r\n  }\r\n\r\n  /**\r\n   * Get the scale of the matrix\r\n   */\r\n  public getScale(): Vector {\r\n    return vec(this.getScaleX(), this.getScaleY());\r\n  }\r\n\r\n  private _scaleX = 1;\r\n  private _scaleSignX = 1;\r\n  public setScaleX(val: number) {\r\n    if (this._scaleX === val) {\r\n      return;\r\n    }\r\n\r\n    this._scaleSignX = sign(val);\r\n    // negative scale acts like a 180 rotation, so flip\r\n    const xscale = vec(this.data[0] * this._scaleSignX, this.data[4] * this._scaleSignX).normalize();\r\n    this.data[0] = xscale.x * val;\r\n    this.data[4] = xscale.y * val;\r\n    this._scaleX = val;\r\n  }\r\n\r\n  private _scaleY = 1;\r\n  private _scaleSignY = 1;\r\n  public setScaleY(val: number) {\r\n    if (this._scaleY === val) {\r\n      return;\r\n    }\r\n    this._scaleSignY = sign(val);\r\n    // negative scale acts like a 180 rotation, so flip\r\n    const yscale = vec(this.data[1] * this._scaleSignY, this.data[5] * this._scaleSignY).normalize();\r\n    this.data[1] = yscale.x * val;\r\n    this.data[5] = yscale.y * val;\r\n    this._scaleY = val;\r\n  }\r\n\r\n  public setScale(scale: Vector) {\r\n    this.setScaleX(scale.x);\r\n    this.setScaleY(scale.y);\r\n  }\r\n\r\n  /**\r\n   * Determinant of the upper left 2x2 matrix\r\n   */\r\n  public getBasisDeterminant() {\r\n    return this.data[0] * this.data[5] - this.data[1] * this.data[4];\r\n  }\r\n\r\n  /**\r\n   * Return the affine inverse, optionally store it in a target matrix.\r\n   *\r\n   * It's recommended you call .reset() the target unless you know what you're doing\r\n   * @param target\r\n   */\r\n  public getAffineInverse(target?: Matrix): Matrix {\r\n    // See http://negativeprobability.blogspot.com/2011/11/affine-transformations-and-their.html\r\n    // See https://www.mathsisfun.com/algebra/matrix-inverse.html\r\n    // Since we are actually only doing 2D transformations we can use this hack\r\n    // We don't actually use the 3rd or 4th dimension\r\n\r\n    const det = this.getBasisDeterminant();\r\n    const inverseDet = 1 / det; // todo zero check\r\n    const a = this.data[0];\r\n    const b = this.data[4];\r\n    const c = this.data[1];\r\n    const d = this.data[5];\r\n\r\n    const m = target || Matrix.identity();\r\n    // inverts rotation and scale\r\n    m.data[0] = d * inverseDet;\r\n    m.data[1] = -c * inverseDet;\r\n    m.data[4] = -b * inverseDet;\r\n    m.data[5] = a * inverseDet;\r\n\r\n    const tx = this.data[12];\r\n    const ty = this.data[13];\r\n    // invert translation\r\n    // transform translation into the matrix basis created by rot/scale\r\n    m.data[12] = -(tx * m.data[0] + ty * m.data[4]);\r\n    m.data[13] = -(tx * m.data[1] + ty * m.data[5]);\r\n\r\n    return m;\r\n  }\r\n\r\n  public isIdentity(): boolean {\r\n    return (\r\n      this.data[0] === 1 &&\r\n      this.data[1] === 0 &&\r\n      this.data[2] === 0 &&\r\n      this.data[3] === 0 &&\r\n      this.data[4] === 0 &&\r\n      this.data[5] === 1 &&\r\n      this.data[6] === 0 &&\r\n      this.data[7] === 0 &&\r\n      this.data[8] === 0 &&\r\n      this.data[9] === 0 &&\r\n      this.data[10] === 1 &&\r\n      this.data[11] === 0 &&\r\n      this.data[12] === 0 &&\r\n      this.data[13] === 0 &&\r\n      this.data[14] === 0 &&\r\n      this.data[15] === 1\r\n    );\r\n  }\r\n\r\n  public toString() {\r\n    return `\r\n[${this.data[0]} ${this.data[4]} ${this.data[8]} ${this.data[12]}]\r\n[${this.data[1]} ${this.data[5]} ${this.data[9]} ${this.data[13]}]\r\n[${this.data[2]} ${this.data[6]} ${this.data[10]} ${this.data[14]}]\r\n[${this.data[3]} ${this.data[7]} ${this.data[11]} ${this.data[15]}]\r\n`;\r\n  }\r\n}\r\n","import { Scene } from './Scene';\r\nimport { Vector } from './Math/vector';\r\nimport { Actor } from './Actor';\r\nimport { Trigger } from './Trigger';\r\nimport { FrameStats } from './Debug';\r\nimport { Engine } from './Engine';\r\nimport { TileMap } from './TileMap';\r\nimport { Side } from './Collision/Side';\r\nimport * as Input from './Input/Index';\r\nimport { CollisionContact } from './Collision/Detection/CollisionContact';\r\nimport { Collider } from './Collision/Colliders/Collider';\r\nimport { Entity } from './EntityComponentSystem/Entity';\r\nimport { OnInitialize, OnPreUpdate, OnPostUpdate, SceneActivationContext } from './Interfaces/LifecycleEvents';\r\nimport { BodyComponent } from './Collision/BodyComponent';\r\nimport { ExcaliburGraphicsContext } from './Graphics';\r\n\r\nexport enum EventTypes {\r\n  Kill = 'kill',\r\n  PreKill = 'prekill',\r\n  PostKill = 'postkill',\r\n\r\n  PreDraw = 'predraw',\r\n  PostDraw = 'postdraw',\r\n\r\n  PreDebugDraw = 'predebugdraw',\r\n  PostDebugDraw = 'postdebugdraw',\r\n\r\n  PreUpdate = 'preupdate',\r\n  PostUpdate = 'postupdate',\r\n\r\n  PreFrame = 'preframe',\r\n  PostFrame = 'postframe',\r\n\r\n  PreCollision = 'precollision',\r\n  CollisionStart = 'collisionstart',\r\n  CollisionEnd = 'collisionend',\r\n  PostCollision = 'postcollision',\r\n\r\n  Initialize = 'initialize',\r\n  Activate = 'activate',\r\n  Deactivate = 'deactivate',\r\n\r\n  ExitViewport = 'exitviewport',\r\n  EnterViewport = 'enterviewport',\r\n\r\n  ExitTrigger = 'exit',\r\n  EnterTrigger = 'enter',\r\n\r\n  Connect = 'connect',\r\n  Disconnect = 'disconnect',\r\n  Button = 'button',\r\n  Axis = 'axis',\r\n\r\n  Visible = 'visible',\r\n  Hidden = 'hidden',\r\n  Start = 'start',\r\n  Stop = 'stop',\r\n\r\n  PointerUp = 'pointerup',\r\n  PointerDown = 'pointerdown',\r\n  PointerMove = 'pointermove',\r\n  PointerEnter = 'pointerenter',\r\n  PointerLeave = 'pointerleave',\r\n  PointerCancel = 'pointercancel',\r\n  PointerWheel = 'pointerwheel',\r\n\r\n  Up = 'up',\r\n  Down = 'down',\r\n  Move = 'move',\r\n  Enter = 'enter',\r\n  Leave = 'leave',\r\n  Cancel = 'cancel',\r\n  Wheel = 'wheel',\r\n\r\n  Press = 'press',\r\n  Release = 'release',\r\n  Hold = 'hold',\r\n\r\n  PointerDragStart = 'pointerdragstart',\r\n  PointerDragEnd = 'pointerdragend',\r\n  PointerDragEnter = 'pointerdragenter',\r\n  PointerDragLeave = 'pointerdragleave',\r\n  PointerDragMove = 'pointerdragmove'\r\n}\r\n\r\n/* istanbul ignore next */\r\n/* compiler only: these are internal to lib */\r\nexport type kill = 'kill';\r\nexport type prekill = 'prekill';\r\nexport type postkill = 'postkill';\r\n\r\nexport type predraw = 'predraw';\r\nexport type postdraw = 'postdraw';\r\n\r\nexport type predebugdraw = 'predebugdraw';\r\nexport type postdebugdraw = 'postdebugdraw';\r\n\r\nexport type preupdate = 'preupdate';\r\nexport type postupdate = 'postupdate';\r\n\r\nexport type preframe = 'preframe';\r\nexport type postframe = 'postframe';\r\n\r\nexport type precollision = 'precollision';\r\nexport type collisionstart = 'collisionstart';\r\nexport type collisionend = 'collisionend';\r\nexport type postcollision = 'postcollision';\r\n\r\nexport type initialize = 'initialize';\r\nexport type activate = 'activate';\r\nexport type deactivate = 'deactivate';\r\n\r\nexport type exitviewport = 'exitviewport';\r\nexport type enterviewport = 'enterviewport';\r\n\r\nexport type exittrigger = 'exit';\r\nexport type entertrigger = 'enter';\r\n\r\nexport type connect = 'connect';\r\nexport type disconnect = 'disconnect';\r\nexport type button = 'button';\r\nexport type axis = 'axis';\r\n\r\nexport type subscribe = 'subscribe';\r\nexport type unsubscribe = 'unsubscribe';\r\n\r\nexport type visible = 'visible';\r\nexport type hidden = 'hidden';\r\nexport type start = 'start';\r\nexport type stop = 'stop';\r\n\r\nexport type pointerup = 'pointerup';\r\nexport type pointerdown = 'pointerdown';\r\nexport type pointermove = 'pointermove';\r\nexport type pointerenter = 'pointerenter';\r\nexport type pointerleave = 'pointerleave';\r\nexport type pointercancel = 'pointercancel';\r\nexport type pointerwheel = 'pointerwheel';\r\n\r\nexport type up = 'up';\r\nexport type down = 'down';\r\nexport type move = 'move';\r\nexport type enter = 'enter';\r\nexport type leave = 'leave';\r\nexport type cancel = 'cancel';\r\nexport type wheel = 'wheel';\r\n\r\nexport type press = 'press';\r\nexport type release = 'release';\r\nexport type hold = 'hold';\r\n\r\nexport type pointerdragstart = 'pointerdragstart';\r\nexport type pointerdragend = 'pointerdragend';\r\nexport type pointerdragenter = 'pointerdragenter';\r\nexport type pointerdragleave = 'pointerdragleave';\r\nexport type pointerdragmove = 'pointerdragmove';\r\n\r\n/**\r\n * Base event type in Excalibur that all other event types derive from. Not all event types are thrown on all Excalibur game objects,\r\n * some events are unique to a type, others are not.\r\n *\r\n */\r\nexport class GameEvent<T, U = T> {\r\n  /**\r\n   * Target object for this event.\r\n   */\r\n  public target: T;\r\n\r\n  /**\r\n   * Other target object for this event\r\n   */\r\n  public other: U | null;\r\n\r\n  /**\r\n   * If set to false, prevents event from propagating to other actors. If true it will be propagated\r\n   * to all actors that apply.\r\n   */\r\n  public get bubbles(): boolean {\r\n    return this._bubbles;\r\n  }\r\n\r\n  public set bubbles(value: boolean) {\r\n    this._bubbles = value;\r\n  }\r\n\r\n  private _bubbles: boolean = true;\r\n  /**\r\n   * Prevents event from bubbling\r\n   */\r\n  public stopPropagation() {\r\n    this.bubbles = false;\r\n  }\r\n}\r\n\r\n/**\r\n * The 'kill' event is emitted on actors when it is killed. The target is the actor that was killed.\r\n */\r\nexport class KillEvent extends GameEvent<Actor> {\r\n  constructor(public target: Actor) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'prekill' event is emitted directly before an actor is killed.\r\n */\r\nexport class PreKillEvent extends GameEvent<Actor> {\r\n  constructor(public target: Actor) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'postkill' event is emitted directly after the actor is killed.\r\n */\r\nexport class PostKillEvent extends GameEvent<Actor> {\r\n  constructor(public target: Actor) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'start' event is emitted on engine when has started and is ready for interaction.\r\n */\r\nexport class GameStartEvent extends GameEvent<Engine> {\r\n  constructor(public target: Engine) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'stop' event is emitted on engine when has been stopped and will no longer take input, update or draw.\r\n */\r\nexport class GameStopEvent extends GameEvent<Engine> {\r\n  constructor(public target: Engine) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'predraw' event is emitted on actors, scenes, and engine before drawing starts. Actors' predraw happens inside their graphics\r\n * transform so that all drawing takes place with the actor as the origin.\r\n *\r\n */\r\nexport class PreDrawEvent extends GameEvent<Entity | Scene | Engine | TileMap> {\r\n  constructor(public ctx: ExcaliburGraphicsContext, public delta: number, public target: Entity | Scene | Engine | TileMap) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'postdraw' event is emitted on actors, scenes, and engine after drawing finishes. Actors' postdraw happens inside their graphics\r\n * transform so that all drawing takes place with the actor as the origin.\r\n *\r\n */\r\nexport class PostDrawEvent extends GameEvent<Entity | Scene | Engine | TileMap> {\r\n  constructor(public ctx: ExcaliburGraphicsContext, public delta: number, public target: Entity | Scene | Engine | TileMap) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'predebugdraw' event is emitted on actors, scenes, and engine before debug drawing starts.\r\n */\r\nexport class PreDebugDrawEvent extends GameEvent<Entity | Actor | Scene | Engine> {\r\n  constructor(public ctx: ExcaliburGraphicsContext, public target: Entity | Actor | Scene | Engine) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'postdebugdraw' event is emitted on actors, scenes, and engine after debug drawing starts.\r\n */\r\nexport class PostDebugDrawEvent extends GameEvent<Entity | Actor | Scene | Engine> {\r\n  constructor(public ctx: ExcaliburGraphicsContext, public target: Entity | Actor | Scene | Engine) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'preupdate' event is emitted on actors, scenes, camera, and engine before the update starts.\r\n */\r\nexport class PreUpdateEvent<T extends OnPreUpdate = Entity> extends GameEvent<T> {\r\n  constructor(public engine: Engine, public delta: number, public target: T) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'postupdate' event is emitted on actors, scenes, camera, and engine after the update ends.\r\n */\r\nexport class PostUpdateEvent<T extends OnPostUpdate = Entity> extends GameEvent<T> {\r\n  constructor(public engine: Engine, public delta: number, public target: T) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'preframe' event is emitted on the engine, before the frame begins.\r\n */\r\nexport class PreFrameEvent extends GameEvent<Engine> {\r\n  constructor(public engine: Engine, public prevStats: FrameStats) {\r\n    super();\r\n    this.target = engine;\r\n  }\r\n}\r\n\r\n/**\r\n * The 'postframe' event is emitted on the engine, after a frame ends.\r\n */\r\nexport class PostFrameEvent extends GameEvent<Engine> {\r\n  constructor(public engine: Engine, public stats: FrameStats) {\r\n    super();\r\n    this.target = engine;\r\n  }\r\n}\r\n\r\n/**\r\n * Event received when a gamepad is connected to Excalibur. [[Gamepads]] receives this event.\r\n */\r\nexport class GamepadConnectEvent extends GameEvent<Input.Gamepad> {\r\n  constructor(public index: number, public gamepad: Input.Gamepad) {\r\n    super();\r\n    this.target = gamepad;\r\n  }\r\n}\r\n\r\n/**\r\n * Event received when a gamepad is disconnected from Excalibur. [[Gamepads]] receives this event.\r\n */\r\nexport class GamepadDisconnectEvent extends GameEvent<Input.Gamepad> {\r\n  constructor(public index: number, public gamepad: Input.Gamepad) {\r\n    super();\r\n    this.target = gamepad;\r\n  }\r\n}\r\n\r\n/**\r\n * Gamepad button event. See [[Gamepads]] for information on responding to controller input. [[Gamepad]] instances receive this event;\r\n */\r\nexport class GamepadButtonEvent extends GameEvent<Input.Gamepad> {\r\n  /**\r\n   * @param button  The Gamepad button\r\n   * @param value   A numeric value between 0 and 1\r\n   */\r\n  constructor(public button: Input.Buttons, public value: number, public target: Input.Gamepad) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * Gamepad axis event. See [[Gamepads]] for information on responding to controller input. [[Gamepad]] instances receive this event;\r\n */\r\nexport class GamepadAxisEvent extends GameEvent<Input.Gamepad> {\r\n  /**\r\n   * @param axis  The Gamepad axis\r\n   * @param value A numeric value between -1 and 1\r\n   */\r\n  constructor(public axis: Input.Axes, public value: number, public target: Input.Gamepad) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * Event received by the [[Engine]] when the browser window is visible on a screen.\r\n */\r\nexport class VisibleEvent extends GameEvent<Engine> {\r\n  constructor(public target: Engine) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * Event received by the [[Engine]] when the browser window is hidden from all screens.\r\n */\r\nexport class HiddenEvent extends GameEvent<Engine> {\r\n  constructor(public target: Engine) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an [[Actor|actor]] when a collision will occur this frame if it resolves\r\n */\r\nexport class PreCollisionEvent<T extends BodyComponent | Collider | Entity = Actor> extends GameEvent<T> {\r\n  /**\r\n   * @param actor         The actor the event was thrown on\r\n   * @param other         The actor that will collided with the current actor\r\n   * @param side          The side that will be collided with the current actor\r\n   * @param intersection  Intersection vector\r\n   */\r\n  constructor(actor: T, public other: T, public side: Side, public intersection: Vector) {\r\n    super();\r\n    this.target = actor;\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an [[Actor|actor]] when a collision has been resolved (body reacted) this frame\r\n */\r\nexport class PostCollisionEvent<T extends Collider | Entity = Actor> extends GameEvent<T> {\r\n  /**\r\n   * @param actor         The actor the event was thrown on\r\n   * @param other         The actor that did collide with the current actor\r\n   * @param side          The side that did collide with the current actor\r\n   * @param intersection  Intersection vector\r\n   */\r\n  constructor(actor: T, public other: T, public side: Side, public intersection: Vector) {\r\n    super();\r\n    this.target = actor;\r\n  }\r\n\r\n  public get actor() {\r\n    return this.target;\r\n  }\r\n\r\n  public set actor(actor: T) {\r\n    this.target = actor;\r\n  }\r\n}\r\n\r\nexport class ContactStartEvent<T> {\r\n  constructor(public target: T, public other: T, public contact: CollisionContact) {}\r\n}\r\n\r\nexport class ContactEndEvent<T> {\r\n  constructor(public target: T, public other: T) {}\r\n}\r\n\r\nexport class CollisionPreSolveEvent<T> {\r\n  constructor(public target: T, public other: T, public side: Side, public intersection: Vector, public contact: CollisionContact) {}\r\n}\r\n\r\nexport class CollisionPostSolveEvent<T> {\r\n  constructor(public target: T, public other: T, public side: Side, public intersection: Vector, public contact: CollisionContact) {}\r\n}\r\n\r\n/**\r\n * Event thrown the first time an [[Actor|actor]] collides with another, after an actor is in contact normal collision events are fired.\r\n */\r\nexport class CollisionStartEvent<T extends BodyComponent | Collider | Entity = Actor> extends GameEvent<T> {\r\n  /**\r\n   *\r\n   * @param actor\r\n   * @param other\r\n   * @param contact\r\n   */\r\n  constructor(actor: T, public other: T, public contact: CollisionContact) {\r\n    super();\r\n    this.target = actor;\r\n  }\r\n\r\n  public get actor() {\r\n    return this.target;\r\n  }\r\n\r\n  public set actor(actor: T) {\r\n    this.target = actor;\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown when the [[Actor|actor]] is no longer colliding with another\r\n */\r\nexport class CollisionEndEvent<T extends BodyComponent | Collider | Entity = Actor> extends GameEvent<T> {\r\n  /**\r\n   *\r\n   */\r\n  constructor(actor: T, public other: T) {\r\n    super();\r\n    this.target = actor;\r\n  }\r\n\r\n  public get actor() {\r\n    return this.target;\r\n  }\r\n\r\n  public set actor(actor: T) {\r\n    this.target = actor;\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an [[Actor]] and a [[Scene]] only once before the first update call\r\n */\r\nexport class InitializeEvent<T extends OnInitialize = Entity> extends GameEvent<T> {\r\n  /**\r\n   * @param engine  The reference to the current engine\r\n   */\r\n  constructor(public engine: Engine, public target: T) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on a [[Scene]] on activation\r\n */\r\nexport class ActivateEvent<TData = undefined> extends GameEvent<Scene> {\r\n  /**\r\n   * @param context  The context for the scene activation\r\n   */\r\n  constructor(public context: SceneActivationContext<TData>, public target: Scene) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on a [[Scene]] on deactivation\r\n */\r\nexport class DeactivateEvent extends GameEvent<Scene> {\r\n  /**\r\n   * @param context  The context for the scene deactivation\r\n   */\r\n  constructor(public context: SceneActivationContext<never>, public target: Scene) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an [[Actor]] when it completely leaves the screen.\r\n */\r\nexport class ExitViewPortEvent extends GameEvent<Entity> {\r\n  constructor(public target: Entity) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an [[Actor]] when it completely leaves the screen.\r\n */\r\nexport class EnterViewPortEvent extends GameEvent<Entity> {\r\n  constructor(public target: Entity) {\r\n    super();\r\n  }\r\n}\r\n\r\nexport class EnterTriggerEvent extends GameEvent<Actor> {\r\n  constructor(public target: Trigger, public actor: Actor) {\r\n    super();\r\n  }\r\n}\r\n\r\nexport class ExitTriggerEvent extends GameEvent<Actor> {\r\n  constructor(public target: Trigger, public actor: Actor) {\r\n    super();\r\n  }\r\n}\r\n","\r\n/**\r\n * Describes the different image filtering modes\r\n */\r\nexport enum ImageFiltering {\r\n\r\n  /**\r\n   * Pixel is useful when you do not want smoothing aka antialiasing applied to your graphics.\r\n   *\r\n   * Useful for Pixel art aesthetics.\r\n   */\r\n  Pixel = 'Pixel',\r\n\r\n  /**\r\n   * Blended is useful when you have high resolution artwork and would like it blended and smoothed\r\n   */\r\n  Blended = 'Blended'\r\n}","\r\n/**\r\n * Provides standard colors (e.g. [[Color.Black]])\r\n * but you can also create custom colors using RGB, HSL, or Hex. Also provides\r\n * useful color operations like [[Color.lighten]], [[Color.darken]], and more.\r\n */\r\nexport class Color {\r\n  /**\r\n   * Red channel\r\n   */\r\n  public r: number;\r\n  /**\r\n   * Green channel\r\n   */\r\n  public g: number;\r\n  /**\r\n   * Blue channel\r\n   */\r\n  public b: number;\r\n  /**\r\n   * Alpha channel (between 0 and 1)\r\n   */\r\n  public a: number;\r\n\r\n  /**\r\n   * Hue\r\n   */\r\n  public h: number;\r\n  /**\r\n   * Saturation\r\n   */\r\n  public s: number;\r\n  /**\r\n   * Lightness\r\n   */\r\n  public l: number;\r\n\r\n  /**\r\n   * Creates a new instance of Color from an r, g, b, a\r\n   *\r\n   * @param r  The red component of color (0-255)\r\n   * @param g  The green component of color (0-255)\r\n   * @param b  The blue component of color (0-255)\r\n   * @param a  The alpha component of color (0-1.0)\r\n   */\r\n  constructor(r: number, g: number, b: number, a?: number) {\r\n    this.r = r;\r\n    this.g = g;\r\n    this.b = b;\r\n    this.a = a != null ? a : 1;\r\n  }\r\n\r\n  /**\r\n   * Creates a new instance of Color from an r, g, b, a\r\n   *\r\n   * @param r  The red component of color (0-255)\r\n   * @param g  The green component of color (0-255)\r\n   * @param b  The blue component of color (0-255)\r\n   * @param a  The alpha component of color (0-1.0)\r\n   */\r\n  public static fromRGB(r: number, g: number, b: number, a?: number): Color {\r\n    return new Color(r, g, b, a);\r\n  }\r\n\r\n  /**\r\n   * Creates a new instance of Color from a rgb string\r\n   *\r\n   * @param string  CSS color string of the form rgba(255, 255, 255, 1) or rgb(255, 255, 255)\r\n   */\r\n  public static fromRGBString(string: string): Color {\r\n    const rgbaRegEx: RegExp = /^rgba?\\((\\d+),\\s*(\\d+),\\s*(\\d+)(?:,\\s*(\\d+(?:\\.\\d+)?))?\\)/i;\r\n    let match = null;\r\n    if ((match = string.match(rgbaRegEx))) {\r\n      const r = parseInt(match[1], 10);\r\n      const g = parseInt(match[2], 10);\r\n      const b = parseInt(match[3], 10);\r\n      let a = 1;\r\n      if (match[4]) {\r\n        a = parseFloat(match[4]);\r\n      }\r\n      return new Color(r, g, b, a);\r\n    } else {\r\n      throw new Error('Invalid rgb/a string: ' + string);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates a new instance of Color from a hex string\r\n   *\r\n   * @param hex  CSS color string of the form #ffffff, the alpha component is optional\r\n   */\r\n  public static fromHex(hex: string): Color {\r\n    const hexRegEx: RegExp = /^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i;\r\n    let match = null;\r\n    if ((match = hex.match(hexRegEx))) {\r\n      const r = parseInt(match[1], 16);\r\n      const g = parseInt(match[2], 16);\r\n      const b = parseInt(match[3], 16);\r\n      let a = 1;\r\n      if (match[4]) {\r\n        a = parseInt(match[4], 16) / 255;\r\n      }\r\n      return new Color(r, g, b, a);\r\n    } else {\r\n      throw new Error('Invalid hex string: ' + hex);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates a new instance of Color from hsla values\r\n   *\r\n   * @param h  Hue is represented [0-1]\r\n   * @param s  Saturation is represented [0-1]\r\n   * @param l  Luminance is represented [0-1]\r\n   * @param a  Alpha is represented [0-1]\r\n   */\r\n  public static fromHSL(h: number, s: number, l: number, a: number = 1.0): Color {\r\n    const temp = new HSLColor(h, s, l, a);\r\n    return temp.toRGBA();\r\n  }\r\n\r\n  /**\r\n   * Lightens the current color by a specified amount\r\n   *\r\n   * @param factor  The amount to lighten by [0-1]\r\n   */\r\n  public lighten(factor: number = 0.1): Color {\r\n    const temp = HSLColor.fromRGBA(this.r, this.g, this.b, this.a);\r\n    temp.l += (1 - temp.l) * factor;\r\n    return temp.toRGBA();\r\n  }\r\n\r\n  /**\r\n   * Darkens the current color by a specified amount\r\n   *\r\n   * @param factor  The amount to darken by [0-1]\r\n   */\r\n  public darken(factor: number = 0.1): Color {\r\n    const temp = HSLColor.fromRGBA(this.r, this.g, this.b, this.a);\r\n    temp.l -= temp.l * factor;\r\n    return temp.toRGBA();\r\n  }\r\n\r\n  /**\r\n   * Saturates the current color by a specified amount\r\n   *\r\n   * @param factor  The amount to saturate by [0-1]\r\n   */\r\n  public saturate(factor: number = 0.1): Color {\r\n    const temp = HSLColor.fromRGBA(this.r, this.g, this.b, this.a);\r\n    temp.s += temp.s * factor;\r\n    return temp.toRGBA();\r\n  }\r\n\r\n  /**\r\n   * Desaturates the current color by a specified amount\r\n   *\r\n   * @param factor  The amount to desaturate by [0-1]\r\n   */\r\n  public desaturate(factor: number = 0.1): Color {\r\n    const temp = HSLColor.fromRGBA(this.r, this.g, this.b, this.a);\r\n    temp.s -= temp.s * factor;\r\n    return temp.toRGBA();\r\n  }\r\n\r\n  /**\r\n   * Multiplies a color by another, results in a darker color\r\n   *\r\n   * @param color  The other color\r\n   */\r\n  public multiply(color: Color): Color {\r\n    const newR = (((color.r / 255) * this.r) / 255) * 255;\r\n    const newG = (((color.g / 255) * this.g) / 255) * 255;\r\n    const newB = (((color.b / 255) * this.b) / 255) * 255;\r\n    const newA = color.a * this.a;\r\n    return new Color(newR, newG, newB, newA);\r\n  }\r\n\r\n  /**\r\n   * Screens a color by another, results in a lighter color\r\n   *\r\n   * @param color  The other color\r\n   */\r\n  public screen(color: Color): Color {\r\n    const color1 = color.invert();\r\n    const color2 = color.invert();\r\n    return color1.multiply(color2).invert();\r\n  }\r\n\r\n  /**\r\n   * Inverts the current color\r\n   */\r\n  public invert(): Color {\r\n    return new Color(255 - this.r, 255 - this.g, 255 - this.b, 1.0 - this.a);\r\n  }\r\n\r\n  /**\r\n   * Averages the current color with another\r\n   *\r\n   * @param color  The other color\r\n   */\r\n  public average(color: Color): Color {\r\n    const newR = (color.r + this.r) / 2;\r\n    const newG = (color.g + this.g) / 2;\r\n    const newB = (color.b + this.b) / 2;\r\n    const newA = (color.a + this.a) / 2;\r\n    return new Color(newR, newG, newB, newA);\r\n  }\r\n\r\n  public equal(color: Color): boolean {\r\n    return this.toString() === color.toString();\r\n  }\r\n\r\n  /**\r\n   * Returns a CSS string representation of a color.\r\n   *\r\n   * @param format Color representation, accepts: rgb, hsl, or hex\r\n   */\r\n  public toString(format: 'rgb' | 'hsl' | 'hex' = 'rgb') {\r\n    switch (format) {\r\n      case 'rgb':\r\n        return this.toRGBA();\r\n      case 'hsl':\r\n        return this.toHSLA();\r\n      case 'hex':\r\n        return this.toHex();\r\n      default:\r\n        throw new Error('Invalid Color format');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns Hex Value of a color component\r\n   * @param c color component\r\n   * @see https://stackoverflow.com/questions/5623838/rgb-to-hex-and-hex-to-rgb\r\n   */\r\n  private _componentToHex(c: number) {\r\n    const hex = c.toString(16);\r\n    return hex.length === 1 ? '0' + hex : hex;\r\n  }\r\n\r\n  /**\r\n   * Return Hex representation of a color.\r\n   */\r\n  public toHex() {\r\n    return '#' + this._componentToHex(this.r) + this._componentToHex(this.g) + this._componentToHex(this.b);\r\n  }\r\n\r\n  /**\r\n   * Return RGBA representation of a color.\r\n   */\r\n  public toRGBA() {\r\n    const result = String(this.r.toFixed(0)) + ', ' + String(this.g.toFixed(0)) + ', ' + String(this.b.toFixed(0));\r\n    if (this.a !== undefined || this.a !== null) {\r\n      return 'rgba(' + result + ', ' + String(this.a) + ')';\r\n    }\r\n    return 'rgb(' + result + ')';\r\n  }\r\n\r\n  /**\r\n   * Return HSLA representation of a color.\r\n   */\r\n  public toHSLA() {\r\n    return HSLColor.fromRGBA(this.r, this.g, this.b, this.a).toString();\r\n  }\r\n\r\n  /**\r\n   * Returns a CSS string representation of a color.\r\n   */\r\n  public fillStyle() {\r\n    return this.toString();\r\n  }\r\n\r\n  /**\r\n   * Returns a clone of the current color.\r\n   */\r\n  public clone(): Color {\r\n    return new Color(this.r, this.g, this.b, this.a);\r\n  }\r\n\r\n  /**\r\n   * Black (#000000)\r\n   */\r\n  public static get Black(): Color {\r\n    return Color.fromHex('#000000');\r\n  }\r\n\r\n  /**\r\n   * White (#FFFFFF)\r\n   */\r\n  public static get White(): Color {\r\n    return Color.fromHex('#FFFFFF');\r\n  }\r\n\r\n  /**\r\n   * Gray (#808080)\r\n   */\r\n  public static get Gray(): Color {\r\n    return Color.fromHex('#808080');\r\n  }\r\n\r\n  /**\r\n   * Light gray (#D3D3D3)\r\n   */\r\n  public static get LightGray(): Color {\r\n    return Color.fromHex('#D3D3D3');\r\n  }\r\n\r\n  /**\r\n   * Dark gray (#A9A9A9)\r\n   */\r\n  public static get DarkGray(): Color {\r\n    return Color.fromHex('#A9A9A9');\r\n  }\r\n\r\n  /**\r\n   * Yellow (#FFFF00)\r\n   */\r\n  public static get Yellow(): Color {\r\n    return Color.fromHex('#FFFF00');\r\n  }\r\n\r\n  /**\r\n   * Orange (#FFA500)\r\n   */\r\n  public static get Orange(): Color {\r\n    return Color.fromHex('#FFA500');\r\n  }\r\n\r\n  /**\r\n   * Red (#FF0000)\r\n   */\r\n  public static get Red(): Color {\r\n    return Color.fromHex('#FF0000');\r\n  }\r\n\r\n  /**\r\n   * Vermilion (#FF5B31)\r\n   */\r\n  public static get Vermilion(): Color {\r\n    return Color.fromHex('#FF5B31');\r\n  }\r\n\r\n  /**\r\n   * Rose (#FF007F)\r\n   */\r\n  public static get Rose(): Color {\r\n    return Color.fromHex('#FF007F');\r\n  }\r\n\r\n  /**\r\n   * Magenta (#FF00FF)\r\n   */\r\n  public static get Magenta(): Color {\r\n    return Color.fromHex('#FF00FF');\r\n  }\r\n\r\n  /**\r\n   * Violet (#7F00FF)\r\n   */\r\n  public static get Violet(): Color {\r\n    return Color.fromHex('#7F00FF');\r\n  }\r\n\r\n  /**\r\n   * Blue (#0000FF)\r\n   */\r\n  public static get Blue(): Color {\r\n    return Color.fromHex('#0000FF');\r\n  }\r\n\r\n  /**\r\n   * Azure (#007FFF)\r\n   */\r\n  public static get Azure(): Color {\r\n    return Color.fromHex('#007FFF');\r\n  }\r\n\r\n  /**\r\n   * Cyan (#00FFFF)\r\n   */\r\n  public static get Cyan(): Color {\r\n    return Color.fromHex('#00FFFF');\r\n  }\r\n\r\n  /**\r\n   * Viridian (#59978F)\r\n   */\r\n  public static get Viridian(): Color {\r\n    return Color.fromHex('#59978F');\r\n  }\r\n\r\n  /**\r\n   * Green (#00FF00)\r\n   */\r\n  public static get Green(): Color {\r\n    return Color.fromHex('#00FF00');\r\n  }\r\n\r\n  /**\r\n   * Chartreuse (#7FFF00)\r\n   */\r\n  public static get Chartreuse(): Color {\r\n    return Color.fromHex('#7FFF00');\r\n  }\r\n\r\n  /**\r\n   * Transparent (#FFFFFF00)\r\n   */\r\n  public static get Transparent(): Color {\r\n    return Color.fromHex('#FFFFFF00');\r\n  }\r\n\r\n  /**\r\n   * ExcaliburBlue (#176BAA)\r\n   */\r\n  public static get ExcaliburBlue(): Color {\r\n    return Color.fromHex('#176BAA');\r\n  }\r\n}\r\n\r\n/**\r\n * Internal HSL Color representation\r\n *\r\n * http://en.wikipedia.org/wiki/HSL_and_HSV\r\n * http://axonflux.com/handy-rgb-to-hsl-and-rgb-to-hsv-color-model-c\r\n */\r\nclass HSLColor {\r\n  constructor(public h: number, public s: number, public l: number, public a: number) {}\r\n\r\n  public static hue2rgb(p: number, q: number, t: number): number {\r\n    if (t < 0) {\r\n      t += 1;\r\n    }\r\n    if (t > 1) {\r\n      t -= 1;\r\n    }\r\n    if (t < 1 / 6) {\r\n      return p + (q - p) * 6 * t;\r\n    }\r\n    if (t < 1 / 2) {\r\n      return q;\r\n    }\r\n    if (t < 2 / 3) {\r\n      return p + (q - p) * (2 / 3 - t) * 6;\r\n    }\r\n    return p;\r\n  }\r\n\r\n  public static fromRGBA(r: number, g: number, b: number, a: number): HSLColor {\r\n    r /= 255;\r\n    g /= 255;\r\n    b /= 255;\r\n    const max = Math.max(r, g, b),\r\n      min = Math.min(r, g, b);\r\n    let h, s;\r\n    const l = (max + min) / 2;\r\n\r\n    if (max === min) {\r\n      h = s = 0; // achromatic\r\n    } else {\r\n      const d = max - min;\r\n      s = l > 0.5 ? d / (2 - max - min) : d / (max + min);\r\n      switch (max) {\r\n        case r:\r\n          h = (g - b) / d + (g < b ? 6 : 0);\r\n          break;\r\n        case g:\r\n          h = (b - r) / d + 2;\r\n          break;\r\n        case b:\r\n          h = (r - g) / d + 4;\r\n          break;\r\n      }\r\n      h /= 6;\r\n    }\r\n\r\n    return new HSLColor(h, s, l, a);\r\n  }\r\n\r\n  public toRGBA(): Color {\r\n    let r: number, g: number, b: number;\r\n\r\n    if (this.s === 0) {\r\n      r = g = b = this.l; // achromatic\r\n    } else {\r\n      const q = this.l < 0.5 ? this.l * (1 + this.s) : this.l + this.s - this.l * this.s;\r\n      const p = 2 * this.l - q;\r\n      r = HSLColor.hue2rgb(p, q, this.h + 1 / 3);\r\n      g = HSLColor.hue2rgb(p, q, this.h);\r\n      b = HSLColor.hue2rgb(p, q, this.h - 1 / 3);\r\n    }\r\n\r\n    return new Color(r * 255, g * 255, b * 255, this.a);\r\n  }\r\n\r\n  public toString(): string {\r\n    const h = this.h.toFixed(0),\r\n      s = this.s.toFixed(0),\r\n      l = this.l.toFixed(0),\r\n      a = this.a.toFixed(0);\r\n    return `hsla(${h}, ${s}, ${l}, ${a})`;\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\r\nimport { Ray } from '../Math/ray';\r\nimport { Color } from '../Color';\r\nimport { Side } from './Side';\r\nimport { ExcaliburGraphicsContext } from '../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { AffineMatrix } from '../Math/affine-matrix';\r\n\r\nexport interface BoundingBoxOptions {\r\n  left: number;\r\n  right: number;\r\n  top: number;\r\n  bottom: number;\r\n}\r\n\r\n/**\r\n * Axis Aligned collision primitive for Excalibur.\r\n */\r\nexport class BoundingBox {\r\n  public top: number;\r\n  public right: number;\r\n  public bottom: number;\r\n  public left: number;\r\n\r\n  /**\r\n   * Constructor allows passing of either an object with all coordinate components,\r\n   * or the coordinate components passed separately.\r\n   * @param leftOrOptions    Either x coordinate of the left edge or an options object\r\n   * containing the four coordinate components.\r\n   * @param top     y coordinate of the top edge\r\n   * @param right   x coordinate of the right edge\r\n   * @param bottom  y coordinate of the bottom edge\r\n   */\r\n  constructor(leftOrOptions: number | BoundingBoxOptions = 0, top: number = 0, right: number = 0, bottom: number = 0) {\r\n    if (typeof leftOrOptions === 'object') {\r\n      this.left = leftOrOptions.left;\r\n      this.top = leftOrOptions.top;\r\n      this.right = leftOrOptions.right;\r\n      this.bottom = leftOrOptions.bottom;\r\n    } else if (typeof leftOrOptions === 'number') {\r\n      this.left = leftOrOptions;\r\n      this.top = top;\r\n      this.right = right;\r\n      this.bottom = bottom;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns a new instance of [[BoundingBox]] that is a copy of the current instance\r\n   */\r\n  public clone(): BoundingBox {\r\n    return new BoundingBox(this.left, this.top, this.right, this.bottom);\r\n  }\r\n\r\n  /**\r\n   * Given bounding box A & B, returns the side relative to A when intersection is performed.\r\n   * @param intersection Intersection vector between 2 bounding boxes\r\n   */\r\n  public static getSideFromIntersection(intersection: Vector): Side {\r\n    if (!intersection) {\r\n      return Side.None;\r\n    }\r\n    if (intersection) {\r\n      if (Math.abs(intersection.x) > Math.abs(intersection.y)) {\r\n        if (intersection.x < 0) {\r\n          return Side.Right;\r\n        }\r\n        return Side.Left;\r\n      } else {\r\n        if (intersection.y < 0) {\r\n          return Side.Bottom;\r\n        }\r\n        return Side.Top;\r\n      }\r\n    }\r\n    return Side.None;\r\n  }\r\n\r\n  public static fromPoints(points: Vector[]): BoundingBox {\r\n    let minX = Infinity;\r\n    let minY = Infinity;\r\n    let maxX = -Infinity;\r\n    let maxY = -Infinity;\r\n    for (let i = 0; i < points.length; i++) {\r\n      if (points[i].x < minX) {\r\n        minX = points[i].x;\r\n      }\r\n      if (points[i].x > maxX) {\r\n        maxX = points[i].x;\r\n      }\r\n      if (points[i].y < minY) {\r\n        minY = points[i].y;\r\n      }\r\n      if (points[i].y > maxY) {\r\n        maxY = points[i].y;\r\n      }\r\n    }\r\n    return new BoundingBox(minX, minY, maxX, maxY);\r\n  }\r\n\r\n  public static fromDimension(width: number, height: number, anchor: Vector = Vector.Half, pos: Vector = Vector.Zero) {\r\n    return new BoundingBox(\r\n      -width * anchor.x + pos.x,\r\n      -height * anchor.y + pos.y,\r\n      width - width * anchor.x + pos.x,\r\n      height - height * anchor.y + pos.y\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Returns the calculated width of the bounding box\r\n   */\r\n  public get width() {\r\n    return this.right - this.left;\r\n  }\r\n\r\n  /**\r\n   * Returns the calculated height of the bounding box\r\n   */\r\n  public get height() {\r\n    return this.bottom - this.top;\r\n  }\r\n\r\n  /**\r\n   * Return whether the bounding box has zero dimensions in height,width or both\r\n   */\r\n  public hasZeroDimensions() {\r\n    return this.width === 0 || this.height === 0;\r\n  }\r\n\r\n  /**\r\n   * Returns the center of the bounding box\r\n   */\r\n  public get center(): Vector {\r\n    return new Vector((this.left + this.right) / 2, (this.top + this.bottom) / 2);\r\n  }\r\n\r\n  public translate(pos: Vector): BoundingBox {\r\n    return new BoundingBox(this.left + pos.x, this.top + pos.y, this.right + pos.x, this.bottom + pos.y);\r\n  }\r\n\r\n  /**\r\n   * Rotates a bounding box by and angle and around a point, if no point is specified (0, 0) is used by default. The resulting bounding\r\n   * box is also axis-align. This is useful when a new axis-aligned bounding box is needed for rotated geometry.\r\n   */\r\n  public rotate(angle: number, point: Vector = Vector.Zero): BoundingBox {\r\n    const points = this.getPoints().map((p) => p.rotate(angle, point));\r\n    return BoundingBox.fromPoints(points);\r\n  }\r\n\r\n  /**\r\n   * Scale a bounding box by a scale factor, optionally provide a point\r\n   * @param scale\r\n   * @param point\r\n   */\r\n  public scale(scale: Vector, point: Vector = Vector.Zero): BoundingBox {\r\n    const shifted = this.translate(point);\r\n    return new BoundingBox(shifted.left * scale.x, shifted.top * scale.y, shifted.right * scale.x, shifted.bottom * scale.y);\r\n  }\r\n\r\n  /**\r\n   * Transform the axis aligned bounding box by a [[Matrix]], producing a new axis aligned bounding box\r\n   * @param matrix\r\n   */\r\n  public transform(matrix: AffineMatrix) {\r\n    // inlined these calculations to not use vectors would speed it up slightly\r\n    // const matFirstColumn = vec(matrix.data[0], matrix.data[1]);\r\n    // const xa = matFirstColumn.scale(this.left);\r\n    const xa1 = matrix.data[0] * this.left;\r\n    const xa2 = matrix.data[1] * this.left;\r\n\r\n    // const xb = matFirstColumn.scale(this.right);\r\n    const xb1 = matrix.data[0] * this.right;\r\n    const xb2 = matrix.data[1] * this.right;\r\n\r\n    // const matSecondColumn = vec(matrix.data[2], matrix.data[3]);\r\n    // const ya = matSecondColumn.scale(this.top);\r\n    const ya1 = matrix.data[2] * this.top;\r\n    const ya2 = matrix.data[3] * this.top;\r\n\r\n    // const yb = matSecondColumn.scale(this.bottom);\r\n    const yb1 = matrix.data[2] * this.bottom;\r\n    const yb2 = matrix.data[3] * this.bottom;\r\n\r\n    const matrixPos = matrix.getPosition();\r\n    // const topLeft = Vector.min(xa, xb).add(Vector.min(ya, yb)).add(matrixPos);\r\n    // const bottomRight = Vector.max(xa, xb).add(Vector.max(ya, yb)).add(matrixPos);\r\n    const left = Math.min(xa1, xb1) + Math.min(ya1, yb1) + matrixPos.x;\r\n    const top = Math.min(xa2, xb2) + Math.min(ya2, yb2) + matrixPos.y;\r\n    const right = Math.max(xa1, xb1) + Math.max(ya1, yb1) + matrixPos.x;\r\n    const bottom = Math.max(xa2, xb2) + Math.max(ya2, yb2) + matrixPos.y;\r\n\r\n    return new BoundingBox({\r\n      left,//: topLeft.x,\r\n      top,//: topLeft.y,\r\n      right,//: bottomRight.x,\r\n      bottom//: bottomRight.y\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Returns the perimeter of the bounding box\r\n   */\r\n  public getPerimeter(): number {\r\n    const wx = this.width;\r\n    const wy = this.height;\r\n    return 2 * (wx + wy);\r\n  }\r\n\r\n  public getPoints(): Vector[] {\r\n    const results = [];\r\n    results.push(new Vector(this.left, this.top));\r\n    results.push(new Vector(this.right, this.top));\r\n    results.push(new Vector(this.right, this.bottom));\r\n    results.push(new Vector(this.left, this.bottom));\r\n    return results;\r\n  }\r\n\r\n  /**\r\n   * Determines whether a ray intersects with a bounding box\r\n   */\r\n  public rayCast(ray: Ray, farClipDistance = Infinity): boolean {\r\n    // algorithm from https://tavianator.com/fast-branchless-raybounding-box-intersections/\r\n    let tmin = -Infinity;\r\n    let tmax = +Infinity;\r\n\r\n    const xinv = ray.dir.x === 0 ? Number.MAX_VALUE : 1 / ray.dir.x;\r\n    const yinv = ray.dir.y === 0 ? Number.MAX_VALUE : 1 / ray.dir.y;\r\n\r\n    const tx1 = (this.left - ray.pos.x) * xinv;\r\n    const tx2 = (this.right - ray.pos.x) * xinv;\r\n    tmin = Math.min(tx1, tx2);\r\n    tmax = Math.max(tx1, tx2);\r\n\r\n    const ty1 = (this.top - ray.pos.y) * yinv;\r\n    const ty2 = (this.bottom - ray.pos.y) * yinv;\r\n    tmin = Math.max(tmin, Math.min(ty1, ty2));\r\n    tmax = Math.min(tmax, Math.max(ty1, ty2));\r\n\r\n    return tmax >= Math.max(0, tmin) && tmin < farClipDistance;\r\n  }\r\n\r\n  public rayCastTime(ray: Ray, farClipDistance = Infinity): number {\r\n    // algorithm from https://tavianator.com/fast-branchless-raybounding-box-intersections/\r\n    let tmin = -Infinity;\r\n    let tmax = +Infinity;\r\n\r\n    const xinv = ray.dir.x === 0 ? Number.MAX_VALUE : 1 / ray.dir.x;\r\n    const yinv = ray.dir.y === 0 ? Number.MAX_VALUE : 1 / ray.dir.y;\r\n\r\n    const tx1 = (this.left - ray.pos.x) * xinv;\r\n    const tx2 = (this.right - ray.pos.x) * xinv;\r\n    tmin = Math.min(tx1, tx2);\r\n    tmax = Math.max(tx1, tx2);\r\n\r\n    const ty1 = (this.top - ray.pos.y) * yinv;\r\n    const ty2 = (this.bottom - ray.pos.y) * yinv;\r\n    tmin = Math.max(tmin, Math.min(ty1, ty2));\r\n    tmax = Math.min(tmax, Math.max(ty1, ty2));\r\n\r\n    if (tmax >= Math.max(0, tmin) && tmin < farClipDistance) {\r\n      return tmin;\r\n    }\r\n    return -1;\r\n  }\r\n\r\n  /**\r\n   * Tests whether a point is contained within the bounding box\r\n   * @param p  The point to test\r\n   */\r\n  public contains(p: Vector): boolean;\r\n\r\n  /**\r\n   * Tests whether another bounding box is totally contained in this one\r\n   * @param bb  The bounding box to test\r\n   */\r\n  public contains(bb: BoundingBox): boolean;\r\n  public contains(val: any): boolean {\r\n    if (val instanceof Vector) {\r\n      return this.left <= val.x && this.top <= val.y && this.bottom >= val.y && this.right >= val.x;\r\n    } else if (val instanceof BoundingBox) {\r\n      if (this.left <= val.left && this.top <= val.top && val.bottom <= this.bottom && val.right <= this.right) {\r\n        return true;\r\n      }\r\n      return false;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Combines this bounding box and another together returning a new bounding box\r\n   * @param other  The bounding box to combine\r\n   */\r\n  public combine(other: BoundingBox): BoundingBox {\r\n    const compositeBB = new BoundingBox(\r\n      Math.min(this.left, other.left),\r\n      Math.min(this.top, other.top),\r\n      Math.max(this.right, other.right),\r\n      Math.max(this.bottom, other.bottom)\r\n    );\r\n    return compositeBB;\r\n  }\r\n\r\n  public get dimensions(): Vector {\r\n    return new Vector(this.width, this.height);\r\n  }\r\n\r\n  /**\r\n   * Returns true if the bounding boxes overlap.\r\n   * @param other\r\n   * @param epsilon Optionally specify a small epsilon (default 0) as amount of overlap to ignore as overlap.\r\n   * This epsilon is useful in stable collision simulations.\r\n   */\r\n  public overlaps(other: BoundingBox, epsilon?: number): boolean {\r\n    const e = epsilon || 0;\r\n    if (other.hasZeroDimensions()){\r\n      return this.contains(other);\r\n    }\r\n    if (this.hasZeroDimensions()) {\r\n      return other.contains(this);\r\n    }\r\n    const totalBoundingBox = this.combine(other);\r\n    return totalBoundingBox.width + e < other.width + this.width &&\r\n           totalBoundingBox.height + e < other.height + this.height;\r\n  }\r\n\r\n  /**\r\n   * Test wether this bounding box intersects with another returning\r\n   * the intersection vector that can be used to resolve the collision. If there\r\n   * is no intersection null is returned.\r\n   *\r\n   * @param other  Other [[BoundingBox]] to test intersection with\r\n   * @returns A Vector in the direction of the current BoundingBox, this <- other\r\n   */\r\n  public intersect(other: BoundingBox): Vector {\r\n    const totalBoundingBox = this.combine(other);\r\n\r\n    // If the total bounding box is less than or equal the sum of the 2 bounds then there is collision\r\n    if (\r\n      totalBoundingBox.width < other.width + this.width &&\r\n      totalBoundingBox.height < other.height + this.height &&\r\n      !totalBoundingBox.dimensions.equals(other.dimensions) &&\r\n      !totalBoundingBox.dimensions.equals(this.dimensions)\r\n    ) {\r\n      // collision\r\n      let overlapX = 0;\r\n      // right edge is between the other's left and right edge\r\n      /**\r\n       *     +-this-+\r\n       *     |      |\r\n       *     |    +-other-+\r\n       *     +----|-+     |\r\n       *          |       |\r\n       *          +-------+\r\n       *         <---\r\n       *          ^ overlap\r\n       */\r\n      if (this.right >= other.left && this.right <= other.right) {\r\n        overlapX = other.left - this.right;\r\n        // right edge is past the other's right edge\r\n        /**\r\n         *     +-other-+\r\n         *     |       |\r\n         *     |    +-this-+\r\n         *     +----|--+   |\r\n         *          |      |\r\n         *          +------+\r\n         *          --->\r\n         *          ^ overlap\r\n         */\r\n      } else {\r\n        overlapX = other.right - this.left;\r\n      }\r\n\r\n      let overlapY = 0;\r\n      // top edge is between the other's top and bottom edge\r\n      /**\r\n       *     +-other-+\r\n       *     |       |\r\n       *     |    +-this-+   | <- overlap\r\n       *     +----|--+   |   |\r\n       *          |      |  \\ /\r\n       *          +------+   '\r\n       */\r\n      if (this.top <= other.bottom && this.top >= other.top) {\r\n        overlapY = other.bottom - this.top;\r\n        // top edge is above the other top edge\r\n        /**\r\n         *     +-this-+         .\r\n         *     |      |        / \\\r\n         *     |    +-other-+   | <- overlap\r\n         *     +----|-+     |   |\r\n         *          |       |\r\n         *          +-------+\r\n         */\r\n      } else {\r\n        overlapY = other.top - this.bottom;\r\n      }\r\n\r\n      if (Math.abs(overlapX) < Math.abs(overlapY)) {\r\n        return new Vector(overlapX, 0);\r\n      } else {\r\n        return new Vector(0, overlapY);\r\n      }\r\n      // Case of total containment of one bounding box by another\r\n    } else if (totalBoundingBox.dimensions.equals(other.dimensions) || totalBoundingBox.dimensions.equals(this.dimensions)) {\r\n      let overlapX = 0;\r\n      // this is wider than the other\r\n      if (this.width - other.width >= 0) {\r\n        // This right edge is closest to the others right edge\r\n        if (this.right - other.right <= other.left - this.left) {\r\n          overlapX = other.left - this.right;\r\n          // This left edge is closest to the others left edge\r\n        } else {\r\n          overlapX = other.right - this.left;\r\n        }\r\n        // other is wider than this\r\n      } else {\r\n        // This right edge is closest to the others right edge\r\n        if (other.right - this.right <= this.left - other.left) {\r\n          overlapX = this.left - other.right;\r\n          // This left edge is closest to the others left edge\r\n        } else {\r\n          overlapX = this.right - other.left;\r\n        }\r\n      }\r\n\r\n      let overlapY = 0;\r\n      // this is taller than other\r\n      if (this.height - other.height >= 0) {\r\n        // The bottom edge is closest to the others bottom edge\r\n        if (this.bottom - other.bottom <= other.top - this.top) {\r\n          overlapY = other.top - this.bottom;\r\n        } else {\r\n          overlapY = other.bottom - this.top;\r\n        }\r\n        // other is taller than this\r\n      } else {\r\n        // The bottom edge is closest to the others bottom edge\r\n        if (other.bottom - this.bottom <= this.top - other.top) {\r\n          overlapY = this.top - other.bottom;\r\n        } else {\r\n          overlapY = this.bottom - other.top;\r\n        }\r\n      }\r\n\r\n      if (Math.abs(overlapX) < Math.abs(overlapY)) {\r\n        return new Vector(overlapX, 0);\r\n      } else {\r\n        return new Vector(0, overlapY);\r\n      }\r\n    } else {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Test whether the bounding box has intersected with another bounding box, returns the side of the current bb that intersected.\r\n   * @param bb The other actor to test\r\n   */\r\n  public intersectWithSide(bb: BoundingBox): Side {\r\n    const intersect = this.intersect(bb);\r\n    return BoundingBox.getSideFromIntersection(intersect);\r\n  }\r\n\r\n  /**\r\n   * Draw a debug bounding box\r\n   * @param ex\r\n   * @param color\r\n   */\r\n  public draw(ex: ExcaliburGraphicsContext, color: Color = Color.Yellow) {\r\n    ex.debug.drawRect(this.left, this.top, this.width, this.height, { color });\r\n  }\r\n}\r\n","\r\n/**\r\n * Future is a wrapper around a native browser Promise to allow resolving/rejecting at any time\r\n */\r\nexport class Future<T> {\r\n  // Code from StephenCleary https://gist.github.com/StephenCleary/ba50b2da419c03b9cba1d20cb4654d5e\r\n  private _resolver: (value: T) => void;\r\n  private _rejecter: (error: Error) => void;\r\n  private _isCompleted: boolean = false;\r\n\r\n  constructor() {\r\n    this.promise = new Promise((resolve, reject) => {\r\n      this._resolver = resolve;\r\n      this._rejecter = reject;\r\n    });\r\n  }\r\n\r\n  public readonly promise: Promise<T>;\r\n\r\n  public get isCompleted(): boolean {\r\n    return this._isCompleted;\r\n  }\r\n\r\n  public resolve(value: T): void {\r\n    if (this._isCompleted) {\r\n      return;\r\n    }\r\n    this._isCompleted = true;\r\n    this._resolver(value);\r\n  }\r\n\r\n  public reject(error: Error): void {\r\n    if (this._isCompleted) {\r\n      return;\r\n    }\r\n    this._isCompleted = true;\r\n    this._rejecter(error);\r\n  }\r\n}","import { Vector } from '../Math/vector';\r\nimport { Clock } from './Clock';\r\nimport { Future } from './Future';\r\n\r\n/**\r\n * Find the screen position of an HTML element\r\n */\r\nexport function getPosition(el: HTMLElement): Vector {\r\n  let oLeft: number = 0,\r\n    oTop: number = 0;\r\n\r\n  const calcOffsetLeft = (parent: HTMLElement) => {\r\n    oLeft += parent.offsetLeft;\r\n\r\n    if (parent.offsetParent) {\r\n      calcOffsetLeft(<HTMLElement>parent.offsetParent);\r\n    }\r\n  };\r\n  const calcOffsetTop = (parent: HTMLElement) => {\r\n    oTop += parent.offsetTop;\r\n    if (parent.offsetParent) {\r\n      calcOffsetTop(<HTMLElement>parent.offsetParent);\r\n    }\r\n  };\r\n\r\n  calcOffsetLeft(el);\r\n  calcOffsetTop(el);\r\n\r\n  return new Vector(oLeft, oTop);\r\n}\r\n\r\n/**\r\n * Add an item to an array list if it doesn't already exist. Returns true if added, false if not and already exists in the array.\r\n * @deprecated Will be removed in v0.26.0\r\n */\r\nexport function addItemToArray<T>(item: T, array: T[]): boolean {\r\n  if (array.indexOf(item) === -1) {\r\n    array.push(item);\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\n/**\r\n * Remove an item from an list\r\n * @deprecated Will be removed in v0.26.0\r\n */\r\nexport function removeItemFromArray<T>(item: T, array: T[]): boolean {\r\n  let index = -1;\r\n  if ((index = array.indexOf(item)) > -1) {\r\n    array.splice(index, 1);\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\n/**\r\n * See if an array contains something\r\n */\r\nexport function contains(array: Array<any>, obj: any): boolean {\r\n  for (let i = 0; i < array.length; i++) {\r\n    if (array[i] === obj) {\r\n      return true;\r\n    }\r\n  }\r\n  return false;\r\n}\r\n\r\n/**\r\n * Used for exhaustive checks at compile time\r\n */\r\nexport function fail(message: never): never {\r\n  throw new Error(message);\r\n}\r\n\r\n/**\r\n * Create a promise that resolves after a certain number of milliseconds\r\n *\r\n * It is strongly recommended you pass the excalibur clock so delays are bound to the\r\n * excalibur clock which would be unaffected by stop/pause.\r\n * @param milliseconds\r\n * @param clock\r\n */\r\nexport function delay(milliseconds: number, clock?: Clock): Promise<void> {\r\n  const future = new Future<void>();\r\n  const schedule = clock?.schedule.bind(clock) ?? setTimeout;\r\n  schedule(() => {\r\n    future.resolve();\r\n  }, milliseconds);\r\n  return future.promise;\r\n}\r\n","import { Matrix } from './matrix';\r\nimport { canonicalizeAngle, sign } from './util';\r\nimport { vec, Vector } from './vector';\r\n\r\n\r\nexport class AffineMatrix {\r\n  /**\r\n   * |         |         |          |\r\n   * | ------- | ------- | -------- |\r\n   * | data[0] | data[2] | data[4]  |\r\n   * | data[1] | data[3] | data[5]  |\r\n   * |   0     |    0    |    1     |\r\n   */\r\n  public data = new Float64Array(6);\r\n\r\n  /**\r\n   * Converts the current matrix into a DOMMatrix\r\n   *\r\n   * This is useful when working with the browser Canvas context\r\n   * @returns {DOMMatrix} DOMMatrix\r\n   */\r\n  public toDOMMatrix(): DOMMatrix {\r\n    return new DOMMatrix([...this.data]);\r\n  }\r\n\r\n  public static identity(): AffineMatrix {\r\n    const mat = new AffineMatrix();\r\n    mat.data[0] = 1;\r\n    mat.data[1] = 0;\r\n\r\n    mat.data[2] = 0;\r\n    mat.data[3] = 1;\r\n\r\n    mat.data[4] = 0;\r\n    mat.data[5] = 0;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a brand new translation matrix at the specified 3d point\r\n   * @param x\r\n   * @param y\r\n   */\r\n  public static translation(x: number, y: number): AffineMatrix {\r\n    const mat = AffineMatrix.identity();\r\n    mat.data[4] = x;\r\n    mat.data[5] = y;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a brand new scaling matrix with the specified scaling factor\r\n   * @param sx\r\n   * @param sy\r\n   */\r\n  public static scale(sx: number, sy: number): AffineMatrix {\r\n    const mat = AffineMatrix.identity();\r\n    mat.data[0] = sx;\r\n    mat.data[3] = sy;\r\n    mat._scale[0] = sx;\r\n    mat._scale[1] = sy;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a brand new rotation matrix with the specified angle\r\n   * @param angleRadians\r\n   */\r\n  public static rotation(angleRadians: number): AffineMatrix {\r\n    const mat = AffineMatrix.identity();\r\n    mat.data[0] = Math.cos(angleRadians);\r\n    mat.data[1] = Math.sin(angleRadians);\r\n    mat.data[2] = -Math.sin(angleRadians);\r\n    mat.data[3] = Math.cos(angleRadians);\r\n    return mat;\r\n  }\r\n\r\n  public setPosition(x: number, y: number) {\r\n    this.data[4] = x;\r\n    this.data[5] = y;\r\n  }\r\n\r\n  public getPosition(): Vector {\r\n    return vec(this.data[4], this.data[5]);\r\n  }\r\n\r\n  /**\r\n   * Applies rotation to the current matrix mutating it\r\n   * @param angle in Radians\r\n   */\r\n  rotate(angle: number) {\r\n    const a11 = this.data[0];\r\n    const a21 = this.data[1];\r\n\r\n    const a12 = this.data[2];\r\n    const a22 = this.data[3];\r\n\r\n    const sine = Math.sin(angle);\r\n    const cosine = Math.cos(angle);\r\n\r\n    this.data[0] = cosine * a11 + sine * a12;\r\n    this.data[1] = cosine * a21 + sine * a22;\r\n\r\n    this.data[2] = cosine * a12 - sine * a11;\r\n    this.data[3] = cosine * a22 - sine * a21;\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Applies translation to the current matrix mutating it\r\n   * @param x\r\n   * @param y\r\n   */\r\n  translate(x: number, y: number) {\r\n    const a11 = this.data[0];\r\n    const a21 = this.data[1];\r\n    // const a31 = 0;\r\n\r\n    const a12 = this.data[2];\r\n    const a22 = this.data[3];\r\n    // const a32 = 0;\r\n\r\n    const a13 = this.data[4];\r\n    const a23 = this.data[5];\r\n    // const a33 = 1;\r\n\r\n    // Doesn't change z\r\n    this.data[4] = a11 * x + a12 * y + a13;\r\n    this.data[5] = a21 * x + a22 * y + a23;\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Applies scaling to the current matrix mutating it\r\n   * @param x\r\n   * @param y\r\n   */\r\n  scale(x: number, y: number) {\r\n    const a11 = this.data[0];\r\n    const a21 = this.data[1];\r\n\r\n    const a12 = this.data[2];\r\n    const a22 = this.data[3];\r\n\r\n    this.data[0] = a11 * x;\r\n    this.data[1] = a21 * x;\r\n\r\n    this.data[2] = a12 * y;\r\n    this.data[3] = a22 * y;\r\n\r\n    this._scale[0] = x;\r\n    this._scale[1] = y;\r\n    return this;\r\n  }\r\n\r\n  public determinant() {\r\n    return this.data[0] * this.data[3] - this.data[1] * this.data[2];\r\n  }\r\n\r\n  /**\r\n   * Return the affine inverse, optionally store it in a target matrix.\r\n   *\r\n   * It's recommended you call .reset() the target unless you know what you're doing\r\n   * @param target\r\n   */\r\n  public inverse(target?: AffineMatrix): AffineMatrix {\r\n    // See http://negativeprobability.blogspot.com/2011/11/affine-transformations-and-their.html\r\n    // See https://www.mathsisfun.com/algebra/matrix-inverse.html\r\n    // Since we are actually only doing 2D transformations we can use this hack\r\n    // We don't actually use the 3rd or 4th dimension\r\n\r\n    const det = this.determinant();\r\n    const inverseDet = 1 / det; // TODO zero check\r\n    const a = this.data[0];\r\n    const b = this.data[2];\r\n    const c = this.data[1];\r\n    const d = this.data[3];\r\n\r\n    const m = target || AffineMatrix.identity();\r\n    // inverts rotation and scale\r\n    m.data[0] = d * inverseDet;\r\n    m.data[1] = -c * inverseDet;\r\n    m.data[2] = -b * inverseDet;\r\n    m.data[3] = a * inverseDet;\r\n\r\n    const tx = this.data[4];\r\n    const ty = this.data[5];\r\n    // invert translation\r\n    // transform translation into the matrix basis created by rot/scale\r\n    m.data[4] = -(tx * m.data[0] + ty * m.data[2]);\r\n    m.data[5] = -(tx * m.data[1] + ty * m.data[3]);\r\n\r\n    return m;\r\n  }\r\n\r\n  /**\r\n   * Multiply the current matrix by a vector producing a new vector\r\n   * @param vector\r\n   * @param dest\r\n   */\r\n  multiply(vector: Vector, dest?: Vector): Vector;\r\n  /**\r\n   * Multiply the current matrix by another matrix producing a new matrix\r\n   * @param matrix\r\n   * @param dest\r\n   */\r\n  multiply(matrix: AffineMatrix, dest?: AffineMatrix): AffineMatrix;\r\n  multiply(vectorOrMatrix: Vector | AffineMatrix, dest?: Vector | AffineMatrix): Vector | AffineMatrix {\r\n    if (vectorOrMatrix instanceof Vector) {\r\n      const result = (dest as Vector) || new Vector(0, 0);\r\n      const vector = vectorOrMatrix;\r\n      // these shenanigans are to allow dest and vector to be the same instance\r\n      const resultX = vector.x * this.data[0] + vector.y * this.data[2] + this.data[4];\r\n      const resultY = vector.x * this.data[1] + vector.y * this.data[3] + this.data[5];\r\n\r\n      result.x = resultX;\r\n      result.y = resultY;\r\n      return result;\r\n    } else {\r\n      const result = (dest as AffineMatrix) || new AffineMatrix();\r\n      const other = vectorOrMatrix;\r\n      const a11 = this.data[0];\r\n      const a21 = this.data[1];\r\n      //  const a31 = 0;\r\n\r\n      const a12 = this.data[2];\r\n      const a22 = this.data[3];\r\n      //  const a32 = 0;\r\n\r\n      const a13 = this.data[4];\r\n      const a23 = this.data[5];\r\n      //  const a33 = 1;\r\n\r\n      const b11 = other.data[0];\r\n      const b21 = other.data[1];\r\n      //  const b31 = 0;\r\n\r\n      const b12 = other.data[2];\r\n      const b22 = other.data[3];\r\n      //  const b32 = 0;\r\n\r\n      const b13 = other.data[4];\r\n      const b23 = other.data[5];\r\n      //  const b33 = 1;\r\n\r\n\r\n      result.data[0] = a11 * b11 + a12 * b21;// + a13 * b31; // zero\r\n      result.data[1] = a21 * b11 + a22 * b21;// + a23 * b31; // zero\r\n\r\n      result.data[2] = a11 * b12 + a12 * b22;// + a13 * b32; // zero\r\n      result.data[3] = a21 * b12 + a22 * b22;// + a23 * b32; // zero\r\n\r\n      result.data[4] = a11 * b13 + a12 * b23 + a13;// * b33; // one\r\n      result.data[5] = a21 * b13 + a22 * b23 + a23;// * b33; // one\r\n\r\n      const s = this.getScale();\r\n      result._scaleSignX = sign(s.x) * sign(result._scaleSignX);\r\n      result._scaleSignY = sign(s.y) * sign(result._scaleSignY);\r\n\r\n      return result;\r\n    }\r\n  }\r\n\r\n  to4x4() {\r\n    const mat = new Matrix();\r\n    mat.data[0] = this.data[0];\r\n    mat.data[1] = this.data[1];\r\n    mat.data[2] = 0;\r\n    mat.data[3] = 0;\r\n\r\n    mat.data[4] = this.data[2];\r\n    mat.data[5] = this.data[3];\r\n    mat.data[6] = 0;\r\n    mat.data[7] = 0;\r\n\r\n    mat.data[8] = 0;\r\n    mat.data[9] = 0;\r\n    mat.data[10] = 1;\r\n    mat.data[11] = 0;\r\n\r\n    mat.data[12] = this.data[4];\r\n    mat.data[13] = this.data[5];\r\n    mat.data[14] = 0;\r\n    mat.data[15] = 1;\r\n    return mat;\r\n  }\r\n\r\n  public setRotation(angle: number) {\r\n    const currentScale = this.getScale();\r\n    const sine = Math.sin(angle);\r\n    const cosine = Math.cos(angle);\r\n\r\n    this.data[0] = cosine * currentScale.x;\r\n    this.data[1] = sine * currentScale.y;\r\n    this.data[2] = -sine * currentScale.x;\r\n    this.data[3] = cosine * currentScale.y;\r\n  }\r\n\r\n  public getRotation(): number {\r\n    const angle = Math.atan2(this.data[1] / this.getScaleY(), this.data[0] / this.getScaleX());\r\n    return canonicalizeAngle(angle);\r\n  }\r\n\r\n  public getScaleX(): number {\r\n    // absolute scale of the matrix (we lose sign so need to add it back)\r\n    const xscale = vec(this.data[0], this.data[2]).distance();\r\n    return this._scaleSignX * xscale;\r\n  }\r\n\r\n  public getScaleY(): number {\r\n    // absolute scale of the matrix (we lose sign so need to add it back)\r\n    const yscale = vec(this.data[1], this.data[3]).distance();\r\n    return this._scaleSignY * yscale;\r\n  }\r\n\r\n  /**\r\n   * Get the scale of the matrix\r\n   */\r\n  public getScale(): Vector {\r\n    return vec(this.getScaleX(), this.getScaleY());\r\n  }\r\n\r\n  private _scale = new Float64Array([1, 1]);\r\n  private _scaleSignX = 1;\r\n  public setScaleX(val: number) {\r\n    if (val === this._scale[0]) {\r\n      return;\r\n    }\r\n    this._scaleSignX = sign(val);\r\n    // negative scale acts like a 180 rotation, so flip\r\n    const xscale = vec(this.data[0] * this._scaleSignX, this.data[2] * this._scaleSignX).normalize();\r\n    this.data[0] = xscale.x * val;\r\n    this.data[2] = xscale.y * val;\r\n    this._scale[0] = val;\r\n  }\r\n\r\n  private _scaleSignY = 1;\r\n  public setScaleY(val: number) {\r\n    if (val === this._scale[1]) {\r\n      return;\r\n    }\r\n    this._scaleSignY = sign(val);\r\n    // negative scale acts like a 180 rotation, so flip\r\n    const yscale = vec(this.data[1] * this._scaleSignY, this.data[3] * this._scaleSignY).normalize();\r\n    this.data[1] = yscale.x * val;\r\n    this.data[3] = yscale.y * val;\r\n    this._scale[1] = val;\r\n  }\r\n\r\n  public setScale(scale: Vector) {\r\n    this.setScaleX(scale.x);\r\n    this.setScaleY(scale.y);\r\n  }\r\n\r\n  public isIdentity(): boolean {\r\n    return (\r\n      this.data[0] === 1 &&\r\n      this.data[1] === 0 &&\r\n      this.data[2] === 0 &&\r\n      this.data[3] === 1 &&\r\n      this.data[4] === 0 &&\r\n      this.data[5] === 0\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Resets the current matrix to the identity matrix, mutating it\r\n   * @returns {AffineMatrix} Current matrix as identity\r\n   */\r\n  public reset(): AffineMatrix {\r\n    const mat = this;\r\n    mat.data[0] = 1;\r\n    mat.data[1] = 0;\r\n\r\n    mat.data[2] = 0;\r\n    mat.data[3] = 1;\r\n\r\n    mat.data[4] = 0;\r\n    mat.data[5] = 0;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a new Matrix with the same data as the current 4x4\r\n   */\r\n  public clone(dest?: AffineMatrix): AffineMatrix {\r\n    const mat = dest || new AffineMatrix();\r\n    mat.data[0] = this.data[0];\r\n    mat.data[1] = this.data[1];\r\n\r\n    mat.data[2] = this.data[2];\r\n    mat.data[3] = this.data[3];\r\n\r\n    mat.data[4] = this.data[4];\r\n    mat.data[5] = this.data[5];\r\n    return mat;\r\n  }\r\n\r\n  public toString() {\r\n    return `\r\n[${this.data[0]} ${this.data[2]} ${this.data[4]}]\r\n[${this.data[1]} ${this.data[3]} ${this.data[5]}]\r\n[0 0 1]\r\n`;\r\n  }\r\n\r\n}","import { AffineMatrix } from '../../Math/affine-matrix';\r\n\r\nexport class TransformStack {\r\n  private _transforms: AffineMatrix[] = [];\r\n  private _currentTransform: AffineMatrix = AffineMatrix.identity();\r\n\r\n  public save(): void {\r\n    this._transforms.push(this._currentTransform);\r\n    this._currentTransform = this._currentTransform.clone();\r\n  }\r\n\r\n  public restore(): void {\r\n    this._currentTransform = this._transforms.pop();\r\n  }\r\n\r\n  public translate(x: number, y: number): AffineMatrix {\r\n    return this._currentTransform.translate(x, y);\r\n  }\r\n\r\n  public rotate(angle: number): AffineMatrix {\r\n    return this._currentTransform.rotate(angle);\r\n  }\r\n\r\n  public scale(x: number, y: number): AffineMatrix {\r\n    return this._currentTransform.scale(x, y);\r\n  }\r\n\r\n  public set current(matrix: AffineMatrix) {\r\n    this._currentTransform = matrix;\r\n  }\r\n\r\n  public get current(): AffineMatrix {\r\n    return this._currentTransform;\r\n  }\r\n}\r\n","import { Color } from '../../Color';\r\nimport { ExcaliburGraphicsContextState } from './ExcaliburGraphicsContext';\r\n\r\nexport class StateStack {\r\n  private _states: ExcaliburGraphicsContextState[] = [];\r\n  private _currentState: ExcaliburGraphicsContextState = this._getDefaultState();\r\n\r\n  private _getDefaultState() {\r\n    return {\r\n      opacity: 1,\r\n      z: 0,\r\n      tint: Color.White\r\n    };\r\n  }\r\n\r\n  private _cloneState() {\r\n    return {\r\n      opacity: this._currentState.opacity,\r\n      z: this._currentState.z,\r\n      tint: this._currentState.tint.clone()\r\n    };\r\n  }\r\n\r\n  public save(): void {\r\n    this._states.push(this._currentState);\r\n    this._currentState = this._cloneState();\r\n  }\r\n\r\n  public restore(): void {\r\n    this._currentState = this._states.pop();\r\n  }\r\n\r\n  public get current(): ExcaliburGraphicsContextState {\r\n    return this._currentState;\r\n  }\r\n\r\n  public set current(val: ExcaliburGraphicsContextState) {\r\n    this._currentState = val;\r\n  }\r\n}\r\n","import { GameEvent } from './Events';\r\nimport { Eventable } from './Interfaces/Evented';\r\n\r\nexport class EventDispatcher<T = any> implements Eventable {\r\n  private _handlers: { [key: string]: { (event: GameEvent<T>): void }[] } = {};\r\n  private _wiredEventDispatchers: Eventable[] = [];\r\n\r\n  /**\r\n   * Clears any existing handlers or wired event dispatchers on this event dispatcher\r\n   */\r\n  public clear() {\r\n    this._handlers = {};\r\n    this._wiredEventDispatchers = [];\r\n  }\r\n\r\n  private _deferedHandlerRemovals: {name: string, handler?: (...args: any[]) => any }[] = [];\r\n  private _processDeferredHandlerRemovals() {\r\n    for (const eventHandler of this._deferedHandlerRemovals) {\r\n      this._removeHandler(eventHandler.name, eventHandler.handler);\r\n    }\r\n    this._deferedHandlerRemovals.length = 0;\r\n  }\r\n\r\n  /**\r\n   * Emits an event for target\r\n   * @param eventName  The name of the event to publish\r\n   * @param event      Optionally pass an event data object to the handler\r\n   */\r\n  public emit(eventName: string, event: GameEvent<T>) {\r\n    this._processDeferredHandlerRemovals();\r\n    if (!eventName) {\r\n      // key not mapped\r\n      return;\r\n    }\r\n    eventName = eventName.toLowerCase();\r\n    if (!event) {\r\n      event = new GameEvent();\r\n    }\r\n    let i: number, len: number;\r\n\r\n    if (this._handlers[eventName]) {\r\n      i = 0;\r\n      len = this._handlers[eventName].length;\r\n      for (i; i < len; i++) {\r\n        this._handlers[eventName][i](event);\r\n      }\r\n    }\r\n\r\n    i = 0;\r\n    len = this._wiredEventDispatchers.length;\r\n\r\n    for (i; i < len; i++) {\r\n      this._wiredEventDispatchers[i].emit(eventName, event);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Subscribe an event handler to a particular event name, multiple handlers per event name are allowed.\r\n   * @param eventName  The name of the event to subscribe to\r\n   * @param handler    The handler callback to fire on this event\r\n   */\r\n  public on(eventName: string, handler: (event: GameEvent<T>) => void) {\r\n    this._processDeferredHandlerRemovals();\r\n    eventName = eventName.toLowerCase();\r\n\r\n    if (!this._handlers[eventName]) {\r\n      this._handlers[eventName] = [];\r\n    }\r\n    this._handlers[eventName].push(handler);\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe an event handler(s) from an event. If a specific handler\r\n   * is specified for an event, only that handler will be unsubscribed.\r\n   * Otherwise all handlers will be unsubscribed for that event.\r\n   *\r\n   * @param eventName  The name of the event to unsubscribe\r\n   * @param handler    Optionally the specific handler to unsubscribe\r\n   */\r\n  public off(eventName: string, handler?: (event: GameEvent<T>) => void) {\r\n    this._deferedHandlerRemovals.push({name: eventName, handler});\r\n  }\r\n\r\n  private _removeHandler(eventName: string, handler?: (event: GameEvent<T>) => void) {\r\n    eventName = eventName.toLowerCase();\r\n    const eventHandlers = this._handlers[eventName];\r\n\r\n    if (eventHandlers) {\r\n      // if no explicit handler is give with the event name clear all handlers\r\n      if (!handler) {\r\n        this._handlers[eventName].length = 0;\r\n      } else {\r\n        const index = eventHandlers.indexOf(handler);\r\n        if (index > -1) {\r\n          this._handlers[eventName].splice(index, 1);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Once listens to an event one time, then unsubscribes from that event\r\n   *\r\n   * @param eventName The name of the event to subscribe to once\r\n   * @param handler   The handler of the event that will be auto unsubscribed\r\n   */\r\n  public once(eventName: string, handler: (event: GameEvent<T>) => void) {\r\n    this._processDeferredHandlerRemovals();\r\n    const metaHandler = (event: GameEvent<T>) => {\r\n      const ev = event || new GameEvent();\r\n      this.off(eventName, metaHandler);\r\n      handler(ev);\r\n    };\r\n\r\n    this.on(eventName, metaHandler);\r\n  }\r\n\r\n  /**\r\n   * Wires this event dispatcher to also receive events from another\r\n   */\r\n  public wire(eventDispatcher: EventDispatcher): void {\r\n    eventDispatcher._wiredEventDispatchers.push(this);\r\n  }\r\n\r\n  /**\r\n   * Unwires this event dispatcher from another\r\n   */\r\n  public unwire(eventDispatcher: EventDispatcher): void {\r\n    const index = eventDispatcher._wiredEventDispatchers.indexOf(this);\r\n    if (index > -1) {\r\n      eventDispatcher._wiredEventDispatchers.splice(index, 1);\r\n    }\r\n  }\r\n}\r\n","import { Loadable } from '../Interfaces/Loadable';\r\nimport { Logger } from '../Util/Log';\r\nimport { EventDispatcher } from '../EventDispatcher';\r\n\r\n/**\r\n * The [[Resource]] type allows games built in Excalibur to load generic resources.\r\n * For any type of remote resource it is recommended to use [[Resource]] for preloading.\r\n */\r\nexport class Resource<T> implements Loadable<T> {\r\n  public data: T = null;\r\n  public logger: Logger = Logger.getInstance();\r\n  public events: EventDispatcher = new EventDispatcher();\r\n\r\n  /**\r\n   * @param path          Path to the remote resource\r\n   * @param responseType  The type to expect as a response: \"\" | \"arraybuffer\" | \"blob\" | \"document\" | \"json\" | \"text\";\r\n   * @param bustCache     Whether or not to cache-bust requests\r\n   */\r\n  constructor(\r\n    public path: string,\r\n    public responseType: '' | 'arraybuffer' | 'blob' | 'document' | 'json' | 'text',\r\n    public bustCache: boolean = true\r\n  ) {}\r\n\r\n  /**\r\n   * Returns true if the Resource is completely loaded and is ready\r\n   * to be drawn.\r\n   */\r\n  public isLoaded(): boolean {\r\n    return this.data !== null;\r\n  }\r\n\r\n\r\n  private _cacheBust(uri: string): string {\r\n    const query: RegExp = /\\?\\w*=\\w*/;\r\n    if (query.test(uri)) {\r\n      uri += '&__=' + Date.now();\r\n    } else {\r\n      uri += '?__=' + Date.now();\r\n    }\r\n    return uri;\r\n  }\r\n  /**\r\n   * Begin loading the resource and returns a promise to be resolved on completion\r\n   */\r\n  public load(): Promise<T> {\r\n    return new Promise((resolve, reject) => {\r\n      // Exit early if we already have data\r\n      if (this.data !== null) {\r\n        this.logger.debug('Already have data for resource', this.path);\r\n        this.events.emit('complete', this.data as any);\r\n        resolve(this.data);\r\n        return;\r\n      }\r\n\r\n      const request = new XMLHttpRequest();\r\n      request.open('GET', this.bustCache ? this._cacheBust(this.path) : this.path, true);\r\n      request.responseType = this.responseType;\r\n      request.addEventListener('loadstart', (e) => this.events.emit('loadstart', e as any));\r\n      request.addEventListener('progress', (e) => this.events.emit('progress', e as any));\r\n      request.addEventListener('error', (e) => this.events.emit('error', e as any));\r\n      request.addEventListener('load', (e) => this.events.emit('load', e as any));\r\n      request.addEventListener('load', () => {\r\n        // XHR on file:// success status is 0, such as with PhantomJS\r\n        if (request.status !== 0 && request.status !== 200) {\r\n          this.logger.error('Failed to load resource ', this.path, ' server responded with error code', request.status);\r\n          this.events.emit('error', request.response);\r\n          reject(new Error(request.statusText));\r\n          return;\r\n        }\r\n\r\n        this.data = request.response;\r\n        this.events.emit('complete', this.data as any);\r\n        this.logger.debug('Completed loading resource', this.path);\r\n        resolve(this.data);\r\n      });\r\n      request.send();\r\n    });\r\n  }\r\n}\r\n","/**\r\n * Watch an object with a proxy, only fires if property value is different\r\n */\r\nexport function watch<T extends object>(type: T, change: (type: T) => any): T {\r\n  if (!type) {\r\n    return type;\r\n  }\r\n  if ((type as any).__isProxy === undefined) {\r\n    // expando hack to mark a proxy\r\n    return new Proxy(type, {\r\n      set: (obj, prop, value) => {\r\n        // The default behavior to store the value\r\n        if ((obj as any)[prop] !== value) {\r\n          (obj as any)[prop] = value;\r\n          // Avoid watching private junk\r\n          if (typeof prop === 'string') {\r\n            if (prop[0] !== '_') {\r\n              change(obj);\r\n            }\r\n          }\r\n        }\r\n        // Indicate success\r\n        return true;\r\n      },\r\n      get: (obj, prop) => {\r\n        if (prop !== '__isProxy') {\r\n          return (obj as any)[prop];\r\n        }\r\n        return true;\r\n      }\r\n    });\r\n  }\r\n  return type;\r\n}\r\n\r\n/**\r\n * Watch an object with a proxy, fires change on any property value change\r\n */\r\nexport function watchAny<T extends object>(type: T, change: (type: T) => any): T {\r\n  if (!type) {\r\n    return type;\r\n  }\r\n  if ((type as any).__isProxy === undefined) {\r\n    // expando hack to mark a proxy\r\n    return new Proxy(type, {\r\n      set: (obj, prop, value) => {\r\n        // The default behavior to store the value\r\n        (obj as any)[prop] = value;\r\n        // Avoid watching private junk\r\n        if (typeof prop === 'string') {\r\n          if (prop[0] !== '_') {\r\n            change(obj);\r\n          }\r\n        }\r\n\r\n        // Indicate success\r\n        return true;\r\n      },\r\n      get: (obj, prop) => {\r\n        if (prop !== '__isProxy') {\r\n          return (obj as any)[prop];\r\n        }\r\n        return true;\r\n      }\r\n    });\r\n  }\r\n  return type;\r\n}\r\n","import { Vector, vec } from '../Math/vector';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { BoundingBox } from '../Collision/BoundingBox';\r\nimport { Color } from '../Color';\r\nimport { watch } from '../Util/Watch';\r\nimport { AffineMatrix } from '../Math/affine-matrix';\r\n\r\nexport interface GraphicOptions {\r\n  /**\r\n   * The width of the graphic\r\n   */\r\n  width?: number;\r\n  /**\r\n   * The height of the graphic\r\n   */\r\n  height?: number;\r\n  /**\r\n   * Should the graphic be flipped horizontally\r\n   */\r\n  flipHorizontal?: boolean;\r\n  /**\r\n   * Should the graphic be flipped vertically\r\n   */\r\n  flipVertical?: boolean;\r\n  /**\r\n   * The rotation of the graphic\r\n   */\r\n  rotation?: number;\r\n  /**\r\n   * The scale of the graphic\r\n   */\r\n  scale?: Vector;\r\n  /**\r\n   * The opacity of the graphic\r\n   */\r\n  opacity?: number;\r\n  /**\r\n   * The tint of the graphic, this color will be multiplied by the original pixel colors\r\n   */\r\n  tint?: Color;\r\n  /**\r\n   * The origin of the drawing in pixels to use when applying transforms, by default it will be the center of the image\r\n   */\r\n  origin?: Vector;\r\n}\r\n\r\n/**\r\n * A Graphic is the base Excalibur primitive for something that can be drawn to the [[ExcaliburGraphicsContext]].\r\n * [[Sprite]], [[Animation]], [[GraphicsGroup]], [[Canvas]], [[Rectangle]], [[Circle]], and [[Polygon]] all derive from the\r\n * [[Graphic]] abstract class.\r\n *\r\n * Implementors of a Graphic must override the abstract [[Graphic._drawImage]] method to render an image to the graphics context. Graphic\r\n * handles all the position, rotation, and scale transformations in [[Graphic._preDraw]] and [[Graphic._postDraw]]\r\n */\r\nexport abstract class Graphic {\r\n  private static _ID: number = 0;\r\n  readonly id = Graphic._ID++;\r\n\r\n  public transform: AffineMatrix = AffineMatrix.identity();\r\n  public tint: Color = null;\r\n\r\n  private _transformStale = true;\r\n  public isStale() {\r\n    return this._transformStale;\r\n  }\r\n\r\n  /**\r\n   * Gets or sets wether to show debug information about the graphic\r\n   */\r\n  public showDebug: boolean = false;\r\n\r\n\r\n  private _flipHorizontal = false;\r\n  /**\r\n   * Gets or sets the flipHorizontal, which will flip the graphic horizontally (across the y axis)\r\n   */\r\n  public get flipHorizontal(): boolean {\r\n    return this._flipHorizontal;\r\n  }\r\n\r\n  public set flipHorizontal(value: boolean) {\r\n    this._flipHorizontal = value;\r\n    this._transformStale = true;\r\n  }\r\n\r\n  private _flipVertical = false;\r\n  /**\r\n   * Gets or sets the flipVertical, which will flip the graphic vertically (across the x axis)\r\n   */\r\n  public get flipVertical(): boolean {\r\n    return this._flipVertical;\r\n  }\r\n\r\n  public set flipVertical(value: boolean) {\r\n    this._flipVertical = value;\r\n    this._transformStale = true;\r\n  }\r\n\r\n  private _rotation = 0;\r\n  /**\r\n   * Gets or sets the rotation of the graphic\r\n   */\r\n  public get rotation(): number {\r\n    return this._rotation;\r\n  }\r\n\r\n  public set rotation(value: number) {\r\n    this._rotation = value;\r\n    this._transformStale = true;\r\n  }\r\n\r\n  /**\r\n   * Gets or sets the opacity of the graphic, 0 is transparent, 1 is solid (opaque).\r\n   */\r\n  public opacity: number = 1;\r\n\r\n  private _scale = Vector.One;\r\n  /**\r\n   * Gets or sets the scale of the graphic, this affects the width and\r\n   */\r\n  public get scale() {\r\n    return this._scale;\r\n  }\r\n\r\n  public set scale(value: Vector) {\r\n    this._scale = watch(value, () => {\r\n      this._transformStale = true;\r\n    });\r\n    this._transformStale = true;\r\n  }\r\n\r\n  private _origin: Vector | null = null;\r\n  /**\r\n   * Gets or sets the origin of the graphic, if not set the center of the graphic is the origin\r\n   */\r\n  public get origin(): Vector | null {\r\n    return this._origin;\r\n  }\r\n\r\n  public set origin(value: Vector | null) {\r\n    this._origin = watch(value, () => {\r\n      this._transformStale = true;\r\n    });\r\n    this._transformStale = true;\r\n  }\r\n\r\n  constructor(options?: GraphicOptions) {\r\n    if (options) {\r\n      this.origin = options.origin ?? this.origin;\r\n      this.flipHorizontal = options.flipHorizontal ?? this.flipHorizontal;\r\n      this.flipVertical = options.flipVertical ?? this.flipVertical;\r\n      this.rotation = options.rotation ?? this.rotation;\r\n      this.opacity = options.opacity ?? this.opacity;\r\n      this.scale = options.scale ?? this.scale;\r\n    }\r\n  }\r\n\r\n  public cloneGraphicOptions(): GraphicOptions {\r\n    return {\r\n      origin: this.origin ? this.origin.clone() : null,\r\n      flipHorizontal: this.flipHorizontal,\r\n      flipVertical: this.flipVertical,\r\n      rotation: this.rotation,\r\n      opacity: this.opacity,\r\n      scale: this.scale ? this.scale.clone() : null\r\n    };\r\n  }\r\n\r\n  private _width: number = 0;\r\n\r\n  /**\r\n   * Gets or sets the width of the graphic (always positive)\r\n   */\r\n  public get width() {\r\n    return Math.abs(this._width * this.scale.x);\r\n  }\r\n\r\n  private _height: number = 0;\r\n\r\n  /**\r\n   * Gets or sets the height of the graphic (always positive)\r\n   */\r\n  public get height() {\r\n    return Math.abs(this._height * this.scale.y);\r\n  }\r\n\r\n  public set width(value: number) {\r\n    this._width = value;\r\n    this._transformStale = true;\r\n  }\r\n\r\n  public set height(value: number) {\r\n    this._height = value;\r\n    this._transformStale = true;\r\n  }\r\n\r\n  /**\r\n   * Gets a copy of the bounds in pixels occupied by the graphic on the the screen. This includes scale.\r\n   */\r\n  public get localBounds(): BoundingBox {\r\n    return BoundingBox.fromDimension(this.width, this.height, Vector.Zero);\r\n  }\r\n\r\n  /**\r\n   * Draw the whole graphic to the context including transform\r\n   * @param ex The excalibur graphics context\r\n   * @param x\r\n   * @param y\r\n   */\r\n  public draw(ex: ExcaliburGraphicsContext, x: number, y: number): void {\r\n    this._preDraw(ex, x, y);\r\n    this._drawImage(ex, 0, 0);\r\n    this._postDraw(ex);\r\n  }\r\n\r\n  /**\r\n   * Meant to be overridden by the graphic implementation to draw the underlying image (HTMLCanvasElement or HTMLImageElement)\r\n   * to the graphics context without transform. Transformations like position, rotation, and scale are handled by [[Graphic._preDraw]]\r\n   * and [[Graphic._postDraw]]\r\n   * @param ex The excalibur graphics context\r\n   * @param x\r\n   * @param y\r\n   */\r\n  protected abstract _drawImage(ex: ExcaliburGraphicsContext, x: number, y: number): void;\r\n\r\n  /**\r\n   * Apply affine transformations to the graphics context to manipulate the graphic before [[Graphic._drawImage]]\r\n   * @param ex\r\n   * @param x\r\n   * @param y\r\n   */\r\n  protected _preDraw(ex: ExcaliburGraphicsContext, x: number, y: number): void {\r\n    ex.save();\r\n    ex.translate(x, y);\r\n    if (this._transformStale) {\r\n      this.transform.reset();\r\n      this.transform.scale(Math.abs(this.scale.x), Math.abs(this.scale.y));\r\n      this._rotate(this.transform);\r\n      this._flip(this.transform);\r\n      this._transformStale = false;\r\n    }\r\n    ex.multiply(this.transform);\r\n    // it is important to multiply alphas so graphics respect the current context\r\n    ex.opacity = ex.opacity * this.opacity;\r\n    if (this.tint) {\r\n      ex.tint = this.tint;\r\n    }\r\n  }\r\n\r\n  protected _rotate(ex: ExcaliburGraphicsContext | AffineMatrix) {\r\n    const scaleDirX = this.scale.x > 0 ? 1 : -1;\r\n    const scaleDirY = this.scale.y > 0 ? 1 : -1;\r\n    const origin = this.origin ?? vec(this.width / 2, this.height / 2);\r\n    ex.translate(origin.x, origin.y);\r\n    ex.rotate(this.rotation);\r\n    // This is for handling direction changes 1 or -1, that way we don't have mismatched translates()\r\n    ex.scale(scaleDirX, scaleDirY);\r\n    ex.translate(-origin.x, -origin.y);\r\n  }\r\n\r\n  protected _flip(ex: ExcaliburGraphicsContext | AffineMatrix) {\r\n    if (this.flipHorizontal) {\r\n      ex.translate(this.width / this.scale.x, 0);\r\n      ex.scale(-1, 1);\r\n    }\r\n\r\n    if (this.flipVertical) {\r\n      ex.translate(0, this.height / this.scale.y);\r\n      ex.scale(1, -1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Apply any additional work after [[Graphic._drawImage]] and restore the context state.\r\n   * @param ex\r\n   */\r\n  protected _postDraw(ex: ExcaliburGraphicsContext): void {\r\n    if (this.showDebug) {\r\n      ex.debug.drawRect(0, 0, this.width, this.height);\r\n    }\r\n    ex.restore();\r\n  }\r\n\r\n  /**\r\n   * Returns a new instance of the graphic that has the same properties\r\n   */\r\n  abstract clone(): Graphic;\r\n}\r\n","import { Graphic, GraphicOptions } from './Graphic';\r\nimport { ImageSource } from './ImageSource';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { Logger } from '../Util/Log';\r\n\r\nexport type SourceView = { x: number; y: number; width: number; height: number };\r\nexport type DestinationSize = { width: number; height: number };\r\n\r\nexport interface SpriteOptions {\r\n  /**\r\n   * Image to create a sprite from\r\n   */\r\n  image: ImageSource;\r\n  /**\r\n   * By default the source is the entire dimension of the [[ImageSource]]\r\n   */\r\n  sourceView?: { x: number; y: number; width: number; height: number };\r\n  /**\r\n   * By default the size of the final sprite is the size of the [[ImageSource]]\r\n   */\r\n  destSize?: { width: number; height: number };\r\n}\r\n\r\nexport class Sprite extends Graphic {\r\n  private _logger = Logger.getInstance();\r\n  public image: ImageSource;\r\n  public sourceView: SourceView;\r\n  public destSize: DestinationSize;\r\n  private _dirty = true;\r\n\r\n  public static from(image: ImageSource): Sprite {\r\n    return new Sprite({\r\n      image: image\r\n    });\r\n  }\r\n\r\n  constructor(options: GraphicOptions & SpriteOptions) {\r\n    super(options);\r\n    this.image = options.image;\r\n    const { width, height } = options;\r\n    this.sourceView = options.sourceView ?? { x: 0, y: 0, width: width ?? 0, height: height ?? 0 };\r\n    this.destSize = options.destSize ?? { width: width ?? 0, height: height ?? 0 };\r\n    this._updateSpriteDimensions();\r\n    this.image.ready.then(() => {\r\n      this._updateSpriteDimensions();\r\n    });\r\n  }\r\n\r\n  public override get width(): number {\r\n    return Math.abs(this.destSize.width * this.scale.x);\r\n  }\r\n\r\n  public override get height(): number {\r\n    return Math.abs(this.destSize.height * this.scale.y);\r\n  }\r\n\r\n  public override set width(newWidth: number) {\r\n    newWidth /= Math.abs(this.scale.x);\r\n    this.destSize.width = newWidth;\r\n    super.width = Math.ceil(this.destSize.width);\r\n  }\r\n\r\n  public override set height(newHeight: number) {\r\n    newHeight /= Math.abs(this.scale.y);\r\n    this.destSize.height = newHeight;\r\n    super.height = Math.ceil(this.destSize.height);\r\n  }\r\n\r\n  private _updateSpriteDimensions() {\r\n    const { width: nativeWidth, height: nativeHeight } = this.image;\r\n    // This code uses || to avoid 0's\r\n    // If the source is not specified, use the native dimension\r\n    this.sourceView.width = this.sourceView?.width || nativeWidth;\r\n    this.sourceView.height = this.sourceView?.height || nativeHeight;\r\n\r\n    // If the destination is not specified, use the source if specified, then native\r\n    this.destSize.width = this.destSize?.width || this.sourceView?.width || nativeWidth;\r\n    this.destSize.height = this.destSize?.height || this.sourceView?.height || nativeHeight;\r\n\r\n    this.width = Math.ceil(this.destSize.width) * this.scale.x;\r\n    this.height = Math.ceil(this.destSize.height) * this.scale.y;\r\n  }\r\n\r\n  protected _preDraw(ex: ExcaliburGraphicsContext, x: number, y: number): void {\r\n    if (this.image.isLoaded() && this._dirty) {\r\n      this._dirty = false;\r\n      this._updateSpriteDimensions();\r\n    }\r\n    super._preDraw(ex, x, y);\r\n  }\r\n\r\n  private _logNotLoadedWarning = false;\r\n  public _drawImage(ex: ExcaliburGraphicsContext, x: number, y: number): void {\r\n    if (this.image.isLoaded()) {\r\n      ex.drawImage(\r\n        this.image.image,\r\n        this.sourceView.x,\r\n        this.sourceView.y,\r\n        this.sourceView.width,\r\n        this.sourceView.height,\r\n        x,\r\n        y,\r\n        this.destSize.width,\r\n        this.destSize.height\r\n      );\r\n    } else {\r\n      if (!this._logNotLoadedWarning) {\r\n        this._logger.warn(\r\n          `ImageSource ${this.image.path}` +\r\n          ` is not yet loaded and won't be drawn. Please call .load() or include in a Loader.\\n\\n` +\r\n          `Read https://excaliburjs.com/docs/imagesource for more information.`\r\n        );\r\n      }\r\n      this._logNotLoadedWarning = true;\r\n    }\r\n  }\r\n\r\n  public clone(): Sprite {\r\n    return new Sprite({\r\n      image: this.image,\r\n      sourceView: { ...this.sourceView },\r\n      destSize: { ...this.destSize },\r\n      ...this.cloneGraphicOptions()\r\n    });\r\n  }\r\n}\r\n","import { Logger } from '../../Util/Log';\r\nimport { ImageFiltering } from '../Filtering';\r\nimport { HTMLImageSource } from './ExcaliburGraphicsContext';\r\n\r\n/**\r\n * Manages loading image sources into webgl textures, a unique id is associated with all sources\r\n */\r\nexport class TextureLoader {\r\n  private static _LOGGER = Logger.getInstance();\r\n  /**\r\n   * Sets the default filtering for the Excalibur texture loader, default [[ImageFiltering.Blended]]\r\n   */\r\n  public static filtering: ImageFiltering = ImageFiltering.Blended;\r\n\r\n  private static _GL: WebGLRenderingContext;\r\n\r\n  private static _TEXTURE_MAP = new Map<HTMLImageSource, WebGLTexture>();\r\n\r\n  private static _MAX_TEXTURE_SIZE: number  = 0;\r\n\r\n  public static register(context: WebGLRenderingContext): void {\r\n    TextureLoader._GL = context;\r\n    TextureLoader._MAX_TEXTURE_SIZE = context.getParameter(context.MAX_TEXTURE_SIZE);\r\n  }\r\n\r\n  /**\r\n   * Get the WebGL Texture from a source image\r\n   * @param image\r\n   */\r\n  public static get(image: HTMLImageSource): WebGLTexture {\r\n    return TextureLoader._TEXTURE_MAP.get(image);\r\n  }\r\n\r\n  /**\r\n   * Returns whether a source image has been loaded as a texture\r\n   * @param image\r\n   */\r\n  public static has(image: HTMLImageSource): boolean {\r\n    return TextureLoader._TEXTURE_MAP.has(image);\r\n  }\r\n\r\n  /**\r\n   * Loads a graphic into webgl and returns it's texture info, a webgl context must be previously registered\r\n   * @param image Source graphic\r\n   * @param filtering {ImageFiltering} The ImageFiltering mode to apply to the loaded texture\r\n   * @param forceUpdate Optionally force a texture to be reloaded, useful if the source graphic has changed\r\n   */\r\n  public static load(image: HTMLImageSource, filtering?: ImageFiltering, forceUpdate = false): WebGLTexture {\r\n    // Ignore loading if webgl is not registered\r\n    const gl = TextureLoader._GL;\r\n    if (!gl) {\r\n      return null;\r\n    }\r\n\r\n    let tex: WebGLTexture = null;\r\n    // If reuse the texture if it's from the same source\r\n    if (TextureLoader.has(image)) {\r\n      tex = TextureLoader.get(image);\r\n    }\r\n\r\n    // Update existing webgl texture and return early\r\n    if (tex) {\r\n      if (forceUpdate) {\r\n        gl.bindTexture(gl.TEXTURE_2D, tex);\r\n        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\r\n      }\r\n      return tex;\r\n    }\r\n\r\n    // No texture exists create a new one\r\n    tex = gl.createTexture();\r\n\r\n    TextureLoader.checkImageSizeSupportedAndLog(image);\r\n\r\n    gl.bindTexture(gl.TEXTURE_2D, tex);\r\n\r\n    gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, true);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n\r\n    // NEAREST for pixel art, LINEAR for hi-res\r\n    const filterMode = filtering ?? TextureLoader.filtering;\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, filterMode === ImageFiltering.Pixel ? gl.NEAREST : gl.LINEAR);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, filterMode === ImageFiltering.Pixel ? gl.NEAREST : gl.LINEAR);\r\n\r\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\r\n\r\n    TextureLoader._TEXTURE_MAP.set(image, tex);\r\n    return tex;\r\n  }\r\n\r\n  public static delete(image: HTMLImageSource): void {\r\n    // Ignore loading if webgl is not registered\r\n    const gl = TextureLoader._GL;\r\n    if (!gl) {\r\n      return null;\r\n    }\r\n\r\n    let tex: WebGLTexture = null;\r\n    if (TextureLoader.has(image)) {\r\n      tex = TextureLoader.get(image);\r\n      gl.deleteTexture(tex);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Takes an image and returns if it meets size criteria for hardware\r\n   * @param image\r\n   * @returns if the image will be supported at runtime\r\n   */\r\n  public static checkImageSizeSupportedAndLog(image: HTMLImageSource) {\r\n    const originalSrc = image.dataset.originalSrc ?? 'internal canvas bitmap';\r\n    if (image.width > TextureLoader._MAX_TEXTURE_SIZE || image.height > TextureLoader._MAX_TEXTURE_SIZE) {\r\n      TextureLoader._LOGGER.error(\r\n        `The image [${originalSrc}] provided to Excalibur is too large for the device's maximum texture size of `+\r\n        `(${TextureLoader._MAX_TEXTURE_SIZE}x${TextureLoader._MAX_TEXTURE_SIZE}) please resize to an image `\r\n        +`for excalibur to render properly.\\n\\nImages will likely render as black rectangles.\\n\\n`+\r\n        `Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`);\r\n      return false;\r\n    } else if (image.width > 4096 || image.height > 4096) {\r\n      // https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits\r\n      TextureLoader._LOGGER.warn(\r\n        `The image [${originalSrc}] provided to excalibur is too large may not work on all mobile devices, `+\r\n        `it is recommended you resize images to a maximum (4096x4096).\\n\\n` +\r\n        `Images will likely render as black rectangles on some mobile platforms.\\n\\n` +\r\n        `Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`);\r\n    }\r\n    return true;\r\n  }\r\n}\r\n","import { Resource } from '../Resources/Resource';\r\nimport { Sprite } from './Sprite';\r\nimport { Loadable } from '../Interfaces/Index';\r\nimport { Logger } from '../Util/Log';\r\nimport { TextureLoader } from '.';\r\nimport { ImageFiltering } from './Filtering';\r\nimport { Future } from '../Util/Future';\r\n\r\nexport class ImageSource implements Loadable<HTMLImageElement> {\r\n  private _logger = Logger.getInstance();\r\n  private _resource: Resource<Blob>;\r\n  private _filtering: ImageFiltering;\r\n\r\n  /**\r\n   * The original size of the source image in pixels\r\n   */\r\n  public get width() {\r\n    return this.image.naturalWidth;\r\n  }\r\n\r\n  /**\r\n   * The original height of the source image in pixels\r\n   */\r\n  public get height() {\r\n    return this.image.naturalHeight;\r\n  }\r\n\r\n  private _src: string;\r\n  /**\r\n   * Returns true if the Texture is completely loaded and is ready\r\n   * to be drawn.\r\n   */\r\n  public isLoaded(): boolean {\r\n    if (!this._src) {\r\n      // this boosts speed of access\r\n      this._src = this.data.src;\r\n    }\r\n    return !!this._src;\r\n  }\r\n\r\n  /**\r\n   * Access to the underlying html image element\r\n   */\r\n  public data: HTMLImageElement = new Image();\r\n  public get image(): HTMLImageElement {\r\n    return this.data;\r\n  }\r\n\r\n  private _readyFuture = new Future<HTMLImageElement>();\r\n  /**\r\n   * Promise the resolves when the image is loaded and ready for use, does not initiate loading\r\n   */\r\n  public ready: Promise<HTMLImageElement> = this._readyFuture.promise;\r\n\r\n  /**\r\n   * The path to the image, can also be a data url like 'data:image/'\r\n   * @param path {string} Path to the image resource relative from the HTML document hosting the game, or absolute\r\n   * @param bustCache {boolean} Should excalibur add a cache busting querystring?\r\n   * @param filtering {ImageFiltering} Optionally override the image filtering set by [[EngineOptions.antialiasing]]\r\n   */\r\n  constructor(public readonly path: string, bustCache: boolean = false, filtering?: ImageFiltering) {\r\n    this._resource = new Resource(path, 'blob', bustCache);\r\n    this._filtering = filtering;\r\n    if (path.endsWith('.svg') || path.endsWith('.gif')) {\r\n      this._logger.warn(`Image type is not fully supported, you may have mixed results ${path}. Fully supported: jpg, bmp, and png`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Begins loading the image and returns a promise that resolves when the image is loaded\r\n   */\r\n  async load(): Promise<HTMLImageElement> {\r\n    if (this.isLoaded()) {\r\n      return this.data;\r\n    }\r\n    try {\r\n      // Load base64 or blob if needed\r\n      let url: string;\r\n      if (!this.path.includes('data:image/')) {\r\n        const blob = await this._resource.load();\r\n        url = URL.createObjectURL(blob);\r\n      } else {\r\n        url = this.path;\r\n      }\r\n\r\n      // Decode the image\r\n      const image = new Image();\r\n      // Use Image.onload over Image.decode()\r\n      // https://bugs.chromium.org/p/chromium/issues/detail?id=1055828#c7\r\n      // Otherwise chrome will throw still Image.decode() failures for large textures\r\n      const loadedFuture = new Future<void>();\r\n      image.onload = () => loadedFuture.resolve();\r\n      image.src = url;\r\n      image.setAttribute('data-original-src', this.path);\r\n\r\n      await loadedFuture.promise;\r\n\r\n      // Set results\r\n      this.data = image;\r\n    } catch (error) {\r\n      throw `Error loading ImageSource from path '${this.path}' with error [${error.message}]`;\r\n    }\r\n    TextureLoader.load(this.data, this._filtering);\r\n    // todo emit complete\r\n    this._readyFuture.resolve(this.data);\r\n    return this.data;\r\n  }\r\n\r\n  /**\r\n   * Build a sprite from this ImageSource\r\n   */\r\n  public toSprite(): Sprite {\r\n    return Sprite.from(this);\r\n  }\r\n\r\n  /**\r\n   * Unload images from memory\r\n   */\r\n  unload(): void {\r\n    this.data = new Image();\r\n  }\r\n}\r\n","import { ImageSource } from './ImageSource';\r\nimport { SourceView, Sprite } from './Sprite';\r\nimport { Logger } from '../Util/Log';\r\n\r\n/**\r\n * Specify sprite sheet spacing options, useful if your sprites are not tightly packed\r\n * and have space between them.\r\n */\r\nexport interface SpriteSheetSpacingDimensions {\r\n  /**\r\n   * The starting point to offset and start slicing the sprite sheet from the top left of the image.\r\n   * Default is (0, 0)\r\n   */\r\n  originOffset?: { x?: number, y?: number };\r\n\r\n  /**\r\n   * The margin between sprites.\r\n   * Default is (0, 0)\r\n   */\r\n  margin?: {x?: number, y?: number};\r\n}\r\n\r\n/**\r\n * Sprite sheet options for slicing up images\r\n */\r\nexport interface SpriteSheetGridOptions {\r\n  /**\r\n   * Source image to use for each sprite\r\n   */\r\n  image: ImageSource;\r\n  /**\r\n   * Grid definition for the sprite sheet\r\n   */\r\n  grid: {\r\n    /**\r\n     * Number of rows in the sprite sheet\r\n     */\r\n    rows: number;\r\n    /**\r\n     * Number of columns in the sprite sheet\r\n     */\r\n    columns: number;\r\n    /**\r\n     * Width of each individual sprite\r\n     */\r\n    spriteWidth: number;\r\n    /**\r\n     * Height of each individual sprite\r\n     */\r\n    spriteHeight: number;\r\n  };\r\n  /**\r\n   * Optionally specify any spacing information between sprites\r\n   */\r\n  spacing?: SpriteSheetSpacingDimensions;\r\n}\r\n\r\nexport interface SpriteSheetSparseOptions {\r\n  /**\r\n   * Source image to use for each sprite\r\n   */\r\n  image: ImageSource;\r\n  /**\r\n   * List of source view rectangles to create a sprite sheet from\r\n   */\r\n  sourceViews: SourceView[];\r\n}\r\n\r\nexport interface SpriteSheetOptions {\r\n  /**\r\n   * Source sprites for the sprite sheet\r\n   */\r\n  sprites: Sprite[];\r\n  /**\r\n   * Optionally specify the number of rows in a sprite sheet (default 1 row)\r\n   */\r\n  rows?: number;\r\n  /**\r\n   * Optionally specify the number of columns in a sprite sheet (default sprites.length)\r\n   */\r\n  columns?: number;\r\n}\r\n\r\n/**\r\n * Represents a collection of sprites from a source image with some organization in a grid\r\n */\r\nexport class SpriteSheet {\r\n  private _logger = Logger.getInstance();\r\n  public readonly sprites: Sprite[] = [];\r\n  public readonly rows: number;\r\n  public readonly columns: number;\r\n\r\n  /**\r\n   * Build a new sprite sheet from a list of sprites\r\n   *\r\n   * Use [[SpriteSheet.fromImageSource]] to create a SpriteSheet from an [[ImageSource]] organized in a grid\r\n   * @param options\r\n   */\r\n  constructor(options: SpriteSheetOptions) {\r\n    const { sprites, rows, columns } = options;\r\n    this.sprites = sprites;\r\n    this.rows = rows ?? 1;\r\n    this.columns = columns ?? this.sprites.length;\r\n  }\r\n\r\n  /**\r\n   * Find a sprite by their x/y position in the SpriteSheet, for example `getSprite(0, 0)` is the [[Sprite]] in the top-left\r\n   * @param x\r\n   * @param y\r\n   */\r\n  public getSprite(x: number, y: number): Sprite | null {\r\n    if (x >= this.columns || x < 0) {\r\n      this._logger.warn(`No sprite exists in the SpriteSheet at (${x}, ${y}), x: ${x} should be between 0 and ${this.columns - 1}`);\r\n      return null;\r\n    }\r\n    if (y >= this.rows || y < 0) {\r\n      this._logger.warn(`No sprite exists in the SpriteSheet at (${x}, ${y}), y: ${y} should be between 0 and ${this.rows - 1}`);\r\n      return null;\r\n    }\r\n    const spriteIndex = x + y * this.columns;\r\n    return this.sprites[spriteIndex];\r\n  }\r\n\r\n  /**\r\n   * Create a sprite sheet from a sparse set of [[SourceView]] rectangles\r\n   * @param options\r\n   */\r\n  public static fromImageSourceWithSourceViews(options: SpriteSheetSparseOptions): SpriteSheet {\r\n    const sprites: Sprite[] = options.sourceViews.map(sourceView => {\r\n      return new Sprite({\r\n        image: options.image,\r\n        sourceView\r\n      });\r\n    });\r\n    return new SpriteSheet({sprites});\r\n  }\r\n\r\n  /**\r\n   * Create a SpriteSheet from an [[ImageSource]] organized in a grid\r\n   *\r\n   * Example:\r\n   * ```\r\n   * const spriteSheet = SpriteSheet.fromImageSource({\r\n   *   image: imageSource,\r\n   *   grid: {\r\n   *     rows: 5,\r\n   *     columns: 2,\r\n   *     spriteWidth: 32, // pixels\r\n   *     spriteHeight: 32 // pixels\r\n   *   },\r\n   *   // Optionally specify spacing\r\n   *   spacing: {\r\n   *     // pixels from the top left to start the sprite parsing\r\n   *     originOffset: {\r\n   *       x: 5,\r\n   *       y: 5\r\n   *     },\r\n   *     // pixels between each sprite while parsing\r\n   *     margin: {\r\n   *       x: 1,\r\n   *       y: 1\r\n   *     }\r\n   *   }\r\n   * })\r\n   * ```\r\n   *\r\n   * @param options\r\n   */\r\n  public static fromImageSource(options: SpriteSheetGridOptions): SpriteSheet {\r\n    const sprites: Sprite[] = [];\r\n    options.spacing = options.spacing ?? {};\r\n    const {\r\n      image,\r\n      grid: { rows, columns: cols, spriteWidth, spriteHeight },\r\n      spacing: { originOffset, margin }\r\n    } = options;\r\n    const offsetDefaults = { x: 0, y: 0, ...originOffset};\r\n    const marginDefaults = { x: 0, y: 0, ...margin};\r\n    for (let x = 0; x < cols; x++) {\r\n      for (let y = 0; y < rows; y++) {\r\n        sprites[x + y * cols] = new Sprite({\r\n          image: image,\r\n          sourceView: {\r\n            x: x * spriteWidth + marginDefaults.x * x + offsetDefaults.x,\r\n            y: y * spriteHeight + marginDefaults.y * y + offsetDefaults.y,\r\n            width: spriteWidth,\r\n            height: spriteHeight\r\n          },\r\n          destSize: { height: spriteHeight, width: spriteWidth }\r\n        });\r\n      }\r\n    }\r\n    return new SpriteSheet({\r\n      sprites: sprites,\r\n      rows: rows,\r\n      columns: cols\r\n    });\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\r\nimport { Logger } from '../Util/Log';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { FontRenderer } from './FontCommon';\r\nimport { Graphic, GraphicOptions } from './Graphic';\r\nimport { Sprite } from './Sprite';\r\nimport { SpriteSheet } from './SpriteSheet';\r\nimport { BoundingBox, Color } from '..';\r\n\r\nexport interface SpriteFontOptions {\r\n  /**\r\n   * Alphabet string in spritesheet order (default is row column order)\r\n   * example: 'abcdefghijklmnopqrstuvwxyz'\r\n   */\r\n  alphabet: string;\r\n  /**\r\n   * [[SpriteSheet]] to source character sprites from\r\n   */\r\n  spriteSheet: SpriteSheet;\r\n  /**\r\n   * Optionally ignore case in the supplied text;\r\n   */\r\n  caseInsensitive?: boolean;\r\n  /**\r\n   * Optionally adjust the spacing between character sprites\r\n   */\r\n  spacing?: number;\r\n  /**\r\n   * Optionally specify a \"shadow\"\r\n   */\r\n  shadow?: { offset: Vector };\r\n}\r\n\r\nexport class SpriteFont extends Graphic implements FontRenderer {\r\n  private _text: string = '';\r\n  public alphabet: string = '';\r\n  public spriteSheet: SpriteSheet;\r\n\r\n  public shadow: { offset: Vector } = null;\r\n  public caseInsensitive = false;\r\n  public spacing: number = 0;\r\n\r\n  private _logger = Logger.getInstance();\r\n\r\n  constructor(options: SpriteFontOptions & GraphicOptions) {\r\n    super(options);\r\n    const { alphabet, spriteSheet, caseInsensitive, spacing, shadow } = options;\r\n    this.alphabet = alphabet;\r\n    this.spriteSheet = spriteSheet;\r\n    this.caseInsensitive = caseInsensitive ?? this.caseInsensitive;\r\n    this.spacing = spacing ?? this.spacing;\r\n    this.shadow = shadow ?? this.shadow;\r\n  }\r\n\r\n  private _alreadyWarnedAlphabet = false;\r\n  private _alreadyWarnedSpriteSheet = false;\r\n  private _getCharacterSprites(text: string): Sprite[] {\r\n    const results: Sprite[] = [];\r\n    // handle case insensitive\r\n    const textToRender = this.caseInsensitive ? text.toLocaleLowerCase() : text;\r\n    const alphabet = this.caseInsensitive ? this.alphabet.toLocaleLowerCase() : this.alphabet;\r\n\r\n    // for each letter in text\r\n    for (let letterIndex = 0; letterIndex < textToRender.length; letterIndex++) {\r\n      // find the sprite index in alphabet , if there is an error pick the first\r\n      const letter = textToRender[letterIndex];\r\n      let spriteIndex = alphabet.indexOf(letter);\r\n      if (spriteIndex === -1) {\r\n        spriteIndex = 0;\r\n        if (!this._alreadyWarnedAlphabet) {\r\n          this._logger.warn(`SpriteFont - Cannot find letter '${letter}' in configured alphabet '${alphabet}'.`);\r\n          this._logger.warn('There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged.');\r\n          this._alreadyWarnedAlphabet = true;\r\n        }\r\n      }\r\n\r\n      const letterSprite = this.spriteSheet.sprites[spriteIndex];\r\n      if (letterSprite) {\r\n        results.push(letterSprite);\r\n      } else {\r\n        if (!this._alreadyWarnedSpriteSheet) {\r\n          this._logger.warn(`SpriteFont - Cannot find sprite for '${letter}' at index '${spriteIndex}' in configured SpriteSheet`);\r\n          this._logger.warn('There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged.');\r\n          this._alreadyWarnedSpriteSheet = true;\r\n        }\r\n      }\r\n    }\r\n    return results;\r\n  }\r\n\r\n  public measureText(text: string): BoundingBox {\r\n    const lines = text.split('\\n');\r\n    const maxWidthLine = lines.reduce((a, b) => {\r\n      return a.length > b.length ? a : b;\r\n    });\r\n    const sprites = this._getCharacterSprites(maxWidthLine);\r\n    let width = 0;\r\n    let height = 0;\r\n    for (const sprite of sprites) {\r\n      width += sprite.width + this.spacing;\r\n      height = Math.max(height, sprite.height);\r\n    }\r\n    return BoundingBox.fromDimension(width, height * lines.length, Vector.Zero);\r\n  }\r\n\r\n  protected _drawImage(ex: ExcaliburGraphicsContext, x: number, y: number): void {\r\n    let xCursor = 0;\r\n    let yCursor = 0;\r\n    let height = 0;\r\n    const lines = this._text.split('\\n');\r\n    for (const line of lines) {\r\n      for (const sprite of this._getCharacterSprites(line)) {\r\n        // draw it in the right spot and increase the cursor by sprite width\r\n        sprite.draw(ex, x + xCursor, y + yCursor);\r\n        xCursor += sprite.width + this.spacing;\r\n        height = Math.max(height, sprite.height);\r\n      }\r\n      xCursor = 0;\r\n      yCursor += height;\r\n    }\r\n  }\r\n\r\n  render(ex: ExcaliburGraphicsContext, text: string, _color: Color, x: number, y: number) {\r\n    // SpriteFont doesn't support _color, yet...\r\n    this._text = text;\r\n    const bounds = this.measureText(text);\r\n    this.width = bounds.width;\r\n    this.height = bounds.height;\r\n    if (this.shadow) {\r\n      ex.save();\r\n      ex.translate(this.shadow.offset.x, this.shadow.offset.y);\r\n      this.draw(ex, x, y);\r\n      ex.restore();\r\n    }\r\n\r\n    this.draw(ex, x, y);\r\n  }\r\n\r\n  clone(): SpriteFont {\r\n    return new SpriteFont({\r\n      alphabet: this.alphabet,\r\n      spriteSheet: this.spriteSheet,\r\n      spacing: this.spacing\r\n    });\r\n  }\r\n}\r\n","import { ExcaliburGraphicsContext, ImageSource, SpriteFont, SpriteSheet } from '..';\r\nimport { Vector } from '../..';\r\nimport debugFont from './debug-font.png';\r\n\r\n/**\r\n * Internal debugtext helper\r\n */\r\nexport class DebugText {\r\n  constructor() {\r\n    this.load();\r\n  }\r\n\r\n  /**\r\n   * base64 font\r\n   */\r\n  public readonly fontSheet = debugFont;\r\n  public size: number = 16;\r\n  private _imageSource: ImageSource;\r\n  private _spriteSheet: SpriteSheet;\r\n  private _spriteFont: SpriteFont;\r\n  public load() {\r\n    this._imageSource = new ImageSource(this.fontSheet);\r\n    return this._imageSource.load().then(() => {\r\n      this._spriteSheet = SpriteSheet.fromImageSource({\r\n        image: this._imageSource,\r\n        grid: {\r\n          rows: 3,\r\n          columns: 16,\r\n          spriteWidth: 16,\r\n          spriteHeight: 16\r\n        }\r\n      });\r\n      this._spriteFont = new SpriteFont({\r\n        alphabet: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,!\\'&.\"?-()+ ',\r\n        caseInsensitive: true,\r\n        spriteSheet: this._spriteSheet,\r\n        spacing: -6\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Writes debug text using the built in sprint font\r\n   * @param ctx\r\n   * @param text\r\n   * @param pos\r\n   */\r\n  public write(ctx: ExcaliburGraphicsContext, text: string, pos: Vector) {\r\n    if (this._imageSource.isLoaded()) {\r\n      this._spriteFont.render(ctx, text, null, pos.x, pos.y);\r\n    }\r\n  }\r\n}\r\n","export default \"data:image/png;base64,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\"","export class RenderSource {\r\n  constructor(\r\n    private _gl: WebGLRenderingContext,\r\n    private _texture: WebGLTexture) {}\r\n\r\n  public use() {\r\n    const gl = this._gl;\r\n    gl.activeTexture(gl.TEXTURE0);\r\n    gl.bindTexture(gl.TEXTURE_2D, this._texture);\r\n  }\r\n\r\n  public disable() {\r\n    const gl = this._gl;\r\n    gl.bindTexture(gl.TEXTURE_2D, null);\r\n  }\r\n}","import { RenderSource } from './render-source';\r\n\r\nexport class RenderTarget {\r\n  width: number;\r\n  height: number;\r\n  private _gl: WebGLRenderingContext;\r\n  constructor(options: {gl: WebGLRenderingContext, width: number, height: number}) {\r\n    this.width = options.width;\r\n    this.height = options.height;\r\n    this._gl = options.gl;\r\n    this._setupFramebuffer();\r\n  }\r\n\r\n  setResolution(width: number, height: number) {\r\n    const gl = this._gl;\r\n    this.width = width;\r\n    this.height = height;\r\n    gl.bindTexture(gl.TEXTURE_2D, this._frameTexture);\r\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, this.width, this.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);\r\n  }\r\n\r\n  private _frameBuffer: WebGLFramebuffer;\r\n  public get frameBuffer() {\r\n    return this._frameBuffer;\r\n  }\r\n  private _frameTexture: WebGLTexture;\r\n  public get frameTexture() {\r\n    return this._frameTexture;\r\n  }\r\n  private _setupFramebuffer() {\r\n    // Allocates frame buffer\r\n    const gl = this._gl;\r\n    this._frameTexture = gl.createTexture();\r\n    gl.bindTexture(gl.TEXTURE_2D, this._frameTexture);\r\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, this.width, this.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);\r\n\r\n    // set the filtering so we don't need mips\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n\r\n\r\n    // attach the texture as the first color attachment\r\n    const attachmentPoint = gl.COLOR_ATTACHMENT0;\r\n\r\n    // After this bind all draw calls will draw to this framebuffer texture\r\n    this._frameBuffer = gl.createFramebuffer();\r\n    gl.bindFramebuffer(gl.FRAMEBUFFER, this._frameBuffer);\r\n    gl.framebufferTexture2D(gl.FRAMEBUFFER, attachmentPoint, gl.TEXTURE_2D, this._frameTexture, 0);\r\n    // Reset after initialized\r\n    this.disable();\r\n  }\r\n\r\n  public toRenderSource() {\r\n    const source = new RenderSource(this._gl, this._frameTexture);\r\n    return source;\r\n  }\r\n\r\n  /**\r\n   * When called, all drawing gets redirected to this render target\r\n   */\r\n  public use() {\r\n    const gl = this._gl;\r\n    gl.bindFramebuffer(gl.FRAMEBUFFER, this._frameBuffer);\r\n    // very important to set the viewport to the size of the framebuffer texture\r\n    gl.viewport(0, 0, this.width, this.height);\r\n  }\r\n\r\n  /**\r\n   * When called, all drawing is sent back to the canvas\r\n   */\r\n  public disable() {\r\n    const gl = this._gl;\r\n    // passing null switches rendering back to the canvas\r\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n    gl.bindTexture(gl.TEXTURE_2D, null);\r\n  }\r\n}","\r\n/**\r\n * Must be accessed after Engine construction time to ensure the context has been created\r\n */\r\nexport class ExcaliburWebGLContextAccessor {\r\n  private static _GL: WebGL2RenderingContext;\r\n  public static clear() {\r\n    ExcaliburWebGLContextAccessor._GL = null;\r\n  }\r\n  public static register(gl: WebGL2RenderingContext) {\r\n    ExcaliburWebGLContextAccessor._GL = gl;\r\n  }\r\n  // current webgl context\r\n  public static get gl(): WebGL2RenderingContext {\r\n    if (!ExcaliburWebGLContextAccessor._GL) {\r\n      throw Error('Attempted gl access before init');\r\n    }\r\n    return ExcaliburWebGLContextAccessor._GL;\r\n  }\r\n}","/**\r\n * Return the size of the GlType in bytes\r\n * @param gl\r\n * @param type\r\n */\r\nexport function getGlTypeSizeBytes(gl: WebGLRenderingContext, type: number): number {\r\n  switch (type) {\r\n    case gl.FLOAT:\r\n      return 4;\r\n    case gl.SHORT:\r\n      return 2;\r\n    case gl.UNSIGNED_SHORT:\r\n      return 2;\r\n    case gl.BYTE:\r\n      return 1;\r\n    case gl.UNSIGNED_BYTE:\r\n      return 1;\r\n    default:\r\n      return 1;\r\n  }\r\n}\r\n\r\n\r\n/**\r\n * Based on the type return the number of attribute components\r\n *\r\n * https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/vertexAttribPointer\r\n * @param gl\r\n * @param type\r\n */\r\nexport function getAttributeComponentSize(gl: WebGLRenderingContext, type: number): number {\r\n  switch (type) {\r\n    case gl.LOW_FLOAT:\r\n    case gl.HIGH_FLOAT:\r\n    case gl.FLOAT:\r\n      return 1;\r\n    case gl.FLOAT_VEC2:\r\n      return 2;\r\n    case gl.FLOAT_VEC3:\r\n      return 3;\r\n    case gl.FLOAT_VEC4:\r\n      return 4;\r\n    case gl.BYTE:\r\n      return 1;\r\n    case gl.UNSIGNED_BYTE:\r\n      return 1;\r\n    case gl.UNSIGNED_SHORT:\r\n    case gl.SHORT:\r\n      return 1;\r\n    default:\r\n      return 1;\r\n  }\r\n}\r\n\r\n/**\r\n * Based on the attribute return the corresponding supported attrib pointer type\r\n * https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/vertexAttribPointer\r\n *\r\n * @param gl\r\n * @param type\r\n */\r\nexport function getAttributePointerType(gl: WebGLRenderingContext, type: number) {\r\n  switch (type) {\r\n    case gl.LOW_FLOAT:\r\n    case gl.HIGH_FLOAT:\r\n    case gl.FLOAT:\r\n    case gl.FLOAT_VEC2:\r\n    case gl.FLOAT_VEC3:\r\n    case gl.FLOAT_VEC4:\r\n      return gl.FLOAT;\r\n    case gl.BYTE:\r\n      return gl.BYTE;\r\n    case gl.UNSIGNED_BYTE:\r\n      return gl.UNSIGNED_BYTE;\r\n    case gl.SHORT:\r\n      return gl.SHORT;\r\n    case gl.UNSIGNED_SHORT:\r\n      return gl.UNSIGNED_SHORT;\r\n    default:\r\n      return gl.FLOAT;\r\n  }\r\n}","import { Vector } from '../..';\r\nimport { Matrix } from '../../Math/matrix';\r\nimport { ExcaliburWebGLContextAccessor } from './webgl-adapter';\r\nimport { getAttributeComponentSize, getAttributePointerType } from './webgl-util';\r\n\r\nexport type UniformTypeNames =\r\n  'uniform1f' |\r\n  'uniform1i' |\r\n  'uniform2f' |\r\n  'uniform2i' |\r\n  'uniform3f' |\r\n  'uniform3i' |\r\n  'uniform4f' |\r\n  'uniform4i' |\r\n  'uniform1fv' |\r\n  'uniform1iv' |\r\n  'uniform2fv' |\r\n  'uniform2iv' |\r\n  'uniform3fv' |\r\n  'uniform3iv' |\r\n  'uniform4fv' |\r\n  'uniform4iv' |\r\n  'uniformMatrix2fv' |\r\n  'uniformMatrix3fv' |\r\n  'uniformMatrix4fv';\r\n\r\ntype RemoveFirstFromTuple<T extends any[]> =\r\n  T['length'] extends 0 ? undefined :\r\n    (((...b: T) => void) extends (a: any, ...b: infer I) => void ? I : [])\r\n\r\ntype UniformParameters<TUniformType extends UniformTypeNames> = RemoveFirstFromTuple<Parameters<WebGLRenderingContext[TUniformType]>>\r\n\r\nexport interface UniformDefinition {\r\n  name: string;\r\n  glType: number;\r\n  location: WebGLUniformLocation;\r\n}\r\n\r\n\r\nexport interface VertexAttributeDefinition {\r\n  /**\r\n   * string name of the attribute in the shader program, commonly `a_nameofmyvariable`\r\n   */\r\n  name: string;\r\n  /**\r\n   * Number of components for a given attribute\r\n   * Must be 1, 2, 3, or 4\r\n   *\r\n   * For example a vec4 attribute would be `4` floats, so 4\r\n   */\r\n  size: number;\r\n  /**\r\n   * Supported types in webgl 1\r\n   * * gl.BYTE\r\n   * * gl.SHORT\r\n   * * gl.UNSIGNED_BYTE\r\n   * * gl.UNSIGNED_SHORT\r\n   * * gl.FLOAT\r\n   * https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/vertexAttribPointer\r\n   */\r\n  glType: number;\r\n  /**\r\n   * Is the attribute normalized between (0-1)\r\n   */\r\n  normalized: boolean;\r\n  /**\r\n   * Location index in the shader program\r\n   */\r\n  location: number;\r\n}\r\n\r\nexport interface ShaderOptions {\r\n  vertexSource: string;\r\n  fragmentSource: string;\r\n}\r\n\r\nexport class Shader {\r\n  private static _ACTIVE_SHADER_INSTANCE: Shader = null;\r\n  private _gl: WebGLRenderingContext = ExcaliburWebGLContextAccessor.gl;\r\n  public program: WebGLProgram;\r\n  public uniforms: { [variableName: string]: UniformDefinition } = {};\r\n  public attributes: { [variableName: string]: VertexAttributeDefinition } = {};\r\n  private _compiled = false;\r\n  public readonly vertexSource: string;\r\n  public readonly fragmentSource: string;\r\n\r\n  public get compiled() {\r\n    return this._compiled;\r\n  }\r\n\r\n  /**\r\n   * Create a shader program in excalibur\r\n   * @param options specify shader vertex and fragment source\r\n   */\r\n  constructor(options?: ShaderOptions) {\r\n    const { vertexSource, fragmentSource } = options;\r\n    this.vertexSource = vertexSource;\r\n    this.fragmentSource = fragmentSource;\r\n  }\r\n\r\n  /**\r\n   * Binds the shader program\r\n   */\r\n  use() {\r\n    const gl = this._gl;\r\n    gl.useProgram(this.program);\r\n    Shader._ACTIVE_SHADER_INSTANCE = this;\r\n  }\r\n\r\n  isCurrentlyBound() {\r\n    return Shader._ACTIVE_SHADER_INSTANCE === this;\r\n  }\r\n\r\n  /**\r\n   * Compile the current shader against a webgl context\r\n   */\r\n  compile(): WebGLProgram {\r\n    const gl = this._gl;\r\n    const vertexShader = this._compileShader(gl, this.vertexSource, gl.VERTEX_SHADER);\r\n    const fragmentShader = this._compileShader(gl, this.fragmentSource, gl.FRAGMENT_SHADER);\r\n    this.program = this._createProgram(gl, vertexShader, fragmentShader);\r\n\r\n    const attributes = this.getAttributes();\r\n    for (const attribute of attributes) {\r\n      this.attributes[attribute.name] = attribute;\r\n    }\r\n    const uniforms = this.getUniforms();\r\n    for (const uniform of uniforms) {\r\n      this.uniforms[uniform.name] = uniform;\r\n    }\r\n\r\n    this._compiled = true;\r\n    return this.program;\r\n  }\r\n\r\n  getUniforms(): UniformDefinition[] {\r\n    const gl = this._gl;\r\n    const uniformCount = gl.getProgramParameter(this.program, gl.ACTIVE_UNIFORMS);\r\n    const uniforms: UniformDefinition[] = [];\r\n    for (let i = 0; i < uniformCount; i++) {\r\n      const uniform = gl.getActiveUniform(this.program, i);\r\n      const uniformLocation = gl.getUniformLocation(this.program, uniform.name);\r\n      uniforms.push({\r\n        name: uniform.name,\r\n        glType: uniform.type,\r\n        location: uniformLocation\r\n      });\r\n    }\r\n    return uniforms;\r\n  }\r\n\r\n  getAttributes(): VertexAttributeDefinition[] {\r\n    const gl = this._gl;\r\n    const attributeCount = gl.getProgramParameter(this.program, gl.ACTIVE_ATTRIBUTES);\r\n    const attributes: VertexAttributeDefinition[] = [];\r\n    for (let i = 0; i < attributeCount; i++) {\r\n      const attribute = gl.getActiveAttrib(this.program, i);\r\n      const attributeLocation = gl.getAttribLocation(this.program, attribute.name);\r\n      attributes.push({\r\n        name: attribute.name,\r\n        glType: getAttributePointerType(gl, attribute.type),\r\n        size: getAttributeComponentSize(gl, attribute.type),\r\n        location: attributeLocation,\r\n        normalized: false\r\n      });\r\n    }\r\n    return attributes;\r\n  }\r\n\r\n  /**\r\n   * Set a texture in a gpu texture slot\r\n   * @param slotNumber\r\n   * @param texture\r\n   */\r\n  setTexture(slotNumber: number, texture: WebGLTexture) {\r\n    const gl = this._gl;\r\n    gl.activeTexture(gl.TEXTURE0 + slotNumber);\r\n    gl.bindTexture(gl.TEXTURE_2D, texture);\r\n  }\r\n\r\n  /**\r\n   * Set an integer uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   *\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformInt(name: string, value: number) {\r\n    this.setUniform('uniform1i', name, ~~value);\r\n  }\r\n\r\n  /**\r\n   * Set an integer array uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   *\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformIntArray(name: string, value: number[]) {\r\n    this.setUniform('uniform1iv', name, value);\r\n  }\r\n\r\n  /**\r\n   * Set a boolean uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   *\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformBoolean(name: string, value: boolean) {\r\n    this.setUniform('uniform1i', name, value ? 1 : 0);\r\n  }\r\n\r\n  /**\r\n   * Set a float uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   *\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformFloat(name: string, value: number) {\r\n    this.setUniform('uniform1f', name, value);\r\n  }\r\n\r\n  /**\r\n   * Set a float array uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   *\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformFloatArray(name: string, value: number[]) {\r\n    this.setUniform('uniform1fv', name, value);\r\n  }\r\n\r\n  /**\r\n   * Set a [[Vector]] uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   *\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformFloatVector(name: string, value: Vector) {\r\n    this.setUniform('uniform2f', name, value.x, value.y);\r\n  }\r\n\r\n  /**\r\n   * Set an [[Matrix]] uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   *\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformMatrix(name: string, value: Matrix) {\r\n    this.setUniform('uniformMatrix4fv', name, false, value.data);\r\n  }\r\n\r\n  /**\r\n   * Set any available uniform type in webgl\r\n   *\r\n   * For example setUniform('uniformMatrix2fv', 'u_my2x2_mat`, ...);\r\n   */\r\n  setUniform<TUniformType extends UniformTypeNames>(uniformType: TUniformType, name: string, ...value: UniformParameters<TUniformType>) {\r\n    if (!this._compiled) {\r\n      throw Error(`Must compile shader before setting a uniform ${uniformType}:${name}`);\r\n    }\r\n    if (!this.isCurrentlyBound()) {\r\n      throw Error('Currently accessed shader instance is not the current active shader in WebGL,' +\r\n      ' must call `shader.use()` before setting uniforms');\r\n    }\r\n    const gl = this._gl;\r\n    const location = gl.getUniformLocation(this.program, name);\r\n    if (location) {\r\n      const args = [location, ...value];\r\n      this._gl[uniformType].apply(this._gl, args);\r\n    } else {\r\n      throw Error(`Uniform ${uniformType}:${name} doesn\\'t exist or is not used in the shader source code,`+\r\n      ' unused uniforms are optimized away by most browsers');\r\n    }\r\n  }\r\n\r\n  private _createProgram(gl: WebGLRenderingContext, vertexShader: WebGLShader, fragmentShader: WebGLShader): WebGLProgram {\r\n    const program = gl.createProgram();\r\n    if (program === null) {\r\n      throw Error('Could not create graphics shader program');\r\n    }\r\n\r\n    // attach the shaders.\r\n    gl.attachShader(program, vertexShader);\r\n    gl.attachShader(program, fragmentShader);\r\n\r\n    // link the program.\r\n    gl.linkProgram(program);\r\n\r\n    const success = gl.getProgramParameter(program, gl.LINK_STATUS);\r\n    if (!success) {\r\n      throw Error(`Could not link the program: [${gl.getProgramInfoLog(program)}]`);\r\n    }\r\n\r\n    return program;\r\n  }\r\n\r\n  private _compileShader(gl: WebGLRenderingContext, source: string, type: number): WebGLShader {\r\n    const typeName = gl.VERTEX_SHADER === type ? 'vertex' : 'fragment';\r\n    const shader = gl.createShader(type);\r\n    if (shader === null) {\r\n      throw Error(`Could not build shader: [${source}]`);\r\n    }\r\n\r\n    gl.shaderSource(shader, source);\r\n    gl.compileShader(shader);\r\n\r\n    const success = gl.getShaderParameter(shader, gl.COMPILE_STATUS);\r\n    if (!success) {\r\n      const errorInfo = gl.getShaderInfoLog(shader);\r\n      throw Error(`Could not compile ${typeName} shader:\\n\\n${errorInfo}${this._processSourceForError(source, errorInfo)}`);\r\n    }\r\n    return shader;\r\n  }\r\n\r\n  private _processSourceForError(source: string, errorInfo: string) {\r\n    const lines = source.split('\\n');\r\n    const errorLineStart = errorInfo.search(/\\d:\\d/);\r\n    const errorLineEnd = errorInfo.indexOf(' ', errorLineStart);\r\n    const [_, error2] = errorInfo.slice(errorLineStart, errorLineEnd).split(':').map(v => Number(v));\r\n    for (let i = 0; i < lines.length; i++) {\r\n      lines[i] = `${i+1}: ${lines[i]}${error2 === (i+1)? ' <----- ERROR!' : ''}`;\r\n    }\r\n\r\n    return '\\n\\nSource:\\n' + lines.join('\\n');\r\n  }\r\n}","import { ExcaliburWebGLContextAccessor } from './webgl-adapter';\r\n\r\nexport interface VertexBufferOptions {\r\n  /**\r\n   * Size in number of floats, so [4.2, 4.0, 2.1] is size = 3\r\n   *\r\n   * Ignored if data is passed directly\r\n   */\r\n  size?: number;\r\n  /**\r\n   * If the vertices never change switching 'static' can be more efficient on the gpu\r\n   *\r\n   * Default is 'dynamic'\r\n   */\r\n  type?: 'static' | 'dynamic';\r\n\r\n  /**\r\n   * Optionally pass pre-seeded data, size parameter is ignored\r\n   */\r\n  data?: Float32Array\r\n}\r\n\r\n/**\r\n * Helper around vertex buffer to simplify creating and uploading geometry\r\n *\r\n * Under the hood uses Float32Array\r\n */\r\nexport class VertexBuffer {\r\n  private _gl: WebGL2RenderingContext = ExcaliburWebGLContextAccessor.gl;\r\n\r\n  /**\r\n   * Access to the webgl buffer handle\r\n   */\r\n  public readonly buffer: WebGLBuffer;\r\n  /**\r\n   * Access to the raw data of the vertex buffer\r\n   */\r\n  public readonly bufferData: Float32Array;\r\n\r\n  /**\r\n   * If the vertices never change switching 'static' can be more efficient on the gpu\r\n   *\r\n   * Default is 'dynamic'\r\n   */\r\n  public type: 'static' | 'dynamic' = 'dynamic';\r\n\r\n  constructor(options: VertexBufferOptions) {\r\n    const { size, type, data } = options;\r\n    this.buffer = this._gl.createBuffer();\r\n    if (!data && !size) {\r\n      throw Error('Must either provide data or a size to the VertexBuffer');\r\n    }\r\n\r\n    if (!data) {\r\n      this.bufferData = new Float32Array(size);\r\n    } else {\r\n      this.bufferData = data;\r\n    }\r\n    this.type = type ?? this.type;\r\n    // Allocate buffer\r\n    const gl = this._gl;\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.buffer);\r\n    gl.bufferData(gl.ARRAY_BUFFER, this.bufferData, this.type === 'static' ? gl.STATIC_DRAW : gl.DYNAMIC_DRAW);\r\n  }\r\n\r\n  /**\r\n   * Bind this vertex buffer\r\n   */\r\n  bind() {\r\n    const gl = this._gl;\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.buffer);\r\n\r\n  }\r\n\r\n  /**\r\n   * Upload vertex buffer geometry to the GPU\r\n   */\r\n  upload(count?: number) {\r\n    const gl = this._gl;\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.buffer);\r\n    if (count) {\r\n      gl.bufferSubData(gl.ARRAY_BUFFER, 0, this.bufferData, 0, count);\r\n    } else {\r\n      // TODO always use bufferSubData? need to perf test it\r\n      gl.bufferData(gl.ARRAY_BUFFER, this.bufferData, this.type === 'static' ? gl.STATIC_DRAW : gl.DYNAMIC_DRAW);\r\n    }\r\n  }\r\n}","import { Logger } from '../..';\r\nimport { Shader, VertexAttributeDefinition } from './shader';\r\nimport { VertexBuffer } from './vertex-buffer';\r\nimport { ExcaliburWebGLContextAccessor } from './webgl-adapter';\r\nimport { getGlTypeSizeBytes } from './webgl-util';\r\n\r\n\r\nexport interface VertexLayoutOptions {\r\n  /**\r\n   * Shader that this layout will be for\r\n   */\r\n  shader: Shader;\r\n  /**\r\n   * Vertex buffer to use for vertex data\r\n   */\r\n  vertexBuffer: VertexBuffer,\r\n  /**\r\n   * Specify the attributes that will exist in the vertex buffer\r\n   *\r\n   * **Important** must specify them in the order that they will be in the vertex buffer!!\r\n   */\r\n  attributes: [name: string, numberOfComponents: number][]\r\n}\r\n\r\n/**\r\n * Helper around creating vertex attributes in a given [[VertexBuffer]], this is useful for describing\r\n * the memory layout for your vertices inside a particular buffer\r\n *\r\n * Note: This helper assumes interleaved attributes in one [[VertexBuffer]], not many.\r\n *\r\n * Working with `gl.vertexAttribPointer` can be tricky, and this attempts to double check you\r\n */\r\nexport class VertexLayout {\r\n  private _gl: WebGLRenderingContext = ExcaliburWebGLContextAccessor.gl;\r\n  private _logger = Logger.getInstance();\r\n  private _shader: Shader;\r\n  private _layout: VertexAttributeDefinition[] = [];\r\n  private _attributes: [name: string, numberOfComponents: number][] = [];\r\n  private _vertexBuffer: VertexBuffer;\r\n  public get vertexBuffer() {\r\n    return this._vertexBuffer;\r\n  }\r\n\r\n  public get attributes(): readonly [name: string, numberOfComponents: number][] {\r\n    return this._attributes;\r\n  }\r\n\r\n  constructor(options: VertexLayoutOptions) {\r\n    const {shader, vertexBuffer, attributes} = options;\r\n    this._vertexBuffer = vertexBuffer;\r\n    this._attributes = attributes;\r\n    this._shader = shader;\r\n    this.initialize();\r\n  }\r\n\r\n  private _vertexTotalSizeBytes = 0;\r\n  /**\r\n   * Total number of bytes that the vertex will take up\r\n   */\r\n  public get totalVertexSizeBytes(): number {\r\n    return this._vertexTotalSizeBytes;\r\n  }\r\n\r\n  /**\r\n   * Layouts need shader locations and must be bound to a shader\r\n   */\r\n  initialize() {\r\n    if (!this._shader.compiled) {\r\n      throw Error('Shader not compiled, shader must be compiled before defining a vertex layout');\r\n    }\r\n    this._layout.length = 0;\r\n    const shaderAttributes = this._shader.attributes;\r\n    for (const attribute of this._attributes) {\r\n      const attrib = shaderAttributes[attribute[0]];\r\n      if (!attrib) {\r\n        throw Error(`The attribute named: ${attribute[0]} size ${attribute[1]}`+\r\n        ` not found in the shader source code:\\n ${this._shader.vertexSource}`);\r\n      }\r\n      if (attrib.size !== attribute[1]) {\r\n        throw Error(`VertexLayout size definition for attribute: [${attribute[0]}, ${attribute[1]}],`\r\n        +` doesnt match shader source size ${attrib.size}:\\n ${this._shader.vertexSource}`);\r\n      }\r\n      this._layout.push(attrib);\r\n    }\r\n\r\n    // calc size\r\n    let componentsPerVertex = 0;\r\n    for (const vertAttribute of this._layout) {\r\n      const typeSize = getGlTypeSizeBytes(this._gl, vertAttribute.glType);\r\n      this._vertexTotalSizeBytes += typeSize * vertAttribute.size;\r\n      componentsPerVertex += vertAttribute.size;\r\n    }\r\n\r\n    if (this._vertexBuffer.bufferData.length % componentsPerVertex !== 0) {\r\n      this._logger.warn(`The vertex component size (${componentsPerVertex})  does divide evenly into the specified vertex buffer`\r\n      +` (${this._vertexBuffer.bufferData.length})`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Bind this layout with it's associated vertex buffer\r\n   *\r\n   * @param uploadBuffer Optionally indicate you wish to upload the buffer to the GPU associated with this layout\r\n   */\r\n  use(uploadBuffer = false, count?: number) {\r\n    const gl = this._gl;\r\n    if (!this._shader.isCurrentlyBound()) {\r\n      throw Error('Shader associated with this vertex layout is not active! Call shader.use() before layout.use()');\r\n    }\r\n    this._vertexBuffer.bind();\r\n    if (uploadBuffer) {\r\n      this._vertexBuffer.upload(count);\r\n    }\r\n    let offset = 0;\r\n    // TODO switch to VAOs if the extension is\r\n    for (const vert of this._layout) {\r\n      gl.vertexAttribPointer(vert.location, vert.size, vert.glType, vert.normalized, this.totalVertexSizeBytes, offset);\r\n      gl.enableVertexAttribArray(vert.location);\r\n      offset += getGlTypeSizeBytes(gl, vert.glType) * vert.size;\r\n    }\r\n  }\r\n}","export class GraphicsDiagnostics {\r\n  public static DrawCallCount: number = 0;\r\n  public static DrawnImagesCount: number = 0;\r\n  public static clear(): void {\r\n    GraphicsDiagnostics.DrawCallCount = 0;\r\n    GraphicsDiagnostics.DrawnImagesCount = 0;\r\n  }\r\n}\r\n","import { Vector } from '../../../Math/vector';\r\nimport { Color } from '../../../Color';\r\nimport lineVertexSource from './line-vertex.glsl';\r\nimport lineFragmentSource from './line-fragment.glsl';\r\nimport { ExcaliburGraphicsContextWebGL } from '../ExcaliburGraphicsContextWebGL';\r\nimport { RendererPlugin } from '../renderer';\r\nimport { Shader, VertexBuffer, VertexLayout } from '../..';\r\nimport { GraphicsDiagnostics } from '../../GraphicsDiagnostics';\r\n\r\nexport class LineRenderer implements RendererPlugin {\r\n  public readonly type = 'ex.line';\r\n  public priority: number = 0;\r\n  private _context: ExcaliburGraphicsContextWebGL;\r\n  private _gl: WebGLRenderingContext;\r\n  private _shader: Shader;\r\n  private _maxLines: number = 10922;\r\n  private _vertexBuffer: VertexBuffer;\r\n  private _layout: VertexLayout;\r\n  private _vertexIndex = 0;\r\n  private _lineCount = 0;\r\n  initialize(gl: WebGLRenderingContext, context: ExcaliburGraphicsContextWebGL): void {\r\n    this._gl = gl;\r\n    this._context = context;\r\n    this._shader = new Shader({\r\n      vertexSource: lineVertexSource,\r\n      fragmentSource: lineFragmentSource\r\n    });\r\n    this._shader.compile();\r\n    this._shader.use();\r\n\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    this._vertexBuffer = new VertexBuffer({\r\n      size: 6 * 2 * this._maxLines,\r\n      type: 'dynamic'\r\n    });\r\n\r\n    this._layout = new VertexLayout({\r\n      vertexBuffer: this._vertexBuffer,\r\n      shader: this._shader,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_color', 4]\r\n      ]\r\n    });\r\n  }\r\n\r\n  draw(start: Vector, end: Vector, color: Color): void {\r\n    // Force a render if the batch is full\r\n    if (this._isFull()) {\r\n      this.flush();\r\n    }\r\n\r\n    this._lineCount++;\r\n\r\n    const transform = this._context.getTransform();\r\n    const finalStart = transform.multiply(start);\r\n    const finalEnd = transform.multiply(end);\r\n\r\n\r\n    const vertexBuffer = this._vertexBuffer.bufferData;\r\n    // Start\r\n    vertexBuffer[this._vertexIndex++] = finalStart.x;\r\n    vertexBuffer[this._vertexIndex++] = finalStart.y;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n\r\n    // End\r\n    vertexBuffer[this._vertexIndex++] = finalEnd.x;\r\n    vertexBuffer[this._vertexIndex++] = finalEnd.y;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n  }\r\n\r\n  private _isFull() {\r\n    if (this._lineCount >= this._maxLines) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  hasPendingDraws(): boolean {\r\n    return this._lineCount !== 0;\r\n  }\r\n\r\n  flush(): void {\r\n    // nothing to draw early exit\r\n    if (this._lineCount === 0) {\r\n      return;\r\n    }\r\n\r\n    const gl = this._gl;\r\n    this._shader.use();\r\n    this._layout.use(true);\r\n\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    gl.drawArrays(gl.LINES, 0, this._lineCount * 2); // 2 verts per line\r\n\r\n    GraphicsDiagnostics.DrawnImagesCount += this._lineCount;\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n\r\n    // reset\r\n    this._vertexIndex = 0;\r\n    this._lineCount = 0;\r\n  }\r\n}\r\n","export default \"#version 300 es\\r\\nin vec2 a_position;\\r\\nin vec4 a_color;\\r\\n\\r\\nout lowp vec4 v_color;\\r\\n\\r\\nuniform mat4 u_matrix;\\r\\n\\r\\nvoid main() {\\r\\n   // Set the vertex position using the ortho transform matrix\\r\\n   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\\r\\n\\r\\n   // Passthrough the color\\r\\n   v_color = a_color;\\r\\n}\";","export default \"#version 300 es\\r\\nprecision mediump float;\\r\\n\\r\\n// Color\\r\\nin lowp vec4 v_color;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main() {\\r\\n  fragColor = v_color;\\r\\n}\";","import pointVertexSource from './point-vertex.glsl';\r\nimport pointFragmentSource from './point-fragment.glsl';\r\nimport { Vector } from '../../../Math/vector';\r\nimport { Color } from '../../../Color';\r\nimport { ExcaliburGraphicsContextWebGL, pixelSnapEpsilon } from '../ExcaliburGraphicsContextWebGL';\r\nimport { RendererPlugin } from '../renderer';\r\nimport { Shader } from '../shader';\r\nimport { VertexBuffer } from '../vertex-buffer';\r\nimport { VertexLayout } from '../vertex-layout';\r\nimport { GraphicsDiagnostics } from '../../GraphicsDiagnostics';\r\n\r\nexport class PointRenderer implements RendererPlugin {\r\n  public readonly type = 'ex.point';\r\n  public priority: number = 0;\r\n  private _shader: Shader;\r\n  private _maxPoints: number = 10922;\r\n  private _buffer: VertexBuffer;\r\n  private _layout: VertexLayout;\r\n  private _gl: WebGLRenderingContext;\r\n  private _context: ExcaliburGraphicsContextWebGL;\r\n  private _pointCount: number = 0;\r\n  private _vertexIndex: number = 0;\r\n  initialize(gl: WebGLRenderingContext, context: ExcaliburGraphicsContextWebGL): void {\r\n    this._gl = gl;\r\n    this._context = context;\r\n    this._shader = new Shader({\r\n      vertexSource: pointVertexSource,\r\n      fragmentSource: pointFragmentSource\r\n    });\r\n    this._shader.compile();\r\n    this._shader.use();\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n    this._buffer = new VertexBuffer({\r\n      size: 7 * this._maxPoints,\r\n      type: 'dynamic'\r\n    });\r\n\r\n    this._layout = new VertexLayout({\r\n      shader: this._shader,\r\n      vertexBuffer: this._buffer,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_color', 4],\r\n        ['a_size', 1]\r\n      ]\r\n    });\r\n  }\r\n\r\n  draw(point: Vector, color: Color, size: number): void {\r\n    // Force a render if the batch is full\r\n    if (this._isFull()) {\r\n      this.flush();\r\n    }\r\n\r\n    this._pointCount++;\r\n\r\n    const transform = this._context.getTransform();\r\n    const opacity = this._context.opacity;\r\n    const snapToPixel = this._context.snapToPixel;\r\n\r\n    const finalPoint = transform.multiply(point);\r\n\r\n    if (snapToPixel) {\r\n      finalPoint.x = ~~(finalPoint.x + pixelSnapEpsilon);\r\n      finalPoint.y = ~~(finalPoint.y + pixelSnapEpsilon);\r\n    }\r\n\r\n    const vertexBuffer = this._buffer.bufferData;\r\n    vertexBuffer[this._vertexIndex++] = finalPoint.x;\r\n    vertexBuffer[this._vertexIndex++] = finalPoint.y;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a * opacity;\r\n    vertexBuffer[this._vertexIndex++] = size * Math.max(transform.getScaleX(), transform.getScaleY());\r\n  }\r\n\r\n  private _isFull() {\r\n    if (this._pointCount >= this._maxPoints) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  hasPendingDraws(): boolean {\r\n    return this._pointCount !== 0;\r\n  }\r\n\r\n  flush(): void {\r\n    // nothing to draw early exit\r\n    if (this._pointCount === 0) {\r\n      return;\r\n    }\r\n\r\n    const gl = this._gl;\r\n    this._shader.use();\r\n    this._layout.use(true);\r\n\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    gl.drawArrays(gl.POINTS, 0, this._pointCount);\r\n\r\n    GraphicsDiagnostics.DrawnImagesCount += this._pointCount;\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n\r\n    this._pointCount = 0;\r\n    this._vertexIndex = 0;\r\n  }\r\n}\r\n","export default \"#version 300 es\\r\\nin vec2 a_position;\\r\\nin vec4 a_color;\\r\\nin float a_size;\\r\\nout lowp vec4 v_color;\\r\\nuniform mat4 u_matrix;\\r\\n\\r\\nvoid main() {\\r\\n  gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\\r\\n  gl_PointSize = a_size * 2.0;\\r\\n  v_color = a_color;\\r\\n}\";","export default \"#version 300 es\\r\\n\\r\\nprecision mediump float;\\r\\nin lowp vec4 v_color;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main() {\\r\\n  float r = 0.0, delta = 0.0, alpha = 1.0;\\r\\n  vec2 cxy = 2.0 * gl_PointCoord - 1.0;\\r\\n  r = dot(cxy, cxy);\\r\\n\\r\\n  delta = fwidth(r);\\r\\n  alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\\r\\n  // \\\"premultiply\\\" the color by alpha\\r\\n  vec4 color = v_color;\\r\\n  color.a = color.a * alpha;\\r\\n  color.rgb = color.rgb * color.a;\\r\\n  fragColor = color;\\r\\n}\";","\r\nimport screenVertex from './screen-vertex.glsl';\r\nimport screenFragment from './screen-fragment.glsl';\r\nimport { Shader } from '../shader';\r\nimport { VertexBuffer } from '../vertex-buffer';\r\nimport { VertexLayout } from '../vertex-layout';\r\nimport { PostProcessor } from '../../PostProcessor/PostProcessor';\r\n\r\n/**\r\n * This is responsible for painting the entire screen during the render passes\r\n */\r\nexport class ScreenPassPainter {\r\n  private _gl: WebGLRenderingContext;\r\n  private _shader: Shader;\r\n  private _buffer: VertexBuffer;\r\n  private _layout: VertexLayout;\r\n  constructor(gl: WebGLRenderingContext) {\r\n    this._gl = gl;\r\n    this._shader = new Shader({\r\n      vertexSource: screenVertex,\r\n      fragmentSource: screenFragment\r\n    });\r\n    this._shader.compile();\r\n    // Setup memory layout\r\n    this._buffer = new VertexBuffer({\r\n      type: 'static',\r\n      // clip space quad + uv since we don't need a camera\r\n      data: new Float32Array([\r\n        -1, -1,          0, 0,\r\n        -1, 1,           0, 1,\r\n        1, -1,           1, 0,\r\n\r\n        1, -1,            1, 0,\r\n        -1, 1,           0, 1,\r\n        1, 1,            1, 1\r\n      ])\r\n    });\r\n    this._layout = new VertexLayout({\r\n      shader: this._shader,\r\n      vertexBuffer: this._buffer,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_texcoord', 2]\r\n      ]\r\n    });\r\n    this._buffer.upload();\r\n  }\r\n\r\n  renderWithPostProcessor(postprocessor: PostProcessor): void {\r\n    const gl = this._gl;\r\n    postprocessor.getShader().use();\r\n    postprocessor.getLayout().use();\r\n    gl.drawArrays(gl.TRIANGLES, 0, 6);\r\n  }\r\n\r\n  renderToScreen(): void {\r\n    const gl = this._gl;\r\n    this._shader.use();\r\n    this._layout.use();\r\n    gl.drawArrays(gl.TRIANGLES, 0, 6);\r\n  }\r\n}","export default \"#version 300 es\\r\\nin vec2 a_position;\\r\\n\\r\\nin vec2 a_texcoord;\\r\\nout vec2 v_texcoord;\\r\\n\\r\\nvoid main() {\\r\\n  gl_Position = vec4(a_position, 0.0, 1.0);\\r\\n\\r\\n  // Pass the texcoord to the fragment shader.\\r\\n  v_texcoord = a_texcoord;\\r\\n}\";","export default \"#version 300 es\\r\\nprecision mediump float;\\r\\n\\r\\n// Passed in from the vertex shader.\\r\\nin vec2 v_texcoord;\\r\\n\\r\\n// The texture.\\r\\nuniform sampler2D u_texture;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main() {\\r\\n   fragColor = texture(u_texture, v_texcoord);\\r\\n}\";","import { Logger } from '../..';\r\nimport { ExcaliburWebGLContextAccessor } from './webgl-adapter';\r\n\r\n/**\r\n * Helper that defines and index buffer for quad geometry\r\n *\r\n * Index buffers allow you to save space in vertex buffers when you share vertices in geometry\r\n * it is almost always worth it in terms of performance to use an index buffer.\r\n */\r\nexport class QuadIndexBuffer {\r\n  private _gl: WebGL2RenderingContext = ExcaliburWebGLContextAccessor.gl;\r\n  private _logger: Logger = Logger.getInstance();\r\n  /**\r\n   * Access to the webgl buffer handle\r\n   */\r\n  public buffer: WebGLBuffer;\r\n  /**\r\n   * Access to the raw data of the index buffer\r\n   */\r\n  public bufferData: Uint16Array | Uint32Array;\r\n  /**\r\n   * Depending on the browser this is either gl.UNSIGNED_SHORT or gl.UNSIGNED_INT\r\n   */\r\n  public bufferGlType: number;\r\n\r\n  /**\r\n   * @param numberOfQuads Specify the max number of quads you want to draw\r\n   * @param useUint16 Optionally force a uint16 buffer\r\n   */\r\n  constructor(numberOfQuads: number, useUint16?: boolean) {\r\n    const gl = this._gl;\r\n    this.buffer = gl.createBuffer();\r\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.buffer);\r\n\r\n    const totalVertices = numberOfQuads * 6;\r\n\r\n    if (!useUint16) {\r\n      this.bufferData = new Uint32Array(totalVertices);\r\n    } else {\r\n      // fall back to using gl.UNSIGNED_SHORT or tell the user they are out of luck\r\n      const maxUint16 = 65_535;\r\n      const maxUint16Index = Math.floor((maxUint16 - 1) / 4); // max quads\r\n\r\n      this.bufferGlType = gl.UNSIGNED_SHORT;\r\n      this.bufferData = new Uint16Array(totalVertices);\r\n      // TODO Should we error if this happens?? maybe not might crash mid game\r\n      if (numberOfQuads > maxUint16Index) {\r\n        this._logger.warn(\r\n          `Total quads exceeds hardware index buffer limit (uint16), max(${maxUint16Index}) requested quads(${numberOfQuads})`);\r\n      }\r\n    }\r\n\r\n\r\n    let currentQuad = 0;\r\n    for (let i = 0; i < totalVertices; i += 6) {\r\n      // first triangle\r\n      this.bufferData[i + 0] = currentQuad + 0;\r\n      this.bufferData[i + 1] = currentQuad + 1;\r\n      this.bufferData[i + 2] = currentQuad + 2;\r\n      // second triangle\r\n      this.bufferData[i + 3] = currentQuad + 2;\r\n      this.bufferData[i + 4] = currentQuad + 1;\r\n      this.bufferData[i + 5] = currentQuad + 3;\r\n      currentQuad += 4;\r\n    }\r\n    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, this.bufferData, gl.STATIC_DRAW);\r\n  }\r\n\r\n  public get size() {\r\n    return this.bufferData.length;\r\n  }\r\n\r\n  /**\r\n   * Upload data to the GPU\r\n   */\r\n  public upload() {\r\n    const gl = this._gl;\r\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.buffer);\r\n    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, this.bufferData, gl.STATIC_DRAW);\r\n  }\r\n\r\n  /**\r\n   * Bind this index buffer\r\n   */\r\n  public bind() {\r\n    const gl = this._gl;\r\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.buffer);\r\n  }\r\n}","import { vec } from '../../../Math/vector';\r\nimport { GraphicsDiagnostics } from '../../GraphicsDiagnostics';\r\nimport { HTMLImageSource } from '../ExcaliburGraphicsContext';\r\nimport { ExcaliburGraphicsContextWebGL, pixelSnapEpsilon } from '../ExcaliburGraphicsContextWebGL';\r\nimport { QuadIndexBuffer } from '../quad-index-buffer';\r\nimport { RendererPlugin } from '../renderer';\r\nimport { Shader } from '../shader';\r\nimport { TextureLoader } from '../texture-loader';\r\nimport { VertexBuffer } from '../vertex-buffer';\r\nimport { VertexLayout } from '../vertex-layout';\r\nimport frag from './image-renderer.frag.glsl';\r\nimport vert from './image-renderer.vert.glsl';\r\n\r\nexport class ImageRenderer implements RendererPlugin {\r\n  public readonly type = 'ex.image';\r\n  public priority: number = 0;\r\n\r\n  private _maxImages: number = 10922; // max(uint16) / 6 verts\r\n  private _maxTextures: number = 0;\r\n\r\n  private _context: ExcaliburGraphicsContextWebGL;\r\n  private _gl: WebGLRenderingContext;\r\n  private _shader: Shader;\r\n  private _buffer: VertexBuffer;\r\n  private _layout: VertexLayout;\r\n  private _quads: QuadIndexBuffer;\r\n\r\n  // Per flush vars\r\n  private _imageCount: number = 0;\r\n  private _textures: WebGLTexture[] = [];\r\n  private _vertexIndex: number = 0;\r\n\r\n  initialize(gl: WebGLRenderingContext, context: ExcaliburGraphicsContextWebGL): void {\r\n    this._gl = gl;\r\n    this._context = context;\r\n    // Transform shader source\r\n    // FIXME: PIXEL 6 complains `ERROR: Expression too complex.` if we use it's reported max texture units, 125 seems to work for now...\r\n    this._maxTextures = Math.min(gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS), 125);\r\n    const transformedFrag = this._transformFragmentSource(frag, this._maxTextures);\r\n    // Compile shader\r\n    this._shader = new Shader({\r\n      fragmentSource: transformedFrag,\r\n      vertexSource: vert\r\n    });\r\n    this._shader.compile();\r\n\r\n    // setup uniforms\r\n    this._shader.use();\r\n    this._shader.setUniformMatrix('u_matrix', context.ortho);\r\n    // Initialize texture slots to [0, 1, 2, 3, 4, .... maxGPUTextures]\r\n    this._shader.setUniformIntArray(\r\n      'u_textures',\r\n      [...Array(this._maxTextures)].map((_, i) => i)\r\n    );\r\n\r\n    // Setup memory layout\r\n    this._buffer = new VertexBuffer({\r\n      size: 10 * 4 * this._maxImages, // 10 components * 4 verts\r\n      type: 'dynamic'\r\n    });\r\n    this._layout = new VertexLayout({\r\n      shader: this._shader,\r\n      vertexBuffer: this._buffer,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_opacity', 1],\r\n        ['a_texcoord', 2],\r\n        ['a_textureIndex', 1],\r\n        ['a_tint', 4]\r\n      ]\r\n    });\r\n\r\n    // Setup index buffer\r\n    this._quads = new QuadIndexBuffer(this._maxImages, true);\r\n  }\r\n\r\n  private _transformFragmentSource(source: string, maxTextures: number): string {\r\n    let newSource = source.replace('%%count%%', maxTextures.toString());\r\n    let texturePickerBuilder = '';\r\n    for (let i = 0; i < maxTextures; i++) {\r\n      if (i === 0) {\r\n        texturePickerBuilder += `if (v_textureIndex <= ${i}.5) {\\n`;\r\n      } else {\r\n        texturePickerBuilder += `   else if (v_textureIndex <= ${i}.5) {\\n`;\r\n      }\r\n      texturePickerBuilder += `      color = texture(u_textures[${i}], v_texcoord);\\n`;\r\n      texturePickerBuilder += `   }\\n`;\r\n    }\r\n    newSource = newSource.replace('%%texture_picker%%', texturePickerBuilder);\r\n    return newSource;\r\n  }\r\n\r\n  private _addImageAsTexture(image: HTMLImageSource) {\r\n    const texture = TextureLoader.load(image);\r\n    if (this._textures.indexOf(texture) === -1) {\r\n      this._textures.push(texture);\r\n    }\r\n  }\r\n\r\n  private _bindTextures(gl: WebGLRenderingContext) {\r\n    // Bind textures in the correct order\r\n    for (let i = 0; i < this._maxTextures; i++) {\r\n      gl.activeTexture(gl.TEXTURE0 + i);\r\n      gl.bindTexture(gl.TEXTURE_2D, this._textures[i] || this._textures[0]);\r\n    }\r\n  }\r\n\r\n  private _getTextureIdForImage(image: HTMLImageSource) {\r\n    if (image) {\r\n      return this._textures.indexOf(TextureLoader.get(image));\r\n    }\r\n    return -1;\r\n  }\r\n\r\n  private _isFull() {\r\n    if (this._imageCount >= this._maxImages) {\r\n      return true;\r\n    }\r\n    if (this._textures.length >= this._maxTextures) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n\r\n  draw(image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number): void {\r\n\r\n    // Force a render if the batch is full\r\n    if (this._isFull()) {\r\n      this.flush();\r\n    }\r\n\r\n    this._imageCount++;\r\n    this._addImageAsTexture(image);\r\n\r\n    let width = image?.width || swidth || 0;\r\n    let height = image?.height || sheight || 0;\r\n    let view = [0, 0, swidth ?? image?.width ?? 0, sheight ?? image?.height ?? 0];\r\n    let dest = [sx ?? 1, sy ?? 1];\r\n    // If destination is specified, update view and dest\r\n    if (dx !== undefined && dy !== undefined && dwidth !== undefined && dheight !== undefined) {\r\n      view = [sx ?? 1, sy ?? 1, swidth ?? image?.width ?? 0, sheight ?? image?.height ?? 0];\r\n      dest = [dx, dy];\r\n      width = dwidth;\r\n      height = dheight;\r\n    }\r\n\r\n    sx = view[0];\r\n    sy = view[1];\r\n    const sw = view[2];\r\n    const sh = view[3];\r\n\r\n    // transform based on current context\r\n    const transform = this._context.getTransform();\r\n    const opacity = this._context.opacity;\r\n    const snapToPixel = this._context.snapToPixel;\r\n\r\n    let topLeft = vec(dest[0], dest[1]);\r\n    let topRight = vec(dest[0] + width, dest[1]);\r\n    let bottomLeft = vec(dest[0], dest[1] + height);\r\n    let bottomRight = vec(dest[0] + width, dest[1] + height);\r\n\r\n    topLeft = transform.multiply(topLeft);\r\n    topRight = transform.multiply(topRight);\r\n    bottomLeft = transform.multiply(bottomLeft);\r\n    bottomRight = transform.multiply(bottomRight);\r\n\r\n    if (snapToPixel) {\r\n      topLeft.x = ~~(topLeft.x + pixelSnapEpsilon);\r\n      topLeft.y = ~~(topLeft.y + pixelSnapEpsilon);\r\n\r\n      topRight.x = ~~(topRight.x + pixelSnapEpsilon);\r\n      topRight.y = ~~(topRight.y + pixelSnapEpsilon);\r\n\r\n      bottomLeft.x = ~~(bottomLeft.x + pixelSnapEpsilon);\r\n      bottomLeft.y = ~~(bottomLeft.y + pixelSnapEpsilon);\r\n\r\n      bottomRight.x = ~~(bottomRight.x + pixelSnapEpsilon);\r\n      bottomRight.y = ~~(bottomRight.y + pixelSnapEpsilon);\r\n    }\r\n\r\n    const tint = this._context.tint;\r\n\r\n    const textureId = this._getTextureIdForImage(image);\r\n    const imageWidth = image.width || width;\r\n    const imageHeight = image.height || height;\r\n\r\n    const uvx0 = (sx) / imageWidth;\r\n    const uvy0 = (sy) / imageHeight;\r\n    const uvx1 = (sx + sw - 0.01) / imageWidth;\r\n    const uvy1 = (sy + sh - 0.01) / imageHeight;\r\n\r\n    // update data\r\n    const vertexBuffer = this._layout.vertexBuffer.bufferData;\r\n\r\n    // (0, 0) - 0\r\n    vertexBuffer[this._vertexIndex++] = topLeft.x;\r\n    vertexBuffer[this._vertexIndex++] = topLeft.y;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = textureId;\r\n    vertexBuffer[this._vertexIndex++] = tint.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.a;\r\n\r\n    // (0, 1) - 1\r\n    vertexBuffer[this._vertexIndex++] = bottomLeft.x;\r\n    vertexBuffer[this._vertexIndex++] = bottomLeft.y;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = textureId;\r\n    vertexBuffer[this._vertexIndex++] = tint.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.a;\r\n\r\n    // (1, 0) - 2\r\n    vertexBuffer[this._vertexIndex++] = topRight.x;\r\n    vertexBuffer[this._vertexIndex++] = topRight.y;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = textureId;\r\n    vertexBuffer[this._vertexIndex++] = tint.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.a;\r\n\r\n    // (1, 1) - 3\r\n    vertexBuffer[this._vertexIndex++] = bottomRight.x;\r\n    vertexBuffer[this._vertexIndex++] = bottomRight.y;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = textureId;\r\n    vertexBuffer[this._vertexIndex++] = tint.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.a;\r\n  }\r\n\r\n  hasPendingDraws(): boolean {\r\n    return this._imageCount !== 0;\r\n  }\r\n\r\n  flush(): void {\r\n    // nothing to draw early exit\r\n    if (this._imageCount === 0) {\r\n      return;\r\n    }\r\n\r\n    const gl = this._gl;\r\n    // Bind the shader\r\n    this._shader.use();\r\n\r\n    // Bind the memory layout and upload data\r\n    this._layout.use(true, 4 * 10 * this._imageCount);\r\n\r\n    // Update ortho matrix uniform\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    // Bind textures to\r\n    this._bindTextures(gl);\r\n\r\n    // Bind index buffer\r\n    this._quads.bind();\r\n\r\n    // Draw all the quads\r\n    gl.drawElements(gl.TRIANGLES, this._imageCount * 6, this._quads.bufferGlType, 0);\r\n\r\n    GraphicsDiagnostics.DrawnImagesCount += this._imageCount;\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n\r\n    // Reset\r\n    this._imageCount = 0;\r\n    this._vertexIndex = 0;\r\n    this._textures.length = 0;\r\n  }\r\n}","export default \"#version 300 es\\r\\nprecision mediump float;\\r\\n\\r\\n// UV coord\\r\\nin vec2 v_texcoord;\\r\\n\\r\\n// Texture index\\r\\nin lowp float v_textureIndex;\\r\\n\\r\\n// Textures in the current draw\\r\\nuniform sampler2D u_textures[%%count%%];\\r\\n\\r\\n// Opacity\\r\\nin float v_opacity;\\r\\n\\r\\nin vec4 v_tint;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main() {\\r\\n   // In order to support the most efficient sprite batching, we have multiple\\r\\n   // textures loaded into the gpu (usually 8) this picker logic skips over textures\\r\\n   // that do not apply to a particular sprite.\\r\\n\\r\\n   vec4 color = vec4(1.0, 0, 0, 1.0);\\r\\n\\r\\n   // GLSL is templated out to pick the right texture and set the vec4 color\\r\\n   %%texture_picker%%\\r\\n\\r\\n   color.rgb = color.rgb * v_opacity;\\r\\n   color.a = color.a * v_opacity;\\r\\n   fragColor = color * v_tint;\\r\\n}\";","export default \"#version 300 es\\r\\nin vec2 a_position;\\r\\n\\r\\n// Opacity \\r\\nin float a_opacity;\\r\\nout float v_opacity;\\r\\n\\r\\n// UV coordinate\\r\\nin vec2 a_texcoord;\\r\\nout vec2 v_texcoord;\\r\\n\\r\\n// Texture number\\r\\nin lowp float a_textureIndex;\\r\\nout lowp float v_textureIndex;\\r\\n\\r\\nin vec4 a_tint;\\r\\nout vec4 v_tint;\\r\\n\\r\\nuniform mat4 u_matrix;\\r\\n\\r\\nvoid main() {\\r\\n   // Set the vertex position using the ortho transform matrix\\r\\n   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\\r\\n\\r\\n   // Pass through the Opacity to the fragment shader\\r\\n   v_opacity = a_opacity;\\r\\n   // Pass through the UV coord to the fragment shader\\r\\n   v_texcoord = a_texcoord;\\r\\n   // Pass through the texture number to the fragment shader\\r\\n   v_textureIndex = a_textureIndex;\\r\\n   // Pass through the tint\\r\\n   v_tint = a_tint;\\r\\n}\";","import { Color } from '../../../Color';\r\nimport { vec, Vector } from '../../../Math/vector';\r\nimport { GraphicsDiagnostics } from '../../GraphicsDiagnostics';\r\nimport { ExcaliburGraphicsContextWebGL, pixelSnapEpsilon } from '../ExcaliburGraphicsContextWebGL';\r\nimport { QuadIndexBuffer } from '../quad-index-buffer';\r\nimport { RendererPlugin } from '../renderer';\r\nimport { Shader } from '../shader';\r\nimport { VertexBuffer } from '../vertex-buffer';\r\nimport { VertexLayout } from '../vertex-layout';\r\n\r\nimport frag from './rectangle-renderer.frag.glsl';\r\nimport vert from './rectangle-renderer.vert.glsl';\r\n\r\nexport class RectangleRenderer implements RendererPlugin {\r\n  public readonly type = 'ex.rectangle';\r\n  public priority: number = 0;\r\n\r\n  private _maxRectangles: number = 10922; // max(uint16) / 6 verts\r\n\r\n  private _shader: Shader;\r\n  private _gl: WebGLRenderingContext;\r\n  private _context: ExcaliburGraphicsContextWebGL;\r\n  private _buffer: VertexBuffer;\r\n  private _layout: VertexLayout;\r\n  private _quads: QuadIndexBuffer;\r\n  private _rectangleCount: number = 0;\r\n  private _vertexIndex: number = 0;\r\n\r\n\r\n  initialize(gl: WebGLRenderingContext, context: ExcaliburGraphicsContextWebGL): void {\r\n    this._gl = gl;\r\n    this._context = context;\r\n    // https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\r\n    this._shader = new Shader({\r\n      fragmentSource: frag,\r\n      vertexSource: vert\r\n    });\r\n    this._shader.compile();\r\n\r\n    // setup uniforms\r\n    this._shader.use();\r\n    this._shader.setUniformMatrix('u_matrix', context.ortho);\r\n\r\n    this._buffer = new VertexBuffer({\r\n      size: 16 * 4 * this._maxRectangles,\r\n      type: 'dynamic'\r\n    });\r\n\r\n    this._layout = new VertexLayout({\r\n      shader: this._shader,\r\n      vertexBuffer: this._buffer,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_uv', 2],\r\n        ['a_size', 2],\r\n        ['a_opacity', 1],\r\n        ['a_color', 4],\r\n        ['a_strokeColor', 4],\r\n        ['a_strokeThickness', 1]\r\n      ]\r\n    });\r\n    this._quads = new QuadIndexBuffer(this._maxRectangles, true);\r\n  }\r\n\r\n  private _isFull() {\r\n    if (this._rectangleCount >= this._maxRectangles) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  draw(...args: any[]): void {\r\n    if (args[0] instanceof Vector && args[1] instanceof Vector) {\r\n      this.drawLine.apply(this, args);\r\n    } else {\r\n      this.drawRectangle.apply(this, args);\r\n    }\r\n  }\r\n\r\n  drawLine(start: Vector, end: Vector, color: Color, thickness: number = 1) {\r\n\r\n    if (this._isFull()) {\r\n      this.flush();\r\n    }\r\n    this._rectangleCount++;\r\n\r\n    // transform based on current context\r\n    const transform = this._context.getTransform();\r\n    const opacity = this._context.opacity;\r\n    const snapToPixel = this._context.snapToPixel;\r\n\r\n    const dir = end.sub(start);\r\n    const length = dir.size;\r\n    const normal = dir.normalize().perpendicular();\r\n    const halfThick = thickness / 2;\r\n\r\n    /**\r\n     *    +---------------------^----------------------+\r\n     *    |                     | (normal)             |\r\n     *   (startx, starty)------------------>(endx, endy)\r\n     *    |                                            |\r\n     *    + -------------------------------------------+\r\n     */\r\n    const startTop = transform.multiply(normal.scale(halfThick).add(start));\r\n    const startBottom = transform.multiply(normal.scale(-halfThick).add(start));\r\n    const endTop = transform.multiply(normal.scale(halfThick).add(end));\r\n    const endBottom = transform.multiply(normal.scale(-halfThick).add(end));\r\n\r\n    if (snapToPixel) {\r\n      startTop.x = ~~(startTop.x + pixelSnapEpsilon);\r\n      startTop.y = ~~(startTop.y + pixelSnapEpsilon);\r\n\r\n      endTop.x = ~~(endTop.x + pixelSnapEpsilon);\r\n      endTop.y = ~~(endTop.y + pixelSnapEpsilon);\r\n\r\n      startBottom.x = ~~(startBottom.x + pixelSnapEpsilon);\r\n      startBottom.y = ~~(startBottom.y + pixelSnapEpsilon);\r\n\r\n      endBottom.x = ~~(endBottom.x + pixelSnapEpsilon);\r\n      endBottom.y = ~~(endBottom.y + pixelSnapEpsilon);\r\n    }\r\n\r\n    // TODO uv could be static vertex buffer\r\n    const uvx0 = 0;\r\n    const uvy0 = 0;\r\n    const uvx1 = 1;\r\n    const uvy1 = 1;\r\n\r\n    const stroke = Color.Transparent;\r\n    const strokeThickness = 0;\r\n    const width = 1;\r\n\r\n    // update data\r\n    const vertexBuffer = this._layout.vertexBuffer.bufferData;\r\n\r\n    // (0, 0) - 0\r\n    vertexBuffer[this._vertexIndex++] = startTop.x;\r\n    vertexBuffer[this._vertexIndex++] = startTop.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = length;\r\n    vertexBuffer[this._vertexIndex++] = thickness;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / width;\r\n\r\n    // (0, 1) - 1\r\n    vertexBuffer[this._vertexIndex++] = startBottom.x;\r\n    vertexBuffer[this._vertexIndex++] = startBottom.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = length;\r\n    vertexBuffer[this._vertexIndex++] = thickness;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / width;\r\n\r\n    // (1, 0) - 2\r\n    vertexBuffer[this._vertexIndex++] = endTop.x;\r\n    vertexBuffer[this._vertexIndex++] = endTop.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = length;\r\n    vertexBuffer[this._vertexIndex++] = thickness;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / width;\r\n\r\n    // (1, 1) - 3\r\n    vertexBuffer[this._vertexIndex++] = endBottom.x;\r\n    vertexBuffer[this._vertexIndex++] = endBottom.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = length;\r\n    vertexBuffer[this._vertexIndex++] = thickness;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / width;\r\n  }\r\n\r\n  drawRectangle(\r\n    pos: Vector,\r\n    width: number,\r\n    height: number,\r\n    color: Color,\r\n    stroke: Color = Color.Transparent,\r\n    strokeThickness: number = 0): void {\r\n    if (this._isFull()) {\r\n      this.flush();\r\n    }\r\n    this._rectangleCount++;\r\n\r\n    // transform based on current context\r\n    const transform = this._context.getTransform();\r\n    const opacity = this._context.opacity;\r\n    const snapToPixel = this._context.snapToPixel;\r\n\r\n    const topLeft = transform.multiply(pos.add(vec(0, 0)));\r\n    const topRight = transform.multiply(pos.add(vec(width, 0)));\r\n    const bottomRight = transform.multiply(pos.add(vec(width, height)));\r\n    const bottomLeft = transform.multiply(pos.add(vec(0, height)));\r\n\r\n    if (snapToPixel) {\r\n      topLeft.x = ~~(topLeft.x + pixelSnapEpsilon);\r\n      topLeft.y = ~~(topLeft.y + pixelSnapEpsilon);\r\n\r\n      topRight.x = ~~(topRight.x + pixelSnapEpsilon);\r\n      topRight.y = ~~(topRight.y + pixelSnapEpsilon);\r\n\r\n      bottomLeft.x = ~~(bottomLeft.x + pixelSnapEpsilon);\r\n      bottomLeft.y = ~~(bottomLeft.y + pixelSnapEpsilon);\r\n\r\n      bottomRight.x = ~~(bottomRight.x + pixelSnapEpsilon);\r\n      bottomRight.y = ~~(bottomRight.y + pixelSnapEpsilon);\r\n    }\r\n\r\n    // TODO uv could be static vertex buffer\r\n    const uvx0 = 0;\r\n    const uvy0 = 0;\r\n    const uvx1 = 1;\r\n    const uvy1 = 1;\r\n\r\n    // update data\r\n    const vertexBuffer = this._layout.vertexBuffer.bufferData;\r\n\r\n    // (0, 0) - 0\r\n    vertexBuffer[this._vertexIndex++] = topLeft.x;\r\n    vertexBuffer[this._vertexIndex++] = topLeft.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = width;\r\n    vertexBuffer[this._vertexIndex++] = height;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness;\r\n\r\n    // (0, 1) - 1\r\n    vertexBuffer[this._vertexIndex++] = bottomLeft.x;\r\n    vertexBuffer[this._vertexIndex++] = bottomLeft.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = width;\r\n    vertexBuffer[this._vertexIndex++] = height;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness;\r\n\r\n    // (1, 0) - 2\r\n    vertexBuffer[this._vertexIndex++] = topRight.x;\r\n    vertexBuffer[this._vertexIndex++] = topRight.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = width;\r\n    vertexBuffer[this._vertexIndex++] = height;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness;\r\n\r\n    // (1, 1) - 3\r\n    vertexBuffer[this._vertexIndex++] = bottomRight.x;\r\n    vertexBuffer[this._vertexIndex++] = bottomRight.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = width;\r\n    vertexBuffer[this._vertexIndex++] = height;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness;\r\n\r\n  }\r\n\r\n  hasPendingDraws(): boolean {\r\n    return this._rectangleCount !== 0;\r\n  }\r\n\r\n  flush(): void {\r\n    // nothing to draw early exit\r\n    if (this._rectangleCount === 0) {\r\n      return;\r\n    }\r\n\r\n    const gl = this._gl;\r\n    // Bind the shader\r\n    this._shader.use();\r\n\r\n    // Bind the memory layout and upload data\r\n    this._layout.use(true);\r\n\r\n    // Update ortho matrix uniform\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    // Bind index buffer\r\n    this._quads.bind();\r\n\r\n    // Draw all the quads\r\n    gl.drawElements(gl.TRIANGLES, this._rectangleCount * 6, this._quads.bufferGlType, 0);\r\n\r\n    GraphicsDiagnostics.DrawnImagesCount += this._rectangleCount;\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n\r\n    // Reset\r\n    this._rectangleCount = 0;\r\n    this._vertexIndex = 0;\r\n  }\r\n\r\n}","export default \"#version 300 es\\r\\n\\r\\nprecision mediump float;\\r\\n\\r\\n// UV coord\\r\\nin vec2 v_uv;\\r\\n\\r\\nin vec2 v_size; // in pixels\\r\\n\\r\\n// Color coord to blend with image\\r\\nin lowp vec4 v_color;\\r\\n\\r\\n// Stroke color if used\\r\\nin lowp vec4 v_strokeColor;\\r\\n\\r\\n// Stroke thickness if used\\r\\nin lowp float v_strokeThickness; // in pixels\\r\\n\\r\\n// Opacity\\r\\nin float v_opacity;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main() {\\r\\n    // modified from https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\\r\\n    vec2 uv = v_uv;\\r\\n    vec2 fragCoord = uv * v_size;\\r\\n    float maxX = v_size.x - v_strokeThickness;\\r\\n    float minX = v_strokeThickness;\\r\\n    float maxY = v_size.y - v_strokeThickness;\\r\\n    float minY = v_strokeThickness;\\r\\n\\r\\n    if (fragCoord.x < maxX && fragCoord.x > minX &&\\r\\n        fragCoord.y < maxY && fragCoord.y > minY) {\\r\\n      fragColor = v_color;\\r\\n    } else {\\r\\n      fragColor = v_strokeColor;\\r\\n    }\\r\\n    fragColor.a *= v_opacity;\\r\\n    fragColor.rgb *= fragColor.a;\\r\\n\\r\\n    // vec2 v2CenteredPos     = abs(fragCoord - v_size.xy / 2.0);\\r\\n    // vec2 v2HalfShapeSizePx = v_size.xy/2.0 - v_strokeThickness/2.0;\\r\\n\\r\\n    // float fHalfBorderDist      = 0.0;\\r\\n    // float fHalfBorderThickness = 0.0;\\r\\n\\r\\n    // if (fragCoord.x > max(v_radius, v_strokeThickness) && \\r\\n    //     fragCoord.x < v_size.x - max(v_radius, v_strokeThickness))\\r\\n    // {\\r\\n    //     fHalfBorderDist      = v2CenteredPos.y - v2HalfShapeSizePx.y;\\r\\n    //     fHalfBorderThickness = v_strokeThickness / 2.0;\\r\\n    // }\\r\\n    // else if (fragCoord.y > max(v_radius, v_strokeThickness) && \\r\\n    //          fragCoord.y < v_size.y - max(v_radius, v_strokeThickness))\\r\\n    // {\\r\\n    //     fHalfBorderDist      = v2CenteredPos.x - v2HalfShapeSizePx.x;\\r\\n    //     fHalfBorderThickness = v_strokeThickness / 2.0;\\r\\n    // }\\r\\n    // else\\r\\n    // {\\r\\n    //     vec2 edgeVec = max(vec2(0.0), v_radius - vec2(\\r\\n    //         uv.x > 0.5 ? v_size.x - fragCoord.x : fragCoord.x,\\r\\n    //         uv.y > 0.5 ? v_size.y - fragCoord.y : fragCoord.y));\\r\\n        \\r\\n    //     float ellipse_ab    = v_radius-v_strokeThickness;\\r\\n    //     vec2 ellipse_isect = (v_strokeThickness > v_radius || v_strokeThickness > v_radius) ? vec2(0.0) :\\r\\n    //                             edgeVec.xy * ellipse_ab*ellipse_ab / length(ellipse_ab*edgeVec.yx); \\r\\n            \\r\\n    //     fHalfBorderThickness = (v_radius - length(ellipse_isect)) / 2.0;\\r\\n    //     fHalfBorderDist      = length(edgeVec) - (v_radius - fHalfBorderThickness);\\r\\n    // }\\r\\n\\r\\n    // vec4 v4FromColor = v_strokeColor;\\r\\n    // v4FromColor.rgb *= v4FromColor.a;\\r\\n    // vec4 v4ToColor   = vec4(0.0); // background color is transparent\\r\\n    // if (fHalfBorderDist < 0.0) {\\r\\n    //     v4ToColor = v_color;\\r\\n    //     v4ToColor.rgb *= v4ToColor.a;\\r\\n    // }\\r\\n\\r\\n    // float mixPct = abs(fHalfBorderDist) - fHalfBorderThickness;\\r\\n\\r\\n    // vec4 finalColor = mix(v4FromColor, v4ToColor, mixPct);\\r\\n    // gl_FragColor = finalColor;\\r\\n}\";","export default \"#version 300 es\\r\\nin vec2 a_position;\\r\\n\\r\\n// UV coordinate\\r\\nin vec2 a_uv;\\r\\nout vec2 v_uv;\\r\\n\\r\\nin vec2 a_size;\\r\\nout vec2 v_size;\\r\\n\\r\\n// Opacity \\r\\nin float a_opacity;\\r\\nout float v_opacity;\\r\\n\\r\\nin vec4 a_color;\\r\\nout vec4 v_color;\\r\\n\\r\\nin vec4 a_strokeColor;\\r\\nout vec4 v_strokeColor;\\r\\n\\r\\nin float a_strokeThickness;\\r\\nout float v_strokeThickness;\\r\\n\\r\\nuniform mat4 u_matrix;\\r\\n\\r\\n\\r\\nvoid main() {\\r\\n   // Set the vertex position using the ortho transform matrix\\r\\n   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\\r\\n\\r\\n   // Pass through UV coords\\r\\n   v_uv = a_uv;\\r\\n   // Pass through size\\r\\n   v_size = a_size;\\r\\n   // Pass through the Opacity to the fragment shader\\r\\n   v_opacity = a_opacity;\\r\\n   // Pass through the color to the fragment shader\\r\\n   v_color = a_color;\\r\\n   // Pass through the stroke color to the fragment shader\\r\\n   v_strokeColor = a_strokeColor;\\r\\n   // Pass through the stroke thickenss to the fragment shader\\r\\n   v_strokeThickness = a_strokeThickness;\\r\\n}\";","import { Color } from '../../../Color';\r\nimport { vec, Vector } from '../../../Math/vector';\r\nimport { GraphicsDiagnostics } from '../../GraphicsDiagnostics';\r\nimport { ExcaliburGraphicsContextWebGL, pixelSnapEpsilon } from '../ExcaliburGraphicsContextWebGL';\r\nimport { QuadIndexBuffer } from '../quad-index-buffer';\r\nimport { RendererPlugin } from '../renderer';\r\nimport { Shader } from '../shader';\r\nimport { VertexBuffer } from '../vertex-buffer';\r\nimport { VertexLayout } from '../vertex-layout';\r\n\r\nimport frag from './circle-renderer.frag.glsl';\r\nimport vert from './circle-renderer.vert.glsl';\r\n\r\nexport class CircleRenderer implements RendererPlugin {\r\n  public readonly type = 'ex.circle';\r\n  public priority: number = 0;\r\n\r\n  private _maxCircles: number = 10922; // max(uint16) / 6 verts\r\n\r\n  private _shader: Shader;\r\n  private _context: ExcaliburGraphicsContextWebGL;\r\n  private _gl: WebGLRenderingContext;\r\n  private _buffer: VertexBuffer;\r\n  private _layout: VertexLayout;\r\n  private _quads: QuadIndexBuffer;\r\n\r\n  private _circleCount: number = 0;\r\n  private _vertexIndex: number = 0;\r\n\r\n  initialize(gl: WebGLRenderingContext, context: ExcaliburGraphicsContextWebGL): void {\r\n    this._gl = gl;\r\n    this._context = context;\r\n    this._shader = new Shader({\r\n      fragmentSource: frag,\r\n      vertexSource: vert\r\n    });\r\n    this._shader.compile();\r\n\r\n    // setup uniforms\r\n    this._shader.use();\r\n    this._shader.setUniformMatrix('u_matrix', context.ortho);\r\n\r\n    this._buffer = new VertexBuffer({\r\n      size: 14 * 4 * this._maxCircles,\r\n      type: 'dynamic'\r\n    });\r\n\r\n    this._layout = new VertexLayout({\r\n      shader: this._shader,\r\n      vertexBuffer: this._buffer,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_uv', 2],\r\n        ['a_opacity', 1],\r\n        ['a_color', 4],\r\n        ['a_strokeColor', 4],\r\n        ['a_strokeThickness', 1]\r\n      ]\r\n    });\r\n\r\n    this._quads = new QuadIndexBuffer(this._maxCircles, true);\r\n  }\r\n\r\n  private _isFull() {\r\n    if (this._circleCount >= this._maxCircles) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  draw(pos: Vector, radius: number, color: Color, stroke: Color = Color.Transparent, strokeThickness: number = 0): void {\r\n    if (this._isFull()) {\r\n      this.flush();\r\n    }\r\n    this._circleCount++;\r\n\r\n    // transform based on current context\r\n    const transform = this._context.getTransform();\r\n    const opacity = this._context.opacity;\r\n    const snapToPixel = this._context.snapToPixel;\r\n\r\n    const topLeft = transform.multiply(pos.add(vec(-radius, -radius)));\r\n    const topRight = transform.multiply(pos.add(vec(radius, -radius)));\r\n    const bottomRight = transform.multiply(pos.add(vec(radius, radius)));\r\n    const bottomLeft = transform.multiply(pos.add(vec(-radius, radius)));\r\n\r\n    if (snapToPixel) {\r\n      topLeft.x = ~~(topLeft.x + pixelSnapEpsilon);\r\n      topLeft.y = ~~(topLeft.y + pixelSnapEpsilon);\r\n\r\n      topRight.x = ~~(topRight.x + pixelSnapEpsilon);\r\n      topRight.y = ~~(topRight.y + pixelSnapEpsilon);\r\n\r\n      bottomLeft.x = ~~(bottomLeft.x + pixelSnapEpsilon);\r\n      bottomLeft.y = ~~(bottomLeft.y + pixelSnapEpsilon);\r\n\r\n      bottomRight.x = ~~(bottomRight.x + pixelSnapEpsilon);\r\n      bottomRight.y = ~~(bottomRight.y + pixelSnapEpsilon);\r\n    }\r\n\r\n    // TODO UV could be static vertex buffer\r\n    const uvx0 = 0;\r\n    const uvy0 = 0;\r\n    const uvx1 = 1;\r\n    const uvy1 = 1;\r\n\r\n    // update data\r\n    const vertexBuffer = this._layout.vertexBuffer.bufferData;\r\n\r\n    // (0, 0) - 0\r\n    vertexBuffer[this._vertexIndex++] = topLeft.x;\r\n    vertexBuffer[this._vertexIndex++] = topLeft.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / radius;\r\n\r\n    // (0, 1) - 1\r\n    vertexBuffer[this._vertexIndex++] = bottomLeft.x;\r\n    vertexBuffer[this._vertexIndex++] = bottomLeft.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / radius;\r\n\r\n    // (1, 0) - 2\r\n    vertexBuffer[this._vertexIndex++] = topRight.x;\r\n    vertexBuffer[this._vertexIndex++] = topRight.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / radius;\r\n\r\n    // (1, 1) - 3\r\n    vertexBuffer[this._vertexIndex++] = bottomRight.x;\r\n    vertexBuffer[this._vertexIndex++] = bottomRight.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / radius;\r\n  }\r\n\r\n  hasPendingDraws(): boolean {\r\n    return this._circleCount !== 0;\r\n  }\r\n\r\n  flush(): void {\r\n    // nothing to draw early exit\r\n    if (this._circleCount === 0) {\r\n      return;\r\n    }\r\n\r\n    const gl = this._gl;\r\n    // Bind the shader\r\n    this._shader.use();\r\n\r\n    // Bind the memory layout and upload data\r\n    this._layout.use(true);\r\n\r\n    // Update ortho matrix uniform\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    // Bind index buffer\r\n    this._quads.bind();\r\n\r\n    // Draw all the quads\r\n    gl.drawElements(gl.TRIANGLES, this._circleCount * 6, this._quads.bufferGlType, 0);\r\n\r\n    GraphicsDiagnostics.DrawnImagesCount += this._circleCount;\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n\r\n    // Reset\r\n    this._circleCount = 0;\r\n    this._vertexIndex = 0;\r\n  }\r\n\r\n}","export default \"#version 300 es\\r\\nprecision highp float;\\r\\n\\r\\n// UV coord\\r\\nin vec2 v_uv;\\r\\n\\r\\n// Color coord to blend with image\\r\\nin lowp vec4 v_color;\\r\\n\\r\\n// Stroke color if used\\r\\nin lowp vec4 v_strokeColor;\\r\\n\\r\\n// Stroke thickness if used\\r\\nin lowp float v_strokeThickness;\\r\\n\\r\\n// Opacity\\r\\nin float v_opacity;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main() {\\r\\n  // make (0, 0) the center the uv \\r\\n  vec2 uv = v_uv * 2.0 - 1.0;\\r\\n\\r\\n  vec4 color = v_color;\\r\\n  vec4 strokeColor = v_strokeColor;\\r\\n\\r\\n  // circle border is at radius 1.0 \\r\\n  // dist is > 0 when inside the circle \\r\\n  float d = length(uv);\\r\\n  float dist = 1.0 - length(uv);\\r\\n\\r\\n  // Fade based on fwidth\\r\\n  float fade = fwidth(dot(uv, uv));\\r\\n\\r\\n  // if dist is greater than 0 step to 1;\\r\\n  // when we cross this 0 threshold add a smooth fade\\r\\n  float fill = smoothstep(-fade/2.0, fade/2.0, dist);\\r\\n\\r\\n  // if dist is greater than the stroke thickness step to 1\\r\\n  float stroke = 1.0 - smoothstep(v_strokeThickness, v_strokeThickness + fade, dist);\\r\\n\\r\\n  strokeColor.a *= fill * stroke;\\r\\n  strokeColor.rgb *= strokeColor.a;\\r\\n\\r\\n  color.a *= fill * (1.0 - stroke);\\r\\n  color.rgb *= color.a;\\r\\n\\r\\n  vec4 finalColor = mix(vec4(0.0), (color + strokeColor), fill);\\r\\n  finalColor.rgb = finalColor.rgb * v_opacity;\\r\\n  finalColor.a = finalColor.a * v_opacity;\\r\\n  fragColor = finalColor;\\r\\n}\";","export default \"#version 300 es\\r\\nin vec2 a_position;\\r\\n\\r\\n// UV coordinate\\r\\nin vec2 a_uv;\\r\\nout vec2 v_uv;\\r\\n\\r\\n// Opacity \\r\\nin float a_opacity;\\r\\nout float v_opacity;\\r\\n\\r\\nin vec4 a_color;\\r\\nout vec4 v_color;\\r\\n\\r\\nin vec4 a_strokeColor;\\r\\nout vec4 v_strokeColor;\\r\\n\\r\\nin float a_strokeThickness;\\r\\nout float v_strokeThickness;\\r\\n\\r\\nuniform mat4 u_matrix;\\r\\n\\r\\n\\r\\nvoid main() {\\r\\n   // Set the vertex position using the ortho transform matrix\\r\\n   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\\r\\n\\r\\n   // Pass through UV coords\\r\\n   v_uv = a_uv;\\r\\n   // Pass through the Opacity to the fragment shader\\r\\n   v_opacity = a_opacity;\\r\\n   // Pass through the color to the fragment shader\\r\\n   v_color = a_color;\\r\\n   // Pass through the stroke color to the fragment shader\\r\\n   v_strokeColor = a_strokeColor;\\r\\n   // Pass through the stroke thickenss to the fragment shader\\r\\n   v_strokeThickness = a_strokeThickness;\\r\\n}\";","import { Logger } from '..';\r\nexport class Pool<Type> {\r\n  public totalAllocations = 0;\r\n  public index = 0;\r\n  public objects: Type[] = [];\r\n  public disableWarnings = false;\r\n  private _logger = Logger.getInstance();\r\n\r\n  constructor(\r\n    public builder: (...args: any[]) => Type,\r\n    public recycler: (instance: Type, ...args: any[]) => Type,\r\n    public maxObjects: number = 100\r\n  ) {}\r\n\r\n  preallocate() {\r\n    for (let i = 0; i < this.maxObjects; i++) {\r\n      this.objects[i] = this.builder();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Use many instances out of the in the context and return all to the pool.\r\n   *\r\n   * By returning values out of the context they will be un-hooked from the pool and are free to be passed to consumers\r\n   * @param context\r\n   */\r\n  using(context: (pool: Pool<Type>) => Type[] | void) {\r\n    const result = context(this);\r\n    if (result) {\r\n      return this.done(...result);\r\n    }\r\n    return this.done();\r\n  }\r\n\r\n  /**\r\n   * Use a single instance out of th pool and immediately return it to the pool\r\n   * @param context\r\n   */\r\n  borrow(context: (object: Type) => void) {\r\n    const object = this.get();\r\n    context(object);\r\n    this.index--;\r\n  }\r\n\r\n  /**\r\n   * Retrieve a value from the pool, will allocate a new instance if necessary or recycle from the pool\r\n   * @param args\r\n   */\r\n  get(...args: any[]): Type {\r\n    if (this.index === this.maxObjects) {\r\n      if (!this.disableWarnings) {\r\n        this._logger.warn('Max pooled objects reached, possible memory leak? Doubling');\r\n      }\r\n      this.maxObjects = this.maxObjects * 2;\r\n    }\r\n\r\n    if (this.objects[this.index]) {\r\n      // Pool has an available object already constructed\r\n      return this.recycler(this.objects[this.index++], ...args);\r\n    } else {\r\n      // New allocation\r\n      this.totalAllocations++;\r\n      const object = (this.objects[this.index++] = this.builder(...args));\r\n      return object;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Signals we are done with the pool objects for now, Reclaims all objects in the pool.\r\n   *\r\n   * If a list of pooled objects is passed to done they are un-hooked from the pool and are free\r\n   * to be passed to consumers\r\n   * @param objects A list of object to separate from the pool\r\n   */\r\n  done(...objects: Type[]): Type[];\r\n  done(): void;\r\n  done(...objects: Type[]): Type[] | void {\r\n    // All objects in pool now considered \"free\"\r\n    this.index = 0;\r\n    for (const object of objects) {\r\n      const poolIndex = this.objects.indexOf(object);\r\n      // Build a new object to take the pool place\r\n      this.objects[poolIndex] = (this as any).builder(); // TODO problematic 0-arg only support\r\n      this.totalAllocations++;\r\n    }\r\n    return objects;\r\n  }\r\n}\r\n","import { AffineMatrix } from '../../Math/affine-matrix';\r\nimport { Color } from '../../Color';\r\nimport { ExcaliburGraphicsContextState } from './ExcaliburGraphicsContext';\r\n\r\nexport class DrawCall {\r\n  public z: number = 0;\r\n  public priority: number = 0;\r\n  public renderer: string;\r\n  public transform: AffineMatrix = AffineMatrix.identity();\r\n  public state: ExcaliburGraphicsContextState = {\r\n    z: 0,\r\n    opacity: 1,\r\n    tint: Color.White\r\n  };\r\n  public args: any[];\r\n}","import {\r\n  ExcaliburGraphicsContext,\r\n  LineGraphicsOptions,\r\n  RectGraphicsOptions,\r\n  PointGraphicsOptions,\r\n  ExcaliburGraphicsContextOptions,\r\n  DebugDraw,\r\n  HTMLImageSource\r\n} from './ExcaliburGraphicsContext';\r\n\r\nimport { Matrix } from '../../Math/matrix';\r\nimport { TransformStack } from './transform-stack';\r\nimport { Vector, vec } from '../../Math/vector';\r\nimport { Color } from '../../Color';\r\nimport { StateStack } from './state-stack';\r\nimport { Logger } from '../../Util/Log';\r\nimport { DebugText } from './debug-text';\r\nimport { ScreenDimension } from '../../Screen';\r\nimport { RenderTarget } from './render-target';\r\nimport { PostProcessor } from '../PostProcessor/PostProcessor';\r\nimport { ExcaliburWebGLContextAccessor } from './webgl-adapter';\r\nimport { TextureLoader } from './texture-loader';\r\nimport { RendererPlugin } from './renderer';\r\n\r\n// renderers\r\nimport { LineRenderer } from './line-renderer/line-renderer';\r\nimport { PointRenderer } from './point-renderer/point-renderer';\r\nimport { ScreenPassPainter } from './screen-pass-painter/screen-pass-painter';\r\nimport { ImageRenderer } from './image-renderer/image-renderer';\r\nimport { RectangleRenderer } from './rectangle-renderer/rectangle-renderer';\r\nimport { CircleRenderer } from './circle-renderer/circle-renderer';\r\nimport { Pool } from '../../Util/Pool';\r\nimport { DrawCall } from './draw-call';\r\nimport { AffineMatrix } from '../../Math/affine-matrix';\r\n\r\nexport const pixelSnapEpsilon = 0.0001;\r\n\r\nclass ExcaliburGraphicsContextWebGLDebug implements DebugDraw {\r\n  private _debugText = new DebugText();\r\n  constructor(private _webglCtx: ExcaliburGraphicsContextWebGL) {}\r\n\r\n  /**\r\n   * Draw a debugging rectangle to the context\r\n   * @param x\r\n   * @param y\r\n   * @param width\r\n   * @param height\r\n   */\r\n  drawRect(x: number, y: number, width: number, height: number, rectOptions: RectGraphicsOptions = { color: Color.Black }): void {\r\n    this.drawLine(vec(x, y), vec(x + width, y), { ...rectOptions });\r\n    this.drawLine(vec(x + width, y), vec(x + width, y + height), { ...rectOptions });\r\n    this.drawLine(vec(x + width, y + height), vec(x, y + height), { ...rectOptions });\r\n    this.drawLine(vec(x, y + height), vec(x, y), { ...rectOptions });\r\n  }\r\n\r\n  /**\r\n   * Draw a debugging line to the context\r\n   * @param start\r\n   * @param end\r\n   * @param lineOptions\r\n   */\r\n  drawLine(start: Vector, end: Vector, lineOptions: LineGraphicsOptions = { color: Color.Black }): void {\r\n    this._webglCtx.draw<LineRenderer>('ex.line', start, end, lineOptions.color);\r\n  }\r\n\r\n  /**\r\n   * Draw a debugging point to the context\r\n   * @param point\r\n   * @param pointOptions\r\n   */\r\n  drawPoint(point: Vector, pointOptions: PointGraphicsOptions = { color: Color.Black, size: 5 }): void {\r\n    this._webglCtx.draw<PointRenderer>('ex.point', point, pointOptions.color, pointOptions.size);\r\n  }\r\n\r\n  drawText(text: string, pos: Vector) {\r\n    this._debugText.write(this._webglCtx, text, pos);\r\n  }\r\n}\r\n\r\nexport interface WebGLGraphicsContextInfo {\r\n  transform: TransformStack;\r\n  state: StateStack;\r\n  ortho: Matrix;\r\n  context: ExcaliburGraphicsContextWebGL;\r\n}\r\n\r\nexport class ExcaliburGraphicsContextWebGL implements ExcaliburGraphicsContext {\r\n  private _logger = Logger.getInstance();\r\n  private _renderers: Map<string, RendererPlugin> = new Map<string, RendererPlugin>();\r\n  private _isDrawLifecycle = false;\r\n  public useDrawSorting = true;\r\n\r\n  private _drawCallPool = new Pool<DrawCall>(\r\n    () => new DrawCall(),\r\n    (instance) => {\r\n      instance.priority = 0;\r\n      instance.z = 0;\r\n      instance.renderer = undefined;\r\n      instance.args = undefined;\r\n      return instance;\r\n    }, 4000);\r\n  private _drawCalls: DrawCall[] = [];\r\n\r\n  // Main render target\r\n  private _renderTarget: RenderTarget;\r\n\r\n  // Postprocessing is a tuple with 2 render targets, these are flip-flopped during the postprocessing process\r\n  private _postProcessTargets: RenderTarget[] = [];\r\n\r\n  private _screenRenderer: ScreenPassPainter;\r\n\r\n  private _postprocessors: PostProcessor[] = [];\r\n  /**\r\n   * Meant for internal use only. Access the internal context at your own risk and no guarantees this will exist in the future.\r\n   * @internal\r\n   */\r\n  public __gl: WebGL2RenderingContext;\r\n\r\n  private _transform = new TransformStack();\r\n  private _state = new StateStack();\r\n  private _ortho!: Matrix;\r\n\r\n  public snapToPixel: boolean = false;\r\n\r\n  public smoothing: boolean = false;\r\n\r\n  public backgroundColor: Color = Color.ExcaliburBlue;\r\n\r\n  public get z(): number {\r\n    return this._state.current.z;\r\n  }\r\n\r\n  public set z(value: number) {\r\n    this._state.current.z = value;\r\n  }\r\n\r\n  public get opacity(): number {\r\n    return this._state.current.opacity;\r\n  }\r\n\r\n  public set opacity(value: number) {\r\n    this._state.current.opacity = value;\r\n  }\r\n\r\n  public get tint(): Color {\r\n    return this._state.current.tint;\r\n  }\r\n\r\n  public set tint(color: Color) {\r\n    this._state.current.tint = color;\r\n  }\r\n\r\n  public get width() {\r\n    return this.__gl.canvas.width;\r\n  }\r\n\r\n  public get height() {\r\n    return this.__gl.canvas.height;\r\n  }\r\n\r\n  public get ortho(): Matrix {\r\n    return this._ortho;\r\n  }\r\n\r\n  /**\r\n   * Checks the underlying webgl implementation if the requested internal resolution is supported\r\n   * @param dim\r\n   */\r\n  public checkIfResolutionSupported(dim: ScreenDimension): boolean {\r\n    // Slight hack based on this thread https://groups.google.com/g/webgl-dev-list/c/AHONvz3oQTo\r\n    let supported = true;\r\n    if (dim.width > 4096 || dim.height > 4096) {\r\n      supported = false;\r\n    }\r\n    return supported;\r\n  }\r\n\r\n  constructor(options: ExcaliburGraphicsContextOptions) {\r\n    const { canvasElement, enableTransparency, smoothing, snapToPixel, backgroundColor, useDrawSorting } = options;\r\n    this.__gl = canvasElement.getContext('webgl2', {\r\n      antialias: smoothing ?? this.smoothing,\r\n      premultipliedAlpha: false,\r\n      alpha: enableTransparency ?? true,\r\n      depth: true,\r\n      powerPreference: 'high-performance'\r\n      // TODO Chromium fixed the bug where this didn't work now it breaks CI :(\r\n      // failIfMajorPerformanceCaveat: true\r\n    });\r\n    if (!this.__gl) {\r\n      throw Error('Failed to retrieve webgl context from browser');\r\n    }\r\n    ExcaliburWebGLContextAccessor.register(this.__gl);\r\n    TextureLoader.register(this.__gl);\r\n    this.snapToPixel = snapToPixel ?? this.snapToPixel;\r\n    this.smoothing = smoothing ?? this.smoothing;\r\n    this.backgroundColor = backgroundColor ?? this.backgroundColor;\r\n    this.useDrawSorting = useDrawSorting ?? this.useDrawSorting;\r\n    this._drawCallPool.disableWarnings = true;\r\n    this._drawCallPool.preallocate();\r\n    this._init();\r\n  }\r\n\r\n  private _init() {\r\n    const gl = this.__gl;\r\n    // Setup viewport and view matrix\r\n    this._ortho = Matrix.ortho(0, gl.canvas.width, gl.canvas.height, 0, 400, -400);\r\n    gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);\r\n\r\n    // Clear background\r\n    gl.clearColor(this.backgroundColor.r / 255, this.backgroundColor.g / 255, this.backgroundColor.b / 255, this.backgroundColor.a);\r\n    gl.clear(gl.COLOR_BUFFER_BIT);\r\n\r\n    // Enable alpha blending\r\n    // https://www.realtimerendering.com/blog/gpus-prefer-premultiplication/\r\n    gl.enable(gl.BLEND);\r\n    gl.blendEquation(gl.FUNC_ADD);\r\n    gl.blendFunc(gl.ONE, gl.ONE_MINUS_SRC_ALPHA);\r\n    gl.blendEquationSeparate(gl.FUNC_ADD, gl.FUNC_ADD);\r\n    gl.blendFuncSeparate(gl.ONE, gl.ONE_MINUS_SRC_ALPHA, gl.ONE, gl.ONE_MINUS_SRC_ALPHA);\r\n\r\n    // Setup builtin renderers\r\n    this.register(new ImageRenderer());\r\n    this.register(new RectangleRenderer());\r\n    this.register(new CircleRenderer());\r\n    this.register(new PointRenderer());\r\n    this.register(new LineRenderer());\r\n\r\n    this._screenRenderer = new ScreenPassPainter(gl);\r\n\r\n    this._renderTarget = new RenderTarget({\r\n      gl,\r\n      width: gl.canvas.width,\r\n      height: gl.canvas.height\r\n    });\r\n\r\n\r\n    this._postProcessTargets = [\r\n      new RenderTarget({\r\n        gl,\r\n        width: gl.canvas.width,\r\n        height: gl.canvas.height\r\n      }),\r\n      new RenderTarget({\r\n        gl,\r\n        width: gl.canvas.width,\r\n        height: gl.canvas.height\r\n      })\r\n    ];\r\n  }\r\n\r\n  public register<T extends RendererPlugin>(renderer: T) {\r\n    this._renderers.set(renderer.type, renderer);\r\n    renderer.initialize(this.__gl, this);\r\n  }\r\n\r\n  public get(rendererName: string): RendererPlugin {\r\n    return this._renderers.get(rendererName);\r\n  }\r\n\r\n  private _currentRenderer: RendererPlugin;\r\n\r\n  private _isCurrentRenderer(renderer: RendererPlugin): boolean {\r\n    if (!this._currentRenderer || this._currentRenderer === renderer) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  public beginDrawLifecycle() {\r\n    this._isDrawLifecycle = true;\r\n  }\r\n\r\n  public endDrawLifecycle() {\r\n    this._isDrawLifecycle = false;\r\n  }\r\n\r\n  private _alreadyWarnedDrawLifecycle = false;\r\n\r\n  public draw<TRenderer extends RendererPlugin>(rendererName: TRenderer['type'], ...args: Parameters<TRenderer['draw']>) {\r\n    if (!this._isDrawLifecycle && !this._alreadyWarnedDrawLifecycle) {\r\n      this._logger.warn(\r\n        `Attempting to draw outside the the drawing lifecycle (preDraw/postDraw) is not supported and is a source of bugs/errors.\\n` +\r\n        `If you want to do custom drawing, use Actor.graphics, or any onPreDraw or onPostDraw handler.`);\r\n      this._alreadyWarnedDrawLifecycle = true;\r\n    }\r\n\r\n    const renderer = this._renderers.get(rendererName);\r\n    if (renderer) {\r\n      if (this.useDrawSorting) {\r\n        const drawCall = this._drawCallPool.get();\r\n        drawCall.z = this._state.current.z;\r\n        drawCall.priority = renderer.priority;\r\n        drawCall.renderer = rendererName;\r\n        this.getTransform().clone(drawCall.transform);\r\n        drawCall.state.z = this._state.current.z;\r\n        drawCall.state.opacity = this._state.current.opacity;\r\n        drawCall.state.tint = this._state.current.tint;\r\n        drawCall.args = args;\r\n        this._drawCalls.push(drawCall);\r\n      } else {\r\n        // Set the current renderer if not defined\r\n        if (!this._currentRenderer) {\r\n          this._currentRenderer = renderer;\r\n        }\r\n\r\n        if (!this._isCurrentRenderer(renderer)) {\r\n          // switching graphics means we must flush the previous\r\n          this._currentRenderer.flush();\r\n        }\r\n\r\n        // If we are still using the same renderer we can add to the current batch\r\n        renderer.draw(...args);\r\n\r\n        this._currentRenderer = renderer;\r\n      }\r\n    } else {\r\n      throw Error(`No renderer with name ${rendererName} has been registered`);\r\n    }\r\n  }\r\n\r\n  public resetTransform(): void {\r\n    this._transform.current = AffineMatrix.identity();\r\n  }\r\n\r\n  public updateViewport(resolution: ScreenDimension): void {\r\n    const gl = this.__gl;\r\n    this._ortho = this._ortho = Matrix.ortho(0, resolution.width, resolution.height, 0, 400, -400);\r\n\r\n    this._renderTarget.setResolution(gl.canvas.width, gl.canvas.height);\r\n    this._postProcessTargets[0].setResolution(gl.canvas.width, gl.canvas.height);\r\n    this._postProcessTargets[1].setResolution(gl.canvas.width, gl.canvas.height);\r\n  }\r\n\r\n  drawImage(image: HTMLImageSource, x: number, y: number): void;\r\n  drawImage(image: HTMLImageSource, x: number, y: number, width: number, height: number): void;\r\n  drawImage(\r\n    image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number\r\n  ): void;\r\n  drawImage(\r\n    image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number\r\n  ): void {\r\n    if (swidth === 0 || sheight === 0) {\r\n      return; // zero dimension dest exit early\r\n    } else if (dwidth === 0 || dheight === 0) {\r\n      return; // zero dimension dest exit early\r\n    } else if (image.width === 0 || image.height === 0) {\r\n      return; // zero dimension source exit early\r\n    }\r\n\r\n    if (!image) {\r\n      Logger.getInstance().warn('Cannot draw a null or undefined image');\r\n      // tslint:disable-next-line: no-console\r\n      if (console.trace) {\r\n        // tslint:disable-next-line: no-console\r\n        console.trace();\r\n      }\r\n      return;\r\n    }\r\n    this.draw<ImageRenderer>('ex.image', image, sx, sy, swidth, sheight, dx, dy, dwidth, dheight);\r\n  }\r\n\r\n  public drawLine(start: Vector, end: Vector, color: Color, thickness = 1) {\r\n    this.draw<RectangleRenderer>('ex.rectangle', start, end, color, thickness);\r\n  }\r\n\r\n  public drawRectangle(pos: Vector, width: number, height: number, color: Color, stroke?: Color, strokeThickness?: number) {\r\n    this.draw<RectangleRenderer>('ex.rectangle', pos, width, height, color, stroke, strokeThickness);\r\n  }\r\n\r\n  public drawCircle(pos: Vector, radius: number, color: Color, stroke?: Color, thickness?: number) {\r\n    this.draw<CircleRenderer>('ex.circle', pos, radius, color, stroke, thickness);\r\n  }\r\n\r\n  debug = new ExcaliburGraphicsContextWebGLDebug(this);\r\n\r\n  public save(): void {\r\n    this._transform.save();\r\n    this._state.save();\r\n  }\r\n\r\n  public restore(): void {\r\n    this._transform.restore();\r\n    this._state.restore();\r\n  }\r\n\r\n  public translate(x: number, y: number): void {\r\n    this._transform.translate(this.snapToPixel ? ~~(x + pixelSnapEpsilon) : x, this.snapToPixel ? ~~(y + pixelSnapEpsilon) : y);\r\n  }\r\n\r\n  public rotate(angle: number): void {\r\n    this._transform.rotate(angle);\r\n  }\r\n\r\n  public scale(x: number, y: number): void {\r\n    this._transform.scale(x, y);\r\n  }\r\n\r\n  public transform(matrix: AffineMatrix) {\r\n    this._transform.current = matrix;\r\n  }\r\n\r\n  public getTransform(): AffineMatrix {\r\n    return this._transform.current;\r\n  }\r\n\r\n  public multiply(m: AffineMatrix) {\r\n    this._transform.current.multiply(m, this._transform.current);\r\n  }\r\n\r\n  public addPostProcessor(postprocessor: PostProcessor) {\r\n    this._postprocessors.push(postprocessor);\r\n    postprocessor.initialize(this.__gl);\r\n  }\r\n\r\n  public removePostProcessor(postprocessor: PostProcessor) {\r\n    const index = this._postprocessors.indexOf(postprocessor);\r\n    if (index !== -1) {\r\n      this._postprocessors.splice(index, 1);\r\n    }\r\n  }\r\n\r\n  public clearPostProcessors() {\r\n    this._postprocessors.length = 0;\r\n  }\r\n\r\n  clear() {\r\n    const gl = this.__gl;\r\n    this._renderTarget.use();\r\n    gl.clearColor(this.backgroundColor.r / 255, this.backgroundColor.g / 255, this.backgroundColor.b / 255, this.backgroundColor.a);\r\n    // Clear the context with the newly set color. This is\r\n    // the function call that actually does the drawing.\r\n    gl.clear(gl.COLOR_BUFFER_BIT);\r\n  }\r\n\r\n  /**\r\n   * Flushes all batched rendering to the screen\r\n   */\r\n  flush() {\r\n    const gl = this.__gl;\r\n\r\n    // render target captures all draws and redirects to the render target\r\n    this._renderTarget.use();\r\n\r\n    if (this.useDrawSorting) {\r\n      // sort draw calls\r\n      // Find the original order of the first instance of the draw call\r\n      const originalSort = new Map<string, number>();\r\n      for (const [name] of this._renderers) {\r\n        const firstIndex = this._drawCalls.findIndex(dc => dc.renderer === name);\r\n        originalSort.set(name, firstIndex);\r\n      }\r\n\r\n      this._drawCalls.sort((a, b) => {\r\n        const zIndex = a.z - b.z;\r\n        const originalSortOrder = originalSort.get(a.renderer) - originalSort.get(b.renderer);\r\n        const priority = a.priority - b.priority;\r\n        if (zIndex === 0) { // sort by z first\r\n          if (priority === 0) { // sort by priority\r\n            return originalSortOrder; // use the original order to inform draw call packing to maximally preserve painter order\r\n          }\r\n          return priority;\r\n        }\r\n        return zIndex;\r\n      });\r\n\r\n      const oldTransform = this._transform.current;\r\n      const oldState = this._state.current;\r\n\r\n      if (this._drawCalls.length) {\r\n        let currentRendererName = this._drawCalls[0].renderer;\r\n        let currentRenderer = this._renderers.get(currentRendererName);\r\n        for (let i = 0; i < this._drawCalls.length; i++) {\r\n          // hydrate the state for renderers\r\n          this._transform.current = this._drawCalls[i].transform;\r\n          this._state.current = this._drawCalls[i].state;\r\n\r\n          if (this._drawCalls[i].renderer !== currentRendererName) {\r\n            // switching graphics renderer means we must flush the previous\r\n            currentRenderer.flush();\r\n            currentRendererName = this._drawCalls[i].renderer;\r\n            currentRenderer = this._renderers.get(currentRendererName);\r\n          }\r\n\r\n          // If we are still using the same renderer we can add to the current batch\r\n          currentRenderer.draw(...this._drawCalls[i].args);\r\n        }\r\n        if (currentRenderer.hasPendingDraws()) {\r\n          currentRenderer.flush();\r\n        }\r\n      }\r\n\r\n      // reset state\r\n      this._transform.current = oldTransform;\r\n      this._state.current = oldState;\r\n\r\n      // reclaim draw calls\r\n      this._drawCallPool.done();\r\n      this._drawCalls.length = 0;\r\n    } else {\r\n      // This is the final flush at the moment to draw any leftover pending draw\r\n      for (const renderer of this._renderers.values()) {\r\n        if (renderer.hasPendingDraws()) {\r\n          renderer.flush();\r\n        }\r\n      }\r\n    }\r\n\r\n    this._renderTarget.disable();\r\n\r\n    // post process step\r\n    const source = this._renderTarget.toRenderSource();\r\n    source.use();\r\n\r\n    // flip flop render targets\r\n    for (let i = 0; i < this._postprocessors.length; i++) {\r\n      this._postProcessTargets[i % 2].use();\r\n      this._screenRenderer.renderWithPostProcessor(this._postprocessors[i]);\r\n      this._postProcessTargets[i % 2].toRenderSource().use();\r\n    }\r\n\r\n    // passing null switches rendering back to the canvas\r\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n    this._screenRenderer.renderToScreen();\r\n  }\r\n}\r\n","import {\r\n  ExcaliburGraphicsContext,\r\n  LineGraphicsOptions,\r\n  PointGraphicsOptions,\r\n  ExcaliburGraphicsContextOptions,\r\n  DebugDraw,\r\n  HTMLImageSource\r\n} from './ExcaliburGraphicsContext';\r\nimport { Vector } from '../../Math/vector';\r\nimport { Color } from '../../Color';\r\nimport { StateStack } from './state-stack';\r\nimport { GraphicsDiagnostics } from '../GraphicsDiagnostics';\r\nimport { DebugText } from './debug-text';\r\nimport { ScreenDimension } from '../../Screen';\r\nimport { PostProcessor } from '../PostProcessor/PostProcessor';\r\nimport { AffineMatrix } from '../../Math/affine-matrix';\r\n\r\nconst pixelSnapEpsilon = 0.0001;\r\n\r\nclass ExcaliburGraphicsContext2DCanvasDebug implements DebugDraw {\r\n  private _debugText = new DebugText();\r\n  constructor(private _ex: ExcaliburGraphicsContext2DCanvas) {}\r\n  /**\r\n   * Draw a debug rectangle to the context\r\n   * @param x\r\n   * @param y\r\n   * @param width\r\n   * @param height\r\n   */\r\n  drawRect(x: number, y: number, width: number, height: number): void {\r\n    this._ex.__ctx.save();\r\n    this._ex.__ctx.strokeStyle = 'red';\r\n    this._ex.__ctx.strokeRect(\r\n      this._ex.snapToPixel ? ~~(x + pixelSnapEpsilon) : x,\r\n      this._ex.snapToPixel ? ~~(y + pixelSnapEpsilon) : y,\r\n      this._ex.snapToPixel ? ~~(width + pixelSnapEpsilon) : width,\r\n      this._ex.snapToPixel ? ~~(height + pixelSnapEpsilon) : height\r\n    );\r\n    this._ex.__ctx.restore();\r\n  }\r\n\r\n  drawLine(start: Vector, end: Vector, lineOptions: LineGraphicsOptions = { color: Color.Black }): void {\r\n    this._ex.__ctx.save();\r\n    this._ex.__ctx.beginPath();\r\n    this._ex.__ctx.strokeStyle = lineOptions.color.toString();\r\n    this._ex.__ctx.moveTo(\r\n      this._ex.snapToPixel ? ~~(start.x + pixelSnapEpsilon) : start.x,\r\n      this._ex.snapToPixel ? ~~(start.y + pixelSnapEpsilon) : start.y\r\n    );\r\n    this._ex.__ctx.lineTo(\r\n      this._ex.snapToPixel ? ~~(end.x + pixelSnapEpsilon) : end.x,\r\n      this._ex.snapToPixel ? ~~(end.y + pixelSnapEpsilon) : end.y\r\n    );\r\n    this._ex.__ctx.lineWidth = 2;\r\n    this._ex.__ctx.stroke();\r\n    this._ex.__ctx.closePath();\r\n    this._ex.__ctx.restore();\r\n  }\r\n\r\n  drawPoint(point: Vector, pointOptions: PointGraphicsOptions = { color: Color.Black, size: 5 }): void {\r\n    this._ex.__ctx.save();\r\n    this._ex.__ctx.beginPath();\r\n    this._ex.__ctx.fillStyle = pointOptions.color.toString();\r\n    this._ex.__ctx.arc(\r\n      this._ex.snapToPixel ? ~~(point.x + pixelSnapEpsilon) : point.x,\r\n      this._ex.snapToPixel ? ~~(point.y + pixelSnapEpsilon) : point.y,\r\n      pointOptions.size,\r\n      0,\r\n      Math.PI * 2\r\n    );\r\n    this._ex.__ctx.fill();\r\n    this._ex.__ctx.closePath();\r\n    this._ex.__ctx.restore();\r\n  }\r\n\r\n  drawText(text: string, pos: Vector) {\r\n    this._debugText.write(this._ex, text, pos);\r\n  }\r\n}\r\n\r\nexport class ExcaliburGraphicsContext2DCanvas implements ExcaliburGraphicsContext {\r\n  /**\r\n   * Meant for internal use only. Access the internal context at your own risk and no guarantees this will exist in the future.\r\n   * @internal\r\n   */\r\n  public __ctx: CanvasRenderingContext2D;\r\n  public get width() {\r\n    return this.__ctx.canvas.width;\r\n  }\r\n\r\n  public get height() {\r\n    return this.__ctx.canvas.height;\r\n  }\r\n\r\n  /**\r\n   * Unused in Canvas implementation\r\n   */\r\n  public readonly useDrawSorting: boolean = false;\r\n\r\n  /**\r\n   * Unused in Canvas implementation\r\n   */\r\n  public z: number = 0;\r\n\r\n  public backgroundColor: Color = Color.ExcaliburBlue;\r\n\r\n  private _state = new StateStack();\r\n\r\n  public get opacity(): number {\r\n    return this._state.current.opacity;\r\n  }\r\n\r\n  public set opacity(value: number) {\r\n    this._state.current.opacity = value;\r\n  }\r\n\r\n  public get tint(): Color {\r\n    return this._state.current.tint;\r\n  }\r\n\r\n  public set tint(color: Color) {\r\n    this._state.current.tint = color;\r\n  }\r\n\r\n  public snapToPixel: boolean = false;\r\n\r\n  public get smoothing(): boolean {\r\n    return this.__ctx.imageSmoothingEnabled;\r\n  }\r\n\r\n  public set smoothing(value: boolean) {\r\n    this.__ctx.imageSmoothingEnabled = value;\r\n  }\r\n\r\n  constructor(options: ExcaliburGraphicsContextOptions) {\r\n    const { canvasElement, enableTransparency, snapToPixel, smoothing, backgroundColor } = options;\r\n    this.__ctx = canvasElement.getContext('2d', {\r\n      alpha: enableTransparency ?? true\r\n    });\r\n    this.backgroundColor = backgroundColor ?? this.backgroundColor;\r\n    this.snapToPixel = snapToPixel ?? this.snapToPixel;\r\n    this.smoothing = smoothing ?? this.smoothing;\r\n  }\r\n\r\n  public resetTransform(): void {\r\n    this.__ctx.resetTransform();\r\n  }\r\n\r\n  public updateViewport(_resolution: ScreenDimension): void {\r\n    // pass\r\n  }\r\n\r\n  /**\r\n   * Draw an image to the Excalibur Graphics context at an x and y coordinate using the images width and height\r\n   */\r\n  drawImage(image: HTMLImageSource, x: number, y: number): void;\r\n  /**\r\n   *\r\n   * Draw an image to the Excalibur Graphics context at an x and y coordinate with a specific width and height\r\n   */\r\n  drawImage(image: HTMLImageSource, x: number, y: number, width: number, height: number): void;\r\n  /**\r\n   *\r\n   * Draw an image to the Excalibur Graphics context specifying the source image coordinates (sx, sy, swidth, sheight)\r\n   * and to a specific destination on the context (dx, dy, dwidth, dheight)\r\n   */\r\n  drawImage(\r\n    image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number\r\n  ): void;\r\n\r\n  drawImage(\r\n    image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number\r\n  ): void {\r\n    if (swidth === 0 || sheight === 0) {\r\n      return; // zero dimension dest exit early\r\n    } else if (dwidth === 0 || dheight === 0) {\r\n      return; // zero dimension dest exit early\r\n    } else if (image.width === 0 || image.height === 0) {\r\n      return; // zero dimension source exit early\r\n    }\r\n\r\n    this.__ctx.globalAlpha = this.opacity;\r\n    const args = [image, sx, sy, swidth, sheight, dx, dy, dwidth, dheight]\r\n      .filter((a) => a !== undefined)\r\n      .map((a) => (typeof a === 'number' && this.snapToPixel ? ~~a : a));\r\n    this.__ctx.drawImage.apply(this.__ctx, args);\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n    GraphicsDiagnostics.DrawnImagesCount = 1;\r\n  }\r\n\r\n  public drawLine(start: Vector, end: Vector, color: Color, thickness = 1) {\r\n    this.__ctx.save();\r\n    this.__ctx.beginPath();\r\n    this.__ctx.strokeStyle = color.toString();\r\n    this.__ctx.moveTo(\r\n      this.snapToPixel ? ~~ (start.x + pixelSnapEpsilon) : start.x,\r\n      this.snapToPixel ? ~~(start.y + pixelSnapEpsilon) : start.y\r\n    );\r\n    this.__ctx.lineTo(\r\n      this.snapToPixel ? ~~ (end.x + pixelSnapEpsilon) : end.x,\r\n      this.snapToPixel ? ~~(end.y + pixelSnapEpsilon) : end.y\r\n    );\r\n    this.__ctx.lineWidth = thickness;\r\n    this.__ctx.stroke();\r\n    this.__ctx.closePath();\r\n    this.__ctx.restore();\r\n  }\r\n\r\n  public drawRectangle(pos: Vector, width: number, height: number, color: Color) {\r\n    this.__ctx.save();\r\n    this.__ctx.fillStyle = color.toString();\r\n    this.__ctx.fillRect(\r\n      this.snapToPixel ? ~~(pos.x + pixelSnapEpsilon) : pos.x,\r\n      this.snapToPixel ? ~~(pos.y + pixelSnapEpsilon) : pos.y,\r\n      this.snapToPixel ? ~~(width + pixelSnapEpsilon) : width,\r\n      this.snapToPixel ? ~~(height + pixelSnapEpsilon) : height\r\n    );\r\n    this.__ctx.restore();\r\n  }\r\n\r\n  public drawCircle(pos: Vector, radius: number, color: Color, stroke?: Color, thickness?: number) {\r\n    this.__ctx.save();\r\n    this.__ctx.beginPath();\r\n    if (stroke) {\r\n      this.__ctx.strokeStyle = stroke.toString();\r\n    }\r\n    if (thickness) {\r\n      this.__ctx.lineWidth = thickness;\r\n    }\r\n    this.__ctx.fillStyle = color.toString();\r\n    this.__ctx.arc(\r\n      this.snapToPixel ? ~~(pos.x + pixelSnapEpsilon) : pos.x,\r\n      this.snapToPixel ? ~~(pos.y + pixelSnapEpsilon) : pos.y, radius, 0, Math.PI * 2\r\n    );\r\n    this.__ctx.fill();\r\n    if (stroke) {\r\n      this.__ctx.stroke();\r\n    }\r\n    this.__ctx.closePath();\r\n    this.__ctx.restore();\r\n  }\r\n\r\n  debug = new ExcaliburGraphicsContext2DCanvasDebug(this);\r\n\r\n  /**\r\n   * Save the current state of the canvas to the stack (transforms and opacity)\r\n   */\r\n  save(): void {\r\n    this.__ctx.save();\r\n  }\r\n\r\n  /**\r\n   * Restore the state of the canvas from the stack\r\n   */\r\n  restore(): void {\r\n    this.__ctx.restore();\r\n  }\r\n\r\n  /**\r\n   * Translate the origin of the context by an x and y\r\n   * @param x\r\n   * @param y\r\n   */\r\n  translate(x: number, y: number): void {\r\n    this.__ctx.translate(this.snapToPixel ? ~~(x + pixelSnapEpsilon) : x, this.snapToPixel ? ~~(y + pixelSnapEpsilon) : y);\r\n  }\r\n\r\n  /**\r\n   * Rotate the context about the current origin\r\n   */\r\n  rotate(angle: number): void {\r\n    this.__ctx.rotate(angle);\r\n  }\r\n\r\n  /**\r\n   * Scale the context by an x and y factor\r\n   * @param x\r\n   * @param y\r\n   */\r\n  scale(x: number, y: number): void {\r\n    this.__ctx.scale(x, y);\r\n  }\r\n\r\n  public getTransform(): AffineMatrix {\r\n    throw new Error('Not implemented');\r\n  }\r\n\r\n  public multiply(_m: AffineMatrix): void {\r\n    this.__ctx.setTransform(this.__ctx.getTransform().multiply(_m.toDOMMatrix()));\r\n  }\r\n\r\n  public addPostProcessor(_postprocessor: PostProcessor) {\r\n    // pass\r\n  }\r\n\r\n  public removePostProcessor(_postprocessor: PostProcessor) {\r\n    // pass\r\n  }\r\n\r\n  public clearPostProcessors() {\r\n    // pass\r\n  }\r\n\r\n  public beginDrawLifecycle() {\r\n    // pass\r\n  }\r\n\r\n  public endDrawLifecycle() {\r\n    // pass\r\n  }\r\n\r\n  clear(): void {\r\n    // Clear frame\r\n    this.__ctx.clearRect(0, 0, this.width, this.height);\r\n    this.__ctx.fillStyle = this.backgroundColor.toString();\r\n    this.__ctx.fillRect(0, 0, this.width, this.height);\r\n    GraphicsDiagnostics.clear();\r\n  }\r\n\r\n  /**\r\n   * Flushes the batched draw calls to the screen\r\n   */\r\n  flush(): void {\r\n    // pass\r\n  }\r\n}\r\n","import { vec, Vector } from './Math/vector';\r\nimport { Logger } from './Util/Log';\r\nimport { Camera } from './Camera';\r\nimport { BrowserEvents } from './Util/Browser';\r\nimport { BoundingBox } from './Collision/Index';\r\nimport { ExcaliburGraphicsContext } from './Graphics/Context/ExcaliburGraphicsContext';\r\nimport { getPosition } from './Util/Util';\r\nimport { ExcaliburGraphicsContextWebGL } from './Graphics/Context/ExcaliburGraphicsContextWebGL';\r\nimport { ExcaliburGraphicsContext2DCanvas } from './Graphics/Context/ExcaliburGraphicsContext2DCanvas';\r\n\r\n/**\r\n * Enum representing the different display modes available to Excalibur.\r\n */\r\nexport enum DisplayMode {\r\n  /**\r\n   * Default, use a specified resolution for the game. Like 800x600 pixels for example.\r\n   */\r\n  Fixed = 'Fixed',\r\n\r\n  /**\r\n   * Fit the aspect ratio given by the game resolution within the container at all times will fill any gaps with canvas.\r\n   * The displayed area outside the aspect ratio is not guaranteed to be on the screen, only the [[Screen.contentArea]]\r\n   * is guaranteed to be on screen.\r\n   */\r\n  FitContainerAndFill = 'FitContainerAndFill',\r\n\r\n  /**\r\n   * Fit the aspect ratio given by the game resolution the screen at all times will fill the screen.\r\n   * This displayed area outside the aspect ratio is not guaranteed to be on the screen, only the [[Screen.contentArea]]\r\n   * is guaranteed to be on screen.\r\n   */\r\n  FitScreenAndFill = 'FitScreenAndFill',\r\n\r\n  /**\r\n   * Fit the viewport to the parent element maintaining aspect ratio given by the game resolution, but zooms in to avoid the black bars\r\n   * (letterbox) that would otherwise be present in [[FitContainer]].\r\n   *\r\n   * **warning** This will clip some drawable area from the user because of the zoom,\r\n   * use [[Screen.contentArea]] to know the safe to draw area.\r\n   */\r\n  FitContainerAndZoom = 'FitContainerAndZoom',\r\n\r\n  /**\r\n   * Fit the viewport to the device screen maintaining aspect ratio given by the game resolution, but zooms in to avoid the black bars\r\n   * (letterbox) that would otherwise be present in [[FitScreen]].\r\n   *\r\n   * **warning** This will clip some drawable area from the user because of the zoom,\r\n   * use [[Screen.contentArea]] to know the safe to draw area.\r\n   */\r\n  FitScreenAndZoom = 'FitScreenAndZoom',\r\n\r\n  /**\r\n   * Fit to screen using as much space as possible while maintaining aspect ratio and resolution.\r\n   * This is not the same as [[Screen.goFullScreen]] but behaves in a similar way maintaining aspect ratio.\r\n   *\r\n   * You may want to center your game here is an example\r\n   * ```html\r\n   * <!-- html -->\r\n   * <body>\r\n   * <main>\r\n   *   <canvas id=\"game\"></canvas>\r\n   * </main>\r\n   * </body>\r\n   * ```\r\n   *\r\n   * ```css\r\n   * // css\r\n   * main {\r\n   *   display: flex;\r\n   *   align-items: center;\r\n   *   justify-content: center;\r\n   *   height: 100%;\r\n   *   width: 100%;\r\n   * }\r\n   * ```\r\n   */\r\n  FitScreen = 'FitScreen',\r\n\r\n  /**\r\n   * Fill the entire screen's css width/height for the game resolution dynamically. This means the resolution of the game will\r\n   * change dynamically as the window is resized. This is not the same as [[Screen.goFullScreen]]\r\n   */\r\n  FillScreen = 'FillScreen',\r\n\r\n  /**\r\n   * Fit to parent element width/height using as much space as possible while maintaining aspect ratio and resolution.\r\n   */\r\n  FitContainer = 'FitContainer',\r\n\r\n  /**\r\n   * Use the parent DOM container's css width/height for the game resolution dynamically\r\n   */\r\n  FillContainer = 'FillContainer'\r\n}\r\n\r\n/**\r\n * Convenience class for quick resolutions\r\n * Mostly sourced from https://emulation.gametechwiki.com/index.php/Resolution\r\n */\r\nexport class Resolution {\r\n  /* istanbul ignore next */\r\n  public static get SVGA(): ScreenDimension {\r\n    return { width: 800, height: 600 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get Standard(): ScreenDimension {\r\n    return { width: 1920, height: 1080 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get Atari2600(): ScreenDimension {\r\n    return { width: 160, height: 192 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get GameBoy(): ScreenDimension {\r\n    return { width: 160, height: 144 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get GameBoyAdvance(): ScreenDimension {\r\n    return { width: 240, height: 160 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get NintendoDS(): ScreenDimension {\r\n    return { width: 256, height: 192 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get NES(): ScreenDimension {\r\n    return { width: 256, height: 224 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get SNES(): ScreenDimension {\r\n    return { width: 256, height: 244 };\r\n  }\r\n}\r\n\r\nexport interface ScreenDimension {\r\n  width: number;\r\n  height: number;\r\n}\r\n\r\nexport interface ScreenOptions {\r\n  /**\r\n   * Canvas element to build a screen on\r\n   */\r\n  canvas: HTMLCanvasElement;\r\n\r\n  /**\r\n   * Graphics context for the screen\r\n   */\r\n  context: ExcaliburGraphicsContext;\r\n\r\n  /**\r\n   * Browser abstraction\r\n   */\r\n  browser: BrowserEvents;\r\n  /**\r\n   * Optionally set antialiasing, defaults to true. If set to true, images will be smoothed\r\n   */\r\n  antialiasing?: boolean;\r\n  /**\r\n   * Optionally override the pixel ratio to use for the screen, otherwise calculated automatically from the browser\r\n   */\r\n  pixelRatio?: number;\r\n  /**\r\n   * Optionally specify the actual pixel resolution in width/height pixels (also known as logical resolution), by default the\r\n   * resolution will be the same as the viewport. Resolution will be overridden by [[DisplayMode.FillContainer]] and\r\n   * [[DisplayMode.FillScreen]].\r\n   */\r\n  resolution?: ScreenDimension;\r\n  /**\r\n   * Visual viewport size in css pixel, if resolution is not specified it will be the same as the viewport\r\n   */\r\n  viewport: ScreenDimension;\r\n  /**\r\n   * Set the display mode of the screen, by default DisplayMode.Fixed.\r\n   */\r\n  displayMode?: DisplayMode;\r\n}\r\n\r\n/**\r\n * The Screen handles all aspects of interacting with the screen for Excalibur.\r\n */\r\nexport class Screen {\r\n  public graphicsContext: ExcaliburGraphicsContext;\r\n  private _canvas: HTMLCanvasElement;\r\n  private _antialiasing: boolean = true;\r\n  private _contentResolution: ScreenDimension;\r\n  private _browser: BrowserEvents;\r\n  private _camera: Camera;\r\n  private _resolution: ScreenDimension;\r\n  private _resolutionStack: ScreenDimension[] = [];\r\n  private _viewport: ScreenDimension;\r\n  private _viewportStack: ScreenDimension[] = [];\r\n  private _pixelRatioOverride: number | null = null;\r\n  private _displayMode: DisplayMode;\r\n  private _isFullScreen = false;\r\n  private _mediaQueryList: MediaQueryList;\r\n  private _isDisposed = false;\r\n  private _logger = Logger.getInstance();\r\n  private _resizeObserver: ResizeObserver;\r\n\r\n  constructor(options: ScreenOptions) {\r\n    this.viewport = options.viewport;\r\n    this.resolution = options.resolution ?? { ...this.viewport };\r\n    this._contentResolution = this.resolution;\r\n    this._displayMode = options.displayMode ?? DisplayMode.Fixed;\r\n    this._canvas = options.canvas;\r\n    this.graphicsContext = options.context;\r\n    this._antialiasing = options.antialiasing ?? this._antialiasing;\r\n    this._browser = options.browser;\r\n    this._pixelRatioOverride = options.pixelRatio;\r\n\r\n    this._applyDisplayMode();\r\n\r\n    this._listenForPixelRatio();\r\n\r\n    this._canvas.addEventListener('fullscreenchange', this._fullscreenChangeHandler);\r\n    this.applyResolutionAndViewport();\r\n  }\r\n\r\n  private _listenForPixelRatio() {\r\n    if (this._mediaQueryList && !this._mediaQueryList.addEventListener) {\r\n      // Safari <=13.1 workaround, remove any existing handlers\r\n      this._mediaQueryList.removeListener(this._pixelRatioChangeHandler);\r\n    }\r\n    this._mediaQueryList = this._browser.window.nativeComponent.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`);\r\n\r\n    // Safari <=13.1 workaround\r\n    if (this._mediaQueryList.addEventListener) {\r\n      this._mediaQueryList.addEventListener('change', this._pixelRatioChangeHandler, { once: true });\r\n    } else {\r\n      this._mediaQueryList.addListener(this._pixelRatioChangeHandler);\r\n    }\r\n  }\r\n\r\n  public dispose(): void {\r\n    if (!this._isDisposed) {\r\n      // Clean up handlers\r\n      this._isDisposed = true;\r\n      this._browser.window.off('resize', this._resizeHandler);\r\n      if (this._resizeObserver) {\r\n        this._resizeObserver.disconnect();\r\n      }\r\n      this.parent.removeEventListener('resize', this._resizeHandler);\r\n      // Safari <=13.1 workaround\r\n      if (this._mediaQueryList.removeEventListener) {\r\n        this._mediaQueryList.removeEventListener('change', this._pixelRatioChangeHandler);\r\n      } else {\r\n        this._mediaQueryList.removeListener(this._pixelRatioChangeHandler);\r\n      }\r\n      this._canvas.removeEventListener('fullscreenchange', this._fullscreenChangeHandler);\r\n    }\r\n  }\r\n\r\n  private _fullscreenChangeHandler = () => {\r\n    this._isFullScreen = !this._isFullScreen;\r\n    this._logger.debug('Fullscreen Change', this._isFullScreen);\r\n  };\r\n\r\n  private _pixelRatioChangeHandler = () => {\r\n    this._logger.debug('Pixel Ratio Change', window.devicePixelRatio);\r\n    this._listenForPixelRatio();\r\n    this._devicePixelRatio = this._calculateDevicePixelRatio();\r\n    this.applyResolutionAndViewport();\r\n  };\r\n\r\n  private _resizeHandler = () => {\r\n    const parent = this.parent;\r\n    this._logger.debug('View port resized');\r\n    this._setResolutionAndViewportByDisplayMode(parent);\r\n    this.applyResolutionAndViewport();\r\n  };\r\n\r\n  private _calculateDevicePixelRatio() {\r\n    if (window.devicePixelRatio < 1) {\r\n      return 1;\r\n    }\r\n\r\n    const devicePixelRatio = window.devicePixelRatio || 1;\r\n\r\n    return devicePixelRatio;\r\n  }\r\n\r\n  // Asking the window.devicePixelRatio is expensive we do it once\r\n  private _devicePixelRatio = this._calculateDevicePixelRatio();\r\n\r\n  public get pixelRatio(): number {\r\n    if (this._pixelRatioOverride) {\r\n      return this._pixelRatioOverride;\r\n    }\r\n\r\n    return this._devicePixelRatio;\r\n  }\r\n\r\n  public get isHiDpi() {\r\n    return this.pixelRatio !== 1;\r\n  }\r\n\r\n  public get displayMode(): DisplayMode {\r\n    return this._displayMode;\r\n  }\r\n\r\n  public get canvas(): HTMLCanvasElement {\r\n    return this._canvas;\r\n  }\r\n\r\n  public get parent(): HTMLElement | Window {\r\n    switch (this.displayMode) {\r\n      case DisplayMode.FillContainer:\r\n      case DisplayMode.FitContainer:\r\n      case DisplayMode.FitContainerAndFill:\r\n      case DisplayMode.FitContainerAndZoom:\r\n        return this.canvas.parentElement || document.body;\r\n      default:\r\n        return window;\r\n    }\r\n  }\r\n\r\n  public get resolution(): ScreenDimension {\r\n    return this._resolution;\r\n  }\r\n\r\n  public set resolution(resolution: ScreenDimension) {\r\n    this._resolution = resolution;\r\n  }\r\n\r\n  public get viewport(): ScreenDimension {\r\n    if (this._viewport) {\r\n      return this._viewport;\r\n    }\r\n    return this._resolution;\r\n  }\r\n\r\n  public set viewport(viewport: ScreenDimension) {\r\n    this._viewport = viewport;\r\n  }\r\n\r\n  public get aspectRatio() {\r\n    return this._resolution.width / this._resolution.height;\r\n  }\r\n\r\n  public get scaledWidth() {\r\n    return this._resolution.width * this.pixelRatio;\r\n  }\r\n\r\n  public get scaledHeight() {\r\n    return this._resolution.height * this.pixelRatio;\r\n  }\r\n\r\n  public setCurrentCamera(camera: Camera) {\r\n    this._camera = camera;\r\n  }\r\n\r\n  public pushResolutionAndViewport() {\r\n    this._resolutionStack.push(this.resolution);\r\n    this._viewportStack.push(this.viewport);\r\n\r\n    this.resolution = { ...this.resolution };\r\n    this.viewport = { ...this.viewport };\r\n  }\r\n\r\n  public peekViewport(): ScreenDimension {\r\n    return this._viewportStack[this._viewportStack.length - 1];\r\n  }\r\n\r\n  public peekResolution(): ScreenDimension {\r\n    return this._resolutionStack[this._resolutionStack.length - 1];\r\n  }\r\n\r\n  public popResolutionAndViewport() {\r\n    this.resolution = this._resolutionStack.pop();\r\n    this.viewport = this._viewportStack.pop();\r\n  }\r\n\r\n  private _alreadyWarned = false;\r\n  public applyResolutionAndViewport() {\r\n    this._canvas.width = this.scaledWidth;\r\n    this._canvas.height = this.scaledHeight;\r\n\r\n    if (this.graphicsContext instanceof ExcaliburGraphicsContextWebGL) {\r\n      const supported = this.graphicsContext.checkIfResolutionSupported({\r\n        width: this.scaledWidth,\r\n        height: this.scaledHeight\r\n      });\r\n      if (!supported && !this._alreadyWarned) {\r\n        this._alreadyWarned = true; // warn once\r\n        this._logger.warn(\r\n          `The currently configured resolution (${this.resolution.width}x${this.resolution.height}) and pixel ratio (${this.pixelRatio})` +\r\n          ' are too large for the platform WebGL implementation, this may work but cause WebGL rendering to behave oddly.' +\r\n          ' Try reducing the resolution or disabling Hi DPI scaling to avoid this' +\r\n          ' (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).');\r\n      }\r\n    }\r\n\r\n    if (this._antialiasing) {\r\n      this._canvas.style.imageRendering = 'auto';\r\n    } else {\r\n      this._canvas.style.imageRendering = 'pixelated';\r\n      // Fall back to 'crisp-edges' if 'pixelated' is not supported\r\n      // Currently for firefox https://developer.mozilla.org/en-US/docs/Web/CSS/image-rendering\r\n      if (this._canvas.style.imageRendering === '') {\r\n        this._canvas.style.imageRendering = 'crisp-edges';\r\n      }\r\n    }\r\n    this._canvas.style.width = this.viewport.width + 'px';\r\n    this._canvas.style.height = this.viewport.height + 'px';\r\n\r\n    // After messing with the canvas width/height the graphics context is invalidated and needs to have some properties reset\r\n    this.graphicsContext.updateViewport(this.resolution);\r\n    this.graphicsContext.resetTransform();\r\n    this.graphicsContext.smoothing = this._antialiasing;\r\n    if (this.graphicsContext instanceof ExcaliburGraphicsContext2DCanvas) {\r\n      this.graphicsContext.scale(this.pixelRatio, this.pixelRatio);\r\n    }\r\n  }\r\n\r\n  public get antialiasing() {\r\n    return this._antialiasing;\r\n  }\r\n\r\n  public set antialiasing(isSmooth: boolean) {\r\n    this._antialiasing = isSmooth;\r\n    this.graphicsContext.smoothing = this._antialiasing;\r\n  }\r\n\r\n  /**\r\n   * Returns true if excalibur is fullscreen using the browser fullscreen api\r\n   */\r\n  public get isFullScreen() {\r\n    return this._isFullScreen;\r\n  }\r\n\r\n  /**\r\n   * Requests to go fullscreen using the browser fullscreen api, requires user interaction to be successful.\r\n   * For example, wire this to a user click handler.\r\n   *\r\n   * Optionally specify a target element id to go fullscreen, by default the game canvas is used\r\n   * @param elementId\r\n   */\r\n  public goFullScreen(elementId?: string): Promise<void> {\r\n    if (elementId) {\r\n      const maybeElement = document.getElementById(elementId);\r\n      if (maybeElement) {\r\n        return maybeElement.requestFullscreen();\r\n      }\r\n    }\r\n    return this._canvas.requestFullscreen();\r\n  }\r\n\r\n  /**\r\n   * Requests to exit fullscreen using the browser fullscreen api\r\n   */\r\n  public exitFullScreen(): Promise<void> {\r\n    return document.exitFullscreen();\r\n  }\r\n\r\n  /**\r\n   * Takes a coordinate in normal html page space, for example from a pointer move event, and translates it to\r\n   * Excalibur screen space.\r\n   *\r\n   * Excalibur screen space starts at the top left (0, 0) corner of the viewport, and extends to the\r\n   * bottom right corner (resolutionX, resolutionY)\r\n   * @param point\r\n   */\r\n  public pageToScreenCoordinates(point: Vector): Vector {\r\n    let newX = point.x;\r\n    let newY = point.y;\r\n\r\n    if (!this._isFullScreen) {\r\n      newX -= getPosition(this._canvas).x;\r\n      newY -= getPosition(this._canvas).y;\r\n    }\r\n\r\n    // if fullscreen api on it centers with black bars\r\n    // we need to adjust the screen to world coordinates in this case\r\n    if (this._isFullScreen) {\r\n      if (window.innerWidth / this.aspectRatio < window.innerHeight) {\r\n        const screenHeight = window.innerWidth / this.aspectRatio;\r\n        const screenMarginY = (window.innerHeight - screenHeight) / 2;\r\n        newY = ((newY - screenMarginY) / screenHeight) * this.viewport.height;\r\n        newX = (newX / window.innerWidth) * this.viewport.width;\r\n      } else {\r\n        const screenWidth = window.innerHeight * this.aspectRatio;\r\n        const screenMarginX = (window.innerWidth - screenWidth) / 2;\r\n        newX = ((newX - screenMarginX) / screenWidth) * this.viewport.width;\r\n        newY = (newY / window.innerHeight) * this.viewport.height;\r\n      }\r\n    }\r\n\r\n    newX = (newX / this.viewport.width) * this.resolution.width;\r\n    newY = (newY / this.viewport.height) * this.resolution.height;\r\n\r\n    return new Vector(newX, newY);\r\n  }\r\n\r\n  /**\r\n   * Takes a coordinate in Excalibur screen space, and translates it to normal html page space. For example,\r\n   * this is where html elements might live if you want to position them relative to Excalibur.\r\n   *\r\n   * Excalibur screen space starts at the top left (0, 0) corner of the viewport, and extends to the\r\n   * bottom right corner (resolutionX, resolutionY)\r\n   * @param point\r\n   */\r\n  public screenToPageCoordinates(point: Vector): Vector {\r\n    let newX = point.x;\r\n    let newY = point.y;\r\n\r\n    newX = (newX / this.resolution.width) * this.viewport.width;\r\n    newY = (newY / this.resolution.height) * this.viewport.height;\r\n\r\n    if (this._isFullScreen) {\r\n      if (window.innerWidth / this.aspectRatio < window.innerHeight) {\r\n        const screenHeight = window.innerWidth / this.aspectRatio;\r\n        const screenMarginY = (window.innerHeight - screenHeight) / 2;\r\n        newY = (newY / this.viewport.height) * screenHeight + screenMarginY;\r\n        newX = (newX / this.viewport.width) * window.innerWidth;\r\n      } else {\r\n        const screenWidth = window.innerHeight * this.aspectRatio;\r\n        const screenMarginX = (window.innerWidth - screenWidth) / 2;\r\n        newX = (newX / this.viewport.width) * screenWidth + screenMarginX;\r\n        newY = (newY / this.viewport.height) * window.innerHeight;\r\n      }\r\n    }\r\n\r\n    if (!this._isFullScreen) {\r\n      newX += getPosition(this._canvas).x;\r\n      newY += getPosition(this._canvas).y;\r\n    }\r\n\r\n    return new Vector(newX, newY);\r\n  }\r\n\r\n  /**\r\n   * Takes a coordinate in Excalibur screen space, and translates it to Excalibur world space.\r\n   *\r\n   * World space is where [[Entity|entities]] in Excalibur live by default [[CoordPlane.World]]\r\n   * and extends infinitely out relative from the [[Camera]].\r\n   * @param point  Screen coordinate to convert\r\n   */\r\n  public screenToWorldCoordinates(point: Vector): Vector {\r\n    // the only difference between screen & world is the camera transform\r\n    if (this._camera) {\r\n      return this._camera.inverse.multiply(point);\r\n    }\r\n    return point.sub(vec(this.resolution.width / 2, this.resolution.height / 2));\r\n  }\r\n\r\n  /**\r\n   * Takes a coordinate in Excalibur world space, and translates it to Excalibur screen space.\r\n   *\r\n   * Screen space is where [[ScreenElement|screen elements]] and [[Entity|entities]] with [[CoordPlane.Screen]] live.\r\n   * @param point  World coordinate to convert\r\n   */\r\n  public worldToScreenCoordinates(point: Vector): Vector {\r\n    if (this._camera) {\r\n      return this._camera.transform.multiply(point);\r\n    }\r\n    return point.add(vec(this.resolution.width / 2, this.resolution.height / 2));\r\n  }\r\n\r\n  public pageToWorldCoordinates(point: Vector): Vector {\r\n    const screen = this.pageToScreenCoordinates(point);\r\n    return this.screenToWorldCoordinates(screen);\r\n  }\r\n\r\n  public worldToPageCoordinates(point: Vector): Vector {\r\n    const screen = this.worldToScreenCoordinates(point);\r\n    return this.screenToPageCoordinates(screen);\r\n  }\r\n\r\n  /**\r\n   * Returns a BoundingBox of the top left corner of the screen\r\n   * and the bottom right corner of the screen.\r\n   *\r\n   * World bounds are in world coordinates, useful for culling objects offscreen\r\n   */\r\n  public getWorldBounds(): BoundingBox {\r\n    const topLeft = this.screenToWorldCoordinates(Vector.Zero);\r\n    const right = topLeft.x + this.drawWidth;\r\n    const bottom = topLeft.y + this.drawHeight;\r\n\r\n    return new BoundingBox(topLeft.x, topLeft.y, right, bottom);\r\n  }\r\n\r\n  /**\r\n   * The width of the game canvas in pixels (physical width component of the\r\n   * resolution of the canvas element)\r\n   */\r\n  public get canvasWidth(): number {\r\n    return this.canvas.width;\r\n  }\r\n\r\n  /**\r\n   * Returns half width of the game canvas in pixels (half physical width component)\r\n   */\r\n  public get halfCanvasWidth(): number {\r\n    return this.canvas.width / 2;\r\n  }\r\n\r\n  /**\r\n   * The height of the game canvas in pixels, (physical height component of\r\n   * the resolution of the canvas element)\r\n   */\r\n  public get canvasHeight(): number {\r\n    return this.canvas.height;\r\n  }\r\n\r\n  /**\r\n   * Returns half height of the game canvas in pixels (half physical height component)\r\n   */\r\n  public get halfCanvasHeight(): number {\r\n    return this.canvas.height / 2;\r\n  }\r\n\r\n  /**\r\n   * Returns the width of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get drawWidth(): number {\r\n    if (this._camera) {\r\n      return this.resolution.width / this._camera.zoom;\r\n    }\r\n    return this.resolution.width;\r\n  }\r\n\r\n  /**\r\n   * Returns half the width of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get halfDrawWidth(): number {\r\n    return this.drawWidth / 2;\r\n  }\r\n\r\n  /**\r\n   * Returns the height of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get drawHeight(): number {\r\n    if (this._camera) {\r\n      return this.resolution.height / this._camera.zoom;\r\n    }\r\n    return this.resolution.height;\r\n  }\r\n\r\n  /**\r\n   * Returns half the height of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get halfDrawHeight(): number {\r\n    return this.drawHeight / 2;\r\n  }\r\n\r\n  /**\r\n   * Returns screen center coordinates including zoom and device pixel ratio.\r\n   */\r\n  public get center(): Vector {\r\n    return vec(this.halfDrawWidth, this.halfDrawHeight);\r\n  }\r\n\r\n  /**\r\n   * Returns the content area in screen space where it is safe to place content\r\n   */\r\n  public get contentArea(): BoundingBox {\r\n    return this._contentArea;\r\n  }\r\n\r\n  private _computeFit() {\r\n    document.body.style.margin = '0px';\r\n    document.body.style.overflow = 'hidden';\r\n    const aspect = this.aspectRatio;\r\n    let adjustedWidth = 0;\r\n    let adjustedHeight = 0;\r\n    if (window.innerWidth / aspect < window.innerHeight) {\r\n      adjustedWidth = window.innerWidth;\r\n      adjustedHeight = window.innerWidth / aspect;\r\n    } else {\r\n      adjustedWidth = window.innerHeight * aspect;\r\n      adjustedHeight = window.innerHeight;\r\n    }\r\n\r\n    this.viewport = {\r\n      width: adjustedWidth,\r\n      height: adjustedHeight\r\n    };\r\n    this._contentArea = BoundingBox.fromDimension(this.resolution.width, this.resolution.height, Vector.Zero);\r\n  }\r\n\r\n  private _contentArea: BoundingBox = new BoundingBox();\r\n  private _computeFitScreenAndFill() {\r\n    document.body.style.margin = '0px';\r\n    document.body.style.overflow = 'hidden';\r\n    const vw = window.innerWidth;\r\n    const vh = window.innerHeight;\r\n    this._computeFitAndFill(vw, vh);\r\n  }\r\n\r\n\r\n\r\n  private _computeFitContainerAndFill() {\r\n    document.body.style.margin = '0px';\r\n    document.body.style.overflow = 'hidden';\r\n    const parent = this.canvas.parentElement;\r\n    const vw = parent.clientWidth;\r\n    const vh = parent.clientHeight;\r\n    this._computeFitAndFill(vw, vh);\r\n  }\r\n\r\n  private _computeFitAndFill(vw: number, vh: number) {\r\n    this.viewport = {\r\n      width: vw,\r\n      height: vh\r\n    };\r\n    // if the current screen aspectRatio is less than the original aspectRatio\r\n    if (vw / vh <= this._contentResolution.width / this._contentResolution.height) {\r\n      // compute new resolution to match the original aspect ratio\r\n      this.resolution = {\r\n        width:  vw * this._contentResolution.width / vw,\r\n        height: vw * this._contentResolution.width / vw * vh / vw\r\n      };\r\n      const clip = (this.resolution.height - this._contentResolution.height) / 2;\r\n      this._contentArea = new BoundingBox({\r\n        top: clip,\r\n        left: 0,\r\n        right: this._contentResolution.width,\r\n        bottom: this.resolution.height - clip\r\n      });\r\n    } else {\r\n      this.resolution = {\r\n        width: vh *  this._contentResolution.height / vh * vw / vh,\r\n        height: vh *  this._contentResolution.height / vh\r\n      };\r\n      const clip = (this.resolution.width - this._contentResolution.width) / 2;\r\n      this._contentArea = new BoundingBox({\r\n        top: 0,\r\n        left: clip,\r\n        right: this.resolution.width - clip,\r\n        bottom: this._contentResolution.height\r\n      });\r\n    }\r\n  }\r\n\r\n  private _computeFitScreenAndZoom() {\r\n    document.body.style.margin = '0px';\r\n    document.body.style.overflow = 'hidden';\r\n    this.canvas.style.position = 'absolute';\r\n\r\n    const vw = window.innerWidth;\r\n    const vh = window.innerHeight;\r\n\r\n    this._computeFitAndZoom(vw, vh);\r\n  }\r\n\r\n  private _computeFitContainerAndZoom() {\r\n    document.body.style.margin = '0px';\r\n    document.body.style.overflow = 'hidden';\r\n    this.canvas.style.position = 'absolute';\r\n    const parent = this.canvas.parentElement;\r\n    parent.style.position = 'relative';\r\n    parent.style.overflow = 'hidden';\r\n\r\n    const vw = parent.clientWidth;\r\n    const vh = parent.clientHeight;\r\n\r\n    this._computeFitAndZoom(vw, vh);\r\n  }\r\n\r\n  private _computeFitAndZoom(vw: number, vh: number) {\r\n    const aspect = this.aspectRatio;\r\n    let adjustedWidth = 0;\r\n    let adjustedHeight = 0;\r\n    if (vw / aspect < vh) {\r\n      adjustedWidth = vw;\r\n      adjustedHeight = vw / aspect;\r\n    } else {\r\n      adjustedWidth = vh * aspect;\r\n      adjustedHeight = vh;\r\n    }\r\n\r\n    const scaleX = vw / adjustedWidth;\r\n    const scaleY = vh / adjustedHeight;\r\n\r\n    const maxScaleFactor = Math.max(scaleX, scaleY);\r\n\r\n    const zoomedWidth = adjustedWidth * maxScaleFactor;\r\n    const zoomedHeight = adjustedHeight * maxScaleFactor;\r\n\r\n    // Center zoomed dimension if bigger than the screen\r\n    if (zoomedWidth > vw) {\r\n      this.canvas.style.left = -(zoomedWidth - vw) / 2 + 'px';\r\n    } else {\r\n      this.canvas.style.left = '';\r\n    }\r\n\r\n    if (zoomedHeight > vh) {\r\n      this.canvas.style.top = -(zoomedHeight - vh) / 2 + 'px';\r\n    } else {\r\n      this.canvas.style.top = '';\r\n    }\r\n\r\n    this.viewport = {\r\n      width: zoomedWidth,\r\n      height: zoomedHeight\r\n    };\r\n\r\n    const bounds = BoundingBox.fromDimension(this.viewport.width, this.viewport.height, Vector.Zero);\r\n    // return safe area\r\n    if (this.viewport.width > vw) {\r\n      const clip = (this.viewport.width - vw)/this.viewport.width * this.resolution.width;\r\n      bounds.top = 0;\r\n      bounds.left = clip / 2;\r\n      bounds.right = this.resolution.width - clip / 2;\r\n      bounds.bottom = this.resolution.height;\r\n    }\r\n\r\n    if (this.viewport.height > vh) {\r\n      const clip = (this.viewport.height - vh)/this.viewport.height * this.resolution.height;\r\n      bounds.top = clip / 2;\r\n      bounds.left = 0;\r\n      bounds.bottom = this.resolution.height - clip / 2;\r\n      bounds.right = this.resolution.width;\r\n    }\r\n    this._contentArea = bounds;\r\n  }\r\n\r\n  private _computeFitContainer() {\r\n    const aspect = this.aspectRatio;\r\n    let adjustedWidth = 0;\r\n    let adjustedHeight = 0;\r\n    const parent = this.canvas.parentElement;\r\n    if (parent.clientWidth / aspect < parent.clientHeight) {\r\n      adjustedWidth = parent.clientWidth;\r\n      adjustedHeight = parent.clientWidth / aspect;\r\n    } else {\r\n      adjustedWidth = parent.clientHeight * aspect;\r\n      adjustedHeight = parent.clientHeight;\r\n    }\r\n\r\n    this.viewport = {\r\n      width: adjustedWidth,\r\n      height: adjustedHeight\r\n    };\r\n    this._contentArea = BoundingBox.fromDimension(this.resolution.width, this.resolution.height, Vector.Zero);\r\n  }\r\n\r\n  private _applyDisplayMode() {\r\n    this._setResolutionAndViewportByDisplayMode(this.parent);\r\n\r\n    // watch resizing\r\n    if (this.parent instanceof Window) {\r\n      this._browser.window.on('resize', this._resizeHandler);\r\n    } else {\r\n      this._resizeObserver = new ResizeObserver(() => {\r\n        this._resizeHandler();\r\n      });\r\n      this._resizeObserver.observe(this.parent);\r\n    }\r\n    this.parent.addEventListener('resize', this._resizeHandler);\r\n  }\r\n\r\n  /**\r\n   * Sets the resolution and viewport based on the selected display mode.\r\n   */\r\n  private _setResolutionAndViewportByDisplayMode(parent: HTMLElement | Window) {\r\n    if (this.displayMode === DisplayMode.FillContainer) {\r\n      this.resolution = {\r\n        width: (<HTMLElement> parent).clientWidth,\r\n        height: (<HTMLElement> parent).clientHeight\r\n      };\r\n\r\n      this.viewport = this.resolution;\r\n    }\r\n\r\n    if (this.displayMode === DisplayMode.FillScreen) {\r\n      document.body.style.margin = '0px';\r\n      document.body.style.overflow = 'hidden';\r\n      this.resolution = {\r\n        width: (<Window> parent).innerWidth,\r\n        height: (<Window> parent).innerHeight\r\n      };\r\n\r\n      this.viewport = this.resolution;\r\n    }\r\n\r\n    if (this.displayMode === DisplayMode.FitScreen) {\r\n      this._computeFit();\r\n    }\r\n\r\n    if (this.displayMode === DisplayMode.FitContainer) {\r\n      this._computeFitContainer();\r\n    }\r\n\r\n    if (this.displayMode === DisplayMode.FitScreenAndFill) {\r\n      this._computeFitScreenAndFill();\r\n    }\r\n\r\n    if (this.displayMode === DisplayMode.FitContainerAndFill){\r\n      this._computeFitContainerAndFill();\r\n    }\r\n\r\n    if (this.displayMode === DisplayMode.FitScreenAndZoom) {\r\n      this._computeFitScreenAndZoom();\r\n    }\r\n\r\n    if (this.displayMode === DisplayMode.FitContainerAndZoom){\r\n      this._computeFitContainerAndZoom();\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Internal class used to build instances of AudioContext\r\n */\r\n/* istanbul ignore next */\r\nexport class AudioContextFactory {\r\n  private static _INSTANCE: AudioContext = null;\r\n\r\n  public static create(): AudioContext {\r\n    if (!this._INSTANCE) {\r\n      if ((<any>window).AudioContext || (<any>window).webkitAudioContext) {\r\n        this._INSTANCE = new AudioContext();\r\n      }\r\n    }\r\n\r\n    return this._INSTANCE;\r\n  }\r\n}\r\n","import { AudioContextFactory } from '../Resources/Sound/AudioContext';\r\nimport { Logger } from './Log';\r\n\r\nexport interface LegacyWebAudioSource {\r\n  playbackState: string;\r\n  PLAYING_STATE: 'playing';\r\n  FINISHED_STATE: 'finished';\r\n}\r\n\r\n/**\r\n * Patch for detecting legacy web audio in browsers\r\n * @internal\r\n * @param source\r\n */\r\nfunction isLegacyWebAudioSource(source: any): source is LegacyWebAudioSource {\r\n  return !!source.playbackState;\r\n}\r\n\r\nexport class WebAudio {\r\n  private static _UNLOCKED: boolean = false;\r\n\r\n  /**\r\n   * Play an empty sound to unlock Safari WebAudio context. Call this function\r\n   * right after a user interaction event.\r\n   * @source https://paulbakaus.com/tutorials/html5/web-audio-on-ios/\r\n   */\r\n  static unlock(): Promise<boolean> {\r\n    const promise = new Promise<boolean>((resolve, reject) => {\r\n      if (WebAudio._UNLOCKED || !AudioContextFactory.create()) {\r\n        return resolve(true);\r\n      }\r\n      const unlockTimeoutTimer = setTimeout(() => {\r\n        Logger.getInstance().warn('Excalibur was unable to unlock the audio context, audio probably will not play in this browser.');\r\n        resolve(false);\r\n      }, 200);\r\n\r\n      const audioContext = AudioContextFactory.create();\r\n      audioContext.resume().then(\r\n        () => {\r\n          // create empty buffer and play it\r\n          const buffer = audioContext.createBuffer(1, 1, 22050);\r\n          const source = audioContext.createBufferSource();\r\n          let ended = false;\r\n\r\n          source.buffer = buffer;\r\n          source.connect(audioContext.destination);\r\n          source.onended = () => (ended = true);\r\n\r\n          source.start(0);\r\n\r\n          // by checking the play state after some time, we know if we're really unlocked\r\n          setTimeout(() => {\r\n            if (isLegacyWebAudioSource(source)) {\r\n              if (source.playbackState === source.PLAYING_STATE || source.playbackState === source.FINISHED_STATE) {\r\n                WebAudio._UNLOCKED = true;\r\n              }\r\n            } else {\r\n              if (audioContext.currentTime > 0 || ended) {\r\n                WebAudio._UNLOCKED = true;\r\n              }\r\n            }\r\n          }, 0);\r\n\r\n          clearTimeout(unlockTimeoutTimer);\r\n          resolve(true);\r\n        },\r\n        () => {\r\n          reject();\r\n        }\r\n      );\r\n    });\r\n\r\n    return promise;\r\n  }\r\n\r\n  static isUnlocked() {\r\n    return this._UNLOCKED;\r\n  }\r\n}\r\n","import { EventDispatcher } from './EventDispatcher';\r\nimport { Eventable } from './Interfaces/Evented';\r\n\r\n/**\r\n * Excalibur base class that provides basic functionality such as [[EventDispatcher]]\r\n * and extending abilities for vanilla Javascript projects\r\n */\r\nexport class Class implements Eventable {\r\n  /**\r\n   * Direct access to the game object event dispatcher.\r\n   */\r\n  public eventDispatcher: EventDispatcher;\r\n\r\n  constructor() {\r\n    this.eventDispatcher = new EventDispatcher();\r\n  }\r\n\r\n  /**\r\n   * Alias for `addEventListener`. You can listen for a variety of\r\n   * events off of the engine; see the events section below for a complete list.\r\n   * @param eventName  Name of the event to listen for\r\n   * @param handler    Event handler for the thrown event\r\n   */\r\n  public on(eventName: string, handler: (event: any) => void) {\r\n    this.eventDispatcher.on(eventName, handler);\r\n  }\r\n\r\n  /**\r\n   * Alias for `removeEventListener`. If only the eventName is specified\r\n   * it will remove all handlers registered for that specific event. If the eventName\r\n   * and the handler instance are specified only that handler will be removed.\r\n   *\r\n   * @param eventName  Name of the event to listen for\r\n   * @param handler    Event handler for the thrown event\r\n   */\r\n  public off(eventName: string, handler?: (event: any) => void) {\r\n    this.eventDispatcher.off(eventName, handler);\r\n  }\r\n\r\n  /**\r\n   * Emits a new event\r\n   * @param eventName   Name of the event to emit\r\n   * @param eventObject Data associated with this event\r\n   */\r\n  public emit(eventName: string, eventObject: any) {\r\n    this.eventDispatcher.emit(eventName, eventObject);\r\n  }\r\n\r\n  /**\r\n   * Once listens to an event one time, then unsubscribes from that event\r\n   *\r\n   * @param eventName The name of the event to subscribe to once\r\n   * @param handler   The handler of the event that will be auto unsubscribed\r\n   */\r\n  public once(eventName: string, handler: (event: any) => void) {\r\n    this.eventDispatcher.once(eventName, handler);\r\n  }\r\n}\r\n","import { Color } from '../Color';\r\nimport { Vector } from '../Math/vector';\r\n\r\n/**\r\n * A canvas linecap style. \"butt\" is the default flush style, \"round\" is a semi-circle cap with a radius half the width of\r\n * the line, and \"square\" is a rectangle that is an equal width and half height cap.\r\n */\r\nexport type LineCapStyle = 'butt' | 'round' | 'square';\r\n\r\n/* istanbul ignore next */\r\n/**\r\n * Draw a line on canvas context\r\n *\r\n * @param ctx The canvas context\r\n * @param color The color of the line\r\n * @param x1 The start x coordinate\r\n * @param y1 The start y coordinate\r\n * @param x2 The ending x coordinate\r\n * @param y2 The ending y coordinate\r\n * @param thickness The line thickness\r\n * @param cap The [[LineCapStyle]] (butt, round, or square)\r\n */\r\nexport function line(\r\n  ctx: CanvasRenderingContext2D,\r\n  color: Color = Color.Red,\r\n  x1: number,\r\n  y1: number,\r\n  x2: number,\r\n  y2: number,\r\n  thickness: number = 1,\r\n  cap: LineCapStyle = 'butt'\r\n) {\r\n  ctx.save();\r\n  ctx.beginPath();\r\n  ctx.lineWidth = thickness;\r\n  ctx.lineCap = cap;\r\n  ctx.strokeStyle = color.toString();\r\n  ctx.moveTo(x1, y1);\r\n  ctx.lineTo(x2, y2);\r\n  ctx.closePath();\r\n  ctx.stroke();\r\n  ctx.restore();\r\n}\r\n\r\n/* istanbul ignore next */\r\n/**\r\n * Draw the vector as a point onto the canvas.\r\n */\r\nexport function point(ctx: CanvasRenderingContext2D, color: Color = Color.Red, point: Vector): void {\r\n  ctx.beginPath();\r\n  ctx.strokeStyle = color.toString();\r\n  ctx.arc(point.x, point.y, 5, 0, Math.PI * 2);\r\n  ctx.closePath();\r\n  ctx.stroke();\r\n}\r\n\r\n/**\r\n * Draw the vector as a line onto the canvas starting a origin point.\r\n */\r\n/* istanbul ignore next */\r\n/**\r\n *\r\n */\r\nexport function vector(ctx: CanvasRenderingContext2D, color: Color, origin: Vector, vector: Vector, scale: number = 1.0): void {\r\n  const c = color ? color.toString() : 'blue';\r\n  const v = vector.scale(scale);\r\n  ctx.beginPath();\r\n  ctx.strokeStyle = c;\r\n  ctx.moveTo(origin.x, origin.y);\r\n  ctx.lineTo(origin.x + v.x, origin.y + v.y);\r\n  ctx.closePath();\r\n  ctx.stroke();\r\n}\r\n\r\n/**\r\n * Represents border radius values\r\n */\r\nexport interface BorderRadius {\r\n  /**\r\n   * Top-left\r\n   */\r\n  tl: number;\r\n  /**\r\n   * Top-right\r\n   */\r\n  tr: number;\r\n  /**\r\n   * Bottom-right\r\n   */\r\n  br: number;\r\n  /**\r\n   * Bottom-left\r\n   */\r\n  bl: number;\r\n}\r\n\r\n/**\r\n * Draw a round rectangle on a canvas context\r\n *\r\n * @param ctx The canvas context\r\n * @param x The top-left x coordinate\r\n * @param y The top-left y coordinate\r\n * @param width The width of the rectangle\r\n * @param height The height of the rectangle\r\n * @param radius The border radius of the rectangle\r\n * @param stroke The [[Color]] to stroke rectangle with\r\n * @param fill The [[Color]] to fill rectangle with\r\n */\r\nexport function roundRect(\r\n  ctx: CanvasRenderingContext2D,\r\n  x: number,\r\n  y: number,\r\n  width: number,\r\n  height: number,\r\n  radius: number | BorderRadius = 5,\r\n  stroke: Color = Color.White,\r\n  fill: Color = null\r\n) {\r\n  let br: BorderRadius;\r\n\r\n  if (typeof radius === 'number') {\r\n    br = { tl: radius, tr: radius, br: radius, bl: radius };\r\n  } else {\r\n    const defaultRadius: BorderRadius = { tl: 0, tr: 0, br: 0, bl: 0 };\r\n\r\n    for (const prop in defaultRadius) {\r\n      if (defaultRadius.hasOwnProperty(prop)) {\r\n        const side = <keyof BorderRadius>prop;\r\n        br[side] = radius[side] || defaultRadius[side];\r\n      }\r\n    }\r\n  }\r\n\r\n  ctx.beginPath();\r\n  ctx.moveTo(x + br.tl, y);\r\n  ctx.lineTo(x + width - br.tr, y);\r\n  ctx.quadraticCurveTo(x + width, y, x + width, y + br.tr);\r\n  ctx.lineTo(x + width, y + height - br.br);\r\n  ctx.quadraticCurveTo(x + width, y + height, x + width - br.br, y + height);\r\n  ctx.lineTo(x + br.bl, y + height);\r\n  ctx.quadraticCurveTo(x, y + height, x, y + height - br.bl);\r\n  ctx.lineTo(x, y + br.tl);\r\n  ctx.quadraticCurveTo(x, y, x + br.tl, y);\r\n  ctx.closePath();\r\n\r\n  if (fill) {\r\n    ctx.fillStyle = fill.toString();\r\n    ctx.fill();\r\n  }\r\n\r\n  if (stroke) {\r\n    ctx.strokeStyle = stroke.toString();\r\n    ctx.stroke();\r\n  }\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function circle(\r\n  ctx: CanvasRenderingContext2D,\r\n  x: number,\r\n  y: number,\r\n  radius: number,\r\n  stroke: Color = Color.White,\r\n  fill: Color = null\r\n) {\r\n  ctx.beginPath();\r\n  ctx.arc(x, y, radius, 0, Math.PI * 2);\r\n  ctx.closePath();\r\n\r\n  if (fill) {\r\n    ctx.fillStyle = fill.toString();\r\n    ctx.fill();\r\n  }\r\n\r\n  if (stroke) {\r\n    ctx.strokeStyle = stroke.toString();\r\n    ctx.stroke();\r\n  }\r\n}\r\n","import { Graphic, GraphicOptions } from './Graphic';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { Color } from '../Color';\r\nimport { Vector } from '../Math/vector';\r\nimport { BoundingBox } from '../Collision/BoundingBox';\r\nimport { watch } from '../Util/Watch';\r\nimport { TextureLoader } from './Context/texture-loader';\r\nimport { ImageFiltering } from './Filtering';\r\n\r\n\r\nexport interface RasterOptions {\r\n  /**\r\n   * Optionally specify a quality number, which is how much to scale the internal Raster. Default is 1.\r\n   *\r\n   * For example if the quality is set to 2, it doubles the internal raster bitmap in memory.\r\n   *\r\n   * Adjusting this value can be useful if you are working with small rasters.\r\n   */\r\n  quality?: number;\r\n  /**\r\n   * Optionally specify \"smoothing\" if you want antialiasing to apply to the raster's bitmap context, by default `false`\r\n   */\r\n  smoothing?: boolean;\r\n\r\n  /**\r\n   * Optionally specify the color of the raster's bitmap context, by default [[Color.Black]]\r\n   */\r\n  color?: Color;\r\n\r\n  /**\r\n   * Optionally specify the stroke color of the raster's bitmap context, by default undefined\r\n   */\r\n  strokeColor?: Color;\r\n\r\n  /**\r\n   * Optionally specify the line width of the raster's bitmap, by default 1 pixel\r\n   */\r\n  lineWidth?: number;\r\n\r\n  /**\r\n   * Optionally specify the line dash of the raster's bitmap, by default `[]` which means none\r\n   */\r\n  lineDash?: number[];\r\n\r\n  /**\r\n   * Optionally specify the line end style, default is \"butt\".\r\n   */\r\n  lineCap?: 'butt' | 'round' | 'square';\r\n\r\n  /**\r\n   * Optionally specify the padding to apply to the bitmap\r\n   */\r\n  padding?: number;\r\n\r\n  /**\r\n   * Optionally specify what image filtering mode should be used, [[ImageFiltering.Pixel]] for pixel art,\r\n   * [[ImageFiltering.Blended]] for hi-res art\r\n   *\r\n   * By default unset, rasters defer to the engine antialiasing setting\r\n   */\r\n  filtering?: ImageFiltering;\r\n}\r\n\r\n/**\r\n * A Raster is a Graphic that needs to be first painted to a HTMLCanvasElement before it can be drawn to the\r\n * [[ExcaliburGraphicsContext]]. This is useful for generating custom images using the 2D canvas api.\r\n *\r\n * Implementors must implement the [[Raster.execute]] method to rasterize their drawing.\r\n */\r\nexport abstract class Raster extends Graphic {\r\n  public filtering: ImageFiltering = null;\r\n  public lineCap: 'butt' | 'round' | 'square' = 'butt';\r\n  public quality: number = 1;\r\n\r\n  public _bitmap: HTMLCanvasElement;\r\n  protected _ctx: CanvasRenderingContext2D;\r\n  private _dirty: boolean = true;\r\n\r\n  constructor(options?: GraphicOptions & RasterOptions) {\r\n    super(options);\r\n    if (options) {\r\n      this.quality = options.quality ?? this.quality;\r\n      this.color = options.color ?? Color.Black;\r\n      this.strokeColor = options?.strokeColor;\r\n      this.smoothing = options.smoothing ?? this.smoothing;\r\n      this.lineWidth = options.lineWidth ?? this.lineWidth;\r\n      this.lineDash = options.lineDash ?? this.lineDash;\r\n      this.lineCap = options.lineCap ?? this.lineCap;\r\n      this.padding = options.padding ?? this.padding;\r\n      this.filtering = options.filtering ?? this.filtering;\r\n    }\r\n    this._bitmap = document.createElement('canvas');\r\n    // get the default canvas width/height as a fallback\r\n    const bitmapWidth = options?.width ?? this._bitmap.width;\r\n    const bitmapHeight = options?.height ?? this._bitmap.height;\r\n    this.width = bitmapWidth;\r\n    this.height = bitmapHeight;\r\n    const maybeCtx = this._bitmap.getContext('2d');\r\n    if (!maybeCtx) {\r\n      /* istanbul ignore next */\r\n      throw new Error('Browser does not support 2d canvas drawing, cannot create Raster graphic');\r\n    } else {\r\n      this._ctx = maybeCtx;\r\n    }\r\n  }\r\n\r\n  public cloneRasterOptions(): RasterOptions {\r\n    return {\r\n      color: this.color ? this.color.clone() : null,\r\n      strokeColor: this.strokeColor ? this.strokeColor.clone() : null,\r\n      smoothing: this.smoothing,\r\n      lineWidth: this.lineWidth,\r\n      lineDash: this.lineDash,\r\n      lineCap: this.lineCap,\r\n      quality: this.quality,\r\n      padding: this.padding\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Gets whether the graphic is dirty, this means there are changes that haven't been re-rasterized\r\n   */\r\n  public get dirty() {\r\n    return this._dirty;\r\n  }\r\n\r\n  /**\r\n   * Flags the graphic as dirty, meaning it must be re-rasterized before draw.\r\n   * This should be called any time the graphics state changes such that it affects the outputted drawing\r\n   */\r\n  public flagDirty() {\r\n    this._dirty = true;\r\n  }\r\n\r\n  private _originalWidth: number;\r\n  /**\r\n   * Gets or sets the current width of the Raster graphic. Setting the width will cause the raster\r\n   * to be flagged dirty causing a re-raster on the next draw.\r\n   *\r\n   * Any `padding`s or `quality` set will be factored into the width\r\n   */\r\n  public get width() {\r\n    return Math.abs(this._getTotalWidth() * this.scale.x);\r\n  }\r\n  public set width(value: number) {\r\n    value /= Math.abs(this.scale.x);\r\n    this._bitmap.width = value;\r\n    this._originalWidth = value;\r\n    this.flagDirty();\r\n  }\r\n\r\n  private _originalHeight: number;\r\n  /**\r\n   * Gets or sets the current height of the Raster graphic. Setting the height will cause the raster\r\n   * to be flagged dirty causing a re-raster on the next draw.\r\n   *\r\n   * Any `padding` or `quality` set will be factored into the height\r\n   */\r\n  public get height() {\r\n    return Math.abs(this._getTotalHeight() * this.scale.y);\r\n  }\r\n\r\n  public set height(value: number) {\r\n    value /= Math.abs(this.scale.y);\r\n    this._bitmap.height = value;\r\n    this._originalHeight = value;\r\n    this.flagDirty();\r\n  }\r\n\r\n  private _getTotalWidth() {\r\n    return ((this._originalWidth ?? this._bitmap.width) + this.padding * 2) * 1;\r\n  }\r\n\r\n  private _getTotalHeight() {\r\n    return ((this._originalHeight ?? this._bitmap.height) + this.padding * 2) * 1;\r\n  }\r\n\r\n  /**\r\n   * Returns the local bounds of the Raster including the padding\r\n   */\r\n  public get localBounds() {\r\n    return BoundingBox.fromDimension(this._getTotalWidth() * this.scale.x, this._getTotalHeight() * this.scale.y, Vector.Zero);\r\n  }\r\n\r\n  private _smoothing: boolean = false;\r\n  /**\r\n   * Gets or sets the smoothing (anti-aliasing of the graphic). Setting the height will cause the raster\r\n   * to be flagged dirty causing a re-raster on the next draw.\r\n   */\r\n  public get smoothing() {\r\n    return this._smoothing;\r\n  }\r\n  public set smoothing(value: boolean) {\r\n    this._smoothing = value;\r\n    this.flagDirty();\r\n  }\r\n\r\n  private _color: Color = watch(Color.Black, () => this.flagDirty());\r\n  /**\r\n   * Gets or sets the fillStyle of the Raster graphic. Setting the fillStyle will cause the raster to be\r\n   * flagged dirty causing a re-raster on the next draw.\r\n   */\r\n  public get color() {\r\n    return this._color;\r\n  }\r\n  public set color(value) {\r\n    this.flagDirty();\r\n    this._color = watch(value, () => this.flagDirty());\r\n  }\r\n\r\n  private _strokeColor: Color;\r\n  /**\r\n   * Gets or sets the strokeStyle of the Raster graphic. Setting the strokeStyle will cause the raster to be\r\n   * flagged dirty causing a re-raster on the next draw.\r\n   */\r\n  public get strokeColor() {\r\n    return this._strokeColor;\r\n  }\r\n  public set strokeColor(value) {\r\n    this.flagDirty();\r\n    this._strokeColor = watch(value, () => this.flagDirty());\r\n  }\r\n\r\n  private _lineWidth: number = 1;\r\n  /**\r\n   * Gets or sets the line width of the Raster graphic. Setting the lineWidth will cause the raster to be\r\n   * flagged dirty causing a re-raster on the next draw.\r\n   */\r\n  public get lineWidth() {\r\n    return this._lineWidth;\r\n  }\r\n  public set lineWidth(value) {\r\n    this._lineWidth = value;\r\n    this.flagDirty();\r\n  }\r\n\r\n  private _lineDash: number[] = [];\r\n  public get lineDash() {\r\n    return this._lineDash;\r\n  }\r\n\r\n  public set lineDash(value) {\r\n    this._lineDash = value;\r\n    this.flagDirty();\r\n  }\r\n\r\n  private _padding: number = 0;\r\n  public get padding() {\r\n    return this._padding;\r\n  }\r\n\r\n  public set padding(value: number) {\r\n    this._padding = value;\r\n    this.flagDirty();\r\n  }\r\n\r\n  /**\r\n   * Rasterize the graphic to a bitmap making it usable as in excalibur. Rasterize is called automatically if\r\n   * the graphic is [[Raster.dirty]] on the next [[Graphic.draw]] call\r\n   */\r\n  public rasterize(): void {\r\n    this._dirty = false;\r\n    this._ctx.clearRect(0, 0, this._getTotalWidth(), this._getTotalHeight());\r\n    this._ctx.save();\r\n    this._applyRasterProperties(this._ctx);\r\n    this.execute(this._ctx);\r\n    this._ctx.restore();\r\n    // The webgl texture needs to be updated if it exists after a raster cycle\r\n    TextureLoader.load(this._bitmap, this.filtering, true);\r\n  }\r\n\r\n  protected _applyRasterProperties(ctx: CanvasRenderingContext2D) {\r\n    this._bitmap.width = this._getTotalWidth() * this.quality;\r\n    this._bitmap.height = this._getTotalHeight() * this.quality;\r\n    ctx.scale(this.quality, this.quality);\r\n    ctx.translate(this.padding, this.padding);\r\n    ctx.imageSmoothingEnabled = this.smoothing;\r\n    ctx.lineWidth = this.lineWidth;\r\n    ctx.setLineDash(this.lineDash ?? ctx.getLineDash());\r\n    ctx.lineCap = this.lineCap;\r\n    ctx.strokeStyle = this.strokeColor?.toString();\r\n    ctx.fillStyle = this.color?.toString();\r\n  }\r\n\r\n  protected _drawImage(ex: ExcaliburGraphicsContext, x: number, y: number) {\r\n    if (this._dirty) {\r\n      this.rasterize();\r\n    }\r\n    ex.scale(1 / this.quality, 1 / this.quality);\r\n    ex.drawImage(this._bitmap, x, y);\r\n  }\r\n\r\n  /**\r\n   * Executes drawing implementation of the graphic, this is where the specific drawing code for the graphic\r\n   * should be implemented. Once `rasterize()` the graphic can be drawn to the [[ExcaliburGraphicsContext]] via `draw(...)`\r\n   * @param ctx Canvas to draw the graphic to\r\n   */\r\n  abstract execute(ctx: CanvasRenderingContext2D): void;\r\n}\r\n","import { GraphicOptions } from './Graphic';\r\nimport { Raster, RasterOptions } from './Raster';\r\n\r\nexport interface CanvasOptions {\r\n  draw?: (ctx: CanvasRenderingContext2D) => void;\r\n  cache?: boolean;\r\n}\r\n\r\n/**\r\n * A canvas [[Graphic]] to provide an adapter between the 2D Canvas API and the [[ExcaliburGraphicsContext]].\r\n *\r\n * The [[Canvas]] works by re-rastering a draw handler to a HTMLCanvasElement for every draw which is then passed\r\n * to the [[ExcaliburGraphicsContext]] implementation as a rendered image.\r\n *\r\n * **Low performance API**\r\n */\r\nexport class Canvas extends Raster {\r\n  /**\r\n   * Return the 2D graphics context of this canvas\r\n   */\r\n  public get ctx() {\r\n    return this._ctx;\r\n  }\r\n\r\n  constructor(private _options: GraphicOptions & RasterOptions & CanvasOptions) {\r\n    super(_options);\r\n  }\r\n\r\n  public clone(): Canvas {\r\n    return new Canvas({\r\n      ...this._options,\r\n      ...this.cloneGraphicOptions(),\r\n      ...this.cloneRasterOptions()\r\n    });\r\n  }\r\n\r\n  execute(ctx: CanvasRenderingContext2D): void {\r\n    if (this._options?.draw) {\r\n      this._options?.draw(ctx);\r\n    }\r\n    if (!this._options.cache) {\r\n      this.flagDirty();\r\n    }\r\n  }\r\n}\r\n","import { Audio } from './Audio';\r\n\r\nexport type ExResponseType = '' | 'arraybuffer' | 'blob' | 'document' | 'json' | 'text';\r\n\r\nexport interface ExResponseTypesLookup {\r\n  [name: string]: ExResponseType;\r\n}\r\n\r\nexport class ExResponse {\r\n  public static type: ExResponseTypesLookup = {\r\n    any: '',\r\n    blob: 'blob',\r\n    json: 'json',\r\n    text: 'text',\r\n    document: 'document',\r\n    arraybuffer: 'arraybuffer'\r\n  };\r\n}\r\n\r\n/**\r\n * Represents an audio implementation like [[WebAudioInstance]]\r\n */\r\nexport interface AudioImplementation {\r\n  /**\r\n   * XHR response type\r\n   */\r\n  responseType: ExResponseType;\r\n\r\n  /**\r\n   * Processes raw data and transforms into sound data\r\n   */\r\n  processData(data: Blob | ArrayBuffer): Promise<string | AudioBuffer>;\r\n\r\n  /**\r\n   * Factory method that returns an instance of a played audio track\r\n   */\r\n  createInstance(data: string | AudioBuffer): Audio;\r\n}\r\n","\r\nexport interface State {\r\n  name?: string;\r\n  transitions: string[];\r\n  onEnter?: (context: {from: string, eventData?: any, data: any}) => boolean | void;\r\n  onState?: () => any;\r\n  onExit?: (context: {to: string, data: any}) => boolean | void;\r\n  onUpdate?: (data: any, elapsedMs: number) => any;\r\n}\r\n\r\nexport interface StateMachineDescription {\r\n  start: string,\r\n  states: { [name: string]: State }\r\n}\r\n\r\nexport type PossibleStates<TMachine> = TMachine extends StateMachineDescription ? Extract<keyof TMachine['states'], string> : never;\r\n\r\nexport interface StateMachineState {\r\n  data: any;\r\n  currentState: string;\r\n}\r\n\r\nexport class StateMachine<TPossibleStates extends string, TData> {\r\n  public startState: State;\r\n  private _currentState: State;\r\n  public get currentState(): State {\r\n    return this._currentState;\r\n  }\r\n  public set currentState(state: State) {\r\n    this._currentState = state;\r\n  }\r\n  public states = new Map<string, State>();\r\n  public data: TData;\r\n\r\n  static create<TMachine extends StateMachineDescription, TData>(\r\n    machineDescription: TMachine, data?: TData): StateMachine<PossibleStates<TMachine>, TData> {\r\n    const machine = new StateMachine<PossibleStates<TMachine>, TData>();\r\n    machine.data = data;\r\n    for (const stateName in machineDescription.states) {\r\n      machine.states.set(stateName as PossibleStates<TMachine>, {\r\n        name: stateName,\r\n        ...machineDescription.states[stateName]\r\n      });\r\n    }\r\n\r\n    // validate transitions are states\r\n    for (const state of machine.states.values()) {\r\n      for (const transitionState of state.transitions) {\r\n        if (transitionState === '*') {\r\n          continue;\r\n        }\r\n        if (!machine.states.has(transitionState)) {\r\n          throw Error(\r\n            `Invalid state machine, state [${state.name}] has a transition to another state that doesn't exist [${transitionState}]`\r\n          );\r\n        }\r\n      }\r\n    }\r\n    machine.currentState = machine.startState = machine.states.get(machineDescription.start);\r\n    return machine;\r\n  }\r\n\r\n  in(state: TPossibleStates): boolean {\r\n    return this.currentState.name === state;\r\n  }\r\n\r\n  go(stateName: TPossibleStates, eventData?: any): boolean {\r\n    if (this.currentState.transitions.includes(stateName) || this.currentState.transitions.includes('*')) {\r\n      const potentialNewState = this.states.get(stateName);\r\n      if (this.currentState.onExit) {\r\n        const canExit = this.currentState?.onExit({to: potentialNewState.name, data: this.data});\r\n        if (canExit === false) {\r\n          return false;\r\n        }\r\n      }\r\n\r\n      if (potentialNewState?.onEnter) {\r\n        const canEnter = potentialNewState?.onEnter({from: this.currentState.name, eventData, data: this.data});\r\n        if (canEnter === false) {\r\n          return false;\r\n        }\r\n      }\r\n      // console.log(`${this.currentState.name} => ${potentialNewState.name} (${eventData})`);\r\n      this.currentState = potentialNewState;\r\n      if (this.currentState?.onState) {\r\n        this.currentState.onState();\r\n      }\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  update(elapsedMs: number) {\r\n    if (this.currentState.onUpdate) {\r\n      this.currentState.onUpdate(this.data, elapsedMs);\r\n    }\r\n  }\r\n\r\n  save(saveKey: string) {\r\n    localStorage.setItem(saveKey, JSON.stringify({\r\n      currentState: this.currentState.name,\r\n      data: this.data\r\n    }));\r\n  }\r\n\r\n  restore(saveKey: string) {\r\n    const state: StateMachineState = JSON.parse(localStorage.getItem(saveKey));\r\n    this.currentState = this.states.get(state.currentState);\r\n    this.data = state.data;\r\n  }\r\n}\r\n\r\n","import { StateMachine } from '../../Util/StateMachine';\r\nimport { Audio } from '../../Interfaces/Audio';\r\nimport { clamp } from '../../Math/util';\r\nimport { AudioContextFactory } from './AudioContext';\r\n\r\ninterface SoundState {\r\n  startedAt: number;\r\n  pausedAt: number;\r\n}\r\n\r\n/**\r\n * Internal class representing a Web Audio AudioBufferSourceNode instance\r\n * @see https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API\r\n */\r\nexport class WebAudioInstance implements Audio {\r\n  private _instance: AudioBufferSourceNode;\r\n  private _audioContext: AudioContext = AudioContextFactory.create();\r\n  private _volumeNode = this._audioContext.createGain();\r\n  private _playingResolve: (value: boolean) => void;\r\n  private _playingPromise = new Promise<boolean>((resolve) => {\r\n    this._playingResolve = resolve;\r\n  });\r\n  private _stateMachine = StateMachine.create({\r\n    start: 'STOPPED',\r\n    states: {\r\n      PLAYING: {\r\n        onEnter: ({data}: {from: string, data: SoundState}) => {\r\n\r\n          // Buffer nodes are single use\r\n          this._createNewBufferSource();\r\n          this._handleEnd();\r\n          this._instance.start(0, data.pausedAt * this._playbackRate, this.duration);\r\n          data.startedAt = (this._audioContext.currentTime - data.pausedAt);\r\n          data.pausedAt = 0;\r\n        },\r\n        onState: () => this._playStarted(),\r\n        onExit: ({to}) => {\r\n          // If you've exited early only resolve if explicitly STOPPED\r\n          if (to === 'STOPPED') {\r\n            this._playingResolve(true);\r\n          }\r\n          // Whenever you're not playing... you stop!\r\n          this._instance.onended = null; // disconnect the wired on-end handler\r\n          this._instance.disconnect();\r\n          this._instance.stop(0);\r\n          this._instance = null;\r\n        },\r\n        transitions: ['STOPPED', 'PAUSED', 'SEEK']\r\n      },\r\n      SEEK: {\r\n        onEnter: ({ eventData: position, data }: {eventData?: number, data: SoundState}) => {\r\n          data.pausedAt = (position ?? 0) / this._playbackRate;\r\n          data.startedAt = 0;\r\n        },\r\n        transitions: ['*']\r\n      },\r\n      STOPPED: {\r\n        onEnter: ({data}: {from: string, data: SoundState}) => {\r\n          data.pausedAt = 0;\r\n          data.startedAt = 0;\r\n          this._playingResolve(true);\r\n        },\r\n        transitions: ['PLAYING', 'PAUSED', 'SEEK']\r\n      },\r\n      PAUSED: {\r\n        onEnter: ({data}: {data: SoundState}) => {\r\n          // Playback rate will be a scale factor of how fast/slow the audio is being played\r\n          // default is 1.0\r\n          // we need to invert it to get the time scale\r\n          data.pausedAt = (this._audioContext.currentTime - data.startedAt);\r\n        },\r\n        transitions: ['PLAYING', 'STOPPED', 'SEEK']\r\n      }\r\n    }\r\n  }, {\r\n    startedAt: 0,\r\n    pausedAt: 0\r\n  } as SoundState);\r\n\r\n  private _createNewBufferSource() {\r\n    this._instance = this._audioContext.createBufferSource();\r\n    this._instance.buffer = this._src;\r\n    this._instance.loop = this.loop;\r\n    this._instance.playbackRate.value = this._playbackRate;\r\n    this._instance.connect(this._volumeNode);\r\n    this._volumeNode.connect(this._audioContext.destination);\r\n  }\r\n\r\n  private _handleEnd() {\r\n    if (!this.loop) {\r\n      this._instance.onended = () => {\r\n        this._playingResolve(true);\r\n      };\r\n    }\r\n  }\r\n\r\n  private _volume = 1;\r\n  private _loop = false;\r\n  // eslint-disable-next-line @typescript-eslint/no-empty-function\r\n  private _playStarted: () => any = () => {};\r\n  public set loop(value: boolean) {\r\n    this._loop = value;\r\n\r\n    if (this._instance) {\r\n      this._instance.loop = value;\r\n      if (!this.loop) {\r\n        this._instance.onended = () => {\r\n          this._playingResolve(true);\r\n        };\r\n      }\r\n    }\r\n  }\r\n  public get loop(): boolean {\r\n    return this._loop;\r\n  }\r\n\r\n  public set volume(value: number) {\r\n    value = clamp(value, 0, 1.0);\r\n\r\n    this._volume = value;\r\n\r\n    if (this._stateMachine.in('PLAYING') && this._volumeNode.gain.setTargetAtTime) {\r\n      // https://developer.mozilla.org/en-US/docs/Web/API/AudioParam/setTargetAtTime\r\n      // After each .1 seconds timestep, the target value will ~63.2% closer to the target value.\r\n      // This exponential ramp provides a more pleasant transition in gain\r\n      this._volumeNode.gain.setTargetAtTime(value, this._audioContext.currentTime, 0.1);\r\n    } else {\r\n      this._volumeNode.gain.value = value;\r\n    }\r\n  }\r\n  public get volume(): number {\r\n    return this._volume;\r\n  }\r\n\r\n  private _duration: number | undefined;\r\n  /**\r\n   * Returns the set duration to play, otherwise returns the total duration if unset\r\n   */\r\n  public get duration() {\r\n    return this._duration ?? this.getTotalPlaybackDuration();\r\n  }\r\n\r\n  /**\r\n   * Set the duration that this audio should play.\r\n   *\r\n   * Note: if you seek to a specific point the duration will start from that point, for example\r\n   *\r\n   * If you have a 10 second clip, seek to 5 seconds, then set the duration to 2, it will play the clip from 5-7 seconds.\r\n   */\r\n  public set duration(duration: number) {\r\n    this._duration = duration;\r\n  }\r\n\r\n  constructor(private _src: AudioBuffer) {\r\n    this._createNewBufferSource();\r\n  }\r\n\r\n  public isPlaying() {\r\n    return this._stateMachine.in('PLAYING');\r\n  }\r\n\r\n  public isPaused() {\r\n    return this._stateMachine.in('PAUSED') || this._stateMachine.in('SEEK');\r\n  }\r\n\r\n  // eslint-disable-next-line @typescript-eslint/no-empty-function\r\n  public play(playStarted: () => any = () => {}) {\r\n    this._playStarted = playStarted;\r\n    this._stateMachine.go('PLAYING');\r\n    return this._playingPromise;\r\n  }\r\n\r\n  public pause() {\r\n    this._stateMachine.go('PAUSED');\r\n  }\r\n\r\n  public stop() {\r\n    this._stateMachine.go('STOPPED');\r\n  }\r\n\r\n  public seek(position: number) {\r\n    this._stateMachine.go('PAUSED');\r\n    this._stateMachine.go('SEEK', position);\r\n  }\r\n\r\n  public getTotalPlaybackDuration() {\r\n    return this._src.duration;\r\n  }\r\n\r\n  public getPlaybackPosition() {\r\n    const {pausedAt, startedAt} =  this._stateMachine.data;\r\n    if (pausedAt) {\r\n      return pausedAt * this._playbackRate;\r\n    }\r\n    if (startedAt) {\r\n      return (this._audioContext.currentTime - startedAt) * this._playbackRate;\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  private _playbackRate = 1.0;\r\n  public set playbackRate(playbackRate: number) {\r\n    this._instance.playbackRate.value = this._playbackRate = playbackRate;\r\n  }\r\n\r\n  public get playbackRate() {\r\n    return this._instance.playbackRate.value;\r\n  }\r\n}\r\n","import { GameEvent } from '../Events';\r\nimport { Sound } from '../Resources/Sound/Sound';\r\nimport { Actor } from '../Actor';\r\nimport { WebAudioInstance } from '../Resources/Sound/WebAudioInstance';\r\n\r\nexport class MediaEvent extends GameEvent<Sound> {\r\n  /**\r\n   * Media event cannot bubble\r\n   */\r\n  public set bubbles(_value: boolean) {\r\n    // stubbed\r\n  }\r\n  /**\r\n   * Media event cannot bubble\r\n   */\r\n  public get bubbles(): boolean {\r\n    return false;\r\n  }\r\n  /**\r\n   * Media event cannot bubble, so they have no path\r\n   */\r\n  protected get _path(): Actor[] {\r\n    return null;\r\n  }\r\n  /**\r\n   * Media event cannot bubble, so they have no path\r\n   */\r\n  protected set _path(_val: Actor[]) {\r\n    // stubbed\r\n  }\r\n\r\n  constructor(public target: Sound, protected _name: string = 'MediaEvent') {\r\n    super();\r\n  }\r\n\r\n  /**\r\n   * Prevents event from bubbling\r\n   */\r\n  public stopPropagation(): void {\r\n    /**\r\n     * Stub\r\n     */\r\n  }\r\n  /**\r\n   * Action, that calls when event happens\r\n   */\r\n  public action(): void {\r\n    /**\r\n     * Stub\r\n     */\r\n  }\r\n  /**\r\n   * Propagate event further through event path\r\n   */\r\n  public propagate(): void {\r\n    /**\r\n     * Stub\r\n     */\r\n  }\r\n\r\n  public layPath(_actor: Actor): void {\r\n    /**\r\n     * Stub\r\n     */\r\n  }\r\n}\r\n\r\nexport class NativeSoundEvent extends MediaEvent {\r\n  constructor(target: Sound, public track?: WebAudioInstance) {\r\n    super(target, 'NativeSoundEvent');\r\n  }\r\n}\r\n\r\nexport class NativeSoundProcessedEvent extends MediaEvent {\r\n  public data: string | AudioBuffer;\r\n\r\n  constructor(target: Sound, private _processedData: string | AudioBuffer) {\r\n    super(target, 'NativeSoundProcessedEvent');\r\n\r\n    this.data = this._processedData;\r\n  }\r\n}\r\n","import { Logger } from './Log';\r\n\r\n/**\r\n * Whether or not the browser can play this file as HTML5 Audio\r\n */\r\nexport function canPlayFile(file: string): boolean {\r\n  try {\r\n    const a = new Audio();\r\n    const filetype = /.*\\.([A-Za-z0-9]+)$/;\r\n    const type = file.match(filetype)[1];\r\n    if (a.canPlayType('audio/' + type)) {\r\n      return true;\r\n    } else {\r\n      return false;\r\n    }\r\n  } catch (e) {\r\n    Logger.getInstance().warn('Cannot determine audio support, assuming no support for the Audio Tag', e);\r\n    return false;\r\n  }\r\n}\r\n","import { ExResponse } from '../../Interfaces/AudioImplementation';\r\nimport { Audio } from '../../Interfaces/Audio';\r\nimport { Engine } from '../../Engine';\r\nimport { Resource } from '../Resource';\r\nimport { WebAudioInstance } from './WebAudioInstance';\r\nimport { AudioContextFactory } from './AudioContext';\r\nimport { NativeSoundEvent, NativeSoundProcessedEvent } from '../../Events/MediaEvents';\r\nimport { canPlayFile } from '../../Util/Sound';\r\nimport { Loadable } from '../../Interfaces/Index';\r\nimport { Logger } from '../../Util/Log';\r\nimport { Class } from '../../Class';\r\n\r\n/**\r\n * The [[Sound]] object allows games built in Excalibur to load audio\r\n * components, from soundtracks to sound effects. [[Sound]] is an [[Loadable]]\r\n * which means it can be passed to a [[Loader]] to pre-load before a game or level.\r\n */\r\nexport class Sound extends Class implements Audio, Loadable<AudioBuffer> {\r\n  public logger: Logger = Logger.getInstance();\r\n  public data: AudioBuffer;\r\n  private _resource: Resource<ArrayBuffer>;\r\n  /**\r\n   * Indicates whether the clip should loop when complete\r\n   * @param value  Set the looping flag\r\n   */\r\n  public set loop(value: boolean) {\r\n    this._loop = value;\r\n\r\n    for (const track of this._tracks) {\r\n      track.loop = this._loop;\r\n    }\r\n\r\n    this.logger.debug('Set loop for all instances of sound', this.path, 'to', this._loop);\r\n  }\r\n  public get loop(): boolean {\r\n    return this._loop;\r\n  }\r\n\r\n  public set volume(value: number) {\r\n    this._volume = value;\r\n\r\n    for (const track of this._tracks) {\r\n      track.volume = this._volume;\r\n    }\r\n\r\n    this.emit('volumechange', new NativeSoundEvent(this));\r\n\r\n    this.logger.debug('Set loop for all instances of sound', this.path, 'to', this._volume);\r\n  }\r\n  public get volume(): number {\r\n    return this._volume;\r\n  }\r\n\r\n  private _duration: number | undefined;\r\n  /**\r\n   * Get the duration that this audio should play. If unset the total natural playback duration will be used.\r\n   */\r\n  public get duration(): number | undefined {\r\n    return this._duration;\r\n  }\r\n  /**\r\n   * Set the duration that this audio should play. If unset the total natural playback duration will be used.\r\n   *\r\n   * Note: if you seek to a specific point the duration will start from that point, for example\r\n   *\r\n   * If you have a 10 second clip, seek to 5 seconds, then set the duration to 2, it will play the clip from 5-7 seconds.\r\n   */\r\n  public set duration(duration: number | undefined){\r\n    this._duration = duration;\r\n  }\r\n\r\n  /**\r\n   * Return array of Current AudioInstances playing or being paused\r\n   */\r\n  public get instances(): Audio[] {\r\n    return this._tracks;\r\n  }\r\n\r\n  public get path() {\r\n    return this._resource.path;\r\n  }\r\n\r\n  public set path(val: string) {\r\n    this._resource.path = val;\r\n  }\r\n\r\n  private _loop = false;\r\n  private _volume = 1;\r\n  private _isStopped = false;\r\n  // private _isPaused = false;\r\n  private _tracks: Audio[] = [];\r\n  private _engine: Engine;\r\n  private _wasPlayingOnHidden: boolean = false;\r\n  private _playbackRate = 1.0;\r\n  private _audioContext = AudioContextFactory.create();\r\n\r\n  /**\r\n   * @param paths A list of audio sources (clip.wav, clip.mp3, clip.ogg) for this audio clip. This is done for browser compatibility.\r\n   */\r\n  constructor(...paths: string[]) {\r\n    super();\r\n    this._resource = new Resource('', ExResponse.type.arraybuffer);\r\n    /**\r\n     * Chrome : MP3, WAV, Ogg\r\n     * Firefox : WAV, Ogg,\r\n     * IE : MP3, WAV coming soon\r\n     * Safari MP3, WAV, Ogg\r\n     */\r\n    for (const path of paths) {\r\n      if (canPlayFile(path)) {\r\n        this.path = path;\r\n        break;\r\n      }\r\n    }\r\n\r\n    if (!this.path) {\r\n      this.logger.warn('This browser does not support any of the audio files specified:', paths.join(', '));\r\n      this.logger.warn('Attempting to use', paths[0]);\r\n      this.path = paths[0]; // select the first specified\r\n    }\r\n  }\r\n\r\n  public isLoaded() {\r\n    return !!this.data;\r\n  }\r\n\r\n  public async load(): Promise<AudioBuffer> {\r\n    if (this.data) {\r\n      return this.data;\r\n    }\r\n    const arraybuffer = await this._resource.load();\r\n    const audiobuffer = await this.decodeAudio(arraybuffer.slice(0));\r\n    this._duration = this._duration ?? audiobuffer?.duration ?? undefined;\r\n    this.emit('processed', new NativeSoundProcessedEvent(this, audiobuffer));\r\n    return this.data = audiobuffer;\r\n  }\r\n\r\n  public async decodeAudio(data: ArrayBuffer): Promise<AudioBuffer> {\r\n    try {\r\n      return await this._audioContext.decodeAudioData(data.slice(0));\r\n    } catch (e) {\r\n      this.logger.error(\r\n        'Unable to decode ' +\r\n          ' this browser may not fully support this format, or the file may be corrupt, ' +\r\n          'if this is an mp3 try removing id3 tags and album art from the file.'\r\n      );\r\n      return await Promise.reject();\r\n    }\r\n  }\r\n\r\n  public wireEngine(engine: Engine) {\r\n    if (engine) {\r\n      this._engine = engine;\r\n\r\n      this._engine.on('hidden', () => {\r\n        if (engine.pauseAudioWhenHidden && this.isPlaying()) {\r\n          this._wasPlayingOnHidden = true;\r\n          this.pause();\r\n        }\r\n      });\r\n\r\n      this._engine.on('visible', () => {\r\n        if (engine.pauseAudioWhenHidden && this._wasPlayingOnHidden) {\r\n          this.play();\r\n          this._wasPlayingOnHidden = false;\r\n        }\r\n      });\r\n\r\n      this._engine.on('start', () => {\r\n        this._isStopped = false;\r\n      });\r\n\r\n      this._engine.on('stop', () => {\r\n        this.stop();\r\n        this._isStopped = true;\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns how many instances of the sound are currently playing\r\n   */\r\n  public instanceCount(): number {\r\n    return this._tracks.length;\r\n  }\r\n\r\n  /**\r\n   * Whether or not the sound is playing right now\r\n   */\r\n  public isPlaying(): boolean {\r\n    return this._tracks.some((t) => t.isPlaying());\r\n  }\r\n\r\n  public isPaused(): boolean {\r\n    return this._tracks.some(t => t.isPaused());\r\n  }\r\n\r\n  /**\r\n   * Play the sound, returns a promise that resolves when the sound is done playing\r\n   * An optional volume argument can be passed in to play the sound. Max volume is 1.0\r\n   */\r\n  public play(volume?: number): Promise<boolean> {\r\n    if (!this.isLoaded()) {\r\n      this.logger.warn('Cannot start playing. Resource', this.path, 'is not loaded yet');\r\n\r\n      return Promise.resolve(true);\r\n    }\r\n\r\n    if (this._isStopped) {\r\n      this.logger.warn('Cannot start playing. Engine is in a stopped state.');\r\n      return Promise.resolve(false);\r\n    }\r\n\r\n    this.volume = volume || this.volume;\r\n\r\n    if (this.isPaused()) {\r\n      return this._resumePlayback();\r\n    } else {\r\n      return this._startPlayback();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop the sound, and do not rewind\r\n   */\r\n  public pause() {\r\n    if (!this.isPlaying()) {\r\n      return;\r\n    }\r\n\r\n    for (const track of this._tracks) {\r\n      track.pause();\r\n    }\r\n\r\n    this.emit('pause', new NativeSoundEvent(this));\r\n\r\n    this.logger.debug('Paused all instances of sound', this.path);\r\n  }\r\n\r\n  /**\r\n   * Stop the sound if it is currently playing and rewind the track. If the sound is not playing, rewinds the track.\r\n   */\r\n  public stop() {\r\n    for (const track of this._tracks) {\r\n      track.stop();\r\n    }\r\n\r\n    this.emit('stop', new NativeSoundEvent(this));\r\n\r\n    this._tracks.length = 0;\r\n    this.logger.debug('Stopped all instances of sound', this.path);\r\n  }\r\n\r\n  public get playbackRate(): number {\r\n    return this._playbackRate;\r\n  }\r\n\r\n  public set playbackRate(playbackRate: number) {\r\n    this._playbackRate = playbackRate;\r\n    this._tracks.forEach(t => {\r\n      t.playbackRate = this._playbackRate;\r\n    });\r\n  }\r\n\r\n  public seek(position: number, trackId = 0) {\r\n    if (this._tracks.length === 0) {\r\n      this._getTrackInstance(this.data);\r\n    }\r\n\r\n    this._tracks[trackId].seek(position);\r\n  }\r\n\r\n  public getTotalPlaybackDuration() {\r\n    return this.data.duration;\r\n  }\r\n\r\n  /**\r\n   * Return the current playback time of the playing track in seconds from the start.\r\n   *\r\n   * Optionally specify the track to query if multiple are playing at once.\r\n   * @param trackId\r\n   */\r\n  public getPlaybackPosition(trackId = 0) {\r\n    if (this._tracks.length) {\r\n      return this._tracks[trackId].getPlaybackPosition();\r\n    }\r\n    return 0;\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Get Id of provided AudioInstance in current trackList\r\n   * @param track [[Audio]] which Id is to be given\r\n   */\r\n  public getTrackId(track: Audio): number {\r\n    return this._tracks.indexOf(track);\r\n  }\r\n\r\n  private async _resumePlayback(): Promise<boolean> {\r\n    if (this.isPaused) {\r\n      const resumed: Promise<boolean>[] = [];\r\n      // ensure we resume *current* tracks (if paused)\r\n      for (const track of this._tracks) {\r\n        resumed.push(track.play().then(() => {\r\n          this.emit('playbackend', new NativeSoundEvent(this, track as WebAudioInstance));\r\n          this._tracks.splice(this.getTrackId(track), 1);\r\n          return true;\r\n        }));\r\n      }\r\n\r\n      this.emit('resume', new NativeSoundEvent(this));\r\n\r\n      this.logger.debug('Resuming paused instances for sound', this.path, this._tracks);\r\n      // resolve when resumed tracks are done\r\n      await Promise.all(resumed);\r\n    }\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Starts playback, returns a promise that resolves when playback is complete\r\n   */\r\n  private async _startPlayback(): Promise<boolean> {\r\n    const track = await this._getTrackInstance(this.data);\r\n\r\n    const complete = await track.play(() => {\r\n      this.emit('playbackstart', new NativeSoundEvent(this, track));\r\n      this.logger.debug('Playing new instance for sound', this.path);\r\n    });\r\n\r\n    // when done, remove track\r\n    this.emit('playbackend', new NativeSoundEvent(this, track));\r\n    this._tracks.splice(this.getTrackId(track), 1);\r\n\r\n    return complete;\r\n  }\r\n\r\n  private _getTrackInstance(data: AudioBuffer): WebAudioInstance {\r\n    const newTrack = new WebAudioInstance(data);\r\n\r\n    newTrack.loop = this.loop;\r\n    newTrack.volume = this.volume;\r\n    newTrack.duration = this.duration;\r\n    newTrack.playbackRate = this._playbackRate;\r\n\r\n    this._tracks.push(newTrack);\r\n\r\n    return newTrack;\r\n  }\r\n}\r\n","import { Color } from './Color';\r\nimport { WebAudio } from './Util/WebAudio';\r\nimport { Engine } from './Engine';\r\nimport { Loadable } from './Interfaces/Loadable';\r\nimport { Class } from './Class';\r\nimport * as DrawUtil from './Util/DrawUtil';\r\n\r\nimport logoImg from './Loader.logo.png';\r\nimport loaderCss from './Loader.css';\r\nimport { Canvas } from './Graphics/Canvas';\r\nimport { Vector } from './Math/vector';\r\nimport { delay } from './Util/Util';\r\nimport { ImageFiltering } from './Graphics/Filtering';\r\nimport { clamp } from './Math/util';\r\nimport { Sound } from './Resources/Sound/Sound';\r\nimport { Future } from './Util/Future';\r\n\r\n/**\r\n * Pre-loading assets\r\n *\r\n * The loader provides a mechanism to preload multiple resources at\r\n * one time. The loader must be passed to the engine in order to\r\n * trigger the loading progress bar.\r\n *\r\n * The [[Loader]] itself implements [[Loadable]] so you can load loaders.\r\n *\r\n * ## Example: Pre-loading resources for a game\r\n *\r\n * ```js\r\n * // create a loader\r\n * var loader = new ex.Loader();\r\n *\r\n * // create a resource dictionary (best practice is to keep a separate file)\r\n * var resources = {\r\n *   TextureGround: new ex.Texture(\"/images/textures/ground.png\"),\r\n *   SoundDeath: new ex.Sound(\"/sound/death.wav\", \"/sound/death.mp3\")\r\n * };\r\n *\r\n * // loop through dictionary and add to loader\r\n * for (var loadable in resources) {\r\n *   if (resources.hasOwnProperty(loadable)) {\r\n *     loader.addResource(resources[loadable]);\r\n *   }\r\n * }\r\n *\r\n * // start game\r\n * game.start(loader).then(function () {\r\n *   console.log(\"Game started!\");\r\n * });\r\n * ```\r\n *\r\n * ## Customize the Loader\r\n *\r\n * The loader can be customized to show different, text, logo, background color, and button.\r\n *\r\n * ```typescript\r\n * const loader = new ex.Loader([playerTexture]);\r\n *\r\n * // The loaders button text can simply modified using this\r\n * loader.playButtonText = 'Start the best game ever';\r\n *\r\n * // The logo can be changed by inserting a base64 image string here\r\n *\r\n * loader.logo = 'data:image/png;base64,iVBORw...';\r\n * loader.logoWidth = 15;\r\n * loader.logoHeight = 14;\r\n *\r\n * // The background color can be changed like so by supplying a valid CSS color string\r\n *\r\n * loader.backgroundColor = 'red'\r\n * loader.backgroundColor = '#176BAA'\r\n *\r\n * // To build a completely new button\r\n * loader.startButtonFactory = () => {\r\n *     let myButton = document.createElement('button');\r\n *     myButton.textContent = 'The best button';\r\n *     return myButton;\r\n * };\r\n *\r\n * engine.start(loader).then(() => {});\r\n * ```\r\n */\r\nexport class Loader extends Class implements Loadable<Loadable<any>[]> {\r\n  public canvas: Canvas = new Canvas({\r\n    filtering: ImageFiltering.Blended,\r\n    smoothing: true,\r\n    cache: true,\r\n    draw: this.draw.bind(this)\r\n  });\r\n  private _resourceList: Loadable<any>[] = [];\r\n  private _index = 0;\r\n\r\n  private _playButtonShown: boolean = false;\r\n  private _resourceCount: number = 0;\r\n  private _numLoaded: number = 0;\r\n  private _progressCounts: { [key: string]: number } = {};\r\n  private _totalCounts: { [key: string]: number } = {};\r\n  private _engine: Engine;\r\n\r\n  // logo drawing stuff\r\n\r\n  // base64 string encoding of the excalibur logo (logo-white.png)\r\n  public logo = logoImg;\r\n  public logoWidth = 468;\r\n  public logoHeight = 118;\r\n  /**\r\n   * Positions the top left corner of the logo image\r\n   * If not set, the loader automatically positions the logo\r\n   */\r\n  public logoPosition: Vector | null;\r\n  /**\r\n   * Positions the top left corner of the play button.\r\n   * If not set, the loader automatically positions the play button\r\n   */\r\n  public playButtonPosition: Vector | null;\r\n  /**\r\n   * Positions the top left corner of the loading bar\r\n   * If not set, the loader automatically positions the loading bar\r\n   */\r\n  public loadingBarPosition: Vector | null;\r\n\r\n  /**\r\n   * Gets or sets the color of the loading bar, default is [[Color.White]]\r\n   */\r\n  public loadingBarColor: Color = Color.White;\r\n\r\n  /**\r\n   * Gets or sets the background color of the loader as a hex string\r\n   */\r\n  public backgroundColor: string = '#176BAA';\r\n\r\n  protected _imageElement: HTMLImageElement;\r\n  protected get _image() {\r\n    if (!this._imageElement) {\r\n      this._imageElement = new Image();\r\n      this._imageElement.src = this.logo;\r\n    }\r\n\r\n    return this._imageElement;\r\n  }\r\n\r\n  public suppressPlayButton: boolean = false;\r\n  public get playButtonRootElement(): HTMLElement | null {\r\n    return this._playButtonRootElement;\r\n  }\r\n  public get playButtonElement(): HTMLButtonElement | null {\r\n    return this._playButtonElement;\r\n  }\r\n  protected _playButtonRootElement: HTMLElement;\r\n  protected _playButtonElement: HTMLButtonElement;\r\n  protected _styleBlock: HTMLStyleElement;\r\n  /** Loads the css from Loader.css */\r\n  protected _playButtonStyles: string = loaderCss.toString();\r\n  protected get _playButton() {\r\n    const existingRoot = document.getElementById('excalibur-play-root');\r\n    if (existingRoot) {\r\n      this._playButtonRootElement = existingRoot;\r\n    }\r\n    if (!this._playButtonRootElement) {\r\n      this._playButtonRootElement = document.createElement('div');\r\n      this._playButtonRootElement.id = 'excalibur-play-root';\r\n      this._playButtonRootElement.style.position = 'absolute';\r\n      document.body.appendChild(this._playButtonRootElement);\r\n    }\r\n    if (!this._styleBlock) {\r\n      this._styleBlock = document.createElement('style');\r\n      this._styleBlock.textContent = this._playButtonStyles;\r\n      document.head.appendChild(this._styleBlock);\r\n    }\r\n    if (!this._playButtonElement) {\r\n      this._playButtonElement = this.startButtonFactory();\r\n      this._playButtonRootElement.appendChild(this._playButtonElement);\r\n    }\r\n    return this._playButtonElement;\r\n  }\r\n\r\n  /**\r\n   * Get/set play button text\r\n   */\r\n  public playButtonText: string = 'Play game';\r\n\r\n  /**\r\n   * Return a html button element for excalibur to use as a play button\r\n   */\r\n  public startButtonFactory = () => {\r\n    let buttonElement: HTMLButtonElement = document.getElementById('excalibur-play') as HTMLButtonElement;\r\n    if (!buttonElement) {\r\n      buttonElement = document.createElement('button');\r\n    }\r\n\r\n    buttonElement.id = 'excalibur-play';\r\n    buttonElement.textContent = this.playButtonText;\r\n    buttonElement.style.display = 'none';\r\n    return buttonElement;\r\n  };\r\n\r\n  /**\r\n   * @param loadables  Optionally provide the list of resources you want to load at constructor time\r\n   */\r\n  constructor(loadables?: Loadable<any>[]) {\r\n    super();\r\n\r\n    if (loadables) {\r\n      this.addResources(loadables);\r\n    }\r\n  }\r\n\r\n  public wireEngine(engine: Engine) {\r\n    this._engine = engine;\r\n    this.canvas.width = this._engine.canvas.width;\r\n    this.canvas.height = this._engine.canvas.height;\r\n  }\r\n\r\n  /**\r\n   * Add a resource to the loader to load\r\n   * @param loadable  Resource to add\r\n   */\r\n  public addResource(loadable: Loadable<any>) {\r\n    const key = this._index++;\r\n    this._resourceList.push(loadable);\r\n    this._progressCounts[key] = 0;\r\n    this._totalCounts[key] = 1;\r\n    this._resourceCount++;\r\n  }\r\n\r\n  /**\r\n   * Add a list of resources to the loader to load\r\n   * @param loadables  The list of resources to load\r\n   */\r\n  public addResources(loadables: Loadable<any>[]) {\r\n    let i = 0;\r\n    const len = loadables.length;\r\n\r\n    for (i; i < len; i++) {\r\n      this.addResource(loadables[i]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns true if the loader has completely loaded all resources\r\n   */\r\n  public isLoaded() {\r\n    return this._numLoaded === this._resourceCount;\r\n  }\r\n\r\n  /**\r\n   * Shows the play button and returns a promise that resolves when clicked\r\n   */\r\n  public async showPlayButton(): Promise<void> {\r\n    if (this.suppressPlayButton) {\r\n      this.hidePlayButton();\r\n      // Delay is to give the logo a chance to show, otherwise don't delay\r\n      await delay(500, this._engine?.clock);\r\n    } else {\r\n      const resizeHandler = () => {\r\n        this._positionPlayButton();\r\n      };\r\n      if (this._engine?.browser) {\r\n        this._engine.browser.window.on('resize', resizeHandler);\r\n      }\r\n      this._playButtonShown = true;\r\n      this._playButton.style.display = 'block';\r\n      document.body.addEventListener('keyup', (evt: KeyboardEvent) => {\r\n        if (evt.key === 'Enter') {\r\n          this._playButton.click();\r\n        }\r\n      });\r\n      this._positionPlayButton();\r\n      const playButtonClicked = new Promise<void>((resolve) => {\r\n        const startButtonHandler = (e: Event) => {\r\n          // We want to stop propagation to keep bubbling to the engine pointer handlers\r\n          e.stopPropagation();\r\n          // Hide Button after click\r\n          this.hidePlayButton();\r\n          if (this._engine?.browser) {\r\n            this._engine.browser.window.off('resize', resizeHandler);\r\n          }\r\n          resolve();\r\n        };\r\n        this._playButton.addEventListener('click', startButtonHandler);\r\n        this._playButton.addEventListener('touchend', startButtonHandler);\r\n        this._playButton.addEventListener('pointerup', startButtonHandler);\r\n      });\r\n\r\n      return await playButtonClicked;\r\n    }\r\n  }\r\n\r\n  public hidePlayButton() {\r\n    this._playButtonShown = false;\r\n    this._playButton.style.display = 'none';\r\n  }\r\n\r\n  /**\r\n   * Clean up generated elements for the loader\r\n   */\r\n  public dispose() {\r\n    if (this._playButtonRootElement.parentElement) {\r\n      this._playButtonRootElement.removeChild(this._playButtonElement);\r\n      document.body.removeChild(this._playButtonRootElement);\r\n      document.head.removeChild(this._styleBlock);\r\n      this._playButtonRootElement = null;\r\n      this._playButtonElement = null;\r\n      this._styleBlock = null;\r\n    }\r\n  }\r\n\r\n  update(_engine: Engine, _delta: number): void {\r\n    // override me\r\n  }\r\n\r\n  data: Loadable<any>[];\r\n\r\n  private _loadingFuture = new Future<void>();\r\n  public areResourcesLoaded() {\r\n    return this._loadingFuture.promise;\r\n  }\r\n\r\n  /**\r\n   * Begin loading all of the supplied resources, returning a promise\r\n   * that resolves when loading of all is complete AND the user has clicked the \"Play button\"\r\n   */\r\n  public async load(): Promise<Loadable<any>[]> {\r\n    await this._image?.decode(); // decode logo if it exists\r\n    this.canvas.flagDirty();\r\n\r\n    await Promise.all(\r\n      this._resourceList.map(async (r) => {\r\n        await r.load().finally(() => {\r\n          // capture progress\r\n          this._numLoaded++;\r\n          this.canvas.flagDirty();\r\n        });\r\n      })\r\n    );\r\n    // Wire all sound to the engine\r\n    for (const resource of this._resourceList) {\r\n      if (resource instanceof Sound) {\r\n        resource.wireEngine(this._engine);\r\n      }\r\n    }\r\n\r\n    this._loadingFuture.resolve();\r\n\r\n    // short delay in showing the button for aesthetics\r\n    await delay(200, this._engine?.clock);\r\n    this.canvas.flagDirty();\r\n\r\n    await this.showPlayButton();\r\n    // Unlock browser AudioContext in after user gesture\r\n    // See: https://github.com/excaliburjs/Excalibur/issues/262\r\n    // See: https://github.com/excaliburjs/Excalibur/issues/1031\r\n    await WebAudio.unlock();\r\n\r\n    return (this.data = this._resourceList);\r\n  }\r\n\r\n  public markResourceComplete(): void {\r\n    this._numLoaded++;\r\n  }\r\n\r\n  /**\r\n   * Returns the progress of the loader as a number between [0, 1] inclusive.\r\n   */\r\n  public get progress(): number {\r\n    return this._resourceCount > 0 ? clamp(this._numLoaded, 0, this._resourceCount) / this._resourceCount : 1;\r\n  }\r\n\r\n  private _positionPlayButton() {\r\n    if (this._engine) {\r\n      const screenHeight = this._engine.screen.viewport.height;\r\n      const screenWidth = this._engine.screen.viewport.width;\r\n      if (this._playButtonRootElement) {\r\n        const left = this._engine.canvas.offsetLeft;\r\n        const top = this._engine.canvas.offsetTop;\r\n        const buttonWidth = this._playButton.clientWidth;\r\n        const buttonHeight = this._playButton.clientHeight;\r\n        if (this.playButtonPosition) {\r\n          this._playButtonRootElement.style.left = `${this.playButtonPosition.x}px`;\r\n          this._playButtonRootElement.style.top = `${this.playButtonPosition.y}px`;\r\n        } else {\r\n          this._playButtonRootElement.style.left = `${left + screenWidth / 2 - buttonWidth / 2}px`;\r\n          this._playButtonRootElement.style.top = `${top + screenHeight / 2 - buttonHeight / 2 + 100}px`;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Loader draw function. Draws the default Excalibur loading screen.\r\n   * Override `logo`, `logoWidth`, `logoHeight` and `backgroundColor` properties\r\n   * to customize the drawing, or just override entire method.\r\n   */\r\n  public draw(ctx: CanvasRenderingContext2D) {\r\n    const canvasHeight = this._engine.canvasHeight / this._engine.pixelRatio;\r\n    const canvasWidth = this._engine.canvasWidth / this._engine.pixelRatio;\r\n\r\n    this._positionPlayButton();\r\n\r\n    ctx.fillStyle = this.backgroundColor;\r\n    ctx.fillRect(0, 0, canvasWidth, canvasHeight);\r\n\r\n    let logoY = canvasHeight / 2;\r\n    const width = Math.min(this.logoWidth, canvasWidth * 0.75);\r\n    let logoX = canvasWidth / 2 - width / 2;\r\n\r\n    if (this.logoPosition) {\r\n      logoX = this.logoPosition.x;\r\n      logoY = this.logoPosition.y;\r\n    }\r\n\r\n    const imageHeight = Math.floor(width * (this.logoHeight / this.logoWidth)); // OG height/width factor\r\n    const oldAntialias = this._engine.getAntialiasing();\r\n    this._engine.setAntialiasing(true);\r\n    if (!this.logoPosition) {\r\n      ctx.drawImage(this._image, 0, 0, this.logoWidth, this.logoHeight, logoX, logoY - imageHeight - 20, width, imageHeight);\r\n    } else {\r\n      ctx.drawImage(this._image, 0, 0, this.logoWidth, this.logoHeight, logoX, logoY, width, imageHeight);\r\n    }\r\n\r\n    // loading box\r\n    if (!this.suppressPlayButton && this._playButtonShown) {\r\n      this._engine.setAntialiasing(oldAntialias);\r\n      return;\r\n    }\r\n\r\n    let loadingX = logoX;\r\n    let loadingY = logoY;\r\n    if (this.loadingBarPosition) {\r\n      loadingX = this.loadingBarPosition.x;\r\n      loadingY = this.loadingBarPosition.y;\r\n    }\r\n\r\n    ctx.lineWidth = 2;\r\n    DrawUtil.roundRect(ctx, loadingX, loadingY, width, 20, 10, this.loadingBarColor);\r\n    const progress = width * this.progress;\r\n    const margin = 5;\r\n    const progressWidth = progress - margin * 2;\r\n    const height = 20 - margin * 2;\r\n    DrawUtil.roundRect(\r\n      ctx,\r\n      loadingX + margin,\r\n      loadingY + margin,\r\n      progressWidth > 10 ? progressWidth : 10,\r\n      height,\r\n      5,\r\n      null,\r\n      this.loadingBarColor\r\n    );\r\n    this._engine.setAntialiasing(oldAntialias);\r\n  }\r\n}\r\n","export default \"data:image/png;base64,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\"","import { Logger } from './Log';\r\n/**\r\n * This is the list of features that will be used to log the supported\r\n * features to the console when Detector.logBrowserFeatures() is called.\r\n */\r\n\r\nconst REPORTED_FEATURES: { [key: string]: string } = {\r\n  webgl: 'WebGL',\r\n  webaudio: 'WebAudio',\r\n  gamepadapi: 'Gamepad API'\r\n};\r\n\r\n/**\r\n * Interface for detected browser features matrix\r\n */\r\nexport interface DetectedFeatures {\r\n  readonly canvas: boolean;\r\n  readonly arraybuffer: boolean;\r\n  readonly dataurl: boolean;\r\n  readonly objecturl: boolean;\r\n  readonly rgba: boolean;\r\n  readonly webaudio: boolean;\r\n  readonly webgl: boolean;\r\n  readonly gamepadapi: boolean;\r\n}\r\n\r\ninterface CriticalTests {\r\n  canvasSupport(): boolean;\r\n  arrayBufferSupport(): boolean;\r\n  dataUrlSupport(): boolean;\r\n  objectUrlSupport(): boolean;\r\n  rgbaSupport(): boolean;\r\n}\r\n\r\ninterface WarningTests {\r\n  webAudioSupport(): boolean;\r\n  webglSupport(): boolean;\r\n}\r\n\r\n/**\r\n * Excalibur internal feature detection helper class\r\n */\r\nexport class Detector {\r\n  private _features: DetectedFeatures = null;\r\n\r\n  public failedTests: string[] = [];\r\n\r\n  public constructor() {\r\n    this._features = this._loadBrowserFeatures();\r\n  }\r\n\r\n  /**\r\n   * Returns a map of currently supported browser features. This method\r\n   * treats the features as a singleton and will only calculate feature\r\n   * support if it has not previously been done.\r\n   */\r\n  public getBrowserFeatures(): DetectedFeatures {\r\n    if (this._features === null) {\r\n      this._features = this._loadBrowserFeatures();\r\n    }\r\n    return this._features;\r\n  }\r\n\r\n  /**\r\n   * Report on non-critical browser support for debugging purposes.\r\n   * Use native browser console colors for visibility.\r\n   */\r\n  public logBrowserFeatures(): void {\r\n    let msg = '%cSUPPORTED BROWSER FEATURES\\n==========================%c\\n';\r\n    const args = ['font-weight: bold; color: navy', 'font-weight: normal; color: inherit'];\r\n\r\n    const supported: any = this.getBrowserFeatures();\r\n    for (const feature of Object.keys(REPORTED_FEATURES)) {\r\n      if (supported[feature]) {\r\n        msg += '(%c\\u2713%c)'; // ()\r\n        args.push('font-weight: bold; color: green');\r\n        args.push('font-weight: normal; color: inherit');\r\n      } else {\r\n        msg += '(%c\\u2717%c)'; // ()\r\n        args.push('font-weight: bold; color: red');\r\n        args.push('font-weight: normal; color: inherit');\r\n      }\r\n\r\n      msg += ' ' + REPORTED_FEATURES[feature] + '\\n';\r\n    }\r\n\r\n    args.unshift(msg);\r\n    // eslint-disable-next-line no-console\r\n    console.log.apply(console, args);\r\n  }\r\n\r\n  /**\r\n   * Executes several IIFE's to get a constant reference to supported\r\n   * features within the current execution context.\r\n   */\r\n  private _loadBrowserFeatures(): DetectedFeatures {\r\n    return {\r\n      // IIFE to check canvas support\r\n      canvas: (() => {\r\n        return this._criticalTests.canvasSupport();\r\n      })(),\r\n\r\n      // IIFE to check arraybuffer support\r\n      arraybuffer: (() => {\r\n        return this._criticalTests.arrayBufferSupport();\r\n      })(),\r\n\r\n      // IIFE to check dataurl support\r\n      dataurl: (() => {\r\n        return this._criticalTests.dataUrlSupport();\r\n      })(),\r\n\r\n      // IIFE to check objecturl support\r\n      objecturl: (() => {\r\n        return this._criticalTests.objectUrlSupport();\r\n      })(),\r\n\r\n      // IIFE to check rgba support\r\n      rgba: (() => {\r\n        return this._criticalTests.rgbaSupport();\r\n      })(),\r\n\r\n      // IIFE to check webaudio support\r\n      webaudio: (() => {\r\n        return this._warningTest.webAudioSupport();\r\n      })(),\r\n\r\n      // IIFE to check webgl support\r\n      webgl: (() => {\r\n        return this._warningTest.webglSupport();\r\n      })(),\r\n\r\n      // IIFE to check gamepadapi support\r\n      gamepadapi: (() => {\r\n        return !!(<any>navigator).getGamepads;\r\n      })()\r\n    };\r\n  }\r\n\r\n  // critical browser features required for ex to run\r\n  private _criticalTests: CriticalTests = {\r\n    // Test canvas/2d context support\r\n    canvasSupport: function() {\r\n      const elem = document.createElement('canvas');\r\n      return !!(elem.getContext && elem.getContext('2d'));\r\n    },\r\n\r\n    // Test array buffer support ex uses for downloading binary data\r\n    arrayBufferSupport: function() {\r\n      const xhr = new XMLHttpRequest();\r\n      xhr.open('GET', '/');\r\n      try {\r\n        xhr.responseType = 'arraybuffer';\r\n      } catch (e) {\r\n        return false;\r\n      }\r\n      return xhr.responseType === 'arraybuffer';\r\n    },\r\n\r\n    // Test data urls ex uses for sprites\r\n    dataUrlSupport: function() {\r\n      const canvas = document.createElement('canvas');\r\n      return canvas.toDataURL('image/png').indexOf('data:image/png') === 0;\r\n    },\r\n\r\n    // Test object url support for loading\r\n    objectUrlSupport: function() {\r\n      return 'URL' in window && 'revokeObjectURL' in URL && 'createObjectURL' in URL;\r\n    },\r\n\r\n    // RGBA support for colors\r\n    rgbaSupport: function() {\r\n      const style = document.createElement('a').style;\r\n      style.cssText = 'background-color:rgba(150,255,150,.5)';\r\n      return ('' + style.backgroundColor).indexOf('rgba') > -1;\r\n    }\r\n  };\r\n\r\n  // warnings excalibur performance will be degraded\r\n  private _warningTest: WarningTests = {\r\n    webAudioSupport: function() {\r\n      return !!(\r\n        (<any>window).AudioContext ||\r\n        (<any>window).webkitAudioContext ||\r\n        (<any>window).mozAudioContext ||\r\n        (<any>window).msAudioContext ||\r\n        (<any>window).oAudioContext\r\n      );\r\n    },\r\n    webglSupport: function() {\r\n      const elem = document.createElement('canvas');\r\n      return !!(elem.getContext && elem.getContext('webgl'));\r\n    }\r\n  };\r\n\r\n  public test(): boolean {\r\n    // Critical test will for ex not to run\r\n    let failedCritical = false;\r\n    for (const test in this._criticalTests) {\r\n      if (!this._criticalTests[<keyof CriticalTests>test].call(this)) {\r\n        this.failedTests.push(test);\r\n        Logger.getInstance().error('Critical browser feature missing, Excalibur requires:', test);\r\n        failedCritical = true;\r\n      }\r\n    }\r\n    if (failedCritical) {\r\n      return false;\r\n    }\r\n\r\n    // Warning tests do not for ex to return false to compatibility\r\n    for (const warning in this._warningTest) {\r\n      if (!this._warningTest[<keyof WarningTests>warning]()) {\r\n        Logger.getInstance().warn('Warning browser feature missing, Excalibur will have reduced performance:', warning);\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n}\r\n","/**\r\n * An enum that describes the types of collisions bodies can participate in\r\n */\r\nexport enum CollisionType {\r\n  /**\r\n   * Bodies with the `PreventCollision` setting do not participate in any\r\n   * collisions and do not raise collision events.\r\n   */\r\n  PreventCollision = 'PreventCollision',\r\n  /**\r\n   * Bodies with the `Passive` setting only raise collision events, but are not\r\n   * influenced or moved by other bodies and do not influence or move other bodies.\r\n   * This is useful for use in trigger type behavior.\r\n   */\r\n  Passive = 'Passive',\r\n  /**\r\n   * Bodies with the `Active` setting raise collision events and participate\r\n   * in collisions with other bodies and will be push or moved by bodies sharing\r\n   * the `Active` or `Fixed` setting.\r\n   */\r\n  Active = 'Active',\r\n  /**\r\n   * Bodies with the `Fixed` setting raise collision events and participate in\r\n   * collisions with other bodies. Actors with the `Fixed` setting will not be\r\n   * pushed or moved by other bodies sharing the `Fixed`. Think of Fixed\r\n   * bodies as \"immovable/unstoppable\" objects. If two `Fixed` bodies meet they will\r\n   * not be pushed or moved by each other, they will not interact except to throw\r\n   * collision events.\r\n   */\r\n  Fixed = 'Fixed'\r\n}\r\n","import { Flags } from '../Flags';\r\nimport { Logger } from './Log';\r\n\r\n/**\r\n * Obsolete decorator options\r\n */\r\nexport interface ObsoleteOptions {\r\n  // Optionally specify a custom message\r\n  message?: string;\r\n  // Optionally indicate that an alternate method to the obsolete one exists\r\n  alternateMethod?: string;\r\n  // Optional show stack trace, by default off\r\n  showStackTrace?: boolean;\r\n}\r\n\r\nexport const maxMessages = 5;\r\nconst obsoleteMessage: { [messageCount: string]: number } = {};\r\nexport const resetObsoleteCounter = () => {\r\n  for (const message in obsoleteMessage) {\r\n    obsoleteMessage[message] = 0;\r\n  }\r\n};\r\n\r\nconst logMessage = (message: string, options: ObsoleteOptions) => {\r\n  const suppressObsoleteMessages = Flags.isEnabled('suppress-obsolete-message');\r\n  if (obsoleteMessage[message] < maxMessages && !suppressObsoleteMessages) {\r\n    Logger.getInstance().warn(message);\r\n\r\n    // tslint:disable-next-line: no-console\r\n    if (console.trace && options.showStackTrace) {\r\n      // tslint:disable-next-line: no-console\r\n      console.trace();\r\n    }\r\n  }\r\n  obsoleteMessage[message]++;\r\n};\r\n\r\n/**\r\n * Obsolete decorator for marking Excalibur methods obsolete, you can optionally specify a custom message and/or alternate replacement\r\n * method do the deprecated one. Inspired by https://github.com/jayphelps/core-decorators.js\r\n */\r\nexport function obsolete(options?: ObsoleteOptions): any {\r\n  options = {\r\n    message: 'This feature will be removed in future versions of Excalibur.',\r\n    alternateMethod: null,\r\n    showStackTrace: false,\r\n    ...options\r\n  };\r\n\r\n  return function (target: any, property: string, descriptor: PropertyDescriptor): any {\r\n    if (\r\n      descriptor &&\r\n      !(typeof descriptor.value === 'function' || typeof descriptor.get === 'function' || typeof descriptor.set === 'function')\r\n    ) {\r\n      throw new SyntaxError('Only classes/functions/getters/setters can be marked as obsolete');\r\n    }\r\n    const methodSignature = `${target.name || ''}${target.name && property ? '.' : ''}${property ? property : ''}`;\r\n\r\n    const message =\r\n      `${methodSignature} is marked obsolete: ${options.message}` +\r\n      (options.alternateMethod ? ` Use ${options.alternateMethod} instead` : '');\r\n\r\n    if (!obsoleteMessage[message]) {\r\n      obsoleteMessage[message] = 0;\r\n    }\r\n\r\n    // If descriptor is null it is a class\r\n    const method = descriptor ? { ...descriptor } : target;\r\n    if (!descriptor) {\r\n      // with es2015 classes we need to change our decoration tactic\r\n      class DecoratedClass extends method {\r\n        constructor(...args: any) {\r\n          logMessage(message, options);\r\n          super(...args);\r\n        }\r\n      }\r\n      return DecoratedClass;\r\n    }\r\n\r\n    if (descriptor && descriptor.value) {\r\n      method.value = function (this: any) {\r\n        logMessage(message, options);\r\n        return descriptor.value.apply(this, arguments);\r\n      };\r\n      return method;\r\n    }\r\n\r\n    if (descriptor && descriptor.get) {\r\n      method.get = function (this: any) {\r\n        logMessage(message, options);\r\n        return descriptor.get.apply(this, arguments);\r\n      };\r\n    }\r\n\r\n    if (descriptor && descriptor.set) {\r\n      method.set = function (this: any) {\r\n        logMessage(message, options);\r\n        return descriptor.set.apply(this, arguments);\r\n      };\r\n    }\r\n    return method;\r\n  };\r\n}\r\n","import { Vector } from '../Math/vector';\r\nimport { obsolete } from '../Util/Decorators';\r\n\r\n\r\n/**\r\n * Possible collision resolution strategies\r\n *\r\n * The default is [[CollisionResolutionStrategy.Arcade]] which performs simple axis aligned arcade style physics. This is useful for things\r\n * like platformers or top down games.\r\n *\r\n * More advanced rigid body physics are enabled by setting [[CollisionResolutionStrategy.Realistic]] which allows for complicated\r\n * simulated physical interactions.\r\n */\r\nexport enum CollisionResolutionStrategy {\r\n  Arcade = 'arcade',\r\n  Realistic = 'realistic'\r\n}\r\n\r\n/**\r\n * Possible broadphase collision pair identification strategies\r\n *\r\n * The default strategy is [[BroadphaseStrategy.DynamicAABBTree]] which uses a binary tree of axis-aligned bounding boxes to identify\r\n * potential collision pairs which is O(nlog(n)) faster.\r\n */\r\nexport enum BroadphaseStrategy {\r\n  DynamicAABBTree\r\n}\r\n\r\n/**\r\n * Possible numerical integrators for position and velocity\r\n */\r\nexport enum Integrator {\r\n  Euler\r\n}\r\n\r\n/**\r\n * The [[Physics]] object is the global configuration object for all Excalibur physics.\r\n */\r\n/* istanbul ignore next */\r\nexport class Physics {\r\n  /**\r\n   * Global acceleration that is applied to all vanilla actors that have a [[CollisionType.Active|active]] collision type.\r\n   * Global acceleration won't effect [[Label|labels]], [[ScreenElement|ui actors]], or [[Trigger|triggers]] in Excalibur.\r\n   *\r\n   * This is a great way to globally simulate effects like gravity.\r\n   */\r\n  public static acc = new Vector(0, 0);\r\n  public static get gravity() {\r\n    return Physics.acc;\r\n  }\r\n  public static set gravity(v: Vector) {\r\n    Physics.acc = v;\r\n  }\r\n\r\n  /**\r\n   * Globally switches all Excalibur physics behavior on or off.\r\n   */\r\n  public static enabled = true;\r\n\r\n  /**\r\n   * Gets or sets the broadphase pair identification strategy.\r\n   *\r\n   * The default strategy is [[BroadphaseStrategy.DynamicAABBTree]] which uses a binary tree of axis-aligned bounding boxes to identify\r\n   * potential collision pairs which is O(nlog(n)) faster.\r\n   */\r\n  public static broadphaseStrategy: BroadphaseStrategy = BroadphaseStrategy.DynamicAABBTree;\r\n\r\n  /**\r\n   * Gets or sets the global collision resolution strategy (narrowphase).\r\n   *\r\n   * The default is [[CollisionResolutionStrategy.Arcade]] which performs simple axis aligned arcade style physics.\r\n   *\r\n   * More advanced rigid body physics are enabled by setting [[CollisionResolutionStrategy.Realistic]] which allows for complicated\r\n   * simulated physical interactions.\r\n   */\r\n  public static collisionResolutionStrategy: CollisionResolutionStrategy = CollisionResolutionStrategy.Arcade;\r\n  /**\r\n   * The default mass to use if none is specified\r\n   */\r\n  public static defaultMass: number = 10;\r\n  /**\r\n   * Gets or sets the position and velocity positional integrator, currently only Euler is supported.\r\n   */\r\n  public static integrator: Integrator = Integrator.Euler;\r\n\r\n  /**\r\n   * Configures Excalibur to use \"arcade\" physics. Arcade physics which performs simple axis aligned arcade style physics.\r\n   */\r\n  public static useArcadePhysics(): void {\r\n    Physics.collisionResolutionStrategy = CollisionResolutionStrategy.Arcade;\r\n  }\r\n\r\n  /**\r\n   * Configures Excalibur to use rigid body physics. Rigid body physics allows for complicated\r\n   * simulated physical interactions.\r\n   */\r\n  public static useRealisticPhysics(): void {\r\n    Physics.collisionResolutionStrategy = CollisionResolutionStrategy.Realistic;\r\n  }\r\n\r\n  /**\r\n   * Factor to add to the RigidBody BoundingBox, bounding box (dimensions += vel * dynamicTreeVelocityMultiplier);\r\n   */\r\n  public static dynamicTreeVelocityMultiplier = 2;\r\n\r\n  @obsolete({\r\n    message: 'Alias for incorrect spelling used in older versions, will be removed in v0.25.0',\r\n    alternateMethod: 'dynamicTreeVelocityMultiplier'\r\n  })\r\n  public static get dynamicTreeVelocityMultiplyer() {\r\n    return Physics.dynamicTreeVelocityMultiplier;\r\n  }\r\n\r\n  public static set dynamicTreeVelocityMultiplyer(value: number) {\r\n    Physics.dynamicTreeVelocityMultiplier = value;\r\n  }\r\n\r\n  /**\r\n   * Pad RigidBody BoundingBox by a constant amount\r\n   */\r\n  public static boundsPadding = 5;\r\n\r\n  /**\r\n   * Number of position iterations (overlap) to run in the solver\r\n   */\r\n  public static positionIterations = 3;\r\n\r\n  /**\r\n   * Number of velocity iteration (response) to run in the solver\r\n   */\r\n  public static velocityIterations = 8;\r\n\r\n  /**\r\n   * Amount of overlap to tolerate in pixels\r\n   */\r\n  public static slop = 1;\r\n\r\n  /**\r\n   * Amount of positional overlap correction to apply each position iteration of the solver\r\n   * O - meaning no correction, 1 - meaning correct all overlap\r\n   */\r\n  public static steeringFactor = 0.2;\r\n\r\n  /**\r\n   * Warm start set to true re-uses impulses from previous frames back in the solver\r\n   */\r\n  public static warmStart = true;\r\n\r\n  /**\r\n   * By default bodies do not sleep\r\n   */\r\n  public static bodiesCanSleepByDefault = false;\r\n\r\n  /**\r\n   * Surface epsilon is used to help deal with surface penetration\r\n   */\r\n  public static surfaceEpsilon = 0.1;\r\n\r\n  public static sleepEpsilon = 0.07;\r\n\r\n  public static wakeThreshold = Physics.sleepEpsilon * 3;\r\n\r\n  public static sleepBias = 0.9;\r\n\r\n  /**\r\n   * Enable fast moving body checking, this enables checking for collision pairs via raycast for fast moving objects to prevent\r\n   * bodies from tunneling through one another.\r\n   */\r\n  public static checkForFastBodies = true;\r\n\r\n  /**\r\n   * Disable minimum fast moving body raycast, by default if ex.Physics.checkForFastBodies = true Excalibur will only check if the\r\n   * body is moving at least half of its minimum dimension in an update. If ex.Physics.disableMinimumSpeedForFastBody is set to true,\r\n   * Excalibur will always perform the fast body raycast regardless of speed.\r\n   */\r\n  public static disableMinimumSpeedForFastBody = false;\r\n}\r\n","/**\r\n * Enum representing the coordinate plane for the position 2D vector in the [[TransformComponent]]\r\n */\r\nexport enum CoordPlane {\r\n  /**\r\n   * The world coordinate plane (default) represents world space, any entities drawn with world\r\n   * space move when the camera moves.\r\n   */\r\n  World = 'world',\r\n  /**\r\n   * The screen coordinate plane represents screen space, entities drawn in screen space are pinned\r\n   * to screen coordinates ignoring the camera.\r\n   */\r\n  Screen = 'screen'\r\n}","import { Vector } from './vector';\r\n\r\nexport interface VectorViewOptions {\r\n  getX: () => number;\r\n  getY: () => number;\r\n  setX: (x: number) => void;\r\n  setY: (y: number) => void;\r\n}\r\nexport class VectorView extends Vector {\r\n  private _getX: () => number;\r\n  private _getY: () => number;\r\n  private _setX: (x: number) => void;\r\n  private _setY: (y: number) => void;\r\n  constructor(options: VectorViewOptions) {\r\n    super(0, 0);\r\n    this._getX = options.getX;\r\n    this._getY = options.getY;\r\n    this._setX = options.setX;\r\n    this._setY = options.setY;\r\n  }\r\n  public get x() {\r\n    return (this._x = this._getX());\r\n  }\r\n\r\n  public set x(val) {\r\n    this._setX(val);\r\n    this._x = val;\r\n  }\r\n\r\n  public get y() {\r\n    return (this._y = this._getY());\r\n  }\r\n  public set y(val) {\r\n    this._setY(val);\r\n    this._y = val;\r\n  }\r\n}\r\n","import { Vector } from './vector';\r\n\r\n/**\r\n * Wraps a vector and watches for changes in the x/y, modifies the original vector.\r\n */\r\nexport class WatchVector extends Vector {\r\n  constructor(public original: Vector, public change: (x: number, y: number) => any) {\r\n    super(original.x, original.y);\r\n  }\r\n  public get x() {\r\n    return this._x = this.original.x;\r\n  }\r\n\r\n  public set x(newX: number) {\r\n    this.change(newX, this._y);\r\n    this._x = this.original.x = newX;\r\n  }\r\n\r\n  public get y() {\r\n    return this._y = this.original.y;\r\n  }\r\n\r\n  public set y(newY: number) {\r\n    this.change(this._x, newY);\r\n    this._y = this.original.y = newY;\r\n  }\r\n}","import { AffineMatrix } from './affine-matrix';\r\nimport { canonicalizeAngle } from './util';\r\nimport { vec, Vector } from './vector';\r\nimport { VectorView } from './vector-view';\r\nimport { WatchVector } from './watch-vector';\r\n\r\nexport class Transform {\r\n  private _parent: Transform | null = null;\r\n  get parent() {\r\n    return this._parent;\r\n  }\r\n  set parent(transform: Transform) {\r\n    if (this._parent) {\r\n      const index = this._parent._children.indexOf(this);\r\n      if (index > -1) {\r\n        this._parent._children.splice(index, 1);\r\n      }\r\n    }\r\n    this._parent = transform;\r\n    if (this._parent) {\r\n      this._parent._children.push(this);\r\n    }\r\n    this.flagDirty();\r\n  }\r\n  get children(): readonly Transform[] {\r\n    return this._children;\r\n  }\r\n  private _children: Transform[] = [];\r\n\r\n  private _pos: Vector = vec(0, 0);\r\n  set pos(v: Vector) {\r\n    if (!v.equals(this._pos)) {\r\n      this._pos.x = v.x;\r\n      this._pos.y = v.y;\r\n      this.flagDirty();\r\n    }\r\n  }\r\n  get pos() {\r\n    return new WatchVector(this._pos, (x, y) => {\r\n      if (x !== this._pos.x || y !== this._pos.y) {\r\n        this.flagDirty();\r\n      }\r\n    });\r\n  }\r\n\r\n  set globalPos(v: Vector) {\r\n    let localPos = v.clone();\r\n    if (this.parent) {\r\n      localPos = this.parent.inverse.multiply(v);\r\n    }\r\n    if (!localPos.equals(this._pos)) {\r\n      this._pos = localPos;\r\n      this.flagDirty();\r\n    }\r\n  }\r\n  get globalPos() {\r\n    return new VectorView({\r\n      getX: () => this.matrix.data[4],\r\n      getY: () => this.matrix.data[5],\r\n      setX: (x) => {\r\n        if (this.parent) {\r\n          const { x: newX } = this.parent.inverse.multiply(vec(x, this.pos.y));\r\n          this.pos.x = newX;\r\n        } else {\r\n          this.pos.x = x;\r\n        }\r\n        if (x !== this.matrix.data[4]) {\r\n          this.flagDirty();\r\n        }\r\n      },\r\n      setY: (y) => {\r\n        if (this.parent) {\r\n          const { y: newY } = this.parent.inverse.multiply(vec(this.pos.x, y));\r\n          this.pos.y = newY;\r\n        } else {\r\n          this.pos.y = y;\r\n        }\r\n        if (y !== this.matrix.data[5]) {\r\n          this.flagDirty();\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  private _rotation: number = 0;\r\n  set rotation(rotation: number) {\r\n    const canonRotation = canonicalizeAngle(rotation);\r\n    if (canonRotation !== this._rotation) {\r\n      this.flagDirty();\r\n    }\r\n    this._rotation = canonRotation;\r\n  }\r\n  get rotation() {\r\n    return this._rotation;\r\n  }\r\n\r\n  set globalRotation(rotation: number) {\r\n    let inverseRotation = 0;\r\n    if (this.parent) {\r\n      inverseRotation = this.parent.globalRotation;\r\n    }\r\n    const canonRotation = canonicalizeAngle(rotation + inverseRotation);\r\n    if (canonRotation !== this._rotation) {\r\n      this.flagDirty();\r\n    }\r\n    this._rotation = canonRotation;\r\n  }\r\n\r\n  get globalRotation() {\r\n    if (this.parent) {\r\n      return this.matrix.getRotation();\r\n    }\r\n    return this.rotation;\r\n  }\r\n\r\n  private _scale: Vector = vec(1, 1);\r\n  set scale(v: Vector) {\r\n    if (!v.equals(this._scale)) {\r\n      this._scale.x = v.x;\r\n      this._scale.y = v.y;\r\n      this.flagDirty();\r\n    }\r\n  }\r\n  get scale() {\r\n    return new WatchVector(this._scale, (x, y) => {\r\n      if (x !== this._scale.x || y !== this._scale.y) {\r\n        this.flagDirty();\r\n      }\r\n    });\r\n  }\r\n\r\n  set globalScale(v: Vector) {\r\n    let inverseScale = vec(1, 1);\r\n    if (this.parent) {\r\n      inverseScale = this.parent.globalScale;\r\n    }\r\n    this.scale = v.scale(vec(1 / inverseScale.x, 1 / inverseScale.y));\r\n  }\r\n\r\n  get globalScale() {\r\n    return new VectorView({\r\n      getX: () => this.parent ? this.matrix.getScaleX() : this.scale.x,\r\n      getY: () => this.parent ? this.matrix.getScaleY() : this.scale.y,\r\n      setX: (x) => {\r\n        if (this.parent) {\r\n          const globalScaleX = this.parent.globalScale.x;\r\n          this.scale.x = x / globalScaleX;\r\n        } else {\r\n          this.scale.x = x;\r\n        }\r\n      },\r\n      setY: (y) => {\r\n        if (this.parent) {\r\n          const globalScaleY = this.parent.globalScale.y;\r\n          this.scale.y = y / globalScaleY;\r\n        } else {\r\n          this.scale.y = y;\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  private _isDirty = false;\r\n  private _isInverseDirty = false;\r\n  private _matrix = AffineMatrix.identity();\r\n  private _inverse = AffineMatrix.identity();\r\n\r\n  public get matrix() {\r\n    if (this._isDirty) {\r\n      if (this.parent === null) {\r\n        this._matrix = this._calculateMatrix();\r\n      } else {\r\n        this._matrix = this.parent.matrix.multiply(this._calculateMatrix());\r\n      }\r\n      this._isDirty = false;\r\n    }\r\n    return this._matrix;\r\n  }\r\n\r\n  public get inverse() {\r\n    if (this._isInverseDirty) {\r\n      this._inverse = this.matrix.inverse();\r\n      this._isInverseDirty = false;\r\n    }\r\n    return this._inverse;\r\n  }\r\n\r\n  private _calculateMatrix(): AffineMatrix {\r\n    const matrix = AffineMatrix.identity()\r\n      .translate(this.pos.x, this.pos.y)\r\n      .rotate(this.rotation)\r\n      .scale(this.scale.x, this.scale.y);\r\n    return matrix;\r\n  }\r\n\r\n\r\n  public flagDirty() {\r\n    this._isDirty = true;\r\n    this._isInverseDirty = true;\r\n    for (let i = 0; i < this._children.length; i ++) {\r\n      this._children[i].flagDirty();\r\n    }\r\n  }\r\n\r\n  public apply(point: Vector): Vector {\r\n    return this.matrix.multiply(point);\r\n  }\r\n\r\n  public applyInverse(point: Vector): Vector {\r\n    return this.inverse.multiply(point);\r\n  }\r\n\r\n  public setTransform(pos: Vector, rotation: number, scale: Vector) {\r\n    this._pos.x = pos.x;\r\n    this._pos.y = pos.y;\r\n    this._rotation = canonicalizeAngle(rotation);\r\n    this._scale.x = scale.x;\r\n    this._scale.y = scale.y;\r\n    this.flagDirty();\r\n  }\r\n\r\n  public clone(dest?: Transform) {\r\n    const target = dest ?? new Transform();\r\n    this._pos.clone(target._pos);\r\n    target._rotation = this._rotation;\r\n    this._scale.clone(target._scale);\r\n    target.flagDirty();\r\n  }\r\n}","import { Entity } from './Entity';\r\n\r\n/**\r\n * Component Contructor Types\r\n */\r\nexport declare type ComponentCtor<T extends Component = Component> = new (...args:any[]) => T;\r\n\r\n/**\r\n * Type guard to check if a component implements clone\r\n * @param x\r\n */\r\nfunction hasClone(x: any): x is { clone(): any } {\r\n  return !!x?.clone;\r\n}\r\n\r\nexport type ComponentType<ComponentToParse> = ComponentToParse extends Component<infer TypeName> ? TypeName : never;\r\n\r\n/**\r\n * Plucks the string type out of a component type\r\n */\r\nexport type ComponentStringType<T> = T extends Component<infer R> ? R : string;\r\n\r\n/**\r\n * Components are containers for state in Excalibur, the are meant to convey capabilities that an Entity possesses\r\n *\r\n * Implementations of Component must have a zero-arg constructor to support dependencies\r\n *\r\n * ```typescript\r\n * class MyComponent extends ex.Component<'my'> {\r\n *   public readonly type = 'my';\r\n *   // zero arg support required if you want to use component dependencies\r\n *   constructor(public optionalPos?: ex.Vector) {}\r\n * }\r\n * ```\r\n */\r\nexport abstract class Component<TypeName extends string = string> {\r\n  /**\r\n   * Optionally list any component types this component depends on\r\n   * If the owner entity does not have these components, new components will be added to the entity\r\n   *\r\n   * Only components with zero-arg constructors are supported as automatic component dependencies\r\n   */\r\n  readonly dependencies?: ComponentCtor[];\r\n\r\n  // todo implement optional\r\n  readonly optional?: ComponentCtor[];\r\n\r\n  /**\r\n   * Type of this component, must be a unique type among component types in you game.\r\n   */\r\n  abstract readonly type: TypeName;\r\n\r\n  /**\r\n   * Current owning [[Entity]], if any, of this component. Null if not added to any [[Entity]]\r\n   */\r\n  owner?: Entity = null;\r\n\r\n  /**\r\n   * Clones any properties on this component, if that property value has a `clone()` method it will be called\r\n   */\r\n  clone(): this {\r\n    const newComponent = new (this.constructor as any)();\r\n    for (const prop in this) {\r\n      if (this.hasOwnProperty(prop)) {\r\n        const val = this[prop];\r\n        if (hasClone(val) && prop !== 'owner' && prop !== 'clone') {\r\n          newComponent[prop] = val.clone();\r\n        } else {\r\n          newComponent[prop] = val;\r\n        }\r\n      }\r\n    }\r\n    return newComponent;\r\n  }\r\n\r\n  /**\r\n   * Optional callback called when a component is added to an entity\r\n   */\r\n  onAdd?(owner: Entity): void;\r\n\r\n  /**\r\n   * Optional callback called when a component is added to an entity\r\n   */\r\n  onRemove?(previousOwner: Entity): void;\r\n}\r\n\r\n/**\r\n * Tag components are a way of tagging a component with label and a simple value\r\n *\r\n * For example:\r\n *\r\n * ```typescript\r\n * const isOffscreen = new TagComponent('offscreen');\r\n * entity.addComponent(isOffscreen);\r\n * entity.tags.includes\r\n * ```\r\n */\r\nexport class TagComponent<TypeName extends string, MaybeValueType extends string | symbol | number | boolean = never> extends Component<\r\nTypeName\r\n> {\r\n  constructor(public readonly type: TypeName, public readonly value?: MaybeValueType) {\r\n    super();\r\n  }\r\n}\r\n","/**\r\n * Defines a generic message that can contain any data\r\n * @template T is the typescript Type of the data\r\n */\r\nexport interface Message<T> {\r\n  type: string;\r\n  data: T;\r\n}\r\n\r\n/**\r\n * Defines an interface for an observer to receive a message via a notify() method\r\n */\r\nexport interface Observer<T> {\r\n  notify(message: T): void;\r\n}\r\n\r\n/**\r\n * Defines an interface for something that might be an observer if a notify() is present\r\n */\r\nexport type MaybeObserver<T> = Partial<Observer<T>>;\r\n\r\n/**\r\n * Simple Observable implementation\r\n * @template T is the typescript Type that defines the data being observed\r\n */\r\nexport class Observable<T> {\r\n  public observers: Observer<T>[] = [];\r\n  public subscriptions: ((val: T) => any)[] = [];\r\n\r\n  /**\r\n   * Register an observer to listen to this observable\r\n   * @param observer\r\n   */\r\n  register(observer: Observer<T>) {\r\n    this.observers.push(observer);\r\n  }\r\n\r\n  /**\r\n   * Register a callback to listen to this observable\r\n   * @param func\r\n   */\r\n  subscribe(func: (val: T) => any) {\r\n    this.subscriptions.push(func);\r\n  }\r\n\r\n  /**\r\n   * Remove an observer from the observable\r\n   * @param observer\r\n   */\r\n  unregister(observer: Observer<T>) {\r\n    const i = this.observers.indexOf(observer);\r\n    if (i !== -1) {\r\n      this.observers.splice(i, 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove a callback that is listening to this observable\r\n   * @param func\r\n   */\r\n  unsubscribe(func: (val: T) => any) {\r\n    const i = this.subscriptions.indexOf(func);\r\n    if (i !== -1) {\r\n      this.subscriptions.splice(i, 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Broadcasts a message to all observers and callbacks\r\n   * @param message\r\n   */\r\n  notifyAll(message: T) {\r\n    const observersLength = this.observers.length;\r\n    for (let i = 0; i < observersLength; i++) {\r\n      this.observers[i].notify(message);\r\n    }\r\n    const subscriptionsLength = this.subscriptions.length;\r\n    for (let i = 0; i < subscriptionsLength; i++) {\r\n      this.subscriptions[i](message);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes all observers and callbacks\r\n   */\r\n  clear() {\r\n    this.observers.length = 0;\r\n    this.subscriptions.length = 0;\r\n  }\r\n}\r\n","import { Vector } from '../../Math/vector';\r\nimport { CoordPlane } from '../../Math/coord-plane';\r\nimport { Transform } from '../../Math/transform';\r\nimport { Component } from '../Component';\r\nimport { Entity } from '../Entity';\r\nimport { Observable } from '../../Util/Observable';\r\n\r\n\r\nexport class TransformComponent extends Component<'ex.transform'> {\r\n  public readonly type = 'ex.transform';\r\n\r\n  private _transform = new Transform();\r\n  public get() {\r\n    return this._transform;\r\n  }\r\n\r\n  private _addChildTransform = (child: Entity) => {\r\n    const childTxComponent = child.get(TransformComponent);\r\n    if (childTxComponent) {\r\n      childTxComponent._transform.parent = this._transform;\r\n    }\r\n  };\r\n  onAdd(owner: Entity): void {\r\n    for (const child of owner.children) {\r\n      this._addChildTransform(child);\r\n    }\r\n    owner.childrenAdded$.subscribe(child => this._addChildTransform(child));\r\n    owner.childrenRemoved$.subscribe(child => {\r\n      const childTxComponent = child.get(TransformComponent);\r\n      if (childTxComponent) {\r\n        childTxComponent._transform.parent = null;\r\n      }\r\n    });\r\n  }\r\n  onRemove(_previousOwner: Entity): void {\r\n    this._transform.parent = null;\r\n  }\r\n\r\n  /**\r\n   * Observable that emits when the z index changes on this component\r\n   */\r\n  public zIndexChanged$ = new Observable<number>();\r\n  private _z = 0;\r\n\r\n  /**\r\n   * The z-index ordering of the entity, a higher values are drawn on top of lower values.\r\n   * For example z=99 would be drawn on top of z=0.\r\n   */\r\n  public get z(): number {\r\n    return this._z;\r\n  }\r\n\r\n  public set z(val: number) {\r\n    const oldz = this._z;\r\n    this._z = val;\r\n    if (oldz !== val) {\r\n      this.zIndexChanged$.notifyAll(val);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * The [[CoordPlane|coordinate plane|]] for this transform for the entity.\r\n   */\r\n  public coordPlane = CoordPlane.World;\r\n\r\n  get pos() {\r\n    return this._transform.pos;\r\n  }\r\n  set pos(v: Vector) {\r\n    this._transform.pos = v;\r\n  }\r\n\r\n  get globalPos() {\r\n    return this._transform.globalPos;\r\n  }\r\n  set globalPos(v: Vector) {\r\n    this._transform.globalPos = v;\r\n  }\r\n\r\n  get rotation() {\r\n    return this._transform.rotation;\r\n  }\r\n  set rotation(rotation) {\r\n    this._transform.rotation = rotation;\r\n  }\r\n\r\n  get globalRotation() {\r\n    return this._transform.globalRotation;\r\n  }\r\n  set globalRotation(rotation) {\r\n    this._transform.globalRotation = rotation;\r\n  }\r\n\r\n  get scale() {\r\n    return this._transform.scale;\r\n  }\r\n  set scale(v: Vector) {\r\n    this._transform.scale = v;\r\n  }\r\n\r\n  get globalScale() {\r\n    return this._transform.globalScale;\r\n  }\r\n  set globalScale(v: Vector) {\r\n    this._transform.globalScale = v;\r\n  }\r\n\r\n  applyInverse(v: Vector) {\r\n    return this._transform.applyInverse(v);\r\n  }\r\n\r\n  apply(v: Vector) {\r\n    return this._transform.apply(v);\r\n  }\r\n}","import { Vector } from '../../Math/vector';\r\nimport { Component } from '../Component';\r\n\r\nexport interface Motion {\r\n  /**\r\n   * The velocity of an entity in pixels per second\r\n   */\r\n  vel: Vector;\r\n\r\n  /**\r\n   * The acceleration of entity in pixels per second^2\r\n   */\r\n  acc: Vector;\r\n\r\n  /**\r\n   * The scale rate of change in scale units per second\r\n   */\r\n  scaleFactor: Vector;\r\n\r\n  /**\r\n   * The angular velocity which is how quickly the entity is rotating in radians per second\r\n   */\r\n  angularVelocity: number;\r\n\r\n  /**\r\n   * The amount of torque applied to the entity, angular acceleration is torque * inertia\r\n   */\r\n  torque: number;\r\n\r\n  /**\r\n   * Inertia can be thought of as the resistance to motion\r\n   */\r\n  inertia: number;\r\n}\r\n\r\nexport class MotionComponent extends Component<'ex.motion'> {\r\n  public readonly type = 'ex.motion';\r\n\r\n  /**\r\n   * The velocity of an entity in pixels per second\r\n   */\r\n  public vel: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * The acceleration of entity in pixels per second^2\r\n   */\r\n  public acc: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * The scale rate of change in scale units per second\r\n   */\r\n  public scaleFactor: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * The angular velocity which is how quickly the entity is rotating in radians per second\r\n   */\r\n  public angularVelocity = 0;\r\n\r\n  /**\r\n   * The amount of torque applied to the entity, angular acceleration is torque * inertia\r\n   */\r\n  public torque: number = 0;\r\n\r\n  /**\r\n   * Inertia can be thought of as the resistance to motion\r\n   */\r\n  public inertia: number = 1;\r\n}\r\n","/**\r\n * CollisionGroups indicate like members that do not collide with each other. Use [[CollisionGroupManager]] to create [[CollisionGroup]]s\r\n *\r\n * For example:\r\n *\r\n * Players have collision group \"player\"\r\n *\r\n * ![Player Collision Group](/assets/images/docs/CollisionGroupsPlayer.png)\r\n *\r\n * Enemies have collision group \"enemy\"\r\n *\r\n * ![Enemy Collision Group](/assets/images/docs/CollisionGroupsEnemy.png)\r\n *\r\n * Blocks have collision group \"ground\"\r\n *\r\n * ![Ground collision group](/assets/images/docs/CollisionGroupsGround.png)\r\n *\r\n * Players don't collide with each other, but enemies and blocks. Likewise, enemies don't collide with each other but collide\r\n * with players and blocks.\r\n *\r\n * This is done with bitmasking, see the following pseudo-code\r\n *\r\n * PlayerGroup = `0b001`\r\n * PlayerGroupMask = `0b110`\r\n *\r\n * EnemyGroup = `0b010`\r\n * EnemyGroupMask = `0b101`\r\n *\r\n * BlockGroup = `0b100`\r\n * BlockGroupMask = `0b011`\r\n *\r\n * Should Players collide? No because the bitwise mask evaluates to 0\r\n * `(player1.group & player2.mask) === 0`\r\n * `(0b001 & 0b110) === 0`\r\n *\r\n * Should Players and Enemies collide? Yes because the bitwise mask is non-zero\r\n * `(player1.group & enemy1.mask) === 1`\r\n * `(0b001 & 0b101) === 1`\r\n *\r\n * Should Players and Blocks collide? Yes because the bitwise mask is non-zero\r\n * `(player1.group & blocks1.mask) === 1`\r\n * `(0b001 & 0b011) === 1`\r\n */\r\nexport class CollisionGroup {\r\n  /**\r\n   * The `All` [[CollisionGroup]] is a special group that collides with all other groups including itself,\r\n   * it is the default collision group on colliders.\r\n   */\r\n  public static All = new CollisionGroup('Collide with all groups', -1, -1);\r\n\r\n  private _name: string;\r\n  private _category: number;\r\n  private _mask: number;\r\n\r\n  /**\r\n   * STOP!!** It is preferred that [[CollisionGroupManager.create]] is used to create collision groups\r\n   *  unless you know how to construct the proper bitmasks. See https://github.com/excaliburjs/Excalibur/issues/1091 for more info.\r\n   * @param name Name of the collision group\r\n   * @param category 32 bit category for the group, should be a unique power of 2. For example `0b001` or `0b010`\r\n   * @param mask 32 bit mask of category, or `~category` generally. For a category of `0b001`, the mask would be `0b110`\r\n   */\r\n  constructor(name: string, category: number, mask: number) {\r\n    this._name = name;\r\n    this._category = category;\r\n    this._mask = mask;\r\n  }\r\n\r\n  /**\r\n   * Get the name of the collision group\r\n   */\r\n  public get name() {\r\n    return this._name;\r\n  }\r\n\r\n  /**\r\n   * Get the category of the collision group, a 32 bit number which should be a unique power of 2\r\n   */\r\n  public get category() {\r\n    return this._category;\r\n  }\r\n\r\n  /**\r\n   * Get the mask for this collision group\r\n   */\r\n  public get mask() {\r\n    return this._mask;\r\n  }\r\n\r\n  /**\r\n   * Evaluates whether 2 collision groups can collide\r\n   * @param other  CollisionGroup\r\n   */\r\n  public canCollide(other: CollisionGroup): boolean {\r\n    return (this.category & other.mask) !== 0 && (other.category & this.mask) !== 0;\r\n  }\r\n\r\n  /**\r\n   * Inverts the collision group. For example, if before the group specified \"players\",\r\n   * inverting would specify all groups except players\r\n   * @returns CollisionGroup\r\n   */\r\n  public invert(): CollisionGroup {\r\n    return new CollisionGroup('~(' + this.name + ')', ~this.category, ~this.mask);\r\n  }\r\n\r\n  /**\r\n   * Combine collision groups with each other. The new group includes all of the previous groups.\r\n   *\r\n   * @param collisionGroups\r\n   */\r\n  public static combine(collisionGroups: CollisionGroup[]) {\r\n    const combinedName = collisionGroups.map((c) => c.name).join('+');\r\n    const combinedCategory = collisionGroups.reduce((current, g) => g.category | current, 0b0);\r\n    const combinedMask = ~combinedCategory;\r\n\r\n    return new CollisionGroup(combinedName, combinedCategory, combinedMask);\r\n  }\r\n\r\n  /**\r\n   * Creates a collision group that collides with the listed groups\r\n   * @param collisionGroups\r\n   */\r\n  public static collidesWith(collisionGroups: CollisionGroup[]) {\r\n    return CollisionGroup.combine(collisionGroups).invert();\r\n  }\r\n}\r\n","import { CollisionContact } from './CollisionContact';\r\nimport { CollisionType } from '../CollisionType';\r\nimport { BodyComponent } from '../BodyComponent';\r\nimport { Id } from '../../Id';\r\nimport { Collider } from '../Colliders/Collider';\r\n\r\n/**\r\n * Models a potential collision between 2 colliders\r\n */\r\nexport class Pair {\r\n  public id: string = null;\r\n  constructor(public colliderA: Collider, public colliderB: Collider) {\r\n    this.id = Pair.calculatePairHash(colliderA.id, colliderB.id);\r\n  }\r\n\r\n  /**\r\n   * Returns whether a it is allowed for 2 colliders in a Pair to collide\r\n   * @param colliderA\r\n   * @param colliderB\r\n   */\r\n  public static canCollide(colliderA: Collider, colliderB: Collider) {\r\n    const bodyA = colliderA?.owner?.get(BodyComponent);\r\n    const bodyB = colliderB?.owner?.get(BodyComponent);\r\n\r\n    // Prevent self collision\r\n    if (colliderA.id === colliderB.id) {\r\n      return false;\r\n    }\r\n\r\n    // Colliders with the same owner do not collide (composite colliders)\r\n    if (colliderA.owner &&\r\n        colliderB.owner &&\r\n        colliderA.owner.id === colliderB.owner.id) {\r\n      return false;\r\n    }\r\n\r\n    // if the pair has a member with zero dimension don't collide\r\n    if (colliderA.localBounds.hasZeroDimensions() || colliderB.localBounds.hasZeroDimensions()) {\r\n      return false;\r\n    }\r\n\r\n    // Body's needed for collision in the current state\r\n    // TODO can we collide without a body?\r\n    if (!bodyA || !bodyB) {\r\n      return false;\r\n    }\r\n\r\n    // If both are in the same collision group short circuit\r\n    if (!bodyA.group.canCollide(bodyB.group)) {\r\n      return false;\r\n    }\r\n\r\n    // if both are fixed short circuit\r\n    if (bodyA.collisionType === CollisionType.Fixed && bodyB.collisionType === CollisionType.Fixed) {\r\n      return false;\r\n    }\r\n\r\n    // if the either is prevent collision short circuit\r\n    if (bodyB.collisionType === CollisionType.PreventCollision || bodyA.collisionType === CollisionType.PreventCollision) {\r\n      return false;\r\n    }\r\n\r\n    // if either is dead short circuit\r\n    if (!bodyA.active || !bodyB.active) {\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Returns whether or not it is possible for the pairs to collide\r\n   */\r\n  public get canCollide(): boolean {\r\n    const colliderA = this.colliderA;\r\n    const colliderB = this.colliderB;\r\n    return Pair.canCollide(colliderA, colliderB);\r\n  }\r\n\r\n  /**\r\n   * Runs the collision intersection logic on the members of this pair\r\n   */\r\n  public collide(): CollisionContact[] {\r\n    return this.colliderA.collide(this.colliderB);\r\n  }\r\n\r\n  /**\r\n   * Check if the collider is part of the pair\r\n   * @param collider\r\n   */\r\n  public hasCollider(collider: Collider) {\r\n    return collider === this.colliderA || collider === this.colliderB;\r\n  }\r\n\r\n  /**\r\n   * Calculates the unique pair hash id for this collision pair (owning id)\r\n   */\r\n  public static calculatePairHash(idA: Id<'collider'>, idB: Id<'collider'>): string {\r\n    if (idA.value < idB.value) {\r\n      return `#${idA.value}+${idB.value}`;\r\n    } else {\r\n      return `#${idB.value}+${idA.value}`;\r\n    }\r\n  }\r\n}\r\n","/**\r\n * A 1 dimensional projection on an axis, used to test overlaps\r\n */\r\n\r\nexport class Projection {\r\n  constructor(public min: number, public max: number) {}\r\n  public overlaps(projection: Projection): boolean {\r\n    return this.max > projection.min && projection.max > this.min;\r\n  }\r\n\r\n  public getOverlap(projection: Projection): number {\r\n    if (this.overlaps(projection)) {\r\n      if (this.max > projection.max) {\r\n        return projection.max - this.min;\r\n      } else {\r\n        return this.max - projection.min;\r\n      }\r\n    }\r\n    return 0;\r\n  }\r\n}\r\n","import { Physics } from '../Physics';\r\nimport { BoundingBox } from '../BoundingBox';\r\n\r\nimport { Ray } from '../../Math/ray';\r\nimport { Logger } from '../../Util/Log';\r\nimport { Id } from '../../Id';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { BodyComponent } from '../BodyComponent';\r\nimport { Color, ExcaliburGraphicsContext } from '../..';\r\n\r\n/**\r\n * Dynamic Tree Node used for tracking bounds within the tree\r\n */\r\nexport class TreeNode<T> {\r\n  public left: TreeNode<T>;\r\n  public right: TreeNode<T>;\r\n  public bounds: BoundingBox;\r\n  public height: number;\r\n  public data: T;\r\n  constructor(public parent?: TreeNode<T>) {\r\n    this.parent = parent || null;\r\n    this.data = null;\r\n    this.bounds = new BoundingBox();\r\n    this.left = null;\r\n    this.right = null;\r\n    this.height = 0;\r\n  }\r\n\r\n  public isLeaf(): boolean {\r\n    return !this.left && !this.right;\r\n  }\r\n}\r\n\r\nexport interface ColliderProxy<T> {\r\n  id: Id<'collider'>;\r\n  owner: T;\r\n  bounds: BoundingBox;\r\n}\r\n\r\n/**\r\n * The DynamicTrees provides a spatial partitioning data structure for quickly querying for overlapping bounding boxes for\r\n * all tracked bodies. The worst case performance of this is O(n*log(n)) where n is the number of bodies in the tree.\r\n *\r\n * Internally the bounding boxes are organized as a balanced binary tree of bounding boxes, where the leaf nodes are tracked bodies.\r\n * Every non-leaf node is a bounding box that contains child bounding boxes.\r\n */\r\nexport class DynamicTree<T extends ColliderProxy<Entity>> {\r\n  public root: TreeNode<T>;\r\n  public nodes: { [key: number]: TreeNode<T> };\r\n  constructor(public worldBounds: BoundingBox = new BoundingBox(-Number.MAX_VALUE, -Number.MAX_VALUE, Number.MAX_VALUE, Number.MAX_VALUE)) {\r\n    this.root = null;\r\n    this.nodes = {};\r\n  }\r\n\r\n  /**\r\n   * Inserts a node into the dynamic tree\r\n   */\r\n  private _insert(leaf: TreeNode<T>): void {\r\n    // If there are no nodes in the tree, make this the root leaf\r\n    if (this.root === null) {\r\n      this.root = leaf;\r\n      this.root.parent = null;\r\n      return;\r\n    }\r\n\r\n    // Search the tree for a node that is not a leaf and find the best place to insert\r\n    const leafAABB = leaf.bounds;\r\n    let currentRoot = this.root;\r\n    while (!currentRoot.isLeaf()) {\r\n      const left = currentRoot.left;\r\n      const right = currentRoot.right;\r\n\r\n      const area = currentRoot.bounds.getPerimeter();\r\n      const combinedAABB = currentRoot.bounds.combine(leafAABB);\r\n      const combinedArea = combinedAABB.getPerimeter();\r\n\r\n      // Calculate cost heuristic for creating a new parent and leaf\r\n      const cost = 2 * combinedArea;\r\n\r\n      // Minimum cost of pushing the leaf down the tree\r\n      const inheritanceCost = 2 * (combinedArea - area);\r\n\r\n      // Cost of descending\r\n      let leftCost = 0;\r\n      const leftCombined = leafAABB.combine(left.bounds);\r\n      let newArea;\r\n      let oldArea;\r\n      if (left.isLeaf()) {\r\n        leftCost = leftCombined.getPerimeter() + inheritanceCost;\r\n      } else {\r\n        oldArea = left.bounds.getPerimeter();\r\n        newArea = leftCombined.getPerimeter();\r\n        leftCost = newArea - oldArea + inheritanceCost;\r\n      }\r\n\r\n      let rightCost = 0;\r\n      const rightCombined = leafAABB.combine(right.bounds);\r\n      if (right.isLeaf()) {\r\n        rightCost = rightCombined.getPerimeter() + inheritanceCost;\r\n      } else {\r\n        oldArea = right.bounds.getPerimeter();\r\n        newArea = rightCombined.getPerimeter();\r\n        rightCost = newArea - oldArea + inheritanceCost;\r\n      }\r\n\r\n      // cost is acceptable\r\n      if (cost < leftCost && cost < rightCost) {\r\n        break;\r\n      }\r\n\r\n      // Descend to the depths\r\n      if (leftCost < rightCost) {\r\n        currentRoot = left;\r\n      } else {\r\n        currentRoot = right;\r\n      }\r\n    }\r\n\r\n    // Create the new parent node and insert into the tree\r\n    const oldParent = currentRoot.parent;\r\n    const newParent = new TreeNode(oldParent);\r\n    newParent.bounds = leafAABB.combine(currentRoot.bounds);\r\n    newParent.height = currentRoot.height + 1;\r\n\r\n    if (oldParent !== null) {\r\n      // The sibling node was not the root\r\n      if (oldParent.left === currentRoot) {\r\n        oldParent.left = newParent;\r\n      } else {\r\n        oldParent.right = newParent;\r\n      }\r\n\r\n      newParent.left = currentRoot;\r\n      newParent.right = leaf;\r\n\r\n      currentRoot.parent = newParent;\r\n      leaf.parent = newParent;\r\n    } else {\r\n      // The sibling node was the root\r\n      newParent.left = currentRoot;\r\n      newParent.right = leaf;\r\n\r\n      currentRoot.parent = newParent;\r\n      leaf.parent = newParent;\r\n      this.root = newParent;\r\n    }\r\n\r\n    // Walk up the tree fixing heights and AABBs\r\n    let currentNode = leaf.parent;\r\n    while (currentNode) {\r\n      currentNode = this._balance(currentNode);\r\n\r\n      if (!currentNode.left) {\r\n        throw new Error('Parent of current leaf cannot have a null left child' + currentNode);\r\n      }\r\n      if (!currentNode.right) {\r\n        throw new Error('Parent of current leaf cannot have a null right child' + currentNode);\r\n      }\r\n\r\n      currentNode.height = 1 + Math.max(currentNode.left.height, currentNode.right.height);\r\n      currentNode.bounds = currentNode.left.bounds.combine(currentNode.right.bounds);\r\n\r\n      currentNode = currentNode.parent;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes a node from the dynamic tree\r\n   */\r\n  private _remove(leaf: TreeNode<T>) {\r\n    if (leaf === this.root) {\r\n      this.root = null;\r\n      return;\r\n    }\r\n\r\n    const parent = leaf.parent;\r\n    const grandParent = parent.parent;\r\n    let sibling: TreeNode<T>;\r\n    if (parent.left === leaf) {\r\n      sibling = parent.right;\r\n    } else {\r\n      sibling = parent.left;\r\n    }\r\n\r\n    if (grandParent) {\r\n      if (grandParent.left === parent) {\r\n        grandParent.left = sibling;\r\n      } else {\r\n        grandParent.right = sibling;\r\n      }\r\n      sibling.parent = grandParent;\r\n\r\n      let currentNode = grandParent;\r\n      while (currentNode) {\r\n        currentNode = this._balance(currentNode);\r\n        currentNode.bounds = currentNode.left.bounds.combine(currentNode.right.bounds);\r\n        currentNode.height = 1 + Math.max(currentNode.left.height, currentNode.right.height);\r\n\r\n        currentNode = currentNode.parent;\r\n      }\r\n    } else {\r\n      this.root = sibling;\r\n      sibling.parent = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Tracks a body in the dynamic tree\r\n   */\r\n  public trackCollider(collider: T) {\r\n    const node = new TreeNode<T>();\r\n    node.data = collider;\r\n    node.bounds = collider.bounds;\r\n    node.bounds.left -= 2;\r\n    node.bounds.top -= 2;\r\n    node.bounds.right += 2;\r\n    node.bounds.bottom += 2;\r\n    this.nodes[collider.id.value] = node;\r\n    this._insert(node);\r\n  }\r\n\r\n  /**\r\n   * Updates the dynamic tree given the current bounds of each body being tracked\r\n   */\r\n  public updateCollider(collider: T) {\r\n    const node = this.nodes[collider.id.value];\r\n    if (!node) {\r\n      return false;\r\n    }\r\n    const b = collider.bounds;\r\n\r\n    // if the body is outside the world no longer update it\r\n    if (!this.worldBounds.contains(b)) {\r\n      Logger.getInstance().warn(\r\n        'Collider with id ' + collider.id.value + ' is outside the world bounds and will no longer be tracked for physics'\r\n      );\r\n      this.untrackCollider(collider);\r\n      return false;\r\n    }\r\n\r\n    if (node.bounds.contains(b)) {\r\n      return false;\r\n    }\r\n\r\n    this._remove(node);\r\n    b.left -= Physics.boundsPadding;\r\n    b.top -= Physics.boundsPadding;\r\n    b.right += Physics.boundsPadding;\r\n    b.bottom += Physics.boundsPadding;\r\n\r\n    // THIS IS CAUSING UNECESSARY CHECKS\r\n    if (collider.owner) {\r\n      const body = collider.owner?.get(BodyComponent);\r\n      if (body) {\r\n        const multdx = ((body.vel.x * 32) / 1000) * Physics.dynamicTreeVelocityMultiplier;\r\n        const multdy = ((body.vel.y * 32) / 1000) * Physics.dynamicTreeVelocityMultiplier;\r\n\r\n        if (multdx < 0) {\r\n          b.left += multdx;\r\n        } else {\r\n          b.right += multdx;\r\n        }\r\n\r\n        if (multdy < 0) {\r\n          b.top += multdy;\r\n        } else {\r\n          b.bottom += multdy;\r\n        }\r\n      }\r\n    }\r\n\r\n    node.bounds = b;\r\n    this._insert(node);\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Untracks a body from the dynamic tree\r\n   */\r\n  public untrackCollider(collider: T) {\r\n    const node = this.nodes[collider.id.value];\r\n    if (!node) {\r\n      return;\r\n    }\r\n    this._remove(node);\r\n    this.nodes[collider.id.value] = null;\r\n    delete this.nodes[collider.id.value];\r\n  }\r\n\r\n  /**\r\n   * Balances the tree about a node\r\n   */\r\n  private _balance(node: TreeNode<T>) {\r\n    if (node === null) {\r\n      throw new Error('Cannot balance at null node');\r\n    }\r\n\r\n    if (node.isLeaf() || node.height < 2) {\r\n      return node;\r\n    }\r\n\r\n    const left = node.left;\r\n    const right = node.right;\r\n\r\n    const a = node;\r\n    const b = left;\r\n    const c = right;\r\n    const d = left.left;\r\n    const e = left.right;\r\n    const f = right.left;\r\n    const g = right.right;\r\n\r\n    const balance = c.height - b.height;\r\n    // Rotate c node up\r\n    if (balance > 1) {\r\n      // Swap the right node with it's parent\r\n      c.left = a;\r\n      c.parent = a.parent;\r\n      a.parent = c;\r\n\r\n      // The original node's old parent should point to the right node\r\n      // this is mega confusing\r\n      if (c.parent) {\r\n        if (c.parent.left === a) {\r\n          c.parent.left = c;\r\n        } else {\r\n          c.parent.right = c;\r\n        }\r\n      } else {\r\n        this.root = c;\r\n      }\r\n\r\n      // Rotate\r\n      if (f.height > g.height) {\r\n        c.right = f;\r\n        a.right = g;\r\n        g.parent = a;\r\n\r\n        a.bounds = b.bounds.combine(g.bounds);\r\n        c.bounds = a.bounds.combine(f.bounds);\r\n\r\n        a.height = 1 + Math.max(b.height, g.height);\r\n        c.height = 1 + Math.max(a.height, f.height);\r\n      } else {\r\n        c.right = g;\r\n        a.right = f;\r\n        f.parent = a;\r\n\r\n        a.bounds = b.bounds.combine(f.bounds);\r\n        c.bounds = a.bounds.combine(g.bounds);\r\n\r\n        a.height = 1 + Math.max(b.height, f.height);\r\n        c.height = 1 + Math.max(a.height, g.height);\r\n      }\r\n\r\n      return c;\r\n    }\r\n    // Rotate left node up\r\n    if (balance < -1) {\r\n      // swap\r\n      b.left = a;\r\n      b.parent = a.parent;\r\n      a.parent = b;\r\n\r\n      // node's old parent should point to b\r\n      if (b.parent) {\r\n        if (b.parent.left === a) {\r\n          b.parent.left = b;\r\n        } else {\r\n          if (b.parent.right !== a) {\r\n            throw 'Error rotating Dynamic Tree';\r\n          }\r\n          b.parent.right = b;\r\n        }\r\n      } else {\r\n        this.root = b;\r\n      }\r\n\r\n      // rotate\r\n      if (d.height > e.height) {\r\n        b.right = d;\r\n        a.left = e;\r\n        e.parent = a;\r\n\r\n        a.bounds = c.bounds.combine(e.bounds);\r\n        b.bounds = a.bounds.combine(d.bounds);\r\n\r\n        a.height = 1 + Math.max(c.height, e.height);\r\n        b.height = 1 + Math.max(a.height, d.height);\r\n      } else {\r\n        b.right = e;\r\n        a.left = d;\r\n        d.parent = a;\r\n\r\n        a.bounds = c.bounds.combine(d.bounds);\r\n        b.bounds = a.bounds.combine(e.bounds);\r\n\r\n        a.height = 1 + Math.max(c.height, d.height);\r\n        b.height = 1 + Math.max(a.height, e.height);\r\n      }\r\n      return b;\r\n    }\r\n\r\n    return node;\r\n  }\r\n\r\n  /**\r\n   * Returns the internal height of the tree, shorter trees are better. Performance drops as the tree grows\r\n   */\r\n  public getHeight(): number {\r\n    if (this.root === null) {\r\n      return 0;\r\n    }\r\n    return this.root.height;\r\n  }\r\n\r\n  /**\r\n   * Queries the Dynamic Axis Aligned Tree for bodies that could be colliding with the provided body.\r\n   *\r\n   * In the query callback, it will be passed a potential collider. Returning true from this callback indicates\r\n   * that you are complete with your query and you do not want to continue. Returning false will continue searching\r\n   * the tree until all possible colliders have been returned.\r\n   */\r\n  public query(collider: T, callback: (other: T) => boolean): void {\r\n    const bounds = collider.bounds;\r\n    const helper = (currentNode: TreeNode<T>): boolean => {\r\n      if (currentNode && currentNode.bounds.overlaps(bounds)) {\r\n        if (currentNode.isLeaf() && currentNode.data !== collider) {\r\n          if (callback.call(collider, currentNode.data)) {\r\n            return true;\r\n          }\r\n        } else {\r\n          return helper(currentNode.left) || helper(currentNode.right);\r\n        }\r\n      }\r\n      return false;\r\n    };\r\n    helper(this.root);\r\n  }\r\n\r\n  /**\r\n   * Queries the Dynamic Axis Aligned Tree for bodies that could be intersecting. By default the raycast query uses an infinitely\r\n   * long ray to test the tree specified by `max`.\r\n   *\r\n   * In the query callback, it will be passed a potential body that intersects with the raycast. Returning true from this\r\n   * callback indicates that your are complete with your query and do not want to continue. Return false will continue searching\r\n   * the tree until all possible bodies that would intersect with the ray have been returned.\r\n   */\r\n  public rayCastQuery(ray: Ray, max: number = Infinity, callback: (other: T) => boolean): void {\r\n    const helper = (currentNode: TreeNode<T>): boolean => {\r\n      if (currentNode && currentNode.bounds.rayCast(ray, max)) {\r\n        if (currentNode.isLeaf()) {\r\n          if (callback.call(ray, currentNode.data)) {\r\n            // ray hit a leaf! return the body\r\n            return true;\r\n          }\r\n        } else {\r\n          // ray hit but not at a leaf, recurse deeper\r\n          return helper(currentNode.left) || helper(currentNode.right);\r\n        }\r\n      }\r\n      return false; // ray missed\r\n    };\r\n    helper(this.root);\r\n  }\r\n\r\n  public getNodes(): TreeNode<T>[] {\r\n    const helper = (currentNode: TreeNode<T>): TreeNode<T>[] => {\r\n      if (currentNode) {\r\n        return [currentNode].concat(helper(currentNode.left), helper(currentNode.right));\r\n      } else {\r\n        return [];\r\n      }\r\n    };\r\n    return helper(this.root);\r\n  }\r\n\r\n  public debug(ex: ExcaliburGraphicsContext) {\r\n    // draw all the nodes in the Dynamic Tree\r\n    const helper = (currentNode: TreeNode<T>) => {\r\n      if (currentNode) {\r\n        if (currentNode.isLeaf()) {\r\n          currentNode.bounds.draw(ex, Color.Green);\r\n        } else {\r\n          currentNode.bounds.draw(ex, Color.White);\r\n        }\r\n\r\n        if (currentNode.left) {\r\n          helper(currentNode.left);\r\n        }\r\n        if (currentNode.right) {\r\n          helper(currentNode.right);\r\n        }\r\n      }\r\n    };\r\n\r\n    helper(this.root);\r\n  }\r\n}\r\n","import { LineSegment } from './line-segment';\r\nimport { Vector } from './vector';\r\n\r\n/**\r\n * A 2D ray that can be cast into the scene to do collision detection\r\n */\r\n\r\nexport class Ray {\r\n  public pos: Vector;\r\n  public dir: Vector;\r\n\r\n  /**\r\n   * @param pos The starting position for the ray\r\n   * @param dir The vector indicating the direction of the ray\r\n   */\r\n  constructor(pos: Vector, dir: Vector) {\r\n    this.pos = pos;\r\n    this.dir = dir.normalize();\r\n  }\r\n\r\n  /**\r\n   * Tests a whether this ray intersects with a line segment. Returns a number greater than or equal to 0 on success.\r\n   * This number indicates the mathematical intersection time.\r\n   * @param line  The line to test\r\n   */\r\n  public intersect(line: LineSegment): number {\r\n    const numerator = line.begin.sub(this.pos);\r\n\r\n    // Test is line and ray are parallel and non intersecting\r\n    if (this.dir.cross(line.getSlope()) === 0 && numerator.cross(this.dir) !== 0) {\r\n      return -1;\r\n    }\r\n\r\n    // Lines are parallel\r\n    const divisor = this.dir.cross(line.getSlope());\r\n    if (divisor === 0) {\r\n      return -1;\r\n    }\r\n\r\n    const t = numerator.cross(line.getSlope()) / divisor;\r\n\r\n    if (t >= 0) {\r\n      const u = numerator.cross(this.dir) / divisor / line.getLength();\r\n      if (u >= 0 && u <= 1) {\r\n        return t;\r\n      }\r\n    }\r\n    return -1;\r\n  }\r\n\r\n  public intersectPoint(line: LineSegment): Vector {\r\n    const time = this.intersect(line);\r\n    if (time < 0) {\r\n      return null;\r\n    }\r\n    return this.getPoint(time);\r\n  }\r\n\r\n  /**\r\n   * Returns the point of intersection given the intersection time\r\n   */\r\n  public getPoint(time: number): Vector {\r\n    return this.pos.add(this.dir.scale(time));\r\n  }\r\n}\r\n","import { Physics } from '../Physics';\r\nimport { CollisionProcessor } from './CollisionProcessor';\r\nimport { DynamicTree } from './DynamicTree';\r\nimport { Pair } from './Pair';\r\n\r\nimport { Vector } from '../../Math/vector';\r\nimport { Ray } from '../../Math/ray';\r\nimport { FrameStats } from '../../Debug';\r\nimport { Logger } from '../../Util/Log';\r\nimport { CollisionType } from '../CollisionType';\r\nimport { Collider } from '../Colliders/Collider';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { BodyComponent } from '../BodyComponent';\r\nimport { CompositeCollider } from '../Colliders/CompositeCollider';\r\nimport { ExcaliburGraphicsContext } from '../..';\r\n\r\n/**\r\n * Responsible for performing the collision broadphase (locating potential collisions) and\r\n * the narrowphase (actual collision contacts)\r\n */\r\nexport class DynamicTreeCollisionProcessor implements CollisionProcessor {\r\n  private _dynamicCollisionTree = new DynamicTree<Collider>();\r\n  private _pairs = new Set<string>();\r\n\r\n  private _collisionPairCache: Pair[] = [];\r\n  private _colliders: Collider[] = [];\r\n\r\n  public getColliders(): readonly Collider[] {\r\n    return this._colliders;\r\n  }\r\n\r\n  /**\r\n   * Tracks a physics body for collisions\r\n   */\r\n  public track(target: Collider): void {\r\n    if (!target) {\r\n      Logger.getInstance().warn('Cannot track null collider');\r\n      return;\r\n    }\r\n    if (target instanceof CompositeCollider) {\r\n      const colliders = target.getColliders();\r\n      for (const c of colliders) {\r\n        c.owner = target.owner;\r\n        this._colliders.push(c);\r\n        this._dynamicCollisionTree.trackCollider(c);\r\n      }\r\n    } else {\r\n      this._colliders.push(target);\r\n      this._dynamicCollisionTree.trackCollider(target);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Untracks a physics body\r\n   */\r\n  public untrack(target: Collider): void {\r\n    if (!target) {\r\n      Logger.getInstance().warn('Cannot untrack a null collider');\r\n      return;\r\n    }\r\n\r\n    if (target instanceof CompositeCollider) {\r\n      const colliders = target.getColliders();\r\n      for (const c of colliders) {\r\n        const index = this._colliders.indexOf(c);\r\n        if (index !== -1) {\r\n          this._colliders.splice(index, 1);\r\n        }\r\n        this._dynamicCollisionTree.untrackCollider(c);\r\n      }\r\n    } else {\r\n      const index = this._colliders.indexOf(target);\r\n      if (index !== -1) {\r\n        this._colliders.splice(index, 1);\r\n      }\r\n      this._dynamicCollisionTree.untrackCollider(target);\r\n    }\r\n  }\r\n\r\n  private _pairExists(colliderA: Collider, colliderB: Collider) {\r\n    // if the collision pair has been calculated already short circuit\r\n    const hash = Pair.calculatePairHash(colliderA.id, colliderB.id);\r\n    return this._pairs.has(hash);\r\n  }\r\n\r\n  /**\r\n   * Detects potential collision pairs in a broadphase approach with the dynamic AABB tree strategy\r\n   */\r\n  public broadphase(targets: Collider[], delta: number, stats?: FrameStats): Pair[] {\r\n    const seconds = delta / 1000;\r\n\r\n    // Retrieve the list of potential colliders, exclude killed, prevented, and self\r\n    const potentialColliders = targets.filter((other) => {\r\n      const body = other.owner?.get(BodyComponent);\r\n      return other.owner?.active && body.collisionType !== CollisionType.PreventCollision;\r\n    });\r\n\r\n    // clear old list of collision pairs\r\n    this._collisionPairCache = [];\r\n    this._pairs.clear();\r\n\r\n    // check for normal collision pairs\r\n    let collider: Collider;\r\n    for (let j = 0, l = potentialColliders.length; j < l; j++) {\r\n      collider = potentialColliders[j];\r\n      // Query the collision tree for potential colliders\r\n      this._dynamicCollisionTree.query(collider, (other: Collider) => {\r\n        if (!this._pairExists(collider, other) && Pair.canCollide(collider, other)) {\r\n          const pair = new Pair(collider, other);\r\n          this._pairs.add(pair.id);\r\n          this._collisionPairCache.push(pair);\r\n        }\r\n        // Always return false, to query whole tree. Returning true in the query method stops searching\r\n        return false;\r\n      });\r\n    }\r\n    if (stats) {\r\n      stats.physics.pairs = this._collisionPairCache.length;\r\n    }\r\n\r\n    // Check dynamic tree for fast moving objects\r\n    // Fast moving objects are those moving at least there smallest bound per frame\r\n    if (Physics.checkForFastBodies) {\r\n      for (const collider of potentialColliders) {\r\n        const body = collider.owner.get(BodyComponent);\r\n        // Skip non-active objects. Does not make sense on other collision types\r\n        if (body.collisionType !== CollisionType.Active) {\r\n          continue;\r\n        }\r\n\r\n        // Maximum travel distance next frame\r\n        const updateDistance =\r\n          body.vel.size * seconds + // velocity term\r\n          body.acc.size * 0.5 * seconds * seconds; // acc term\r\n\r\n        // Find the minimum dimension\r\n        const minDimension = Math.min(collider.bounds.height, collider.bounds.width);\r\n        if (Physics.disableMinimumSpeedForFastBody || updateDistance > minDimension / 2) {\r\n          if (stats) {\r\n            stats.physics.fastBodies++;\r\n          }\r\n\r\n          // start with the oldPos because the integration for actors has already happened\r\n          // objects resting on a surface may be slightly penetrating in the current position\r\n          const updateVec = body.globalPos.sub(body.oldPos);\r\n          const centerPoint = collider.center;\r\n          const furthestPoint = collider.getFurthestPoint(body.vel);\r\n          const origin: Vector = furthestPoint.sub(updateVec);\r\n\r\n          const ray: Ray = new Ray(origin, body.vel);\r\n\r\n          // back the ray up by -2x surfaceEpsilon to account for fast moving objects starting on the surface\r\n          ray.pos = ray.pos.add(ray.dir.scale(-2 * Physics.surfaceEpsilon));\r\n          let minCollider: Collider;\r\n          let minTranslate: Vector = new Vector(Infinity, Infinity);\r\n          this._dynamicCollisionTree.rayCastQuery(ray, updateDistance + Physics.surfaceEpsilon * 2, (other: Collider) => {\r\n            if (!this._pairExists(collider, other) && Pair.canCollide(collider, other)) {\r\n              const hitPoint = other.rayCast(ray, updateDistance + Physics.surfaceEpsilon * 10);\r\n              if (hitPoint) {\r\n                const translate = hitPoint.sub(origin);\r\n                if (translate.size < minTranslate.size) {\r\n                  minTranslate = translate;\r\n                  minCollider = other;\r\n                }\r\n              }\r\n            }\r\n            return false;\r\n          });\r\n\r\n          if (minCollider && Vector.isValid(minTranslate)) {\r\n            const pair = new Pair(collider, minCollider);\r\n            if (!this._pairs.has(pair.id)) {\r\n              this._pairs.add(pair.id);\r\n              this._collisionPairCache.push(pair);\r\n            }\r\n            // move the fast moving object to the other body\r\n            // need to push into the surface by ex.Physics.surfaceEpsilon\r\n            const shift = centerPoint.sub(furthestPoint);\r\n            body.globalPos = origin\r\n              .add(shift)\r\n              .add(minTranslate)\r\n              .add(ray.dir.scale(10 * Physics.surfaceEpsilon)); // needed to push the shape slightly into contact\r\n            collider.update(body.transform.get());\r\n\r\n            if (stats) {\r\n              stats.physics.fastBodyCollisions++;\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n    // return cache\r\n    return this._collisionPairCache;\r\n  }\r\n\r\n  /**\r\n   * Applies narrow phase on collision pairs to find actual area intersections\r\n   * Adds actual colliding pairs to stats' Frame data\r\n   */\r\n  public narrowphase(pairs: Pair[], stats?: FrameStats): CollisionContact[] {\r\n    let contacts: CollisionContact[] = [];\r\n    for (let i = 0; i < pairs.length; i++) {\r\n      const newContacts = pairs[i].collide();\r\n      contacts = contacts.concat(newContacts);\r\n      if (stats && newContacts.length > 0) {\r\n        for (const c of newContacts) {\r\n          stats.physics.contacts.set(c.id, c);\r\n        }\r\n      }\r\n    }\r\n    if (stats) {\r\n      stats.physics.collisions += contacts.length;\r\n    }\r\n    return contacts;\r\n  }\r\n\r\n  /**\r\n   * Update the dynamic tree positions\r\n   */\r\n  public update(targets: Collider[]): number {\r\n    let updated = 0;\r\n    const len = targets.length;\r\n\r\n    for (let i = 0; i < len; i++) {\r\n      if (this._dynamicCollisionTree.updateCollider(targets[i])) {\r\n        updated++;\r\n      }\r\n    }\r\n    return updated;\r\n  }\r\n\r\n  public debug(ex: ExcaliburGraphicsContext) {\r\n    this._dynamicCollisionTree.debug(ex);\r\n  }\r\n}\r\n","import { Color } from '../../Color';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { BoundingBox } from '../BoundingBox';\r\nimport { Projection } from '../../Math/projection';\r\nimport { LineSegment } from '../../Math/line-segment';\r\nimport { Vector } from '../../Math/vector';\r\nimport { Ray } from '../../Math/ray';\r\nimport { Clonable } from '../../Interfaces/Clonable';\r\nimport { Entity } from '../../EntityComponentSystem';\r\nimport { createId, Id } from '../../Id';\r\nimport { EventDispatcher } from '../../EventDispatcher';\r\nimport { ExcaliburGraphicsContext } from '../../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { Transform } from '../../Math/transform';\r\n\r\n/**\r\n * A collision collider specifies the geometry that can detect when other collision colliders intersect\r\n * for the purposes of colliding 2 objects in excalibur.\r\n */\r\nexport abstract class Collider implements Clonable<Collider> {\r\n  private static _ID = 0;\r\n  public readonly id: Id<'collider'> = createId('collider', Collider._ID++);\r\n  /**\r\n   * Excalibur uses this to signal to the [[CollisionSystem]] this is part of a composite collider\r\n   * @internal\r\n   * @hidden\r\n   */\r\n  public __compositeColliderId: Id<'collider'> | null = null;\r\n  public events: EventDispatcher<Collider> = new EventDispatcher<Collider>();\r\n\r\n  /**\r\n   * Returns a boolean indicating whether this body collided with\r\n   * or was in stationary contact with\r\n   * the body of the other [[Collider]]\r\n   */\r\n  public touching(other: Collider): boolean {\r\n    const contact = this.collide(other);\r\n\r\n    if (contact) {\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  public owner: Entity;\r\n\r\n  /**\r\n   * Pixel offset of the collision collider relative to the collider, by default (0, 0) meaning the collider is positioned\r\n   * on top of the collider.\r\n   */\r\n  offset: Vector;\r\n\r\n  /**\r\n   * Position of the collision collider in world coordinates\r\n   */\r\n  abstract get worldPos(): Vector;\r\n\r\n  /**\r\n   * The center point of the collision collider, for example if the collider is a circle it would be the center.\r\n   */\r\n  abstract get center(): Vector;\r\n\r\n  /**\r\n   * Return the axis-aligned bounding box of the collision collider in world coordinates\r\n   */\r\n  abstract get bounds(): BoundingBox;\r\n\r\n  /**\r\n   * Return the axis-aligned bounding box of the collision collider in local coordinates\r\n   */\r\n  abstract get localBounds(): BoundingBox;\r\n\r\n  /**\r\n   * Return the axes of this particular collider\r\n   */\r\n  abstract get axes(): Vector[];\r\n  /**\r\n   * Find the furthest point on the convex hull of this particular collider in a certain direction.\r\n   */\r\n  abstract getFurthestPoint(direction: Vector): Vector;\r\n\r\n  abstract getInertia(mass: number): number;\r\n\r\n  // All new CollisionShape need to do the following\r\n  // Create a new collision function in the CollisionJumpTable against all the primitives\r\n  // Currently there are 3 primitive collision collider 3! = 6 jump functions\r\n  abstract collide(collider: Collider): CollisionContact[];\r\n\r\n  /**\r\n   * Returns the closest line between the surfaces this collider and another\r\n   * @param collider\r\n   */\r\n  abstract getClosestLineBetween(collider: Collider): LineSegment;\r\n\r\n  /**\r\n   * Return wether the collider contains a point inclusive to it's border\r\n   */\r\n  abstract contains(point: Vector): boolean;\r\n\r\n  /**\r\n   * Return the point on the border of the collision collider that intersects with a ray (if any).\r\n   */\r\n  abstract rayCast(ray: Ray, max?: number): Vector;\r\n\r\n  /**\r\n   * Create a projection of this collider along an axis. Think of this as casting a \"shadow\" along an axis\r\n   */\r\n  abstract project(axis: Vector): Projection;\r\n\r\n  /**\r\n   * Updates collider world space geometry\r\n   */\r\n  abstract update(transform: Transform): void;\r\n\r\n\r\n  abstract debug(ex: ExcaliburGraphicsContext, color: Color): void;\r\n\r\n  abstract clone(): Collider;\r\n}\r\n","import { Util } from '../..';\r\nimport { Pair } from '../Detection/Pair';\r\nimport { Color } from '../../Color';\r\nimport { ExcaliburGraphicsContext } from '../../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { LineSegment } from '../../Math/line-segment';\r\nimport { Projection } from '../../Math/projection';\r\nimport { Ray } from '../../Math/ray';\r\nimport { Vector } from '../../Math/vector';\r\nimport { BoundingBox } from '../BoundingBox';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { DynamicTree } from '../Detection/DynamicTree';\r\nimport { DynamicTreeCollisionProcessor } from '../Detection/DynamicTreeCollisionProcessor';\r\nimport { Collider } from './Collider';\r\nimport { Transform } from '../../Math/transform';\r\n\r\nexport class CompositeCollider extends Collider {\r\n  private _transform: Transform;\r\n  private _collisionProcessor = new DynamicTreeCollisionProcessor();\r\n  private _dynamicAABBTree = new DynamicTree();\r\n  private _colliders: Collider[] = [];\r\n\r\n  constructor(colliders: Collider[]) {\r\n    super();\r\n    for (const c of colliders) {\r\n      this.addCollider(c);\r\n    }\r\n  }\r\n\r\n  clearColliders() {\r\n    this._colliders = [];\r\n  }\r\n\r\n  addCollider(collider: Collider) {\r\n    this.events.wire(collider.events);\r\n    collider.__compositeColliderId = this.id;\r\n    this._colliders.push(collider);\r\n    this._collisionProcessor.track(collider);\r\n    this._dynamicAABBTree.trackCollider(collider);\r\n  }\r\n\r\n  removeCollider(collider: Collider) {\r\n    this.events.unwire(collider.events);\r\n    collider.__compositeColliderId = null;\r\n    Util.removeItemFromArray(collider, this._colliders);\r\n    this._collisionProcessor.untrack(collider);\r\n    this._dynamicAABBTree.untrackCollider(collider);\r\n  }\r\n\r\n  getColliders(): Collider[] {\r\n    return this._colliders;\r\n  }\r\n\r\n  get worldPos(): Vector {\r\n    // TODO transform component world pos\r\n    return this._transform?.pos ?? Vector.Zero;\r\n  }\r\n\r\n  get center(): Vector {\r\n    return this._transform?.pos ?? Vector.Zero;\r\n  }\r\n\r\n  get bounds(): BoundingBox {\r\n    // TODO cache this\r\n    const colliders = this.getColliders();\r\n    const results = colliders.reduce(\r\n      (acc, collider) => acc.combine(collider.bounds),\r\n      colliders[0]?.bounds ?? new BoundingBox().translate(this.worldPos)\r\n    );\r\n\r\n    return results;\r\n  }\r\n\r\n  get localBounds(): BoundingBox {\r\n    // TODO cache this\r\n    const colliders = this.getColliders();\r\n    const results = colliders.reduce((acc, collider) => acc.combine(collider.localBounds), colliders[0]?.localBounds ?? new BoundingBox());\r\n\r\n    return results;\r\n  }\r\n\r\n  get axes(): Vector[] {\r\n    // TODO cache this\r\n    const colliders = this.getColliders();\r\n    let axes: Vector[] = [];\r\n    for (const collider of colliders) {\r\n      axes = axes.concat(collider.axes);\r\n    }\r\n    return axes;\r\n  }\r\n\r\n  getFurthestPoint(direction: Vector): Vector {\r\n    const colliders = this.getColliders();\r\n    const furthestPoints: Vector[] = [];\r\n    for (const collider of colliders) {\r\n      furthestPoints.push(collider.getFurthestPoint(direction));\r\n    }\r\n    // Pick best point from all colliders\r\n    let bestPoint = furthestPoints[0];\r\n    let maxDistance = -Number.MAX_VALUE;\r\n    for (const point of furthestPoints) {\r\n      const distance = point.dot(direction);\r\n      if (distance > maxDistance) {\r\n        bestPoint = point;\r\n        maxDistance = distance;\r\n      }\r\n    }\r\n    return bestPoint;\r\n  }\r\n\r\n  getInertia(mass: number): number {\r\n    const colliders = this.getColliders();\r\n    let totalInertia = 0;\r\n    for (const collider of colliders) {\r\n      totalInertia += collider.getInertia(mass);\r\n    }\r\n    return totalInertia;\r\n  }\r\n\r\n  collide(other: Collider): CollisionContact[] {\r\n    let otherColliders = [other];\r\n    if (other instanceof CompositeCollider) {\r\n      otherColliders = other.getColliders();\r\n    }\r\n\r\n    const pairs: Pair[] = [];\r\n    for (const c of otherColliders) {\r\n      this._dynamicAABBTree.query(c, (potentialCollider: Collider) => {\r\n        pairs.push(new Pair(c, potentialCollider));\r\n        return false;\r\n      });\r\n    }\r\n\r\n    let contacts: CollisionContact[] = [];\r\n    for (const p of pairs) {\r\n      contacts = contacts.concat(p.collide());\r\n    }\r\n    return contacts;\r\n  }\r\n\r\n  getClosestLineBetween(other: Collider): LineSegment {\r\n    const colliders = this.getColliders();\r\n    const lines: LineSegment[] = [];\r\n    if (other instanceof CompositeCollider) {\r\n      const otherColliders = other.getColliders();\r\n      for (const colliderA of colliders) {\r\n        for (const colliderB of otherColliders) {\r\n          const maybeLine = colliderA.getClosestLineBetween(colliderB);\r\n          if (maybeLine) {\r\n            lines.push(maybeLine);\r\n          }\r\n        }\r\n      }\r\n    } else {\r\n      for (const collider of colliders) {\r\n        const maybeLine = other.getClosestLineBetween(collider);\r\n        if (maybeLine) {\r\n          lines.push(maybeLine);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (lines.length) {\r\n      let minLength = lines[0].getLength();\r\n      let minLine = lines[0];\r\n      for (const line of lines) {\r\n        const length = line.getLength();\r\n        if (length < minLength) {\r\n          minLength = length;\r\n          minLine = line;\r\n        }\r\n      }\r\n      return minLine;\r\n    }\r\n    return null;\r\n  }\r\n  contains(point: Vector): boolean {\r\n    const colliders = this.getColliders();\r\n    for (const collider of colliders) {\r\n      if (collider.contains(point)) {\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n  rayCast(ray: Ray, max?: number): Vector {\r\n    const colliders = this.getColliders();\r\n    const points: Vector[] = [];\r\n    for (const collider of colliders) {\r\n      const vec = collider.rayCast(ray, max);\r\n      if (vec) {\r\n        points.push(vec);\r\n      }\r\n    }\r\n    if (points.length) {\r\n      let minPoint = points[0];\r\n      let minDistance = minPoint.dot(ray.dir);\r\n      for (const point of points) {\r\n        const distance = ray.dir.dot(point);\r\n        if (distance < minDistance) {\r\n          minPoint = point;\r\n          minDistance = distance;\r\n        }\r\n      }\r\n      return minPoint;\r\n    }\r\n    return null;\r\n  }\r\n  project(axis: Vector): Projection {\r\n    const colliders = this.getColliders();\r\n    const projs: Projection[] = [];\r\n    for (const collider of colliders) {\r\n      const proj = collider.project(axis);\r\n      if (proj) {\r\n        projs.push(proj);\r\n      }\r\n    }\r\n    // Merge all proj's on the same axis\r\n    if (projs.length) {\r\n      const newProjection = new Projection(projs[0].min, projs[0].max);\r\n      for (const proj of projs) {\r\n        newProjection.min = Math.min(proj.min, newProjection.min);\r\n        newProjection.max = Math.max(proj.max, newProjection.max);\r\n      }\r\n      return newProjection;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  update(transform: Transform): void {\r\n    if (transform) {\r\n      const colliders = this.getColliders();\r\n      for (const collider of colliders) {\r\n        collider.owner = this.owner;\r\n        collider.update(transform);\r\n      }\r\n    }\r\n  }\r\n\r\n  public debug(ex: ExcaliburGraphicsContext, color: Color) {\r\n    const colliders = this.getColliders();\r\n    for (const collider of colliders) {\r\n      collider.debug(ex, color);\r\n    }\r\n  }\r\n\r\n  clone(): Collider {\r\n    return new CompositeCollider(this._colliders.map((c) => c.clone()));\r\n  }\r\n}\r\n","import { Vector } from './vector';\r\n\r\n/**\r\n * A 2D line segment\r\n */\r\n\r\nexport class LineSegment {\r\n\r\n  /**\r\n   * @param begin  The starting point of the line segment\r\n   * @param end  The ending point of the line segment\r\n   */\r\n  constructor(public readonly begin: Vector, public readonly end: Vector) {}\r\n\r\n  /**\r\n   * Gets the raw slope (m) of the line. Will return (+/-)Infinity for vertical lines.\r\n   */\r\n  public get slope() {\r\n    return (this.end.y - this.begin.y) / (this.end.x - this.begin.x);\r\n  }\r\n\r\n  /**\r\n   * Gets the Y-intercept (b) of the line. Will return (+/-)Infinity if there is no intercept.\r\n   */\r\n  public get intercept() {\r\n    return this.begin.y - this.slope * this.begin.x;\r\n  }\r\n\r\n  private _normal: Vector;\r\n  /**\r\n   * Gets the normal of the line\r\n   */\r\n  public normal(): Vector {\r\n    if (this._normal) {\r\n      return this._normal;\r\n    }\r\n    return this._normal = this.end.sub(this.begin).normal();\r\n  }\r\n\r\n  private _dir: Vector;\r\n  public dir(): Vector {\r\n    if (this._dir) {\r\n      return this._dir;\r\n    }\r\n    return this._dir = this.end.sub(this.begin);\r\n  }\r\n\r\n  public getPoints(): Vector[] {\r\n    return [this.begin, this.end];\r\n  }\r\n\r\n  private _slope: Vector;\r\n  /**\r\n   * Returns the slope of the line in the form of a vector of length 1\r\n   */\r\n  public getSlope(): Vector {\r\n    if (this._slope) {\r\n      return this._slope;\r\n    }\r\n    const begin = this.begin;\r\n    const end = this.end;\r\n    const distance = begin.distance(end);\r\n    return this._slope = end.sub(begin).scale(1 / distance);\r\n  }\r\n\r\n  /**\r\n   * Returns the edge of the line as vector, the length of the vector is the length of the edge\r\n   */\r\n  public getEdge(): Vector {\r\n    const begin = this.begin;\r\n    const end = this.end;\r\n    return end.sub(begin);\r\n  }\r\n\r\n  private _length: number;\r\n  /**\r\n   * Returns the length of the line segment in pixels\r\n   */\r\n  public getLength(): number {\r\n    if (this._length) {\r\n      return this._length;\r\n    }\r\n    const begin = this.begin;\r\n    const end = this.end;\r\n    const distance = begin.distance(end);\r\n    return this._length = distance;\r\n  }\r\n\r\n  /**\r\n   * Returns the midpoint of the edge\r\n   */\r\n  public get midpoint(): Vector {\r\n    return this.begin.add(this.end).scale(0.5);\r\n  }\r\n\r\n  /**\r\n   * Flips the direction of the line segment\r\n   */\r\n  public flip(): LineSegment {\r\n    return new LineSegment(this.end, this.begin);\r\n  }\r\n\r\n  /**\r\n   * Tests if a given point is below the line, points in the normal direction above the line are considered above.\r\n   * @param point\r\n   */\r\n  public below(point: Vector): boolean {\r\n    const above2 = (this.end.x - this.begin.x) * (point.y - this.begin.y) - (this.end.y - this.begin.y) * (point.x - this.begin.x);\r\n    return above2 >= 0;\r\n  }\r\n\r\n  /**\r\n   * Returns the clip point\r\n   * @param sideVector Vector that traces the line\r\n   * @param length Length to clip along side\r\n   */\r\n  public clip(sideVector: Vector, length: number): LineSegment {\r\n    let dir = sideVector;\r\n    dir = dir.normalize();\r\n\r\n    const near = dir.dot(this.begin) - length;\r\n    const far = dir.dot(this.end) - length;\r\n\r\n    const results = [];\r\n    if (near <= 0) {\r\n      results.push(this.begin);\r\n    }\r\n    if (far <= 0) {\r\n      results.push(this.end);\r\n    }\r\n\r\n    if (near * far < 0) {\r\n      const clipTime = near / (near - far);\r\n      results.push(this.begin.add(this.end.sub(this.begin).scale(clipTime)));\r\n    }\r\n    if (results.length !== 2) {\r\n      return null;\r\n    }\r\n\r\n    return new LineSegment(results[0], results[1]);\r\n  }\r\n\r\n  /**\r\n   * Find the perpendicular distance from the line to a point\r\n   * https://en.wikipedia.org/wiki/Distance_from_a_point_to_a_line\r\n   * @param point\r\n   */\r\n  public distanceToPoint(point: Vector, signed: boolean = false) {\r\n    const x0 = point.x;\r\n    const y0 = point.y;\r\n\r\n    const l = this.getLength();\r\n\r\n    const dy = this.end.y - this.begin.y;\r\n    const dx = this.end.x - this.begin.x;\r\n    const distance = (dy * x0 - dx * y0 + this.end.x * this.begin.y - this.end.y * this.begin.x) / l;\r\n    return signed ? distance : Math.abs(distance);\r\n  }\r\n\r\n  /**\r\n   * Find the perpendicular line from the line to a point\r\n   * https://en.wikipedia.org/wiki/Distance_from_a_point_to_a_line\r\n   * (a - p) - ((a - p) * n)n\r\n   * a is a point on the line\r\n   * p is the arbitrary point above the line\r\n   * n is a unit vector in direction of the line\r\n   * @param point\r\n   */\r\n  public findVectorToPoint(point: Vector): Vector {\r\n    const aMinusP = this.begin.sub(point);\r\n    const n = this.getSlope();\r\n\r\n    return aMinusP.sub(n.scale(aMinusP.dot(n)));\r\n  }\r\n\r\n  /**\r\n   * Finds a point on the line given only an X or a Y value. Given an X value, the function returns\r\n   * a new point with the calculated Y value and vice-versa.\r\n   *\r\n   * @param x The known X value of the target point\r\n   * @param y The known Y value of the target point\r\n   * @returns A new point with the other calculated axis value\r\n   */\r\n  public findPoint(x: number = null, y: number = null): Vector {\r\n    const m = this.slope;\r\n    const b = this.intercept;\r\n\r\n    if (x !== null) {\r\n      return new Vector(x, m * x + b);\r\n    } else if (y !== null) {\r\n      return new Vector((y - b) / m, y);\r\n    } else {\r\n      throw new Error('You must provide an X or a Y value');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Whether or not the given point lies on this line. This method is precise by default\r\n   * meaning the point must lie exactly on the line. Adjust threshold to\r\n   * loosen the strictness of the check for floating-point calculations.\r\n   */\r\n  public hasPoint(x: number, y: number, threshold?: number): boolean;\r\n\r\n  /**\r\n   * Whether or not the given point lies on this line. This method is precise by default\r\n   * meaning the point must lie exactly on the line. Adjust threshold to\r\n   * loosen the strictness of the check for floating-point calculations.\r\n   */\r\n  public hasPoint(v: Vector, threshold?: number): boolean;\r\n\r\n  /**\r\n   * @see http://stackoverflow.com/a/11908158/109458\r\n   */\r\n  public hasPoint(): boolean {\r\n    let currPoint: Vector;\r\n    let threshold = 0;\r\n\r\n    if (typeof arguments[0] === 'number' && typeof arguments[1] === 'number') {\r\n      currPoint = new Vector(arguments[0], arguments[1]);\r\n      threshold = arguments[2] || 0;\r\n    } else if (arguments[0] instanceof Vector) {\r\n      currPoint = arguments[0];\r\n      threshold = arguments[1] || 0;\r\n    } else {\r\n      throw 'Could not determine the arguments for Vector.hasPoint';\r\n    }\r\n\r\n    const dxc = currPoint.x - this.begin.x;\r\n    const dyc = currPoint.y - this.begin.y;\r\n\r\n    const dx1 = this.end.x - this.begin.x;\r\n    const dy1 = this.end.y - this.begin.y;\r\n\r\n    const cross = dxc * dy1 - dyc * dx1;\r\n\r\n    // check whether point lines on the line\r\n    if (Math.abs(cross) > threshold) {\r\n      return false;\r\n    }\r\n\r\n    // check whether point lies in-between start and end\r\n    if (Math.abs(dx1) >= Math.abs(dy1)) {\r\n      return dx1 > 0 ? this.begin.x <= currPoint.x && currPoint.x <= this.end.x : this.end.x <= currPoint.x && currPoint.x <= this.begin.x;\r\n    } else {\r\n      return dy1 > 0 ? this.begin.y <= currPoint.y && currPoint.y <= this.end.y : this.end.y <= currPoint.y && currPoint.y <= this.begin.y;\r\n    }\r\n  }\r\n}\r\n","import { LineSegment } from '../../Math/line-segment';\r\nimport { Vector } from '../../Math/vector';\r\nimport { Ray } from '../../Math/ray';\r\nimport { PolygonCollider } from './PolygonCollider';\r\nimport { EdgeCollider } from './EdgeCollider';\r\nimport { CircleCollider } from './CircleCollider';\r\n\r\n/**\r\n * Finds the closes line between 2 line segments, were the magnitude of u, v are the lengths of each segment\r\n * L1 = P(s) = p0 + s * u, where s is time and p0 is the start of the line\r\n * L2 = Q(t) = q0 + t * v, where t is time and q0 is the start of the line\r\n * @param p0 Point where L1 begins\r\n * @param u Direction and length of L1\r\n * @param q0 Point were L2 begins\r\n * @param v Direction and length of L2\r\n */\r\nexport function ClosestLine(p0: Vector, u: Vector, q0: Vector, v: Vector) {\r\n  // Distance between 2 lines http://geomalgorithms.com/a07-_distance.html\r\n\r\n  // w(s, t) = P(s) - Q(t)\r\n  // The w(s, t) that has the minimum distance we will say is w(sClosest, tClosest) = wClosest\r\n  //\r\n  // wClosest is the vector that is uniquely perpendicular to the 2 line directions u & v.\r\n  // wClosest = w0 + sClosest * u - tClosest * v, where w0 is p0 - q0\r\n  //\r\n  // The closest point between 2 lines then satisfies this pair of equations\r\n  // 1: u * wClosest = 0\r\n  // 2: v * wClosest = 0\r\n  //\r\n  // Substituting wClosest into the equations we get\r\n  //\r\n  // 1: (u * u) * sClosest - (u * v) tClosest = -u * w0\r\n  // 2: (v * u) * sClosest - (v * v) tClosest = -v * w0\r\n\r\n  // simplify w0\r\n  const w0 = p0.sub(q0);\r\n\r\n  // simplify (u * u);\r\n  const a = u.dot(u);\r\n  // simplify (u * v);\r\n  const b = u.dot(v);\r\n  // simplify (v * v)\r\n  const c = v.dot(v);\r\n  // simplify (u * w0)\r\n  const d = u.dot(w0);\r\n  // simplify (v * w0)\r\n  const e = v.dot(w0);\r\n\r\n  // denominator ac - b^2\r\n  const denom = a * c - b * b;\r\n  let sDenom = denom;\r\n  let tDenom = denom;\r\n  // if denom is 0 they are parallel, use any point from either as the start in this case p0\r\n  if (denom === 0 || denom <= 0.01) {\r\n    const tClosestParallel = d / b;\r\n    return new LineSegment(p0, q0.add(v.scale(tClosestParallel)));\r\n  }\r\n\r\n  // Solve for sClosest for infinite line\r\n  let sClosest = b * e - c * d; // / denom;\r\n\r\n  // Solve for tClosest for infinite line\r\n  let tClosest = a * e - b * d; // / denom;\r\n\r\n  // Solve for segments candidate edges, if sClosest and tClosest are outside their segments\r\n  if (sClosest < 0) {\r\n    sClosest = 0;\r\n    tClosest = e;\r\n    tDenom = c;\r\n  } else if (sClosest > sDenom) {\r\n    sClosest = sDenom;\r\n    tClosest = e + b;\r\n    tDenom = c;\r\n  }\r\n\r\n  if (tClosest < 0) {\r\n    tClosest = 0;\r\n    if (-d < 0) {\r\n      sClosest = 0;\r\n    } else if (-d > a) {\r\n      sClosest = sDenom;\r\n    } else {\r\n      sClosest = -d;\r\n      sDenom = a;\r\n    }\r\n  } else if (tClosest > tDenom) {\r\n    tClosest = tDenom;\r\n    if (-d + b < 0) {\r\n      sClosest = 0;\r\n    } else if (-d + b > a) {\r\n      sClosest = sDenom;\r\n    } else {\r\n      sClosest = -d + b;\r\n      sDenom = a;\r\n    }\r\n  }\r\n  sClosest = Math.abs(sClosest) < 0.001 ? 0 : sClosest / sDenom;\r\n  tClosest = Math.abs(tClosest) < 0.001 ? 0 : tClosest / tDenom;\r\n\r\n  return new LineSegment(p0.add(u.scale(sClosest)), q0.add(v.scale(tClosest)));\r\n}\r\n\r\nexport const ClosestLineJumpTable = {\r\n  PolygonPolygonClosestLine(polygonA: PolygonCollider, polygonB: PolygonCollider) {\r\n    // Find the 2 closest faces on each polygon\r\n    const otherWorldPos = polygonB.worldPos;\r\n    const otherDirection = otherWorldPos.sub(polygonA.worldPos);\r\n    const thisDirection = otherDirection.negate();\r\n\r\n    const rayTowardsOther = new Ray(polygonA.worldPos, otherDirection);\r\n    const rayTowardsThis = new Ray(otherWorldPos, thisDirection);\r\n\r\n    const thisPoint = polygonA.rayCast(rayTowardsOther).add(rayTowardsOther.dir.scale(0.1));\r\n    const otherPoint = polygonB.rayCast(rayTowardsThis).add(rayTowardsThis.dir.scale(0.1));\r\n\r\n    const thisFace = polygonA.getClosestFace(thisPoint);\r\n    const otherFace = polygonB.getClosestFace(otherPoint);\r\n\r\n    // L1 = P(s) = p0 + s * u, where s is time and p0 is the start of the line\r\n    const p0 = thisFace.face.begin;\r\n    const u = thisFace.face.getEdge();\r\n\r\n    // L2 = Q(t) = q0 + t * v, where t is time and q0 is the start of the line\r\n    const q0 = otherFace.face.begin;\r\n    const v = otherFace.face.getEdge();\r\n\r\n    return ClosestLine(p0, u, q0, v);\r\n  },\r\n\r\n  PolygonEdgeClosestLine(polygon: PolygonCollider, edge: EdgeCollider) {\r\n    // Find the 2 closest faces on each polygon\r\n    const otherWorldPos = edge.worldPos;\r\n    const otherDirection = otherWorldPos.sub(polygon.worldPos);\r\n\r\n    const rayTowardsOther = new Ray(polygon.worldPos, otherDirection);\r\n\r\n    const thisPoint = polygon.rayCast(rayTowardsOther).add(rayTowardsOther.dir.scale(0.1));\r\n\r\n    const thisFace = polygon.getClosestFace(thisPoint);\r\n\r\n    // L1 = P(s) = p0 + s * u, where s is time and p0 is the start of the line\r\n    const p0 = thisFace.face.begin;\r\n    const u = thisFace.face.getEdge();\r\n\r\n    // L2 = Q(t) = q0 + t * v, where t is time and q0 is the start of the line\r\n    const edgeLine = edge.asLine();\r\n    const edgeStart = edgeLine.begin;\r\n    const edgeVector = edgeLine.getEdge();\r\n    const q0 = edgeStart;\r\n    const v = edgeVector;\r\n\r\n    return ClosestLine(p0, u, q0, v);\r\n  },\r\n\r\n  PolygonCircleClosestLine(polygon: PolygonCollider, circle: CircleCollider) {\r\n    // https://math.stackexchange.com/questions/1919177/how-to-find-point-on-line-closest-to-sphere\r\n    // Find the 2 closest faces on each polygon\r\n    const otherWorldPos = circle.worldPos;\r\n    const otherDirection = otherWorldPos.sub(polygon.worldPos);\r\n\r\n    const rayTowardsOther = new Ray(polygon.worldPos, otherDirection.normalize());\r\n\r\n    const thisPoint = polygon.rayCast(rayTowardsOther).add(rayTowardsOther.dir.scale(0.1));\r\n\r\n    const thisFace = polygon.getClosestFace(thisPoint);\r\n\r\n    // L1 = P(s) = p0 + s * u, where s is time and p0 is the start of the line\r\n    const p0 = thisFace.face.begin;\r\n    const u = thisFace.face.getEdge();\r\n\r\n    // Time of minimum distance\r\n    let t = (u.x * (otherWorldPos.x - p0.x) + u.y * (otherWorldPos.y - p0.y)) / (u.x * u.x + u.y * u.y);\r\n\r\n    // If time of minimum is past the edge clamp\r\n    if (t > 1) {\r\n      t = 1;\r\n    } else if (t < 0) {\r\n      t = 0;\r\n    }\r\n\r\n    // Minimum distance\r\n    const d = Math.sqrt(Math.pow(p0.x + u.x * t - otherWorldPos.x, 2) + Math.pow(p0.y + u.y * t - otherWorldPos.y, 2)) - circle.radius;\r\n\r\n    const circlex = ((p0.x + u.x * t - otherWorldPos.x) * circle.radius) / (circle.radius + d);\r\n    const circley = ((p0.y + u.y * t - otherWorldPos.y) * circle.radius) / (circle.radius + d);\r\n    return new LineSegment(u.scale(t).add(p0), new Vector(otherWorldPos.x + circlex, otherWorldPos.y + circley));\r\n  },\r\n\r\n  CircleCircleClosestLine(circleA: CircleCollider, circleB: CircleCollider) {\r\n    // Find the 2 closest faces on each polygon\r\n    const otherWorldPos = circleB.worldPos;\r\n    const otherDirection = otherWorldPos.sub(circleA.worldPos);\r\n\r\n    const thisWorldPos = circleA.worldPos;\r\n    const thisDirection = thisWorldPos.sub(circleB.worldPos);\r\n\r\n    const rayTowardsOther = new Ray(circleA.worldPos, otherDirection);\r\n    const rayTowardsThis = new Ray(circleB.worldPos, thisDirection);\r\n\r\n    const thisPoint = circleA.rayCast(rayTowardsOther);\r\n    const otherPoint = circleB.rayCast(rayTowardsThis);\r\n\r\n    return new LineSegment(thisPoint, otherPoint);\r\n  },\r\n\r\n  CircleEdgeClosestLine(circle: CircleCollider, edge: EdgeCollider) {\r\n    // https://math.stackexchange.com/questions/1919177/how-to-find-point-on-line-closest-to-sphere\r\n    const circleWorlPos = circle.worldPos;\r\n\r\n    // L1 = P(s) = p0 + s * u, where s is time and p0 is the start of the line\r\n    const edgeLine = edge.asLine();\r\n    const edgeStart = edgeLine.begin;\r\n    const edgeVector = edgeLine.getEdge();\r\n    const p0 = edgeStart;\r\n    const u = edgeVector;\r\n\r\n    // Time of minimum distance\r\n    let t = (u.x * (circleWorlPos.x - p0.x) + u.y * (circleWorlPos.y - p0.y)) / (u.x * u.x + u.y * u.y);\r\n\r\n    // If time of minimum is past the edge clamp to edge\r\n    if (t > 1) {\r\n      t = 1;\r\n    } else if (t < 0) {\r\n      t = 0;\r\n    }\r\n\r\n    // Minimum distance\r\n    const d = Math.sqrt(Math.pow(p0.x + u.x * t - circleWorlPos.x, 2) + Math.pow(p0.y + u.y * t - circleWorlPos.y, 2)) - circle.radius;\r\n\r\n    const circlex = ((p0.x + u.x * t - circleWorlPos.x) * circle.radius) / (circle.radius + d);\r\n    const circley = ((p0.y + u.y * t - circleWorlPos.y) * circle.radius) / (circle.radius + d);\r\n    return new LineSegment(u.scale(t).add(p0), new Vector(circleWorlPos.x + circlex, circleWorlPos.y + circley));\r\n  },\r\n\r\n  EdgeEdgeClosestLine(edgeA: EdgeCollider, edgeB: EdgeCollider) {\r\n    // L1 = P(s) = p0 + s * u, where s is time and p0 is the start of the line\r\n    const edgeLineA = edgeA.asLine();\r\n    const edgeStartA = edgeLineA.begin;\r\n    const edgeVectorA = edgeLineA.getEdge();\r\n    const p0 = edgeStartA;\r\n    const u = edgeVectorA;\r\n\r\n    // L2 = Q(t) = q0 + t * v, where t is time and q0 is the start of the line\r\n    const edgeLineB = edgeB.asLine();\r\n    const edgeStartB = edgeLineB.begin;\r\n    const edgeVectorB = edgeLineB.getEdge();\r\n    const q0 = edgeStartB;\r\n    const v = edgeVectorB;\r\n\r\n    return ClosestLine(p0, u, q0, v);\r\n  }\r\n};\r\n","import { BoundingBox } from '../BoundingBox';\r\nimport { CollisionJumpTable } from './CollisionJumpTable';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { PolygonCollider } from './PolygonCollider';\r\nimport { EdgeCollider } from './EdgeCollider';\r\n\r\nimport { Projection } from '../../Math/projection';\r\nimport { LineSegment } from '../../Math/line-segment';\r\nimport { Vector } from '../../Math/vector';\r\nimport { Ray } from '../../Math/ray';\r\nimport { Color } from '../../Color';\r\nimport { Collider } from './Collider';\r\n\r\nimport { ClosestLineJumpTable } from './ClosestLineJumpTable';\r\nimport { ExcaliburGraphicsContext } from '../../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { Transform } from '../../Math/transform';\r\nimport { AffineMatrix } from '../../Math/affine-matrix';\r\n\r\nexport interface CircleColliderOptions {\r\n  /**\r\n   * Optional pixel offset to shift the circle relative to the collider, by default (0, 0).\r\n   */\r\n  offset?: Vector;\r\n  /**\r\n   * Required radius of the circle\r\n   */\r\n  radius: number;\r\n}\r\n\r\n/**\r\n * This is a circle collider for the excalibur rigid body physics simulation\r\n */\r\nexport class CircleCollider extends Collider {\r\n  /**\r\n   * Position of the circle relative to the collider, by default (0, 0).\r\n   */\r\n  public offset: Vector = Vector.Zero;\r\n\r\n  private _globalMatrix: AffineMatrix = AffineMatrix.identity();\r\n\r\n  public get worldPos(): Vector {\r\n    return this._globalMatrix.getPosition();\r\n  }\r\n\r\n  private _naturalRadius: number;\r\n  /**\r\n   * Get the radius of the circle\r\n   */\r\n  public get radius(): number {\r\n    const tx = this._transform;\r\n    const scale = tx?.globalScale ?? Vector.One;\r\n    // This is a trade off, the alternative is retooling circles to support ellipse collisions\r\n    return this._naturalRadius * Math.min(scale.x, scale.y);\r\n  }\r\n\r\n  /**\r\n   * Set the radius of the circle\r\n   */\r\n  public set radius(val: number) {\r\n    const tx = this._transform;\r\n    const scale = tx?.globalScale ?? Vector.One;\r\n    // This is a trade off, the alternative is retooling circles to support ellipse collisions\r\n    this._naturalRadius = val / Math.min(scale.x, scale.y);\r\n  }\r\n\r\n  private _transform: Transform;\r\n\r\n  constructor(options: CircleColliderOptions) {\r\n    super();\r\n    this.offset = options.offset || Vector.Zero;\r\n    this.radius = options.radius || 0;\r\n    this._globalMatrix.translate(this.offset.x, this.offset.y);\r\n  }\r\n\r\n  /**\r\n   * Returns a clone of this shape, not associated with any collider\r\n   */\r\n  public clone(): CircleCollider {\r\n    return new CircleCollider({\r\n      offset: this.offset.clone(),\r\n      radius: this.radius\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get the center of the collider in world coordinates\r\n   */\r\n  public get center(): Vector {\r\n    return this._globalMatrix.getPosition();\r\n  }\r\n\r\n  /**\r\n   * Tests if a point is contained in this collider\r\n   */\r\n  public contains(point: Vector): boolean {\r\n    const pos = this._transform?.pos ?? this.offset;\r\n    const distance = pos.distance(point);\r\n    if (distance <= this.radius) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Casts a ray at the Circle collider and returns the nearest point of collision\r\n   * @param ray\r\n   */\r\n  public rayCast(ray: Ray, max: number = Infinity): Vector {\r\n    //https://en.wikipedia.org/wiki/Line%E2%80%93sphere_intersection\r\n    const c = this.center;\r\n    const dir = ray.dir;\r\n    const orig = ray.pos;\r\n\r\n    const discriminant = Math.sqrt(Math.pow(dir.dot(orig.sub(c)), 2) - Math.pow(orig.sub(c).distance(), 2) + Math.pow(this.radius, 2));\r\n\r\n    if (discriminant < 0) {\r\n      // no intersection\r\n      return null;\r\n    } else {\r\n      let toi = 0;\r\n      if (discriminant === 0) {\r\n        toi = -dir.dot(orig.sub(c));\r\n        if (toi > 0 && toi < max) {\r\n          return ray.getPoint(toi);\r\n        }\r\n        return null;\r\n      } else {\r\n        const toi1 = -dir.dot(orig.sub(c)) + discriminant;\r\n        const toi2 = -dir.dot(orig.sub(c)) - discriminant;\r\n\r\n        const positiveToi: number[] = [];\r\n        if (toi1 >= 0) {\r\n          positiveToi.push(toi1);\r\n        }\r\n\r\n        if (toi2 >= 0) {\r\n          positiveToi.push(toi2);\r\n        }\r\n\r\n        const mintoi = Math.min(...positiveToi);\r\n        if (mintoi <= max) {\r\n          return ray.getPoint(mintoi);\r\n        }\r\n        return null;\r\n      }\r\n    }\r\n  }\r\n\r\n  public getClosestLineBetween(shape: Collider): LineSegment {\r\n    if (shape instanceof CircleCollider) {\r\n      return ClosestLineJumpTable.CircleCircleClosestLine(this, shape);\r\n    } else if (shape instanceof PolygonCollider) {\r\n      return ClosestLineJumpTable.PolygonCircleClosestLine(shape, this).flip();\r\n    } else if (shape instanceof EdgeCollider) {\r\n      return ClosestLineJumpTable.CircleEdgeClosestLine(this, shape).flip();\r\n    } else {\r\n      throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof shape}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @inheritdoc\r\n   */\r\n  public collide(collider: Collider): CollisionContact[] {\r\n    if (collider instanceof CircleCollider) {\r\n      return CollisionJumpTable.CollideCircleCircle(this, collider);\r\n    } else if (collider instanceof PolygonCollider) {\r\n      return CollisionJumpTable.CollideCirclePolygon(this, collider);\r\n    } else if (collider instanceof EdgeCollider) {\r\n      return CollisionJumpTable.CollideCircleEdge(this, collider);\r\n    } else {\r\n      throw new Error(`Circle could not collide with unknown CollisionShape ${typeof collider}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Find the point on the collider furthest in the direction specified\r\n   */\r\n  public getFurthestPoint(direction: Vector): Vector {\r\n    return this.center.add(direction.normalize().scale(this.radius));\r\n  }\r\n\r\n  /**\r\n   * Find the local point on the shape in the direction specified\r\n   * @param direction\r\n   */\r\n  public getFurthestLocalPoint(direction: Vector): Vector {\r\n    const dir = direction.normalize();\r\n    return dir.scale(this.radius);\r\n  }\r\n\r\n  /**\r\n   * Get the axis aligned bounding box for the circle collider in world coordinates\r\n   */\r\n  public get bounds(): BoundingBox {\r\n    const tx = this._transform;\r\n    const scale = tx?.globalScale ?? Vector.One;\r\n    const rotation = tx?.globalRotation ?? 0;\r\n    const pos = (tx?.globalPos ?? Vector.Zero);\r\n    return new BoundingBox(\r\n      this.offset.x - this._naturalRadius,\r\n      this.offset.y - this._naturalRadius,\r\n      this.offset.x + this._naturalRadius,\r\n      this.offset.y + this._naturalRadius\r\n    ).rotate(rotation).scale(scale).translate(pos);\r\n  }\r\n\r\n  /**\r\n   * Get the axis aligned bounding box for the circle collider in local coordinates\r\n   */\r\n  public get localBounds(): BoundingBox {\r\n    return new BoundingBox(\r\n      this.offset.x - this._naturalRadius,\r\n      this.offset.y - this._naturalRadius,\r\n      this.offset.x + this._naturalRadius,\r\n      this.offset.y + this._naturalRadius\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get axis not implemented on circles, since there are infinite axis in a circle\r\n   */\r\n  public get axes(): Vector[] {\r\n    return [];\r\n  }\r\n\r\n  /**\r\n   * Returns the moment of inertia of a circle given it's mass\r\n   * https://en.wikipedia.org/wiki/List_of_moments_of_inertia\r\n   */\r\n  public getInertia(mass: number): number {\r\n    return (mass * this.radius * this.radius) / 2;\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public update(transform: Transform): void {\r\n    this._transform = transform;\r\n    const globalMat = transform.matrix ?? this._globalMatrix;\r\n    globalMat.clone(this._globalMatrix);\r\n    this._globalMatrix.translate(this.offset.x, this.offset.y);\r\n  }\r\n\r\n  /**\r\n   * Project the circle along a specified axis\r\n   */\r\n  public project(axis: Vector): Projection {\r\n    const scalars = [];\r\n    const point = this.center;\r\n    const dotProduct = point.dot(axis);\r\n    scalars.push(dotProduct);\r\n    scalars.push(dotProduct + this.radius);\r\n    scalars.push(dotProduct - this.radius);\r\n    return new Projection(Math.min.apply(Math, scalars), Math.max.apply(Math, scalars));\r\n  }\r\n\r\n  public debug(ex: ExcaliburGraphicsContext, color: Color) {\r\n    const tx = this._transform;\r\n    const scale = tx?.globalScale ?? Vector.One;\r\n    const rotation = tx?.globalRotation ?? 0;\r\n    const pos = (tx?.globalPos ?? Vector.Zero);\r\n    ex.save();\r\n    ex.translate(pos.x, pos.y);\r\n    ex.rotate(rotation);\r\n    ex.scale(scale.x, scale.y);\r\n    ex.drawCircle((this.offset ?? Vector.Zero), this._naturalRadius, Color.Transparent, color, 2);\r\n    ex.restore();\r\n  }\r\n}\r\n","import { Vector } from '../../Math/vector';\r\nimport { Physics } from '../Physics';\r\nimport { Collider } from '../Colliders/Collider';\r\nimport { CollisionType } from '../CollisionType';\r\nimport { Pair } from './Pair';\r\nimport { SeparationInfo } from '../Colliders/SeparatingAxis';\r\nimport { BodyComponent } from '../BodyComponent';\r\n\r\n/**\r\n * Collision contacts are used internally by Excalibur to resolve collision between colliders. This\r\n * Pair prevents collisions from being evaluated more than one time\r\n */\r\nexport class CollisionContact {\r\n  private _canceled = false;\r\n\r\n  /**\r\n   * Currently the ids between colliders\r\n   */\r\n  readonly id: string;\r\n\r\n  /**\r\n   * The first collider in the collision\r\n   */\r\n  colliderA: Collider;\r\n\r\n  /**\r\n   * The second collider in the collision\r\n   */\r\n  colliderB: Collider;\r\n\r\n  /**\r\n   * The minimum translation vector to resolve overlap, pointing away from colliderA\r\n   */\r\n  mtv: Vector;\r\n\r\n  /**\r\n   * World space contact points between colliderA and colliderB\r\n   */\r\n  points: Vector[];\r\n\r\n  /**\r\n   * Local space contact points between colliderA and colliderB\r\n   */\r\n  localPoints: Vector[];\r\n\r\n  /**\r\n   * The collision normal, pointing away from colliderA\r\n   */\r\n  normal: Vector;\r\n\r\n  /**\r\n   * The collision tangent\r\n   */\r\n  tangent: Vector;\r\n\r\n  /**\r\n   * Information about the specifics of the collision contact separation\r\n   */\r\n  info: SeparationInfo;\r\n\r\n  constructor(\r\n    colliderA: Collider,\r\n    colliderB: Collider,\r\n    mtv: Vector,\r\n    normal: Vector,\r\n    tangent: Vector,\r\n    points: Vector[],\r\n    localPoints: Vector[],\r\n    info: SeparationInfo\r\n  ) {\r\n    this.colliderA = colliderA;\r\n    this.colliderB = colliderB;\r\n    this.mtv = mtv;\r\n    this.normal = normal;\r\n    this.tangent = tangent;\r\n    this.points = points;\r\n    this.localPoints = localPoints;\r\n    this.info = info;\r\n    this.id = Pair.calculatePairHash(colliderA.id, colliderB.id);\r\n    if (colliderA.__compositeColliderId || colliderB.__compositeColliderId) {\r\n      // Add on the parent composite pair for start/end contact\r\n      this.id += '|' + Pair.calculatePairHash(\r\n        colliderA.__compositeColliderId ?? colliderA.id,\r\n        colliderB.__compositeColliderId ?? colliderB.id);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Match contact awake state, except if body's are Fixed\r\n   */\r\n  public matchAwake(): void {\r\n    const bodyA = this.colliderA.owner.get(BodyComponent);\r\n    const bodyB = this.colliderB.owner.get(BodyComponent);\r\n    if (bodyA && bodyB) {\r\n      if (bodyA.sleeping !== bodyB.sleeping) {\r\n        if (bodyA.sleeping && bodyA.collisionType !== CollisionType.Fixed && bodyB.sleepMotion >= Physics.wakeThreshold) {\r\n          bodyA.setSleeping(false);\r\n        }\r\n        if (bodyB.sleeping && bodyB.collisionType !== CollisionType.Fixed && bodyA.sleepMotion >= Physics.wakeThreshold) {\r\n          bodyB.setSleeping(false);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public isCanceled() {\r\n    return this._canceled;\r\n  }\r\n\r\n  public cancel(): void {\r\n    this._canceled = true;\r\n  }\r\n}\r\n","import { LineSegment } from '../../Math/line-segment';\r\nimport { Vector } from '../../Math/vector';\r\nimport { Collider } from './Collider';\r\nimport { CircleCollider } from './CircleCollider';\r\nimport { PolygonCollider } from './PolygonCollider';\r\n\r\n/**\r\n * Specific information about a contact and it's separation\r\n */\r\nexport interface SeparationInfo {\r\n  /**\r\n   * Collider A\r\n   */\r\n  collider: Collider;\r\n\r\n  /**\r\n   * Signed value (negative means overlap, positive no overlap)\r\n   */\r\n  separation: number;\r\n\r\n  /**\r\n   * Axis of separation from the collider's perspective\r\n   */\r\n  axis: Vector;\r\n\r\n  /**\r\n   * Side of separation (reference) from the collider's perspective\r\n   */\r\n\r\n  side?: LineSegment;\r\n\r\n  /**\r\n   * Local side of separation (reference) from the collider's perspective\r\n   */\r\n  localSide?: LineSegment;\r\n\r\n  /**\r\n   * Index of the separation side (reference) from the collider's perspective\r\n   */\r\n  sideId?: number;\r\n\r\n  /**\r\n   * Point on collider B (incident point)\r\n   */\r\n  point: Vector;\r\n\r\n  /**\r\n   * Local point on collider B (incident point)\r\n   */\r\n  localPoint?: Vector;\r\n}\r\n\r\nexport class SeparatingAxis {\r\n  static findPolygonPolygonSeparation(polyA: PolygonCollider, polyB: PolygonCollider): SeparationInfo {\r\n    let bestSeparation = -Number.MAX_VALUE;\r\n    let bestSide: LineSegment | null = null;\r\n    let bestAxis: Vector | null = null;\r\n    let bestSideIndex: number = -1;\r\n    let bestOtherPoint: Vector | null = null;\r\n    const sides = polyA.getSides();\r\n    const localSides = polyA.getLocalSides();\r\n    for (let i = 0; i < sides.length; i++) {\r\n      const side = sides[i];\r\n      const axis = side.normal();\r\n      const vertB = polyB.getFurthestPoint(axis.negate());\r\n      // Separation on side i's axis\r\n      // We are looking for the largest separation between poly A's sides\r\n      const vertSeparation = side.distanceToPoint(vertB, true);\r\n      if (vertSeparation > bestSeparation) {\r\n        bestSeparation = vertSeparation;\r\n        bestSide = side;\r\n        bestAxis = axis;\r\n        bestSideIndex = i;\r\n        bestOtherPoint = vertB;\r\n      }\r\n    }\r\n\r\n    return {\r\n      collider: polyA,\r\n      separation: bestAxis ? bestSeparation : 99,\r\n      axis: bestAxis as Vector,\r\n      side: bestSide,\r\n      localSide: localSides[bestSideIndex],\r\n      sideId: bestSideIndex,\r\n      point: bestOtherPoint as Vector,\r\n      localPoint: bestAxis ? polyB.getFurthestLocalPoint(bestAxis!.negate()) : null\r\n    };\r\n  }\r\n\r\n  static findCirclePolygonSeparation(circle: CircleCollider, polygon: PolygonCollider): Vector | null {\r\n    const axes = polygon.axes;\r\n    const pc = polygon.center;\r\n    // Special SAT with circles\r\n    const polyDir = pc.sub(circle.worldPos);\r\n    const closestPointOnPoly = polygon.getFurthestPoint(polyDir.negate());\r\n    axes.push(closestPointOnPoly.sub(circle.worldPos).normalize());\r\n\r\n    let minOverlap = Number.MAX_VALUE;\r\n    let minAxis = null;\r\n    let minIndex = -1;\r\n    for (let i = 0; i < axes.length; i++) {\r\n      const proj1 = polygon.project(axes[i]);\r\n      const proj2 = circle.project(axes[i]);\r\n      const overlap = proj1.getOverlap(proj2);\r\n      if (overlap <= 0) {\r\n        return null;\r\n      } else {\r\n        if (overlap < minOverlap) {\r\n          minOverlap = overlap;\r\n          minAxis = axes[i];\r\n          minIndex = i;\r\n        }\r\n      }\r\n    }\r\n    if (minIndex < 0) {\r\n      return null;\r\n    }\r\n    return minAxis.normalize().scale(minOverlap);\r\n  }\r\n}\r\n","import { CircleCollider } from './CircleCollider';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { PolygonCollider } from './PolygonCollider';\r\nimport { EdgeCollider } from './EdgeCollider';\r\nimport { SeparatingAxis, SeparationInfo } from './SeparatingAxis';\r\nimport { LineSegment } from '../../Math/line-segment';\r\nimport { Vector } from '../../Math/vector';\r\nimport { TransformComponent } from '../../EntityComponentSystem';\r\nimport { Pair } from '../Detection/Pair';\r\n\r\nexport const CollisionJumpTable = {\r\n  CollideCircleCircle(circleA: CircleCollider, circleB: CircleCollider): CollisionContact[] {\r\n    const circleAPos = circleA.worldPos;\r\n    const circleBPos = circleB.worldPos;\r\n    const combinedRadius = circleA.radius + circleB.radius;\r\n    const distance = circleAPos.distance(circleBPos);\r\n\r\n    if (distance > combinedRadius) {\r\n      return [];\r\n    }\r\n\r\n    // negative means overlap\r\n    const separation = combinedRadius - distance;\r\n\r\n    // Normal points from A -> B\r\n    const normal = circleBPos.sub(circleAPos).normalize();\r\n    const tangent = normal.perpendicular();\r\n    const mvt = normal.scale(separation);\r\n\r\n    const point = circleA.getFurthestPoint(normal);\r\n    const local = circleA.getFurthestLocalPoint(normal);\r\n\r\n    const info: SeparationInfo = {\r\n      collider: circleA,\r\n      separation,\r\n      axis: normal,\r\n      point: point\r\n    };\r\n\r\n    return [new CollisionContact(circleA, circleB, mvt, normal, tangent, [point], [local], info)];\r\n  },\r\n\r\n  CollideCirclePolygon(circle: CircleCollider, polygon: PolygonCollider): CollisionContact[] {\r\n    let minAxis = SeparatingAxis.findCirclePolygonSeparation(circle, polygon);\r\n    if (!minAxis) {\r\n      return [];\r\n    }\r\n\r\n    // make sure that the minAxis is pointing away from circle\r\n    const samedir = minAxis.dot(polygon.center.sub(circle.center));\r\n    minAxis = samedir < 0 ? minAxis.negate() : minAxis;\r\n\r\n    const point = circle.getFurthestPoint(minAxis);\r\n    const xf = circle.owner?.get(TransformComponent) ?? new TransformComponent();\r\n    const local = xf.applyInverse(point);\r\n    const normal = minAxis.normalize();\r\n\r\n    const info: SeparationInfo = {\r\n      collider: circle,\r\n      separation: -minAxis.size,\r\n      axis: normal,\r\n      point: point,\r\n      localPoint: local,\r\n      side: polygon.findSide(normal.negate()),\r\n      localSide: polygon.findLocalSide(normal.negate())\r\n    };\r\n\r\n    return [new CollisionContact(circle, polygon, minAxis, normal, normal.perpendicular(), [point], [local], info)];\r\n  },\r\n\r\n  CollideCircleEdge(circle: CircleCollider, edge: EdgeCollider): CollisionContact[] {\r\n    // TODO not sure this actually abides by local/world collisions\r\n    // Are edge.begin and edge.end local space or world space? I think they should be local\r\n\r\n    // center of the circle in world pos\r\n    const cc = circle.center;\r\n    // vector in the direction of the edge\r\n    const edgeWorld = edge.asLine();\r\n    const e = edgeWorld.end.sub(edgeWorld.begin);\r\n\r\n    // amount of overlap with the circle's center along the edge direction\r\n    const u = e.dot(edgeWorld.end.sub(cc));\r\n    const v = e.dot(cc.sub(edgeWorld.begin));\r\n    const side = edge.asLine();\r\n    const localSide = edge.asLocalLine();\r\n\r\n    // Potential region A collision (circle is on the left side of the edge, before the beginning)\r\n    if (v <= 0) {\r\n      const da = edgeWorld.begin.sub(cc);\r\n      const dda = da.dot(da); // quick and dirty way of calc'n distance in r^2 terms saves some sqrts\r\n      // save some sqrts\r\n      if (dda > circle.radius * circle.radius) {\r\n        return []; // no collision\r\n      }\r\n\r\n      const normal = da.normalize();\r\n      const separation = circle.radius - Math.sqrt(dda);\r\n\r\n      const info: SeparationInfo = {\r\n        collider: circle,\r\n        separation: separation,\r\n        axis: normal,\r\n        point: side.begin,\r\n        side: side,\r\n        localSide: localSide\r\n      };\r\n\r\n      return [\r\n        new CollisionContact(circle, edge, normal.scale(separation), normal, normal.perpendicular(), [side.begin], [localSide.begin], info)\r\n      ];\r\n    }\r\n\r\n    // Potential region B collision (circle is on the right side of the edge, after the end)\r\n    if (u <= 0) {\r\n      const db = edgeWorld.end.sub(cc);\r\n      const ddb = db.dot(db);\r\n      if (ddb > circle.radius * circle.radius) {\r\n        return [];\r\n      }\r\n\r\n      const normal = db.normalize();\r\n      const separation = circle.radius - Math.sqrt(ddb);\r\n\r\n      const info: SeparationInfo = {\r\n        collider: circle,\r\n        separation: separation,\r\n        axis: normal,\r\n        point: side.end,\r\n        side: side,\r\n        localSide: localSide\r\n      };\r\n\r\n      return [\r\n        new CollisionContact(circle, edge, normal.scale(separation), normal, normal.perpendicular(), [side.end], [localSide.end], info)\r\n      ];\r\n    }\r\n\r\n    // Otherwise potential region AB collision (circle is in the middle of the edge between the beginning and end)\r\n    const den = e.dot(e);\r\n    const pointOnEdge = edgeWorld.begin\r\n      .scale(u)\r\n      .add(edgeWorld.end.scale(v))\r\n      .scale(1 / den);\r\n    const d = cc.sub(pointOnEdge);\r\n\r\n    const dd = d.dot(d);\r\n    if (dd > circle.radius * circle.radius) {\r\n      return []; // no collision\r\n    }\r\n\r\n    let normal = e.perpendicular();\r\n    // flip correct direction\r\n    if (normal.dot(cc.sub(edgeWorld.begin)) < 0) {\r\n      normal.x = -normal.x;\r\n      normal.y = -normal.y;\r\n    }\r\n\r\n    normal = normal.normalize();\r\n    const separation = circle.radius - Math.sqrt(dd);\r\n\r\n    const mvt = normal.scale(separation);\r\n    const info: SeparationInfo = {\r\n      collider: circle,\r\n      separation: separation,\r\n      axis: normal,\r\n      point: pointOnEdge,\r\n      side: side,\r\n      localSide: localSide\r\n    };\r\n\r\n    return [\r\n      new CollisionContact(\r\n        circle,\r\n        edge,\r\n        mvt,\r\n        normal.negate(),\r\n        normal.negate().perpendicular(),\r\n        [pointOnEdge],\r\n        [pointOnEdge.sub(edge.worldPos)],\r\n        info\r\n      )\r\n    ];\r\n  },\r\n\r\n  CollideEdgeEdge(): CollisionContact[] {\r\n    // Edge-edge collision doesn't make sense\r\n    return [];\r\n  },\r\n\r\n  CollidePolygonEdge(polygon: PolygonCollider, edge: EdgeCollider): CollisionContact[] {\r\n    const pc = polygon.center;\r\n    const ec = edge.center;\r\n    const dir = ec.sub(pc).normalize();\r\n\r\n    // build a temporary polygon from the edge to use SAT\r\n    const linePoly = new PolygonCollider({\r\n      points: [edge.begin, edge.end, edge.end.add(dir.scale(100)), edge.begin.add(dir.scale(100))],\r\n      offset: edge.offset\r\n    });\r\n    linePoly.owner = edge.owner;\r\n    const tx = edge.owner?.get(TransformComponent);\r\n    if (tx) {\r\n      linePoly.update(edge.owner.get(TransformComponent).get());\r\n    }\r\n    // Gross hack but poly-poly works well\r\n    const contact = this.CollidePolygonPolygon(polygon, linePoly);\r\n    if (contact.length) {\r\n      // Fudge the contact back to edge\r\n      contact[0].colliderB = edge;\r\n      (contact[0].id as any) = Pair.calculatePairHash(polygon.id, edge.id);\r\n    }\r\n    return contact;\r\n  },\r\n\r\n  CollidePolygonPolygon(polyA: PolygonCollider, polyB: PolygonCollider): CollisionContact[] {\r\n    // Multi contact from SAT\r\n    // https://gamedev.stackexchange.com/questions/111390/multiple-contacts-for-sat-collision-detection\r\n    // do a SAT test to find a min axis if it exists\r\n    const separationA = SeparatingAxis.findPolygonPolygonSeparation(polyA, polyB);\r\n    // If there is no overlap from boxA's perspective we can end early\r\n    if (separationA.separation > 0) {\r\n      return [];\r\n    }\r\n\r\n    const separationB = SeparatingAxis.findPolygonPolygonSeparation(polyB, polyA);\r\n    // If there is no overlap from boxB's perspective exit now\r\n    if (separationB.separation > 0) {\r\n      return [];\r\n    }\r\n\r\n    // Separations are both negative, we want to pick the least negative (minimal movement)\r\n    const separation = separationA.separation > separationB.separation ? separationA : separationB;\r\n\r\n    // The incident side is the most opposite from the axes of collision on the other collider\r\n    const other = separation.collider === polyA ? polyB : polyA;\r\n    const incident = other.findSide(separation.axis.negate()) as LineSegment;\r\n\r\n    // Clip incident side by the perpendicular lines at each end of the reference side\r\n    // https://en.wikipedia.org/wiki/Sutherland%E2%80%93Hodgman_algorithm\r\n    const reference = separation.side;\r\n    const refDir = reference.dir().normalize();\r\n\r\n    // Find our contact points by clipping the incident by the collision side\r\n    const clipRight = incident.clip(refDir.negate(), -refDir.dot(reference.begin));\r\n    let clipLeft: LineSegment | null = null;\r\n    if (clipRight) {\r\n      clipLeft = clipRight.clip(refDir, refDir.dot(reference.end));\r\n    }\r\n\r\n    // If there is no left there is no collision\r\n    if (clipLeft) {\r\n      // We only want clip points below the reference edge, discard the others\r\n      const points = clipLeft.getPoints().filter((p) => {\r\n        return reference.below(p);\r\n      });\r\n\r\n      let normal = separation.axis;\r\n      let tangent = normal.perpendicular();\r\n      // Point Contact A -> B\r\n      if (polyB.center.sub(polyA.center).dot(normal) < 0) {\r\n        normal = normal.negate();\r\n        tangent = normal.perpendicular();\r\n      }\r\n      // Points are clipped from incident which is the other collider\r\n      // Store those as locals\r\n      let localPoints: Vector[] = [];\r\n      if (separation.collider === polyA) {\r\n        const xf = polyB.owner?.get(TransformComponent) ?? new TransformComponent();\r\n        localPoints = points.map((p) => xf.applyInverse(p));\r\n      } else {\r\n        const xf = polyA.owner?.get(TransformComponent) ?? new TransformComponent();\r\n        localPoints = points.map((p) => xf.applyInverse(p));\r\n      }\r\n      return [new CollisionContact(polyA, polyB, normal.scale(-separation.separation), normal, tangent, points, localPoints, separation)];\r\n    }\r\n    return [];\r\n  },\r\n\r\n  FindContactSeparation(contact: CollisionContact, localPoint: Vector) {\r\n    const shapeA = contact.colliderA;\r\n    const txA = contact.colliderA.owner?.get(TransformComponent) ?? new TransformComponent();\r\n    const shapeB = contact.colliderB;\r\n    const txB = contact.colliderB.owner?.get(TransformComponent) ?? new TransformComponent();\r\n\r\n    // both are circles\r\n    if (shapeA instanceof CircleCollider && shapeB instanceof CircleCollider) {\r\n      const combinedRadius = shapeA.radius + shapeB.radius;\r\n      const distance = txA.pos.distance(txB.pos);\r\n      const separation = combinedRadius - distance;\r\n      return -separation;\r\n    }\r\n\r\n    // both are polygons\r\n    if (shapeA instanceof PolygonCollider && shapeB instanceof PolygonCollider) {\r\n      if (contact.info.localSide) {\r\n        let side: LineSegment;\r\n        let worldPoint: Vector;\r\n        if (contact.info.collider === shapeA) {\r\n          side = new LineSegment(txA.apply(contact.info.localSide.begin), txA.apply(contact.info.localSide.end));\r\n          worldPoint = txB.apply(localPoint);\r\n        } else {\r\n          side = new LineSegment(txB.apply(contact.info.localSide.begin), txB.apply(contact.info.localSide.end));\r\n          worldPoint = txA.apply(localPoint);\r\n        }\r\n\r\n        return side.distanceToPoint(worldPoint, true);\r\n      }\r\n    }\r\n\r\n    // polygon v circle\r\n    if (\r\n      (shapeA instanceof PolygonCollider && shapeB instanceof CircleCollider) ||\r\n      (shapeB instanceof PolygonCollider && shapeA instanceof CircleCollider)\r\n    ) {\r\n      const worldPoint = txA.apply(localPoint);\r\n      if (contact.info.side) {\r\n        return contact.info.side.distanceToPoint(worldPoint, true);\r\n      }\r\n    }\r\n\r\n    // polygon v edge\r\n    if (\r\n      (shapeA instanceof EdgeCollider && shapeB instanceof PolygonCollider) ||\r\n      (shapeB instanceof EdgeCollider && shapeA instanceof PolygonCollider)\r\n    ) {\r\n      let worldPoint: Vector;\r\n      if (contact.info.collider === shapeA) {\r\n        worldPoint = txB.apply(localPoint);\r\n      } else {\r\n        worldPoint = txA.apply(localPoint);\r\n      }\r\n      if (contact.info.side) {\r\n        return contact.info.side.distanceToPoint(worldPoint, true);\r\n      }\r\n    }\r\n\r\n    // circle v edge\r\n    if (\r\n      (shapeA instanceof CircleCollider && shapeB instanceof EdgeCollider) ||\r\n      (shapeB instanceof CircleCollider && shapeA instanceof EdgeCollider)\r\n    ) {\r\n      // Local point is always on the edge which is always shapeB\r\n      const worldPoint = txB.apply(localPoint);\r\n\r\n      let circlePoint: Vector;\r\n      if (shapeA instanceof CircleCollider) {\r\n        circlePoint = shapeA.getFurthestPoint(contact.normal);\r\n      }\r\n\r\n      const dist = worldPoint.distance(circlePoint);\r\n\r\n      if (contact.info.side) {\r\n        return dist > 0 ? -dist : 0;\r\n      }\r\n    }\r\n\r\n    return 0;\r\n  }\r\n};\r\n","import { BoundingBox } from '../BoundingBox';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { CollisionJumpTable } from './CollisionJumpTable';\r\nimport { CircleCollider } from './CircleCollider';\r\nimport { PolygonCollider } from './PolygonCollider';\r\n\r\nimport { Projection } from '../../Math/projection';\r\nimport { LineSegment } from '../../Math/line-segment';\r\nimport { Vector } from '../../Math/vector';\r\nimport { Ray } from '../../Math/ray';\r\nimport { Color } from '../../Color';\r\nimport { Collider } from './Collider';\r\nimport { ClosestLineJumpTable } from './ClosestLineJumpTable';\r\nimport { ExcaliburGraphicsContext } from '../../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { Transform } from '../../Math/transform';\r\nimport { AffineMatrix } from '../../Math/affine-matrix';\r\n\r\nexport interface EdgeColliderOptions {\r\n  /**\r\n   * The beginning of the edge defined in local coordinates to the collider\r\n   */\r\n  begin: Vector;\r\n  /**\r\n   * The ending of the edge defined in local coordinates to the collider\r\n   */\r\n  end: Vector;\r\n  /**\r\n   * Optionally specify an offset\r\n   */\r\n  offset?: Vector;\r\n}\r\n\r\n/**\r\n * Edge is a single line collider to create collisions with a single line.\r\n */\r\nexport class EdgeCollider extends Collider {\r\n  offset: Vector;\r\n  begin: Vector;\r\n  end: Vector;\r\n\r\n  private _transform: Transform;\r\n  private _globalMatrix: AffineMatrix = AffineMatrix.identity();\r\n\r\n  constructor(options: EdgeColliderOptions) {\r\n    super();\r\n    this.begin = options.begin || Vector.Zero;\r\n    this.end = options.end || Vector.Zero;\r\n    this.offset = options.offset ?? Vector.Zero;\r\n  }\r\n\r\n  /**\r\n   * Returns a clone of this Edge, not associated with any collider\r\n   */\r\n  public clone(): EdgeCollider {\r\n    return new EdgeCollider({\r\n      begin: this.begin.clone(),\r\n      end: this.end.clone()\r\n    });\r\n  }\r\n\r\n  public get worldPos(): Vector {\r\n    const tx = this._transform;\r\n    return tx?.globalPos.add(this.offset) ?? this.offset;\r\n  }\r\n\r\n  /**\r\n   * Get the center of the collision area in world coordinates\r\n   */\r\n  public get center(): Vector {\r\n    const begin = this._getTransformedBegin();\r\n    const end = this._getTransformedEnd();\r\n    const pos = begin.average(end);\r\n    return pos;\r\n  }\r\n\r\n  private _getTransformedBegin(): Vector {\r\n    return this._globalMatrix.multiply(this.begin);\r\n  }\r\n\r\n  private _getTransformedEnd(): Vector {\r\n    return this._globalMatrix.multiply(this.end);\r\n  }\r\n\r\n  /**\r\n   * Returns the slope of the line in the form of a vector\r\n   */\r\n  public getSlope(): Vector {\r\n    const begin = this._getTransformedBegin();\r\n    const end = this._getTransformedEnd();\r\n    const distance = begin.distance(end);\r\n    return end.sub(begin).scale(1 / distance);\r\n  }\r\n\r\n  /**\r\n   * Returns the length of the line segment in pixels\r\n   */\r\n  public getLength(): number {\r\n    const begin = this._getTransformedBegin();\r\n    const end = this._getTransformedEnd();\r\n    const distance = begin.distance(end);\r\n    return distance;\r\n  }\r\n\r\n  /**\r\n   * Tests if a point is contained in this collision area\r\n   */\r\n  public contains(): boolean {\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * @inheritdoc\r\n   */\r\n  public rayCast(ray: Ray, max: number = Infinity): Vector {\r\n    const numerator = this._getTransformedBegin().sub(ray.pos);\r\n\r\n    // Test is line and ray are parallel and non intersecting\r\n    if (ray.dir.cross(this.getSlope()) === 0 && numerator.cross(ray.dir) !== 0) {\r\n      return null;\r\n    }\r\n\r\n    // Lines are parallel\r\n    const divisor = ray.dir.cross(this.getSlope());\r\n    if (divisor === 0) {\r\n      return null;\r\n    }\r\n\r\n    const t = numerator.cross(this.getSlope()) / divisor;\r\n\r\n    if (t >= 0 && t <= max) {\r\n      const u = numerator.cross(ray.dir) / divisor / this.getLength();\r\n      if (u >= 0 && u <= 1) {\r\n        return ray.getPoint(t);\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Returns the closes line between this and another collider, from this -> collider\r\n   * @param shape\r\n   */\r\n  public getClosestLineBetween(shape: Collider): LineSegment {\r\n    if (shape instanceof CircleCollider) {\r\n      return ClosestLineJumpTable.CircleEdgeClosestLine(shape, this);\r\n    } else if (shape instanceof PolygonCollider) {\r\n      return ClosestLineJumpTable.PolygonEdgeClosestLine(shape, this).flip();\r\n    } else if (shape instanceof EdgeCollider) {\r\n      return ClosestLineJumpTable.EdgeEdgeClosestLine(this, shape);\r\n    } else {\r\n      throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof shape}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @inheritdoc\r\n   */\r\n  public collide(shape: Collider): CollisionContact[] {\r\n    if (shape instanceof CircleCollider) {\r\n      return CollisionJumpTable.CollideCircleEdge(shape, this);\r\n    } else if (shape instanceof PolygonCollider) {\r\n      return CollisionJumpTable.CollidePolygonEdge(shape, this);\r\n    } else if (shape instanceof EdgeCollider) {\r\n      return CollisionJumpTable.CollideEdgeEdge();\r\n    } else {\r\n      throw new Error(`Edge could not collide with unknown CollisionShape ${typeof shape}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Find the point on the collider furthest in the direction specified\r\n   */\r\n  public getFurthestPoint(direction: Vector): Vector {\r\n    const transformedBegin = this._getTransformedBegin();\r\n    const transformedEnd = this._getTransformedEnd();\r\n    if (direction.dot(transformedBegin) > 0) {\r\n      return transformedBegin;\r\n    } else {\r\n      return transformedEnd;\r\n    }\r\n  }\r\n\r\n  private _boundsFromBeginEnd(begin: Vector, end: Vector, padding = 10) {\r\n    // A perfectly vertical or horizontal edge would have a bounds 0 width or height\r\n    // this causes problems for the collision system so we give them some padding\r\n    return new BoundingBox(\r\n      Math.min(begin.x, end.x) - padding,\r\n      Math.min(begin.y, end.y) - padding,\r\n      Math.max(begin.x, end.x) + padding,\r\n      Math.max(begin.y, end.y) + padding\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get the axis aligned bounding box for the edge collider in world space\r\n   */\r\n  public get bounds(): BoundingBox {\r\n    const transformedBegin = this._getTransformedBegin();\r\n    const transformedEnd = this._getTransformedEnd();\r\n    return this._boundsFromBeginEnd(transformedBegin, transformedEnd);\r\n  }\r\n\r\n  /**\r\n   * Get the axis aligned bounding box for the edge collider in local space\r\n   */\r\n  public get localBounds(): BoundingBox {\r\n    return this._boundsFromBeginEnd(this.begin, this.end);\r\n  }\r\n\r\n  /**\r\n   * Returns this edge represented as a line in world coordinates\r\n   */\r\n  public asLine(): LineSegment {\r\n    return new LineSegment(this._getTransformedBegin(), this._getTransformedEnd());\r\n  }\r\n\r\n  /**\r\n   * Return this edge as a line in local line coordinates (relative to the position)\r\n   */\r\n  public asLocalLine(): LineSegment {\r\n    return new LineSegment(this.begin, this.end);\r\n  }\r\n\r\n  /**\r\n   * Get the axis associated with the edge\r\n   */\r\n  public get axes(): Vector[] {\r\n    const e = this._getTransformedEnd().sub(this._getTransformedBegin());\r\n    const edgeNormal = e.normal();\r\n\r\n    const axes = [];\r\n    axes.push(edgeNormal);\r\n    axes.push(edgeNormal.negate());\r\n    axes.push(edgeNormal.normal());\r\n    axes.push(edgeNormal.normal().negate());\r\n    return axes;\r\n  }\r\n\r\n  /**\r\n   * Get the moment of inertia for an edge\r\n   * https://en.wikipedia.org/wiki/List_of_moments_of_inertia\r\n   */\r\n  public getInertia(mass: number): number {\r\n    const length = this.end.sub(this.begin).distance() / 2;\r\n    return mass * length * length;\r\n  }\r\n\r\n  /**\r\n   * @inheritdoc\r\n   */\r\n  public update(transform: Transform): void {\r\n    this._transform = transform;\r\n    const globalMat = transform.matrix ?? this._globalMatrix;\r\n    globalMat.clone(this._globalMatrix);\r\n    this._globalMatrix.translate(this.offset.x, this.offset.y);\r\n  }\r\n\r\n  /**\r\n   * Project the edge along a specified axis\r\n   */\r\n  public project(axis: Vector): Projection {\r\n    const scalars = [];\r\n\r\n    const points = [this._getTransformedBegin(), this._getTransformedEnd()];\r\n    const len = points.length;\r\n    for (let i = 0; i < len; i++) {\r\n      scalars.push(points[i].dot(axis));\r\n    }\r\n\r\n    return new Projection(Math.min.apply(Math, scalars), Math.max.apply(Math, scalars));\r\n  }\r\n\r\n  public debug(ex: ExcaliburGraphicsContext, color: Color) {\r\n    const begin = this._getTransformedBegin();\r\n    const end = this._getTransformedEnd();\r\n    ex.drawLine(begin, end, color, 2);\r\n    ex.drawCircle(begin, 2, color);\r\n    ex.drawCircle(end, 2, color);\r\n  }\r\n\r\n}\r\n","import { Color } from '../../Color';\r\nimport { BoundingBox } from '../BoundingBox';\r\nimport { EdgeCollider } from './EdgeCollider';\r\nimport { CollisionJumpTable } from './CollisionJumpTable';\r\nimport { CircleCollider } from './CircleCollider';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { Projection } from '../../Math/projection';\r\nimport { LineSegment } from '../../Math/line-segment';\r\nimport { Vector } from '../../Math/vector';\r\nimport { AffineMatrix } from '../../Math/affine-matrix';\r\nimport { Ray } from '../../Math/ray';\r\nimport { ClosestLineJumpTable } from './ClosestLineJumpTable';\r\nimport { Collider } from './Collider';\r\nimport { ExcaliburGraphicsContext, Logger, range } from '../..';\r\nimport { CompositeCollider } from './CompositeCollider';\r\nimport { Shape } from './Shape';\r\nimport { Transform } from '../../Math/transform';\r\n\r\nexport interface PolygonColliderOptions {\r\n  /**\r\n   * Pixel offset relative to a collider's body transform position.\r\n   */\r\n  offset?: Vector;\r\n  /**\r\n   * Points in the polygon in order around the perimeter in local coordinates. These are relative from the body transform position.\r\n   */\r\n  points: Vector[];\r\n}\r\n\r\n/**\r\n * Polygon collider for detecting collisions\r\n */\r\nexport class PolygonCollider extends Collider {\r\n  private _logger = Logger.getInstance();\r\n  /**\r\n   * Pixel offset relative to a collider's body transform position.\r\n   */\r\n  public offset: Vector;\r\n\r\n  private _points: Vector[];\r\n  /**\r\n   * Points in the polygon in order around the perimeter in local coordinates. These are relative from the body transform position.\r\n   * Excalibur stores these in counter-clockwise order\r\n   */\r\n  public set points(points: Vector[]) {\r\n    this._localBoundsDirty = true;\r\n    this._localSidesDirty = true;\r\n    this._sidesDirty = true;\r\n    this._points = points;\r\n  }\r\n\r\n  /**\r\n   * Points in the polygon in order around the perimeter in local coordinates. These are relative from the body transform position.\r\n   * Excalibur stores these in counter-clockwise order\r\n   */\r\n  public get points(): Vector[] {\r\n    return this._points;\r\n  }\r\n\r\n  private _transform: Transform;\r\n\r\n  private _transformedPoints: Vector[] = [];\r\n  private _sides: LineSegment[] = [];\r\n  private _localSides: LineSegment[] = [];\r\n\r\n  constructor(options: PolygonColliderOptions) {\r\n    super();\r\n    this.offset = options.offset ?? Vector.Zero;\r\n    this._globalMatrix.translate(this.offset.x, this.offset.y);\r\n    this.points = options.points ?? [];\r\n    const counterClockwise = this._isCounterClockwiseWinding(this.points);\r\n    if (!counterClockwise) {\r\n      this.points.reverse();\r\n    }\r\n    if (!this.isConvex()) {\r\n      this._logger.warn(\r\n        'Excalibur only supports convex polygon colliders and will not behave properly.'+\r\n        'Call PolygonCollider.triangulate() to build a new collider composed of smaller convex triangles');\r\n    }\r\n\r\n    // calculate initial transformation\r\n    this._calculateTransformation();\r\n  }\r\n\r\n  private _isCounterClockwiseWinding(points: Vector[]): boolean {\r\n    // https://stackoverflow.com/a/1165943\r\n    let sum = 0;\r\n    for (let i = 0; i < points.length; i++) {\r\n      sum += (points[(i + 1) % points.length].x - points[i].x) * (points[(i + 1) % points.length].y + points[i].y);\r\n    }\r\n    return sum < 0;\r\n  }\r\n\r\n  /**\r\n   * Returns if the polygon collider is convex, Excalibur does not handle non-convex collision shapes.\r\n   * Call [[Polygon.triangulate]] to generate a [[CompositeCollider]] from this non-convex shape\r\n   */\r\n  public isConvex(): boolean {\r\n    // From SO: https://stackoverflow.com/a/45372025\r\n    if (this.points.length < 3) {\r\n      return false;\r\n    }\r\n    let oldPoint = this.points[this.points.length - 2];\r\n    let newPoint = this.points[this.points.length - 1];\r\n    let direction = Math.atan2(newPoint.y - oldPoint.y, newPoint.x - oldPoint.x);\r\n    let oldDirection = 0;\r\n    let orientation = 0;\r\n    let angleSum = 0;\r\n    for (const [i, point] of this.points.entries()) {\r\n      oldPoint = newPoint;\r\n      oldDirection = direction;\r\n      newPoint =  point;\r\n      direction = Math.atan2(newPoint.y - oldPoint.y, newPoint.x - oldPoint.x);\r\n      if (oldPoint.equals(newPoint)) {\r\n        return false; // repeat point\r\n      }\r\n      let angle = direction - oldDirection;\r\n      if (angle <= -Math.PI){\r\n        angle += Math.PI * 2;\r\n      } else if (angle > Math.PI) {\r\n        angle -= Math.PI * 2;\r\n      }\r\n      if (i === 0) {\r\n        if (angle === 0.0) {\r\n          return false;\r\n        }\r\n        orientation = angle  > 0 ? 1 : -1;\r\n      } else {\r\n        if (orientation * angle <= 0) {\r\n          return false;\r\n        }\r\n      }\r\n      angleSum += angle;\r\n    }\r\n    return Math.abs(Math.round(angleSum / (Math.PI * 2))) === 1;\r\n  }\r\n\r\n  /**\r\n   * Tessellates the polygon into a triangle fan as a [[CompositeCollider]] of triangle polygons\r\n   */\r\n  public tessellate(): CompositeCollider {\r\n    const polygons: Vector[][] = [];\r\n    for (let i = 1; i < this.points.length - 2; i++) {\r\n      polygons.push([this.points[0], this.points[i + 1], this.points[i + 2]]);\r\n    }\r\n    polygons.push([this.points[0], this.points[1], this.points[2]]);\r\n\r\n    return new CompositeCollider(polygons.map(points => Shape.Polygon(points)));\r\n  }\r\n\r\n  /**\r\n   * Triangulate the polygon collider using the \"Ear Clipping\" algorithm.\r\n   * Returns a new [[CompositeCollider]] made up of smaller triangles.\r\n   */\r\n  public triangulate(): CompositeCollider {\r\n    // https://www.youtube.com/watch?v=hTJFcHutls8\r\n    if (this.points.length < 3) {\r\n      throw Error('Invalid polygon');\r\n    }\r\n\r\n    /**\r\n     * Helper to get a vertex in the list\r\n     */\r\n    function getItem<T>(index: number, list: T[]) {\r\n      if (index >= list.length) {\r\n        return list[index % list.length];\r\n      } else if (index < 0) {\r\n        return list[index % list.length + list.length];\r\n      } else {\r\n        return list[index];\r\n      }\r\n    }\r\n\r\n    /**\r\n     * Quick test for point in triangle\r\n     */\r\n    function isPointInTriangle(point: Vector, a: Vector, b: Vector, c: Vector) {\r\n      const ab = b.sub(a);\r\n      const bc = c.sub(b);\r\n      const ca = a.sub(c);\r\n\r\n      const ap = point.sub(a);\r\n      const bp = point.sub(b);\r\n      const cp = point.sub(c);\r\n\r\n      const cross1 = ab.cross(ap);\r\n      const cross2 = bc.cross(bp);\r\n      const cross3 = ca.cross(cp);\r\n\r\n      if (cross1 > 0 || cross2 > 0 || cross3 > 0) {\r\n        return false;\r\n      }\r\n      return true;\r\n    }\r\n\r\n    const triangles: Vector[][] = [];\r\n    const vertices = [...this.points];\r\n    const indices = range(0, this.points.length - 1);\r\n\r\n    // 1. Loop through vertices clockwise\r\n    //    if the vertex is convex (interior angle is < 180) (cross product positive)\r\n    //    if the polygon formed by it's edges doesn't contain the points\r\n    //         it's an ear add it to our list of triangles, and restart\r\n\r\n    while (indices.length > 3) {\r\n      for (let i = 0; i < indices.length; i++) {\r\n        const a = indices[i];\r\n        const b = getItem(i - 1, indices);\r\n        const c = getItem(i + 1, indices);\r\n\r\n        const va = vertices[a];\r\n        const vb = vertices[b];\r\n        const vc = vertices[c];\r\n\r\n        // Check convexity\r\n        const leftArm = vb.sub(va);\r\n        const rightArm = vc.sub(va);\r\n        const isConvex = rightArm.cross(leftArm) > 0; // positive cross means convex\r\n        if (!isConvex) {\r\n          continue;\r\n        }\r\n\r\n        let isEar = true;\r\n        // Check that if any vertices are in the triangle a, b, c\r\n        for (let j = 0; j < indices.length; j++) {\r\n          const vertIndex = indices[j];\r\n          // We can skip these\r\n          if (vertIndex === a || vertIndex === b || vertIndex === c) {\r\n            continue;\r\n          }\r\n\r\n          const point = vertices[vertIndex];\r\n          if (isPointInTriangle(point, vb, va, vc)) {\r\n            isEar = false;\r\n            break;\r\n          }\r\n        }\r\n\r\n        // Add ear to polygon list and remove from list\r\n        if (isEar) {\r\n          triangles.push([vb, va, vc]);\r\n          indices.splice(i, 1);\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    triangles.push([vertices[indices[0]], vertices[indices[1]], vertices[indices[2]]]);\r\n\r\n    return new CompositeCollider(triangles.map(points => Shape.Polygon(points)));\r\n  }\r\n\r\n  /**\r\n   * Returns a clone of this ConvexPolygon, not associated with any collider\r\n   */\r\n  public clone(): PolygonCollider {\r\n    return new PolygonCollider({\r\n      offset: this.offset.clone(),\r\n      points: this.points.map((p) => p.clone())\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Returns the world position of the collider, which is the current body transform plus any defined offset\r\n   */\r\n  public get worldPos(): Vector {\r\n    if (this._transform) {\r\n      return this._transform.pos.add(this.offset);\r\n    }\r\n    return this.offset;\r\n  }\r\n\r\n  /**\r\n   * Get the center of the collider in world coordinates\r\n   */\r\n  public get center(): Vector {\r\n    return this.bounds.center;\r\n  }\r\n\r\n  private _globalMatrix: AffineMatrix = AffineMatrix.identity();\r\n\r\n  private _transformedPointsDirty = true;\r\n  /**\r\n   * Calculates the underlying transformation from the body relative space to world space\r\n   */\r\n  private _calculateTransformation() {\r\n    const points = this.points;\r\n    const len = points.length;\r\n    this._transformedPoints.length = 0; // clear out old transform\r\n    for (let i = 0; i < len; i++) {\r\n      this._transformedPoints[i] = this._globalMatrix.multiply(points[i].clone());\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets the points that make up the polygon in world space, from actor relative space (if specified)\r\n   */\r\n  public getTransformedPoints(): Vector[] {\r\n    if (this._transformedPointsDirty) {\r\n      this._calculateTransformation();\r\n      this._transformedPointsDirty = false;\r\n    }\r\n    return this._transformedPoints;\r\n  }\r\n\r\n  private _sidesDirty = true;\r\n  /**\r\n   * Gets the sides of the polygon in world space\r\n   */\r\n  public getSides(): LineSegment[] {\r\n    if (this._sidesDirty) {\r\n      const lines = [];\r\n      const points = this.getTransformedPoints();\r\n      const len = points.length;\r\n      for (let i = 0; i < len; i++) {\r\n        // This winding is important\r\n        lines.push(new LineSegment(points[i], points[(i + 1) % len]));\r\n      }\r\n      this._sides = lines;\r\n      this._sidesDirty = false;\r\n    }\r\n    return this._sides;\r\n  }\r\n\r\n  private _localSidesDirty = true;\r\n  /**\r\n   * Returns the local coordinate space sides\r\n   */\r\n  public getLocalSides(): LineSegment[] {\r\n    if (this._localSidesDirty) {\r\n      const lines = [];\r\n      const points = this.points;\r\n      const len = points.length;\r\n      for (let i = 0; i < len; i++) {\r\n        // This winding is important\r\n        lines.push(new LineSegment(points[i], points[(i + 1) % len]));\r\n      }\r\n      this._localSides = lines;\r\n      this._localSidesDirty = false;\r\n    }\r\n\r\n    return this._localSides;\r\n  }\r\n\r\n  /**\r\n   * Given a direction vector find the world space side that is most in that direction\r\n   * @param direction\r\n   */\r\n  public findSide(direction: Vector): LineSegment {\r\n    const sides = this.getSides();\r\n    let bestSide = sides[0];\r\n    let maxDistance = -Number.MAX_VALUE;\r\n    for (let side = 0; side < sides.length; side++) {\r\n      const currentSide = sides[side];\r\n      const sideNormal = currentSide.normal();\r\n      const mostDirection = sideNormal.dot(direction);\r\n      if (mostDirection > maxDistance) {\r\n        bestSide = currentSide;\r\n        maxDistance = mostDirection;\r\n      }\r\n    }\r\n    return bestSide;\r\n  }\r\n\r\n  /**\r\n   * Given a direction vector find the local space side that is most in that direction\r\n   * @param direction\r\n   */\r\n  public findLocalSide(direction: Vector): LineSegment {\r\n    const sides = this.getLocalSides();\r\n    let bestSide = sides[0];\r\n    let maxDistance = -Number.MAX_VALUE;\r\n    for (let side = 0; side < sides.length; side++) {\r\n      const currentSide = sides[side];\r\n      const sideNormal = currentSide.normal();\r\n      const mostDirection = sideNormal.dot(direction);\r\n      if (mostDirection > maxDistance) {\r\n        bestSide = currentSide;\r\n        maxDistance = mostDirection;\r\n      }\r\n    }\r\n    return bestSide;\r\n  }\r\n\r\n  /**\r\n   * Get the axis associated with the convex polygon\r\n   */\r\n  public get axes(): Vector[] {\r\n    const axes: Vector[] = [];\r\n    const sides = this.getSides();\r\n    for (let i = 0; i < sides.length; i++) {\r\n      axes.push(sides[i].normal());\r\n    }\r\n    return axes;\r\n  }\r\n\r\n  /**\r\n   * Updates the transform for the collision geometry\r\n   *\r\n   * Collision geometry (points/bounds) will not change until this is called.\r\n   * @param transform\r\n   */\r\n  public update(transform: Transform): void {\r\n    this._transform = transform;\r\n    this._transformedPointsDirty = true;\r\n    this._sidesDirty = true;\r\n    // This change means an update must be performed in order for geometry to update\r\n    const globalMat = transform.matrix ?? this._globalMatrix;\r\n    globalMat.clone(this._globalMatrix);\r\n    this._globalMatrix.translate(this.offset.x, this.offset.y);\r\n  }\r\n\r\n  /**\r\n   * Tests if a point is contained in this collider in world space\r\n   */\r\n  public contains(point: Vector): boolean {\r\n    // Always cast to the right, as long as we cast in a consistent fixed direction we\r\n    // will be fine\r\n    const testRay = new Ray(point, new Vector(1, 0));\r\n    const intersectCount = this.getSides().reduce(function (accum, side) {\r\n      if (testRay.intersect(side) >= 0) {\r\n        return accum + 1;\r\n      }\r\n      return accum;\r\n    }, 0);\r\n\r\n    if (intersectCount % 2 === 0) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  public getClosestLineBetween(collider: Collider): LineSegment {\r\n    if (collider instanceof CircleCollider) {\r\n      return ClosestLineJumpTable.PolygonCircleClosestLine(this, collider);\r\n    } else if (collider instanceof PolygonCollider) {\r\n      return ClosestLineJumpTable.PolygonPolygonClosestLine(this, collider);\r\n    } else if (collider instanceof EdgeCollider) {\r\n      return ClosestLineJumpTable.PolygonEdgeClosestLine(this, collider);\r\n    } else {\r\n      throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof collider}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns a collision contact if the 2 colliders collide, otherwise collide will\r\n   * return null.\r\n   * @param collider\r\n   */\r\n  public collide(collider: Collider): CollisionContact[] {\r\n    if (collider instanceof CircleCollider) {\r\n      return CollisionJumpTable.CollideCirclePolygon(collider, this);\r\n    } else if (collider instanceof PolygonCollider) {\r\n      return CollisionJumpTable.CollidePolygonPolygon(this, collider);\r\n    } else if (collider instanceof EdgeCollider) {\r\n      return CollisionJumpTable.CollidePolygonEdge(this, collider);\r\n    } else {\r\n      throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof collider}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Find the point on the collider furthest in the direction specified\r\n   */\r\n  public getFurthestPoint(direction: Vector): Vector {\r\n    const pts = this.getTransformedPoints();\r\n    let furthestPoint = null;\r\n    let maxDistance = -Number.MAX_VALUE;\r\n    for (let i = 0; i < pts.length; i++) {\r\n      const distance = direction.dot(pts[i]);\r\n      if (distance > maxDistance) {\r\n        maxDistance = distance;\r\n        furthestPoint = pts[i];\r\n      }\r\n    }\r\n    return furthestPoint;\r\n  }\r\n\r\n  /**\r\n   * Find the local point on the collider furthest in the direction specified\r\n   * @param direction\r\n   */\r\n  public getFurthestLocalPoint(direction: Vector): Vector {\r\n    const pts = this.points;\r\n    let furthestPoint = pts[0];\r\n    let maxDistance = -Number.MAX_VALUE;\r\n    for (let i = 0; i < pts.length; i++) {\r\n      const distance = direction.dot(pts[i]);\r\n      if (distance > maxDistance) {\r\n        maxDistance = distance;\r\n        furthestPoint = pts[i];\r\n      }\r\n    }\r\n    return furthestPoint;\r\n  }\r\n\r\n  /**\r\n   * Finds the closes face to the point using perpendicular distance\r\n   * @param point point to test against polygon\r\n   */\r\n  public getClosestFace(point: Vector): { distance: Vector; face: LineSegment } {\r\n    const sides = this.getSides();\r\n    let min = Number.POSITIVE_INFINITY;\r\n    let faceIndex = -1;\r\n    let distance = -1;\r\n    for (let i = 0; i < sides.length; i++) {\r\n      const dist = sides[i].distanceToPoint(point);\r\n      if (dist < min) {\r\n        min = dist;\r\n        faceIndex = i;\r\n        distance = dist;\r\n      }\r\n    }\r\n\r\n    if (faceIndex !== -1) {\r\n      return {\r\n        distance: sides[faceIndex].normal().scale(distance),\r\n        face: sides[faceIndex]\r\n      };\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Get the axis aligned bounding box for the polygon collider in world coordinates\r\n   */\r\n  public get bounds(): BoundingBox {\r\n    return this.localBounds.transform(this._globalMatrix);\r\n  }\r\n\r\n  private _localBoundsDirty = true;\r\n  private _localBounds: BoundingBox;\r\n  /**\r\n   * Get the axis aligned bounding box for the polygon collider in local coordinates\r\n   */\r\n  public get localBounds(): BoundingBox {\r\n    if (this._localBoundsDirty) {\r\n      this._localBounds = BoundingBox.fromPoints(this.points);\r\n      this._localBoundsDirty = false;\r\n    }\r\n\r\n    return this._localBounds;\r\n  }\r\n\r\n  private _cachedMass: number;\r\n  private _cachedInertia: number;\r\n  /**\r\n   * Get the moment of inertia for an arbitrary polygon\r\n   * https://en.wikipedia.org/wiki/List_of_moments_of_inertia\r\n   */\r\n  public getInertia(mass: number): number {\r\n    if (this._cachedMass === mass && this._cachedInertia) {\r\n      return this._cachedInertia;\r\n    }\r\n    let numerator = 0;\r\n    let denominator = 0;\r\n    const points = this.points;\r\n    for (let i = 0; i < points.length; i++) {\r\n      const iplusone = (i + 1) % points.length;\r\n      const crossTerm = points[iplusone].cross(points[i]);\r\n      numerator +=\r\n        crossTerm *\r\n        (points[i].dot(points[i]) + points[i].dot(points[iplusone]) + points[iplusone].dot(points[iplusone]));\r\n      denominator += crossTerm;\r\n    }\r\n    this._cachedMass = mass;\r\n    return this._cachedInertia = (mass / 6) * (numerator / denominator);\r\n  }\r\n\r\n  /**\r\n   * Casts a ray into the polygon and returns a vector representing the point of contact (in world space) or null if no collision.\r\n   */\r\n  public rayCast(ray: Ray, max: number = Infinity) {\r\n    // find the minimum contact time greater than 0\r\n    // contact times less than 0 are behind the ray and we don't want those\r\n    const sides = this.getSides();\r\n    const len = sides.length;\r\n    let minContactTime = Number.MAX_VALUE;\r\n    let contactIndex = -1;\r\n    for (let i = 0; i < len; i++) {\r\n      const contactTime = ray.intersect(sides[i]);\r\n      if (contactTime >= 0 && contactTime < minContactTime && contactTime <= max) {\r\n        minContactTime = contactTime;\r\n        contactIndex = i;\r\n      }\r\n    }\r\n\r\n    // contact was found\r\n    if (contactIndex >= 0) {\r\n      return ray.getPoint(minContactTime);\r\n    }\r\n\r\n    // no contact found\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Project the edges of the polygon along a specified axis\r\n   */\r\n  public project(axis: Vector): Projection {\r\n    const points = this.getTransformedPoints();\r\n    const len = points.length;\r\n    let min = Number.MAX_VALUE;\r\n    let max = -Number.MAX_VALUE;\r\n    for (let i = 0; i < len; i++) {\r\n      const scalar = points[i].dot(axis);\r\n      min = Math.min(min, scalar);\r\n      max = Math.max(max, scalar);\r\n    }\r\n\r\n    return new Projection(min, max);\r\n  }\r\n\r\n  public debug(ex: ExcaliburGraphicsContext, color: Color) {\r\n    const firstPoint = this.getTransformedPoints()[0];\r\n    const points = [firstPoint, ...this.getTransformedPoints(), firstPoint];\r\n    for (let i = 0; i < points.length - 1; i++) {\r\n      ex.drawLine(points[i], points[i + 1], color, 2);\r\n      ex.drawCircle(points[i], 2, color);\r\n      ex.drawCircle(points[i + 1], 2, color);\r\n    }\r\n  }\r\n}\r\n","import { PolygonCollider } from './PolygonCollider';\r\nimport { CircleCollider } from './CircleCollider';\r\nimport { EdgeCollider } from './EdgeCollider';\r\nimport { BoundingBox } from '../BoundingBox';\r\nimport { vec, Vector } from '../../Math/vector';\r\nimport { CompositeCollider } from './CompositeCollider';\r\nimport { Logger } from '../..';\r\n\r\n/**\r\n * Excalibur helper for defining colliders quickly\r\n */\r\nexport class Shape {\r\n  /**\r\n   * Creates a box collider, under the hood defines a [[PolygonCollider]] collider\r\n   * @param width Width of the box\r\n   * @param height Height of the box\r\n   * @param anchor Anchor of the box (default (.5, .5)) which positions the box relative to the center of the collider's position\r\n   * @param offset Optional offset relative to the collider in local coordinates\r\n   */\r\n  static Box(width: number, height: number, anchor: Vector = Vector.Half, offset: Vector = Vector.Zero): PolygonCollider {\r\n    return new PolygonCollider({\r\n      points: new BoundingBox(-width * anchor.x, -height * anchor.y, width - width * anchor.x, height - height * anchor.y).getPoints(),\r\n      offset: offset\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates a new [[PolygonCollider|arbitrary polygon]] collider\r\n   *\r\n   * PolygonColliders are useful for creating convex polygon shapes\r\n   * @param points Points specified in counter clockwise\r\n   * @param offset Optional offset relative to the collider in local coordinates\r\n   */\r\n  static Polygon(points: Vector[], offset: Vector = Vector.Zero): PolygonCollider {\r\n    return new PolygonCollider({\r\n      points: points,\r\n      offset: offset\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates a new [[CircleCollider|circle]] collider\r\n   *\r\n   * Circle colliders are useful for balls, or to make collisions more forgiving on sharp edges\r\n   * @param radius Radius of the circle collider\r\n   * @param offset Optional offset relative to the collider in local coordinates\r\n   */\r\n  static Circle(radius: number, offset: Vector = Vector.Zero): CircleCollider {\r\n    return new CircleCollider({\r\n      radius: radius,\r\n      offset: offset\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates a new [[EdgeCollider|edge]] collider\r\n   *\r\n   * Edge colliders are useful for  floors, walls, and other barriers\r\n   * @param begin Beginning of the edge in local coordinates to the collider\r\n   * @param end Ending of the edge in local coordinates to the collider\r\n   */\r\n  static Edge(begin: Vector, end: Vector): EdgeCollider {\r\n    return new EdgeCollider({\r\n      begin: begin,\r\n      end: end\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates a new capsule shaped [[CompositeCollider]] using 2 circles and a box\r\n   *\r\n   * Capsule colliders are useful for platformers with incline or jagged floors to have a smooth\r\n   * player experience.\r\n   *\r\n   * @param width\r\n   * @param height\r\n   * @param offset Optional offset\r\n   */\r\n  static Capsule(width: number, height: number, offset = Vector.Zero): CompositeCollider {\r\n    const logger = Logger.getInstance();\r\n    if (width === height) {\r\n      logger.warn('A capsule collider with equal width and height is a circle, consider using a ex.Shape.Circle or ex.CircleCollider');\r\n    }\r\n\r\n    const vertical = height >= width;\r\n\r\n    if (vertical) {\r\n      // height > width, if equal maybe use a circle\r\n      const capsule = new CompositeCollider([\r\n        Shape.Circle(width / 2, vec(0, -height / 2 + width / 2).add(offset)),\r\n        Shape.Box(width, height - width, Vector.Half, offset),\r\n        Shape.Circle(width / 2, vec(0, height / 2 - width / 2).add(offset))\r\n      ]);\r\n      return capsule;\r\n    } else {\r\n      // width > height, if equal maybe use a circle\r\n      const capsule = new CompositeCollider([\r\n        Shape.Circle(height / 2, vec(-width / 2 + height / 2, 0).add(offset)),\r\n        Shape.Box(width - height, height, Vector.Half, offset),\r\n        Shape.Circle(height / 2, vec(width / 2 - height / 2, 0).add(offset))\r\n      ]);\r\n      return capsule;\r\n    }\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\r\nimport { TransformComponent } from '../EntityComponentSystem';\r\nimport { Component } from '../EntityComponentSystem/Component';\r\nimport { Entity } from '../EntityComponentSystem/Entity';\r\nimport { EventDispatcher } from '../EventDispatcher';\r\nimport { CollisionEndEvent, CollisionStartEvent, PostCollisionEvent, PreCollisionEvent } from '../Events';\r\nimport { Observable } from '../Util/Observable';\r\nimport { BoundingBox } from './BoundingBox';\r\nimport { CollisionContact } from './Detection/CollisionContact';\r\nimport { CircleCollider } from './Colliders/CircleCollider';\r\nimport { Collider } from './Colliders/Collider';\r\nimport { CompositeCollider } from './Colliders/CompositeCollider';\r\nimport { PolygonCollider } from './Colliders/PolygonCollider';\r\nimport { EdgeCollider } from './Colliders/EdgeCollider';\r\nimport { Shape } from './Colliders/Shape';\r\n\r\nexport class ColliderComponent extends Component<'ex.collider'> {\r\n  public readonly type = 'ex.collider';\r\n\r\n  public events = new EventDispatcher();\r\n  /**\r\n   * Observable that notifies when a collider is added to the body\r\n   */\r\n  public $colliderAdded = new Observable<Collider>();\r\n\r\n  /**\r\n   * Observable that notifies when a collider is removed from the body\r\n   */\r\n  public $colliderRemoved = new Observable<Collider>();\r\n\r\n  constructor(collider?: Collider) {\r\n    super();\r\n    this.set(collider);\r\n  }\r\n\r\n  private _collider: Collider;\r\n  /**\r\n   * Get the current collider geometry\r\n   */\r\n  public get() {\r\n    return this._collider;\r\n  }\r\n\r\n  /**\r\n   * Set the collider geometry\r\n   * @param collider\r\n   * @returns the collider you set\r\n   */\r\n  public set<T extends Collider>(collider: T): T {\r\n    this.clear();\r\n    if (collider) {\r\n      this._collider = collider;\r\n      this._collider.owner = this.owner;\r\n      this.events.wire(collider.events);\r\n      this.$colliderAdded.notifyAll(collider);\r\n      this.update();\r\n    }\r\n    return collider;\r\n  }\r\n\r\n  /**\r\n   * Remove collider geometry from collider component\r\n   */\r\n  public clear() {\r\n    if (this._collider) {\r\n      this.events.unwire(this._collider.events);\r\n      this.$colliderRemoved.notifyAll(this._collider);\r\n      this._collider.owner = null;\r\n      this._collider = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Return world space bounds\r\n   */\r\n  public get bounds() {\r\n    return this._collider?.bounds ?? new BoundingBox();\r\n  }\r\n\r\n  /**\r\n   * Return local space bounds\r\n   */\r\n  public get localBounds() {\r\n    return this._collider?.localBounds ?? new BoundingBox();\r\n  }\r\n\r\n  /**\r\n   * Update the collider's transformed geometry\r\n   */\r\n  public update() {\r\n    const tx = this.owner?.get(TransformComponent);\r\n    if (this._collider) {\r\n      this._collider.owner = this.owner;\r\n      if (tx) {\r\n        this._collider.update(tx.get());\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Collide component with another\r\n   * @param other\r\n   */\r\n  collide(other: ColliderComponent): CollisionContact[] {\r\n    let colliderA = this._collider;\r\n    let colliderB = other._collider;\r\n    if (!colliderA || !colliderB) {\r\n      return [];\r\n    }\r\n\r\n    // If we have a composite lefthand side :(\r\n    // Might bite us, but to avoid updating all the handlers make composite always left side\r\n    let flipped = false;\r\n    if (colliderB instanceof CompositeCollider) {\r\n      colliderA = colliderB;\r\n      colliderB = this._collider;\r\n      flipped = true;\r\n    }\r\n\r\n    if (this._collider) {\r\n      const contacts = colliderA.collide(colliderB);\r\n      if (contacts) {\r\n        if (flipped) {\r\n          contacts.forEach((contact) => {\r\n            contact.mtv = contact.mtv.negate();\r\n            contact.normal = contact.normal.negate();\r\n            contact.tangent = contact.normal.perpendicular();\r\n            contact.colliderA = this._collider;\r\n            contact.colliderB = other._collider;\r\n          });\r\n        }\r\n        return contacts;\r\n      }\r\n      return [];\r\n    }\r\n    return [];\r\n  }\r\n\r\n  onAdd(entity: Entity) {\r\n    if (this._collider) {\r\n      this.update();\r\n    }\r\n    // Wire up the collider events to the owning entity\r\n    this.events.on('precollision', (evt: any) => {\r\n      const precollision = evt as PreCollisionEvent<Collider>;\r\n      entity.events.emit(\r\n        'precollision',\r\n        new PreCollisionEvent(precollision.target.owner, precollision.other.owner, precollision.side, precollision.intersection)\r\n      );\r\n    });\r\n    this.events.on('postcollision', (evt: any) => {\r\n      const postcollision = evt as PostCollisionEvent<Collider>;\r\n      entity.events.emit(\r\n        'postcollision',\r\n        new PostCollisionEvent(postcollision.target.owner, postcollision.other.owner, postcollision.side, postcollision.intersection)\r\n      );\r\n    });\r\n    this.events.on('collisionstart', (evt: any) => {\r\n      const start = evt as CollisionStartEvent<Collider>;\r\n      entity.events.emit('collisionstart', new CollisionStartEvent(start.target.owner, start.other.owner, start.contact));\r\n    });\r\n    this.events.on('collisionend', (evt: any) => {\r\n      const end = evt as CollisionEndEvent<Collider>;\r\n      entity.events.emit('collisionend', new CollisionEndEvent(end.target.owner, end.other.owner));\r\n    });\r\n  }\r\n\r\n  onRemove() {\r\n    this.events.clear();\r\n    this.$colliderRemoved.notifyAll(this._collider);\r\n  }\r\n\r\n  /**\r\n   * Sets up a box geometry based on the current bounds of the associated actor of this physics body.\r\n   *\r\n   * If no width/height are specified the body will attempt to use the associated actor's width/height.\r\n   *\r\n   * By default, the box is center is at (0, 0) which means it is centered around the actors anchor.\r\n   */\r\n  useBoxCollider(width: number, height: number, anchor: Vector = Vector.Half, center: Vector = Vector.Zero): PolygonCollider {\r\n    const collider = Shape.Box(width, height, anchor, center);\r\n    return (this.set(collider));\r\n  }\r\n\r\n  /**\r\n   * Sets up a [[PolygonCollider|polygon]] collision geometry based on a list of of points relative\r\n   *  to the anchor of the associated actor\r\n   * of this physics body.\r\n   *\r\n   * Only [convex polygon](https://en.wikipedia.org/wiki/Convex_polygon) definitions are supported.\r\n   *\r\n   * By default, the box is center is at (0, 0) which means it is centered around the actors anchor.\r\n   */\r\n  usePolygonCollider(points: Vector[], center: Vector = Vector.Zero): PolygonCollider {\r\n    const poly = Shape.Polygon(points, center);\r\n    return (this.set(poly));\r\n  }\r\n\r\n  /**\r\n   * Sets up a [[Circle|circle collision geometry]] as the only collider with a specified radius in pixels.\r\n   *\r\n   * By default, the box is center is at (0, 0) which means it is centered around the actors anchor.\r\n   */\r\n  useCircleCollider(radius: number, center: Vector = Vector.Zero): CircleCollider {\r\n    const collider = Shape.Circle(radius, center);\r\n    return (this.set(collider));\r\n  }\r\n\r\n  /**\r\n   * Sets up an [[Edge|edge collision geometry]] with a start point and an end point relative to the anchor of the associated actor\r\n   * of this physics body.\r\n   *\r\n   * By default, the box is center is at (0, 0) which means it is centered around the actors anchor.\r\n   */\r\n  useEdgeCollider(begin: Vector, end: Vector): EdgeCollider {\r\n    const collider = Shape.Edge(begin, end);\r\n    return (this.set(collider));\r\n  }\r\n\r\n  /**\r\n   * Setups up a [[CompositeCollider]] which can define any arbitrary set of excalibur colliders\r\n   * @param colliders\r\n   */\r\n  useCompositeCollider(colliders: Collider[]): CompositeCollider {\r\n    return (this.set(new CompositeCollider(colliders)));\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\r\nimport { CollisionType } from './CollisionType';\r\nimport { Physics } from './Physics';\r\nimport { Clonable } from '../Interfaces/Clonable';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\r\nimport { Component } from '../EntityComponentSystem/Component';\r\nimport { CollisionGroup } from './Group/CollisionGroup';\r\nimport { EventDispatcher } from '../EventDispatcher';\r\nimport { createId, Id } from '../Id';\r\nimport { clamp } from '../Math/util';\r\nimport { ColliderComponent } from './ColliderComponent';\r\nimport { Transform } from '../Math/transform';\r\n\r\nexport interface BodyComponentOptions {\r\n  type?: CollisionType;\r\n  group?: CollisionGroup;\r\n  useGravity?: boolean;\r\n}\r\n\r\nexport enum DegreeOfFreedom {\r\n  Rotation = 'rotation',\r\n  X = 'x',\r\n  Y = 'y'\r\n}\r\n\r\n/**\r\n * Body describes all the physical properties pos, vel, acc, rotation, angular velocity for the purpose of\r\n * of physics simulation.\r\n */\r\nexport class BodyComponent extends Component<'ex.body'> implements Clonable<BodyComponent> {\r\n  public readonly type = 'ex.body';\r\n  public dependencies = [TransformComponent, MotionComponent];\r\n  public static _ID = 0;\r\n  public readonly id: Id<'body'> = createId('body', BodyComponent._ID++);\r\n  public events = new EventDispatcher();\r\n\r\n  private _oldTransform = new Transform();\r\n\r\n  /**\r\n   * Indicates whether the old transform has been captured at least once for interpolation\r\n   * @internal\r\n   */\r\n  public __oldTransformCaptured: boolean = false;\r\n\r\n  /**\r\n   * Enable or disabled the fixed update interpolation, by default interpolation is on.\r\n   */\r\n  public enableFixedUpdateInterpolate = true;\r\n\r\n  constructor(options?: BodyComponentOptions) {\r\n    super();\r\n    if (options) {\r\n      this.collisionType = options.type ?? this.collisionType;\r\n      this.group = options.group ?? this.group;\r\n      this.useGravity = options.useGravity ?? this.useGravity;\r\n    }\r\n  }\r\n\r\n  public get matrix() {\r\n    return this.transform.get().matrix;\r\n  }\r\n\r\n  /**\r\n   * Collision type for the rigidbody physics simulation, by default [[CollisionType.PreventCollision]]\r\n   */\r\n  public collisionType: CollisionType = CollisionType.PreventCollision;\r\n\r\n  /**\r\n   * The collision group for the body's colliders, by default body colliders collide with everything\r\n   */\r\n  public group: CollisionGroup = CollisionGroup.All;\r\n\r\n  /**\r\n   * The amount of mass the body has\r\n   */\r\n  private _mass: number = Physics.defaultMass;\r\n  public get mass(): number {\r\n    return this._mass;\r\n  }\r\n\r\n  public set mass(newMass: number) {\r\n    this._mass = newMass;\r\n    this._cachedInertia = undefined;\r\n    this._cachedInverseInertia = undefined;\r\n  }\r\n\r\n  /**\r\n   * The inverse mass (1/mass) of the body. If [[CollisionType.Fixed]] this is 0, meaning \"infinite\" mass\r\n   */\r\n  public get inverseMass(): number {\r\n    return this.collisionType === CollisionType.Fixed ? 0 : 1 / this.mass;\r\n  }\r\n\r\n  /**\r\n   * Amount of \"motion\" the body has before sleeping. If below [[Physics.sleepEpsilon]] it goes to \"sleep\"\r\n   */\r\n  public sleepMotion: number = Physics.sleepEpsilon * 5;\r\n\r\n  /**\r\n   * Can this body sleep, by default bodies do not sleep\r\n   */\r\n  public canSleep: boolean = Physics.bodiesCanSleepByDefault;\r\n\r\n  private _sleeping = false;\r\n  /**\r\n   * Whether this body is sleeping or not\r\n   */\r\n  public get sleeping(): boolean {\r\n    return this._sleeping;\r\n  }\r\n\r\n  /**\r\n   * Set the sleep state of the body\r\n   * @param sleeping\r\n   */\r\n  public setSleeping(sleeping: boolean) {\r\n    this._sleeping = sleeping;\r\n    if (!sleeping) {\r\n      // Give it a kick to keep it from falling asleep immediately\r\n      this.sleepMotion = Physics.sleepEpsilon * 5;\r\n    } else {\r\n      this.vel = Vector.Zero;\r\n      this.acc = Vector.Zero;\r\n      this.angularVelocity = 0;\r\n      this.sleepMotion = 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update body's [[BodyComponent.sleepMotion]] for the purpose of sleeping\r\n   */\r\n  public updateMotion() {\r\n    if (this._sleeping) {\r\n      this.setSleeping(true);\r\n    }\r\n    const currentMotion = this.vel.size * this.vel.size + Math.abs(this.angularVelocity * this.angularVelocity);\r\n    const bias = Physics.sleepBias;\r\n    this.sleepMotion = bias * this.sleepMotion + (1 - bias) * currentMotion;\r\n    this.sleepMotion = clamp(this.sleepMotion, 0, 10 * Physics.sleepEpsilon);\r\n    if (this.canSleep && this.sleepMotion < Physics.sleepEpsilon) {\r\n      this.setSleeping(true);\r\n    }\r\n  }\r\n\r\n  private _cachedInertia: number;\r\n  /**\r\n   * Get the moment of inertia from the [[ColliderComponent]]\r\n   */\r\n  public get inertia() {\r\n    if (this._cachedInertia) {\r\n      return this._cachedInertia;\r\n    }\r\n\r\n    // Inertia is a property of the geometry, so this is a little goofy but seems to be okay?\r\n    const collider = this.owner.get(ColliderComponent);\r\n    if (collider) {\r\n      collider.$colliderAdded.subscribe(() => {\r\n        this._cachedInertia = null;\r\n      });\r\n      collider.$colliderRemoved.subscribe(() => {\r\n        this._cachedInertia = null;\r\n      });\r\n      const maybeCollider = collider.get();\r\n      if (maybeCollider) {\r\n        return this._cachedInertia = maybeCollider.getInertia(this.mass);\r\n      }\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  private _cachedInverseInertia: number;\r\n  /**\r\n   * Get the inverse moment of inertial from the [[ColliderComponent]]. If [[CollisionType.Fixed]] this is 0, meaning \"infinite\" mass\r\n   */\r\n  public get inverseInertia() {\r\n    if (this._cachedInverseInertia) {\r\n      return this._cachedInverseInertia;\r\n    }\r\n    return this._cachedInverseInertia = this.collisionType === CollisionType.Fixed ? 0 : 1 / this.inertia;\r\n  }\r\n\r\n  /**\r\n   * The also known as coefficient of restitution of this actor, represents the amount of energy preserved after collision or the\r\n   * bounciness. If 1, it is 100% bouncy, 0 it completely absorbs.\r\n   */\r\n  public bounciness: number = 0.2;\r\n\r\n  /**\r\n   * The coefficient of friction on this actor\r\n   */\r\n  public friction: number = 0.99;\r\n\r\n  /**\r\n   * Should use global gravity [[Physics.gravity]] in it's physics simulation, default is true\r\n   */\r\n  public useGravity: boolean = true;\r\n\r\n  /**\r\n   * Degrees of freedom to limit\r\n   *\r\n   * Note: this only limits responses in the realistic solver, if velocity/angularVelocity is set the actor will still respond\r\n   */\r\n  public limitDegreeOfFreedom: DegreeOfFreedom[] = [];\r\n\r\n  /**\r\n   * Returns if the owner is active\r\n   */\r\n  public get active() {\r\n    return !!this.owner?.active;\r\n  }\r\n\r\n  /**\r\n   * @deprecated Use globalP0s\r\n   */\r\n  public get center() {\r\n    return this.globalPos;\r\n  }\r\n\r\n  public get transform(): TransformComponent {\r\n    return this.owner?.get(TransformComponent);\r\n  }\r\n\r\n  public get motion(): MotionComponent {\r\n    return  this.owner?.get(MotionComponent);\r\n  }\r\n\r\n  public get pos(): Vector {\r\n    return this.transform.pos;\r\n  }\r\n\r\n  public set pos(val: Vector) {\r\n    this.transform.pos = val;\r\n  }\r\n\r\n  /**\r\n   * The (x, y) position of the actor this will be in the middle of the actor if the\r\n   * [[Actor.anchor]] is set to (0.5, 0.5) which is default.\r\n   * If you want the (x, y) position to be the top left of the actor specify an anchor of (0, 0).\r\n   */\r\n  public get globalPos(): Vector {\r\n    return this.transform.globalPos;\r\n  }\r\n\r\n  public set globalPos(val: Vector) {\r\n    this.transform.globalPos = val;\r\n  }\r\n\r\n  /**\r\n   * The position of the actor last frame (x, y) in pixels\r\n   */\r\n  public get oldPos(): Vector {\r\n    return this._oldTransform.pos;\r\n  }\r\n\r\n  /**\r\n   * The current velocity vector (vx, vy) of the actor in pixels/second\r\n   */\r\n  public get vel(): Vector {\r\n    return this.motion.vel;\r\n  }\r\n\r\n  public set vel(val: Vector) {\r\n    this.motion.vel = val;\r\n  }\r\n\r\n  /**\r\n   * The velocity of the actor last frame (vx, vy) in pixels/second\r\n   */\r\n  public oldVel: Vector = new Vector(0, 0);\r\n\r\n  /**\r\n   * The current acceleration vector (ax, ay) of the actor in pixels/second/second. An acceleration pointing down such as (0, 100) may\r\n   * be useful to simulate a gravitational effect.\r\n   */\r\n  public get acc(): Vector {\r\n    return this.motion.acc;\r\n  }\r\n\r\n  public set acc(val: Vector) {\r\n    this.motion.acc = val;\r\n  }\r\n\r\n  /**\r\n   * Gets/sets the acceleration of the actor from the last frame. This does not include the global acc [[Physics.acc]].\r\n   */\r\n  public oldAcc: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * The current torque applied to the actor\r\n   */\r\n  public get torque(): number {\r\n    return this.motion.torque;\r\n  }\r\n\r\n  public set torque(val: number) {\r\n    this.motion.torque = val;\r\n  }\r\n\r\n  /**\r\n   * Gets/sets the rotation of the body from the last frame.\r\n   */\r\n  public get oldRotation(): number {\r\n    return this._oldTransform.rotation;\r\n  }\r\n\r\n  /**\r\n   * The rotation of the body in radians\r\n   */\r\n  public get rotation() {\r\n    return this.transform.globalRotation;\r\n  }\r\n\r\n  public set rotation(val: number) {\r\n    this.transform.globalRotation = val;\r\n  }\r\n\r\n  /**\r\n   * The scale vector of the actor\r\n   */\r\n  public get scale(): Vector {\r\n    return this.transform.globalScale;\r\n  }\r\n\r\n  public set scale(val: Vector) {\r\n    this.transform.globalScale = val;\r\n  }\r\n\r\n  /**\r\n   * The scale of the actor last frame\r\n   */\r\n  public get oldScale(): Vector {\r\n    return this._oldTransform.scale;\r\n  }\r\n\r\n  /**\r\n   * The scale rate of change of the actor in scale/second\r\n   */\r\n  public get scaleFactor(): Vector {\r\n    return this.motion.scaleFactor;\r\n  }\r\n\r\n  public set scaleFactor(scaleFactor: Vector) {\r\n    this.motion.scaleFactor = scaleFactor;\r\n  }\r\n\r\n  /**\r\n   * Get the angular velocity in radians/second\r\n   */\r\n  public get angularVelocity(): number {\r\n    return this.motion.angularVelocity;\r\n  }\r\n\r\n  /**\r\n   * Set the angular velocity in radians/second\r\n   */\r\n  public set angularVelocity(value: number) {\r\n    this.motion.angularVelocity = value;\r\n  }\r\n\r\n  /**\r\n   * Apply a specific impulse to the body\r\n   * @param point\r\n   * @param impulse\r\n   */\r\n  public applyImpulse(point: Vector, impulse: Vector) {\r\n    if (this.collisionType !== CollisionType.Active) {\r\n      return; // only active objects participate in the simulation\r\n    }\r\n\r\n    const finalImpulse = impulse.scale(this.inverseMass);\r\n    if (this.limitDegreeOfFreedom.includes(DegreeOfFreedom.X)) {\r\n      finalImpulse.x = 0;\r\n    }\r\n    if (this.limitDegreeOfFreedom.includes(DegreeOfFreedom.Y)) {\r\n      finalImpulse.y = 0;\r\n    }\r\n\r\n    this.vel.addEqual(finalImpulse);\r\n\r\n    if (!this.limitDegreeOfFreedom.includes(DegreeOfFreedom.Rotation)) {\r\n      const distanceFromCenter = point.sub(this.globalPos);\r\n      this.angularVelocity += this.inverseInertia * distanceFromCenter.cross(impulse);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Apply only linear impulse to the body\r\n   * @param impulse\r\n   */\r\n  public applyLinearImpulse(impulse: Vector) {\r\n    if (this.collisionType !== CollisionType.Active) {\r\n      return; // only active objects participate in the simulation\r\n    }\r\n\r\n    const finalImpulse = impulse.scale(this.inverseMass);\r\n\r\n    if (this.limitDegreeOfFreedom.includes(DegreeOfFreedom.X)) {\r\n      finalImpulse.x = 0;\r\n    }\r\n    if (this.limitDegreeOfFreedom.includes(DegreeOfFreedom.Y)) {\r\n      finalImpulse.y = 0;\r\n    }\r\n\r\n    this.vel = this.vel.add(finalImpulse);\r\n  }\r\n\r\n  /**\r\n   * Apply only angular impulse to the body\r\n   * @param point\r\n   * @param impulse\r\n   */\r\n  public applyAngularImpulse(point: Vector, impulse: Vector) {\r\n    if (this.collisionType !== CollisionType.Active) {\r\n      return; // only active objects participate in the simulation\r\n    }\r\n\r\n    if (!this.limitDegreeOfFreedom.includes(DegreeOfFreedom.Rotation)) {\r\n      const distanceFromCenter = point.sub(this.globalPos);\r\n      this.angularVelocity += this.inverseInertia * distanceFromCenter.cross(impulse);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Sets the old versions of pos, vel, acc, and scale.\r\n   */\r\n  public captureOldTransform() {\r\n    // Capture old values before integration step updates them\r\n    this.__oldTransformCaptured = true;\r\n    this.transform.get().clone(this._oldTransform);\r\n    this.oldVel.setTo(this.vel.x, this.vel.y);\r\n    this.oldAcc.setTo(this.acc.x, this.acc.y);\r\n  }\r\n}\r\n","/**\r\n * An enum that describes the strategies that rotation actions can use\r\n */\r\nexport enum RotationType {\r\n  /**\r\n   * Rotation via `ShortestPath` will use the smallest angle\r\n   * between the starting and ending points. This strategy is the default behavior.\r\n   */\r\n  ShortestPath = 0,\r\n  /**\r\n   * Rotation via `LongestPath` will use the largest angle\r\n   * between the starting and ending points.\r\n   */\r\n  LongestPath = 1,\r\n  /**\r\n   * Rotation via `Clockwise` will travel in a clockwise direction,\r\n   * regardless of the starting and ending points.\r\n   */\r\n  Clockwise = 2,\r\n  /**\r\n   * Rotation via `CounterClockwise` will travel in a counterclockwise direction,\r\n   * regardless of the starting and ending points.\r\n   */\r\n  CounterClockwise = 3\r\n}\r\n","import { BoundingBox } from '../Collision/BoundingBox';\r\nimport { Color } from '../Color';\r\nimport { Vector } from '../Math/vector';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\n\r\n/**\r\n * Enum representing the different font size units\r\n * https://developer.mozilla.org/en-US/docs/Web/CSS/font-size\r\n */\r\nexport enum FontUnit {\r\n  /**\r\n   * Em is a scalable unit, 1 em is equal to the current font size of the current element, parent elements can effect em values\r\n   */\r\n  Em = 'em',\r\n  /**\r\n   * Rem is similar to the Em, it is a scalable unit. 1 rem is equal to the font size of the root element\r\n   */\r\n  Rem = 'rem',\r\n  /**\r\n   * Pixel is a unit of length in screen pixels\r\n   */\r\n  Px = 'px',\r\n  /**\r\n   * Point is a physical unit length (1/72 of an inch)\r\n   */\r\n  Pt = 'pt',\r\n  /**\r\n   * Percent is a scalable unit similar to Em, the only difference is the Em units scale faster when Text-Size stuff\r\n   */\r\n  Percent = '%'\r\n}\r\n\r\n/**\r\n * Enum representing the different horizontal text alignments\r\n */\r\nexport enum TextAlign {\r\n  /**\r\n   * The text is left-aligned.\r\n   */\r\n  Left = 'left',\r\n  /**\r\n   * The text is right-aligned.\r\n   */\r\n  Right = 'right',\r\n  /**\r\n   * The text is centered.\r\n   */\r\n  Center = 'center',\r\n  /**\r\n   * The text is aligned at the normal start of the line (left-aligned for left-to-right locales,\r\n   * right-aligned for right-to-left locales).\r\n   */\r\n  Start = 'start',\r\n  /**\r\n   * The text is aligned at the normal end of the line (right-aligned for left-to-right locales,\r\n   * left-aligned for right-to-left locales).\r\n   */\r\n  End = 'end'\r\n}\r\n\r\n/**\r\n * Enum representing the different baseline text alignments\r\n */\r\nexport enum BaseAlign {\r\n  /**\r\n   * The text baseline is the top of the em square.\r\n   */\r\n  Top = 'top',\r\n  /**\r\n   * The text baseline is the hanging baseline.  Currently unsupported; this will act like\r\n   * alphabetic.\r\n   */\r\n  Hanging = 'hanging',\r\n  /**\r\n   * The text baseline is the middle of the em square.\r\n   */\r\n  Middle = 'middle',\r\n  /**\r\n   * The text baseline is the normal alphabetic baseline.\r\n   */\r\n  Alphabetic = 'alphabetic',\r\n  /**\r\n   * The text baseline is the ideographic baseline; this is the bottom of\r\n   * the body of the characters, if the main body of characters protrudes\r\n   * beneath the alphabetic baseline.  Currently unsupported; this will\r\n   * act like alphabetic.\r\n   */\r\n  Ideographic = 'ideographic',\r\n  /**\r\n   * The text baseline is the bottom of the bounding box.  This differs\r\n   * from the ideographic baseline in that the ideographic baseline\r\n   * doesn't consider descenders.\r\n   */\r\n  Bottom = 'bottom'\r\n}\r\n\r\n/**\r\n * Enum representing the different possible font styles\r\n */\r\nexport enum FontStyle {\r\n  Normal = 'normal',\r\n  Italic = 'italic',\r\n  Oblique = 'oblique'\r\n}\r\n\r\n/**\r\n * Enum representing the text direction, useful for other languages, or writing text in reverse\r\n */\r\nexport enum Direction {\r\n  LeftToRight = 'ltr',\r\n  RightToLeft = 'rtl'\r\n}\r\n\r\n/**\r\n * Font rendering option\r\n */\r\nexport interface FontOptions {\r\n  /**\r\n   * Optionally the size of the font in the specified [[FontUnit]] by default 10.\r\n   */\r\n  size?: number;\r\n  /**\r\n   * Optionally specify unit to measure fonts in, by default Pixels\r\n   */\r\n  unit?: FontUnit;\r\n  /**\r\n   * Optionally specify the font family, by default 'sans-serif'\r\n   */\r\n  family?: string;\r\n  /**\r\n   * Optionally specify the font style, by default Normal\r\n   */\r\n  style?: FontStyle;\r\n  /**\r\n   * Optionally set whether the font is bold, by default false\r\n   */\r\n  bold?: boolean;\r\n  /**\r\n   * Optionally specify the text align, by default Left\r\n   */\r\n  textAlign?: TextAlign;\r\n  /**\r\n   * Optionally specify the text base align, by default Alphabetic\r\n   */\r\n  baseAlign?: BaseAlign;\r\n  /**\r\n   * Optionally specify the text direction, by default LeftToRight\r\n   */\r\n  direction?: Direction;\r\n  /**\r\n   * Optionally specify the quality of the text bitmap, it is a multiplier on the size size, by default 2.\r\n   * Higher quality text has a higher memory impact\r\n   */\r\n  quality?: number;\r\n  /**\r\n   * Optionally specify a text shadow, by default none is specified\r\n   */\r\n  shadow?: {\r\n    blur?: number;\r\n    offset?: Vector;\r\n    color?: Color;\r\n  };\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport interface FontRenderer {\r\n  measureText(text: string): BoundingBox;\r\n  render(ex: ExcaliburGraphicsContext, text: string, color: Color, x: number, y: number): void;\r\n}\r\n","import { Engine } from './Engine';\r\nimport { Screen } from './Screen';\r\nimport { EasingFunction, EasingFunctions } from './Util/EasingFunctions';\r\nimport { Vector, vec } from './Math/vector';\r\nimport { Actor } from './Actor';\r\nimport { removeItemFromArray } from './Util/Util';\r\nimport { CanUpdate, CanInitialize } from './Interfaces/LifecycleEvents';\r\nimport { PreUpdateEvent, PostUpdateEvent, GameEvent, InitializeEvent } from './Events';\r\nimport { Class } from './Class';\r\nimport { BoundingBox } from './Collision/BoundingBox';\r\nimport { Logger } from './Util/Log';\r\nimport { ExcaliburGraphicsContext } from './Graphics/Context/ExcaliburGraphicsContext';\r\nimport { watchAny } from './Util/Watch';\r\nimport { AffineMatrix } from './Math/affine-matrix';\r\n\r\n/**\r\n * Interface that describes a custom camera strategy for tracking targets\r\n */\r\nexport interface CameraStrategy<T> {\r\n  /**\r\n   * Target of the camera strategy that will be passed to the action\r\n   */\r\n  target: T;\r\n\r\n  /**\r\n   * Camera strategies perform an action to calculate a new focus returned out of the strategy\r\n   * @param target The target object to apply this camera strategy (if any)\r\n   * @param camera The current camera implementation in excalibur running the game\r\n   * @param engine The current engine running the game\r\n   * @param delta The elapsed time in milliseconds since the last frame\r\n   */\r\n  action: (target: T, camera: Camera, engine: Engine, delta: number) => Vector;\r\n}\r\n\r\n/**\r\n * Container to house convenience strategy methods\r\n * @internal\r\n */\r\nexport class StrategyContainer {\r\n  constructor(public camera: Camera) {}\r\n\r\n  /**\r\n   * Creates and adds the [[LockCameraToActorStrategy]] on the current camera.\r\n   * @param actor The actor to lock the camera to\r\n   */\r\n  public lockToActor(actor: Actor) {\r\n    this.camera.addStrategy(new LockCameraToActorStrategy(actor));\r\n  }\r\n\r\n  /**\r\n   * Creates and adds the [[LockCameraToActorAxisStrategy]] on the current camera\r\n   * @param actor The actor to lock the camera to\r\n   * @param axis The axis to follow the actor on\r\n   */\r\n  public lockToActorAxis(actor: Actor, axis: Axis) {\r\n    this.camera.addStrategy(new LockCameraToActorAxisStrategy(actor, axis));\r\n  }\r\n\r\n  /**\r\n   * Creates and adds the [[ElasticToActorStrategy]] on the current camera\r\n   * If cameraElasticity < cameraFriction < 1.0, the behavior will be a dampened spring that will slowly end at the target without bouncing\r\n   * If cameraFriction < cameraElasticity < 1.0, the behavior will be an oscillating spring that will over\r\n   * correct and bounce around the target\r\n   *\r\n   * @param actor Target actor to elastically follow\r\n   * @param cameraElasticity [0 - 1.0] The higher the elasticity the more force that will drive the camera towards the target\r\n   * @param cameraFriction [0 - 1.0] The higher the friction the more that the camera will resist motion towards the target\r\n   */\r\n  public elasticToActor(actor: Actor, cameraElasticity: number, cameraFriction: number) {\r\n    this.camera.addStrategy(new ElasticToActorStrategy(actor, cameraElasticity, cameraFriction));\r\n  }\r\n\r\n  /**\r\n   * Creates and adds the [[RadiusAroundActorStrategy]] on the current camera\r\n   * @param actor Target actor to follow when it is \"radius\" pixels away\r\n   * @param radius Number of pixels away before the camera will follow\r\n   */\r\n  public radiusAroundActor(actor: Actor, radius: number) {\r\n    this.camera.addStrategy(new RadiusAroundActorStrategy(actor, radius));\r\n  }\r\n\r\n  /**\r\n   * Creates and adds the [[LimitCameraBoundsStrategy]] on the current camera\r\n   * @param box The bounding box to limit the camera to.\r\n   */\r\n  public limitCameraBounds(box: BoundingBox) {\r\n    this.camera.addStrategy(new LimitCameraBoundsStrategy(box));\r\n  }\r\n}\r\n\r\n/**\r\n * Camera axis enum\r\n */\r\nexport enum Axis {\r\n  X,\r\n  Y\r\n}\r\n\r\n/**\r\n * Lock a camera to the exact x/y position of an actor.\r\n */\r\nexport class LockCameraToActorStrategy implements CameraStrategy<Actor> {\r\n  constructor(public target: Actor) {}\r\n  public action = (target: Actor, _cam: Camera, _eng: Engine, _delta: number) => {\r\n    const center = target.center;\r\n    return center;\r\n  };\r\n}\r\n\r\n/**\r\n * Lock a camera to a specific axis around an actor.\r\n */\r\nexport class LockCameraToActorAxisStrategy implements CameraStrategy<Actor> {\r\n  constructor(public target: Actor, public axis: Axis) {}\r\n  public action = (target: Actor, cam: Camera, _eng: Engine, _delta: number) => {\r\n    const center = target.center;\r\n    const currentFocus = cam.getFocus();\r\n    if (this.axis === Axis.X) {\r\n      return new Vector(center.x, currentFocus.y);\r\n    } else {\r\n      return new Vector(currentFocus.x, center.y);\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Using [Hook's law](https://en.wikipedia.org/wiki/Hooke's_law), elastically move the camera towards the target actor.\r\n */\r\nexport class ElasticToActorStrategy implements CameraStrategy<Actor> {\r\n  /**\r\n   * If cameraElasticity < cameraFriction < 1.0, the behavior will be a dampened spring that will slowly end at the target without bouncing\r\n   * If cameraFriction < cameraElasticity < 1.0, the behavior will be an oscillating spring that will over\r\n   * correct and bounce around the target\r\n   *\r\n   * @param target Target actor to elastically follow\r\n   * @param cameraElasticity [0 - 1.0] The higher the elasticity the more force that will drive the camera towards the target\r\n   * @param cameraFriction [0 - 1.0] The higher the friction the more that the camera will resist motion towards the target\r\n   */\r\n  constructor(public target: Actor, public cameraElasticity: number, public cameraFriction: number) {}\r\n  public action = (target: Actor, cam: Camera, _eng: Engine, _delta: number) => {\r\n    const position = target.center;\r\n    let focus = cam.getFocus();\r\n    let cameraVel = cam.vel.clone();\r\n\r\n    // Calculate the stretch vector, using the spring equation\r\n    // F = kX\r\n    // https://en.wikipedia.org/wiki/Hooke's_law\r\n    // Apply to the current camera velocity\r\n    const stretch = position.sub(focus).scale(this.cameraElasticity); // stretch is X\r\n    cameraVel = cameraVel.add(stretch);\r\n\r\n    // Calculate the friction (-1 to apply a force in the opposition of motion)\r\n    // Apply to the current camera velocity\r\n    const friction = cameraVel.scale(-1).scale(this.cameraFriction);\r\n    cameraVel = cameraVel.add(friction);\r\n\r\n    // Update position by velocity deltas\r\n    focus = focus.add(cameraVel);\r\n\r\n    return focus;\r\n  };\r\n}\r\n\r\nexport class RadiusAroundActorStrategy implements CameraStrategy<Actor> {\r\n  /**\r\n   *\r\n   * @param target Target actor to follow when it is \"radius\" pixels away\r\n   * @param radius Number of pixels away before the camera will follow\r\n   */\r\n  constructor(public target: Actor, public radius: number) {}\r\n  public action = (target: Actor, cam: Camera, _eng: Engine, _delta: number) => {\r\n    const position = target.center;\r\n    const focus = cam.getFocus();\r\n\r\n    const direction = position.sub(focus);\r\n    const distance = direction.size;\r\n    if (distance >= this.radius) {\r\n      const offset = distance - this.radius;\r\n      return focus.add(direction.normalize().scale(offset));\r\n    }\r\n    return focus;\r\n  };\r\n}\r\n\r\n/**\r\n * Prevent a camera from going beyond the given camera dimensions.\r\n */\r\nexport class LimitCameraBoundsStrategy implements CameraStrategy<BoundingBox> {\r\n  /**\r\n   * Useful for limiting the camera to a [[TileMap]]'s dimensions, or a specific area inside the map.\r\n   *\r\n   * Note that this strategy does not perform any movement by itself.\r\n   * It only sets the camera position to within the given bounds when the camera has gone beyond them.\r\n   * Thus, it is a good idea to combine it with other camera strategies and set this strategy as the last one.\r\n   *\r\n   * Make sure that the camera bounds are at least as large as the viewport size.\r\n   *\r\n   * @param target The bounding box to limit the camera to\r\n   */\r\n\r\n  boundSizeChecked: boolean = false; // Check and warn only once\r\n\r\n  constructor(public target: BoundingBox) {}\r\n\r\n  public action = (target: BoundingBox, cam: Camera, _eng: Engine, _delta: number) => {\r\n    const focus = cam.getFocus();\r\n\r\n    if (!this.boundSizeChecked) {\r\n      if (target.bottom - target.top < _eng.drawHeight || target.right - target.left < _eng.drawWidth) {\r\n        Logger.getInstance().warn('Camera bounds should not be smaller than the engine viewport');\r\n      }\r\n      this.boundSizeChecked = true;\r\n    }\r\n\r\n    let focusX = focus.x;\r\n    let focusY = focus.y;\r\n    if (focus.x < target.left + _eng.halfDrawWidth) {\r\n      focusX = target.left + _eng.halfDrawWidth;\r\n    } else if (focus.x > target.right - _eng.halfDrawWidth) {\r\n      focusX = target.right - _eng.halfDrawWidth;\r\n    }\r\n\r\n    if (focus.y < target.top + _eng.halfDrawHeight) {\r\n      focusY = target.top + _eng.halfDrawHeight;\r\n    } else if (focus.y > target.bottom - _eng.halfDrawHeight) {\r\n      focusY = target.bottom - _eng.halfDrawHeight;\r\n    }\r\n\r\n    return vec(focusX, focusY);\r\n  };\r\n}\r\n\r\n/**\r\n * Cameras\r\n *\r\n * [[Camera]] is the base class for all Excalibur cameras. Cameras are used\r\n * to move around your game and set focus. They are used to determine\r\n * what is \"off screen\" and can be used to scale the game.\r\n *\r\n */\r\nexport class Camera extends Class implements CanUpdate, CanInitialize {\r\n  public transform: AffineMatrix = AffineMatrix.identity();\r\n  public inverse: AffineMatrix = AffineMatrix.identity();\r\n\r\n\r\n  protected _follow: Actor;\r\n\r\n  private _cameraStrategies: CameraStrategy<any>[] = [];\r\n\r\n  public strategy: StrategyContainer = new StrategyContainer(this);\r\n\r\n  /**\r\n   * Get or set current zoom of the camera, defaults to 1\r\n   */\r\n  private _z = 1;\r\n  public get zoom(): number {\r\n    return this._z;\r\n  }\r\n\r\n  public set zoom(val: number) {\r\n    this._z = val;\r\n    if (this._engine) {\r\n      this._halfWidth = this._engine.halfDrawWidth;\r\n      this._halfHeight = this._engine.halfDrawHeight;\r\n    }\r\n  }\r\n  /**\r\n   * Get or set rate of change in zoom, defaults to 0\r\n   */\r\n  public dz: number = 0;\r\n  /**\r\n   * Get or set zoom acceleration\r\n   */\r\n  public az: number = 0;\r\n\r\n  /**\r\n   * Current rotation of the camera\r\n   */\r\n  public rotation: number = 0;\r\n\r\n  private _angularVelocity: number = 0;\r\n\r\n  /**\r\n   * Get or set the camera's angular velocity\r\n   */\r\n  public get angularVelocity(): number {\r\n    return this._angularVelocity;\r\n  }\r\n\r\n  public set angularVelocity(value: number) {\r\n    this._angularVelocity = value;\r\n  }\r\n\r\n  /**\r\n   * Get or set the camera's position\r\n   */\r\n  private _posChanged = false;\r\n  private _pos: Vector = watchAny(Vector.Zero, () => (this._posChanged = true));\r\n  public get pos(): Vector {\r\n    return this._pos;\r\n  }\r\n  public set pos(vec: Vector) {\r\n    this._pos = watchAny(vec, () => (this._posChanged = true));\r\n    this._posChanged = true;\r\n  }\r\n\r\n  /**\r\n   * Get or set the camera's velocity\r\n   */\r\n  public vel: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * Get or set the camera's acceleration\r\n   */\r\n  public acc: Vector = Vector.Zero;\r\n\r\n  private _cameraMoving: boolean = false;\r\n  private _currentLerpTime: number = 0;\r\n  private _lerpDuration: number = 1000; // 1 second\r\n  private _lerpStart: Vector = null;\r\n  private _lerpEnd: Vector = null;\r\n  private _lerpResolve: (value: Vector) => void;\r\n  private _lerpPromise: Promise<Vector>;\r\n\r\n  //camera effects\r\n  protected _isShaking: boolean = false;\r\n  private _shakeMagnitudeX: number = 0;\r\n  private _shakeMagnitudeY: number = 0;\r\n  private _shakeDuration: number = 0;\r\n  private _elapsedShakeTime: number = 0;\r\n  private _xShake: number = 0;\r\n  private _yShake: number = 0;\r\n\r\n  protected _isZooming: boolean = false;\r\n  private _zoomStart: number = 1;\r\n  private _zoomEnd: number = 1;\r\n  private _currentZoomTime: number = 0;\r\n  private _zoomDuration: number = 0;\r\n\r\n  private _zoomResolve: (val: boolean) => void;\r\n  private _zoomPromise: Promise<boolean>;\r\n  private _zoomEasing: EasingFunction = EasingFunctions.EaseInOutCubic;\r\n  private _easing: EasingFunction = EasingFunctions.EaseInOutCubic;\r\n\r\n  private _halfWidth: number = 0;\r\n  private _halfHeight: number = 0;\r\n\r\n  /**\r\n   * Get the camera's x position\r\n   */\r\n  public get x() {\r\n    return this.pos.x;\r\n  }\r\n\r\n  /**\r\n   * Set the camera's x position (cannot be set when following an [[Actor]] or when moving)\r\n   */\r\n  public set x(value: number) {\r\n    if (!this._follow && !this._cameraMoving) {\r\n      this.pos = vec(value, this.pos.y);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the camera's y position\r\n   */\r\n  public get y() {\r\n    return this.pos.y;\r\n  }\r\n\r\n  /**\r\n   * Set the camera's y position (cannot be set when following an [[Actor]] or when moving)\r\n   */\r\n  public set y(value: number) {\r\n    if (!this._follow && !this._cameraMoving) {\r\n      this.pos = vec(this.pos.x, value);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get or set the camera's x velocity\r\n   */\r\n  public get dx() {\r\n    return this.vel.x;\r\n  }\r\n\r\n  public set dx(value: number) {\r\n    this.vel = vec(value, this.vel.y);\r\n  }\r\n\r\n  /**\r\n   * Get or set the camera's y velocity\r\n   */\r\n  public get dy() {\r\n    return this.vel.y;\r\n  }\r\n\r\n  public set dy(value: number) {\r\n    this.vel = vec(this.vel.x, value);\r\n  }\r\n\r\n  /**\r\n   * Get or set the camera's x acceleration\r\n   */\r\n  public get ax() {\r\n    return this.acc.x;\r\n  }\r\n\r\n  public set ax(value: number) {\r\n    this.acc = vec(value, this.acc.y);\r\n  }\r\n\r\n  /**\r\n   * Get or set the camera's y acceleration\r\n   */\r\n  public get ay() {\r\n    return this.acc.y;\r\n  }\r\n\r\n  public set ay(value: number) {\r\n    this.acc = vec(this.acc.x, value);\r\n  }\r\n\r\n  /**\r\n   * Returns the focal point of the camera, a new point giving the x and y position of the camera\r\n   */\r\n  public getFocus() {\r\n    return this.pos;\r\n  }\r\n\r\n  /**\r\n   * This moves the camera focal point to the specified position using specified easing function. Cannot move when following an Actor.\r\n   *\r\n   * @param pos The target position to move to\r\n   * @param duration The duration in milliseconds the move should last\r\n   * @param [easingFn] An optional easing function ([[ex.EasingFunctions.EaseInOutCubic]] by default)\r\n   * @returns A [[Promise]] that resolves when movement is finished, including if it's interrupted.\r\n   *          The [[Promise]] value is the [[Vector]] of the target position. It will be rejected if a move cannot be made.\r\n   */\r\n  public move(pos: Vector, duration: number, easingFn: EasingFunction = EasingFunctions.EaseInOutCubic): Promise<Vector> {\r\n    if (typeof easingFn !== 'function') {\r\n      throw 'Please specify an EasingFunction';\r\n    }\r\n\r\n    // cannot move when following an actor\r\n    if (this._follow) {\r\n      return Promise.reject(pos);\r\n    }\r\n\r\n    // resolve existing promise, if any\r\n    if (this._lerpPromise && this._lerpResolve) {\r\n      this._lerpResolve(pos);\r\n    }\r\n\r\n    this._lerpPromise = new Promise<Vector>((resolve) => {\r\n      this._lerpResolve = resolve;\r\n    });\r\n    this._lerpStart = this.getFocus().clone();\r\n    this._lerpDuration = duration;\r\n    this._lerpEnd = pos;\r\n    this._currentLerpTime = 0;\r\n    this._cameraMoving = true;\r\n    this._easing = easingFn;\r\n\r\n    return this._lerpPromise;\r\n  }\r\n\r\n  /**\r\n   * Sets the camera to shake at the specified magnitudes for the specified duration\r\n   * @param magnitudeX  The x magnitude of the shake\r\n   * @param magnitudeY  The y magnitude of the shake\r\n   * @param duration    The duration of the shake in milliseconds\r\n   */\r\n  public shake(magnitudeX: number, magnitudeY: number, duration: number) {\r\n    this._isShaking = true;\r\n    this._shakeMagnitudeX = magnitudeX;\r\n    this._shakeMagnitudeY = magnitudeY;\r\n    this._shakeDuration = duration;\r\n  }\r\n\r\n  /**\r\n   * Zooms the camera in or out by the specified scale over the specified duration.\r\n   * If no duration is specified, it take effect immediately.\r\n   * @param scale    The scale of the zoom\r\n   * @param duration The duration of the zoom in milliseconds\r\n   */\r\n  public zoomOverTime(scale: number, duration: number = 0, easingFn: EasingFunction = EasingFunctions.EaseInOutCubic): Promise<boolean> {\r\n    this._zoomPromise = new Promise<boolean>((resolve) => {\r\n      this._zoomResolve = resolve;\r\n    });\r\n\r\n    if (duration) {\r\n      this._isZooming = true;\r\n      this._zoomEasing = easingFn;\r\n      this._currentZoomTime = 0;\r\n      this._zoomDuration = duration;\r\n      this._zoomStart = this.zoom;\r\n      this._zoomEnd = scale;\r\n    } else {\r\n      this._isZooming = false;\r\n      this.zoom = scale;\r\n      return Promise.resolve(true);\r\n    }\r\n\r\n    return this._zoomPromise;\r\n  }\r\n\r\n  private _viewport: BoundingBox = null;\r\n  /**\r\n   * Gets the bounding box of the viewport of this camera in world coordinates\r\n   */\r\n  public get viewport(): BoundingBox {\r\n    if (this._viewport) {\r\n      return this._viewport;\r\n    }\r\n\r\n    return new BoundingBox(0, 0, 0, 0);\r\n  }\r\n\r\n  /**\r\n   * Adds a new camera strategy to this camera\r\n   * @param cameraStrategy Instance of an [[CameraStrategy]]\r\n   */\r\n  public addStrategy<T>(cameraStrategy: CameraStrategy<T>) {\r\n    this._cameraStrategies.push(cameraStrategy);\r\n  }\r\n\r\n  /**\r\n   * Removes a camera strategy by reference\r\n   * @param cameraStrategy Instance of an [[CameraStrategy]]\r\n   */\r\n  public removeStrategy<T>(cameraStrategy: CameraStrategy<T>) {\r\n    removeItemFromArray(cameraStrategy, this._cameraStrategies);\r\n  }\r\n\r\n  /**\r\n   * Clears all camera strategies from the camera\r\n   */\r\n  public clearAllStrategies() {\r\n    this._cameraStrategies.length = 0;\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for [[onPreUpdate]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _preupdate(engine: Engine, delta: number): void {\r\n    this.emit('preupdate', new PreUpdateEvent(engine, delta, this));\r\n    this.onPreUpdate(engine, delta);\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPreUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPreUpdate` is called directly before a scene is updated.\r\n   */\r\n  public onPreUpdate(_engine: Engine, _delta: number): void {\r\n    // Overridable\r\n  }\r\n\r\n  /**\r\n   *  It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for [[onPostUpdate]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _postupdate(engine: Engine, delta: number): void {\r\n    this.emit('postupdate', new PostUpdateEvent(engine, delta, this));\r\n    this.onPostUpdate(engine, delta);\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPostUpdate` is called directly after a scene is updated.\r\n   */\r\n  public onPostUpdate(_engine: Engine, _delta: number): void {\r\n    // Overridable\r\n  }\r\n\r\n  private _engine: Engine;\r\n  private _screen: Screen;\r\n  private _isInitialized = false;\r\n  public get isInitialized() {\r\n    return this._isInitialized;\r\n  }\r\n\r\n  public _initialize(_engine: Engine) {\r\n    if (!this.isInitialized) {\r\n      this._engine = _engine;\r\n      this._screen = _engine.screen;\r\n\r\n      const currentRes = this._screen.resolution;\r\n      let center = vec(currentRes.width / 2, currentRes.height / 2);\r\n      if (!this._engine.loadingComplete) {\r\n        // If there was a loading screen, we peek the configured resolution\r\n        const res = this._screen.peekResolution();\r\n        if (res) {\r\n          center = vec(res.width / 2, res.height / 2);\r\n        }\r\n      }\r\n      this._halfWidth = center.x;\r\n      this._halfHeight = center.y;\r\n\r\n      // If the user has not set the camera pos, apply default center screen position\r\n      if (!this._posChanged) {\r\n        this.pos = center;\r\n      }\r\n      // First frame bootstrap\r\n\r\n      // Ensure camera tx is correct\r\n      // Run update twice to ensure properties are init'd\r\n      this.updateTransform();\r\n\r\n      // Run strategies for first frame\r\n      this.runStrategies(_engine, _engine.clock.elapsed());\r\n\r\n      // Setup the first frame viewport\r\n      this.updateViewport();\r\n\r\n      // It's important to update the camera after strategies\r\n      // This prevents jitter\r\n      this.updateTransform();\r\n\r\n      this.onInitialize(_engine);\r\n      super.emit('initialize', new InitializeEvent(_engine, this));\r\n      this._isInitialized = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPostUpdate` is called directly after a scene is updated.\r\n   */\r\n  public onInitialize(_engine: Engine) {\r\n    // Overridable\r\n  }\r\n\r\n  public on(eventName: 'initialize', handler: (event: InitializeEvent) => void): void;\r\n  public on(eventName: 'preupdate', handler: (event: PreUpdateEvent) => void): void;\r\n  public on(eventName: 'postupdate', handler: (event: PostUpdateEvent) => void): void;\r\n  public on(eventName: any, handler: any) {\r\n    super.on(eventName, handler);\r\n  }\r\n\r\n  public off(eventName: 'initialize', handler?: (event: InitializeEvent) => void): void;\r\n  public off(eventName: 'preupdate', handler?: (event: PreUpdateEvent) => void): void;\r\n  public off(eventName: 'postupdate', handler?: (event: PostUpdateEvent) => void): void;\r\n  public off(eventName: string, handler: (event: GameEvent<Camera>) => void): void;\r\n  public off(eventName: string, handler: (event: any) => void): void {\r\n    super.off(eventName, handler);\r\n  }\r\n\r\n  public once(eventName: 'initialize', handler: (event: InitializeEvent) => void): void;\r\n  public once(eventName: 'preupdate', handler: (event: PreUpdateEvent) => void): void;\r\n  public once(eventName: 'postupdate', handler: (event: PostUpdateEvent) => void): void;\r\n  public once(eventName: string, handler: (event: GameEvent<Camera>) => void): void;\r\n  public once(eventName: string, handler: (event: any) => void): void {\r\n    super.once(eventName, handler);\r\n  }\r\n\r\n  public runStrategies(engine: Engine, delta: number) {\r\n    for (const s of this._cameraStrategies) {\r\n      this.pos = s.action.call(s, s.target, this, engine, delta);\r\n    }\r\n  }\r\n\r\n  public updateViewport() {\r\n    // recalc viewport\r\n    this._viewport = new BoundingBox(\r\n      this.x - this._halfWidth,\r\n      this.y - this._halfHeight,\r\n      this.x + this._halfWidth,\r\n      this.y + this._halfHeight\r\n    );\r\n  }\r\n\r\n  public update(_engine: Engine, delta: number) {\r\n    this._initialize(_engine);\r\n    this._preupdate(_engine, delta);\r\n\r\n    // Update placements based on linear algebra\r\n    this.pos = this.pos.add(this.vel.scale(delta / 1000));\r\n    this.zoom += (this.dz * delta) / 1000;\r\n\r\n    this.vel = this.vel.add(this.acc.scale(delta / 1000));\r\n    this.dz += (this.az * delta) / 1000;\r\n\r\n    this.rotation += (this.angularVelocity * delta) / 1000;\r\n\r\n    if (this._isZooming) {\r\n      if (this._currentZoomTime < this._zoomDuration) {\r\n        const zoomEasing = this._zoomEasing;\r\n        const newZoom = zoomEasing(this._currentZoomTime, this._zoomStart, this._zoomEnd, this._zoomDuration);\r\n\r\n        this.zoom = newZoom;\r\n        this._currentZoomTime += delta;\r\n      } else {\r\n        this._isZooming = false;\r\n        this.zoom = this._zoomEnd;\r\n        this._currentZoomTime = 0;\r\n        this._zoomResolve(true);\r\n      }\r\n    }\r\n\r\n    if (this._cameraMoving) {\r\n      if (this._currentLerpTime < this._lerpDuration) {\r\n        const moveEasing = EasingFunctions.CreateVectorEasingFunction(this._easing);\r\n\r\n        const lerpPoint = moveEasing(this._currentLerpTime, this._lerpStart, this._lerpEnd, this._lerpDuration);\r\n\r\n        this.pos = lerpPoint;\r\n\r\n        this._currentLerpTime += delta;\r\n      } else {\r\n        this.pos = this._lerpEnd;\r\n        const end = this._lerpEnd.clone();\r\n\r\n        this._lerpStart = null;\r\n        this._lerpEnd = null;\r\n        this._currentLerpTime = 0;\r\n        this._cameraMoving = false;\r\n        // Order matters here, resolve should be last so any chain promises have a clean slate\r\n        this._lerpResolve(end);\r\n      }\r\n    }\r\n\r\n    if (this._isDoneShaking()) {\r\n      this._isShaking = false;\r\n      this._elapsedShakeTime = 0;\r\n      this._shakeMagnitudeX = 0;\r\n      this._shakeMagnitudeY = 0;\r\n      this._shakeDuration = 0;\r\n      this._xShake = 0;\r\n      this._yShake = 0;\r\n    } else {\r\n      this._elapsedShakeTime += delta;\r\n      this._xShake = ((Math.random() * this._shakeMagnitudeX) | 0) + 1;\r\n      this._yShake = ((Math.random() * this._shakeMagnitudeY) | 0) + 1;\r\n    }\r\n\r\n    this.runStrategies(_engine, delta);\r\n\r\n    this.updateViewport();\r\n\r\n    // It's important to update the camera after strategies\r\n    // This prevents jitter\r\n    this.updateTransform();\r\n\r\n    this._postupdate(_engine, delta);\r\n  }\r\n\r\n  /**\r\n   * Applies the relevant transformations to the game canvas to \"move\" or apply effects to the Camera\r\n   * @param ctx Canvas context to apply transformations\r\n   */\r\n  public draw(ctx: ExcaliburGraphicsContext): void {\r\n    ctx.multiply(this.transform);\r\n  }\r\n\r\n  public updateTransform() {\r\n    // center the camera\r\n    const newCanvasWidth = this._screen.resolution.width / this.zoom;\r\n    const newCanvasHeight = this._screen.resolution.height / this.zoom;\r\n    const cameraPos = vec(-this.x + newCanvasWidth / 2 + this._xShake, -this.y + newCanvasHeight / 2 + this._yShake);\r\n\r\n    // Calculate camera transform\r\n    this.transform.reset();\r\n    this.transform.scale(this.zoom, this.zoom);\r\n    this.transform.translate(cameraPos.x, cameraPos.y);\r\n    this.transform.inverse(this.inverse);\r\n  }\r\n\r\n  private _isDoneShaking(): boolean {\r\n    return !this._isShaking || this._elapsedShakeTime >= this._shakeDuration;\r\n  }\r\n}\r\n","import { Component, ComponentCtor, TagComponent } from './Component';\r\n\r\nimport { Observable, Message } from '../Util/Observable';\r\nimport { Class } from '../Class';\r\nimport { OnInitialize, OnPreUpdate, OnPostUpdate } from '../Interfaces/LifecycleEvents';\r\nimport { Engine } from '../Engine';\r\nimport { InitializeEvent, PreUpdateEvent, PostUpdateEvent } from '../Events';\r\nimport { EventDispatcher } from '../EventDispatcher';\r\nimport { Util } from '..';\r\n\r\n/**\r\n * Interface holding an entity component pair\r\n */\r\nexport interface EntityComponent {\r\n  component: Component;\r\n  entity: Entity;\r\n}\r\n\r\n/**\r\n * AddedComponent message\r\n */\r\nexport class AddedComponent implements Message<EntityComponent> {\r\n  readonly type: 'Component Added' = 'Component Added';\r\n  constructor(public data: EntityComponent) {}\r\n}\r\n\r\n/**\r\n * Type guard to know if message is f an Added Component\r\n */\r\nexport function isAddedComponent(x: Message<EntityComponent>): x is AddedComponent {\r\n  return !!x && x.type === 'Component Added';\r\n}\r\n\r\n/**\r\n * RemovedComponent message\r\n */\r\nexport class RemovedComponent implements Message<EntityComponent> {\r\n  readonly type: 'Component Removed' = 'Component Removed';\r\n  constructor(public data: EntityComponent) {}\r\n}\r\n\r\n/**\r\n * Type guard to know if message is for a Removed Component\r\n */\r\nexport function isRemovedComponent(x: Message<EntityComponent>): x is RemovedComponent {\r\n  return !!x && x.type === 'Component Removed';\r\n}\r\n\r\n/**\r\n * An Entity is the base type of anything that can have behavior in Excalibur, they are part of the built in entity component system\r\n *\r\n * Entities can be strongly typed with the components they contain\r\n *\r\n * ```typescript\r\n * const entity = new Entity<ComponentA | ComponentB>();\r\n * entity.components.a; // Type ComponentA\r\n * entity.components.b; // Type ComponentB\r\n * ```\r\n */\r\nexport class Entity extends Class implements OnInitialize, OnPreUpdate, OnPostUpdate {\r\n  private static _ID = 0;\r\n\r\n  constructor(components?: Component[], name?: string) {\r\n    super();\r\n    this._setName(name);\r\n    if (components) {\r\n      for (const component of components) {\r\n        this.addComponent(component);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * The unique identifier for the entity\r\n   */\r\n  public id: number = Entity._ID++;\r\n\r\n  private _name: string = 'anonymous';\r\n  protected _setName(name: string) {\r\n    if (name) {\r\n      this._name = name;\r\n    }\r\n  }\r\n  public get name(): string {\r\n    return this._name;\r\n  }\r\n\r\n  public get events(): EventDispatcher {\r\n    return this.eventDispatcher;\r\n  }\r\n\r\n  /**\r\n   * Whether this entity is active, if set to false it will be reclaimed\r\n   */\r\n  public active: boolean = true;\r\n\r\n  /**\r\n   * Kill the entity, means it will no longer be updated. Kills are deferred to the end of the update.\r\n   */\r\n  public kill() {\r\n    this.active = false;\r\n  }\r\n\r\n  public isKilled() {\r\n    return !this.active;\r\n  }\r\n\r\n  /**\r\n   * Specifically get the tags on the entity from [[TagComponent]]\r\n   */\r\n  public get tags(): readonly string[] {\r\n    return this._tagsMemo;\r\n  }\r\n\r\n  /**\r\n   * Check if a tag exists on the entity\r\n   * @param tag name to check for\r\n   */\r\n  public hasTag(tag: string): boolean {\r\n    return this.tags.includes(tag);\r\n  }\r\n\r\n  /**\r\n   * Adds a tag to an entity\r\n   * @param tag\r\n   * @returns Entity\r\n   */\r\n  public addTag(tag: string) {\r\n    return this.addComponent(new TagComponent(tag));\r\n  }\r\n\r\n  /**\r\n   * Removes a tag on the entity\r\n   *\r\n   * Removals are deferred until the end of update\r\n   * @param tag\r\n   * @param force Remove component immediately, no deferred\r\n   */\r\n  public removeTag(tag: string, force = false) {\r\n    return this.removeComponent(tag, force);\r\n  }\r\n\r\n  /**\r\n   * The types of the components on the Entity\r\n   */\r\n  public get types(): string[] {\r\n    return this._typesMemo;\r\n  }\r\n\r\n  /**\r\n   * Bucket to hold on to deferred removals\r\n   */\r\n  private _componentsToRemove: (Component | string)[] = [];\r\n  private _componentTypeToInstance = new Map<ComponentCtor, Component>();\r\n  private _componentStringToInstance = new Map<string, Component>();\r\n\r\n  private _tagsMemo: string[] = [];\r\n  private _typesMemo: string[] = [];\r\n  private _rebuildMemos() {\r\n    this._tagsMemo = Array.from(this._componentStringToInstance.values())\r\n      .filter((c) => c instanceof TagComponent)\r\n      .map((c) => c.type);\r\n    this._typesMemo = Array.from(this._componentStringToInstance.keys());\r\n  }\r\n\r\n  public getComponents(): Component[] {\r\n    return Array.from(this._componentStringToInstance.values());\r\n  }\r\n\r\n  /**\r\n   * Observable that keeps track of component add or remove changes on the entity\r\n   */\r\n  public componentAdded$ = new Observable<AddedComponent>();\r\n  private _notifyAddComponent(component: Component) {\r\n    this._rebuildMemos();\r\n    const added = new AddedComponent({\r\n      component,\r\n      entity: this\r\n    });\r\n    this.componentAdded$.notifyAll(added);\r\n  }\r\n\r\n  public componentRemoved$ = new Observable<RemovedComponent>();\r\n  private _notifyRemoveComponent(component: Component) {\r\n    const removed = new RemovedComponent({\r\n      component,\r\n      entity: this\r\n    });\r\n    this.componentRemoved$.notifyAll(removed);\r\n    this._rebuildMemos();\r\n  }\r\n\r\n  private _parent: Entity = null;\r\n  public get parent(): Entity {\r\n    return this._parent;\r\n  }\r\n\r\n  public childrenAdded$ = new Observable<Entity>();\r\n  public childrenRemoved$ = new Observable<Entity>();\r\n\r\n  private _children: Entity[] = [];\r\n  /**\r\n   * Get the direct children of this entity\r\n   */\r\n  public get children(): readonly Entity[] {\r\n    return this._children;\r\n  }\r\n\r\n  /**\r\n   * Unparents this entity, if there is a parent. Otherwise it does nothing.\r\n   */\r\n  public unparent() {\r\n    if (this._parent) {\r\n      this._parent.removeChild(this);\r\n      this._parent = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adds an entity to be a child of this entity\r\n   * @param entity\r\n   */\r\n  public addChild(entity: Entity): Entity {\r\n    if (entity.parent === null) {\r\n      if (this.getAncestors().includes(entity)) {\r\n        throw new Error('Cycle detected, cannot add entity');\r\n      }\r\n      this._children.push(entity);\r\n      entity._parent = this;\r\n      this.childrenAdded$.notifyAll(entity);\r\n    } else {\r\n      throw new Error('Entity already has a parent, cannot add without unparenting');\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Remove an entity from children if it exists\r\n   * @param entity\r\n   */\r\n  public removeChild(entity: Entity): Entity {\r\n    if (entity.parent === this) {\r\n      Util.removeItemFromArray(entity, this._children);\r\n      entity._parent = null;\r\n      this.childrenRemoved$.notifyAll(entity);\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Removes all children from this entity\r\n   */\r\n  public removeAllChildren(): Entity {\r\n    this.children.forEach((c) => {\r\n      this.removeChild(c);\r\n    });\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Returns a list of parent entities starting with the topmost parent. Includes the current entity.\r\n   */\r\n  public getAncestors(): Entity[] {\r\n    const result: Entity[] = [this];\r\n    let current = this.parent;\r\n    while (current) {\r\n      result.push(current);\r\n      current = current.parent;\r\n    }\r\n    return result.reverse();\r\n  }\r\n\r\n  /**\r\n   * Returns a list of all the entities that descend from this entity. Includes the current entity.\r\n   */\r\n  public getDescendants(): Entity[] {\r\n    let result: Entity[] = [this];\r\n    let queue: Entity[] = [this];\r\n    while (queue.length > 0) {\r\n      const curr = queue.pop();\r\n      queue = queue.concat(curr.children);\r\n      result = result.concat(curr.children);\r\n    }\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Creates a deep copy of the entity and a copy of all its components\r\n   */\r\n  public clone(): Entity {\r\n    const newEntity = new Entity();\r\n    for (const c of this.types) {\r\n      newEntity.addComponent(this.get(c).clone());\r\n    }\r\n    for (const child of this.children) {\r\n      newEntity.addChild(child.clone());\r\n    }\r\n    return newEntity;\r\n  }\r\n\r\n  /**\r\n   * Adds a copy of all the components from another template entity as a \"prefab\"\r\n   * @param templateEntity Entity to use as a template\r\n   * @param force Force component replacement if it already exists on the target entity\r\n   */\r\n  public addTemplate(templateEntity: Entity, force: boolean = false): Entity {\r\n    for (const c of templateEntity.getComponents()) {\r\n      this.addComponent(c.clone(), force);\r\n    }\r\n    for (const child of templateEntity.children) {\r\n      this.addChild(child.clone().addTemplate(child));\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Adds a component to the entity\r\n   * @param component Component or Entity to add copy of components from\r\n   * @param force Optionally overwrite any existing components of the same type\r\n   */\r\n  public addComponent<T extends Component>(component: T, force: boolean = false): Entity {\r\n    // if component already exists, skip if not forced\r\n    if (this.has(component.type)) {\r\n      if (force) {\r\n        // Remove existing component type if exists when forced\r\n        this.removeComponent(component);\r\n      } else {\r\n        // early exit component exits\r\n        return this;\r\n      }\r\n    }\r\n\r\n    // TODO circular dependencies will be a problem\r\n    if (component.dependencies && component.dependencies.length) {\r\n      for (const ctor of component.dependencies) {\r\n        this.addComponent(new ctor());\r\n      }\r\n    }\r\n\r\n    component.owner = this;\r\n    const constuctorType = component.constructor as ComponentCtor<T>;\r\n    this._componentTypeToInstance.set(constuctorType, component);\r\n    this._componentStringToInstance.set(component.type, component);\r\n    if (component.onAdd) {\r\n      component.onAdd(this);\r\n    }\r\n    this._notifyAddComponent(component);\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Removes a component from the entity, by default removals are deferred to the end of entity update to avoid consistency issues\r\n   *\r\n   * Components can be force removed with the `force` flag, the removal is not deferred and happens immediately\r\n   * @param componentOrType\r\n   * @param force\r\n   */\r\n  public removeComponent<ComponentOrType extends string | Component>(componentOrType: ComponentOrType, force = false): Entity {\r\n    if (force) {\r\n      if (typeof componentOrType === 'string') {\r\n        this._removeComponentByType(componentOrType);\r\n      } else if (componentOrType instanceof Component) {\r\n        this._removeComponentByType(componentOrType.type);\r\n      }\r\n    } else {\r\n      this._componentsToRemove.push(componentOrType);\r\n    }\r\n\r\n    return this as any;\r\n  }\r\n\r\n  private _removeComponentByType(type: string) {\r\n    if (this.has(type)) {\r\n      const component = this.get(type);\r\n      component.owner = null;\r\n      if (component.onRemove) {\r\n        component.onRemove(this);\r\n      }\r\n      const ctor = component.constructor as ComponentCtor;\r\n      this._componentTypeToInstance.delete(ctor);\r\n      this._componentStringToInstance.delete(component.type);\r\n      this._notifyRemoveComponent(component);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @hidden\r\n   * @internal\r\n   */\r\n  public processComponentRemoval() {\r\n    for (const componentOrType of this._componentsToRemove) {\r\n      const type = typeof componentOrType === 'string' ? componentOrType : componentOrType.type;\r\n      this._removeComponentByType(type);\r\n    }\r\n    this._componentsToRemove.length = 0;\r\n  }\r\n\r\n  /**\r\n   * Check if a component type exists\r\n   * @param type\r\n   */\r\n  public has<T extends Component>(type: ComponentCtor<T>): boolean;\r\n  public has(type: string): boolean;\r\n  public has<T extends Component>(type: ComponentCtor<T> | string): boolean {\r\n    if (typeof type === 'string') {\r\n      return this._componentStringToInstance.has(type);\r\n    } else {\r\n      return this._componentTypeToInstance.has(type);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get a component by type with typecheck\r\n   *\r\n   * (Does not work on tag components, use .hasTag(\"mytag\") instead)\r\n   * @param type\r\n   */\r\n  public get<T extends Component>(type: ComponentCtor<T>): T | null;\r\n  public get<T extends Component>(type: string): T | null;\r\n  public get<T extends Component>(type: ComponentCtor<T> | string): T | null {\r\n    if (typeof type === 'string') {\r\n      return this._componentStringToInstance.get(type) as T;\r\n    } else {\r\n      return this._componentTypeToInstance.get(type) as T;\r\n    }\r\n  }\r\n\r\n  private _isInitialized = false;\r\n\r\n  /**\r\n   * Gets whether the actor is Initialized\r\n   */\r\n  public get isInitialized(): boolean {\r\n    return this._isInitialized;\r\n  }\r\n\r\n  /**\r\n   * Initializes this entity, meant to be called by the Scene before first update not by users of Excalibur.\r\n   *\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * @internal\r\n   */\r\n  public _initialize(engine: Engine) {\r\n    if (!this.isInitialized) {\r\n      this.onInitialize(engine);\r\n      super.emit('initialize', new InitializeEvent(engine, this));\r\n      this._isInitialized = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for [[onPreUpdate]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _preupdate(engine: Engine, delta: number): void {\r\n    this.emit('preupdate', new PreUpdateEvent(engine, delta, this));\r\n    this.onPreUpdate(engine, delta);\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for [[onPostUpdate]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _postupdate(engine: Engine, delta: number): void {\r\n    this.emit('postupdate', new PostUpdateEvent(engine, delta, this));\r\n    this.onPostUpdate(engine, delta);\r\n  }\r\n\r\n  /**\r\n   * `onInitialize` is called before the first update of the entity. This method is meant to be\r\n   * overridden.\r\n   *\r\n   * Synonymous with the event handler `.on('initialize', (evt) => {...})`\r\n   */\r\n  public onInitialize(_engine: Engine): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPreUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPreUpdate` is called directly before an entity is updated.\r\n   */\r\n  public onPreUpdate(_engine: Engine, _delta: number): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostUpdate lifecycle event handler. Synonymous with `.on('postupdate', (evt) =>{...})`\r\n   *\r\n   * `onPostUpdate` is called directly after an entity is updated.\r\n   */\r\n  public onPostUpdate(_engine: Engine, _delta: number): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   *\r\n   * Entity update lifecycle, called internally\r\n   *\r\n   * @internal\r\n   * @param engine\r\n   * @param delta\r\n   */\r\n  public update(engine: Engine, delta: number): void {\r\n    this._initialize(engine);\r\n    this._preupdate(engine, delta);\r\n    for (const child of this.children) {\r\n      child.update(engine, delta);\r\n    }\r\n    this._postupdate(engine, delta);\r\n  }\r\n}\r\n","import { Vector, vec } from '../Math/vector';\r\nimport { Graphic } from './Graphic';\r\nimport { HasTick } from './Animation';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { Logger } from '../Util/Log';\r\nimport { BoundingBox } from '../Collision/Index';\r\nimport { Component } from '../EntityComponentSystem/Component';\r\n\r\n/**\r\n * Type guard for checking if a Graphic HasTick (used for graphics that change over time like animations)\r\n * @param graphic\r\n */\r\nexport function hasGraphicsTick(graphic: Graphic): graphic is Graphic & HasTick {\r\n  return !!(graphic as unknown as HasTick).tick;\r\n}\r\nexport interface GraphicsShowOptions {\r\n  offset?: Vector;\r\n  anchor?: Vector;\r\n}\r\n\r\nexport interface GraphicsComponentOptions {\r\n  onPostDraw?: (ex: ExcaliburGraphicsContext, elapsed: number) => void;\r\n  onPreDraw?: (ex: ExcaliburGraphicsContext, elapsed: number) => void;\r\n\r\n  /**\r\n   * Name of current graphic to use\r\n   */\r\n  current?: string;\r\n\r\n  /**\r\n   * Optionally copy instances of graphics by calling .clone(), you may set this to false to avoid sharing graphics when added to the\r\n   * component for performance reasons. By default graphics are not copied and are shared when added to the component.\r\n   */\r\n  copyGraphics?: boolean;\r\n\r\n  /**\r\n   * Optional visible flag, if the graphics component is not visible it will not be displayed\r\n   */\r\n  visible?: boolean;\r\n\r\n  /**\r\n   * Optional opacity\r\n   */\r\n  opacity?: number;\r\n\r\n  /**\r\n   * List of graphics\r\n   */\r\n  graphics?: { [graphicName: string]: Graphic };\r\n\r\n  /**\r\n   * Optional offset in absolute pixels to shift all graphics in this component from each graphic's anchor (default is top left corner)\r\n   */\r\n  offset?: Vector;\r\n\r\n  /**\r\n   * Optional anchor\r\n   */\r\n  anchor?: Vector;\r\n}\r\n\r\nexport interface GraphicsLayerOptions {\r\n  /**\r\n   * Name of the layer required, for example 'background'\r\n   */\r\n  name: string;\r\n  /**\r\n   * Order of the layer, a layer with order -1 will be below a layer with order of 1\r\n   */\r\n  order: number;\r\n  /**\r\n   * Offset to shift the entire layer\r\n   */\r\n  offset?: Vector;\r\n}\r\nexport class GraphicsLayer {\r\n  public graphics: { graphic: Graphic; options: GraphicsShowOptions }[] = [];\r\n  constructor(private _options: GraphicsLayerOptions, private _graphics: GraphicsComponent) {}\r\n  public get name(): string {\r\n    return this._options.name;\r\n  }\r\n\r\n  /**\r\n   * Remove any instance(s) of a graphic currently being shown in this layer\r\n   */\r\n  public hide(nameOrGraphic: string | Graphic): void;\r\n  /**\r\n   * Remove all currently shown graphics in this layer\r\n   */\r\n  public hide(): void;\r\n  public hide(nameOrGraphic?: string | Graphic): void {\r\n    if (!nameOrGraphic) {\r\n      this.graphics.length = 0;\r\n    } else {\r\n      let gfx: Graphic = null;\r\n      if (nameOrGraphic instanceof Graphic) {\r\n        gfx = nameOrGraphic;\r\n      } else {\r\n        gfx = this._graphics.getGraphic(nameOrGraphic);\r\n      }\r\n      this.graphics = this.graphics.filter((g) => g.graphic !== gfx);\r\n      this._graphics.recalculateBounds();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Show a graphic by name or instance at an offset, graphics are shown in the order in which `show()` is called.\r\n   *\r\n   * If `show()` is called multiple times for the same graphic it will be shown multiple times.\r\n   * @param nameOrGraphic\r\n   * @param options\r\n   */\r\n  public show<T extends Graphic = Graphic>(nameOrGraphic: string | T, options?: GraphicsShowOptions): T {\r\n    options = { ...options };\r\n    let gfx: Graphic;\r\n    if (nameOrGraphic instanceof Graphic) {\r\n      gfx = this._graphics.copyGraphics ? nameOrGraphic.clone() : nameOrGraphic;\r\n    } else {\r\n      gfx = this._graphics.getGraphic(nameOrGraphic);\r\n      if (!gfx) {\r\n        Logger.getInstance().error(\r\n          `No such graphic added to component named ${nameOrGraphic}. These named graphics are available: `,\r\n          this._graphics.getNames()\r\n        );\r\n      }\r\n    }\r\n    if (gfx) {\r\n      this.graphics.push({ graphic: gfx, options });\r\n      this._graphics.recalculateBounds();\r\n      return gfx as T;\r\n    } else {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Use a specific graphic, swap out any current graphics being shown\r\n   * @param nameOrGraphic\r\n   * @param options\r\n   */\r\n  public use<T extends Graphic = Graphic>(nameOrGraphic: string | T, options?: GraphicsShowOptions): T {\r\n    options = { ...options };\r\n    this.hide();\r\n    return this.show<T>(nameOrGraphic, options);\r\n  }\r\n\r\n  /**\r\n   * Current order of the layer, higher numbers are on top, lower numbers are on the bottom.\r\n   *\r\n   * For example a layer with `order = -1` would be under a layer of `order = 1`\r\n   */\r\n  public get order(): number {\r\n    return this._options.order;\r\n  }\r\n\r\n  /**\r\n   * Set the order of the layer, higher numbers are on top, lower numbers are on the bottom.\r\n   *\r\n   * For example a layer with `order = -1` would be under a layer of `order = 1`\r\n   */\r\n  public set order(order: number) {\r\n    this._options.order = order;\r\n  }\r\n\r\n  /**\r\n   * Get or set the pixel offset from the layer anchor for all graphics in the layer\r\n   */\r\n  public get offset(): Vector {\r\n    return this._options.offset ?? Vector.Zero;\r\n  }\r\n\r\n  public set offset(value: Vector) {\r\n    this._options.offset = value;\r\n  }\r\n\r\n  public get currentKeys(): string {\r\n    return this.name ?? 'anonymous';\r\n  }\r\n}\r\n\r\nexport class GraphicsLayers {\r\n  private _layers: GraphicsLayer[] = [];\r\n  private _layerMap: { [layerName: string]: GraphicsLayer } = {};\r\n  public default: GraphicsLayer;\r\n  constructor(private _component: GraphicsComponent) {\r\n    this.default = new GraphicsLayer({ name: 'default', order: 0 }, _component);\r\n    this._maybeAddLayer(this.default);\r\n  }\r\n  public create(options: GraphicsLayerOptions): GraphicsLayer {\r\n    const layer = new GraphicsLayer(options, this._component);\r\n    return this._maybeAddLayer(layer);\r\n  }\r\n\r\n  /**\r\n   * Retrieve a single layer by name\r\n   * @param name\r\n   */\r\n  public get(name: string): GraphicsLayer;\r\n  /**\r\n   * Retrieve all layers\r\n   */\r\n  public get(): readonly GraphicsLayer[];\r\n  public get(name?: string): GraphicsLayer | readonly GraphicsLayer[] {\r\n    if (name) {\r\n      return this._getLayer(name);\r\n    }\r\n    return this._layers;\r\n  }\r\n\r\n  public currentKeys() {\r\n    const graphicsLayerKeys = [];\r\n    for (const layer of this._layers) {\r\n      graphicsLayerKeys.push(layer.currentKeys);\r\n    }\r\n    return graphicsLayerKeys;\r\n  }\r\n\r\n  public has(name: string): boolean {\r\n    return name in this._layerMap;\r\n  }\r\n\r\n  private _maybeAddLayer(layer: GraphicsLayer) {\r\n    if (this._layerMap[layer.name]) {\r\n      // todo log warning\r\n      return this._layerMap[layer.name];\r\n    }\r\n    this._layerMap[layer.name] = layer;\r\n    this._layers.push(layer);\r\n    this._layers.sort((a, b) => a.order - b.order);\r\n    return layer;\r\n  }\r\n\r\n  private _getLayer(name: string): GraphicsLayer | undefined {\r\n    return this._layerMap[name];\r\n  }\r\n}\r\n\r\n/**\r\n * Component to manage drawings, using with the position component\r\n */\r\nexport class GraphicsComponent extends Component<'ex.graphics'> {\r\n  readonly type = 'ex.graphics';\r\n\r\n  private _graphics: { [graphicName: string]: Graphic } = {};\r\n\r\n  public layers: GraphicsLayers;\r\n\r\n  public getGraphic(name: string): Graphic | undefined {\r\n    return this._graphics[name];\r\n  }\r\n\r\n  /**\r\n   * Get registered graphics names\r\n   */\r\n  public getNames(): string[] {\r\n    return Object.keys(this._graphics);\r\n  }\r\n\r\n  /**\r\n   * Draws after the entity transform has bene applied, but before graphics component graphics have been drawn\r\n   */\r\n  public onPreDraw: (ctx: ExcaliburGraphicsContext, elapsedMilliseconds: number) => void;\r\n\r\n  /**\r\n   * Draws after the entity transform has been applied, and after graphics component graphics has been drawn\r\n   */\r\n  public onPostDraw: (ctx: ExcaliburGraphicsContext, elapsedMilliseconds: number) => void;\r\n\r\n  /**\r\n   * Sets or gets wether any drawing should be visible in this component\r\n   */\r\n  public visible: boolean = true;\r\n\r\n  /**\r\n   * Sets or gets wither all drawings should have an opacity applied\r\n   */\r\n  public opacity: number = 1;\r\n\r\n  /**\r\n   * Offset to apply to graphics by default\r\n   */\r\n  public offset: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * Anchor to apply to graphics by default\r\n   */\r\n  public anchor: Vector = Vector.Half;\r\n\r\n  /**\r\n   * If set to true graphics added to the component will be copied. This can affect performance\r\n   */\r\n  public copyGraphics: boolean = false;\r\n\r\n  constructor(options?: GraphicsComponentOptions) {\r\n    super();\r\n    // Defaults\r\n    options = {\r\n      visible: this.visible,\r\n      ...options\r\n    };\r\n\r\n    const { current, anchor, opacity, visible, graphics, offset, copyGraphics, onPreDraw, onPostDraw } = options;\r\n\r\n    this._graphics = graphics || {};\r\n    this.offset = offset ?? this.offset;\r\n    this.opacity = opacity ?? this.opacity;\r\n    this.anchor = anchor ?? this.anchor;\r\n    this.copyGraphics = copyGraphics ?? this.copyGraphics;\r\n    this.onPreDraw = onPreDraw ?? this.onPreDraw;\r\n    this.onPostDraw = onPostDraw ?? this.onPostDraw;\r\n    this.visible = !!visible;\r\n\r\n    this.layers = new GraphicsLayers(this);\r\n    if (current && this._graphics[current]) {\r\n      this.show(this._graphics[current]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns the currently displayed graphics and their offsets, empty array if hidden\r\n   */\r\n  public get current(): { graphic: Graphic; options: GraphicsShowOptions }[] {\r\n    return this.layers.default.graphics;\r\n  }\r\n\r\n  /**\r\n   * Returns all graphics associated with this component\r\n   */\r\n  public get graphics(): { [graphicName: string]: Graphic } {\r\n    return this._graphics;\r\n  }\r\n\r\n  /**\r\n   * Adds a named graphic to this component, if the name is \"default\" or not specified, it will be shown by default without needing to call\r\n   * `show(\"default\")`\r\n   * @param graphic\r\n   */\r\n  public add(graphic: Graphic): Graphic;\r\n  public add(name: string, graphic: Graphic): Graphic;\r\n  public add(nameOrGraphic: string | Graphic, graphic?: Graphic): Graphic {\r\n    let name = 'default';\r\n    let graphicToSet: Graphic = null;\r\n    if (typeof nameOrGraphic === 'string') {\r\n      name = nameOrGraphic;\r\n      graphicToSet = graphic;\r\n    } else {\r\n      graphicToSet = nameOrGraphic;\r\n    }\r\n\r\n    this._graphics[name] = this.copyGraphics ? graphicToSet.clone() : graphicToSet;\r\n    if (name === 'default') {\r\n      this.show('default');\r\n    }\r\n    return graphicToSet;\r\n  }\r\n\r\n  /**\r\n   * Show a graphic by name on the **default** layer, returns the new [[Graphic]]\r\n   */\r\n  public show<T extends Graphic = Graphic>(nameOrGraphic: string | T, options?: GraphicsShowOptions): T {\r\n    const result = this.layers.default.show<T>(nameOrGraphic, options);\r\n    this.recalculateBounds();\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Use a graphic only, swap out any graphics on the **default** layer, returns the new [[Graphic]]\r\n   * @param nameOrGraphic\r\n   * @param options\r\n   */\r\n  public use<T extends Graphic = Graphic>(nameOrGraphic: string | T, options?: GraphicsShowOptions): T {\r\n    const result = this.layers.default.use<T>(nameOrGraphic, options);\r\n    this.recalculateBounds();\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Remove any instance(s) of a graphic currently being shown in the **default** layer\r\n   */\r\n  public hide(nameOrGraphic: string | Graphic): void;\r\n  /**\r\n   * Remove all currently shown graphics in the **default** layer\r\n   */\r\n  public hide(): void;\r\n  public hide(nameOrGraphic?: string | Graphic): void {\r\n    this.layers.default.hide(nameOrGraphic);\r\n  }\r\n\r\n  private _localBounds: BoundingBox = null;\r\n  public set localBounds(bounds: BoundingBox) {\r\n    this._localBounds = bounds;\r\n  }\r\n\r\n  public recalculateBounds() {\r\n    let bb = new BoundingBox();\r\n    for (const layer of this.layers.get()) {\r\n      for (const { graphic, options } of layer.graphics) {\r\n        let anchor = this.anchor;\r\n        let offset = this.offset;\r\n        if (options?.anchor) {\r\n          anchor = options.anchor;\r\n        }\r\n        if (options?.offset) {\r\n          offset = options.offset;\r\n        }\r\n        const bounds = graphic.localBounds;\r\n        const offsetX = -bounds.width *  anchor.x + offset.x;\r\n        const offsetY = -bounds.height *  anchor.y + offset.y;\r\n        bb = graphic?.localBounds.translate(vec(offsetX + layer.offset.x, offsetY + layer.offset.y)).combine(bb);\r\n      }\r\n    }\r\n    this._localBounds = bb;\r\n  }\r\n\r\n  public get localBounds(): BoundingBox {\r\n    if (!this._localBounds || this._localBounds.hasZeroDimensions()) {\r\n      this.recalculateBounds();\r\n    }\r\n    return this._localBounds;\r\n  }\r\n\r\n  /**\r\n   * Update underlying graphics if necesary, called internally\r\n   * @param elapsed\r\n   * @internal\r\n   */\r\n  public update(elapsed: number, idempotencyToken: number = 0) {\r\n    for (const layer of this.layers.get()) {\r\n      for (const { graphic } of layer.graphics) {\r\n        if (hasGraphicsTick(graphic)) {\r\n          graphic?.tick(elapsed, idempotencyToken);\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Raster, RasterOptions } from './Raster';\r\n\r\nexport interface RectangleOptions {\r\n  width: number;\r\n  height: number;\r\n}\r\n\r\n/**\r\n * A Rectangle [[Graphic]] for drawing rectangles to the [[ExcaliburGraphicsContext]]\r\n */\r\nexport class Rectangle extends Raster {\r\n  constructor(options: RasterOptions & RectangleOptions) {\r\n    super(options);\r\n    this.width = options.width;\r\n    this.height = options.height;\r\n    this.rasterize();\r\n  }\r\n\r\n  public clone(): Rectangle {\r\n    return new Rectangle({\r\n      width: this.width,\r\n      height: this.height,\r\n      ...this.cloneGraphicOptions(),\r\n      ...this.cloneRasterOptions()\r\n    });\r\n  }\r\n\r\n  execute(ctx: CanvasRenderingContext2D): void {\r\n    if (this.color) {\r\n      ctx.fillRect(0, 0, this.width, this.height);\r\n    }\r\n    if (this.strokeColor) {\r\n      ctx.strokeRect(0, 0, this.width, this.height);\r\n    }\r\n  }\r\n}\r\n","import { ImageFiltering } from '.';\r\nimport { Raster, RasterOptions } from './Raster';\r\n\r\nexport interface CircleOptions {\r\n  radius: number;\r\n}\r\n\r\n/**\r\n * A circle [[Graphic]] for drawing circles to the [[ExcaliburGraphicsContext]]\r\n *\r\n * Circles default to [[ImageFiltering.Blended]]\r\n */\r\nexport class Circle extends Raster {\r\n  private _radius: number = 0;\r\n  public get radius() {\r\n    return this._radius;\r\n  }\r\n  public set radius(value: number) {\r\n    this._radius = value;\r\n    this.width = this._radius * 2;\r\n    this.height = this._radius * 2;\r\n    this.flagDirty();\r\n  }\r\n  constructor(options: RasterOptions & CircleOptions) {\r\n    super(options);\r\n    this.padding = options.padding ?? 2; // default 2 padding for circles looks nice\r\n    this.radius = options.radius;\r\n    this.filtering = options.filtering ?? ImageFiltering.Blended;\r\n    this.rasterize();\r\n  }\r\n\r\n  public clone(): Circle {\r\n    return new Circle({\r\n      radius: this.radius,\r\n      ...this.cloneGraphicOptions(),\r\n      ...this.cloneRasterOptions()\r\n    });\r\n  }\r\n\r\n  execute(ctx: CanvasRenderingContext2D): void {\r\n    if (this.radius > 0) {\r\n      ctx.beginPath();\r\n      ctx.arc(this.radius, this.radius, this.radius, 0, Math.PI * 2);\r\n\r\n      if (this.color) {\r\n        ctx.fill();\r\n      }\r\n\r\n      if (this.strokeColor) {\r\n        ctx.stroke();\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Component } from '../EntityComponentSystem/Component';\r\n\r\n/**\r\n * Add this component to optionally configure how the pointer\r\n * system detects pointer events.\r\n *\r\n * By default the collider shape is used and graphics bounds is not.\r\n *\r\n * If both collider shape and graphics bounds are enabled it will fire events if either or\r\n * are intersecting the pointer.\r\n */\r\nexport class PointerComponent extends Component<'ex.pointer'> {\r\n  public readonly type = 'ex.pointer';\r\n  /**\r\n   * Use any existing Collider component geometry for pointer events. This is useful if you want\r\n   * user pointer events only to trigger on the same collision geometry used in the collider component\r\n   * for collision resolution. Default is `true`.\r\n   */\r\n  public useColliderShape = true;\r\n  /**\r\n   * Use any existing Graphics component bounds for pointers. This is useful if you want the axis aligned\r\n   * bounds around the graphic to trigger pointer events. Default is `false`.\r\n   */\r\n  public useGraphicsBounds = false;\r\n}","import { Vector } from '../Math/vector';\r\n\r\n/**\r\n * A definition of an EasingFunction. See [[EasingFunctions]].\r\n */\r\n// tslint:disable-next-line\r\nexport interface EasingFunction {\r\n  (currentTime: number, startValue: number, endValue: number, duration: number): number;\r\n}\r\n\r\n/**\r\n * Standard easing functions for motion in Excalibur, defined on a domain of [0, duration] and a range from [+startValue,+endValue]\r\n * Given a time, the function will return a value from positive startValue to positive endValue.\r\n *\r\n * ```js\r\n * function Linear (t) {\r\n *    return t * t;\r\n * }\r\n *\r\n * // accelerating from zero velocity\r\n * function EaseInQuad (t) {\r\n *    return t * t;\r\n * }\r\n *\r\n * // decelerating to zero velocity\r\n * function EaseOutQuad (t) {\r\n *    return t * (2 - t);\r\n * }\r\n *\r\n * // acceleration until halfway, then deceleration\r\n * function EaseInOutQuad (t) {\r\n *    return t < .5 ? 2 * t * t : -1 + (4 - 2 * t) * t;\r\n * }\r\n *\r\n * // accelerating from zero velocity\r\n * function EaseInCubic (t) {\r\n *    return t * t * t;\r\n * }\r\n *\r\n * // decelerating to zero velocity\r\n * function EaseOutCubic (t) {\r\n *    return (--t) * t * t + 1;\r\n * }\r\n *\r\n * // acceleration until halfway, then deceleration\r\n * function EaseInOutCubic (t) {\r\n *    return t < .5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1;\r\n * }\r\n * ```\r\n */\r\nexport class EasingFunctions {\r\n  public static CreateReversibleEasingFunction(easing: EasingFunction) {\r\n    return (time: number, start: number, end: number, duration: number) => {\r\n      if (end < start) {\r\n        return start - (easing(time, end, start, duration) - end);\r\n      } else {\r\n        return easing(time, start, end, duration);\r\n      }\r\n    };\r\n  }\r\n\r\n  public static CreateVectorEasingFunction(easing: EasingFunction) {\r\n    return (time: number, start: Vector, end: Vector, duration: number) => {\r\n      return new Vector(easing(time, start.x, end.x, duration), easing(time, start.y, end.y, duration));\r\n    };\r\n  }\r\n\r\n  public static Linear: EasingFunction = EasingFunctions.CreateReversibleEasingFunction(\r\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\r\n      endValue = endValue - startValue;\r\n      return (endValue * currentTime) / duration + startValue;\r\n    }\r\n  );\r\n\r\n  public static EaseInQuad = EasingFunctions.CreateReversibleEasingFunction(\r\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\r\n      endValue = endValue - startValue;\r\n      currentTime /= duration;\r\n\r\n      return endValue * currentTime * currentTime + startValue;\r\n    }\r\n  );\r\n\r\n  public static EaseOutQuad: EasingFunction = EasingFunctions.CreateReversibleEasingFunction(\r\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\r\n      endValue = endValue - startValue;\r\n      currentTime /= duration;\r\n      return -endValue * currentTime * (currentTime - 2) + startValue;\r\n    }\r\n  );\r\n\r\n  public static EaseInOutQuad: EasingFunction = EasingFunctions.CreateReversibleEasingFunction(\r\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\r\n      endValue = endValue - startValue;\r\n      currentTime /= duration / 2;\r\n\r\n      if (currentTime < 1) {\r\n        return (endValue / 2) * currentTime * currentTime + startValue;\r\n      }\r\n      currentTime--;\r\n\r\n      return (-endValue / 2) * (currentTime * (currentTime - 2) - 1) + startValue;\r\n    }\r\n  );\r\n\r\n  public static EaseInCubic: EasingFunction = EasingFunctions.CreateReversibleEasingFunction(\r\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\r\n      endValue = endValue - startValue;\r\n      currentTime /= duration;\r\n      return endValue * currentTime * currentTime * currentTime + startValue;\r\n    }\r\n  );\r\n\r\n  public static EaseOutCubic: EasingFunction = EasingFunctions.CreateReversibleEasingFunction(\r\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\r\n      endValue = endValue - startValue;\r\n      currentTime /= duration;\r\n      currentTime--;\r\n      return endValue * (currentTime * currentTime * currentTime + 1) + startValue;\r\n    }\r\n  );\r\n\r\n  public static EaseInOutCubic: EasingFunction = EasingFunctions.CreateReversibleEasingFunction(\r\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\r\n      endValue = endValue - startValue;\r\n      currentTime /= duration / 2;\r\n      if (currentTime < 1) {\r\n        return (endValue / 2) * currentTime * currentTime * currentTime + startValue;\r\n      }\r\n      currentTime -= 2;\r\n      return (endValue / 2) * (currentTime * currentTime * currentTime + 2) + startValue;\r\n    }\r\n  );\r\n}\r\n","import { Entity } from '../EntityComponentSystem/Entity';\r\nimport { Action } from './Action';\r\n\r\n/**\r\n * Action Queues represent an ordered sequence of actions\r\n *\r\n * Action queues are part of the [[ActionContext|Action API]] and\r\n * store the list of actions to be executed for an [[Actor]].\r\n *\r\n * Actors implement [[Actor.actions]] which can be manipulated by\r\n * advanced users to adjust the actions currently being executed in the\r\n * queue.\r\n */\r\nexport class ActionQueue {\r\n  private _entity: Entity;\r\n  private _actions: Action[] = [];\r\n  private _currentAction: Action;\r\n  private _completedActions: Action[] = [];\r\n  constructor(entity: Entity) {\r\n    this._entity = entity;\r\n  }\r\n\r\n  /**\r\n   * Add an action to the sequence\r\n   * @param action\r\n   */\r\n  public add(action: Action) {\r\n    this._actions.push(action);\r\n  }\r\n\r\n  /**\r\n   * Remove an action by reference from the sequence\r\n   * @param action\r\n   */\r\n  public remove(action: Action) {\r\n    const index = this._actions.indexOf(action);\r\n    this._actions.splice(index, 1);\r\n  }\r\n\r\n  /**\r\n   * Removes all actions from this sequence\r\n   */\r\n  public clearActions(): void {\r\n    this._actions.length = 0;\r\n    this._completedActions.length = 0;\r\n    if (this._currentAction) {\r\n      this._currentAction.stop();\r\n    }\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @returns The total list of actions in this sequence complete or not\r\n   */\r\n  public getActions(): Action[] {\r\n    return this._actions.concat(this._completedActions);\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @returns `true` if there are more actions to process in the sequence\r\n   */\r\n  public hasNext(): boolean {\r\n    return this._actions.length > 0;\r\n  }\r\n\r\n  /**\r\n   * @returns `true` if the current sequence of actions is done\r\n   */\r\n  public isComplete(): boolean {\r\n    return this._actions.length === 0;\r\n  }\r\n\r\n  /**\r\n   * Resets the sequence of actions, this is used to restart a sequence from the beginning\r\n   */\r\n  public reset(): void {\r\n    this._actions = this.getActions();\r\n\r\n    const len = this._actions.length;\r\n    for (let i = 0; i < len; i++) {\r\n      this._actions[i].reset();\r\n    }\r\n    this._completedActions = [];\r\n  }\r\n\r\n  /**\r\n   * Update the queue which updates actions and handles completing actions\r\n   * @param elapsedMs\r\n   */\r\n  public update(elapsedMs: number) {\r\n    if (this._actions.length > 0) {\r\n      this._currentAction = this._actions[0];\r\n      this._currentAction.update(elapsedMs);\r\n\r\n      if (this._currentAction.isComplete(this._entity)) {\r\n        this._completedActions.push(this._actions.shift());\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Action } from '../Action';\r\nimport { ActionContext } from '../ActionContext';\r\nimport { ActionQueue } from '../ActionQueue';\r\n\r\nexport class Repeat implements Action {\r\n  private _actionQueue: ActionQueue;\r\n  private _repeat: number;\r\n  private _originalRepeat: number;\r\n  private _stopped: boolean = false;\r\n  private _repeatContext: ActionContext;\r\n  private _repeatBuilder: (repeatContext: ActionContext) => any;\r\n  constructor(entity: Entity, repeatBuilder: (repeatContext: ActionContext) => any, repeat: number) {\r\n    this._repeatBuilder = repeatBuilder;\r\n    this._repeatContext = new ActionContext(entity);\r\n    this._actionQueue = this._repeatContext.getQueue();\r\n\r\n    this._repeat = repeat;\r\n    this._originalRepeat = repeat;\r\n\r\n    this._repeatBuilder(this._repeatContext);\r\n    this._repeat--; // current execution is the first repeat\r\n  }\r\n\r\n  public update(delta: number): void {\r\n    if (this._actionQueue.isComplete()) {\r\n      this._actionQueue.clearActions();\r\n      this._repeatBuilder(this._repeatContext);\r\n      this._repeat--;\r\n    }\r\n    this._actionQueue.update(delta);\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped || (this._repeat <= 0 && this._actionQueue.isComplete());\r\n  }\r\n\r\n  public stop(): void {\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._repeat = this._originalRepeat;\r\n  }\r\n}\r\n","import { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Action } from '../Action';\r\nimport { ActionContext } from '../ActionContext';\r\nimport { ActionQueue } from '../ActionQueue';\r\n\r\n/**\r\n * RepeatForever Action implementation, it is recommended you use the fluent action\r\n * context API.\r\n *\r\n *\r\n */\r\nexport class RepeatForever implements Action {\r\n  private _actionQueue: ActionQueue;\r\n  private _stopped: boolean = false;\r\n  private _repeatContext: ActionContext;\r\n  private _repeatBuilder: (repeatContext: ActionContext) => any;\r\n  constructor(entity: Entity, repeatBuilder: (repeatContext: ActionContext) => any) {\r\n    this._repeatBuilder = repeatBuilder;\r\n    this._repeatContext = new ActionContext(entity);\r\n    this._actionQueue = this._repeatContext.getQueue();\r\n\r\n    this._repeatBuilder(this._repeatContext);\r\n  }\r\n\r\n  public update(delta: number): void {\r\n    if (this._stopped) {\r\n      return;\r\n    }\r\n\r\n    if (this._actionQueue.isComplete()) {\r\n      this._actionQueue.clearActions();\r\n      this._repeatBuilder(this._repeatContext);\r\n    }\r\n\r\n    this._actionQueue.update(delta);\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._stopped = true;\r\n    this._actionQueue.clearActions();\r\n  }\r\n\r\n  public reset(): void {\r\n    return;\r\n  }\r\n}\r\n","import { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Vector, vec } from '../../Math/vector';\r\nimport { Logger } from '../../Util/Log';\r\nimport { Action } from '../Action';\r\n\r\nexport class MoveBy implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  private _entity: Entity;\r\n  public x: number;\r\n  public y: number;\r\n  private _distance: number;\r\n  private _speed: number;\r\n\r\n  private _start: Vector;\r\n  private _offset: Vector;\r\n  private _end: Vector;\r\n  private _dir: Vector;\r\n  private _started = false;\r\n  private _stopped = false;\r\n\r\n  constructor(entity: Entity, offsetX: number, offsetY: number, speed: number) {\r\n    this._entity = entity;\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._speed = speed;\r\n    this._offset = new Vector(offsetX, offsetY);\r\n    if (speed <= 0) {\r\n      Logger.getInstance().error('Attempted to moveBy with speed less than or equal to zero : ' + speed);\r\n      throw new Error('Speed must be greater than 0 pixels per second');\r\n    }\r\n  }\r\n\r\n  public update(_delta: number) {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._start = new Vector(this._tx.pos.x, this._tx.pos.y);\r\n      this._end = this._start.add(this._offset);\r\n      this._distance = this._offset.size;\r\n      this._dir = this._end.sub(this._start).normalize();\r\n    }\r\n\r\n    if (this.isComplete(this._entity)) {\r\n      this._tx.pos = vec(this._end.x, this._end.y);\r\n      this._motion.vel = vec(0, 0);\r\n    } else {\r\n      this._motion.vel = this._dir.scale(this._speed);\r\n    }\r\n  }\r\n\r\n  public isComplete(entity: Entity): boolean {\r\n    const tx = entity.get(TransformComponent);\r\n    return this._stopped || tx.pos.distance(this._start) >= this._distance;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Vector, vec } from '../../Math/vector';\r\nimport { Action } from '../Action';\r\n\r\nexport class MoveTo implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  public x: number;\r\n  public y: number;\r\n  private _start: Vector;\r\n  private _end: Vector;\r\n  private _dir: Vector;\r\n  private _speed: number;\r\n  private _distance: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  constructor(public entity: Entity, destx: number, desty: number, speed: number) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._end = new Vector(destx, desty);\r\n    this._speed = speed;\r\n  }\r\n\r\n  public update(_delta: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._start = new Vector(this._tx.pos.x, this._tx.pos.y);\r\n      this._distance = this._start.distance(this._end);\r\n      this._dir = this._end.sub(this._start).normalize();\r\n    }\r\n    const m = this._dir.scale(this._speed);\r\n    this._motion.vel = vec(m.x, m.y);\r\n\r\n    if (this.isComplete(this.entity)) {\r\n      this._tx.pos = vec(this._end.x, this._end.y);\r\n      this._motion.vel = vec(0, 0);\r\n    }\r\n  }\r\n\r\n  public isComplete(entity: Entity): boolean {\r\n    const tx = entity.get(TransformComponent);\r\n    return this._stopped || new Vector(tx.pos.x, tx.pos.y).distance(this._start) >= this._distance;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { Action } from '../Action';\r\nimport { RotationType } from '../RotationType';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { TwoPI } from '../../Math/util';\r\n\r\nexport class RotateTo implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  public x: number;\r\n  public y: number;\r\n  private _start: number;\r\n  private _end: number;\r\n  private _speed: number;\r\n  private _rotationType: RotationType;\r\n  private _direction: number;\r\n  private _distance: number;\r\n  private _shortDistance: number;\r\n  private _longDistance: number;\r\n  private _shortestPathIsPositive: boolean;\r\n  private _currentNonCannonAngle: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  constructor(entity: Entity, angleRadians: number, speed: number, rotationType?: RotationType) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._end = angleRadians;\r\n    this._speed = speed;\r\n    this._rotationType = rotationType || RotationType.ShortestPath;\r\n  }\r\n\r\n  public update(_delta: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._start = this._tx.rotation;\r\n      this._currentNonCannonAngle = this._tx.rotation;\r\n      const distance1 = Math.abs(this._end - this._start);\r\n      const distance2 = TwoPI - distance1;\r\n      if (distance1 > distance2) {\r\n        this._shortDistance = distance2;\r\n        this._longDistance = distance1;\r\n      } else {\r\n        this._shortDistance = distance1;\r\n        this._longDistance = distance2;\r\n      }\r\n\r\n      this._shortestPathIsPositive = (this._start - this._end + TwoPI) % TwoPI >= Math.PI;\r\n\r\n      switch (this._rotationType) {\r\n        case RotationType.ShortestPath:\r\n          this._distance = this._shortDistance;\r\n          if (this._shortestPathIsPositive) {\r\n            this._direction = 1;\r\n          } else {\r\n            this._direction = -1;\r\n          }\r\n          break;\r\n        case RotationType.LongestPath:\r\n          this._distance = this._longDistance;\r\n          if (this._shortestPathIsPositive) {\r\n            this._direction = -1;\r\n          } else {\r\n            this._direction = 1;\r\n          }\r\n          break;\r\n        case RotationType.Clockwise:\r\n          this._direction = 1;\r\n          if (this._shortestPathIsPositive) {\r\n            this._distance = this._shortDistance;\r\n          } else {\r\n            this._distance = this._longDistance;\r\n          }\r\n          break;\r\n        case RotationType.CounterClockwise:\r\n          this._direction = -1;\r\n          if (!this._shortestPathIsPositive) {\r\n            this._distance = this._shortDistance;\r\n          } else {\r\n            this._distance = this._longDistance;\r\n          }\r\n          break;\r\n      }\r\n    }\r\n\r\n    this._motion.angularVelocity = this._direction * this._speed;\r\n    this._currentNonCannonAngle += this._direction * this._speed * (_delta / 1000);\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.rotation = this._end;\r\n      this._motion.angularVelocity = 0;\r\n      this._stopped = true;\r\n    }\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    const distanceTraveled = Math.abs(this._currentNonCannonAngle - this._start);\r\n    return this._stopped || distanceTraveled >= Math.abs(this._distance);\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.angularVelocity = 0;\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { Action } from '../Action';\r\nimport { RotationType } from '../RotationType';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { TwoPI } from '../../Math/util';\r\n\r\nexport class RotateBy implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  public x: number;\r\n  public y: number;\r\n  private _start: number;\r\n  private _end: number;\r\n  private _speed: number;\r\n  private _offset: number;\r\n\r\n  private _rotationType: RotationType;\r\n  private _direction: number;\r\n  private _distance: number;\r\n  private _shortDistance: number;\r\n  private _longDistance: number;\r\n  private _shortestPathIsPositive: boolean;\r\n  private _currentNonCannonAngle: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  constructor(entity: Entity, angleRadiansOffset: number, speed: number, rotationType?: RotationType) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._speed = speed;\r\n    this._offset = angleRadiansOffset;\r\n    this._rotationType = rotationType || RotationType.ShortestPath;\r\n  }\r\n\r\n  public update(_delta: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._start = this._tx.rotation;\r\n      this._currentNonCannonAngle = this._tx.rotation;\r\n      this._end = this._start + this._offset;\r\n\r\n      const distance1 = Math.abs(this._end - this._start);\r\n      const distance2 = TwoPI - distance1;\r\n      if (distance1 > distance2) {\r\n        this._shortDistance = distance2;\r\n        this._longDistance = distance1;\r\n      } else {\r\n        this._shortDistance = distance1;\r\n        this._longDistance = distance2;\r\n      }\r\n\r\n      this._shortestPathIsPositive = (this._start - this._end + TwoPI) % TwoPI >= Math.PI;\r\n\r\n      switch (this._rotationType) {\r\n        case RotationType.ShortestPath:\r\n          this._distance = this._shortDistance;\r\n          if (this._shortestPathIsPositive) {\r\n            this._direction = 1;\r\n          } else {\r\n            this._direction = -1;\r\n          }\r\n          break;\r\n        case RotationType.LongestPath:\r\n          this._distance = this._longDistance;\r\n          if (this._shortestPathIsPositive) {\r\n            this._direction = -1;\r\n          } else {\r\n            this._direction = 1;\r\n          }\r\n          break;\r\n        case RotationType.Clockwise:\r\n          this._direction = 1;\r\n          if (this._shortDistance >= 0) {\r\n            this._distance = this._shortDistance;\r\n          } else {\r\n            this._distance = this._longDistance;\r\n          }\r\n          break;\r\n        case RotationType.CounterClockwise:\r\n          this._direction = -1;\r\n          if (this._shortDistance <= 0) {\r\n            this._distance = this._shortDistance;\r\n          } else {\r\n            this._distance = this._longDistance;\r\n          }\r\n          break;\r\n      }\r\n    }\r\n\r\n    this._motion.angularVelocity = this._direction * this._speed;\r\n    this._currentNonCannonAngle += this._direction * this._speed * (_delta / 1000);\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.rotation = this._end;\r\n      this._motion.angularVelocity = 0;\r\n      this._stopped = true;\r\n    }\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    const distanceTraveled = Math.abs(this._currentNonCannonAngle - this._start);\r\n    return this._stopped || distanceTraveled >= Math.abs(this._distance);\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.angularVelocity = 0;\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n    this._start = undefined;\r\n    this._currentNonCannonAngle = undefined;\r\n    this._distance = undefined;\r\n  }\r\n}\r\n","import { vec } from '../../Math/vector';\r\nimport { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Action } from '../Action';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\n\r\nexport class ScaleTo implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  public x: number;\r\n  public y: number;\r\n  private _startX: number;\r\n  private _startY: number;\r\n  private _endX: number;\r\n  private _endY: number;\r\n  private _speedX: number;\r\n  private _speedY: number;\r\n  private _distanceX: number;\r\n  private _distanceY: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  constructor(entity: Entity, scaleX: number, scaleY: number, speedX: number, speedY: number) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._endX = scaleX;\r\n    this._endY = scaleY;\r\n    this._speedX = speedX;\r\n    this._speedY = speedY;\r\n  }\r\n\r\n  public update(_delta: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._startX = this._tx.scale.x;\r\n      this._startY = this._tx.scale.y;\r\n      this._distanceX = Math.abs(this._endX - this._startX);\r\n      this._distanceY = Math.abs(this._endY - this._startY);\r\n    }\r\n\r\n    if (!(Math.abs(this._tx.scale.x - this._startX) >= this._distanceX)) {\r\n      const directionX = this._endY < this._startY ? -1 : 1;\r\n      this._motion.scaleFactor.x = this._speedX * directionX;\r\n    } else {\r\n      this._motion.scaleFactor.x = 0;\r\n    }\r\n\r\n    if (!(Math.abs(this._tx.scale.y - this._startY) >= this._distanceY)) {\r\n      const directionY = this._endY < this._startY ? -1 : 1;\r\n      this._motion.scaleFactor.y = this._speedY * directionY;\r\n    } else {\r\n      this._motion.scaleFactor.y = 0;\r\n    }\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.scale = vec(this._endX, this._endY);\r\n      this._motion.scaleFactor.x = 0;\r\n      this._motion.scaleFactor.y = 0;\r\n    }\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return (\r\n      this._stopped ||\r\n      (Math.abs(this._tx.scale.y - this._startX) >= (this._distanceX - 0.01) &&\r\n        Math.abs(this._tx.scale.y - this._startY) >= (this._distanceY - 0.01))\r\n    );\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.scaleFactor.x = 0;\r\n    this._motion.scaleFactor.y = 0;\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { Vector } from '../../Math/vector';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Action } from '../Action';\r\n\r\nexport class ScaleBy implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  public x: number;\r\n  public y: number;\r\n  private _startScale: Vector;\r\n  private _endScale: Vector;\r\n  private _offset: Vector;\r\n  private _distanceX: number;\r\n  private _distanceY: number;\r\n  private _directionX: number;\r\n  private _directionY: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  private _speedX: number;\r\n  private _speedY: number;\r\n  constructor(entity: Entity, scaleOffsetX: number, scaleOffsetY: number, speed: number) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._offset = new Vector(scaleOffsetX, scaleOffsetY);\r\n    this._speedX = this._speedY = speed;\r\n  }\r\n\r\n  public update(_delta: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._startScale = this._tx.scale.clone();\r\n      this._endScale = this._startScale.add(this._offset);\r\n      this._distanceX = Math.abs(this._endScale.x - this._startScale.x);\r\n      this._distanceY = Math.abs(this._endScale.y - this._startScale.y);\r\n      this._directionX = this._endScale.x < this._startScale.x ? -1 : 1;\r\n      this._directionY = this._endScale.y < this._startScale.y ? -1 : 1;\r\n    }\r\n\r\n    this._motion.scaleFactor.x = this._speedX * this._directionX;\r\n    this._motion.scaleFactor.y = this._speedY * this._directionY;\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.scale = this._endScale;\r\n      this._motion.scaleFactor.x = 0;\r\n      this._motion.scaleFactor.y = 0;\r\n    }\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return (\r\n      this._stopped ||\r\n      (Math.abs(this._tx.scale.x - this._startScale.x) >= (this._distanceX - 0.01) &&\r\n        Math.abs(this._tx.scale.y - this._startScale.y) >= (this._distanceY - 0.01))\r\n    );\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.scaleFactor.x = 0;\r\n    this._motion.scaleFactor.y = 0;\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { Action } from '../Action';\r\n\r\nexport class CallMethod implements Action {\r\n  private _method: () => any = null;\r\n  private _hasBeenCalled: boolean = false;\r\n  constructor(method: () => any) {\r\n    this._method = method;\r\n  }\r\n\r\n  public update(_delta: number) {\r\n    this._method();\r\n    this._hasBeenCalled = true;\r\n  }\r\n  public isComplete() {\r\n    return this._hasBeenCalled;\r\n  }\r\n  public reset() {\r\n    this._hasBeenCalled = false;\r\n  }\r\n  public stop() {\r\n    this._hasBeenCalled = true;\r\n  }\r\n}\r\n","import { Entity} from '../../EntityComponentSystem/Entity';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { vec, Vector } from '../../Math/vector';\r\nimport { Action } from '../Action';\r\n\r\nexport class EaseTo implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  private _currentLerpTime: number = 0;\r\n  private _lerpDuration: number = 1 * 1000; // 1 second\r\n  private _lerpStart: Vector = new Vector(0, 0);\r\n  private _lerpEnd: Vector = new Vector(0, 0);\r\n  private _initialized: boolean = false;\r\n  private _stopped: boolean = false;\r\n  constructor(\r\n    entity: Entity,\r\n    x: number,\r\n    y: number,\r\n    duration: number,\r\n    public easingFcn: (currentTime: number, startValue: number, endValue: number, duration: number) => number\r\n  ) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._lerpDuration = duration;\r\n    this._lerpEnd = new Vector(x, y);\r\n  }\r\n  private _initialize() {\r\n    this._lerpStart = new Vector(this._tx.pos.x, this._tx.pos.y);\r\n    this._currentLerpTime = 0;\r\n  }\r\n\r\n  public update(delta: number): void {\r\n    if (!this._initialized) {\r\n      this._initialize();\r\n      this._initialized = true;\r\n    }\r\n\r\n    // Need to update lerp time first, otherwise the first update will always be zero\r\n    this._currentLerpTime += delta;\r\n    let newX = this._tx.pos.x;\r\n    let newY = this._tx.pos.y;\r\n    if (this._currentLerpTime < this._lerpDuration) {\r\n      if (this._lerpEnd.x < this._lerpStart.x) {\r\n        newX =\r\n          this._lerpStart.x -\r\n          (this.easingFcn(this._currentLerpTime, this._lerpEnd.x, this._lerpStart.x, this._lerpDuration) - this._lerpEnd.x);\r\n      } else {\r\n        newX = this.easingFcn(this._currentLerpTime, this._lerpStart.x, this._lerpEnd.x, this._lerpDuration);\r\n      }\r\n\r\n      if (this._lerpEnd.y < this._lerpStart.y) {\r\n        newY =\r\n          this._lerpStart.y -\r\n          (this.easingFcn(this._currentLerpTime, this._lerpEnd.y, this._lerpStart.y, this._lerpDuration) - this._lerpEnd.y);\r\n      } else {\r\n        newY = this.easingFcn(this._currentLerpTime, this._lerpStart.y, this._lerpEnd.y, this._lerpDuration);\r\n      }\r\n      // Given the lerp position figure out the velocity in pixels per second\r\n      this._motion.vel = vec((newX - this._tx.pos.x) / (delta / 1000), (newY - this._tx.pos.y) / (delta / 1000));\r\n    } else {\r\n      this._tx.pos = vec(this._lerpEnd.x, this._lerpEnd.y);\r\n      this._motion.vel = Vector.Zero;\r\n    }\r\n  }\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._currentLerpTime >= this._lerpDuration;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._initialized = false;\r\n    this._stopped = false;\r\n    this._currentLerpTime = 0;\r\n  }\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n  }\r\n}\r\n","import { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { vec, Vector } from '../../Math/vector';\r\nimport { Action } from '../Action';\r\n\r\nexport class EaseBy implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  private _currentLerpTime: number = 0;\r\n  private _lerpDuration: number = 1 * 1000; // 1 second\r\n  private _lerpStart: Vector = new Vector(0, 0);\r\n  private _lerpEnd: Vector = new Vector(0, 0);\r\n  private _offset: Vector;\r\n  private _initialized: boolean = false;\r\n  private _stopped: boolean = false;\r\n  constructor(\r\n    entity: Entity,\r\n    offsetX: number,\r\n    offsetY: number,\r\n    duration: number,\r\n    public easingFcn: (currentTime: number, startValue: number, endValue: number, duration: number) => number\r\n  ) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._lerpDuration = duration;\r\n    this._offset = new Vector(offsetX, offsetY);\r\n  }\r\n  private _initialize() {\r\n    this._lerpStart = new Vector(this._tx.pos.x, this._tx.pos.y);\r\n    this._currentLerpTime = 0;\r\n    this._lerpEnd = this._lerpStart.add(this._offset);\r\n  }\r\n\r\n  public update(delta: number): void {\r\n    if (!this._initialized) {\r\n      this._initialize();\r\n      this._initialized = true;\r\n    }\r\n\r\n    // Need to update lerp time first, otherwise the first update will always be zero\r\n    this._currentLerpTime += delta;\r\n    let newX = this._tx.pos.x;\r\n    let newY = this._tx.pos.y;\r\n    if (this._currentLerpTime < this._lerpDuration) {\r\n      if (this._lerpEnd.x < this._lerpStart.x) {\r\n        newX =\r\n          this._lerpStart.x -\r\n          (this.easingFcn(this._currentLerpTime, this._lerpEnd.x, this._lerpStart.x, this._lerpDuration) - this._lerpEnd.x);\r\n      } else {\r\n        newX = this.easingFcn(this._currentLerpTime, this._lerpStart.x, this._lerpEnd.x, this._lerpDuration);\r\n      }\r\n\r\n      if (this._lerpEnd.y < this._lerpStart.y) {\r\n        newY =\r\n          this._lerpStart.y -\r\n          (this.easingFcn(this._currentLerpTime, this._lerpEnd.y, this._lerpStart.y, this._lerpDuration) - this._lerpEnd.y);\r\n      } else {\r\n        newY = this.easingFcn(this._currentLerpTime, this._lerpStart.y, this._lerpEnd.y, this._lerpDuration);\r\n      }\r\n      // Given the lerp position figure out the velocity in pixels per second\r\n      this._motion.vel = vec((newX - this._tx.pos.x) / (delta / 1000), (newY - this._tx.pos.y) / (delta / 1000));\r\n    } else {\r\n      this._tx.pos = vec(this._lerpEnd.x, this._lerpEnd.y);\r\n      this._motion.vel = Vector.Zero;\r\n    }\r\n  }\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._currentLerpTime >= this._lerpDuration;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._initialized = false;\r\n    this._stopped = false;\r\n    this._currentLerpTime = 0;\r\n  }\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n  }\r\n}","import { GraphicsComponent } from '../../Graphics/GraphicsComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Action } from '../Action';\r\n\r\nexport class Blink implements Action {\r\n  private _graphics: GraphicsComponent;\r\n  private _timeVisible: number = 0;\r\n  private _timeNotVisible: number = 0;\r\n  private _elapsedTime: number = 0;\r\n  private _totalTime: number = 0;\r\n  private _duration: number;\r\n  private _stopped: boolean = false;\r\n  private _started: boolean = false;\r\n  constructor(entity: Entity, timeVisible: number, timeNotVisible: number, numBlinks: number = 1) {\r\n    this._graphics = entity.get(GraphicsComponent);\r\n    this._timeVisible = timeVisible;\r\n    this._timeNotVisible = timeNotVisible;\r\n    this._duration = (timeVisible + timeNotVisible) * numBlinks;\r\n  }\r\n\r\n  public update(delta: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._elapsedTime = 0;\r\n      this._totalTime = 0;\r\n    }\r\n    if (!this._graphics) {\r\n      return;\r\n    }\r\n\r\n    this._elapsedTime += delta;\r\n    this._totalTime += delta;\r\n    if (this._graphics.visible && this._elapsedTime >= this._timeVisible) {\r\n      this._graphics.visible = false;\r\n      this._elapsedTime = 0;\r\n    }\r\n\r\n    if (!this._graphics.visible && this._elapsedTime >= this._timeNotVisible) {\r\n      this._graphics.visible = true;\r\n      this._elapsedTime = 0;\r\n    }\r\n\r\n    if (this.isComplete()) {\r\n      this._graphics.visible = true;\r\n    }\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._totalTime >= this._duration;\r\n  }\r\n\r\n  public stop(): void {\r\n    if (this._graphics) {\r\n      this._graphics.visible = true;\r\n    }\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset() {\r\n    this._started = false;\r\n    this._stopped = false;\r\n    this._elapsedTime = 0;\r\n    this._totalTime = 0;\r\n  }\r\n}\r\n","import { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { GraphicsComponent } from '../../Graphics/GraphicsComponent';\r\nimport { Logger } from '../../Util/Log';\r\nimport { Action } from '../Action';\r\n\r\nexport class Fade implements Action {\r\n  private _graphics: GraphicsComponent;\r\n  public x: number;\r\n  public y: number;\r\n\r\n  private _endOpacity: number;\r\n  private _speed: number;\r\n  private _ogspeed: number;\r\n  private _multiplier: number = 1;\r\n  private _started = false;\r\n  private _stopped = false;\r\n\r\n  constructor(entity: Entity, endOpacity: number, speed: number) {\r\n    this._graphics = entity.get(GraphicsComponent);\r\n    this._endOpacity = endOpacity;\r\n    this._speed = this._ogspeed = speed;\r\n  }\r\n\r\n  public update(delta: number): void {\r\n    if (!this._graphics) {\r\n      return;\r\n    }\r\n\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._speed = this._ogspeed;\r\n\r\n      // determine direction when we start\r\n      if (this._endOpacity < this._graphics.opacity) {\r\n        this._multiplier = -1;\r\n      } else {\r\n        this._multiplier = 1;\r\n      }\r\n    }\r\n\r\n    if (this._speed > 0) {\r\n      this._graphics.opacity += (this._multiplier *\r\n        (Math.abs(this._graphics.opacity - this._endOpacity) * delta)) / this._speed;\r\n    }\r\n\r\n    this._speed -= delta;\r\n\r\n    if (this.isComplete()) {\r\n      this._graphics.opacity = this._endOpacity;\r\n    }\r\n\r\n    Logger.getInstance().debug('[Action fade] Actor opacity:', this._graphics.opacity);\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped || Math.abs(this._graphics.opacity - this._endOpacity) < 0.05;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { Action } from '../Action';\r\n\r\nexport class Delay implements Action {\r\n  private _elapsedTime: number = 0;\r\n  private _delay: number;\r\n  private _started: boolean = false;\r\n  private _stopped = false;\r\n  constructor(delay: number) {\r\n    this._delay = delay;\r\n  }\r\n\r\n  public update(delta: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n    }\r\n\r\n    this._elapsedTime += delta;\r\n  }\r\n\r\n  isComplete(): boolean {\r\n    return this._stopped || this._elapsedTime >= this._delay;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._stopped = true;\r\n  }\r\n\r\n  reset(): void {\r\n    this._elapsedTime = 0;\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Action } from '../Action';\r\nimport { ActionsComponent } from '../ActionsComponent';\r\n\r\nexport class Die implements Action {\r\n  private _entity: Entity;\r\n  private _stopped = false;\r\n\r\n  constructor(entity: Entity) {\r\n    this._entity = entity;\r\n  }\r\n\r\n  public update(_delta: number): void {\r\n    this._entity.get(ActionsComponent).clearActions();\r\n    this._entity.kill();\r\n    this._stopped = true;\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped;\r\n  }\r\n\r\n  public stop(): void {\r\n    return;\r\n  }\r\n\r\n  public reset(): void {\r\n    return;\r\n  }\r\n}\r\n","import { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { vec, Vector } from '../../Math/vector';\r\nimport { Action } from '../Action';\r\n\r\nexport class Follow implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  private _followTx: TransformComponent;\r\n  private _followMotion: MotionComponent;\r\n\r\n  public x: number;\r\n  public y: number;\r\n  private _current: Vector;\r\n  private _end: Vector;\r\n  private _dir: Vector;\r\n  private _speed: number;\r\n  private _maximumDistance: number;\r\n  private _distanceBetween: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n\r\n  constructor(entity: Entity, entityToFollow: Entity, followDistance?: number) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._followTx = entityToFollow.get(TransformComponent);\r\n    this._followMotion = entityToFollow.get(MotionComponent);\r\n    this._current = new Vector(this._tx.pos.x, this._tx.pos.y);\r\n    this._end = new Vector(this._followTx.pos.x, this._followTx.pos.y);\r\n    this._maximumDistance = followDistance !== undefined ? followDistance : this._current.distance(this._end);\r\n    this._speed = 0;\r\n  }\r\n\r\n  public update(_delta: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._distanceBetween = this._current.distance(this._end);\r\n      this._dir = this._end.sub(this._current).normalize();\r\n    }\r\n\r\n    const actorToFollowSpeed = Math.sqrt(Math.pow(this._followMotion.vel.x, 2) + Math.pow(this._followMotion.vel.y, 2));\r\n    if (actorToFollowSpeed !== 0) {\r\n      this._speed = actorToFollowSpeed;\r\n    }\r\n    this._current = vec(this._tx.pos.x, this._tx.pos.y);\r\n\r\n    this._end = vec(this._followTx.pos.x, this._followTx.pos.y);\r\n    this._distanceBetween = this._current.distance(this._end);\r\n    this._dir = this._end.sub(this._current).normalize();\r\n\r\n    if (this._distanceBetween >= this._maximumDistance) {\r\n      const m = this._dir.scale(this._speed);\r\n      this._motion.vel = vec(m.x, m.y);\r\n    } else {\r\n      this._motion.vel = vec(0, 0);\r\n    }\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.pos = vec(this._end.x, this._end.y);\r\n      this._motion.vel = vec(0, 0);\r\n    }\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    // the actor following should never stop unless specified to do so\r\n    return this._stopped;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Vector, vec } from '../../Math/vector';\r\nimport { Action } from '../Action';\r\n\r\nexport class Meet implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  private _meetTx: TransformComponent;\r\n  private _meetMotion: MotionComponent;\r\n  public x: number;\r\n  public y: number;\r\n  private _current: Vector;\r\n  private _end: Vector;\r\n  private _dir: Vector;\r\n  private _speed: number;\r\n  private _distanceBetween: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  private _speedWasSpecified = false;\r\n\r\n  constructor(actor: Entity, actorToMeet: Entity, speed?: number) {\r\n    this._tx = actor.get(TransformComponent);\r\n    this._motion = actor.get(MotionComponent);\r\n    this._meetTx = actorToMeet.get(TransformComponent);\r\n    this._meetMotion = actorToMeet.get(MotionComponent);\r\n    this._current = new Vector(this._tx.pos.x, this._tx.pos.y);\r\n    this._end = new Vector(this._meetTx.pos.x, this._meetTx.pos.y);\r\n    this._speed = speed || 0;\r\n\r\n    if (speed !== undefined) {\r\n      this._speedWasSpecified = true;\r\n    }\r\n  }\r\n\r\n  public update(_delta: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._distanceBetween = this._current.distance(this._end);\r\n      this._dir = this._end.sub(this._current).normalize();\r\n    }\r\n\r\n    const actorToMeetSpeed = Math.sqrt(Math.pow(this._meetMotion.vel.x, 2) + Math.pow(this._meetMotion.vel.y, 2));\r\n    if (actorToMeetSpeed !== 0 && !this._speedWasSpecified) {\r\n      this._speed = actorToMeetSpeed;\r\n    }\r\n    this._current = vec(this._tx.pos.x, this._tx.pos.y);\r\n\r\n    this._end = vec(this._meetTx.pos.x, this._meetTx.pos.y);\r\n    this._distanceBetween = this._current.distance(this._end);\r\n    this._dir = this._end.sub(this._current).normalize();\r\n\r\n    const m = this._dir.scale(this._speed);\r\n    this._motion.vel = vec(m.x, m.y);\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.pos = vec(this._end.x, this._end.y);\r\n      this._motion.vel = vec(0, 0);\r\n    }\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._distanceBetween <= 1;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n    this._distanceBetween = undefined;\r\n  }\r\n}\r\n","import { RotationType } from './RotationType';\r\n\r\nimport { EasingFunction, EasingFunctions } from '../Util/EasingFunctions';\r\nimport { ActionQueue } from './ActionQueue';\r\nimport { Repeat } from './Action/Repeat';\r\nimport { RepeatForever } from './Action/RepeatForever';\r\nimport { MoveBy } from './Action/MoveBy';\r\nimport { MoveTo } from './Action/MoveTo';\r\nimport { RotateTo } from './Action/RotateTo';\r\nimport { RotateBy } from './Action/RotateBy';\r\nimport { ScaleTo } from './Action/ScaleTo';\r\nimport { ScaleBy } from './Action/ScaleBy';\r\nimport { CallMethod } from './Action/CallMethod';\r\nimport { EaseTo } from './Action/EaseTo';\r\nimport { EaseBy } from './Action/EaseBy';\r\nimport { Blink } from './Action/Blink';\r\nimport { Fade } from './Action/Fade';\r\nimport { Delay } from './Action/Delay';\r\nimport { Die } from './Action/Die';\r\nimport { Follow } from './Action/Follow';\r\nimport { Meet } from './Action/Meet';\r\nimport { Vector } from '../Math/vector';\r\nimport { Entity } from '../EntityComponentSystem/Entity';\r\nimport { Action } from './Action';\r\n\r\n/**\r\n * The fluent Action API allows you to perform \"actions\" on\r\n * [[Actor|Actors]] such as following, moving, rotating, and\r\n * more. You can implement your own actions by implementing\r\n * the [[Action]] interface.\r\n */\r\nexport class ActionContext {\r\n  private _entity: Entity;\r\n  private _queue: ActionQueue;\r\n\r\n  constructor(entity: Entity) {\r\n    this._entity = entity;\r\n    this._queue = new ActionQueue(entity);\r\n  }\r\n\r\n  public getQueue(): ActionQueue {\r\n    return this._queue;\r\n  }\r\n\r\n  public update(elapsedMs: number) {\r\n    this._queue.update(elapsedMs);\r\n  }\r\n\r\n  /**\r\n   * Clears all queued actions from the Actor\r\n   */\r\n  public clearActions(): void {\r\n    this._queue.clearActions();\r\n  }\r\n\r\n  public runAction(action: Action) {\r\n    action.reset();\r\n    this._queue.add(action);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will move an actor to the specified `x` and `y` position over the\r\n   * specified duration using a given [[EasingFunctions]] and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param pos       The x,y vector location to move the actor to\r\n   * @param duration  The time it should take the actor to move to the new location in milliseconds\r\n   * @param easingFcn Use [[EasingFunction]] or a custom function to use to calculate position, Default is [[EasingFunctions.Linear]]\r\n   */\r\n  public easeTo(pos: Vector, duration: number, easingFcn?: EasingFunction): ActionContext\r\n  /**\r\n   * This method will move an actor to the specified `x` and `y` position over the\r\n   * specified duration using a given [[EasingFunctions]] and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param x         The x location to move the actor to\r\n   * @param y         The y location to move the actor to\r\n   * @param duration  The time it should take the actor to move to the new location in milliseconds\r\n   * @param easingFcn Use [[EasingFunction]] or a custom function to use to calculate position, Default is [[EasingFunctions.Linear]]\r\n   */\r\n  public easeTo(x: number, y: number, duration: number, easingFcn?: EasingFunction): ActionContext\r\n  public easeTo(...args: any[]): ActionContext {\r\n    let x = 0;\r\n    let y = 0;\r\n    let duration = 0;\r\n    let easingFcn = EasingFunctions.Linear;\r\n    if (args[0] instanceof Vector) {\r\n      x = args[0].x;\r\n      y = args[0].y;\r\n      duration = args[1];\r\n      easingFcn = args[2] ?? easingFcn;\r\n    } else {\r\n      x = args[0];\r\n      y = args[1];\r\n      duration = args[2];\r\n      easingFcn = args[3] ?? easingFcn;\r\n    }\r\n\r\n    this._queue.add(new EaseTo(this._entity, x, y, duration, easingFcn));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will move an actor by a specified vector offset relative to the current position given\r\n   * a duration and a [[EasingFunction]]. This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param offset Vector offset relative to the current position\r\n   * @param duration The duration in milliseconds\r\n   * @param easingFcn Use [[EasingFunction]] or a custom function to use to calculate position, Default is [[EasingFunctions.Linear]]\r\n   */\r\n  public easeBy(offset: Vector, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  /**\r\n   * This method will move an actor by a specified x and y offset relative to the current position given\r\n   * a duration and a [[EasingFunction]]. This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param offset Vector offset relative to the current position\r\n   * @param duration The duration in milliseconds\r\n   * @param easingFcn Use [[EasingFunction]] or a custom function to use to calculate position, Default is [[EasingFunctions.Linear]]\r\n   */\r\n  public easeBy(offsetX: number, offsetY: number, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  public easeBy(...args: any[]): ActionContext {\r\n    let offsetX = 0;\r\n    let offsetY = 0;\r\n    let duration = 0;\r\n    let easingFcn = EasingFunctions.Linear;\r\n    if (args[0] instanceof Vector) {\r\n      offsetX = args[0].x;\r\n      offsetY = args[0].y;\r\n      duration = args[1];\r\n      easingFcn = args[2] ?? easingFcn;\r\n    } else {\r\n      offsetX = args[0];\r\n      offsetY = args[1];\r\n      duration = args[2];\r\n      easingFcn = args[3] ?? easingFcn;\r\n    }\r\n\r\n    this._queue.add(new EaseBy(this._entity, offsetX, offsetY, duration, easingFcn));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will move an actor to the specified x and y position at the\r\n   * speed specified (in pixels per second) and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param pos    The x,y vector location to move the actor to\r\n   * @param speed  The speed in pixels per second to move\r\n   */\r\n  public moveTo(pos: Vector, speed: number): ActionContext;\r\n  /**\r\n   * This method will move an actor to the specified x and y position at the\r\n   * speed specified (in pixels per second) and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param x      The x location to move the actor to\r\n   * @param y      The y location to move the actor to\r\n   * @param speed  The speed in pixels per second to move\r\n   */\r\n  public moveTo(x: number, y: number, speed: number): ActionContext;\r\n  public moveTo(xOrPos: number | Vector, yOrSpeed: number, speedOrUndefined?: number | undefined): ActionContext {\r\n    let x = 0;\r\n    let y = 0;\r\n    let speed = 0;\r\n    if (xOrPos instanceof Vector) {\r\n      x = xOrPos.x;\r\n      y = xOrPos.y;\r\n      speed = yOrSpeed;\r\n    } else {\r\n      x = xOrPos;\r\n      y = yOrSpeed;\r\n      speed = speedOrUndefined;\r\n    }\r\n    this._queue.add(new MoveTo(this._entity, x, y, speed));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will move an actor by the specified x offset and y offset from its current position, at a certain speed.\r\n   * This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param xOffset     The x offset to apply to this actor\r\n   * @param yOffset     The y location to move the actor to\r\n   * @param speed  The speed in pixels per second the actor should move\r\n   */\r\n  public moveBy(offset: Vector, speed: number): ActionContext;\r\n  public moveBy(xOffset: number, yOffset: number, speed: number): ActionContext;\r\n  public moveBy(xOffsetOrVector: number | Vector, yOffsetOrSpeed: number, speedOrUndefined?: number | undefined): ActionContext {\r\n    let xOffset = 0;\r\n    let yOffset = 0;\r\n    let speed = 0;\r\n    if (xOffsetOrVector instanceof Vector) {\r\n      xOffset = xOffsetOrVector.x;\r\n      yOffset = xOffsetOrVector.y;\r\n      speed = yOffsetOrSpeed;\r\n    } else {\r\n      xOffset = xOffsetOrVector;\r\n      yOffset = yOffsetOrSpeed;\r\n      speed = speedOrUndefined;\r\n    }\r\n    this._queue.add(new MoveBy(this._entity, xOffset, yOffset, speed));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will rotate an actor to the specified angle at the speed\r\n   * specified (in radians per second) and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param angleRadians  The angle to rotate to in radians\r\n   * @param speed         The angular velocity of the rotation specified in radians per second\r\n   * @param rotationType  The [[RotationType]] to use for this rotation\r\n   */\r\n  public rotateTo(angleRadians: number, speed: number, rotationType?: RotationType): ActionContext {\r\n    this._queue.add(new RotateTo(this._entity, angleRadians, speed, rotationType));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will rotate an actor by the specified angle offset, from it's current rotation given a certain speed\r\n   * in radians/sec and return back the actor. This method is part\r\n   * of the actor 'Action' fluent API allowing action chaining.\r\n   * @param angleRadiansOffset  The angle to rotate to in radians relative to the current rotation\r\n   * @param speed          The speed in radians/sec the actor should rotate at\r\n   * @param rotationType  The [[RotationType]] to use for this rotation, default is shortest path\r\n   */\r\n  public rotateBy(angleRadiansOffset: number, speed: number, rotationType?: RotationType): ActionContext {\r\n    this._queue.add(new RotateBy(this._entity, angleRadiansOffset, speed, rotationType));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will scale an actor to the specified size at the speed\r\n   * specified (in magnitude increase per second) and return back the\r\n   * actor. This method is part of the actor 'Action' fluent API allowing\r\n   * action chaining.\r\n   * @param size    The scale to adjust the actor to over time\r\n   * @param speed   The speed of scaling specified in magnitude increase per second\r\n   */\r\n  public scaleTo(size: Vector, speed: Vector): ActionContext;\r\n  /**\r\n   * This method will scale an actor to the specified size at the speed\r\n   * specified (in magnitude increase per second) and return back the\r\n   * actor. This method is part of the actor 'Action' fluent API allowing\r\n   * action chaining.\r\n   * @param sizeX   The scaling factor to apply on X axis\r\n   * @param sizeY   The scaling factor to apply on Y axis\r\n   * @param speedX  The speed of scaling specified in magnitude increase per second on X axis\r\n   * @param speedY  The speed of scaling specified in magnitude increase per second on Y axis\r\n   */\r\n  public scaleTo(sizeX: number, sizeY: number, speedX: number, speedY: number): ActionContext;\r\n  public scaleTo(sizeXOrVector: number | Vector,\r\n    sizeYOrSpeed: number | Vector,\r\n    speedXOrUndefined?: number | undefined,\r\n    speedYOrUndefined?: number | undefined): ActionContext {\r\n\r\n    let sizeX = 1;\r\n    let sizeY = 1;\r\n    let speedX = 0;\r\n    let speedY = 0;\r\n\r\n    if (sizeXOrVector instanceof Vector && sizeYOrSpeed instanceof Vector) {\r\n      sizeX = sizeXOrVector.x;\r\n      sizeY = sizeXOrVector.y;\r\n\r\n      speedX = sizeYOrSpeed.x;\r\n      speedY = sizeYOrSpeed.y;\r\n    }\r\n    if (typeof sizeXOrVector === 'number' && typeof sizeYOrSpeed === 'number') {\r\n      sizeX = sizeXOrVector;\r\n      sizeY = sizeYOrSpeed;\r\n\r\n      speedX = speedXOrUndefined;\r\n      speedY = speedYOrUndefined;\r\n    }\r\n\r\n    this._queue.add(new ScaleTo(this._entity, sizeX, sizeY, speedX, speedY));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will scale an actor by an amount relative to the current scale at a certain speed in scale units/sec\r\n   * and return back the actor. This method is part of the\r\n   * actor 'Action' fluent API allowing action chaining.\r\n   * @param offset   The scaling factor to apply to the actor\r\n   * @param speed    The speed to scale at in scale units/sec\r\n   */\r\n  public scaleBy(offset: Vector, speed: number): ActionContext;\r\n  /**\r\n   * This method will scale an actor by an amount relative to the current scale at a certain speed in scale units/sec\r\n   * and return back the actor. This method is part of the\r\n   * actor 'Action' fluent API allowing action chaining.\r\n   * @param sizeOffsetX   The scaling factor to apply on X axis\r\n   * @param sizeOffsetY   The scaling factor to apply on Y axis\r\n   * @param speed    The speed to scale at in scale units/sec\r\n   */\r\n  public scaleBy(sizeOffsetX: number, sizeOffsetY: number, speed: number): ActionContext;\r\n  public scaleBy(sizeOffsetXOrVector: number | Vector, sizeOffsetYOrSpeed: number, speed?: number | undefined): ActionContext {\r\n    let sizeOffsetX = 1;\r\n    let sizeOffsetY = 1;\r\n\r\n    if (sizeOffsetXOrVector instanceof Vector) {\r\n      sizeOffsetX = sizeOffsetXOrVector.x;\r\n      sizeOffsetY = sizeOffsetXOrVector.y;\r\n\r\n      speed = sizeOffsetYOrSpeed;\r\n    }\r\n    if (typeof sizeOffsetXOrVector === 'number' && typeof sizeOffsetYOrSpeed === 'number') {\r\n      sizeOffsetX = sizeOffsetXOrVector;\r\n      sizeOffsetY = sizeOffsetYOrSpeed;\r\n    }\r\n\r\n    this._queue.add(new ScaleBy(this._entity, sizeOffsetX, sizeOffsetY, speed));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will cause an actor to blink (become visible and not\r\n   * visible). Optionally, you may specify the number of blinks. Specify the amount of time\r\n   * the actor should be visible per blink, and the amount of time not visible.\r\n   * This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param timeVisible     The amount of time to stay visible per blink in milliseconds\r\n   * @param timeNotVisible  The amount of time to stay not visible per blink in milliseconds\r\n   * @param numBlinks       The number of times to blink\r\n   */\r\n  public blink(timeVisible: number, timeNotVisible: number, numBlinks: number = 1): ActionContext {\r\n    this._queue.add(new Blink(this._entity, timeVisible, timeNotVisible, numBlinks));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will cause an actor's opacity to change from its current value\r\n   * to the provided value by a specified time (in milliseconds). This method is\r\n   * part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param opacity  The ending opacity\r\n   * @param time     The time it should take to fade the actor (in milliseconds)\r\n   */\r\n  public fade(opacity: number, time: number): ActionContext {\r\n    this._queue.add(new Fade(this._entity, opacity, time));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will delay the next action from executing for a certain\r\n   * amount of time (in milliseconds). This method is part of the actor\r\n   * 'Action' fluent API allowing action chaining.\r\n   * @param time  The amount of time to delay the next action in the queue from executing in milliseconds\r\n   */\r\n  public delay(time: number): ActionContext {\r\n    this._queue.add(new Delay(time));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will add an action to the queue that will remove the actor from the\r\n   * scene once it has completed its previous  Any actions on the\r\n   * action queue after this action will not be executed.\r\n   */\r\n  public die(): ActionContext {\r\n    this._queue.add(new Die(this._entity));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method allows you to call an arbitrary method as the next action in the\r\n   * action queue. This is useful if you want to execute code in after a specific\r\n   * action, i.e An actor arrives at a destination after traversing a path\r\n   */\r\n  public callMethod(method: () => any): ActionContext {\r\n    this._queue.add(new CallMethod(method));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will cause the actor to repeat all of the actions built in\r\n   * the `repeatBuilder` callback. If the number of repeats\r\n   * is not specified it will repeat forever. This method is part of\r\n   * the actor 'Action' fluent API allowing action chaining\r\n   *\r\n   * ```typescript\r\n   * // Move up in a zig-zag by repeated moveBy's\r\n   * actor.actions.repeat(repeatCtx => {\r\n   *  repeatCtx.moveBy(10, 0, 10);\r\n   *  repeatCtx.moveBy(0, 10, 10);\r\n   * }, 5);\r\n   * ```\r\n   *\r\n   * @param repeatBuilder The builder to specify the repeatable list of actions\r\n   * @param times  The number of times to repeat all the previous actions in the action queue. If nothing is specified the actions\r\n   * will repeat forever\r\n   */\r\n  public repeat(repeatBuilder: (repeatContext: ActionContext) => any, times?: number): ActionContext {\r\n    if (!times) {\r\n      this.repeatForever(repeatBuilder);\r\n      return this;\r\n    }\r\n    this._queue.add(new Repeat(this._entity, repeatBuilder, times));\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will cause the actor to repeat all of the actions built in\r\n   * the `repeatBuilder` callback. If the number of repeats\r\n   * is not specified it will repeat forever. This method is part of\r\n   * the actor 'Action' fluent API allowing action chaining\r\n   *\r\n   * ```typescript\r\n   * // Move up in a zig-zag by repeated moveBy's\r\n   * actor.actions.repeat(repeatCtx => {\r\n   *  repeatCtx.moveBy(10, 0, 10);\r\n   *  repeatCtx.moveBy(0, 10, 10);\r\n   * }, 5);\r\n   * ```\r\n   *\r\n   * @param repeatBuilder The builder to specify the repeatable list of actions\r\n   */\r\n  public repeatForever(repeatBuilder: (repeatContext: ActionContext) => any): ActionContext {\r\n    this._queue.add(new RepeatForever(this._entity, repeatBuilder));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will cause the entity to follow another at a specified distance\r\n   * @param entity           The entity to follow\r\n   * @param followDistance  The distance to maintain when following, if not specified the actor will follow at the current distance.\r\n   */\r\n  public follow(entity: Entity, followDistance?: number): ActionContext {\r\n    if (followDistance === undefined) {\r\n      this._queue.add(new Follow(this._entity, entity));\r\n    } else {\r\n      this._queue.add(new Follow(this._entity, entity, followDistance));\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will cause the entity to move towards another until they\r\n   * collide \"meet\" at a specified speed.\r\n   * @param entity  The entity to meet\r\n   * @param speed  The speed in pixels per second to move, if not specified it will match the speed of the other actor\r\n   */\r\n  public meet(entity: Entity, speed?: number): ActionContext {\r\n    if (speed === undefined) {\r\n      this._queue.add(new Meet(this._entity, entity));\r\n    } else {\r\n      this._queue.add(new Meet(this._entity, entity, speed));\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Returns a promise that resolves when the current action queue up to now\r\n   * is finished.\r\n   */\r\n  public toPromise(): Promise<void> {\r\n    const temp = new Promise<void>((resolve) => {\r\n      this._queue.add(\r\n        new CallMethod(() => {\r\n          resolve();\r\n        })\r\n      );\r\n    });\r\n    return temp;\r\n  }\r\n}\r\n","import { ActionContext } from './ActionContext';\r\nimport { Component } from '../EntityComponentSystem/Component';\r\nimport { Entity } from '../EntityComponentSystem/Entity';\r\nimport { Actor } from '../Actor';\r\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { Vector } from '../Math/vector';\r\nimport { EasingFunction } from '../Util/EasingFunctions';\r\nimport { ActionQueue } from './ActionQueue';\r\nimport { RotationType } from './RotationType';\r\nimport { Action } from './Action';\r\n\r\nexport interface ActionContextMethods extends Pick<ActionContext, keyof ActionContext> { };\r\n\r\nexport class ActionsComponent extends Component<'ex.actions'> implements ActionContextMethods {\r\n  public readonly type = 'ex.actions';\r\n  dependencies = [TransformComponent, MotionComponent];\r\n  private _ctx: ActionContext;\r\n\r\n  onAdd(entity: Entity) {\r\n    this._ctx = new ActionContext(entity);\r\n  }\r\n\r\n  onRemove() {\r\n    this._ctx = null;\r\n  }\r\n\r\n  /**\r\n   * Returns the internal action queue\r\n   * @returns action queue\r\n   */\r\n  public getQueue(): ActionQueue {\r\n    return this._ctx?.getQueue();\r\n  }\r\n\r\n  public runAction(action: Action): ActionContext {\r\n    return this._ctx?.runAction(action);\r\n  }\r\n\r\n  /**\r\n   * Updates the internal action context, performing action and moving through the internal queue\r\n   * @param elapsedMs\r\n   */\r\n  public update(elapsedMs: number): void {\r\n    return this._ctx?.update(elapsedMs);\r\n  }\r\n\r\n  /**\r\n   * Clears all queued actions from the Actor\r\n   */\r\n  public clearActions(): void {\r\n    this._ctx?.clearActions();\r\n  }\r\n\r\n  /**\r\n   * This method will move an actor to the specified `x` and `y` position over the\r\n   * specified duration using a given [[EasingFunctions]] and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param pos       The x,y vector location to move the actor to\r\n   * @param duration  The time it should take the actor to move to the new location in milliseconds\r\n   * @param easingFcn Use [[EasingFunctions]] or a custom function to use to calculate position, Default is [[EasingFunctions.Linear]]\r\n   */\r\n  public easeTo(pos: Vector, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  /**\r\n   * This method will move an actor to the specified `x` and `y` position over the\r\n   * specified duration using a given [[EasingFunctions]] and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param x         The x location to move the actor to\r\n   * @param y         The y location to move the actor to\r\n   * @param duration  The time it should take the actor to move to the new location in milliseconds\r\n   * @param easingFcn Use [[EasingFunctions]] or a custom function to use to calculate position, Default is [[EasingFunctions.Linear]]\r\n   */\r\n  public easeTo(x: number, y: number, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  public easeTo(...args: any[]): ActionContext {\r\n    return this._ctx.easeTo.apply(this._ctx, args);\r\n  }\r\n\r\n  public easeBy(offset: Vector, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  public easeBy(offsetX: number, offsetY: number, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  public easeBy(...args: any[]): ActionContext {\r\n    return this._ctx.easeBy.apply(this._ctx, args);\r\n  }\r\n\r\n  /**\r\n   * This method will move an actor to the specified x and y position at the\r\n   * speed specified (in pixels per second) and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param pos    The x,y vector location to move the actor to\r\n   * @param speed  The speed in pixels per second to move\r\n   */\r\n  public moveTo(pos: Vector, speed: number): ActionContext;\r\n  /**\r\n   * This method will move an actor to the specified x and y position at the\r\n   * speed specified (in pixels per second) and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param x      The x location to move the actor to\r\n   * @param y      The y location to move the actor to\r\n   * @param speed  The speed in pixels per second to move\r\n   */\r\n  public moveTo(x: number, y: number, speed: number): ActionContext;\r\n  public moveTo(xOrPos: number | Vector, yOrSpeed: number, speedOrUndefined?: number): ActionContext {\r\n    return this._ctx.moveTo.apply(this._ctx, [xOrPos, yOrSpeed, speedOrUndefined]);\r\n  }\r\n\r\n  /**\r\n   * This method will move an actor by the specified x offset and y offset from its current position, at a certain speed.\r\n   * This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param offset The (x, y) offset to apply to this actor\r\n   * @param speed  The speed in pixels per second the actor should move\r\n   */\r\n  public moveBy(offset: Vector, speed: number): ActionContext;\r\n  /**\r\n   * This method will move an actor by the specified x offset and y offset from its current position, at a certain speed.\r\n   * This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param xOffset     The x offset to apply to this actor\r\n   * @param yOffset     The y location to move the actor to\r\n   * @param speed  The speed in pixels per second the actor should move\r\n   */\r\n  public moveBy(xOffset: number, yOffset: number, speed: number): ActionContext;\r\n  public moveBy(xOffsetOrVector: number | Vector, yOffsetOrSpeed: number, speedOrUndefined?: number): ActionContext {\r\n    return this._ctx.moveBy.apply(this._ctx, [xOffsetOrVector, yOffsetOrSpeed, speedOrUndefined]);\r\n  }\r\n\r\n  /**\r\n   * This method will rotate an actor to the specified angle at the speed\r\n   * specified (in radians per second) and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param angleRadians  The angle to rotate to in radians\r\n   * @param speed         The angular velocity of the rotation specified in radians per second\r\n   * @param rotationType  The [[RotationType]] to use for this rotation\r\n   */\r\n  public rotateTo(angleRadians: number, speed: number, rotationType?: RotationType): ActionContext {\r\n    return this._ctx.rotateTo(angleRadians, speed, rotationType);\r\n  }\r\n\r\n  /**\r\n   * This method will rotate an actor by the specified angle offset, from it's current rotation given a certain speed\r\n   * in radians/sec and return back the actor. This method is part\r\n   * of the actor 'Action' fluent API allowing action chaining.\r\n   * @param angleRadiansOffset  The angle to rotate to in radians relative to the current rotation\r\n   * @param speed          The speed in radians/sec the actor should rotate at\r\n   * @param rotationType  The [[RotationType]] to use for this rotation, default is shortest path\r\n   */\r\n  public rotateBy(angleRadiansOffset: number, speed: number, rotationType?: RotationType): ActionContext {\r\n    return this._ctx.rotateBy(angleRadiansOffset, speed, rotationType);\r\n  }\r\n\r\n  /**\r\n   * This method will scale an actor to the specified size at the speed\r\n   * specified (in magnitude increase per second) and return back the\r\n   * actor. This method is part of the actor 'Action' fluent API allowing\r\n   * action chaining.\r\n   * @param size    The scale to adjust the actor to over time\r\n   * @param speed   The speed of scaling specified in magnitude increase per second\r\n   */\r\n  public scaleTo(size: Vector, speed: Vector): ActionContext;\r\n  /**\r\n   * This method will scale an actor to the specified size at the speed\r\n   * specified (in magnitude increase per second) and return back the\r\n   * actor. This method is part of the actor 'Action' fluent API allowing\r\n   * action chaining.\r\n   * @param sizeX   The scaling factor to apply on X axis\r\n   * @param sizeY   The scaling factor to apply on Y axis\r\n   * @param speedX  The speed of scaling specified in magnitude increase per second on X axis\r\n   * @param speedY  The speed of scaling specified in magnitude increase per second on Y axis\r\n   */\r\n  public scaleTo(sizeX: number, sizeY: number, speedX: number, speedY: number): ActionContext;\r\n  public scaleTo(\r\n    sizeXOrVector: number | Vector,\r\n    sizeYOrSpeed: number | Vector,\r\n    speedXOrUndefined?: number,\r\n    speedYOrUndefined?: number): ActionContext {\r\n    return this._ctx.scaleTo.apply(this._ctx, [sizeXOrVector, sizeYOrSpeed, speedXOrUndefined, speedYOrUndefined]);\r\n  }\r\n\r\n  /**\r\n   * This method will scale an actor by an amount relative to the current scale at a certain speed in scale units/sec\r\n   * and return back the actor. This method is part of the\r\n   * actor 'Action' fluent API allowing action chaining.\r\n   * @param offset   The scaling factor to apply to the actor\r\n   * @param speed    The speed to scale at in scale units/sec\r\n   */\r\n  public scaleBy(offset: Vector, speed: number): ActionContext;\r\n  /**\r\n   * This method will scale an actor by an amount relative to the current scale at a certain speed in scale units/sec\r\n   * and return back the actor. This method is part of the\r\n   * actor 'Action' fluent API allowing action chaining.\r\n   * @param sizeOffsetX   The scaling factor to apply on X axis\r\n   * @param sizeOffsetY   The scaling factor to apply on Y axis\r\n   * @param speed    The speed to scale at in scale units/sec\r\n   */\r\n  public scaleBy(sizeOffsetX: number, sizeOffsetY: number, speed: number): ActionContext;\r\n  public scaleBy(sizeOffsetXOrVector: number | Vector, sizeOffsetYOrSpeed: number, speed?: number): ActionContext {\r\n    return this._ctx.scaleBy.apply(this._ctx, [sizeOffsetXOrVector, sizeOffsetYOrSpeed, speed]);\r\n  }\r\n\r\n  /**\r\n   * This method will cause an actor to blink (become visible and not\r\n   * visible). Optionally, you may specify the number of blinks. Specify the amount of time\r\n   * the actor should be visible per blink, and the amount of time not visible.\r\n   * This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param timeVisible     The amount of time to stay visible per blink in milliseconds\r\n   * @param timeNotVisible  The amount of time to stay not visible per blink in milliseconds\r\n   * @param numBlinks       The number of times to blink\r\n   */\r\n  public blink(timeVisible: number, timeNotVisible: number, numBlinks?: number): ActionContext {\r\n    return this._ctx.blink(timeVisible, timeNotVisible, numBlinks);\r\n  }\r\n\r\n  /**\r\n   * This method will cause an actor's opacity to change from its current value\r\n   * to the provided value by a specified time (in milliseconds). This method is\r\n   * part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param opacity  The ending opacity\r\n   * @param time     The time it should take to fade the actor (in milliseconds)\r\n   */\r\n  public fade(opacity: number, time: number): ActionContext {\r\n    return this._ctx.fade(opacity, time);\r\n  }\r\n\r\n  /**\r\n   * This method will delay the next action from executing for a certain\r\n   * amount of time (in milliseconds). This method is part of the actor\r\n   * 'Action' fluent API allowing action chaining.\r\n   * @param time  The amount of time to delay the next action in the queue from executing in milliseconds\r\n   */\r\n  public delay(time: number): ActionContext {\r\n    return this._ctx.delay(time);\r\n  }\r\n\r\n  /**\r\n   * This method will add an action to the queue that will remove the actor from the\r\n   * scene once it has completed its previous  Any actions on the\r\n   * action queue after this action will not be executed.\r\n   */\r\n  public die(): ActionContext {\r\n    return this._ctx.die();\r\n  }\r\n\r\n  /**\r\n   * This method allows you to call an arbitrary method as the next action in the\r\n   * action queue. This is useful if you want to execute code in after a specific\r\n   * action, i.e An actor arrives at a destination after traversing a path\r\n   */\r\n  public callMethod(method: () => any): ActionContext {\r\n    return this._ctx.callMethod(method);\r\n  }\r\n\r\n  /**\r\n   * This method will cause the actor to repeat all of the actions built in\r\n   * the `repeatBuilder` callback. If the number of repeats\r\n   * is not specified it will repeat forever. This method is part of\r\n   * the actor 'Action' fluent API allowing action chaining\r\n   *\r\n   * ```typescript\r\n   * // Move up in a zig-zag by repeated moveBy's\r\n   * actor.actions.repeat(repeatCtx => {\r\n   *  repeatCtx.moveBy(10, 0, 10);\r\n   *  repeatCtx.moveBy(0, 10, 10);\r\n   * }, 5);\r\n   * ```\r\n   *\r\n   * @param repeatBuilder The builder to specify the repeatable list of actions\r\n   * @param times  The number of times to repeat all the previous actions in the action queue. If nothing is specified the actions\r\n   * will repeat forever\r\n   */\r\n  public repeat(repeatBuilder: (repeatContext: ActionContext) => any, times?: number): ActionContext {\r\n    return this._ctx.repeat(repeatBuilder, times);\r\n  }\r\n\r\n  /**\r\n   * This method will cause the actor to repeat all of the actions built in\r\n   * the `repeatBuilder` callback. If the number of repeats\r\n   * is not specified it will repeat forever. This method is part of\r\n   * the actor 'Action' fluent API allowing action chaining\r\n   *\r\n   * ```typescript\r\n   * // Move up in a zig-zag by repeated moveBy's\r\n   * actor.actions.repeat(repeatCtx => {\r\n   *  repeatCtx.moveBy(10, 0, 10);\r\n   *  repeatCtx.moveBy(0, 10, 10);\r\n   * }, 5);\r\n   * ```\r\n   *\r\n   * @param repeatBuilder The builder to specify the repeatable list of actions\r\n   */\r\n  public repeatForever(repeatBuilder: (repeatContext: ActionContext) => any): ActionContext {\r\n    return this._ctx.repeatForever(repeatBuilder);\r\n  }\r\n\r\n  /**\r\n   * This method will cause the entity to follow another at a specified distance\r\n   * @param entity           The entity to follow\r\n   * @param followDistance  The distance to maintain when following, if not specified the actor will follow at the current distance.\r\n   */\r\n  public follow(entity: Actor, followDistance?: number): ActionContext {\r\n    return this._ctx.follow(entity, followDistance);\r\n  }\r\n\r\n  /**\r\n   * This method will cause the entity to move towards another until they\r\n   * collide \"meet\" at a specified speed.\r\n   * @param entity  The entity to meet\r\n   * @param speed  The speed in pixels per second to move, if not specified it will match the speed of the other actor\r\n   */\r\n  public meet(entity: Actor, speed?: number): ActionContext {\r\n    return this._ctx.meet(entity, speed);\r\n  }\r\n\r\n  /**\r\n   * Returns a promise that resolves when the current action queue up to now\r\n   * is finished.\r\n   */\r\n  public toPromise(): Promise<void> {\r\n    return this._ctx.toPromise();\r\n  }\r\n}","import { Vector } from '../Math/vector';\r\nimport { BoundingBox } from '../Collision/Index';\r\nimport { Color } from '../Color';\r\nimport { line } from '../Util/DrawUtil';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { BaseAlign, Direction, FontOptions, FontStyle, FontUnit, TextAlign, FontRenderer } from './FontCommon';\r\nimport { Graphic, GraphicOptions } from './Graphic';\r\nimport { RasterOptions } from './Raster';\r\nimport { TextureLoader } from '.';\r\nimport { ImageFiltering } from './Filtering';\r\n\r\n/**\r\n * Represents a system or web font in Excalibur\r\n *\r\n * If no options specified, the system sans-serif 10 pixel is used\r\n *\r\n * If loading a custom web font be sure to have the font loaded before you use it https://erikonarheim.com/posts/dont-test-fonts/\r\n */\r\nexport class Font extends Graphic implements FontRenderer {\r\n  /**\r\n   * Set the font filtering mode, by default set to [[ImageFiltering.Blended]] regardless of the engine default smoothing\r\n   *\r\n   * If you have a pixel style font that may be a reason to switch this to [[ImageFiltering.Pixel]]\r\n   */\r\n  public filtering: ImageFiltering = ImageFiltering.Blended;\r\n  constructor(options: FontOptions & GraphicOptions & RasterOptions = {}) {\r\n    super(options); // <- Graphics properties\r\n\r\n    // Raster properties\r\n    this.smoothing = options?.smoothing ?? this.smoothing;\r\n    this.padding = options?.padding ?? this.padding;\r\n    this.color = options?.color ?? this.color;\r\n    this.strokeColor = options?.strokeColor ?? this.strokeColor;\r\n    this.lineDash = options?.lineDash ?? this.lineDash;\r\n    this.lineWidth = options?.lineWidth ?? this.lineWidth;\r\n    this.filtering = options?.filtering ?? this.filtering;\r\n\r\n    // Font specific properties\r\n    this.family = options?.family ?? this.family;\r\n    this.style = options?.style ?? this.style;\r\n    this.bold = options?.bold ?? this.bold;\r\n    this.size = options?.size ?? this.size;\r\n    this.unit = options?.unit ?? this.unit;\r\n    this.textAlign = options?.textAlign ?? this.textAlign;\r\n    this.baseAlign = options?.baseAlign ?? this.baseAlign;\r\n    this.direction = options?.direction ?? this.direction;\r\n    this.quality = options?.quality ?? this.quality;\r\n    if (options?.shadow) {\r\n      this.shadow = {};\r\n      this.shadow.blur = options.shadow.blur ?? this.shadow.blur;\r\n      this.shadow.offset = options.shadow.offset ?? this.shadow.offset;\r\n      this.shadow.color = options.shadow.color ?? this.shadow.color;\r\n    }\r\n  }\r\n\r\n  public clone() {\r\n    return new Font({\r\n      ...this.cloneGraphicOptions(),\r\n      size: this.size,\r\n      unit: this.unit,\r\n      family: this.family,\r\n      style: this.style,\r\n      bold: this.bold,\r\n      textAlign: this.textAlign,\r\n      baseAlign: this.baseAlign,\r\n      direction: this.direction,\r\n      shadow: this.shadow\r\n        ? {\r\n          blur: this.shadow.blur,\r\n          offset: this.shadow.offset,\r\n          color: this.shadow.color\r\n        }\r\n        : null\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Font quality determines the size of the underlying raster text, higher quality means less jagged edges.\r\n   * If quality is set to 1, then just enough raster bitmap is generated to render the text.\r\n   *\r\n   * You can think of quality as how zoomed in to the text you can get before seeing jagged edges.\r\n   *\r\n   * (Default 2)\r\n   */\r\n  public quality = 2;\r\n\r\n  // Raster properties for fonts\r\n  public padding = 2;\r\n  public smoothing = false;\r\n  public lineWidth = 1;\r\n  public lineDash: number[] = [];\r\n  public color: Color = Color.Black;\r\n  public strokeColor: Color;\r\n\r\n  public family: string = 'sans-serif';\r\n  public style: FontStyle = FontStyle.Normal;\r\n  public bold: boolean = false;\r\n  public unit: FontUnit = FontUnit.Px;\r\n  public textAlign: TextAlign = TextAlign.Left;\r\n  public baseAlign: BaseAlign = BaseAlign.Alphabetic;\r\n  public direction: Direction = Direction.LeftToRight;\r\n  public size: number = 10;\r\n  public shadow: { blur?: number; offset?: Vector; color?: Color } = null;\r\n\r\n  public get fontString() {\r\n    return `${this.style} ${this.bold ? 'bold' : ''} ${this.size}${this.unit} ${this.family}`;\r\n  }\r\n\r\n  private _textBounds: BoundingBox = new BoundingBox();\r\n\r\n  public get localBounds(): BoundingBox {\r\n    return this._textBounds;\r\n  }\r\n\r\n\r\n  protected _drawImage(_ex: ExcaliburGraphicsContext, _x: number, _y: number) {\r\n    // TODO weird vestigial drawimage\r\n  }\r\n\r\n\r\n  protected _rotate(ex: ExcaliburGraphicsContext) {\r\n    // TODO this needs to change depending on the bounding box...\r\n    const origin = this.origin ?? this._textBounds.center;\r\n    ex.translate(origin.x, origin.y);\r\n    ex.rotate(this.rotation);\r\n    ex.translate(-origin.x, -origin.y);\r\n  }\r\n\r\n  protected _flip(ex: ExcaliburGraphicsContext) {\r\n    if (this.flipHorizontal) {\r\n      ex.translate(this._textBounds.width / this.scale.x, 0);\r\n      ex.scale(-1, 1);\r\n    }\r\n\r\n    if (this.flipVertical) {\r\n      ex.translate(0, -this._textBounds.height / 2 / this.scale.y);\r\n      ex.scale(1, -1);\r\n    }\r\n  }\r\n\r\n\r\n  private _cachedTextMeasurement = new Map<string, {text: string, measurement: BoundingBox, rasterProps: string}>();\r\n  private _bitmapToTextMeasurement = new Map<CanvasRenderingContext2D, {text: string, measurement: BoundingBox, rasterProps: string}>();\r\n  /**\r\n   * Returns a BoundingBox that is the total size of the text including multiple lines\r\n   *\r\n   * Does not include any padding or adjustment\r\n   * @param text\r\n   * @returns BoundingBox\r\n   */\r\n  public measureText(text: string): BoundingBox {\r\n    let measurementDirty = false;\r\n    let cached = this._cachedTextMeasurement.get(text);\r\n    if (!cached) {\r\n      measurementDirty = true;\r\n    }\r\n\r\n    const rasterProps = this._getRasterPropertiesHash();\r\n    if (!cached || rasterProps !== cached.rasterProps) {\r\n      measurementDirty = true;\r\n    }\r\n\r\n    if (measurementDirty) {\r\n      const lines = text.split('\\n');\r\n      const maxWidthLine = lines.reduce((a, b) => {\r\n        return a.length > b.length ? a : b;\r\n      });\r\n      const ctx = this._getTextBitmap(text);\r\n\r\n      this._applyFont(ctx); // font must be applied to the context to measure it\r\n      const metrics = ctx.measureText(maxWidthLine);\r\n      let textHeight = Math.abs(metrics.actualBoundingBoxAscent) + Math.abs(metrics.actualBoundingBoxDescent);\r\n\r\n      // TODO lineheight makes the text bounds wonky\r\n      const lineAdjustedHeight = textHeight * lines.length;\r\n      textHeight = lineAdjustedHeight;\r\n      const bottomBounds = lineAdjustedHeight - Math.abs(metrics.actualBoundingBoxAscent);\r\n      const x = 0;\r\n      const y = 0;\r\n      // this._cachedText = text;\r\n      // this._cachedRasterProps = rasterProps;\r\n      // this._measurementDirty = false;\r\n      const measurement = new BoundingBox({\r\n        left: x - Math.abs(metrics.actualBoundingBoxLeft) - this.padding,\r\n        top: y - Math.abs(metrics.actualBoundingBoxAscent) - this.padding,\r\n        bottom: y + bottomBounds + this.padding,\r\n        right: x + Math.abs(metrics.actualBoundingBoxRight) + this.padding\r\n      });\r\n      cached = {\r\n        text,\r\n        rasterProps,\r\n        measurement\r\n      };\r\n      this._cachedTextMeasurement.set(text, cached);\r\n      this._bitmapToTextMeasurement.set(ctx, cached);\r\n      return cached.measurement;\r\n    } else {\r\n      return cached.measurement;\r\n    }\r\n  }\r\n\r\n  private _setDimension(textBounds: BoundingBox, bitmap: CanvasRenderingContext2D) {\r\n\r\n    // Changing the width and height clears the context properties\r\n    // We double the bitmap width to account for all possible alignment\r\n    // We scale by \"quality\" so we render text without jaggies\r\n    bitmap.canvas.width = (textBounds.width + this.padding * 2) * 2 * this.quality;\r\n    bitmap.canvas.height = (textBounds.height + this.padding * 2) * 2 * this.quality;\r\n  }\r\n\r\n  protected _postDraw(ex: ExcaliburGraphicsContext): void {\r\n    ex.restore();\r\n  }\r\n\r\n  /**\r\n   * We need to identify bitmaps with more than just the text content\r\n   *\r\n   * Any properties that can change the rendering of the text\r\n   */\r\n  private _getRasterPropertiesHash(color?: Color): string {\r\n    const hash = '__hashcode__' +\r\n    this.fontString +\r\n    this.showDebug +\r\n    this.textAlign +\r\n    this.baseAlign +\r\n    this.direction +\r\n    JSON.stringify(this.shadow) +\r\n    (this.padding.toString() +\r\n    this.smoothing.toString() +\r\n    this.lineWidth.toString() +\r\n    this.lineDash.toString() +\r\n    this.strokeColor?.toString() +\r\n    ( color ? color.toString() : this.color?.toString()).toString());\r\n    return hash;\r\n  }\r\n\r\n  protected _applyRasterProperties(ctx: CanvasRenderingContext2D, color: Color) {\r\n    ctx.translate(this.padding, this.padding);\r\n    ctx.imageSmoothingEnabled = this.smoothing;\r\n    ctx.lineWidth = this.lineWidth;\r\n    ctx.setLineDash(this.lineDash ?? ctx.getLineDash());\r\n    ctx.strokeStyle = this.strokeColor?.toString();\r\n    ctx.fillStyle = color ? color.toString() : this.color?.toString();\r\n  }\r\n\r\n  private _applyFont(ctx: CanvasRenderingContext2D) {\r\n    ctx.translate(this.padding + ctx.canvas.width / 2, this.padding + ctx.canvas.height / 2);\r\n    ctx.scale(this.quality, this.quality);\r\n    ctx.textAlign = this.textAlign;\r\n    ctx.textBaseline = this.baseAlign;\r\n    ctx.font = this.fontString;\r\n    ctx.direction = this.direction;\r\n\r\n    if (this.shadow) {\r\n      ctx.shadowColor = this.shadow.color.toString();\r\n      ctx.shadowBlur = this.shadow.blur;\r\n      ctx.shadowOffsetX = this.shadow.offset.x;\r\n      ctx.shadowOffsetY = this.shadow.offset.y;\r\n    }\r\n  }\r\n\r\n  private _drawText(ctx: CanvasRenderingContext2D, text: string, colorOverride: Color, lineHeight: number): void {\r\n    const lines = text.split('\\n');\r\n    this._applyRasterProperties(ctx, colorOverride);\r\n    this._applyFont(ctx);\r\n\r\n    for (let i = 0; i < lines.length; i++) {\r\n      const line = lines[i];\r\n      if (this.color) {\r\n        ctx.fillText(line, 0, i * lineHeight);\r\n      }\r\n\r\n      if (this.strokeColor) {\r\n        ctx.strokeText(line, 0, i * lineHeight);\r\n      }\r\n    }\r\n\r\n    if (this.showDebug) {\r\n      // Horizontal line\r\n      /* istanbul ignore next */\r\n      line(ctx, Color.Red, -ctx.canvas.width / 2, 0, ctx.canvas.width / 2, 0, 2);\r\n      // Vertical line\r\n      /* istanbul ignore next */\r\n      line(ctx, Color.Red, 0, -ctx.canvas.height / 2, 0, ctx.canvas.height / 2, 2);\r\n    }\r\n  }\r\n\r\n  private _textToBitmap = new Map<string, CanvasRenderingContext2D>();\r\n  private _bitmapUsage = new Map<CanvasRenderingContext2D, number>();\r\n  private _getTextBitmap(text: string, color?: Color): CanvasRenderingContext2D {\r\n    const textAndHash = text + this._getRasterPropertiesHash(color);\r\n    const bitmap = this._textToBitmap.get(textAndHash);\r\n    if (bitmap) {\r\n      return bitmap;\r\n    }\r\n\r\n    const canvas = document.createElement('canvas');\r\n    const ctx = canvas.getContext('2d');\r\n    this._textToBitmap.set(textAndHash, ctx);\r\n    return ctx;\r\n  }\r\n\r\n  private _splitTextBitmap(bitmap: CanvasRenderingContext2D) {\r\n    const textImages: {x: number, y: number, canvas: HTMLCanvasElement}[] = [];\r\n    let currentX = 0;\r\n    let currentY = 0;\r\n    // 4k is the max for mobile devices\r\n    const width = Math.min(4096, bitmap.canvas.width);\r\n    const height = Math.min(4096, bitmap.canvas.height);\r\n\r\n    // Splits the original bitmap into 4k max chunks\r\n    while (currentX < bitmap.canvas.width) {\r\n      while (currentY < bitmap.canvas.height) {\r\n        // create new bitmap\r\n        const canvas = document.createElement('canvas');\r\n        canvas.width = width;\r\n        canvas.height = height;\r\n        const ctx = canvas.getContext('2d');\r\n\r\n        // draw current slice to new bitmap in < 4k chunks\r\n        ctx.drawImage(bitmap.canvas, currentX, currentY, width, height, 0, 0, width, height);\r\n\r\n        textImages.push({x: currentX, y: currentY, canvas});\r\n        currentY += height;\r\n      }\r\n      currentX += width;\r\n      currentY = 0;\r\n    }\r\n    return textImages;\r\n  }\r\n\r\n  private _textFragments: {x: number, y: number, canvas: HTMLCanvasElement}[] = [];\r\n  public render(ex: ExcaliburGraphicsContext, text: string, colorOverride: Color, x: number, y: number) {\r\n    if (this.showDebug) {\r\n      this.clearCache();\r\n    }\r\n    this.checkAndClearCache();\r\n    // Get bitmap for rastering text, this is cached by raster properties\r\n    const bitmap = this._getTextBitmap(text, colorOverride);\r\n    const isNewBitmap = !this._bitmapUsage.get(bitmap);\r\n\r\n    // Bounds of the text\r\n    this._textBounds = this.measureText(text);\r\n\r\n    if (isNewBitmap) {\r\n      // Setting dimension is expensive because it invalidates the bitmap\r\n      this._setDimension(this._textBounds, bitmap);\r\n    }\r\n\r\n    // Apply affine transformations\r\n    this._preDraw(ex, x, y);\r\n\r\n    const lines = text.split('\\n');\r\n    const lineHeight = this._textBounds.height / lines.length;\r\n\r\n    if (isNewBitmap) {\r\n      // draws the text to the bitmap\r\n      this._drawText(bitmap, text, colorOverride, lineHeight);\r\n\r\n      // clean up any existing fragments\r\n      for (const frag of this._textFragments) {\r\n        TextureLoader.delete(frag.canvas);\r\n      }\r\n\r\n      this._textFragments = this._splitTextBitmap(bitmap);\r\n\r\n      for (const frag of this._textFragments) {\r\n        TextureLoader.load(frag.canvas, this.filtering, true);\r\n      }\r\n    }\r\n\r\n    // draws the bitmap fragments to excalibur graphics context\r\n    for (const frag of this._textFragments) {\r\n      ex.drawImage(\r\n        frag.canvas,\r\n        0,\r\n        0,\r\n        frag.canvas.width,\r\n        frag.canvas.height,\r\n        frag.x / this.quality + x - bitmap.canvas.width / this.quality / 2,\r\n        frag.y / this.quality + y - bitmap.canvas.height / this.quality / 2,\r\n        frag.canvas.width / this.quality,\r\n        frag.canvas.height / this.quality\r\n      );\r\n    }\r\n\r\n    this._postDraw(ex);\r\n\r\n    // Cache the bitmap for certain amount of time\r\n    this._bitmapUsage.set(bitmap, performance.now());\r\n  }\r\n\r\n  /**\r\n   * Get the internal cache size of the font\r\n   * This is useful when debugging memory usage, these numbers indicate the number of cached in memory text bitmaps\r\n   */\r\n  public get cacheSize() {\r\n    return this._bitmapUsage.size;\r\n  }\r\n\r\n  /**\r\n   * Force clear all cached text bitmaps\r\n   */\r\n  public clearCache() {\r\n    this._bitmapUsage.clear();\r\n  }\r\n\r\n  /**\r\n   * Remove any expired cached text bitmaps\r\n   */\r\n  public checkAndClearCache() {\r\n    for (const [bitmap, time] of this._bitmapUsage.entries()) {\r\n      // if bitmap hasn't been used in 1 second clear it\r\n      if (time + 1000 < performance.now()) {\r\n        this._bitmapUsage.delete(bitmap);\r\n        // Cleanup measurements\r\n        const measurement = this._bitmapToTextMeasurement.get(bitmap);\r\n        if (measurement) {\r\n          this._cachedTextMeasurement.delete(measurement.text);\r\n          this._bitmapToTextMeasurement.delete(bitmap);\r\n        }\r\n        TextureLoader.delete(bitmap.canvas);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { BoundingBox } from '../Collision/BoundingBox';\r\nimport { SpriteFont } from './SpriteFont';\r\nimport { Graphic, GraphicOptions } from './Graphic';\r\nimport { Color } from '../Color';\r\nimport { Font } from './Font';\r\n\r\nexport interface TextOptions {\r\n  /**\r\n   * Text to draw\r\n   */\r\n  text: string;\r\n\r\n  /**\r\n   * Optionally override the font color, currently unsupported by SpriteFont\r\n   */\r\n  color?: Color;\r\n\r\n  /**\r\n   * Optionally specify a font, if none specified a default font is used (System sans-serif 10 pixel)\r\n   */\r\n  font?: Font | SpriteFont;\r\n}\r\n\r\n/**\r\n * Represent Text graphics in excalibur\r\n *\r\n * Useful for in game labels, ui, or overlays\r\n */\r\nexport class Text extends Graphic {\r\n  public color?: Color;\r\n  constructor(options: TextOptions & GraphicOptions) {\r\n    super(options);\r\n    // This order is important font, color, then text\r\n    this.font = options.font ?? new Font();\r\n    this.color = options.color ?? this.color;\r\n    this.text = options.text;\r\n  }\r\n\r\n  public clone(): Text {\r\n    return new Text({\r\n      text: this.text.slice(),\r\n      color: this.color?.clone() ?? Color.Black,\r\n      font: this.font.clone()\r\n    });\r\n  }\r\n\r\n  private _text: string = '';\r\n  public get text() {\r\n    return this._text;\r\n  }\r\n\r\n  public set text(value: string) {\r\n    this._text = value;\r\n    const bounds = this.font.measureText(this._text);\r\n    this._textWidth = bounds.width;\r\n    this._textHeight = bounds.height;\r\n  }\r\n\r\n  private _font: Font | SpriteFont;\r\n  public get font(): Font | SpriteFont {\r\n    return this._font;\r\n  }\r\n  public set font(font: Font | SpriteFont) {\r\n    this._font = font;\r\n  }\r\n\r\n  private _textWidth: number = 0;\r\n\r\n  public get width() {\r\n    if (this._textWidth === 0) {\r\n      this._calculateDimension();\r\n    }\r\n    return this._textWidth * this.scale.x;\r\n  }\r\n\r\n  private _textHeight: number = 0;\r\n  public get height() {\r\n    if (this._textHeight === 0) {\r\n      this._calculateDimension();\r\n    }\r\n    return this._textHeight * this.scale.y;\r\n  }\r\n\r\n  private _calculateDimension() {\r\n    const { width, height } = this.font.measureText(this._text);\r\n    this._textWidth = width;\r\n    this._textHeight = height;\r\n  }\r\n\r\n  public get localBounds(): BoundingBox {\r\n    return this.font.measureText(this._text).scale(this.scale);\r\n  }\r\n\r\n  protected override _rotate(_ex: ExcaliburGraphicsContext) {\r\n    // None this is delegated to font\r\n    // This override erases the default behavior\r\n  }\r\n\r\n  protected override _flip(_ex: ExcaliburGraphicsContext) {\r\n    // None this is delegated to font\r\n    // This override erases the default behavior\r\n  }\r\n\r\n  protected override _drawImage(ex: ExcaliburGraphicsContext, x: number, y: number) {\r\n    let color = Color.Black;\r\n    if (this.font instanceof Font) {\r\n      color = this.color ?? this.font.color;\r\n    }\r\n\r\n    if (this.isStale() || this.font.isStale()) {\r\n      this.font.flipHorizontal = this.flipHorizontal;\r\n      this.font.flipVertical = this.flipVertical;\r\n      this.font.rotation = this.rotation;\r\n      this.font.origin = this.origin;\r\n      this.font.opacity = this.opacity;\r\n    }\r\n    this.font.tint = this.tint;\r\n\r\n    const { width, height } = this.font.measureText(this._text);\r\n    this._textWidth = width;\r\n    this._textHeight = height;\r\n\r\n    this.font.render(ex, this._text, color, x, y);\r\n    if (this.font.showDebug) {\r\n      ex.debug.drawRect(x - width, y - height, width * 2, height * 2);\r\n    }\r\n  }\r\n}\r\n","import {\r\n  InitializeEvent,\r\n  KillEvent,\r\n  PreUpdateEvent,\r\n  PostUpdateEvent,\r\n  PostCollisionEvent,\r\n  PreCollisionEvent,\r\n  CollisionStartEvent,\r\n  CollisionEndEvent,\r\n  PostKillEvent,\r\n  PreKillEvent,\r\n  GameEvent,\r\n  ExitTriggerEvent,\r\n  EnterTriggerEvent,\r\n  EnterViewPortEvent,\r\n  ExitViewPortEvent\r\n} from './Events';\r\nimport { Engine } from './Engine';\r\nimport { Color } from './Color';\r\nimport { CanInitialize, CanUpdate, CanBeKilled } from './Interfaces/LifecycleEvents';\r\nimport { Scene } from './Scene';\r\nimport { Logger } from './Util/Log';\r\nimport { Vector, vec } from './Math/vector';\r\nimport { BodyComponent } from './Collision/BodyComponent';\r\nimport { Eventable } from './Interfaces/Evented';\r\nimport * as Events from './Events';\r\nimport { PointerEvents } from './Interfaces/PointerEventHandlers';\r\nimport { CollisionType } from './Collision/CollisionType';\r\n\r\nimport { Entity } from './EntityComponentSystem/Entity';\r\nimport { TransformComponent } from './EntityComponentSystem/Components/TransformComponent';\r\nimport { MotionComponent } from './EntityComponentSystem/Components/MotionComponent';\r\nimport { GraphicsComponent } from './Graphics/GraphicsComponent';\r\nimport { Rectangle } from './Graphics/Rectangle';\r\nimport { ColliderComponent } from './Collision/ColliderComponent';\r\nimport { Shape } from './Collision/Colliders/Shape';\r\nimport { watch } from './Util/Watch';\r\nimport { Collider, CollisionGroup } from './Collision/Index';\r\nimport { Circle } from './Graphics/Circle';\r\nimport { PointerEvent } from './Input/PointerEvent';\r\nimport { WheelEvent } from './Input/WheelEvent';\r\nimport { PointerComponent } from './Input/PointerComponent';\r\nimport { ActionsComponent } from './Actions/ActionsComponent';\r\nimport { Raster } from './Graphics/Raster';\r\nimport { Text } from './Graphics/Text';\r\nimport { CoordPlane } from './Math/coord-plane';\r\n\r\n/**\r\n * Type guard for checking if something is an Actor\r\n * @param x\r\n */\r\nexport function isActor(x: any): x is Actor {\r\n  return x instanceof Actor;\r\n}\r\n\r\n/**\r\n * Actor contructor options\r\n */\r\nexport interface ActorArgs {\r\n  /**\r\n   * Optionally set the name of the actor, default is 'anonymous'\r\n   */\r\n  name?: string;\r\n  /**\r\n   * Optionally set the x position of the actor, default is 0\r\n   */\r\n  x?: number;\r\n  /**\r\n   * Optionally set the y position of the actor, default is 0\r\n   */\r\n  y?: number;\r\n  /**\r\n   * Optionally set the (x, y) position of the actor as a vector, default is (0, 0)\r\n   */\r\n  pos?: Vector;\r\n  /**\r\n   * Optionally set the coordinate plane of the actor, default is [[CoordPlane.World]] meaning actor is subject to camera positioning\r\n   */\r\n  coordPlane?: CoordPlane;\r\n  /**\r\n   * Optionally set the width of a box collider for the actor\r\n   */\r\n  width?: number;\r\n  /**\r\n   * Optionally set the height of a box collider for the actor\r\n   */\r\n  height?: number;\r\n  /**\r\n   * Optionally set the radius of the circle collider for the actor\r\n   */\r\n  radius?: number;\r\n  /**\r\n   * Optionally set the velocity of the actor in pixels/sec\r\n   */\r\n  vel?: Vector;\r\n  /**\r\n   * Optionally set the acceleration of the actor in pixels/sec^2\r\n   */\r\n  acc?: Vector;\r\n  /**\r\n   * Optionally se the rotation in radians (180 degrees = Math.PI radians)\r\n   */\r\n  rotation?: number;\r\n  /**\r\n   * Optionally set the angular velocity of the actor in radians/sec (180 degrees = Math.PI radians)\r\n   */\r\n  angularVelocity?: number;\r\n  /**\r\n   * Optionally set the scale of the actor's transform\r\n   */\r\n  scale?: Vector;\r\n  /**\r\n   * Optionally set the z index of the actor, default is 0\r\n   */\r\n  z?: number;\r\n  /**\r\n   * Optionally set the color of an actor, only used if no graphics are present\r\n   * If a width/height or a radius was set a default graphic will be added\r\n   */\r\n  color?: Color;\r\n  /**\r\n   * Optionally set the visibility of the actor\r\n   */\r\n  visible?: boolean;\r\n  /**\r\n   * Optionally set the anchor for graphics in the actor\r\n   */\r\n  anchor?: Vector;\r\n  /**\r\n   * Optionally set the collision type\r\n   */\r\n  collisionType?: CollisionType;\r\n  /**\r\n   * Optionally supply a collider for an actor, if supplied ignores any supplied width/height\r\n   */\r\n  collider?: Collider;\r\n  /**\r\n   * Optionally suppy a [[CollisionGroup]]\r\n   */\r\n  collisionGroup?: CollisionGroup;\r\n}\r\n\r\n/**\r\n * The most important primitive in Excalibur is an `Actor`. Anything that\r\n * can move on the screen, collide with another `Actor`, respond to events,\r\n * or interact with the current scene, must be an actor. An `Actor` **must**\r\n * be part of a [[Scene]] for it to be drawn to the screen.\r\n */\r\nexport class Actor extends Entity implements Eventable, PointerEvents, CanInitialize, CanUpdate, CanBeKilled {\r\n  // #region Properties\r\n\r\n  /**\r\n   * Set defaults for all Actors\r\n   */\r\n  public static defaults = {\r\n    anchor: Vector.Half\r\n  };\r\n\r\n  /**\r\n   * The physics body the is associated with this actor. The body is the container for all physical properties, like position, velocity,\r\n   * acceleration, mass, inertia, etc.\r\n   */\r\n  public get body(): BodyComponent {\r\n    return this.get(BodyComponent);\r\n  }\r\n\r\n  /**\r\n   * Access the Actor's built in [[TransformComponent]]\r\n   */\r\n  public get transform(): TransformComponent {\r\n    return this.get(TransformComponent);\r\n  }\r\n\r\n  /**\r\n   * Access the Actor's built in [[MotionComponent]]\r\n   */\r\n  public get motion(): MotionComponent {\r\n    return this.get(MotionComponent);\r\n  }\r\n\r\n  /**\r\n   * Access to the Actor's built in [[GraphicsComponent]]\r\n   */\r\n  public get graphics(): GraphicsComponent {\r\n    return this.get(GraphicsComponent);\r\n  }\r\n\r\n  /**\r\n   * Access to the Actor's built in [[ColliderComponent]]\r\n   */\r\n  public get collider(): ColliderComponent {\r\n    return this.get(ColliderComponent);\r\n  }\r\n\r\n  /**\r\n   * Access to the Actor's built in [[PointerComponent]] config\r\n   */\r\n  public get pointer(): PointerComponent {\r\n    return this.get(PointerComponent);\r\n  }\r\n\r\n  /**\r\n   * Useful for quickly scripting actor behavior, like moving to a place, patrolling back and forth, blinking, etc.\r\n   *\r\n   *  Access to the Actor's built in [[ActionsComponent]] which forwards to the\r\n   * [[ActionContext|Action context]] of the actor.\r\n   */\r\n  public get actions(): ActionsComponent {\r\n    return this.get(ActionsComponent);\r\n  }\r\n\r\n  /**\r\n   * Gets the position vector of the actor in pixels\r\n   */\r\n  public get pos(): Vector {\r\n    return this.transform.pos;\r\n  }\r\n\r\n  /**\r\n   * Sets the position vector of the actor in pixels\r\n   */\r\n  public set pos(thePos: Vector) {\r\n    this.transform.pos = thePos.clone();\r\n  }\r\n\r\n  /**\r\n   * Gets the position vector of the actor from the last frame\r\n   */\r\n  public get oldPos(): Vector {\r\n    return this.body.oldPos;\r\n  }\r\n\r\n  /**\r\n   * Sets the position vector of the actor in the last frame\r\n   */\r\n  public set oldPos(thePos: Vector) {\r\n    this.body.oldPos.setTo(thePos.x, thePos.y);\r\n  }\r\n\r\n  /**\r\n   * Gets the velocity vector of the actor in pixels/sec\r\n   */\r\n  public get vel(): Vector {\r\n    return this.motion.vel;\r\n  }\r\n\r\n  /**\r\n   * Sets the velocity vector of the actor in pixels/sec\r\n   */\r\n  public set vel(theVel: Vector) {\r\n    this.motion.vel = theVel.clone();\r\n  }\r\n\r\n  /**\r\n   * Gets the velocity vector of the actor from the last frame\r\n   */\r\n  public get oldVel(): Vector {\r\n    return this.body.oldVel;\r\n  }\r\n\r\n  /**\r\n   * Sets the velocity vector of the actor from the last frame\r\n   */\r\n  public set oldVel(theVel: Vector) {\r\n    this.body.oldVel.setTo(theVel.x, theVel.y);\r\n  }\r\n\r\n  /**\r\n   * Gets the acceleration vector of the actor in pixels/second/second. An acceleration pointing down such as (0, 100) may be\r\n   * useful to simulate a gravitational effect.\r\n   */\r\n  public get acc(): Vector {\r\n    return this.motion.acc;\r\n  }\r\n\r\n  /**\r\n   * Sets the acceleration vector of teh actor in pixels/second/second\r\n   */\r\n  public set acc(theAcc: Vector) {\r\n    this.motion.acc = theAcc.clone();\r\n  }\r\n\r\n  /**\r\n   * Sets the acceleration of the actor from the last frame. This does not include the global acc [[Physics.acc]].\r\n   */\r\n  public set oldAcc(theAcc: Vector) {\r\n    this.body.oldAcc.setTo(theAcc.x, theAcc.y);\r\n  }\r\n\r\n  /**\r\n   * Gets the acceleration of the actor from the last frame. This does not include the global acc [[Physics.acc]].\r\n   */\r\n  public get oldAcc(): Vector {\r\n    return this.body.oldAcc;\r\n  }\r\n\r\n  /**\r\n   * Gets the rotation of the actor in radians. 1 radian = 180/PI Degrees.\r\n   */\r\n  public get rotation(): number {\r\n    return this.transform.rotation;\r\n  }\r\n\r\n  /**\r\n   * Sets the rotation of the actor in radians. 1 radian = 180/PI Degrees.\r\n   */\r\n  public set rotation(theAngle: number) {\r\n    this.transform.rotation = theAngle;\r\n  }\r\n\r\n  /**\r\n   * Gets the rotational velocity of the actor in radians/second\r\n   */\r\n  public get angularVelocity(): number {\r\n    return this.motion.angularVelocity;\r\n  }\r\n\r\n  /**\r\n   * Sets the rotational velocity of the actor in radians/sec\r\n   */\r\n  public set angularVelocity(angularVelocity: number) {\r\n    this.motion.angularVelocity = angularVelocity;\r\n  }\r\n\r\n  public get scale(): Vector {\r\n    return this.get(TransformComponent).scale;\r\n  }\r\n\r\n  public set scale(scale: Vector) {\r\n    this.get(TransformComponent).scale = scale;\r\n  }\r\n\r\n  /**\r\n   * The anchor to apply all actor related transformations like rotation,\r\n   * translation, and scaling. By default the anchor is in the center of\r\n   * the actor. By default it is set to the center of the actor (.5, .5)\r\n   *\r\n   * An anchor of (.5, .5) will ensure that drawings are centered.\r\n   *\r\n   * Use `anchor.setTo` to set the anchor to a different point using\r\n   * values between 0 and 1. For example, anchoring to the top-left would be\r\n   * `Actor.anchor.setTo(0, 0)` and top-right would be `Actor.anchor.setTo(0, 1)`.\r\n   */\r\n  private _anchor: Vector = watch(Vector.Half, (v) => this._handleAnchorChange(v));\r\n  public get anchor(): Vector {\r\n    return this._anchor;\r\n  }\r\n\r\n  public set anchor(vec: Vector) {\r\n    this._anchor = watch(vec, (v) => this._handleAnchorChange(v));\r\n    this._handleAnchorChange(vec);\r\n  }\r\n\r\n  private _handleAnchorChange(v: Vector) {\r\n    if (this.graphics) {\r\n      this.graphics.anchor = v;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Indicates whether the actor is physically in the viewport\r\n   */\r\n  public get isOffScreen(): boolean {\r\n    return this.hasTag('ex.offscreen');\r\n  }\r\n\r\n  /**\r\n   * Convenience reference to the global logger\r\n   */\r\n  public logger: Logger = Logger.getInstance();\r\n\r\n  /**\r\n   * The scene that the actor is in\r\n   */\r\n  public scene: Scene = null;\r\n\r\n  /**\r\n   * Draggable helper\r\n   */\r\n  private _draggable: boolean = false;\r\n  private _dragging: boolean = false;\r\n\r\n  private _pointerDragStartHandler = () => {\r\n    this._dragging = true;\r\n  };\r\n\r\n  private _pointerDragEndHandler = () => {\r\n    this._dragging = false;\r\n  };\r\n\r\n  private _pointerDragMoveHandler = (pe: PointerEvent) => {\r\n    if (this._dragging) {\r\n      this.pos = pe.worldPos;\r\n    }\r\n  };\r\n\r\n  private _pointerDragLeaveHandler = (pe: PointerEvent) => {\r\n    if (this._dragging) {\r\n      this.pos = pe.worldPos;\r\n    }\r\n  };\r\n\r\n  public get draggable(): boolean {\r\n    return this._draggable;\r\n  }\r\n\r\n  public set draggable(isDraggable: boolean) {\r\n    if (isDraggable) {\r\n      if (isDraggable && !this._draggable) {\r\n        this.on('pointerdragstart', this._pointerDragStartHandler);\r\n        this.on('pointerdragend', this._pointerDragEndHandler);\r\n        this.on('pointerdragmove', this._pointerDragMoveHandler);\r\n        this.on('pointerdragleave', this._pointerDragLeaveHandler);\r\n      } else if (!isDraggable && this._draggable) {\r\n        this.off('pointerdragstart', this._pointerDragStartHandler);\r\n        this.off('pointerdragend', this._pointerDragEndHandler);\r\n        this.off('pointerdragmove', this._pointerDragMoveHandler);\r\n        this.off('pointerdragleave', this._pointerDragLeaveHandler);\r\n      }\r\n\r\n      this._draggable = isDraggable;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Sets the color of the actor's current graphic\r\n   */\r\n  public get color(): Color {\r\n    return this._color;\r\n  }\r\n  public set color(v: Color) {\r\n    this._color = v.clone();\r\n    const defaultLayer = this.graphics.layers.default;\r\n    const currentGraphic = defaultLayer.graphics[0]?.graphic;\r\n    if (currentGraphic instanceof Raster || currentGraphic instanceof Text) {\r\n      currentGraphic.color = this._color;\r\n    }\r\n  }\r\n  private _color: Color;\r\n\r\n  // #endregion\r\n\r\n  /**\r\n   *\r\n   * @param config\r\n   */\r\n  constructor(config?: ActorArgs) {\r\n    super();\r\n\r\n    const {\r\n      name,\r\n      x,\r\n      y,\r\n      pos,\r\n      coordPlane,\r\n      scale,\r\n      width,\r\n      height,\r\n      radius,\r\n      collider,\r\n      vel,\r\n      acc,\r\n      rotation,\r\n      angularVelocity,\r\n      z,\r\n      color,\r\n      visible,\r\n      anchor,\r\n      collisionType,\r\n      collisionGroup\r\n    } = {\r\n      ...config\r\n    };\r\n\r\n    this._setName(name);\r\n    this.anchor = anchor ?? Actor.defaults.anchor.clone();\r\n    const tx = new TransformComponent();\r\n    this.addComponent(tx);\r\n    this.pos = pos ?? vec(x ?? 0, y ?? 0);\r\n    this.rotation = rotation ?? 0;\r\n    this.scale = scale ?? vec(1, 1);\r\n    this.z = z ?? 0;\r\n    tx.coordPlane = coordPlane ?? CoordPlane.World;\r\n\r\n    this.addComponent(new PointerComponent);\r\n\r\n    this.addComponent(new GraphicsComponent({\r\n      anchor: this.anchor\r\n    }));\r\n    this.addComponent(new MotionComponent());\r\n    this.vel = vel ?? Vector.Zero;\r\n    this.acc = acc ?? Vector.Zero;\r\n    this.angularVelocity = angularVelocity ?? 0;\r\n\r\n    this.addComponent(new ActionsComponent());\r\n\r\n    this.addComponent(new BodyComponent());\r\n    this.body.collisionType = collisionType ?? CollisionType.Passive;\r\n    if (collisionGroup) {\r\n      this.body.group = collisionGroup;\r\n    }\r\n\r\n    if (collider) {\r\n      this.addComponent(new ColliderComponent(collider));\r\n    } else if (radius) {\r\n      this.addComponent(new ColliderComponent(Shape.Circle(radius)));\r\n    } else {\r\n      if (width > 0 && height > 0) {\r\n        this.addComponent(new ColliderComponent(Shape.Box(width, height, this.anchor)));\r\n      } else {\r\n        this.addComponent(new ColliderComponent()); // no collider\r\n      }\r\n    }\r\n\r\n    this.graphics.visible = visible ?? true;\r\n\r\n    if (color) {\r\n      this.color = color;\r\n      if (width && height) {\r\n        this.graphics.add(\r\n          new Rectangle({\r\n            color: color,\r\n            width,\r\n            height\r\n          })\r\n        );\r\n      } else if (radius) {\r\n        this.graphics.add(\r\n          new Circle({\r\n            color: color,\r\n            radius\r\n          })\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * `onInitialize` is called before the first update of the actor. This method is meant to be\r\n   * overridden. This is where initialization of child actors should take place.\r\n   *\r\n   * Synonymous with the event handler `.on('initialize', (evt) => {...})`\r\n   */\r\n  public onInitialize(_engine: Engine): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Initializes this actor and all it's child actors, meant to be called by the Scene before first update not by users of Excalibur.\r\n   *\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * @internal\r\n   */\r\n  public _initialize(engine: Engine) {\r\n    super._initialize(engine);\r\n    for (const child of this.children) {\r\n      child._initialize(engine);\r\n    }\r\n  }\r\n\r\n  // #region Events\r\n\r\n  public on(eventName: Events.exittrigger, handler: (event: ExitTriggerEvent) => void): void;\r\n  public on(eventName: Events.entertrigger, handler: (event: EnterTriggerEvent) => void): void;\r\n  /**\r\n   * The **collisionstart** event is fired when a [[BodyComponent|physics body]], usually attached to an actor,\r\n   *  first starts colliding with another [[BodyComponent|body]], and will not fire again while in contact until\r\n   *  the the pair separates and collides again.\r\n   * Use cases for the **collisionstart** event may be detecting when an actor has touched a surface\r\n   * (like landing) or if a item has been touched and needs to be picked up.\r\n   */\r\n  public on(eventName: Events.collisionstart, handler: (event: CollisionStartEvent) => void): void;\r\n  /**\r\n   * The **collisionend** event is fired when two [[BodyComponent|physics bodies]] are no longer in contact.\r\n   * This event will not fire again until another collision and separation.\r\n   *\r\n   * Use cases for the **collisionend** event might be to detect when an actor has left a surface\r\n   * (like jumping) or has left an area.\r\n   */\r\n  public on(eventName: Events.collisionend, handler: (event: CollisionEndEvent) => void): void;\r\n  /**\r\n   * The **precollision** event is fired **every frame** where a collision pair is found and two\r\n   * bodies are intersecting.\r\n   *\r\n   * This event is useful for building in custom collision resolution logic in Passive-Passive or\r\n   * Active-Passive scenarios. For example in a breakout game you may want to tweak the angle of\r\n   * ricochet of the ball depending on which side of the paddle you hit.\r\n   */\r\n  public on(eventName: Events.precollision, handler: (event: PreCollisionEvent) => void): void;\r\n  /**\r\n   * The **postcollision** event is fired for **every frame** where collision resolution was performed.\r\n   * Collision resolution is when two bodies influence each other and cause a response like bouncing\r\n   * off one another. It is only possible to have *postcollision* event in Active-Active and Active-Fixed\r\n   * type collision pairs.\r\n   *\r\n   * Post collision would be useful if you need to know that collision resolution is happening or need to\r\n   * tweak the default resolution.\r\n   */\r\n  public on(eventName: Events.postcollision, handler: (event: PostCollisionEvent) => void): void;\r\n  public on(eventName: Events.kill, handler: (event: KillEvent) => void): void;\r\n  public on(eventName: Events.prekill, handler: (event: PreKillEvent) => void): void;\r\n  public on(eventName: Events.postkill, handler: (event: PostKillEvent) => void): void;\r\n  public on(eventName: Events.initialize, handler: (event: InitializeEvent<Actor>) => void): void;\r\n  public on(eventName: Events.preupdate, handler: (event: PreUpdateEvent<Actor>) => void): void;\r\n  public on(eventName: Events.postupdate, handler: (event: PostUpdateEvent<Actor>) => void): void;\r\n  public on(eventName: Events.pointerup, handler: (event: PointerEvent) => void): void;\r\n  public on(eventName: Events.pointerdown, handler: (event: PointerEvent) => void): void;\r\n  public on(eventName: Events.pointerenter, handler: (event: PointerEvent) => void): void;\r\n  public on(eventName: Events.pointerleave, handler: (event: PointerEvent) => void): void;\r\n  public on(eventName: Events.pointermove, handler: (event: PointerEvent) => void): void;\r\n  public on(eventName: Events.pointercancel, handler: (event: PointerEvent) => void): void;\r\n  public on(eventName: Events.pointerwheel, handler: (event: WheelEvent) => void): void;\r\n  public on(eventName: Events.pointerdragstart, handler: (event: PointerEvent) => void): void;\r\n  public on(eventName: Events.pointerdragend, handler: (event: PointerEvent) => void): void;\r\n  public on(eventName: Events.pointerdragenter, handler: (event: PointerEvent) => void): void;\r\n  public on(eventName: Events.pointerdragleave, handler: (event: PointerEvent) => void): void;\r\n  public on(eventName: Events.pointerdragmove, handler: (event: PointerEvent) => void): void;\r\n  public on(eventName: Events.enterviewport, handler: (event: EnterViewPortEvent) => void): void;\r\n  public on(eventName: Events.exitviewport, handler: (event: ExitViewPortEvent) => void): void;\r\n  public on(eventName: string, handler: (event: GameEvent<Actor>) => void): void;\r\n  public on(eventName: string, handler: (event: any) => void): void {\r\n    super.on(eventName, handler);\r\n  }\r\n\r\n  public once(eventName: Events.exittrigger, handler: (event: ExitTriggerEvent) => void): void;\r\n  public once(eventName: Events.entertrigger, handler: (event: EnterTriggerEvent) => void): void;\r\n  /**\r\n   * The **collisionstart** event is fired when a [[BodyComponent|physics body]], usually attached to an actor,\r\n   *  first starts colliding with another [[BodyComponent|body]], and will not fire again while in contact until\r\n   *  the the pair separates and collides again.\r\n   * Use cases for the **collisionstart** event may be detecting when an actor has touch a surface\r\n   * (like landing) or if a item has been touched and needs to be picked up.\r\n   */\r\n  public once(eventName: Events.collisionstart, handler: (event: CollisionStartEvent) => void): void;\r\n  /**\r\n   * The **collisionend** event is fired when two [[BodyComponent|physics bodies]] are no longer in contact.\r\n   * This event will not fire again until another collision and separation.\r\n   *\r\n   * Use cases for the **collisionend** event might be to detect when an actor has left a surface\r\n   * (like jumping) or has left an area.\r\n   */\r\n  public once(eventName: Events.collisionend, handler: (event: CollisionEndEvent) => void): void;\r\n  /**\r\n   * The **precollision** event is fired **every frame** where a collision pair is found and two\r\n   * bodies are intersecting.\r\n   *\r\n   * This event is useful for building in custom collision resolution logic in Passive-Passive or\r\n   * Active-Passive scenarios. For example in a breakout game you may want to tweak the angle of\r\n   * ricochet of the ball depending on which side of the paddle you hit.\r\n   */\r\n  public once(eventName: Events.precollision, handler: (event: PreCollisionEvent) => void): void;\r\n  /**\r\n   * The **postcollision** event is fired for **every frame** where collision resolution was performed.\r\n   * Collision resolution is when two bodies influence each other and cause a response like bouncing\r\n   * off one another. It is only possible to have *postcollision* event in Active-Active and Active-Fixed\r\n   * type collision pairs.\r\n   *\r\n   * Post collision would be useful if you need to know that collision resolution is happening or need to\r\n   * tweak the default resolution.\r\n   */\r\n  public once(eventName: Events.postcollision, handler: (event: PostCollisionEvent) => void): void;\r\n  public once(eventName: Events.kill, handler: (event: KillEvent) => void): void;\r\n  public once(eventName: Events.postkill, handler: (event: PostKillEvent) => void): void;\r\n  public once(eventName: Events.prekill, handler: (event: PreKillEvent) => void): void;\r\n  public once(eventName: Events.initialize, handler: (event: InitializeEvent<Actor>) => void): void;\r\n  public once(eventName: Events.preupdate, handler: (event: PreUpdateEvent<Actor>) => void): void;\r\n  public once(eventName: Events.postupdate, handler: (event: PostUpdateEvent<Actor>) => void): void;\r\n  public once(eventName: Events.pointerup, handler: (event: PointerEvent) => void): void;\r\n  public once(eventName: Events.pointerdown, handler: (event: PointerEvent) => void): void;\r\n  public once(eventName: Events.pointerenter, handler: (event: PointerEvent) => void): void;\r\n  public once(eventName: Events.pointerleave, handler: (event: PointerEvent) => void): void;\r\n  public once(eventName: Events.pointermove, handler: (event: PointerEvent) => void): void;\r\n  public once(eventName: Events.pointercancel, handler: (event: PointerEvent) => void): void;\r\n  public once(eventName: Events.pointerwheel, handler: (event: WheelEvent) => void): void;\r\n  public once(eventName: Events.pointerdragstart, handler: (event: PointerEvent) => void): void;\r\n  public once(eventName: Events.pointerdragend, handler: (event: PointerEvent) => void): void;\r\n  public once(eventName: Events.pointerdragenter, handler: (event: PointerEvent) => void): void;\r\n  public once(eventName: Events.pointerdragleave, handler: (event: PointerEvent) => void): void;\r\n  public once(eventName: Events.pointerdragmove, handler: (event: PointerEvent) => void): void;\r\n  public once(eventName: Events.enterviewport, handler: (event: EnterViewPortEvent) => void): void;\r\n  public once(eventName: Events.exitviewport, handler: (event: ExitViewPortEvent) => void): void;\r\n  public once(eventName: string, handler: (event: GameEvent<Actor>) => void): void;\r\n  public once(eventName: string, handler: (event: any) => void): void {\r\n    super.once(eventName, handler);\r\n  }\r\n\r\n  public off(eventName: Events.exittrigger, handler?: (event: ExitTriggerEvent) => void): void;\r\n  public off(eventName: Events.entertrigger, handler?: (event: EnterTriggerEvent) => void): void;\r\n  /**\r\n   * The **collisionstart** event is fired when a [[BodyComponent|physics body]], usually attached to an actor,\r\n   *  first starts colliding with another [[BodyComponent|body]], and will not fire again while in contact until\r\n   *  the the pair separates and collides again.\r\n   * Use cases for the **collisionstart** event may be detecting when an actor has touch a surface\r\n   * (like landing) or if a item has been touched and needs to be picked up.\r\n   */\r\n  public off(eventName: Events.collisionstart, handler?: (event: CollisionStartEvent) => void): void;\r\n  /**\r\n   * The **collisionend** event is fired when two [[BodyComponent|physics bodies]] are no longer in contact.\r\n   * This event will not fire again until another collision and separation.\r\n   *\r\n   * Use cases for the **collisionend** event might be to detect when an actor has left a surface\r\n   * (like jumping) or has left an area.\r\n   */\r\n  public off(eventName: Events.collisionend, handler?: (event: CollisionEndEvent) => void): void;\r\n  /**\r\n   * The **precollision** event is fired **every frame** where a collision pair is found and two\r\n   * bodies are intersecting.\r\n   *\r\n   * This event is useful for building in custom collision resolution logic in Passive-Passive or\r\n   * Active-Passive scenarios. For example in a breakout game you may want to tweak the angle of\r\n   * ricochet of the ball depending on which side of the paddle you hit.\r\n   */\r\n  public off(eventName: Events.precollision, handler?: (event: PreCollisionEvent) => void): void;\r\n  /**\r\n   * The **postcollision** event is fired for **every frame** where collision resolution was performed.\r\n   * Collision resolution is when two bodies influence each other and cause a response like bouncing\r\n   * off one another. It is only possible to have *postcollision* event in Active-Active and Active-Fixed\r\n   * type collision pairs.\r\n   *\r\n   * Post collision would be useful if you need to know that collision resolution is happening or need to\r\n   * tweak the default resolution.\r\n   */\r\n  public off(eventName: Events.postcollision, handler: (event: PostCollisionEvent) => void): void;\r\n  public off(eventName: Events.pointerup, handler?: (event: PointerEvent) => void): void;\r\n  public off(eventName: Events.pointerdown, handler?: (event: PointerEvent) => void): void;\r\n  public off(eventName: Events.pointerenter, handler?: (event: PointerEvent) => void): void;\r\n  public off(eventName: Events.pointerleave, handler?: (event: PointerEvent) => void): void;\r\n  public off(eventName: Events.pointermove, handler?: (event: PointerEvent) => void): void;\r\n  public off(eventName: Events.pointercancel, handler?: (event: PointerEvent) => void): void;\r\n  public off(eventName: Events.pointerwheel, handler?: (event: WheelEvent) => void): void;\r\n  public off(eventName: Events.pointerdragstart, handler?: (event: PointerEvent) => void): void;\r\n  public off(eventName: Events.pointerdragend, handler?: (event: PointerEvent) => void): void;\r\n  public off(eventName: Events.pointerdragenter, handler?: (event: PointerEvent) => void): void;\r\n  public off(eventName: Events.pointerdragleave, handler?: (event: PointerEvent) => void): void;\r\n  public off(eventName: Events.pointerdragmove, handler?: (event: PointerEvent) => void): void;\r\n  public off(eventName: Events.prekill, handler?: (event: PreKillEvent) => void): void;\r\n  public off(eventName: Events.postkill, handler?: (event: PostKillEvent) => void): void;\r\n  public off(eventName: Events.initialize, handler?: (event: Events.InitializeEvent<Actor>) => void): void;\r\n  public off(eventName: Events.postupdate, handler?: (event: Events.PostUpdateEvent<Actor>) => void): void;\r\n  public off(eventName: Events.preupdate, handler?: (event: Events.PreUpdateEvent<Actor>) => void): void;\r\n  public off(eventName: Events.enterviewport, handler?: (event: EnterViewPortEvent) => void): void;\r\n  public off(eventName: Events.exitviewport, handler?: (event: ExitViewPortEvent) => void): void;\r\n  public off(eventName: string, handler?: (event: GameEvent<Actor>) => void): void;\r\n  public off(eventName: string, handler?: (event: any) => void): void {\r\n    super.off(eventName, handler);\r\n  }\r\n\r\n  // #endregion\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _prekill handler for [[onPreKill]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _prekill(_scene: Scene) {\r\n    super.emit('prekill', new PreKillEvent(this));\r\n    this.onPreKill(_scene);\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPreKill lifecycle event handler. Synonymous with `.on('prekill', (evt) =>{...})`\r\n   *\r\n   * `onPreKill` is called directly before an actor is killed and removed from its current [[Scene]].\r\n   */\r\n  public onPreKill(_scene: Scene) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _prekill handler for [[onPostKill]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _postkill(_scene: Scene) {\r\n    super.emit('postkill', new PostKillEvent(this));\r\n    this.onPostKill(_scene);\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostKill lifecycle event handler. Synonymous with `.on('postkill', (evt) => {...})`\r\n   *\r\n   * `onPostKill` is called directly after an actor is killed and remove from its current [[Scene]].\r\n   */\r\n  public onPostKill(_scene: Scene) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * If the current actor is a member of the scene, this will remove\r\n   * it from the scene graph. It will no longer be drawn or updated.\r\n   */\r\n  public kill() {\r\n    if (this.scene) {\r\n      this._prekill(this.scene);\r\n      this.emit('kill', new KillEvent(this));\r\n      super.kill();\r\n      this._postkill(this.scene);\r\n    } else {\r\n      this.logger.warn('Cannot kill actor, it was never added to the Scene');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * If the current actor is killed, it will now not be killed.\r\n   */\r\n  public unkill() {\r\n    this.active = true;\r\n  }\r\n\r\n  /**\r\n   * Indicates wether the actor has been killed.\r\n   */\r\n  public isKilled(): boolean {\r\n    return !this.active;\r\n  }\r\n\r\n  /**\r\n   * Gets the z-index of an actor. The z-index determines the relative order an actor is drawn in.\r\n   * Actors with a higher z-index are drawn on top of actors with a lower z-index\r\n   */\r\n  public get z(): number {\r\n    return this.get(TransformComponent).z;\r\n  }\r\n\r\n\r\n  /**\r\n   * Sets the z-index of an actor and updates it in the drawing list for the scene.\r\n   * The z-index determines the relative order an actor is drawn in.\r\n   * Actors with a higher z-index are drawn on top of actors with a lower z-index\r\n   * @param newZ new z-index to assign\r\n   */\r\n  public set z(newZ: number) {\r\n    this.get(TransformComponent).z = newZ;\r\n  }\r\n\r\n  /**\r\n   * Get the center point of an actor (global position)\r\n   */\r\n  public get center(): Vector {\r\n    const globalPos = this.getGlobalPos();\r\n    return new Vector(\r\n      globalPos.x + this.width / 2 - this.anchor.x * this.width,\r\n      globalPos.y + this.height / 2 - this.anchor.y * this.height);\r\n  }\r\n\r\n  /**\r\n   * Get the local center point of an actor\r\n   */\r\n  public get localCenter(): Vector {\r\n    return new Vector(\r\n      this.pos.x + this.width / 2 - this.anchor.x * this.width,\r\n      this.pos.y + this.height / 2 - this.anchor.y * this.height);\r\n  }\r\n\r\n  public get width() {\r\n    return this.collider.localBounds.width * this.getGlobalScale().x;\r\n  }\r\n\r\n  public get height() {\r\n    return this.collider.localBounds.height * this.getGlobalScale().y;\r\n  }\r\n\r\n  /**\r\n   * Gets this actor's rotation taking into account any parent relationships\r\n   *\r\n   * @returns Rotation angle in radians\r\n   */\r\n  public getGlobalRotation(): number {\r\n    return this.get(TransformComponent).globalRotation;\r\n  }\r\n\r\n  /**\r\n   * Gets an actor's world position taking into account parent relationships, scaling, rotation, and translation\r\n   *\r\n   * @returns Position in world coordinates\r\n   */\r\n  public getGlobalPos(): Vector {\r\n    return this.get(TransformComponent).globalPos;\r\n  }\r\n\r\n  /**\r\n   * Gets the global scale of the Actor\r\n   */\r\n  public getGlobalScale(): Vector {\r\n    return this.get(TransformComponent).globalScale;\r\n  }\r\n\r\n  // #region Collision\r\n\r\n  /**\r\n   * Tests whether the x/y specified are contained in the actor\r\n   * @param x  X coordinate to test (in world coordinates)\r\n   * @param y  Y coordinate to test (in world coordinates)\r\n   * @param recurse checks whether the x/y are contained in any child actors (if they exist).\r\n   */\r\n  public contains(x: number, y: number, recurse: boolean = false): boolean {\r\n    const point = vec(x, y);\r\n    const collider = this.get(ColliderComponent);\r\n    collider.update();\r\n    const geom = collider.get();\r\n    if (!geom) {\r\n      return false;\r\n    }\r\n    const containment = geom.contains(point);\r\n\r\n    if (recurse) {\r\n      return (\r\n        containment ||\r\n        this.children.some((child: Actor) => {\r\n          return child.contains(x, y, true);\r\n        })\r\n      );\r\n    }\r\n\r\n    return containment;\r\n  }\r\n\r\n  /**\r\n   * Returns true if the two actor.collider's surfaces are less than or equal to the distance specified from each other\r\n   * @param actor     Actor to test\r\n   * @param distance  Distance in pixels to test\r\n   */\r\n  public within(actor: Actor, distance: number): boolean {\r\n    const collider = this.get(ColliderComponent);\r\n    const otherCollider = actor.get(ColliderComponent);\r\n    const me = collider.get();\r\n    const other = otherCollider.get();\r\n    if (me && other) {\r\n      return me.getClosestLineBetween(other).getLength() <= distance;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  // #endregion\r\n\r\n  // #region Update\r\n\r\n  /**\r\n   * Called by the Engine, updates the state of the actor\r\n   * @internal\r\n   * @param engine The reference to the current game engine\r\n   * @param delta  The time elapsed since the last update in milliseconds\r\n   */\r\n  public update(engine: Engine, delta: number) {\r\n    this._initialize(engine);\r\n    this._preupdate(engine, delta);\r\n    this._postupdate(engine, delta);\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPreUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPreUpdate` is called directly before an actor is updated.\r\n   */\r\n  public onPreUpdate(_engine: Engine, _delta: number): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostUpdate lifecycle event handler. Synonymous with `.on('postupdate', (evt) =>{...})`\r\n   *\r\n   * `onPostUpdate` is called directly after an actor is updated.\r\n   */\r\n  public onPostUpdate(_engine: Engine, _delta: number): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for [[onPreUpdate]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _preupdate(engine: Engine, delta: number): void {\r\n    this.emit('preupdate', new PreUpdateEvent(engine, delta, this));\r\n    this.onPreUpdate(engine, delta);\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for [[onPostUpdate]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _postupdate(engine: Engine, delta: number): void {\r\n    this.emit('postupdate', new PreUpdateEvent(engine, delta, this));\r\n    this.onPostUpdate(engine, delta);\r\n  }\r\n\r\n  // endregion\r\n}\r\n","import { Vector, vec } from './Math/vector';\r\nimport { Engine } from './Engine';\r\nimport { Actor, ActorArgs } from './Actor';\r\nimport { TransformComponent } from './EntityComponentSystem/Components/TransformComponent';\r\nimport { CollisionType } from './Collision/CollisionType';\r\nimport { CoordPlane } from './Math/coord-plane';\r\n\r\n/**\r\n * Type guard to detect a screen element\r\n */\r\nexport function isScreenElement(actor: Actor) {\r\n  return actor instanceof ScreenElement;\r\n}\r\n\r\n/**\r\n * Helper [[Actor]] primitive for drawing UI's, optimized for UI drawing. Does\r\n * not participate in collisions. Drawn on top of all other actors.\r\n */\r\nexport class ScreenElement extends Actor {\r\n  protected _engine: Engine;\r\n\r\n  constructor();\r\n  constructor(config?: ActorArgs);\r\n\r\n  constructor(config?: ActorArgs) {\r\n    super({ ...config });\r\n    this.get(TransformComponent).coordPlane = CoordPlane.Screen;\r\n    this.anchor = vec(0, 0);\r\n    this.body.collisionType = CollisionType.PreventCollision;\r\n    this.collider.useBoxCollider(this.width, this.height, this.anchor);\r\n  }\r\n\r\n  public _initialize(engine: Engine) {\r\n    this._engine = engine;\r\n    super._initialize(engine);\r\n  }\r\n\r\n  public contains(x: number, y: number, useWorld: boolean = true) {\r\n    if (useWorld) {\r\n      return super.contains(x, y);\r\n    }\r\n\r\n    const coords = this._engine.worldToScreenCoordinates(new Vector(x, y));\r\n    return super.contains(coords.x, coords.y);\r\n  }\r\n}\r\n","import { Scene } from './Scene';\r\nimport { Logger } from './Util/Log';\r\nimport * as ex from './index';\r\nimport { Random } from './Math/Random';\r\n\r\n\r\nexport interface TimerOptions {\r\n  repeats?: boolean;\r\n  numberOfRepeats?: number;\r\n  fcn?: () => void;\r\n  interval: number;\r\n  randomRange?: [number, number];\r\n  random?: ex.Random;\r\n}\r\n\r\n/**\r\n * The Excalibur timer hooks into the internal timer and fires callbacks,\r\n * after a certain interval, optionally repeating.\r\n */\r\nexport class Timer {\r\n  private _logger = Logger.getInstance();\r\n  private static _MAX_ID: number = 0;\r\n  public id: number = 0;\r\n\r\n  private _elapsedTime: number = 0;\r\n  private _totalTimeAlive: number = 0;\r\n\r\n  private _running = false;\r\n\r\n  private _numberOfTicks: number = 0;\r\n  private _callbacks: Array<() => void>;\r\n\r\n  public interval: number = 10;\r\n  public repeats: boolean = false;\r\n  public maxNumberOfRepeats: number = -1;\r\n  public randomRange: [number, number] = [0,0];\r\n  public random: ex.Random;\r\n  private _baseInterval = 10;\r\n  private _generateRandomInterval = () => {\r\n    return this._baseInterval + this.random.integer(this.randomRange[0], this.randomRange[1]);\r\n  };\r\n\r\n  private _complete = false;\r\n  public get complete() {\r\n    return this._complete;\r\n  }\r\n\r\n  public scene: Scene = null;\r\n\r\n  /**\r\n   * @param options    Options - repeats, numberOfRepeats, fcn, interval\r\n   * @param repeats    Indicates whether this call back should be fired only once, or repeat after every interval as completed.\r\n   * @param numberOfRepeats Specifies a maximum number of times that this timer will execute.\r\n   * @param fcn        The callback to be fired after the interval is complete.\r\n   * @param randomRange Indicates a range to select a random number to be added onto the interval\r\n   */\r\n  constructor(options: TimerOptions);\r\n  constructor(fcn: TimerOptions | (() => void), interval?: number,\r\n    repeats?: boolean, numberOfRepeats?: number, randomRange?: [number, number], random?: ex.Random) {\r\n    if (typeof fcn !== 'function') {\r\n      const options = fcn;\r\n      fcn = options.fcn;\r\n      interval = options.interval;\r\n      repeats = options.repeats;\r\n      numberOfRepeats = options.numberOfRepeats;\r\n      randomRange = options.randomRange;\r\n      random= options.random;\r\n    }\r\n\r\n    if (!!numberOfRepeats && numberOfRepeats >= 0) {\r\n      this.maxNumberOfRepeats = numberOfRepeats;\r\n      if (!repeats) {\r\n        throw new Error('repeats must be set to true if numberOfRepeats is set');\r\n      }\r\n    }\r\n\r\n    this.id = Timer._MAX_ID++;\r\n    this._callbacks = [];\r\n    this._baseInterval = this.interval = interval;\r\n    if (!!randomRange){\r\n      if (randomRange[0] > randomRange[1]) {\r\n        throw new Error('min value must be lower than max value for range');\r\n      }\r\n      //We use the instance of ex.Random to generate the range\r\n      this.random = random ?? new Random();\r\n      this.randomRange = randomRange;\r\n\r\n      this.interval = this._generateRandomInterval();\r\n      this.on(() => {\r\n        this.interval = this._generateRandomInterval();\r\n      });\r\n    };\r\n    this.repeats = repeats || this.repeats;\r\n    if (fcn) {\r\n      this.on(fcn);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adds a new callback to be fired after the interval is complete\r\n   * @param fcn The callback to be added to the callback list, to be fired after the interval is complete.\r\n   */\r\n  public on(fcn: () => void) {\r\n    this._callbacks.push(fcn);\r\n  }\r\n\r\n  /**\r\n   * Removes a callback from the callback list to be fired after the interval is complete.\r\n   * @param fcn The callback to be removed from the callback list, to be fired after the interval is complete.\r\n   */\r\n  public off(fcn: () => void) {\r\n    const index = this._callbacks.indexOf(fcn);\r\n    this._callbacks.splice(index, 1);\r\n  }\r\n  /**\r\n   * Updates the timer after a certain number of milliseconds have elapsed. This is used internally by the engine.\r\n   * @param delta  Number of elapsed milliseconds since the last update.\r\n   */\r\n  public update(delta: number) {\r\n    if (this._running) {\r\n      this._totalTimeAlive += delta;\r\n      this._elapsedTime += delta;\r\n\r\n      if (this.maxNumberOfRepeats > -1 && this._numberOfTicks >= this.maxNumberOfRepeats) {\r\n        this._complete = true;\r\n        this._running = false;\r\n        this._elapsedTime = 0;\r\n      }\r\n\r\n      if (!this.complete && this._elapsedTime >= this.interval) {\r\n        this._callbacks.forEach((c) => {\r\n          c.call(this);\r\n        });\r\n        this._numberOfTicks++;\r\n        if (this.repeats) {\r\n          this._elapsedTime = 0;\r\n        } else {\r\n          this._complete = true;\r\n          this._running = false;\r\n          this._elapsedTime = 0;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Resets the timer so that it can be reused, and optionally reconfigure the timers interval.\r\n   *\r\n   * Warning** you may need to call `timer.start()` again if the timer had completed\r\n   * @param newInterval If specified, sets a new non-negative interval in milliseconds to refire the callback\r\n   * @param newNumberOfRepeats If specified, sets a new non-negative upper limit to the number of time this timer executes\r\n   */\r\n  public reset(newInterval?: number, newNumberOfRepeats?: number) {\r\n    if (!!newInterval && newInterval >= 0) {\r\n      this._baseInterval = this.interval= newInterval;\r\n    }\r\n\r\n    if (!!this.maxNumberOfRepeats && this.maxNumberOfRepeats >= 0) {\r\n      this.maxNumberOfRepeats = newNumberOfRepeats;\r\n      if (!this.repeats) {\r\n        throw new Error('repeats must be set to true if numberOfRepeats is set');\r\n      }\r\n    }\r\n\r\n    this._complete = false;\r\n    this._elapsedTime = 0;\r\n    this._numberOfTicks = 0;\r\n  }\r\n\r\n  public get timesRepeated(): number {\r\n    return this._numberOfTicks;\r\n  }\r\n\r\n  public getTimeRunning(): number {\r\n    return this._totalTimeAlive;\r\n  }\r\n\r\n  /**\r\n   * @returns milliseconds until the next action callback, if complete will return 0\r\n   */\r\n  public get timeToNextAction() {\r\n    if (this.complete) {\r\n      return 0;\r\n    }\r\n    return this.interval - this._elapsedTime;\r\n  }\r\n\r\n  /**\r\n   * @returns milliseconds elapsed toward the next action\r\n   */\r\n  public get timeElapsedTowardNextAction() {\r\n    return this._elapsedTime;\r\n  }\r\n\r\n  public get isRunning() {\r\n    return this._running;\r\n  }\r\n\r\n  /**\r\n   * Pauses the timer, time will no longer increment towards the next call\r\n   */\r\n  public pause(): Timer {\r\n    this._running = false;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Resumes the timer, time will now increment towards the next call.\r\n   */\r\n  public resume(): Timer {\r\n    this._running = true;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Starts the timer, if the timer was complete it will restart the timer and reset the elapsed time counter\r\n   */\r\n  public start(): Timer {\r\n    if (!this.scene) {\r\n      this._logger.warn('Cannot start a timer not part of a scene, timer wont start until added');\r\n    }\r\n\r\n    this._running = true;\r\n    if (this.complete) {\r\n      this._complete = false;\r\n      this._elapsedTime = 0;\r\n      this._numberOfTicks = 0;\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Stops the timer and resets the elapsed time counter towards the next action invocation\r\n   */\r\n  public stop(): Timer {\r\n    this._running = false;\r\n    this._elapsedTime = 0;\r\n    this._numberOfTicks = 0;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Cancels the timer, preventing any further executions.\r\n   */\r\n  public cancel() {\r\n    this.pause();\r\n    if (this.scene) {\r\n      this.scene.cancelTimer(this);\r\n    }\r\n  }\r\n}\r\n\r\n","import { Component } from '../EntityComponentSystem/Component';\r\nimport { vec, Vector } from '../Math/vector';\r\n\r\nexport class ParallaxComponent extends Component<'ex.parallax'> {\r\n  readonly type = 'ex.parallax';\r\n\r\n  parallaxFactor = vec(1.0, 1.0);\r\n\r\n  constructor(parallaxFactor?: Vector) {\r\n    super();\r\n    this.parallaxFactor = parallaxFactor ?? this.parallaxFactor;\r\n  }\r\n}","import { ExcaliburGraphicsContext } from '.';\r\nimport { Component } from '../EntityComponentSystem/Component';\r\n\r\n\r\n/**\r\n * Provide arbitrary drawing for the purposes of debugging your game\r\n *\r\n * Will only show when the Engine is set to debug mode [[Engine.showDebug]] or [[Engine.toggleDebug]]\r\n *\r\n */\r\nexport class DebugGraphicsComponent extends Component<'ex.debuggraphics'> {\r\n  readonly type = 'ex.debuggraphics';\r\n  constructor(public draw: (ctx: ExcaliburGraphicsContext) => void, public useTransform = true) {\r\n    super();\r\n  }\r\n}","import { BoundingBox } from '../Collision/BoundingBox';\r\nimport { Engine } from '../Engine';\r\nimport { Vector, vec } from '../Math/vector';\r\nimport { Logger } from '../Util/Log';\r\nimport * as Events from '../Events';\r\nimport { Entity } from '../EntityComponentSystem/Entity';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { BodyComponent } from '../Collision/BodyComponent';\r\nimport { CollisionType } from '../Collision/CollisionType';\r\nimport { Shape } from '../Collision/Colliders/Shape';\r\nimport { ExcaliburGraphicsContext, Graphic, GraphicsComponent, hasGraphicsTick, ParallaxComponent } from '../Graphics';\r\nimport { removeItemFromArray } from '../Util/Util';\r\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\r\nimport { ColliderComponent } from '../Collision/ColliderComponent';\r\nimport { CompositeCollider } from '../Collision/Colliders/CompositeCollider';\r\nimport { Color } from '../Color';\r\nimport { DebugGraphicsComponent } from '../Graphics/DebugGraphicsComponent';\r\nimport { Collider } from '../Collision/Colliders/Collider';\r\n\r\nexport interface TileMapOptions {\r\n  /**\r\n   * Optionally name the isometric tile map\r\n   */\r\n  name?: string;\r\n  /**\r\n   * Optionally specify the position of the isometric tile map\r\n   */\r\n  pos?: Vector;\r\n  /**\r\n   * Width of an individual tile in pixels\r\n   */\r\n  tileWidth: number;\r\n  /**\r\n   * Height of an individual tile in pixels\r\n   */\r\n  tileHeight: number;\r\n  /**\r\n   * The number of tile columns, or the number of tiles wide\r\n   */\r\n  columns: number;\r\n  /**\r\n   * The number of tile  rows, or the number of tiles high\r\n   */\r\n  rows: number;\r\n\r\n  /**\r\n   * Optionally render from the top of the graphic, by default tiles are rendered from the bottom\r\n   */\r\n  renderFromTopOfGraphic?: boolean;\r\n}\r\n\r\n/**\r\n * The TileMap provides a mechanism for doing flat 2D tiles rendered in a grid.\r\n *\r\n * TileMaps are useful for top down or side scrolling grid oriented games.\r\n */\r\nexport class TileMap extends Entity {\r\n  private _token = 0;\r\n  private _onScreenXStart: number = 0;\r\n  private _onScreenXEnd: number = Number.MAX_VALUE;\r\n  private _onScreenYStart: number = 0;\r\n  private _onScreenYEnd: number = Number.MAX_VALUE;\r\n\r\n  public logger: Logger = Logger.getInstance();\r\n  public readonly tiles: Tile[] = [];\r\n  private _rows: Tile[][] = [];\r\n  private _cols: Tile[][] = [];\r\n\r\n  public readonly tileWidth: number;\r\n  public readonly tileHeight: number;\r\n  public readonly rows: number;\r\n  public readonly columns: number;\r\n\r\n  public renderFromTopOfGraphic = false;\r\n\r\n  private _collidersDirty = true;\r\n  public flagCollidersDirty() {\r\n    this._collidersDirty = true;\r\n\r\n  }\r\n  private _transform: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  private _graphics: GraphicsComponent;\r\n  private _collider: ColliderComponent;\r\n  private _composite: CompositeCollider;\r\n\r\n  public get x(): number {\r\n    return this._transform.pos.x ?? 0;\r\n  }\r\n\r\n  public set x(val: number) {\r\n    if (this._transform?.pos) {\r\n      this.get(TransformComponent).pos = vec(val, this.y);\r\n    }\r\n  }\r\n\r\n  public get y(): number {\r\n    return this._transform?.pos.y ?? 0;\r\n  }\r\n\r\n  public set y(val: number) {\r\n    if (this._transform?.pos) {\r\n      this._transform.pos = vec(this.x, val);\r\n    }\r\n  }\r\n\r\n  public get z(): number {\r\n    return this._transform.z ?? 0;\r\n  }\r\n\r\n  public set z(val: number) {\r\n    if (this._transform) {\r\n      this._transform.z = val;\r\n    }\r\n  }\r\n\r\n  public get rotation(): number {\r\n    return this._transform?.rotation ?? 0;\r\n  }\r\n\r\n  public set rotation(val: number) {\r\n    if (this._transform?.rotation) {\r\n      this._transform.rotation = val;\r\n    }\r\n  }\r\n\r\n  public get scale(): Vector {\r\n    return this._transform?.scale ?? Vector.One;\r\n  }\r\n\r\n  public set scale(val: Vector) {\r\n    if (this._transform?.scale) {\r\n      this._transform.scale = val;\r\n    }\r\n  }\r\n\r\n  private _oldPos: Vector;\r\n  public get pos(): Vector {\r\n    return this._transform.pos;\r\n  }\r\n\r\n  public set pos(val: Vector) {\r\n    this._transform.pos = val;\r\n  }\r\n\r\n  public get vel(): Vector {\r\n    return this._motion.vel;\r\n  }\r\n\r\n  public set vel(val: Vector) {\r\n    this._motion.vel = val;\r\n  }\r\n\r\n  public on(eventName: Events.preupdate, handler: (event: Events.PreUpdateEvent<TileMap>) => void): void;\r\n  public on(eventName: Events.postupdate, handler: (event: Events.PostUpdateEvent<TileMap>) => void): void;\r\n  public on(eventName: Events.predraw, handler: (event: Events.PreDrawEvent) => void): void;\r\n  public on(eventName: Events.postdraw, handler: (event: Events.PostDrawEvent) => void): void;\r\n  public on(eventName: string, handler: (event: Events.GameEvent<any>) => void): void;\r\n  public on(eventName: string, handler: (event: any) => void): void {\r\n    super.on(eventName, handler);\r\n  }\r\n\r\n\r\n  /**\r\n   * @param options\r\n   */\r\n  constructor(options: TileMapOptions) {\r\n    super(null, options.name);\r\n    this.addComponent(new TransformComponent());\r\n    this.addComponent(new MotionComponent());\r\n    this.addComponent(\r\n      new BodyComponent({\r\n        type: CollisionType.Fixed\r\n      })\r\n    );\r\n    this.addComponent(\r\n      new GraphicsComponent({\r\n        onPostDraw: (ctx, delta) => this.draw(ctx, delta)\r\n      })\r\n    );\r\n    this.addComponent(new DebugGraphicsComponent((ctx) => this.debug(ctx)));\r\n    this.addComponent(new ColliderComponent());\r\n    this._graphics = this.get(GraphicsComponent);\r\n    this._transform = this.get(TransformComponent);\r\n    this._motion = this.get(MotionComponent);\r\n    this._collider = this.get(ColliderComponent);\r\n    this._composite = this._collider.useCompositeCollider([]);\r\n\r\n    this._transform.pos = options.pos ?? Vector.Zero;\r\n    this._oldPos = this._transform.pos;\r\n    this.renderFromTopOfGraphic = options.renderFromTopOfGraphic ?? this.renderFromTopOfGraphic;\r\n    this.tileWidth = options.tileWidth;\r\n    this.tileHeight = options.tileHeight;\r\n    this.rows = options.rows;\r\n    this.columns = options.columns;\r\n    this.tiles = new Array<Tile>(this.rows * this.columns);\r\n    this._rows = new Array(this.rows);\r\n    this._cols = new Array(this.columns);\r\n    let currentCol: Tile[] = [];\r\n    for (let i = 0; i < this.columns; i++) {\r\n      for (let j = 0; j < this.rows; j++) {\r\n        const cd = new Tile({\r\n          x: i,\r\n          y: j,\r\n          map: this\r\n        });\r\n        cd.map = this;\r\n        this.tiles[i + j * this.columns] = cd;\r\n        currentCol.push(cd);\r\n        if (!this._rows[j]) {\r\n          this._rows[j] = [];\r\n        }\r\n        this._rows[j].push(cd);\r\n      }\r\n      this._cols[i] = currentCol;\r\n      currentCol = [];\r\n    }\r\n\r\n    this._graphics.localBounds = new BoundingBox({\r\n      left: 0,\r\n      top: 0,\r\n      right: this.columns * this.tileWidth,\r\n      bottom: this.rows * this.tileHeight\r\n    });\r\n  }\r\n\r\n  public _initialize(engine: Engine) {\r\n    super._initialize(engine);\r\n  }\r\n\r\n\r\n  private _originalOffsets = new WeakMap<Collider, Vector>();\r\n  private _getOrSetColliderOriginalOffset(collider: Collider): Vector {\r\n    if (!this._originalOffsets.has(collider)) {\r\n      const originalOffset = collider.offset;\r\n      this._originalOffsets.set(collider, originalOffset);\r\n      return originalOffset;\r\n    } else {\r\n      return this._originalOffsets.get(collider);\r\n    }\r\n  }\r\n  /**\r\n   * Tiles colliders based on the solid tiles in the tilemap.\r\n   */\r\n  private _updateColliders(): void {\r\n    this._composite.clearColliders();\r\n    const colliders: BoundingBox[] = [];\r\n    this._composite = this._collider.useCompositeCollider([]);\r\n    let current: BoundingBox;\r\n    // Bad square tesselation algo\r\n    for (let i = 0; i < this.columns; i++) {\r\n      // Scan column for colliders\r\n      for (let j = 0; j < this.rows; j++) {\r\n        // Columns start with a new collider\r\n        if (j === 0) {\r\n          current = null;\r\n        }\r\n        const tile = this.tiles[i + j * this.columns];\r\n        // Current tile in column is solid build up current collider\r\n        if (tile.solid) {\r\n          // Use custom collider otherwise bounding box\r\n          if (tile.getColliders().length > 0) {\r\n            for (const collider of tile.getColliders()) {\r\n              const originalOffset = this._getOrSetColliderOriginalOffset(collider);\r\n              collider.offset = vec(tile.x * this.tileWidth, tile.y * this.tileHeight).add(originalOffset);\r\n              collider.owner = this;\r\n              this._composite.addCollider(collider);\r\n            }\r\n            current = null;\r\n          } else {\r\n            if (!current) {\r\n              current = tile.bounds;\r\n            } else {\r\n              current = current.combine(tile.bounds);\r\n            }\r\n          }\r\n        } else {\r\n          // Not solid skip and cut off the current collider\r\n          if (current) {\r\n            colliders.push(current);\r\n          }\r\n          current = null;\r\n        }\r\n      }\r\n      // After a column is complete check to see if it can be merged into the last one\r\n      if (current) {\r\n        // if previous is the same combine it\r\n        const prev = colliders[colliders.length - 1];\r\n        if (prev && prev.top === current.top && prev.bottom === current.bottom) {\r\n          colliders[colliders.length - 1] = prev.combine(current);\r\n        } else {\r\n          // else new collider\r\n          colliders.push(current);\r\n        }\r\n      }\r\n    }\r\n\r\n    for (const c of colliders) {\r\n      const collider = Shape.Box(c.width, c.height, Vector.Zero, vec(c.left - this.pos.x, c.top - this.pos.y));\r\n      collider.owner = this;\r\n      this._composite.addCollider(collider);\r\n    }\r\n    this._collider.update();\r\n  }\r\n\r\n  /**\r\n   * Returns the [[Tile]] by index (row major order)\r\n   */\r\n  public getTileByIndex(index: number): Tile {\r\n    return this.tiles[index];\r\n  }\r\n  /**\r\n   * Returns the [[Tile]] by its x and y integer coordinates\r\n   */\r\n  public getTile(x: number, y: number): Tile {\r\n    if (x < 0 || y < 0 || x >= this.columns || y >= this.rows) {\r\n      return null;\r\n    }\r\n    return this.tiles[x + y * this.columns];\r\n  }\r\n  /**\r\n   * Returns the [[Tile]] by testing a point in world coordinates,\r\n   * returns `null` if no Tile was found.\r\n   */\r\n  public getTileByPoint(point: Vector): Tile {\r\n    const x = Math.floor((point.x - this.pos.x) / this.tileWidth);\r\n    const y = Math.floor((point.y - this.pos.y) / this.tileHeight);\r\n    const tile = this.getTile(x, y);\r\n    if (x >= 0 && y >= 0 && x < this.columns && y < this.rows && tile) {\r\n      return tile;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  public getRows(): readonly Tile[][] {\r\n    return this._rows;\r\n  }\r\n\r\n  public getColumns(): readonly Tile[][] {\r\n    return this._cols;\r\n  }\r\n\r\n  public update(engine: Engine, delta: number) {\r\n    this.onPreUpdate(engine, delta);\r\n    this.emit('preupdate', new Events.PreUpdateEvent(engine, delta, this));\r\n    if (!this._oldPos.equals(this.pos)) {\r\n      this.flagCollidersDirty();\r\n      for (let i = 0; i < this.tiles.length; i++) {\r\n        if (this.tiles[i]) {\r\n          this.tiles[i].flagDirty();\r\n        }\r\n      }\r\n    }\r\n    if (this._collidersDirty) {\r\n      this._collidersDirty = false;\r\n      this._updateColliders();\r\n    }\r\n\r\n    this._token++;\r\n    const worldBounds = engine.getWorldBounds();\r\n    const worldCoordsUpperLeft = vec(worldBounds.left, worldBounds.top);\r\n    const worldCoordsLowerRight = vec(worldBounds.right, worldBounds.bottom);\r\n\r\n    let pos = this.pos;\r\n    const maybeParallax = this.get(ParallaxComponent);\r\n    let parallaxOffset = Vector.One;\r\n    if (maybeParallax) {\r\n      const oneMinusFactor = Vector.One.sub(maybeParallax.parallaxFactor);\r\n      parallaxOffset = engine.currentScene.camera.pos.scale(oneMinusFactor);\r\n      pos = pos.add(parallaxOffset);\r\n    }\r\n\r\n    this._onScreenXStart = Math.max(Math.floor((worldCoordsUpperLeft.x - pos.x) / this.tileWidth) - 2, 0);\r\n    this._onScreenYStart = Math.max(Math.floor((worldCoordsUpperLeft.y - pos.y) / this.tileHeight) - 2, 0);\r\n    this._onScreenXEnd = Math.max(Math.floor((worldCoordsLowerRight.x - pos.x) / this.tileWidth) + 2, 0);\r\n    this._onScreenYEnd = Math.max(Math.floor((worldCoordsLowerRight.y - pos.y) / this.tileHeight) + 2, 0);\r\n    // why are we resetting pos?\r\n    this._transform.pos = vec(this.x, this.y);\r\n\r\n    this.onPostUpdate(engine, delta);\r\n    this.emit('postupdate', new Events.PostUpdateEvent(engine, delta, this));\r\n  }\r\n\r\n  /**\r\n   * Draws the tile map to the screen. Called by the [[Scene]].\r\n   * @param ctx ExcaliburGraphicsContext\r\n   * @param delta  The number of milliseconds since the last draw\r\n   */\r\n  public draw(ctx: ExcaliburGraphicsContext, delta: number): void {\r\n    this.emit('predraw', new Events.PreDrawEvent(ctx as any, delta, this)); // TODO fix event\r\n\r\n    let x = this._onScreenXStart;\r\n    const xEnd = Math.min(this._onScreenXEnd, this.columns);\r\n    let y = this._onScreenYStart;\r\n    const yEnd = Math.min(this._onScreenYEnd, this.rows);\r\n\r\n    let graphics: readonly Graphic[], graphicsIndex: number, graphicsLen: number;\r\n\r\n    for (x; x < xEnd; x++) {\r\n      for (y; y < yEnd; y++) {\r\n        // get non-negative tile sprites\r\n        graphics = this.getTile(x, y).getGraphics();\r\n\r\n        for (graphicsIndex = 0, graphicsLen = graphics.length; graphicsIndex < graphicsLen; graphicsIndex++) {\r\n          // draw sprite, warning if sprite doesn't exist\r\n          const graphic = graphics[graphicsIndex];\r\n          if (graphic) {\r\n            if (hasGraphicsTick(graphic)) {\r\n              graphic?.tick(delta, this._token);\r\n            }\r\n            const offsetY = this.renderFromTopOfGraphic ? 0 : (graphic.height - this.tileHeight);\r\n            graphic.draw(ctx, x * this.tileWidth, y * this.tileHeight - offsetY);\r\n          }\r\n        }\r\n      }\r\n      y = this._onScreenYStart;\r\n    }\r\n\r\n    this.emit('postdraw', new Events.PostDrawEvent(ctx as any, delta, this));\r\n  }\r\n\r\n  public debug(gfx: ExcaliburGraphicsContext) {\r\n    const width = this.tileWidth * this.columns;\r\n    const height = this.tileHeight * this.rows;\r\n    const pos = Vector.Zero;\r\n    for (let r = 0; r < this.rows + 1; r++) {\r\n      const yOffset = vec(0, r * this.tileHeight);\r\n      gfx.drawLine(pos.add(yOffset), pos.add(vec(width, yOffset.y)), Color.Red, 2);\r\n    }\r\n\r\n    for (let c = 0; c < this.columns + 1; c++) {\r\n      const xOffset = vec(c * this.tileWidth, 0);\r\n      gfx.drawLine(pos.add(xOffset), pos.add(vec(xOffset.x, height)), Color.Red, 2);\r\n    }\r\n\r\n    const colliders = this._composite.getColliders();\r\n    for (const collider of colliders) {\r\n      const grayish = Color.Gray;\r\n      grayish.a = 0.5;\r\n      const bounds = collider.localBounds;\r\n      const pos = collider.worldPos.sub(this.pos);\r\n      gfx.drawRectangle(pos, bounds.width, bounds.height, grayish);\r\n    }\r\n  }\r\n}\r\n\r\nexport interface TileOptions {\r\n  /**\r\n   * Integer tile x coordinate\r\n   */\r\n  x: number;\r\n  /**\r\n   * Integer tile y coordinate\r\n   */\r\n  y: number;\r\n  map: TileMap;\r\n  solid?: boolean;\r\n  graphics?: Graphic[];\r\n}\r\n\r\n/**\r\n * TileMap Tile\r\n *\r\n * A light-weight object that occupies a space in a collision map. Generally\r\n * created by a [[TileMap]].\r\n *\r\n * Tiles can draw multiple sprites. Note that the order of drawing is the order\r\n * of the sprites in the array so the last one will be drawn on top. You can\r\n * use transparency to create layers this way.\r\n */\r\nexport class Tile extends Entity {\r\n  private _bounds: BoundingBox;\r\n  private _pos: Vector;\r\n  private _posDirty = false;\r\n  // private _transform: TransformComponent;\r\n\r\n  /**\r\n   * Return the world position of the top left corner of the tile\r\n   */\r\n  public get pos() {\r\n    if (this._posDirty) {\r\n      this._recalculate();\r\n      this._posDirty = false;\r\n    }\r\n    return this._pos;\r\n  }\r\n\r\n  /**\r\n   * Integer x coordinate of the tile\r\n   */\r\n  public readonly x: number;\r\n\r\n  /**\r\n   * Integer y coordinate of the tile\r\n   */\r\n  public readonly y: number;\r\n\r\n  /**\r\n   * Width of the tile in pixels\r\n   */\r\n  public readonly width: number;\r\n\r\n  /**\r\n   * Height of the tile in pixels\r\n   */\r\n  public readonly height: number;\r\n\r\n  /**\r\n   * Reference to the TileMap this tile is associated with\r\n   */\r\n  public map: TileMap;\r\n\r\n  private _solid = false;\r\n  /**\r\n   * Wether this tile should be treated as solid by the tilemap\r\n   */\r\n  public get solid(): boolean {\r\n    return this._solid;\r\n  }\r\n  /**\r\n   * Wether this tile should be treated as solid by the tilemap\r\n   */\r\n  public set solid(val: boolean) {\r\n    this.map?.flagCollidersDirty();\r\n    this._solid = val;\r\n  }\r\n\r\n  private _graphics: Graphic[] = [];\r\n\r\n  /**\r\n   * Current list of graphics for this tile\r\n   */\r\n  public getGraphics(): readonly Graphic[] {\r\n    return this._graphics;\r\n  }\r\n\r\n  /**\r\n   * Add another [[Graphic]] to this TileMap tile\r\n   * @param graphic\r\n   */\r\n  public addGraphic(graphic: Graphic) {\r\n    this._graphics.push(graphic);\r\n  }\r\n\r\n  /**\r\n   * Remove an instance of a [[Graphic]] from this tile\r\n   */\r\n  public removeGraphic(graphic: Graphic) {\r\n    removeItemFromArray(graphic, this._graphics);\r\n  }\r\n\r\n  /**\r\n   * Clear all graphics from this tile\r\n   */\r\n  public clearGraphics() {\r\n    this._graphics.length = 0;\r\n  }\r\n\r\n  /**\r\n   * Current list of colliders for this tile\r\n   */\r\n  private _colliders: Collider[] = [];\r\n\r\n  /**\r\n   * Returns the list of colliders\r\n   */\r\n  public getColliders(): readonly Collider[] {\r\n    return this._colliders;\r\n  }\r\n\r\n  /**\r\n   * Adds a custom collider to the [[Tile]] to use instead of it's bounds\r\n   *\r\n   * If no collider is set but [[Tile.solid]] is set, the tile bounds are used as a collider.\r\n   *\r\n   * **Note!** the [[Tile.solid]] must be set to true for it to act as a \"fixed\" collider\r\n   * @param collider\r\n   */\r\n  public addCollider(collider: Collider) {\r\n    this._colliders.push(collider);\r\n    this.map.flagCollidersDirty();\r\n  }\r\n\r\n  /**\r\n   * Removes a collider from the [[Tile]]\r\n   * @param collider\r\n   */\r\n  public removeCollider(collider: Collider) {\r\n    const index = this._colliders.indexOf(collider);\r\n    if (index > -1) {\r\n      this._colliders.splice(index, 1);\r\n    }\r\n    this.map.flagCollidersDirty();\r\n  }\r\n\r\n  /**\r\n   * Clears all colliders from the [[Tile]]\r\n   */\r\n  public clearColliders() {\r\n    this._colliders.length = 0;\r\n    this.map.flagCollidersDirty();\r\n  }\r\n\r\n  /**\r\n   * Arbitrary data storage per tile, useful for any game specific data\r\n   */\r\n  public data = new Map<string, any>();\r\n\r\n  constructor(options: TileOptions) {\r\n    super();\r\n    this.x = options.x;\r\n    this.y = options.y;\r\n    this.map = options.map;\r\n    this.width = options.map.tileWidth;\r\n    this.height = options.map.tileHeight;\r\n    this.solid = options.solid ?? this.solid;\r\n    this._graphics = options.graphics ?? [];\r\n    this._recalculate();\r\n  }\r\n\r\n  public flagDirty() {\r\n    return this._posDirty = true;\r\n  }\r\n\r\n  private _recalculate() {\r\n    this._pos = this.map.pos.add(\r\n      vec(\r\n        this.x * this.map.tileWidth,\r\n        this.y * this.map.tileHeight));\r\n    this._bounds = new BoundingBox(this._pos.x, this._pos.y, this._pos.x + this.width, this._pos.y + this.height);\r\n    this._posDirty = false;\r\n  }\r\n\r\n  public get bounds() {\r\n    if (this._posDirty) {\r\n      this._recalculate();\r\n    }\r\n    return this._bounds;\r\n  }\r\n\r\n  public get center(): Vector {\r\n    if (this._posDirty) {\r\n      this._recalculate();\r\n    }\r\n    return new Vector(this._pos.x + this.width / 2, this._pos.y + this.height / 2);\r\n  }\r\n}","import { Engine } from './Engine';\r\nimport { EventDispatcher } from './EventDispatcher';\r\nimport { Vector } from './Math/vector';\r\nimport { ExitTriggerEvent, EnterTriggerEvent, CollisionEndEvent, CollisionStartEvent } from './Events';\r\nimport { CollisionType } from './Collision/CollisionType';\r\nimport { Entity } from './EntityComponentSystem';\r\nimport { Actor } from './Actor';\r\n\r\n/**\r\n * ITriggerOptions\r\n */\r\nexport interface TriggerOptions {\r\n  // position of the trigger\r\n  pos: Vector;\r\n  // width of the trigger\r\n  width: number;\r\n  // height of the trigger\r\n  height: number;\r\n  // whether the trigger is visible or not\r\n  visible: boolean;\r\n  // action to take when triggered\r\n  action: () => void;\r\n  // if specified the trigger will only fire on a specific actor and overrides any filter\r\n  target: Entity;\r\n  // Returns true if the triggers should fire on the collided actor\r\n  filter: (actor: Entity) => boolean;\r\n  // -1 if it should repeat forever\r\n  repeat: number;\r\n}\r\n\r\nconst triggerDefaults: Partial<TriggerOptions> = {\r\n  pos: Vector.Zero,\r\n  width: 10,\r\n  height: 10,\r\n  visible: false,\r\n  action: () => {\r\n    return;\r\n  },\r\n  filter: () => true,\r\n  repeat: -1\r\n};\r\n\r\n/**\r\n * Triggers are a method of firing arbitrary code on collision. These are useful\r\n * as 'buttons', 'switches', or to trigger effects in a game. By default triggers\r\n * are invisible, and can only be seen when [[Trigger.visible]] is set to `true`.\r\n */\r\nexport class Trigger extends Actor {\r\n  private _target: Entity;\r\n  /**\r\n   * Action to fire when triggered by collision\r\n   */\r\n  public action: () => void = () => {\r\n    return;\r\n  };\r\n  /**\r\n   * Filter to add additional granularity to action dispatch, if a filter is specified the action will only fire when\r\n   * filter return true for the collided actor.\r\n   */\r\n  public filter: (actor: Entity) => boolean = () => true;\r\n  /**\r\n   * Number of times to repeat before killing the trigger,\r\n   */\r\n  public repeat: number = -1;\r\n\r\n  /**\r\n   *\r\n   * @param opts Trigger options\r\n   */\r\n  constructor(opts: Partial<TriggerOptions>) {\r\n    super({ x: opts.pos.x, y: opts.pos.y, width: opts.width, height: opts.height });\r\n    opts = {\r\n      ...triggerDefaults,\r\n      ...opts\r\n    };\r\n\r\n    this.filter = opts.filter || this.filter;\r\n    this.repeat = opts.repeat || this.repeat;\r\n    this.action = opts.action || this.action;\r\n    if (opts.target) {\r\n      this.target = opts.target;\r\n    }\r\n\r\n    this.graphics.visible = opts.visible;\r\n    this.body.collisionType = CollisionType.Passive;\r\n    this.eventDispatcher = new EventDispatcher();\r\n\r\n    this.events.on('collisionstart', (evt: CollisionStartEvent<Actor>) => {\r\n      if (this.filter(evt.other)) {\r\n        this.emit('enter', new EnterTriggerEvent(this, evt.other));\r\n        this._dispatchAction();\r\n        // remove trigger if its done, -1 repeat forever\r\n        if (this.repeat === 0) {\r\n          this.kill();\r\n        }\r\n      }\r\n    });\r\n\r\n    this.events.on('collisionend', (evt: CollisionEndEvent<Actor>) => {\r\n      if (this.filter(evt.other)) {\r\n        this.emit('exit', new ExitTriggerEvent(this, evt.other));\r\n      }\r\n    });\r\n  }\r\n\r\n  public set target(target: Entity) {\r\n    this._target = target;\r\n    this.filter = (actor: Entity) => actor === target;\r\n  }\r\n\r\n  public get target() {\r\n    return this._target;\r\n  }\r\n\r\n  public _initialize(engine: Engine) {\r\n    super._initialize(engine);\r\n  }\r\n\r\n  private _dispatchAction() {\r\n    if (this.repeat !== 0) {\r\n      this.action.call(this);\r\n      this.repeat--;\r\n    }\r\n  }\r\n}\r\n","import { Entity } from './Entity';\r\nimport { Message, Observer } from '../Util/Observable';\r\nimport { Component } from './Component';\r\nimport { Scene } from '../Scene';\r\n\r\n/**\r\n * Enum that determines whether to run the system in the update or draw phase\r\n */\r\nexport enum SystemType {\r\n  Update = 'update',\r\n  Draw = 'draw'\r\n}\r\n\r\nexport type SystemTypes<ComponentTypes> = ComponentTypes extends Component<infer TypeName> ? TypeName : never;\r\n\r\n/**\r\n * An Excalibur [[System]] that updates entities of certain types.\r\n * Systems are scene specific\r\n *\r\n * Excalibur Systems currently require at least 1 Component type to operated\r\n *\r\n * Multiple types are declared as a type union\r\n * For example:\r\n *\r\n * ```typescript\r\n * class MySystem extends System<ComponentA | ComponentB> {\r\n *   public readonly types = ['a', 'b'] as const;\r\n *   public readonly systemType = SystemType.Update;\r\n *   public update(entities: Entity<ComponentA | ComponentB>) {\r\n *      ...\r\n *   }\r\n * }\r\n * ```\r\n */\r\nexport abstract class System<ComponentTypeUnion extends Component = Component, ContextType = Scene>\r\nimplements Observer<AddedEntity | RemovedEntity> {\r\n  /**\r\n   * The types of entities that this system operates on\r\n   * For example ['transform', 'motion']\r\n   */\r\n  abstract readonly types: readonly SystemTypes<ComponentTypeUnion>[];\r\n\r\n  /**\r\n   * Determine whether the system is called in the [[SystemType.Update]] or the [[SystemType.Draw]] phase. Update is first, then Draw.\r\n   */\r\n  abstract readonly systemType: SystemType;\r\n\r\n  /**\r\n   * System can execute in priority order, by default all systems are priority 0. Lower values indicated higher priority.\r\n   * For a system to execute before all other a lower priority value (-1 for example) must be set.\r\n   * For a system to execute after all other a higher priority value (10 for example) must be set.\r\n   */\r\n  public priority: number = 0;\r\n\r\n  /**\r\n   * Optionally specify a sort order for entities passed to the your system\r\n   * @param a The left entity\r\n   * @param b The right entity\r\n   */\r\n  sort?(a: Entity, b: Entity): number;\r\n\r\n  /**\r\n   * Optionally specify an initialize handler\r\n   * @param scene\r\n   */\r\n  initialize?(engine: ContextType): void;\r\n\r\n  /**\r\n   * Update all entities that match this system's types\r\n   * @param entities Entities to update that match this system's types\r\n   * @param delta Time in milliseconds\r\n   */\r\n  abstract update(entities: Entity[], delta: number): void;\r\n\r\n  /**\r\n   * Optionally run a preupdate before the system processes matching entities\r\n   * @param engine\r\n   * @param elapsedMs Time in milliseconds since the last frame\r\n   */\r\n  preupdate?(engine: ContextType, elapsedMs: number): void;\r\n\r\n  /**\r\n   * Optionally run a postupdate after the system processes matching entities\r\n   * @param engine\r\n   * @param elapsedMs Time in milliseconds since the last frame\r\n   */\r\n  postupdate?(engine: ContextType, elapsedMs: number): void;\r\n\r\n  /**\r\n   * Systems observe when entities match their types or no longer match their types, override\r\n   * @param _entityAddedOrRemoved\r\n   */\r\n  public notify(_entityAddedOrRemoved: AddedEntity | RemovedEntity) {\r\n    // Override me\r\n  }\r\n}\r\n\r\n/**\r\n * An [[Entity]] with [[Component]] types that matches a [[System]] types exists in the current scene.\r\n */\r\nexport class AddedEntity implements Message<Entity> {\r\n  readonly type: 'Entity Added' = 'Entity Added';\r\n  constructor(public data: Entity) {}\r\n}\r\n\r\n/**\r\n * Type guard to check for AddedEntity messages\r\n * @param x\r\n */\r\nexport function isAddedSystemEntity(x: Message<Entity>): x is AddedEntity {\r\n  return !!x && x.type === 'Entity Added';\r\n}\r\n\r\n/**\r\n * An [[Entity]] with [[Component]] types that no longer matches a [[System]] types exists in the current scene.\r\n */\r\nexport class RemovedEntity implements Message<Entity> {\r\n  readonly type: 'Entity Removed' = 'Entity Removed';\r\n  constructor(public data: Entity) {}\r\n}\r\n\r\n/**\r\n * type guard to check for the RemovedEntity message\r\n */\r\nexport function isRemoveSystemEntity(x: Message<Entity>): x is RemovedEntity {\r\n  return !!x && x.type === 'Entity Removed';\r\n}\r\n","import { Entity, RemovedComponent, AddedComponent, isAddedComponent, isRemovedComponent } from './Entity';\r\nimport { Observer } from '../Util/Observable';\r\nimport { World } from './World';\r\nimport { Util } from '..';\r\n\r\n// Add/Remove entities and components\r\n\r\nexport class EntityManager<ContextType = any> implements Observer<RemovedComponent | AddedComponent> {\r\n  public entities: Entity[] = [];\r\n  public _entityIndex: { [entityId: string]: Entity } = {};\r\n\r\n  constructor(private _world: World<ContextType>) {}\r\n\r\n  /**\r\n   * Runs the entity lifecycle\r\n   * @param _context\r\n   */\r\n  public updateEntities(_context: ContextType, elapsed: number) {\r\n    for (const entity of this.entities) {\r\n      // TODO is this right?\r\n      entity.update((_context as any).engine, elapsed);\r\n      if (!entity.active) {\r\n        this.removeEntity(entity);\r\n      }\r\n    }\r\n  }\r\n\r\n  public findEntitiesForRemoval() {\r\n    for (const entity of this.entities) {\r\n      if (!entity.active) {\r\n        this.removeEntity(entity);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * EntityManager observes changes on entities\r\n   * @param message\r\n   */\r\n  public notify(message: RemovedComponent | AddedComponent): void {\r\n    if (isAddedComponent(message)) {\r\n      // we don't need the component, it's already on the entity\r\n      this._world.queryManager.addEntity(message.data.entity);\r\n    }\r\n\r\n    if (isRemovedComponent(message)) {\r\n      this._world.queryManager.removeComponent(message.data.entity, message.data.component);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adds an entity to be tracked by the EntityManager\r\n   * @param entity\r\n   */\r\n  public addEntity(entity: Entity): void {\r\n    entity.active = true;\r\n    if (entity && !this._entityIndex[entity.id]) {\r\n      this._entityIndex[entity.id] = entity;\r\n      this.entities.push(entity);\r\n      this._world.queryManager.addEntity(entity);\r\n      entity.componentAdded$.register(this);\r\n      entity.componentRemoved$.register(this);\r\n\r\n      // if entity has children\r\n      entity.children.forEach((c) => this.addEntity(c));\r\n      entity.childrenAdded$.register({\r\n        notify: (e) => {\r\n          this.addEntity(e);\r\n        }\r\n      });\r\n      entity.childrenRemoved$.register({\r\n        notify: (e) => {\r\n          this.removeEntity(e, false);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  public removeEntity(entity: Entity, deferred?: boolean): void;\r\n  public removeEntity(id: number, deferred?: boolean): void;\r\n  public removeEntity(idOrEntity: number | Entity, deferred = true): void {\r\n    let id = 0;\r\n    if (idOrEntity instanceof Entity) {\r\n      id = idOrEntity.id;\r\n    } else {\r\n      id = idOrEntity;\r\n    }\r\n    const entity = this._entityIndex[id];\r\n    if (entity && entity.active) {\r\n      entity.kill();\r\n    }\r\n\r\n    if (entity && deferred) {\r\n      this._entitiesToRemove.push(entity);\r\n      return;\r\n    }\r\n\r\n    delete this._entityIndex[id];\r\n    if (entity) {\r\n      Util.removeItemFromArray(entity, this.entities);\r\n      this._world.queryManager.removeEntity(entity);\r\n      entity.componentAdded$.unregister(this);\r\n      entity.componentRemoved$.unregister(this);\r\n\r\n      // if entity has children\r\n      entity.children.forEach((c) => this.removeEntity(c, deferred));\r\n      entity.childrenAdded$.clear();\r\n      entity.childrenRemoved$.clear();\r\n\r\n      // stats\r\n      if ((this._world.context as any)?.engine) {\r\n        (this._world.context as any).engine.stats.currFrame.actors.killed++;\r\n      }\r\n    }\r\n  }\r\n\r\n  private _entitiesToRemove: Entity[] = [];\r\n  public processEntityRemovals(): void {\r\n    for (const entity of this._entitiesToRemove) {\r\n      if (entity.active) {\r\n        continue;\r\n      }\r\n      this.removeEntity(entity, false);\r\n    }\r\n  }\r\n\r\n  public processComponentRemovals(): void {\r\n    for (const entity of this.entities) {\r\n      entity.processComponentRemoval();\r\n    }\r\n  }\r\n\r\n  public getById(id: number): Entity {\r\n    return this._entityIndex[id];\r\n  }\r\n\r\n  public getByName(name: string): Entity[]{\r\n    return this.entities.filter(e => e.name === name);\r\n  }\r\n\r\n  public clear(): void {\r\n    for (const entity of this.entities) {\r\n      this.removeEntity(entity);\r\n    }\r\n  }\r\n}\r\n","export const buildTypeKey = (types: readonly string[]) => {\r\n  const key = [...types].sort((a, b) => a.localeCompare(b)).join('+');\r\n  return key;\r\n};\r\n","import { Entity } from './Entity';\r\nimport { buildTypeKey } from './Util';\r\nimport { Observable } from '../Util/Observable';\r\nimport { Util, Component, ComponentCtor } from '..';\r\nimport { AddedEntity, RemovedEntity } from './System';\r\n\r\n/**\r\n * Represents query for entities that match a list of types that is cached and observable\r\n *\r\n * Queries can be strongly typed by supplying a type union in the optional type parameter\r\n * ```typescript\r\n * const queryAB = new ex.Query<ComponentTypeA | ComponentTypeB>(['A', 'B']);\r\n * ```\r\n */\r\nexport class Query<T extends Component = Component> extends Observable<AddedEntity | RemovedEntity> {\r\n  public types: readonly string[];\r\n  private _entities: Entity[] = [];\r\n  private _key: string;\r\n  public get key(): string {\r\n    if (this._key) {\r\n      return this._key;\r\n    }\r\n    return (this._key = buildTypeKey(this.types));\r\n  }\r\n\r\n  constructor(types: readonly string[]);\r\n  constructor(types: readonly ComponentCtor<T>[]);\r\n  constructor(types: readonly string[] | readonly ComponentCtor<T>[]) {\r\n    super();\r\n    if (types[0] instanceof Function) {\r\n      this.types = (types as ComponentCtor<T>[]).map(T =>  (new T).type);\r\n    } else {\r\n      this.types = types as string[];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns a list of entities that match the query\r\n   *\r\n   * @param sort Optional sorting function to sort entities returned from the query\r\n   */\r\n  public getEntities(sort?: (a: Entity, b: Entity) => number): Entity[] {\r\n    if (sort) {\r\n      this._entities.sort(sort);\r\n    }\r\n    return this._entities;\r\n  }\r\n\r\n  /**\r\n   * Add an entity to the query, will only be added if the entity matches the query types\r\n   * @param entity\r\n   */\r\n  public addEntity(entity: Entity): void {\r\n    if (!Util.contains(this._entities, entity) && this.matches(entity)) {\r\n      this._entities.push(entity);\r\n      this.notifyAll(new AddedEntity(entity));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * If the entity is part of the query it will be removed regardless of types\r\n   * @param entity\r\n   */\r\n  public removeEntity(entity: Entity): void {\r\n    if (Util.removeItemFromArray(entity, this._entities)) {\r\n      this.notifyAll(new RemovedEntity(entity));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes all entities and observers from the query\r\n   */\r\n  public clear(): void {\r\n    this._entities.length = 0;\r\n    for (const observer of this.observers) {\r\n      this.unregister(observer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns whether the entity's types match query\r\n   * @param entity\r\n   */\r\n  public matches(entity: Entity): boolean;\r\n\r\n  /**\r\n   * Returns whether the list of ComponentTypes have at least the same types as the query\r\n   * @param types\r\n   */\r\n  public matches(types: string[]): boolean;\r\n  public matches(typesOrEntity: string[] | Entity): boolean {\r\n    let types: string[] = [];\r\n    if (typesOrEntity instanceof Entity) {\r\n      types = typesOrEntity.types;\r\n    } else {\r\n      types = typesOrEntity;\r\n    }\r\n\r\n    let matches = true;\r\n    for (const type of this.types) {\r\n      matches = matches && types.indexOf(type) > -1;\r\n      if (!matches) {\r\n        return false;\r\n      }\r\n    }\r\n    return matches;\r\n  }\r\n\r\n  public contain(type: string) {\r\n    return this.types.indexOf(type) > -1;\r\n  }\r\n}\r\n","import { Entity } from './Entity';\r\nimport { buildTypeKey } from './Util';\r\nimport { Query } from './Query';\r\nimport { Component } from './Component';\r\nimport { World } from './World';\r\n\r\n/**\r\n * The query manager is responsible for updating all queries when entities/components change\r\n */\r\nexport class QueryManager {\r\n  private _queries: { [entityComponentKey: string]: Query<any> } = {};\r\n\r\n  constructor(private _world: World<any>) {}\r\n\r\n  /**\r\n   * Adds a query to the manager and populates with any entities that match\r\n   * @param query\r\n   */\r\n  private _addQuery(query: Query<any>) {\r\n    this._queries[buildTypeKey(query.types)] = query;\r\n    for (const entity of this._world.entityManager.entities) {\r\n      query.addEntity(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes the query if there are no observers left\r\n   * @param query\r\n   */\r\n  public maybeRemoveQuery(query: Query): void {\r\n    if (query.observers.length === 0) {\r\n      query.clear();\r\n      delete this._queries[buildTypeKey(query.types)];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adds the entity to any matching query in the query manage\r\n   * @param entity\r\n   */\r\n  public addEntity(entity: Entity) {\r\n    for (const queryType in this._queries) {\r\n      if (this._queries[queryType]) {\r\n        this._queries[queryType].addEntity(entity);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes an entity from queries if the removed component disqualifies it\r\n   * @param entity\r\n   * @param component\r\n   */\r\n  public removeComponent(entity: Entity, component: Component) {\r\n    for (const queryType in this._queries) {\r\n      // If the component being removed from an entity is a part of a query,\r\n      // it is now disqualified from that query, remove it\r\n      if (this._queries[queryType].contain(component.type)) {\r\n        this._queries[queryType].removeEntity(entity);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes an entity from all queries it is currently a part of\r\n   * @param entity\r\n   */\r\n  public removeEntity(entity: Entity) {\r\n    for (const queryType in this._queries) {\r\n      this._queries[queryType].removeEntity(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates a populated query and returns, if the query already exists that will be returned instead of a new instance\r\n   * @param types\r\n   */\r\n  public createQuery<T extends Component = Component>(types: readonly string[]): Query<T> {\r\n    const maybeExistingQuery = this.getQuery<T>(types);\r\n    if (maybeExistingQuery) {\r\n      return maybeExistingQuery;\r\n    }\r\n    const query = new Query<T>(types);\r\n    this._addQuery(query);\r\n    return query;\r\n  }\r\n\r\n  /**\r\n   * Retrieves an existing query by types if it exists otherwise returns null\r\n   * @param types\r\n   */\r\n  public getQuery<T extends Component = Component>(types: readonly string[]): Query<T> {\r\n    const key = buildTypeKey(types);\r\n    if (this._queries[key]) {\r\n      return this._queries[key] as Query<T>;\r\n    }\r\n    return null;\r\n  }\r\n}\r\n","import { System, SystemType } from './System';\r\nimport { Scene, Util } from '..';\r\nimport { World } from './World';\r\n\r\nexport interface SystemCtor<T extends System> {\r\n  new (): T;\r\n}\r\n\r\n/**\r\n * The SystemManager is responsible for keeping track of all systems in a scene.\r\n * Systems are scene specific\r\n */\r\nexport class SystemManager<ContextType> {\r\n  /**\r\n   * List of systems, to add a new system call [[SystemManager.addSystem]]\r\n   */\r\n  public systems: System<any, ContextType>[] = [];\r\n  public _keyToSystem: { [key: string]: System<any, ContextType> };\r\n  public initialized = false;\r\n  constructor(private _world: World<ContextType>) {}\r\n\r\n  /**\r\n   * Get a system registered in the manager by type\r\n   * @param systemType\r\n   */\r\n  public get<T extends System>(systemType: SystemCtor<T>): T | null {\r\n    return this.systems.find((s) => s instanceof systemType) as unknown as T;\r\n  }\r\n\r\n  /**\r\n   * Adds a system to the manager, it will now be updated every frame\r\n   * @param system\r\n   */\r\n  public addSystem(system: System<any, ContextType>): void {\r\n    // validate system has types\r\n    if (!system.types || system.types.length === 0) {\r\n      throw new Error(`Attempted to add a System without any types`);\r\n    }\r\n\r\n    const query = this._world.queryManager.createQuery(system.types);\r\n    this.systems.push(system);\r\n    this.systems.sort((a, b) => a.priority - b.priority);\r\n    query.register(system);\r\n    if (this.initialized && system.initialize) {\r\n      system.initialize(this._world.context);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes a system from the manager, it will no longer be updated\r\n   * @param system\r\n   */\r\n  public removeSystem(system: System<any, ContextType>) {\r\n    Util.removeItemFromArray(system, this.systems);\r\n    const query = this._world.queryManager.getQuery(system.types);\r\n    if (query) {\r\n      query.unregister(system);\r\n      this._world.queryManager.maybeRemoveQuery(query);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize all systems in the manager\r\n   *\r\n   * Systems added after initialize() will be initialized on add\r\n   */\r\n  public initialize() {\r\n    if (!this.initialized) {\r\n      this.initialized = true;\r\n      for (const s of this.systems) {\r\n        if (s.initialize) {\r\n          s.initialize(this._world.context);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Updates all systems\r\n   * @param type whether this is an update or draw system\r\n   * @param context context reference\r\n   * @param delta time in milliseconds\r\n   */\r\n  public updateSystems(type: SystemType, context: ContextType, delta: number) {\r\n    const systems = this.systems.filter((s) => s.systemType === type);\r\n    for (const s of systems) {\r\n      if (s.preupdate) {\r\n        s.preupdate(context, delta);\r\n      }\r\n    }\r\n\r\n    for (const s of systems) {\r\n      // Get entities that match the system types, pre-sort\r\n      const entities = this._world.queryManager.getQuery(s.types).getEntities(s.sort);\r\n      // Initialize entities if needed\r\n      if (context instanceof Scene) {\r\n        for (const entity of entities) {\r\n          entity._initialize(context?.engine);\r\n        }\r\n      }\r\n      s.update(entities, delta);\r\n    }\r\n\r\n    for (const s of systems) {\r\n      if (s.postupdate) {\r\n        s.postupdate(context, delta);\r\n      }\r\n    }\r\n  }\r\n\r\n  public clear(): void {\r\n    for (const system of this.systems) {\r\n      this.removeSystem(system);\r\n    }\r\n  }\r\n}\r\n","import { Entity } from './Entity';\r\nimport { EntityManager } from './EntityManager';\r\nimport { QueryManager } from './QueryManager';\r\nimport { System, SystemType } from './System';\r\nimport { SystemManager } from './SystemManager';\r\n\r\n/**\r\n * The World is a self-contained entity component system for a particular context.\r\n */\r\nexport class World<ContextType> {\r\n  public queryManager: QueryManager = new QueryManager(this);\r\n  public entityManager: EntityManager<ContextType> = new EntityManager<ContextType>(this);\r\n  public systemManager: SystemManager<ContextType> = new SystemManager<ContextType>(this);\r\n\r\n  /**\r\n   * The context type is passed to the system updates\r\n   * @param context\r\n   */\r\n  constructor(public context: ContextType) {}\r\n\r\n  /**\r\n   * Update systems by type and time elapsed in milliseconds\r\n   */\r\n  update(type: SystemType, delta: number) {\r\n    if (type === SystemType.Update) {\r\n      this.entityManager.updateEntities(this.context, delta);\r\n    }\r\n    this.systemManager.updateSystems(type, this.context, delta);\r\n    this.entityManager.findEntitiesForRemoval();\r\n    this.entityManager.processComponentRemovals();\r\n    this.entityManager.processEntityRemovals();\r\n  }\r\n\r\n  /**\r\n   * Add an entity to the ECS world\r\n   * @param entity\r\n   */\r\n  add(entity: Entity): void;\r\n  /**\r\n   * Add a system to the ECS world\r\n   * @param system\r\n   */\r\n  add(system: System<any, ContextType>): void;\r\n  add(entityOrSystem: Entity | System<any, ContextType>): void {\r\n    if (entityOrSystem instanceof Entity) {\r\n      this.entityManager.addEntity(entityOrSystem);\r\n    }\r\n\r\n    if (entityOrSystem instanceof System) {\r\n      this.systemManager.addSystem(entityOrSystem);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove an entity from the ECS world\r\n   * @param entity\r\n   */\r\n  remove(entity: Entity, deferred?: boolean): void;\r\n  /**\r\n   * Remove a system from the ECS world\r\n   * @param system\r\n   */\r\n  remove(system: System<any, ContextType>): void;\r\n  remove(entityOrSystem: Entity | System<any, ContextType>, deferred = true): void {\r\n    if (entityOrSystem instanceof Entity) {\r\n      this.entityManager.removeEntity(entityOrSystem, deferred);\r\n    }\r\n\r\n    if (entityOrSystem instanceof System) {\r\n      this.systemManager.removeSystem(entityOrSystem);\r\n    }\r\n  }\r\n\r\n  clearEntities(): void {\r\n    this.entityManager.clear();\r\n  }\r\n\r\n  clearSystems(): void {\r\n    this.systemManager.clear();\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\r\nimport { TransformComponent } from '../EntityComponentSystem';\r\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\r\n\r\nexport class EulerIntegrator {\r\n  // Scratch vectors to avoid allocation\r\n  private static _POS = new Vector(0, 0);\r\n  private static _SCALE = new Vector(1, 1);\r\n\r\n  private static _ACC = new Vector(0, 0);\r\n  private static _VEL = new Vector(0, 0);\r\n  private static _VEL_ACC = new Vector(0, 0);\r\n  private static _SCALE_FACTOR = new Vector(0, 0);\r\n\r\n  static integrate(transform: TransformComponent, motion: MotionComponent, totalAcc: Vector, elapsedMs: number): void {\r\n    const seconds = elapsedMs / 1000;\r\n    // This code looks a little wild, but it's to avoid creating any new Vector instances\r\n    // integration is done in a tight loop so this is key to avoid GC'ing\r\n    motion.vel.addEqual(totalAcc.scale(seconds, EulerIntegrator._ACC));\r\n    transform.pos\r\n      .add(motion.vel.scale(seconds, EulerIntegrator._VEL), EulerIntegrator._POS)\r\n      .addEqual(totalAcc.scale(0.5 * seconds * seconds, EulerIntegrator._VEL_ACC));\r\n\r\n    motion.angularVelocity += motion.torque * (1.0 / motion.inertia) * seconds;\r\n    const rotation = transform.rotation + motion.angularVelocity * seconds;\r\n\r\n    transform.scale.add(motion.scaleFactor.scale(seconds, this._SCALE_FACTOR), EulerIntegrator._SCALE);\r\n    const tx = transform.get();\r\n    tx.setTransform(EulerIntegrator._POS, rotation, EulerIntegrator._SCALE);\r\n  }\r\n}\r\n","import { Entity } from '../EntityComponentSystem';\r\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { System, SystemType } from '../EntityComponentSystem/System';\r\nimport { Physics } from './Physics';\r\nimport { BodyComponent } from './BodyComponent';\r\nimport { CollisionType } from './CollisionType';\r\nimport { EulerIntegrator } from './Integrator';\r\n\r\nexport class MotionSystem extends System<TransformComponent | MotionComponent> {\r\n  public readonly types = ['ex.transform', 'ex.motion'] as const;\r\n  public systemType = SystemType.Update;\r\n  public priority = -1;\r\n\r\n  update(entities: Entity[], elapsedMs: number): void {\r\n    let transform: TransformComponent;\r\n    let motion: MotionComponent;\r\n    for (let i = 0; i < entities.length; i++) {\r\n      transform = entities[i].get(TransformComponent);\r\n      motion = entities[i].get(MotionComponent);\r\n\r\n      const optionalBody = entities[i].get(BodyComponent);\r\n      if (optionalBody?.sleeping) {\r\n        continue;\r\n      }\r\n\r\n      const totalAcc = motion.acc.clone();\r\n      if (optionalBody?.collisionType === CollisionType.Active && optionalBody?.useGravity) {\r\n        totalAcc.addEqual(Physics.gravity);\r\n      }\r\n      optionalBody?.captureOldTransform();\r\n\r\n      // Update transform and motion based on Euler linear algebra\r\n      EulerIntegrator.integrate(transform, motion, totalAcc, elapsedMs);\r\n    }\r\n  }\r\n}\r\n","import { PostCollisionEvent, PreCollisionEvent } from '../../Events';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { CollisionType } from '../CollisionType';\r\nimport { Side } from '../Side';\r\nimport { CollisionSolver } from './Solver';\r\nimport { BodyComponent } from '../BodyComponent';\r\n\r\n/**\r\n * ArcadeSolver is the default in Excalibur. It solves collisions so that there is no overlap between contacts,\r\n * and negates velocity along the collision normal.\r\n *\r\n * This is usually the type of collisions used for 2D games that don't need a more realistic collision simulation.\r\n *\r\n */\r\nexport class ArcadeSolver implements CollisionSolver {\r\n  directionMap = new Map<string, string>();\r\n  distanceMap = new Map<string, number>();\r\n\r\n  public solve(contacts: CollisionContact[]): CollisionContact[] {\r\n    // Events and init\r\n    this.preSolve(contacts);\r\n\r\n    // Remove any canceled contacts\r\n    contacts = contacts.filter(c => !c.isCanceled());\r\n\r\n    // Sort contacts by distance to avoid artifacts with seams\r\n    // It's important to solve in a specific order\r\n    contacts.sort((a, b) => {\r\n      const aDist = this.distanceMap.get(a.id);\r\n      const bDist = this.distanceMap.get(b.id);\r\n      return aDist - bDist;\r\n    });\r\n\r\n    for (const contact of contacts) {\r\n      // Solve position first in arcade\r\n      this.solvePosition(contact);\r\n\r\n      // Solve velocity second in arcade\r\n      this.solveVelocity(contact);\r\n    }\r\n\r\n    // Events and any contact house-keeping the solver needs\r\n    this.postSolve(contacts);\r\n\r\n    return contacts;\r\n  }\r\n\r\n  public preSolve(contacts: CollisionContact[]) {\r\n\r\n    for (const contact of contacts) {\r\n      const side = Side.fromDirection(contact.mtv);\r\n      const mtv = contact.mtv.negate();\r\n\r\n      const distance = contact.colliderA.worldPos.squareDistance(contact.colliderB.worldPos);\r\n      this.distanceMap.set(contact.id, distance);\r\n\r\n      // Publish collision events on both participants\r\n      contact.colliderA.events.emit('precollision', new PreCollisionEvent(contact.colliderA, contact.colliderB, side, mtv));\r\n      contact.colliderB.events.emit(\r\n        'precollision',\r\n        new PreCollisionEvent(contact.colliderB, contact.colliderA, Side.getOpposite(side), mtv.negate())\r\n      );\r\n    }\r\n  }\r\n\r\n  public postSolve(contacts: CollisionContact[]) {\r\n    for (const contact of contacts) {\r\n      if (contact.isCanceled()) {\r\n        continue;\r\n      }\r\n      const colliderA = contact.colliderA;\r\n      const colliderB = contact.colliderB;\r\n      const bodyA = colliderA.owner?.get(BodyComponent);\r\n      const bodyB = colliderB.owner?.get(BodyComponent);\r\n      if (bodyA && bodyB) {\r\n        if (bodyA.collisionType === CollisionType.Passive || bodyB.collisionType === CollisionType.Passive) {\r\n          continue;\r\n        }\r\n      }\r\n\r\n      const side = Side.fromDirection(contact.mtv);\r\n      const mtv = contact.mtv.negate();\r\n      // Publish collision events on both participants\r\n      contact.colliderA.events.emit('postcollision', new PostCollisionEvent(contact.colliderA, contact.colliderB, side, mtv));\r\n      contact.colliderB.events.emit(\r\n        'postcollision',\r\n        new PostCollisionEvent(contact.colliderB, contact.colliderA, Side.getOpposite(side), mtv.negate())\r\n      );\r\n    }\r\n  }\r\n\r\n  public solvePosition(contact: CollisionContact) {\r\n    const epsilon = .0001;\r\n    // if bounds no longer intersect skip to the next\r\n    // this removes jitter from overlapping/stacked solid tiles or a wall of solid tiles\r\n    if (!contact.colliderA.bounds.overlaps(contact.colliderB.bounds, epsilon)) {\r\n      // Cancel the contact to prevent and solving\r\n      contact.cancel();\r\n      return;\r\n    }\r\n\r\n    if (Math.abs(contact.mtv.x) < epsilon && Math.abs(contact.mtv.y) < epsilon) {\r\n      // Cancel near 0 mtv collisions\r\n      contact.cancel();\r\n      return;\r\n    }\r\n\r\n    let mtv = contact.mtv;\r\n    const colliderA = contact.colliderA;\r\n    const colliderB = contact.colliderB;\r\n    const bodyA = colliderA.owner?.get(BodyComponent);\r\n    const bodyB = colliderB.owner?.get(BodyComponent);\r\n    if (bodyA && bodyB) {\r\n      if (bodyA.collisionType === CollisionType.Passive || bodyB.collisionType === CollisionType.Passive) {\r\n        return;\r\n      }\r\n\r\n      if (bodyA.collisionType === CollisionType.Active && bodyB.collisionType === CollisionType.Active) {\r\n        // split overlaps if both are Active\r\n        mtv = mtv.scale(0.5);\r\n      }\r\n\r\n      // Resolve overlaps\r\n      if (bodyA.collisionType === CollisionType.Active) {\r\n        bodyA.globalPos.x -= mtv.x;\r\n        bodyA.globalPos.y -= mtv.y;\r\n        colliderA.update(bodyA.transform.get());\r\n      }\r\n\r\n      if (bodyB.collisionType === CollisionType.Active) {\r\n        bodyB.globalPos.x += mtv.x;\r\n        bodyB.globalPos.y += mtv.y;\r\n        colliderB.update(bodyB.transform.get());\r\n      }\r\n    }\r\n  }\r\n\r\n\r\n  public solveVelocity(contact: CollisionContact) {\r\n    if (contact.isCanceled()) {\r\n      return;\r\n    }\r\n\r\n    const colliderA = contact.colliderA;\r\n    const colliderB = contact.colliderB;\r\n    const bodyA = colliderA.owner?.get(BodyComponent);\r\n    const bodyB = colliderB.owner?.get(BodyComponent);\r\n\r\n    if (bodyA && bodyB) {\r\n\r\n      if (bodyA.collisionType === CollisionType.Passive || bodyB.collisionType === CollisionType.Passive) {\r\n        return;\r\n      }\r\n\r\n      const normal = contact.normal;\r\n      const opposite = normal.negate();\r\n\r\n      if (bodyA.collisionType === CollisionType.Active) {\r\n        // only adjust velocity if the contact normal is opposite to the current velocity\r\n        // this avoids catching edges on a platform when sliding off\r\n        if (bodyA.vel.normalize().dot(opposite) < 0) {\r\n          // Cancel out velocity opposite direction of collision normal\r\n          const velAdj = normal.scale(normal.dot(bodyA.vel.negate()));\r\n          bodyA.vel = bodyA.vel.add(velAdj);\r\n        }\r\n      }\r\n\r\n      if (bodyB.collisionType === CollisionType.Active) {\r\n        // only adjust velocity if the contact normal is opposite to the current velocity\r\n        // this avoids catching edges on a platform\r\n        if (bodyB.vel.normalize().dot(normal) < 0) {\r\n          const velAdj = opposite.scale(opposite.dot(bodyB.vel.negate()));\r\n          bodyB.vel = bodyB.vel.add(velAdj);\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Vector } from '../../Math/vector';\r\nimport { BodyComponent } from '../BodyComponent';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\n\r\n/**\r\n * Holds information about contact points, meant to be reused over multiple frames of contact\r\n */\r\nexport class ContactConstraintPoint {\r\n  constructor(public point: Vector, public local: Vector, public contact: CollisionContact) {\r\n    this.update();\r\n  }\r\n\r\n  /**\r\n   * Updates the contact information\r\n   */\r\n  update() {\r\n    const bodyA = this.contact.colliderA.owner?.get(BodyComponent);\r\n    const bodyB = this.contact.colliderB.owner?.get(BodyComponent);\r\n\r\n    if (bodyA && bodyB) {\r\n      const normal = this.contact.normal;\r\n      const tangent = this.contact.tangent;\r\n\r\n      this.aToContact = this.point.sub(bodyA.globalPos);\r\n      this.bToContact = this.point.sub(bodyB.globalPos);\r\n\r\n      const aToContactNormal = this.aToContact.cross(normal);\r\n      const bToContactNormal = this.bToContact.cross(normal);\r\n\r\n      this.normalMass =\r\n        bodyA.inverseMass +\r\n        bodyB.inverseMass +\r\n        bodyA.inverseInertia * aToContactNormal * aToContactNormal +\r\n        bodyB.inverseInertia * bToContactNormal * bToContactNormal;\r\n\r\n      const aToContactTangent = this.aToContact.cross(tangent);\r\n      const bToContactTangent = this.bToContact.cross(tangent);\r\n\r\n      this.tangentMass =\r\n        bodyA.inverseMass +\r\n        bodyB.inverseMass +\r\n        bodyA.inverseInertia * aToContactTangent * aToContactTangent +\r\n        bodyB.inverseInertia * bToContactTangent * bToContactTangent;\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Returns the relative velocity between bodyA and bodyB\r\n   */\r\n  public getRelativeVelocity() {\r\n    const bodyA = this.contact.colliderA.owner?.get(BodyComponent);\r\n    const bodyB = this.contact.colliderB.owner?.get(BodyComponent);\r\n    if (bodyA && bodyB) {\r\n      // Relative velocity in linear terms\r\n      // Angular to linear velocity formula -> omega = velocity/radius so omega x radius = velocity\r\n      const velA = bodyA.vel.add(Vector.cross(bodyA.angularVelocity, this.aToContact));\r\n      const velB = bodyB.vel.add(Vector.cross(bodyB.angularVelocity, this.bToContact));\r\n      return velB.sub(velA);\r\n    }\r\n    return Vector.Zero;\r\n  }\r\n\r\n  /**\r\n   * Impulse accumulated over time in normal direction\r\n   */\r\n  public normalImpulse: number = 0;\r\n\r\n  /**\r\n   * Impulse accumulated over time in the tangent direction\r\n   */\r\n  public tangentImpulse: number = 0;\r\n\r\n  /**\r\n   * Effective mass seen in the normal direction\r\n   */\r\n  public normalMass: number = 0;\r\n\r\n  /**\r\n   * Effective mass seen in the tangent direction\r\n   */\r\n  public tangentMass: number = 0;\r\n\r\n  /**\r\n   * Direction from center of mass of bodyA to contact point\r\n   */\r\n  public aToContact: Vector = new Vector(0, 0);\r\n\r\n  /**\r\n   * Direction from center of mass of bodyB to contact point\r\n   */\r\n  public bToContact: Vector = new Vector(0, 0);\r\n\r\n  /**\r\n   * Original contact velocity combined with bounciness\r\n   */\r\n  public originalVelocityAndRestitution: number = 0;\r\n}\r\n","import { CollisionPostSolveEvent, CollisionPreSolveEvent, PostCollisionEvent, PreCollisionEvent } from '../../Events';\r\nimport { clamp } from '../../Math/util';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { CollisionType } from '../CollisionType';\r\nimport { ContactConstraintPoint } from './ContactConstraintPoint';\r\nimport { Side } from '../Side';\r\nimport { Physics } from '../Physics';\r\nimport { CollisionSolver } from './Solver';\r\nimport { BodyComponent, DegreeOfFreedom } from '../BodyComponent';\r\nimport { CollisionJumpTable } from '../Colliders/CollisionJumpTable';\r\n\r\nexport class RealisticSolver implements CollisionSolver {\r\n  lastFrameContacts: Map<string, CollisionContact> = new Map();\r\n\r\n  // map contact id to contact points\r\n  idToContactConstraint: Map<string, ContactConstraintPoint[]> = new Map();\r\n\r\n  getContactConstraints(id: string) {\r\n    return this.idToContactConstraint.get(id) ?? [];\r\n  }\r\n\r\n  public solve(contacts: CollisionContact[]): CollisionContact[] {\r\n    // Events and init\r\n    this.preSolve(contacts);\r\n\r\n    // Remove any canceled contacts\r\n    contacts = contacts.filter(c => !c.isCanceled());\r\n\r\n    // Solve velocity first\r\n    this.solveVelocity(contacts);\r\n\r\n    // Solve position last because non-overlap is the most important\r\n    this.solvePosition(contacts);\r\n\r\n    // Events and any contact house-keeping the solver needs\r\n    this.postSolve(contacts);\r\n\r\n    return contacts;\r\n  }\r\n\r\n  preSolve(contacts: CollisionContact[]) {\r\n    for (const contact of contacts) {\r\n      // Publish collision events on both participants\r\n      const side = Side.fromDirection(contact.mtv);\r\n      contact.colliderA.events.emit('precollision', new PreCollisionEvent(contact.colliderA, contact.colliderB, side, contact.mtv));\r\n      contact.colliderA.events.emit(\r\n        'beforecollisionresolve',\r\n        new CollisionPreSolveEvent(contact.colliderA, contact.colliderB, side, contact.mtv, contact) as any\r\n      );\r\n      contact.colliderB.events.emit(\r\n        'precollision',\r\n        new PreCollisionEvent(contact.colliderB, contact.colliderA, Side.getOpposite(side), contact.mtv.negate())\r\n      );\r\n      contact.colliderB.events.emit(\r\n        'beforecollisionresolve',\r\n        new CollisionPreSolveEvent(contact.colliderB, contact.colliderA, Side.getOpposite(side), contact.mtv.negate(), contact) as any\r\n      );\r\n\r\n      // Match awake state for sleeping\r\n      contact.matchAwake();\r\n    }\r\n\r\n    // Keep track of contacts that done\r\n    const finishedContactIds = Array.from(this.idToContactConstraint.keys());\r\n    for (const contact of contacts) {\r\n      // Remove all current contacts that are not done\r\n      const index = finishedContactIds.indexOf(contact.id);\r\n      if (index > -1) {\r\n        finishedContactIds.splice(index, 1);\r\n      }\r\n      const contactPoints = this.idToContactConstraint.get(contact.id) ?? [];\r\n\r\n      let pointIndex = 0;\r\n      const bodyA = contact.colliderA.owner.get(BodyComponent);\r\n      const bodyB = contact.colliderB.owner.get(BodyComponent);\r\n      if (bodyA && bodyB) {\r\n        for (const point of contact.points) {\r\n          const normal = contact.normal;\r\n          const tangent = contact.tangent;\r\n\r\n          const aToContact = point.sub(bodyA.globalPos);\r\n          const bToContact = point.sub(bodyB.globalPos);\r\n\r\n          const aToContactNormal = aToContact.cross(normal);\r\n          const bToContactNormal = bToContact.cross(normal);\r\n\r\n          const normalMass =\r\n            bodyA.inverseMass +\r\n            bodyB.inverseMass +\r\n            bodyA.inverseInertia * aToContactNormal * aToContactNormal +\r\n            bodyB.inverseInertia * bToContactNormal * bToContactNormal;\r\n\r\n          const aToContactTangent = aToContact.cross(tangent);\r\n          const bToContactTangent = bToContact.cross(tangent);\r\n\r\n          const tangentMass =\r\n            bodyA.inverseMass +\r\n            bodyB.inverseMass +\r\n            bodyA.inverseInertia * aToContactTangent * aToContactTangent +\r\n            bodyB.inverseInertia * bToContactTangent * bToContactTangent;\r\n\r\n          // Preserve normal/tangent impulse by re-using the contact point if it's close\r\n          if (contactPoints[pointIndex] && contactPoints[pointIndex]?.point?.squareDistance(point) < 4) {\r\n            contactPoints[pointIndex].point = point;\r\n            contactPoints[pointIndex].local = contact.localPoints[pointIndex];\r\n          } else {\r\n            // new contact if it's not close or doesn't exist\r\n            contactPoints[pointIndex] = new ContactConstraintPoint(point, contact.localPoints[pointIndex], contact);\r\n          }\r\n\r\n          // Update contact point calculations\r\n          contactPoints[pointIndex].aToContact = aToContact;\r\n          contactPoints[pointIndex].bToContact = bToContact;\r\n          contactPoints[pointIndex].normalMass = 1.0 / normalMass;\r\n          contactPoints[pointIndex].tangentMass = 1.0 / tangentMass;\r\n\r\n          // Calculate relative velocity before solving to accurately do restitution\r\n          const restitution = bodyA.bounciness > bodyB.bounciness ? bodyA.bounciness : bodyB.bounciness;\r\n          const relativeVelocity = contact.normal.dot(contactPoints[pointIndex].getRelativeVelocity());\r\n          contactPoints[pointIndex].originalVelocityAndRestitution = 0;\r\n          if (relativeVelocity < -0.1) { // TODO what's a good threshold here?\r\n            contactPoints[pointIndex].originalVelocityAndRestitution = -restitution * relativeVelocity;\r\n          }\r\n          pointIndex++;\r\n        }\r\n      }\r\n      this.idToContactConstraint.set(contact.id, contactPoints);\r\n    }\r\n\r\n    // Clean up any contacts that did not occur last frame\r\n    for (const id of finishedContactIds) {\r\n      this.idToContactConstraint.delete(id);\r\n    }\r\n\r\n    // Warm contacts with accumulated impulse\r\n    // Useful for tall stacks\r\n    if (Physics.warmStart) {\r\n      this.warmStart(contacts);\r\n    } else {\r\n      for (const contact of contacts) {\r\n        const contactPoints = this.getContactConstraints(contact.id);\r\n        for (const point of contactPoints) {\r\n          point.normalImpulse = 0;\r\n          point.tangentImpulse = 0;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  postSolve(contacts: CollisionContact[]) {\r\n    for (const contact of contacts) {\r\n      const bodyA = contact.colliderA.owner.get(BodyComponent);\r\n      const bodyB = contact.colliderB.owner.get(BodyComponent);\r\n\r\n      if (bodyA && bodyB) {\r\n        // Skip post solve for active+passive collisions\r\n        if (bodyA.collisionType === CollisionType.Passive || bodyB.collisionType === CollisionType.Passive) {\r\n          continue;\r\n        }\r\n\r\n        // Update motion values for sleeping\r\n        bodyA.updateMotion();\r\n        bodyB.updateMotion();\r\n      }\r\n\r\n      // Publish collision events on both participants\r\n      const side = Side.fromDirection(contact.mtv);\r\n      contact.colliderA.events.emit('postcollision', new PostCollisionEvent(contact.colliderA, contact.colliderB, side, contact.mtv));\r\n      contact.colliderA.events.emit(\r\n        'aftercollisionresolve',\r\n        new CollisionPostSolveEvent(contact.colliderA, contact.colliderB, side, contact.mtv, contact) as any\r\n      );\r\n      contact.colliderB.events.emit(\r\n        'postcollision',\r\n        new PostCollisionEvent(contact.colliderB, contact.colliderA, Side.getOpposite(side), contact.mtv.negate())\r\n      );\r\n      contact.colliderB.events.emit(\r\n        'aftercollisionresolve',\r\n        new CollisionPostSolveEvent(contact.colliderB, contact.colliderA, Side.getOpposite(side), contact.mtv.negate(), contact) as any\r\n      );\r\n    }\r\n\r\n    // Store contacts\r\n    this.lastFrameContacts.clear();\r\n    for (const c of contacts) {\r\n      this.lastFrameContacts.set(c.id, c);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Warm up body's based on previous frame contact points\r\n   * @param contacts\r\n   */\r\n  warmStart(contacts: CollisionContact[]) {\r\n    for (const contact of contacts) {\r\n      const bodyA = contact.colliderA.owner?.get(BodyComponent);\r\n      const bodyB = contact.colliderB.owner?.get(BodyComponent);\r\n      if (bodyA && bodyB) {\r\n        const contactPoints = this.idToContactConstraint.get(contact.id) ?? [];\r\n        for (const point of contactPoints) {\r\n          if (Physics.warmStart) {\r\n            const normalImpulse = contact.normal.scale(point.normalImpulse);\r\n            const tangentImpulse = contact.tangent.scale(point.tangentImpulse);\r\n            const impulse = normalImpulse.add(tangentImpulse);\r\n\r\n            bodyA.applyImpulse(point.point, impulse.negate());\r\n            bodyB.applyImpulse(point.point, impulse);\r\n          } else {\r\n            point.normalImpulse = 0;\r\n            point.tangentImpulse = 0;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Iteratively solve the position overlap constraint\r\n   * @param contacts\r\n   */\r\n  solvePosition(contacts: CollisionContact[]) {\r\n    for (let i = 0; i < Physics.positionIterations; i++) {\r\n      for (const contact of contacts) {\r\n        const bodyA = contact.colliderA.owner?.get(BodyComponent);\r\n        const bodyB = contact.colliderB.owner?.get(BodyComponent);\r\n\r\n        if (bodyA && bodyB) {\r\n          // Skip solving active+passive\r\n          if (bodyA.collisionType === CollisionType.Passive || bodyB.collisionType === CollisionType.Passive) {\r\n            continue;\r\n          }\r\n\r\n          const constraints = this.idToContactConstraint.get(contact.id) ?? [];\r\n          for (const point of constraints) {\r\n            const normal = contact.normal;\r\n            const separation = CollisionJumpTable.FindContactSeparation(contact, point.local);\r\n\r\n            const steeringConstant = Physics.steeringFactor; //0.2;\r\n            const maxCorrection = -5;\r\n            const slop = Physics.slop; //1;\r\n\r\n            // Clamp to avoid over-correction\r\n            // Remember that we are shooting for 0 overlap in the end\r\n            const steeringForce = clamp(steeringConstant * (separation + slop), maxCorrection, 0);\r\n            const impulse = normal.scale(-steeringForce * point.normalMass);\r\n\r\n            // This is a pseudo impulse, meaning we aren't doing a real impulse calculation\r\n            // We adjust position and rotation instead of doing the velocity\r\n            if (bodyA.collisionType === CollisionType.Active) {\r\n              // TODO make applyPseudoImpulse function?\r\n              const impulseForce = impulse.negate().scale(bodyA.inverseMass);\r\n              if (bodyA.limitDegreeOfFreedom.includes(DegreeOfFreedom.X)) {\r\n                impulseForce.x = 0;\r\n              }\r\n              if (bodyA.limitDegreeOfFreedom.includes(DegreeOfFreedom.Y)) {\r\n                impulseForce.y = 0;\r\n              }\r\n\r\n              bodyA.globalPos = bodyA.globalPos.add(impulseForce);\r\n              if (!bodyA.limitDegreeOfFreedom.includes(DegreeOfFreedom.Rotation)) {\r\n                bodyA.rotation -= point.aToContact.cross(impulse) * bodyA.inverseInertia;\r\n              }\r\n            }\r\n\r\n            if (bodyB.collisionType === CollisionType.Active) {\r\n              const impulseForce = impulse.scale(bodyB.inverseMass);\r\n              if (bodyB.limitDegreeOfFreedom.includes(DegreeOfFreedom.X)) {\r\n                impulseForce.x = 0;\r\n              }\r\n              if (bodyB.limitDegreeOfFreedom.includes(DegreeOfFreedom.Y)) {\r\n                impulseForce.y = 0;\r\n              }\r\n\r\n              bodyB.globalPos = bodyB.globalPos.add(impulseForce);\r\n              if (!bodyB.limitDegreeOfFreedom.includes(DegreeOfFreedom.Rotation)) {\r\n                bodyB.rotation += point.bToContact.cross(impulse) * bodyB.inverseInertia;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  solveVelocity(contacts: CollisionContact[]) {\r\n    for (let i = 0; i < Physics.velocityIterations; i++) {\r\n      for (const contact of contacts) {\r\n        const bodyA = contact.colliderA.owner?.get(BodyComponent);\r\n        const bodyB = contact.colliderB.owner?.get(BodyComponent);\r\n\r\n        if (bodyA && bodyB) {\r\n          // Skip solving active+passive\r\n          if (bodyA.collisionType === CollisionType.Passive || bodyB.collisionType === CollisionType.Passive) {\r\n            continue;\r\n          }\r\n\r\n          const friction = Math.min(bodyA.friction, bodyB.friction);\r\n\r\n          const constraints = this.idToContactConstraint.get(contact.id) ?? [];\r\n\r\n          // Friction constraint\r\n          for (const point of constraints) {\r\n            const relativeVelocity = point.getRelativeVelocity();\r\n\r\n            // Negate velocity in tangent direction to simulate friction\r\n            const tangentVelocity = -relativeVelocity.dot(contact.tangent);\r\n            let impulseDelta = tangentVelocity * point.tangentMass;\r\n\r\n            // Clamping based in Erin Catto's GDC 2006 talk\r\n            // Correct clamping https://github.com/erincatto/box2d-lite/blob/master/docs/GDC2006_Catto_Erin_PhysicsTutorial.pdf\r\n            // Accumulated fiction impulse is always between -uMaxFriction < dT < uMaxFriction\r\n            // But deltas can vary\r\n            const maxFriction = friction * point.normalImpulse;\r\n            const newImpulse = clamp(point.tangentImpulse + impulseDelta, -maxFriction, maxFriction);\r\n            impulseDelta = newImpulse - point.tangentImpulse;\r\n            point.tangentImpulse = newImpulse;\r\n\r\n            const impulse = contact.tangent.scale(impulseDelta);\r\n            bodyA.applyImpulse(point.point, impulse.negate());\r\n            bodyB.applyImpulse(point.point, impulse);\r\n          }\r\n\r\n          // Bounce constraint\r\n          for (const point of constraints) {\r\n            // Need to recalc relative velocity because the previous step could have changed vel\r\n            const relativeVelocity = point.getRelativeVelocity();\r\n\r\n            // Compute impulse in normal direction\r\n            const normalVelocity = relativeVelocity.dot(contact.normal);\r\n\r\n            // Per Erin it is a mistake to apply the restitution inside the iteration\r\n            // From Erin Catto's Box2D we keep original contact velocity and adjust by small impulses\r\n            let impulseDelta = -point.normalMass * (normalVelocity - point.originalVelocityAndRestitution);\r\n\r\n            // Clamping based in Erin Catto's GDC 2014 talk\r\n            // Accumulated impulse stored in the contact is always positive (dV > 0)\r\n            // But deltas can be negative\r\n            const newImpulse = Math.max(point.normalImpulse + impulseDelta, 0);\r\n            impulseDelta = newImpulse - point.normalImpulse;\r\n            point.normalImpulse = newImpulse;\r\n\r\n            const impulse = contact.normal.scale(impulseDelta);\r\n            bodyA.applyImpulse(point.point, impulse.negate());\r\n            bodyB.applyImpulse(point.point, impulse);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Entity } from '../EntityComponentSystem';\r\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { AddedEntity, isAddedSystemEntity, RemovedEntity, System, SystemType } from '../EntityComponentSystem/System';\r\nimport { CollisionEndEvent, CollisionStartEvent, ContactEndEvent, ContactStartEvent } from '../Events';\r\nimport { CollisionResolutionStrategy, Physics } from './Physics';\r\nimport { ArcadeSolver } from './Solver/ArcadeSolver';\r\nimport { Collider } from './Colliders/Collider';\r\nimport { CollisionContact } from './Detection/CollisionContact';\r\nimport { DynamicTreeCollisionProcessor } from './Detection/DynamicTreeCollisionProcessor';\r\nimport { RealisticSolver } from './Solver/RealisticSolver';\r\nimport { CollisionSolver } from './Solver/Solver';\r\nimport { ColliderComponent } from './ColliderComponent';\r\nimport { CompositeCollider } from './Colliders/CompositeCollider';\r\nimport { Engine, ExcaliburGraphicsContext, Scene } from '..';\r\n\r\nexport class CollisionSystem extends System<TransformComponent | MotionComponent | ColliderComponent> {\r\n  public readonly types = ['ex.transform', 'ex.motion', 'ex.collider'] as const;\r\n  public systemType = SystemType.Update;\r\n  public priority = -1;\r\n\r\n  private _engine: Engine;\r\n  private _realisticSolver = new RealisticSolver();\r\n  private _arcadeSolver = new ArcadeSolver();\r\n  private _processor = new DynamicTreeCollisionProcessor();\r\n  private _lastFrameContacts = new Map<string, CollisionContact>();\r\n  private _currentFrameContacts = new Map<string, CollisionContact>();\r\n\r\n  private _trackCollider = (c: Collider) => this._processor.track(c);\r\n  private _untrackCollider = (c: Collider) => this._processor.untrack(c);\r\n\r\n  notify(message: AddedEntity | RemovedEntity) {\r\n    if (isAddedSystemEntity(message)) {\r\n      const colliderComponent = message.data.get(ColliderComponent);\r\n      colliderComponent.$colliderAdded.subscribe(this._trackCollider);\r\n      colliderComponent.$colliderRemoved.subscribe(this._untrackCollider);\r\n      const collider = colliderComponent.get();\r\n      if (collider) {\r\n        this._processor.track(collider);\r\n      }\r\n    } else {\r\n      const colliderComponent = message.data.get(ColliderComponent);\r\n      const collider = colliderComponent.get();\r\n      if (colliderComponent && collider) {\r\n        this._processor.untrack(collider);\r\n      }\r\n    }\r\n  }\r\n\r\n  initialize(scene: Scene) {\r\n    this._engine = scene.engine;\r\n  }\r\n\r\n  update(entities: Entity[], elapsedMs: number): void {\r\n    if (!Physics.enabled) {\r\n      return;\r\n    }\r\n\r\n    // Collect up all the colliders and update them\r\n    let colliders: Collider[] = [];\r\n    for (const entity of entities) {\r\n      const colliderComp = entity.get(ColliderComponent);\r\n      const collider = colliderComp?.get();\r\n      if (colliderComp && colliderComp.owner?.active && collider) {\r\n        colliderComp.update();\r\n        if (collider instanceof CompositeCollider) {\r\n          const compositeColliders = collider.getColliders();\r\n          colliders = colliders.concat(compositeColliders);\r\n        } else {\r\n          colliders.push(collider);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Update the spatial partitioning data structures\r\n    // TODO if collider invalid it will break the processor\r\n    // TODO rename \"update\" to something more specific\r\n    this._processor.update(colliders);\r\n\r\n    // Run broadphase on all colliders and locates potential collisions\r\n    const pairs = this._processor.broadphase(colliders, elapsedMs);\r\n\r\n    this._currentFrameContacts.clear();\r\n\r\n    // Given possible pairs find actual contacts\r\n    let contacts = this._processor.narrowphase(pairs, this._engine?.debug?.stats?.currFrame);\r\n\r\n    const solver: CollisionSolver = this.getSolver();\r\n\r\n    // Solve, this resolves the position/velocity so entities aren't overlapping\r\n    contacts = solver.solve(contacts);\r\n\r\n    // Record contacts for start/end\r\n    for (const contact of contacts) {\r\n      // Process composite ids, things with the same composite id are treated as the same collider for start/end\r\n      const index = contact.id.indexOf('|');\r\n      if (index > 0) {\r\n        const compositeId = contact.id.substring(index + 1);\r\n        this._currentFrameContacts.set(compositeId, contact);\r\n      } else {\r\n        this._currentFrameContacts.set(contact.id, contact);\r\n      }\r\n    }\r\n\r\n    // Emit contact start/end events\r\n    this.runContactStartEnd();\r\n\r\n    // reset the last frame cache\r\n    this._lastFrameContacts.clear();\r\n\r\n    // Keep track of collisions contacts that have started or ended\r\n    this._lastFrameContacts = new Map(this._currentFrameContacts);\r\n  }\r\n\r\n  getSolver(): CollisionSolver {\r\n    return Physics.collisionResolutionStrategy === CollisionResolutionStrategy.Realistic ? this._realisticSolver : this._arcadeSolver;\r\n  }\r\n\r\n  debug(ex: ExcaliburGraphicsContext) {\r\n    this._processor.debug(ex);\r\n  }\r\n\r\n  public runContactStartEnd() {\r\n    // Composite collider collisions may have a duplicate id because we want to treat those as a singular start/end\r\n    for (const [id, c] of this._currentFrameContacts) {\r\n      // find all new contacts\r\n      if (!this._lastFrameContacts.has(id)) {\r\n        const colliderA = c.colliderA;\r\n        const colliderB = c.colliderB;\r\n        colliderA.events.emit('collisionstart', new CollisionStartEvent(colliderA, colliderB, c));\r\n        colliderA.events.emit('contactstart', new ContactStartEvent(colliderA, colliderB, c) as any);\r\n        colliderB.events.emit('collisionstart', new CollisionStartEvent(colliderB, colliderA, c));\r\n        colliderB.events.emit('contactstart', new ContactStartEvent(colliderB, colliderA, c) as any);\r\n      }\r\n    }\r\n\r\n    // find all contacts that have ceased\r\n    for (const [id, c] of this._lastFrameContacts) {\r\n      if (!this._currentFrameContacts.has(id)) {\r\n        const colliderA = c.colliderA;\r\n        const colliderB = c.colliderB;\r\n        colliderA.events.emit('collisionend', new CollisionEndEvent(colliderA, colliderB));\r\n        colliderA.events.emit('contactend', new ContactEndEvent(colliderA, colliderB) as any);\r\n        colliderB.events.emit('collisionend', new CollisionEndEvent(colliderB, colliderA));\r\n        colliderB.events.emit('contactend', new ContactEndEvent(colliderB, colliderA) as any);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Graphic, GraphicOptions } from './Graphic';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { EventDispatcher } from '../EventDispatcher';\r\nimport { SpriteSheet } from './SpriteSheet';\r\nimport { Logger } from '../Util/Log';\r\nimport { clamp } from '../Math/util';\r\n\r\nexport interface HasTick {\r\n  /**\r\n   *\r\n   * @param elapsedMilliseconds The amount of real world time in milliseconds that has elapsed that must be updated in the animation\r\n   * @param idempotencyToken Optional idempotencyToken prevents a ticking animation from updating twice per frame\r\n   */\r\n  tick(elapsedMilliseconds: number, idempotencyToken?: number): void;\r\n}\r\n\r\nexport enum AnimationDirection {\r\n  /**\r\n   * Animation is playing forwards\r\n   */\r\n  Forward = 'forward',\r\n  /**\r\n   * Animation is play backwards\r\n   */\r\n  Backward = 'backward'\r\n}\r\n\r\nexport enum AnimationStrategy {\r\n  /**\r\n   * Animation ends without displaying anything\r\n   */\r\n  End = 'end',\r\n  /**\r\n   * Animation loops to the first frame after the last frame\r\n   */\r\n  Loop = 'loop',\r\n  /**\r\n   * Animation plays to the last frame, then backwards to the first frame, then repeats\r\n   */\r\n  PingPong = 'pingpong',\r\n  /**\r\n   * Animation ends stopping on the last frame\r\n   */\r\n  Freeze = 'freeze'\r\n}\r\n\r\n/**\r\n * Frame of animation\r\n */\r\nexport interface Frame {\r\n  /**\r\n   * Optionally specify a graphic to show, no graphic shows an empty frame\r\n   */\r\n  graphic?: Graphic;\r\n  /**\r\n   * Optionally specify the number of ms the frame should be visible, overrides the animation duration (default 100 ms)\r\n   */\r\n  duration?: number;\r\n}\r\n\r\n/**\r\n * Animation options for building an animation via constructor.\r\n */\r\nexport interface AnimationOptions {\r\n  /**\r\n   * List of frames in the order you wish to play them\r\n   */\r\n  frames: Frame[];\r\n  /**\r\n   * Optionally reverse the direction of play\r\n   */\r\n  reverse?: boolean;\r\n  /**\r\n   * Optionally specify a default frame duration in ms (Default is 1000)\r\n   */\r\n  frameDuration?: number;\r\n  /**\r\n   * Optionally specify a total duration of the animation in ms to calculate each frame's duration\r\n   */\r\n  totalDuration?: number;\r\n  /**\r\n   * Optionally specify the [[AnimationStrategy]] for the Animation\r\n   */\r\n  strategy?: AnimationStrategy;\r\n}\r\n\r\n// TODO wire up to new Emitter\r\nexport type AnimationEvents = {\r\n  frame: Frame;\r\n  loop: Animation;\r\n  ended: Animation;\r\n};\r\n\r\n/**\r\n * Create an Animation given a list of [[Frame|frames]] in [[AnimationOptions]]\r\n *\r\n * To create an Animation from a [[SpriteSheet]], use [[Animation.fromSpriteSheet]]\r\n */\r\nexport class Animation extends Graphic implements HasTick {\r\n  private static _LOGGER = Logger.getInstance();\r\n  public events = new EventDispatcher<any>(); // TODO replace with new Emitter\r\n  public frames: Frame[] = [];\r\n  public strategy: AnimationStrategy = AnimationStrategy.Loop;\r\n  public frameDuration: number = 100;\r\n  public timeScale: number = 1;\r\n\r\n  private _idempotencyToken = -1;\r\n\r\n  private _firstTick = true;\r\n  private _currentFrame = 0;\r\n  private _timeLeftInFrame = 0;\r\n  private _direction = 1; // TODO only used in ping-pong\r\n  private _done = false;\r\n  private _playing = true;\r\n\r\n  constructor(options: GraphicOptions & AnimationOptions) {\r\n    super(options);\r\n    this.frames = options.frames;\r\n    this.strategy = options.strategy ?? this.strategy;\r\n    this.frameDuration = options.totalDuration ? options.totalDuration / this.frames.length : options.frameDuration ?? this.frameDuration;\r\n    if (options.reverse) {\r\n      this.reverse();\r\n    }\r\n    this.goToFrame(0);\r\n  }\r\n\r\n  public clone(): Animation {\r\n    return new Animation({\r\n      frames: this.frames.map((f) => ({ ...f })),\r\n      frameDuration: this.frameDuration,\r\n      reverse: this._reversed,\r\n      strategy: this.strategy,\r\n      ...this.cloneGraphicOptions()\r\n    });\r\n  }\r\n\r\n  public override get width(): number {\r\n    const maybeFrame = this.currentFrame;\r\n    if (maybeFrame) {\r\n      return Math.abs(maybeFrame.graphic.width * this.scale.x);\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  public override get height(): number {\r\n    const maybeFrame = this.currentFrame;\r\n    if (maybeFrame) {\r\n      return Math.abs(maybeFrame.graphic.height * this.scale.y);\r\n    }\r\n    return 0;\r\n  }\r\n\r\n\r\n  /**\r\n   * Create an Animation from a [[SpriteSheet]], a list of indices into the sprite sheet, a duration per frame\r\n   * and optional [[AnimationStrategy]]\r\n   *\r\n   * Example:\r\n   * ```typescript\r\n   * const spriteSheet = SpriteSheet.fromImageSource({...});\r\n   *\r\n   * const anim = Animation.fromSpriteSheet(spriteSheet, range(0, 5), 200, AnimationStrategy.Loop);\r\n   * ```\r\n   *\r\n   * @param spriteSheet\r\n   * @param frameIndices\r\n   * @param durationPerFrameMs\r\n   * @param strategy\r\n   */\r\n  public static fromSpriteSheet(\r\n    spriteSheet: SpriteSheet,\r\n    frameIndices: number[],\r\n    durationPerFrameMs: number,\r\n    strategy: AnimationStrategy = AnimationStrategy.Loop\r\n  ): Animation {\r\n    const maxIndex = spriteSheet.sprites.length - 1;\r\n    const invalidIndices = frameIndices.filter((index) => index < 0 || index > maxIndex);\r\n    if (invalidIndices.length) {\r\n      Animation._LOGGER.warn(\r\n        `Indices into SpriteSheet were provided that don\\'t exist: ${invalidIndices.join(',')} no frame will be shown`\r\n      );\r\n    }\r\n    return new Animation({\r\n      frames: spriteSheet.sprites\r\n        .filter((_, index) => frameIndices.indexOf(index) > -1)\r\n        .map((f) => ({\r\n          graphic: f,\r\n          duration: durationPerFrameMs\r\n        })),\r\n      strategy: strategy\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Returns the current Frame of the animation\r\n   */\r\n  public get currentFrame(): Frame | null {\r\n    if (this._currentFrame >= 0 && this._currentFrame < this.frames.length) {\r\n      return this.frames[this._currentFrame];\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Returns the current frame index of the animation\r\n   */\r\n  public get currentFrameIndex(): number {\r\n    return this._currentFrame;\r\n  }\r\n\r\n  /**\r\n   * Returns `true` if the animation is playing\r\n   */\r\n  public get isPlaying(): boolean {\r\n    return this._playing;\r\n  }\r\n\r\n  private _reversed = false;\r\n  /**\r\n   * Reverses the play direction of the Animation, this preserves the current frame\r\n   */\r\n  public reverse(): void {\r\n    // Don't mutate with the original frame list, create a copy\r\n    this.frames = this.frames.slice().reverse();\r\n    this._reversed = !this._reversed;\r\n  }\r\n\r\n  /**\r\n   * Returns the current play direction of the animation\r\n   */\r\n  public get direction(): AnimationDirection {\r\n    // Keep logically consistent with ping-pong direction\r\n    // If ping-pong is forward = 1 and reversed is true then we are logically reversed\r\n    const reversed = (this._reversed && this._direction === 1) ? true : false;\r\n    return reversed ? AnimationDirection.Backward : AnimationDirection.Forward;\r\n  }\r\n\r\n  /**\r\n   * Plays or resumes the animation from the current frame\r\n   */\r\n  public play(): void {\r\n    this._playing = true;\r\n  }\r\n\r\n  /**\r\n   * Pauses the animation on the current frame\r\n   */\r\n  public pause(): void {\r\n    this._playing = false;\r\n    this._firstTick = true; // firstTick must be set to emit the proper frame event\r\n  }\r\n\r\n  /**\r\n   * Reset the animation back to the beginning, including if the animation were done\r\n   */\r\n  public reset(): void {\r\n    this._done = false;\r\n    this._firstTick = true;\r\n    this._currentFrame = 0;\r\n  }\r\n\r\n  /**\r\n   * Returns `true` if the animation can end\r\n   */\r\n  public get canFinish(): boolean {\r\n    switch (this.strategy) {\r\n      case AnimationStrategy.End:\r\n      case AnimationStrategy.Freeze: {\r\n        return true;\r\n      }\r\n      default: {\r\n        return false;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns `true` if the animation is done, for looping type animations\r\n   * `ex.AnimationStrategy.PingPong` and `ex.AnimationStrategy.Loop` this will always return `false`\r\n   *\r\n   * See the `ex.Animation.canFinish()` method to know if an animation type can end\r\n   */\r\n  public get done(): boolean {\r\n    return this._done;\r\n  }\r\n\r\n  /**\r\n   * Jump the animation immediately to a specific frame if it exists\r\n   * @param frameNumber\r\n   */\r\n  public goToFrame(frameNumber: number) {\r\n    this._currentFrame = frameNumber;\r\n    this._timeLeftInFrame = this.frameDuration;\r\n    const maybeFrame = this.frames[this._currentFrame];\r\n    if (maybeFrame && !this._done) {\r\n      this._timeLeftInFrame = maybeFrame?.duration || this.frameDuration;\r\n      this.events.emit('frame', maybeFrame as any);\r\n    }\r\n  }\r\n\r\n  private _nextFrame(): number {\r\n    const currentFrame = this._currentFrame;\r\n    if (this._done) {\r\n      return currentFrame;\r\n    }\r\n    let next = -1;\r\n\r\n    switch (this.strategy) {\r\n      case AnimationStrategy.Loop: {\r\n        next = (currentFrame + 1) % this.frames.length;\r\n        if (next === 0) {\r\n          this.events.emit('loop', this as any);\r\n        }\r\n        break;\r\n      }\r\n      case AnimationStrategy.End: {\r\n        next = currentFrame + 1;\r\n        if (next >= this.frames.length) {\r\n          this._done = true;\r\n          this._currentFrame = this.frames.length;\r\n          this.events.emit('end', this as any);\r\n        }\r\n        break;\r\n      }\r\n      case AnimationStrategy.Freeze: {\r\n        next = clamp(currentFrame + 1, 0, this.frames.length - 1);\r\n        if (next >= this.frames.length - 1) {\r\n          this._done = true;\r\n          this.events.emit('end', this as any);\r\n        }\r\n        break;\r\n      }\r\n      case AnimationStrategy.PingPong: {\r\n        if (currentFrame + this._direction >= this.frames.length) {\r\n          this._direction = -1;\r\n          this.events.emit('loop', this as any);\r\n        }\r\n\r\n        if (currentFrame + this._direction < 0) {\r\n          this._direction = 1;\r\n          this.events.emit('loop', this as any);\r\n        }\r\n\r\n        next = currentFrame + (this._direction % this.frames.length);\r\n        break;\r\n      }\r\n    }\r\n    return next;\r\n  }\r\n\r\n  /**\r\n   * Called internally by Excalibur to update the state of the animation potential update the current frame\r\n   * @param elapsedMilliseconds Milliseconds elapsed\r\n   * @param idempotencyToken Prevents double ticking in a frame by passing a unique token to the frame\r\n   */\r\n  public tick(elapsedMilliseconds: number, idempotencyToken: number = 0): void {\r\n    if (this._idempotencyToken === idempotencyToken) {\r\n      return;\r\n    }\r\n    this._idempotencyToken = idempotencyToken;\r\n    if (!this._playing) {\r\n      return;\r\n    }\r\n\r\n    // if it's the first frame emit frame event\r\n    if (this._firstTick) {\r\n      this._firstTick = false;\r\n      this.events.emit('frame', this.currentFrame as any);\r\n    }\r\n\r\n    this._timeLeftInFrame -= elapsedMilliseconds * this.timeScale;\r\n    if (this._timeLeftInFrame <= 0) {\r\n      this.goToFrame(this._nextFrame());\r\n    }\r\n  }\r\n\r\n  protected _drawImage(ctx: ExcaliburGraphicsContext, x: number, y: number) {\r\n    if (this.currentFrame) {\r\n      this.currentFrame.graphic.draw(ctx, x, y);\r\n    }\r\n  }\r\n}\r\n","import { Engine } from './Engine';\r\nimport { Actor } from './Actor';\r\nimport { Color } from './Color';\r\nimport { Vector, vec } from './Math/vector';\r\nimport * as Util from './Util/Util';\r\nimport { Configurable } from './Configurable';\r\nimport { Random } from './Math/Random';\r\nimport { CollisionType } from './Collision/CollisionType';\r\nimport { TransformComponent } from './EntityComponentSystem/Components/TransformComponent';\r\nimport { GraphicsComponent } from './Graphics/GraphicsComponent';\r\nimport { Entity } from './EntityComponentSystem/Entity';\r\nimport { Sprite } from './Graphics/Sprite';\r\nimport { BoundingBox } from './Collision/BoundingBox';\r\nimport { clamp, randomInRange } from './Math/util';\r\n\r\n/**\r\n * An enum that represents the types of emitter nozzles\r\n */\r\nexport enum EmitterType {\r\n  /**\r\n   * Constant for the circular emitter type\r\n   */\r\n  Circle,\r\n  /**\r\n   * Constant for the rectangular emitter type\r\n   */\r\n  Rectangle\r\n}\r\n\r\n/**\r\n * @hidden\r\n */\r\nexport class ParticleImpl extends Entity {\r\n  public position: Vector = new Vector(0, 0);\r\n  public velocity: Vector = new Vector(0, 0);\r\n  public acceleration: Vector = new Vector(0, 0);\r\n  public particleRotationalVelocity: number = 0;\r\n  public currentRotation: number = 0;\r\n\r\n  public focus: Vector = null;\r\n  public focusAccel: number = 0;\r\n  public opacity: number = 1;\r\n  public beginColor: Color = Color.White;\r\n  public endColor: Color = Color.White;\r\n\r\n  // Life is counted in ms\r\n  public life: number = 300;\r\n  public fadeFlag: boolean = false;\r\n\r\n  // Color transitions\r\n  private _rRate: number = 1;\r\n  private _gRate: number = 1;\r\n  private _bRate: number = 1;\r\n  private _aRate: number = 0;\r\n  private _currentColor: Color = Color.White;\r\n\r\n  public emitter: ParticleEmitter = null;\r\n  public particleSize: number = 5;\r\n  public particleSprite: Sprite = null;\r\n\r\n  public startSize: number;\r\n  public endSize: number;\r\n  public sizeRate: number = 0;\r\n  public elapsedMultiplier: number = 0;\r\n\r\n  public visible = true;\r\n  public isOffscreen = false;\r\n\r\n  public transform: TransformComponent;\r\n  public graphics: GraphicsComponent;\r\n\r\n  constructor(\r\n    emitterOrConfig: ParticleEmitter | ParticleArgs,\r\n    life?: number,\r\n    opacity?: number,\r\n    beginColor?: Color,\r\n    endColor?: Color,\r\n    position?: Vector,\r\n    velocity?: Vector,\r\n    acceleration?: Vector,\r\n    startSize?: number,\r\n    endSize?: number\r\n  ) {\r\n    super();\r\n    let emitter = emitterOrConfig;\r\n    if (emitter && !(emitterOrConfig instanceof ParticleEmitter)) {\r\n      const config = emitterOrConfig;\r\n      emitter = config.emitter;\r\n      life = config.life;\r\n      opacity = config.opacity;\r\n      endColor = config.endColor;\r\n      beginColor = config.beginColor;\r\n      position = config.position;\r\n      velocity = config.velocity;\r\n      acceleration = config.acceleration;\r\n      startSize = config.startSize;\r\n      endSize = config.endSize;\r\n    }\r\n    this.emitter = <ParticleEmitter>emitter;\r\n    this.life = life || this.life;\r\n    this.opacity = opacity || this.opacity;\r\n    this.endColor = endColor || this.endColor.clone();\r\n    this.beginColor = beginColor || this.beginColor.clone();\r\n    this._currentColor = this.beginColor.clone();\r\n    this.position = (position || this.position).add(this.emitter.pos);\r\n    this.velocity = velocity || this.velocity;\r\n    this.acceleration = acceleration || this.acceleration;\r\n    this._rRate = (this.endColor.r - this.beginColor.r) / this.life;\r\n    this._gRate = (this.endColor.g - this.beginColor.g) / this.life;\r\n    this._bRate = (this.endColor.b - this.beginColor.b) / this.life;\r\n    this._aRate = this.opacity / this.life;\r\n\r\n    this.startSize = startSize || 0;\r\n    this.endSize = endSize || 0;\r\n\r\n    if (this.endSize > 0 && this.startSize > 0) {\r\n      this.sizeRate = (this.endSize - this.startSize) / this.life;\r\n      this.particleSize = this.startSize;\r\n    }\r\n\r\n    this.addComponent((this.transform = new TransformComponent()));\r\n    this.addComponent((this.graphics = new GraphicsComponent()));\r\n\r\n    this.transform.pos = this.position;\r\n    this.transform.rotation = this.currentRotation;\r\n    this.transform.scale = vec(1, 1); // TODO wut\r\n    if (this.particleSprite) {\r\n      this.graphics.opacity = this.opacity;\r\n      this.graphics.use(this.particleSprite);\r\n    } else {\r\n      this.graphics.localBounds = BoundingBox.fromDimension(this.particleSize, this.particleSize, Vector.Half);\r\n      this.graphics.onPostDraw = (ctx) => {\r\n        ctx.save();\r\n        this.graphics.opacity = this.opacity;\r\n        const tmpColor = this._currentColor.clone();\r\n        tmpColor.a = 1;\r\n        ctx.debug.drawPoint(vec(0, 0), { color: tmpColor, size: this.particleSize });\r\n        ctx.restore();\r\n      };\r\n    }\r\n  }\r\n\r\n  public kill() {\r\n    this.emitter.removeParticle(this);\r\n  }\r\n\r\n  public update(_engine: Engine, delta: number) {\r\n    this.life = this.life - delta;\r\n    this.elapsedMultiplier = this.elapsedMultiplier + delta;\r\n\r\n    if (this.life < 0) {\r\n      this.kill();\r\n    }\r\n\r\n    if (this.fadeFlag) {\r\n      this.opacity = clamp(this._aRate * this.life, 0.0001, 1);\r\n    }\r\n\r\n    if (this.startSize > 0 && this.endSize > 0) {\r\n      this.particleSize = clamp(\r\n        this.sizeRate * delta + this.particleSize,\r\n        Math.min(this.startSize, this.endSize),\r\n        Math.max(this.startSize, this.endSize)\r\n      );\r\n    }\r\n\r\n    this._currentColor.r = clamp(this._currentColor.r + this._rRate * delta, 0, 255);\r\n    this._currentColor.g = clamp(this._currentColor.g + this._gRate * delta, 0, 255);\r\n    this._currentColor.b = clamp(this._currentColor.b + this._bRate * delta, 0, 255);\r\n    this._currentColor.a = clamp(this.opacity, 0.0001, 1);\r\n\r\n    if (this.focus) {\r\n      const accel = this.focus\r\n        .sub(this.position)\r\n        .normalize()\r\n        .scale(this.focusAccel)\r\n        .scale(delta / 1000);\r\n      this.velocity = this.velocity.add(accel);\r\n    } else {\r\n      this.velocity = this.velocity.add(this.acceleration.scale(delta / 1000));\r\n    }\r\n    this.position = this.position.add(this.velocity.scale(delta / 1000));\r\n\r\n    if (this.particleRotationalVelocity) {\r\n      this.currentRotation = (this.currentRotation + (this.particleRotationalVelocity * delta) / 1000) % (2 * Math.PI);\r\n    }\r\n\r\n    this.transform.pos = this.position;\r\n    this.transform.rotation = this.currentRotation;\r\n    this.transform.scale = vec(1, 1); // todo wut\r\n    this.graphics.opacity = this.opacity;\r\n  }\r\n}\r\n\r\nexport interface ParticleArgs extends Partial<ParticleImpl> {\r\n  emitter: ParticleEmitter;\r\n  position?: Vector;\r\n  velocity?: Vector;\r\n  acceleration?: Vector;\r\n  particleRotationalVelocity?: number;\r\n  currentRotation?: number;\r\n  particleSize?: number;\r\n  particleSprite?: Sprite;\r\n}\r\n\r\n/**\r\n * Particle is used in a [[ParticleEmitter]]\r\n */\r\nexport class Particle extends Configurable(ParticleImpl) {\r\n  constructor(config: ParticleArgs);\r\n  constructor(\r\n    emitter: ParticleEmitter,\r\n    life?: number,\r\n    opacity?: number,\r\n    beginColor?: Color,\r\n    endColor?: Color,\r\n    position?: Vector,\r\n    velocity?: Vector,\r\n    acceleration?: Vector,\r\n    startSize?: number,\r\n    endSize?: number\r\n  );\r\n  constructor(\r\n    emitterOrConfig: ParticleEmitter | ParticleArgs,\r\n    life?: number,\r\n    opacity?: number,\r\n    beginColor?: Color,\r\n    endColor?: Color,\r\n    position?: Vector,\r\n    velocity?: Vector,\r\n    acceleration?: Vector,\r\n    startSize?: number,\r\n    endSize?: number\r\n  ) {\r\n    super(emitterOrConfig, life, opacity, beginColor, endColor, position, velocity, acceleration, startSize, endSize);\r\n  }\r\n}\r\n\r\nexport interface ParticleEmitterArgs {\r\n  x?: number;\r\n  y?: number;\r\n  pos?: Vector;\r\n  width?: number;\r\n  height?: number;\r\n  isEmitting?: boolean;\r\n  minVel?: number;\r\n  maxVel?: number;\r\n  acceleration?: Vector;\r\n  minAngle?: number;\r\n  maxAngle?: number;\r\n  emitRate?: number;\r\n  particleLife?: number;\r\n  opacity?: number;\r\n  fadeFlag?: boolean;\r\n  focus?: Vector;\r\n  focusAccel?: number;\r\n  startSize?: number;\r\n  endSize?: number;\r\n  minSize?: number;\r\n  maxSize?: number;\r\n  beginColor?: Color;\r\n  endColor?: Color;\r\n  particleSprite?: Sprite;\r\n  emitterType?: EmitterType;\r\n  radius?: number;\r\n  particleRotationalVelocity?: number;\r\n  randomRotation?: boolean;\r\n  random?: Random;\r\n}\r\n\r\n/**\r\n * Using a particle emitter is a great way to create interesting effects\r\n * in your game, like smoke, fire, water, explosions, etc. `ParticleEmitter`\r\n * extend [[Actor]] allowing you to use all of the features that come with.\r\n */\r\nexport class ParticleEmitter extends Actor {\r\n  private _particlesToEmit: number = 0;\r\n\r\n  public numParticles: number = 0;\r\n\r\n  /**\r\n   * Random number generator\r\n   */\r\n  public random: Random;\r\n\r\n  /**\r\n   * Gets or sets the isEmitting flag\r\n   */\r\n  public isEmitting: boolean = true;\r\n  /**\r\n   * Gets or sets the backing particle collection\r\n   */\r\n  public particles: Particle[] = [];\r\n\r\n  /**\r\n   * Gets or sets the backing deadParticle collection\r\n   */\r\n  public deadParticles: Particle[] = [];\r\n\r\n  /**\r\n   * Gets or sets the minimum particle velocity\r\n   */\r\n  public minVel: number = 0;\r\n  /**\r\n   * Gets or sets the maximum particle velocity\r\n   */\r\n  public maxVel: number = 0;\r\n\r\n  /**\r\n   * Gets or sets the acceleration vector for all particles\r\n   */\r\n  public acceleration: Vector = new Vector(0, 0);\r\n\r\n  /**\r\n   * Gets or sets the minimum angle in radians\r\n   */\r\n  public minAngle: number = 0;\r\n  /**\r\n   * Gets or sets the maximum angle in radians\r\n   */\r\n  public maxAngle: number = 0;\r\n\r\n  /**\r\n   * Gets or sets the emission rate for particles (particles/sec)\r\n   */\r\n  public emitRate: number = 1; //particles/sec\r\n  /**\r\n   * Gets or sets the life of each particle in milliseconds\r\n   */\r\n  public particleLife: number = 2000;\r\n  /**\r\n   * Gets the opacity of each particle from 0 to 1.0\r\n   */\r\n  public get opacity(): number {\r\n    return super.graphics.opacity;\r\n  }\r\n  /**\r\n   * Gets the opacity of each particle from 0 to 1.0\r\n   */\r\n  public set opacity(opacity: number) {\r\n    super.graphics.opacity = opacity;\r\n  }\r\n  /**\r\n   * Gets or sets the fade flag which causes particles to gradually fade out over the course of their life.\r\n   */\r\n  public fadeFlag: boolean = false;\r\n\r\n  /**\r\n   * Gets or sets the optional focus where all particles should accelerate towards\r\n   */\r\n  public focus: Vector = null;\r\n  /**\r\n   * Gets or sets the acceleration for focusing particles if a focus has been specified\r\n   */\r\n  public focusAccel: number = null;\r\n  /**\r\n   * Gets or sets the optional starting size for the particles\r\n   */\r\n  public startSize: number = null;\r\n  /**\r\n   * Gets or sets the optional ending size for the particles\r\n   */\r\n  public endSize: number = null;\r\n\r\n  /**\r\n   * Gets or sets the minimum size of all particles\r\n   */\r\n  public minSize: number = 5;\r\n  /**\r\n   * Gets or sets the maximum size of all particles\r\n   */\r\n  public maxSize: number = 5;\r\n\r\n  /**\r\n   * Gets or sets the beginning color of all particles\r\n   */\r\n  public beginColor: Color = Color.White;\r\n  /**\r\n   * Gets or sets the ending color of all particles\r\n   */\r\n  public endColor: Color = Color.White;\r\n\r\n  private _sprite: Sprite = null;\r\n  /**\r\n   * Gets or sets the sprite that a particle should use\r\n   */\r\n  public get particleSprite(): Sprite {\r\n    return this._sprite;\r\n  }\r\n\r\n  public set particleSprite(val: Sprite) {\r\n    if (val) {\r\n      this._sprite = val;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets or sets the emitter type for the particle emitter\r\n   */\r\n  public emitterType: EmitterType = EmitterType.Rectangle;\r\n\r\n  /**\r\n   * Gets or sets the emitter radius, only takes effect when the [[emitterType]] is [[EmitterType.Circle]]\r\n   */\r\n  public radius: number = 0;\r\n\r\n  /**\r\n   * Gets or sets the particle rotational speed velocity\r\n   */\r\n  public particleRotationalVelocity: number = 0;\r\n\r\n  /**\r\n   * Indicates whether particles should start with a random rotation\r\n   */\r\n  public randomRotation: boolean = false;\r\n\r\n  /**\r\n   * @param config particle emitter options bag\r\n   */\r\n  constructor(config: ParticleEmitterArgs) {\r\n    super({ width: config.width ?? 0, height: config.height ?? 0 });\r\n\r\n    const {\r\n      x,\r\n      y,\r\n      pos,\r\n      isEmitting,\r\n      minVel,\r\n      maxVel,\r\n      acceleration,\r\n      minAngle,\r\n      maxAngle,\r\n      emitRate,\r\n      particleLife,\r\n      opacity,\r\n      fadeFlag,\r\n      focus,\r\n      focusAccel,\r\n      startSize,\r\n      endSize,\r\n      minSize,\r\n      maxSize,\r\n      beginColor,\r\n      endColor,\r\n      particleSprite,\r\n      emitterType,\r\n      radius,\r\n      particleRotationalVelocity,\r\n      randomRotation,\r\n      random\r\n    } = { ...config };\r\n\r\n    this.pos = pos ?? vec(x ?? 0, y ?? 0);\r\n    this.isEmitting = isEmitting ?? this.isEmitting;\r\n    this.minVel = minVel ?? this.minVel;\r\n    this.maxVel = maxVel ?? this.maxVel;\r\n    this.acceleration = acceleration ?? this.acceleration;\r\n    this.minAngle = minAngle ?? this.minAngle;\r\n    this.maxAngle = maxAngle ?? this.maxAngle;\r\n    this.emitRate = emitRate ?? this.emitRate;\r\n    this.particleLife = particleLife ?? this.particleLife;\r\n    this.opacity = opacity ?? this.opacity;\r\n    this.fadeFlag = fadeFlag ?? this.fadeFlag;\r\n    this.focus = focus ?? this.focus;\r\n    this.focusAccel = focusAccel ?? this.focusAccel;\r\n    this.startSize = startSize ?? this.startSize;\r\n    this.endSize = endSize ?? this.endSize;\r\n    this.minSize = minSize ?? this.minSize;\r\n    this.maxSize = maxSize ?? this.maxSize;\r\n    this.beginColor = beginColor ?? this.beginColor;\r\n    this.endColor = endColor ?? this.endColor;\r\n    this.particleSprite = particleSprite ?? this.particleSprite;\r\n    this.emitterType = emitterType ?? this.emitterType;\r\n    this.radius = radius ?? this.radius;\r\n    this.particleRotationalVelocity = particleRotationalVelocity ?? this.particleRotationalVelocity;\r\n    this.randomRotation = randomRotation ?? this.randomRotation;\r\n\r\n    this.body.collisionType = CollisionType.PreventCollision;\r\n\r\n    this.random = random ?? new Random();\r\n  }\r\n\r\n  public removeParticle(particle: Particle) {\r\n    this.deadParticles.push(particle);\r\n  }\r\n\r\n  /**\r\n   * Causes the emitter to emit particles\r\n   * @param particleCount  Number of particles to emit right now\r\n   */\r\n  public emitParticles(particleCount: number) {\r\n    for (let i = 0; i < particleCount; i++) {\r\n      const p = this._createParticle();\r\n      this.particles.push(p);\r\n      if (this?.scene?.world) {\r\n        this.scene.world.add(p);\r\n      }\r\n    }\r\n  }\r\n\r\n  public clearParticles() {\r\n    this.particles.length = 0;\r\n  }\r\n\r\n  // Creates a new particle given the constraints of the emitter\r\n  private _createParticle(): Particle {\r\n    // todo implement emitter constraints;\r\n    let ranX = 0;\r\n    let ranY = 0;\r\n\r\n    const angle = randomInRange(this.minAngle, this.maxAngle, this.random);\r\n    const vel = randomInRange(this.minVel, this.maxVel, this.random);\r\n    const size = this.startSize || randomInRange(this.minSize, this.maxSize, this.random);\r\n    const dx = vel * Math.cos(angle);\r\n    const dy = vel * Math.sin(angle);\r\n\r\n    if (this.emitterType === EmitterType.Rectangle) {\r\n      ranX = randomInRange(0, this.width, this.random);\r\n      ranY = randomInRange(0, this.height, this.random);\r\n    } else if (this.emitterType === EmitterType.Circle) {\r\n      const radius = randomInRange(0, this.radius, this.random);\r\n      ranX = radius * Math.cos(angle);\r\n      ranY = radius * Math.sin(angle);\r\n    }\r\n\r\n    const p = new Particle(\r\n      this,\r\n      this.particleLife,\r\n      this.opacity,\r\n      this.beginColor,\r\n      this.endColor,\r\n      new Vector(ranX, ranY),\r\n      new Vector(dx, dy),\r\n      this.acceleration,\r\n      this.startSize,\r\n      this.endSize\r\n    );\r\n    p.fadeFlag = this.fadeFlag;\r\n    p.particleSize = size;\r\n    if (this.particleSprite) {\r\n      p.particleSprite = this.particleSprite;\r\n      p.graphics.opacity = this.opacity;\r\n      p.graphics.use(this._sprite);\r\n    }\r\n    p.particleRotationalVelocity = this.particleRotationalVelocity;\r\n    if (this.randomRotation) {\r\n      p.currentRotation = randomInRange(0, Math.PI * 2, this.random);\r\n    }\r\n    if (this.focus) {\r\n      p.focus = this.focus.add(new Vector(this.pos.x, this.pos.y));\r\n      p.focusAccel = this.focusAccel;\r\n    }\r\n    return p;\r\n  }\r\n\r\n  public update(engine: Engine, delta: number) {\r\n    super.update(engine, delta);\r\n\r\n    if (this.isEmitting) {\r\n      this._particlesToEmit += this.emitRate * (delta / 1000);\r\n      if (this._particlesToEmit > 1.0) {\r\n        this.emitParticles(Math.floor(this._particlesToEmit));\r\n        this._particlesToEmit = this._particlesToEmit - Math.floor(this._particlesToEmit);\r\n      }\r\n    }\r\n\r\n    // deferred removal\r\n    for (let i = 0; i < this.deadParticles.length; i++) {\r\n      Util.removeItemFromArray(this.deadParticles[i], this.particles);\r\n      if (this?.scene?.world) {\r\n        this.scene.world.remove(this.deadParticles[i], false);\r\n      }\r\n    }\r\n    this.deadParticles.length = 0;\r\n  }\r\n}\r\n","\r\n\r\nexport enum ColorBlindnessMode {\r\n  Protanope = 'Protanope',\r\n  Deuteranope = 'Deuteranope',\r\n  Tritanope = 'Tritanope'\r\n}\r\n","import { Vector } from '../Math/vector';\r\nimport { Graphic, GraphicOptions } from './Graphic';\r\nimport { Animation, HasTick } from './Animation';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { BoundingBox } from '../Collision/Index';\r\n\r\nexport interface GraphicsGroupingOptions {\r\n  members: GraphicsGrouping[];\r\n}\r\n\r\nexport interface GraphicsGrouping {\r\n  pos: Vector;\r\n  graphic: Graphic;\r\n}\r\n\r\nexport class GraphicsGroup extends Graphic implements HasTick {\r\n  public members: GraphicsGrouping[] = [];\r\n\r\n  constructor(options: GraphicsGroupingOptions & GraphicOptions) {\r\n    super(options);\r\n    this.members = options.members;\r\n    this._updateDimensions();\r\n  }\r\n\r\n  public clone(): GraphicsGroup {\r\n    return new GraphicsGroup({\r\n      members: [...this.members],\r\n      ...this.cloneGraphicOptions()\r\n    });\r\n  }\r\n\r\n  private _updateDimensions(): BoundingBox {\r\n    let bb = new BoundingBox();\r\n    for (const { graphic, pos } of this.members) {\r\n      bb = graphic.localBounds.translate(pos).combine(bb);\r\n    }\r\n\r\n    this.width = bb.width;\r\n    this.height = bb.height;\r\n\r\n    return bb;\r\n  }\r\n\r\n  public get localBounds(): BoundingBox {\r\n    let bb = new BoundingBox();\r\n    for (const { graphic, pos } of this.members) {\r\n      bb = graphic.localBounds.translate(pos).combine(bb);\r\n    }\r\n    return bb;\r\n  }\r\n\r\n  private _isAnimationOrGroup(graphic: Graphic): graphic is Animation | GraphicsGroup {\r\n    return graphic instanceof Animation || graphic instanceof GraphicsGroup;\r\n  }\r\n\r\n  public tick(elapsedMilliseconds: number, idempotencyToken?: number) {\r\n    for (const member of this.members) {\r\n      const maybeAnimation = member.graphic;\r\n      if (this._isAnimationOrGroup(maybeAnimation)) {\r\n        maybeAnimation.tick(elapsedMilliseconds, idempotencyToken);\r\n      }\r\n    }\r\n  }\r\n\r\n  public reset() {\r\n    for (const member of this.members) {\r\n      const maybeAnimation = member.graphic;\r\n      if (this._isAnimationOrGroup(maybeAnimation)) {\r\n        maybeAnimation.reset();\r\n      }\r\n    }\r\n  }\r\n\r\n  protected _preDraw(ex: ExcaliburGraphicsContext, x: number, y: number) {\r\n    this._updateDimensions();\r\n    super._preDraw(ex, x, y);\r\n  }\r\n\r\n  protected _drawImage(ex: ExcaliburGraphicsContext, x: number, y: number) {\r\n    for (const member of this.members) {\r\n      ex.save();\r\n      ex.translate(x, y);\r\n      member.graphic.draw(ex, member.pos.x, member.pos.y);\r\n      if (this.showDebug) {\r\n        /* istanbul ignore next */\r\n        ex.debug.drawRect(0, 0, this.width, this.height);\r\n      }\r\n      ex.restore();\r\n    }\r\n  }\r\n}\r\n","export type Constructor<T> = {\r\n  new (...args: any[]): T;\r\n};\r\n/**\r\n * Configurable helper extends base type and makes all properties available as option bag arguments\r\n * @internal\r\n * @param base\r\n */\r\nexport function Configurable<T extends Constructor<{}>>(base: T): T {\r\n  return class extends base {\r\n    public assign(props: Partial<T>) {\r\n      //set the value of every property that was passed in,\r\n      //if the constructor previously set this value, it will be overridden here\r\n      for (const k in props) {\r\n        // eslint-disable-next-line\r\n        if (typeof (<any>this)[k] !== 'function') {\r\n          // eslint-disable-next-line\r\n          (<any>this)[k] = (<any>props)[k];\r\n        }\r\n      }\r\n    }\r\n\r\n    constructor(...args: any[]) {\r\n      super(...args);\r\n      //get the number of arguments that aren't undefined. TS passes a value to all parameters\r\n      //of whatever ctor is the implementation, so args.length doesn't work here.\r\n      const size = args.filter(function(value) {\r\n        return value !== undefined;\r\n      }).length;\r\n      if (size === 1 && args[0] && typeof args[0] === 'object' && !(args[0] instanceof Array)) {\r\n        this.assign(args[0]);\r\n      }\r\n    }\r\n  };\r\n}\r\n","import { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { Scene } from '../Scene';\r\nimport { GraphicsComponent } from './GraphicsComponent';\r\nimport { vec, Vector } from '../Math/vector';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity } from '../EntityComponentSystem/Entity';\r\nimport { Camera } from '../Camera';\r\nimport { AddedEntity, isAddedSystemEntity, RemovedEntity, System, SystemType } from '../EntityComponentSystem';\r\nimport { Engine } from '../Engine';\r\nimport { GraphicsGroup } from '.';\r\nimport { Particle } from '../Particles';\r\nimport { ParallaxComponent } from './ParallaxComponent';\r\nimport { CoordPlane } from '../Math/coord-plane';\r\nimport { BodyComponent } from '../Collision/BodyComponent';\r\n\r\nexport class GraphicsSystem extends System<TransformComponent | GraphicsComponent> {\r\n  public readonly types = ['ex.transform', 'ex.graphics'] as const;\r\n  public readonly systemType = SystemType.Draw;\r\n  public priority = 0;\r\n  private _token = 0;\r\n  private _graphicsContext: ExcaliburGraphicsContext;\r\n  private _camera: Camera;\r\n  private _engine: Engine;\r\n\r\n  private _sortedTransforms: TransformComponent[] = [];\r\n  public get sortedTransforms() {\r\n    return this._sortedTransforms;\r\n  }\r\n\r\n  public initialize(scene: Scene): void {\r\n    this._camera = scene.camera;\r\n    this._engine = scene.engine;\r\n  }\r\n\r\n  private _zHasChanged = false;\r\n  private _zIndexUpdate = () => {\r\n    this._zHasChanged = true;\r\n  };\r\n\r\n  public preupdate(): void {\r\n    // Graphics context could be switched to fallback in a new frame\r\n    this._graphicsContext = this._engine.graphicsContext;\r\n    if (this._zHasChanged) {\r\n      this._sortedTransforms.sort((a, b) => {\r\n        return a.z - b.z;\r\n      });\r\n      this._zHasChanged = false;\r\n    }\r\n  }\r\n\r\n  public notify(entityAddedOrRemoved: AddedEntity | RemovedEntity): void {\r\n    if (isAddedSystemEntity(entityAddedOrRemoved)) {\r\n      const tx = entityAddedOrRemoved.data.get(TransformComponent);\r\n      this._sortedTransforms.push(tx);\r\n      tx.zIndexChanged$.subscribe(this._zIndexUpdate);\r\n      this._zHasChanged = true;\r\n    } else {\r\n      const tx = entityAddedOrRemoved.data.get(TransformComponent);\r\n      tx.zIndexChanged$.unsubscribe(this._zIndexUpdate);\r\n      const index = this._sortedTransforms.indexOf(tx);\r\n      if (index > -1) {\r\n        this._sortedTransforms.splice(index, 1);\r\n      }\r\n    }\r\n  }\r\n\r\n  public update(_entities: Entity[], delta: number): void {\r\n    this._token++;\r\n    let graphics: GraphicsComponent;\r\n\r\n    // This is a performance enhancement, most things are in world space\r\n    // so if we can only do this once saves a ton of transform updates\r\n    this._graphicsContext.save();\r\n    if (this._camera) {\r\n      this._camera.draw(this._graphicsContext);\r\n    }\r\n    for (const transform of this._sortedTransforms) {\r\n      const entity = transform.owner as Entity;\r\n\r\n      // If the entity is offscreen skip\r\n      if (entity.hasTag('ex.offscreen')) {\r\n        continue;\r\n      }\r\n\r\n      graphics = entity.get(GraphicsComponent);\r\n      // Exit if graphics set to not visible\r\n      if (!graphics.visible) {\r\n        continue;\r\n      }\r\n\r\n      // This optionally sets our camera based on the entity coord plan (world vs. screen)\r\n      if (transform.coordPlane === CoordPlane.Screen) {\r\n        this._graphicsContext.restore();\r\n      }\r\n\r\n      this._graphicsContext.save();\r\n\r\n      // Tick any graphics state (but only once) for animations and graphics groups\r\n      graphics.update(delta, this._token);\r\n\r\n      // Apply parallax\r\n      const parallax = entity.get(ParallaxComponent);\r\n      if (parallax) {\r\n        // We use the Tiled formula\r\n        // https://doc.mapeditor.org/en/latest/manual/layers/#parallax-scrolling-factor\r\n        // cameraPos * (1 - parallaxFactor)\r\n        const oneMinusFactor = Vector.One.sub(parallax.parallaxFactor);\r\n        const parallaxOffset = this._camera.pos.scale(oneMinusFactor);\r\n        this._graphicsContext.translate(parallaxOffset.x, parallaxOffset.y);\r\n      }\r\n\r\n      // Position the entity + estimate lag\r\n      this._applyTransform(entity);\r\n\r\n      // Optionally run the onPreDraw graphics lifecycle draw\r\n      if (graphics.onPreDraw) {\r\n        graphics.onPreDraw(this._graphicsContext, delta);\r\n      }\r\n\r\n      // TODO remove this hack on the particle redo\r\n      const particleOpacity = (entity instanceof Particle) ? entity.opacity : 1;\r\n      this._graphicsContext.opacity = graphics.opacity * particleOpacity;\r\n\r\n      // Draw the graphics component\r\n      this._drawGraphicsComponent(graphics);\r\n\r\n      // Optionally run the onPostDraw graphics lifecycle draw\r\n      if (graphics.onPostDraw) {\r\n        graphics.onPostDraw(this._graphicsContext, delta);\r\n      }\r\n\r\n      this._graphicsContext.restore();\r\n\r\n      // Reset the transform back to the original world space\r\n      if (transform.coordPlane === CoordPlane.Screen) {\r\n        this._graphicsContext.save();\r\n        if (this._camera) {\r\n          this._camera.draw(this._graphicsContext);\r\n        }\r\n      }\r\n    }\r\n    this._graphicsContext.restore();\r\n  }\r\n\r\n  private _drawGraphicsComponent(graphicsComponent: GraphicsComponent) {\r\n    if (graphicsComponent.visible) {\r\n      // this should be moved to the graphics system\r\n      for (const layer of graphicsComponent.layers.get()) {\r\n        for (const { graphic, options } of layer.graphics) {\r\n          let anchor = graphicsComponent.anchor;\r\n          let offset = graphicsComponent.offset;\r\n          if (options?.anchor) {\r\n            anchor = options.anchor;\r\n          }\r\n          if (options?.offset) {\r\n            offset = options.offset;\r\n          }\r\n          // See https://github.com/excaliburjs/Excalibur/pull/619 for discussion on this formula\r\n          const offsetX = -graphic.width * anchor.x + offset.x;\r\n          const offsetY = -graphic.height * anchor.y + offset.y;\r\n\r\n          graphic?.draw(this._graphicsContext, offsetX + layer.offset.x, offsetY + layer.offset.y);\r\n\r\n          if (this._engine?.isDebug && this._engine.debug.graphics.showBounds) {\r\n            const offset = vec(offsetX + layer.offset.x, offsetY + layer.offset.y);\r\n            if (graphic instanceof GraphicsGroup) {\r\n              for (const g of graphic.members) {\r\n                g.graphic?.localBounds.translate(offset.add(g.pos)).draw(this._graphicsContext, this._engine.debug.graphics.boundsColor);\r\n              }\r\n            } else {\r\n              /* istanbul ignore next */\r\n              graphic?.localBounds.translate(offset).draw(this._graphicsContext, this._engine.debug.graphics.boundsColor);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * This applies the current entity transform to the graphics context\r\n   * @param entity\r\n   */\r\n  private _applyTransform(entity: Entity): void {\r\n    const ancestors = entity.getAncestors();\r\n    for (const ancestor of ancestors) {\r\n      const transform = ancestor?.get(TransformComponent);\r\n      const optionalBody = ancestor?.get(BodyComponent);\r\n      let interpolatedPos = transform.pos;\r\n      let interpolatedScale = transform.scale;\r\n      let interpolatedRotation = transform.rotation;\r\n      if (optionalBody) {\r\n        if (this._engine.fixedUpdateFps &&\r\n            optionalBody.__oldTransformCaptured &&\r\n            optionalBody.enableFixedUpdateInterpolate) {\r\n\r\n          // Interpolate graphics if needed\r\n          const blend = this._engine.currentFrameLagMs / (1000 / this._engine.fixedUpdateFps);\r\n          interpolatedPos = transform.pos.scale(blend).add(\r\n            optionalBody.oldPos.scale(1.0 - blend)\r\n          );\r\n          interpolatedScale = transform.scale.scale(blend).add(\r\n            optionalBody.oldScale.scale(1.0 - blend)\r\n          );\r\n          // Rotational lerp https://stackoverflow.com/a/30129248\r\n          const cosine = (1.0 - blend) * Math.cos(optionalBody.oldRotation) + blend * Math.cos(transform.rotation);\r\n          const sine = (1.0 - blend) * Math.sin(optionalBody.oldRotation) + blend * Math.sin(transform.rotation);\r\n          interpolatedRotation = Math.atan2(sine, cosine);\r\n        }\r\n      }\r\n\r\n      if (transform) {\r\n        this._graphicsContext.z = transform.z;\r\n        this._graphicsContext.translate(interpolatedPos.x, interpolatedPos.y);\r\n        this._graphicsContext.scale(interpolatedScale.x, interpolatedScale.y);\r\n        this._graphicsContext.rotate(interpolatedRotation);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Engine } from '../Engine';\r\nimport { Scene } from '../Scene';\r\nimport { Camera } from '../Camera';\r\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\r\nimport { ColliderComponent } from '../Collision/ColliderComponent';\r\nimport { Entity, TransformComponent } from '../EntityComponentSystem';\r\nimport { System, SystemType } from '../EntityComponentSystem/System';\r\nimport { ExcaliburGraphicsContext } from '../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { vec, Vector } from '../Math/vector';\r\nimport { toDegrees } from '../Math/util';\r\nimport { BodyComponent, CollisionSystem, CompositeCollider, GraphicsComponent, Particle } from '..';\r\nimport { DebugGraphicsComponent } from '../Graphics/DebugGraphicsComponent';\r\nimport { CoordPlane } from '../Math/coord-plane';\r\n\r\nexport class DebugSystem extends System<TransformComponent> {\r\n  public readonly types = ['ex.transform'] as const;\r\n  public readonly systemType = SystemType.Draw;\r\n  public priority = 999; // lowest priority\r\n  private _graphicsContext: ExcaliburGraphicsContext;\r\n  private _collisionSystem: CollisionSystem;\r\n  private _camera: Camera;\r\n  private _engine: Engine;\r\n\r\n  public initialize(scene: Scene): void {\r\n    this._graphicsContext = scene.engine.graphicsContext;\r\n    this._camera = scene.camera;\r\n    this._engine = scene.engine;\r\n    this._collisionSystem = scene.world.systemManager.get(CollisionSystem);\r\n  }\r\n\r\n  update(entities: Entity[], _delta: number): void {\r\n    if (!this._engine.isDebug) {\r\n      return;\r\n    }\r\n\r\n    const filterSettings = this._engine.debug.filter;\r\n\r\n    let id: number;\r\n    let name: string;\r\n    const entitySettings = this._engine.debug.entity;\r\n\r\n    let tx: TransformComponent;\r\n    const txSettings = this._engine.debug.transform;\r\n\r\n    let motion: MotionComponent;\r\n    const motionSettings = this._engine.debug.motion;\r\n\r\n    let colliderComp: ColliderComponent;\r\n    const colliderSettings = this._engine.debug.collider;\r\n\r\n    const physicsSettings = this._engine.debug.physics;\r\n\r\n    let graphics: GraphicsComponent;\r\n    const graphicsSettings = this._engine.debug.graphics;\r\n\r\n    let debugDraw: DebugGraphicsComponent;\r\n\r\n    let body: BodyComponent;\r\n    const bodySettings = this._engine.debug.body;\r\n\r\n    const cameraSettings = this._engine.debug.camera;\r\n    for (const entity of entities) {\r\n      if (entity.hasTag('offscreen')) {\r\n        // skip offscreen entities\r\n        continue;\r\n      }\r\n      if (entity instanceof Particle) {\r\n        // Particles crush the renderer :(\r\n        continue;\r\n      }\r\n      if (filterSettings.useFilter) {\r\n        const allIds = filterSettings.ids.length === 0;\r\n        const idMatch = allIds || filterSettings.ids.includes(entity.id);\r\n        if (!idMatch) {\r\n          continue;\r\n        }\r\n        const allNames = filterSettings.nameQuery === '';\r\n        const nameMatch = allNames || entity.name.includes(filterSettings.nameQuery);\r\n        if (!nameMatch) {\r\n          continue;\r\n        }\r\n      }\r\n\r\n      let cursor = Vector.Zero;\r\n      const lineHeight = vec(0, 16);\r\n      id = entity.id;\r\n      name = entity.name;\r\n      tx = entity.get(TransformComponent);\r\n\r\n      // This optionally sets our camera based on the entity coord plan (world vs. screen)\r\n      this._pushCameraTransform(tx);\r\n\r\n      this._graphicsContext.save();\r\n\r\n      this._applyTransform(entity);\r\n      if (tx) {\r\n        if (txSettings.showAll || txSettings.showPosition) {\r\n          this._graphicsContext.debug.drawPoint(Vector.Zero, { size: 4, color: txSettings.positionColor });\r\n        }\r\n        if (txSettings.showAll || txSettings.showPositionLabel) {\r\n          this._graphicsContext.debug.drawText(`pos${tx.pos.toString(2)}`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n        if (txSettings.showAll || txSettings.showZIndex) {\r\n          this._graphicsContext.debug.drawText(`z(${tx.z.toFixed(1)})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (entitySettings.showAll || entitySettings.showId) {\r\n          this._graphicsContext.debug.drawText(`id(${id}) ${entity.parent ? 'child of id(' + entity.parent?.id + ')' : ''}`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (entitySettings.showAll || entitySettings.showName) {\r\n          this._graphicsContext.debug.drawText(`name(${name})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (txSettings.showAll || txSettings.showRotation) {\r\n          this._graphicsContext.drawLine(\r\n            Vector.Zero,\r\n            Vector.fromAngle(tx.rotation).scale(50).add(Vector.Zero),\r\n            txSettings.rotationColor,\r\n            2\r\n          );\r\n          this._graphicsContext.debug.drawText(`rot deg(${toDegrees(tx.rotation).toFixed(2)})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (txSettings.showAll || txSettings.showScale) {\r\n          this._graphicsContext.drawLine(Vector.Zero, tx.scale.add(Vector.Zero), txSettings.scaleColor, 2);\r\n        }\r\n      }\r\n\r\n      graphics = entity.get(GraphicsComponent);\r\n      if (graphics) {\r\n        if (graphicsSettings.showAll || graphicsSettings.showBounds) {\r\n          const bounds = graphics.localBounds;\r\n          bounds.draw(this._graphicsContext, graphicsSettings.boundsColor);\r\n        }\r\n      }\r\n\r\n      debugDraw = entity.get(DebugGraphicsComponent);\r\n      if (debugDraw) {\r\n        if (!debugDraw.useTransform) {\r\n          this._graphicsContext.restore();\r\n        }\r\n        debugDraw.draw(this._graphicsContext);\r\n        if (!debugDraw.useTransform) {\r\n          this._graphicsContext.save();\r\n          this._applyTransform(entity);\r\n        }\r\n      }\r\n\r\n      body = entity.get(BodyComponent);\r\n      if (body) {\r\n        if (bodySettings.showAll || bodySettings.showCollisionGroup) {\r\n          this._graphicsContext.debug.drawText(`collision group(${body.group.name})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (bodySettings.showAll || bodySettings.showCollisionType) {\r\n          this._graphicsContext.debug.drawText(`collision type(${body.collisionType})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (bodySettings.showAll || bodySettings.showMass) {\r\n          this._graphicsContext.debug.drawText(`mass(${body.mass})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (bodySettings.showAll || bodySettings.showMotion) {\r\n          this._graphicsContext.debug.drawText(`motion(${body.sleepMotion})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (bodySettings.showAll || bodySettings.showSleeping) {\r\n          this._graphicsContext.debug.drawText(`sleeping(${body.canSleep ? body.sleeping: 'cant sleep'})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n      }\r\n\r\n      this._graphicsContext.restore();\r\n\r\n      motion = entity.get(MotionComponent);\r\n      if (motion) {\r\n        if (motionSettings.showAll || motionSettings.showVelocity) {\r\n          this._graphicsContext.debug.drawText(`vel${motion.vel.toString(2)}`, cursor.add(tx.globalPos));\r\n          this._graphicsContext.drawLine(tx.globalPos, tx.globalPos.add(motion.vel), motionSettings.velocityColor, 2);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (motionSettings.showAll || motionSettings.showAcceleration) {\r\n          this._graphicsContext.drawLine(tx.globalPos, tx.globalPos.add(motion.acc), motionSettings.accelerationColor, 2);\r\n        }\r\n      }\r\n\r\n      // Colliders live in world space already so after the restore()\r\n      colliderComp = entity.get(ColliderComponent);\r\n      if (colliderComp) {\r\n        const collider = colliderComp.get();\r\n        if ((colliderSettings.showAll || colliderSettings.showGeometry) && collider) {\r\n          collider.debug(this._graphicsContext, colliderSettings.geometryColor);\r\n        }\r\n        if (colliderSettings.showAll || colliderSettings.showBounds) {\r\n          if (collider instanceof CompositeCollider) {\r\n            const colliders = collider.getColliders();\r\n            for (const collider of colliders) {\r\n              const bounds = collider.bounds;\r\n              const pos = vec(bounds.left, bounds.top);\r\n              this._graphicsContext.debug.drawRect(pos.x, pos.y, bounds.width, bounds.height, { color: colliderSettings.boundsColor });\r\n              if (colliderSettings.showAll || colliderSettings.showOwner) {\r\n                this._graphicsContext.debug.drawText(`owner id(${collider.owner.id})`, pos);\r\n              }\r\n            }\r\n            colliderComp.bounds.draw(this._graphicsContext, colliderSettings.boundsColor);\r\n          } else if (collider) {\r\n            const bounds = colliderComp.bounds;\r\n            const pos = vec(bounds.left, bounds.top);\r\n            this._graphicsContext.debug.drawRect(pos.x, pos.y, bounds.width, bounds.height, { color: colliderSettings.boundsColor });\r\n            if (colliderSettings.showAll || colliderSettings.showOwner) {\r\n              this._graphicsContext.debug.drawText(`owner id(${colliderComp.owner.id})`, pos);\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      this._popCameraTransform(tx);\r\n    }\r\n\r\n    this._graphicsContext.save();\r\n    this._camera.draw(this._graphicsContext);\r\n    if (physicsSettings.showAll || physicsSettings.showBroadphaseSpacePartitionDebug) {\r\n      this._collisionSystem.debug(this._graphicsContext);\r\n    }\r\n    if (physicsSettings.showAll || physicsSettings.showCollisionContacts || physicsSettings.showCollisionNormals) {\r\n      for (const [_, contact] of this._engine.debug.stats.currFrame.physics.contacts) {\r\n        if (physicsSettings.showAll || physicsSettings.showCollisionContacts) {\r\n          for (const point of contact.points) {\r\n            this._graphicsContext.debug.drawPoint(point, { size: 5, color: physicsSettings.collisionContactColor });\r\n          }\r\n        }\r\n\r\n        if (physicsSettings.showAll || physicsSettings.showCollisionNormals) {\r\n          for (const point of contact.points) {\r\n            this._graphicsContext.debug.drawLine(point, contact.normal.scale(30).add(point), {\r\n              color: physicsSettings.collisionNormalColor\r\n            });\r\n          }\r\n        }\r\n      }\r\n    }\r\n    this._graphicsContext.restore();\r\n\r\n    if (cameraSettings) {\r\n      this._graphicsContext.save();\r\n      this._camera.draw(this._graphicsContext);\r\n      if (cameraSettings.showAll || cameraSettings.showFocus) {\r\n        this._graphicsContext.drawCircle(this._camera.pos, 4, cameraSettings.focusColor);\r\n      }\r\n      if (cameraSettings.showAll || cameraSettings.showZoom) {\r\n        this._graphicsContext.debug.drawText(`zoom(${this._camera.zoom})`, this._camera.pos);\r\n      }\r\n      this._graphicsContext.restore();\r\n    }\r\n\r\n    this._graphicsContext.flush();\r\n  }\r\n\r\n  /**\r\n   * This applies the current entity transform to the graphics context\r\n   * @param entity\r\n   */\r\n  private _applyTransform(entity: Entity): void {\r\n    const ancestors = entity.getAncestors();\r\n    for (const ancestor of ancestors) {\r\n      const transform = ancestor?.get(TransformComponent);\r\n      if (transform) {\r\n        this._graphicsContext.translate(transform.pos.x, transform.pos.y);\r\n        this._graphicsContext.scale(transform.scale.x, transform.scale.y);\r\n        this._graphicsContext.rotate(transform.rotation);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Applies the current camera transform if in world coordinates\r\n   * @param transform\r\n   */\r\n  private _pushCameraTransform(transform: TransformComponent) {\r\n    // Establish camera offset per entity\r\n    if (transform.coordPlane === CoordPlane.World) {\r\n      this._graphicsContext.save();\r\n      if (this._camera) {\r\n        this._camera.draw(this._graphicsContext);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Resets the current camera transform if in world coordinates\r\n   * @param transform\r\n   */\r\n  private _popCameraTransform(transform: TransformComponent) {\r\n    if (transform.coordPlane === CoordPlane.World) {\r\n      // Apply camera world offset\r\n      this._graphicsContext.restore();\r\n    }\r\n  }\r\n}\r\n","import { ColliderComponent } from '../Collision/ColliderComponent';\r\nimport { Engine } from '../Engine';\r\nimport {\r\n  System,\r\n  TransformComponent,\r\n  SystemType,\r\n  Entity,\r\n  AddedEntity,\r\n  RemovedEntity,\r\n  isAddedSystemEntity\r\n} from '../EntityComponentSystem';\r\nimport { GraphicsComponent } from '../Graphics/GraphicsComponent';\r\nimport { Scene } from '../Scene';\r\nimport { PointerComponent } from './PointerComponent';\r\nimport { PointerEventReceiver } from './PointerEventReceiver';\r\nimport { PointerEvent } from './PointerEvent';\r\nimport { CoordPlane } from '../Math/coord-plane';\r\n\r\n/**\r\n * The PointerSystem is responsible for dispatching pointer events to entities\r\n * that need them.\r\n *\r\n * The PointerSystem can be optionally configured by the [[PointerComponent]], by default Entities use\r\n * the [[Collider]]'s shape for pointer events.\r\n */\r\nexport class PointerSystem extends System<TransformComponent | PointerComponent> {\r\n  public readonly types = ['ex.transform', 'ex.pointer'] as const;\r\n  public readonly systemType = SystemType.Update;\r\n  public priority = -1;\r\n\r\n  private _engine: Engine;\r\n  private _receiver: PointerEventReceiver;\r\n\r\n  /**\r\n   * Optionally override component configuration for all entities\r\n   */\r\n  public overrideUseColliderShape = false;\r\n  /**\r\n   * Optionally override component configuration for all entities\r\n   */\r\n  public overrideUseGraphicsBounds = false;\r\n\r\n  public lastFrameEntityToPointers = new Map<number, number[]>();\r\n  public currentFrameEntityToPointers = new Map<number, number[]>();\r\n\r\n  public initialize(scene: Scene): void {\r\n    this._engine = scene.engine;\r\n  }\r\n\r\n  private _sortedTransforms: TransformComponent[] = [];\r\n  private _sortedEntities: Entity[] = [];\r\n\r\n  private _zHasChanged = false;\r\n  private _zIndexUpdate = () => {\r\n    this._zHasChanged = true;\r\n  };\r\n\r\n  public preupdate(): void {\r\n    // event receiver might change per frame\r\n    this._receiver = this._engine.input.pointers;\r\n    if (this._zHasChanged) {\r\n      this._sortedTransforms.sort((a, b) => {\r\n        return b.z - a.z;\r\n      });\r\n      this._sortedEntities = this._sortedTransforms.map(t => t.owner);\r\n      this._zHasChanged = false;\r\n    }\r\n  }\r\n\r\n  public notify(entityAddedOrRemoved: AddedEntity | RemovedEntity): void {\r\n    if (isAddedSystemEntity(entityAddedOrRemoved)) {\r\n      const tx = entityAddedOrRemoved.data.get(TransformComponent);\r\n      this._sortedTransforms.push(tx);\r\n      this._sortedEntities.push(tx.owner);\r\n      tx.zIndexChanged$.subscribe(this._zIndexUpdate);\r\n      this._zHasChanged = true;\r\n    } else {\r\n      const tx = entityAddedOrRemoved.data.get(TransformComponent);\r\n      tx.zIndexChanged$.unsubscribe(this._zIndexUpdate);\r\n      const index = this._sortedTransforms.indexOf(tx);\r\n      if (index > -1) {\r\n        this._sortedTransforms.splice(index, 1);\r\n        this._sortedEntities.splice(index, 1);\r\n      }\r\n    }\r\n  }\r\n\r\n  public entityCurrentlyUnderPointer(entity: Entity, pointerId: number) {\r\n    return this.currentFrameEntityToPointers.has(entity.id) &&\r\n           this.currentFrameEntityToPointers.get(entity.id).includes(pointerId);\r\n  }\r\n\r\n  public entityWasUnderPointer(entity: Entity, pointerId: number) {\r\n    return this.lastFrameEntityToPointers.has(entity.id) &&\r\n           this.lastFrameEntityToPointers.get(entity.id).includes(pointerId);\r\n  }\r\n\r\n  public entered(entity: Entity, pointerId: number) {\r\n    return this.entityCurrentlyUnderPointer(entity, pointerId) &&\r\n           !this.lastFrameEntityToPointers.has(entity.id);\r\n  }\r\n\r\n  public left(entity: Entity, pointerId: number) {\r\n    return !this.currentFrameEntityToPointers.has(entity.id) &&\r\n            this.entityWasUnderPointer(entity, pointerId);\r\n  }\r\n\r\n  public addPointerToEntity(entity: Entity, pointerId: number) {\r\n    if (!this.currentFrameEntityToPointers.has(entity.id)) {\r\n      this.currentFrameEntityToPointers.set(entity.id, [pointerId]);\r\n      return;\r\n    }\r\n    const pointers = this.currentFrameEntityToPointers.get(entity.id);\r\n    this.currentFrameEntityToPointers.set(entity.id, pointers.concat(pointerId));\r\n  }\r\n\r\n  public update(_entities: Entity[]): void {\r\n    // Locate all the pointer/entity mappings\r\n    this._processPointerToEntity(this._sortedEntities);\r\n\r\n    // Dispatch pointer events on entities\r\n    this._dispatchEvents(this._sortedEntities);\r\n\r\n    // Clear last frame's events\r\n    this._receiver.update();\r\n    this.lastFrameEntityToPointers.clear();\r\n    this.lastFrameEntityToPointers = new Map<number, number[]>(this.currentFrameEntityToPointers);\r\n    this.currentFrameEntityToPointers.clear();\r\n    this._receiver.clear();\r\n  }\r\n\r\n  private _processPointerToEntity(entities: Entity[]) {\r\n    let transform: TransformComponent;\r\n    let collider: ColliderComponent;\r\n    let graphics: GraphicsComponent;\r\n    let pointer: PointerComponent;\r\n\r\n    // TODO probably a spatial partition optimization here to quickly query bounds for pointer\r\n    // doesn't seem to cause issues tho for perf\r\n\r\n    // Pre-process find entities under pointers\r\n    for (const entity of entities) {\r\n      transform = entity.get(TransformComponent);\r\n      pointer = entity.get(PointerComponent) ?? new PointerComponent;\r\n      // Check collider contains pointer\r\n      collider = entity.get(ColliderComponent);\r\n      if (collider && (pointer.useColliderShape || this.overrideUseColliderShape)) {\r\n        collider.update();\r\n        const geom = collider.get();\r\n        if (geom) {\r\n          for (const [pointerId, pos] of this._receiver.currentFramePointerCoords.entries()) {\r\n            if (geom.contains(transform.coordPlane === CoordPlane.World ? pos.worldPos : pos.screenPos)) {\r\n              this.addPointerToEntity(entity, pointerId);\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      // Check graphics contains pointer\r\n      graphics = entity.get(GraphicsComponent);\r\n      if (graphics && (pointer.useGraphicsBounds || this.overrideUseGraphicsBounds)) {\r\n        const graphicBounds = graphics.localBounds.transform(transform.get().matrix);\r\n        for (const [pointerId, pos] of this._receiver.currentFramePointerCoords.entries()) {\r\n          if (graphicBounds.contains(transform.coordPlane === CoordPlane.World ? pos.worldPos : pos.screenPos)) {\r\n            this.addPointerToEntity(entity, pointerId);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private _processDownAndEmit(entity: Entity): Map<number, PointerEvent> {\r\n    const lastDownPerPointer = new Map<number, PointerEvent>();\r\n    // Loop through down and dispatch to entities\r\n    for (const event of this._receiver.currentFrameDown) {\r\n      if (event.active && entity.active && this.entityCurrentlyUnderPointer(entity, event.pointerId)) {\r\n        entity.events.emit('pointerdown', event as any);\r\n        if (this._receiver.isDragStart(event.pointerId)) {\r\n          entity.events.emit('pointerdragstart', event as any);\r\n        }\r\n      }\r\n      lastDownPerPointer.set(event.pointerId, event);\r\n    }\r\n    return lastDownPerPointer;\r\n  }\r\n\r\n  private _processUpAndEmit(entity: Entity): Map<number, PointerEvent> {\r\n    const lastUpPerPointer = new Map<number, PointerEvent>();\r\n    // Loop through up and dispatch to entities\r\n    for (const event of this._receiver.currentFrameUp) {\r\n      if (event.active && entity.active && this.entityCurrentlyUnderPointer(entity, event.pointerId)) {\r\n        entity.events.emit('pointerup', event as any);\r\n        if (this._receiver.isDragEnd(event.pointerId)) {\r\n          entity.events.emit('pointerdragend', event as any);\r\n        }\r\n      }\r\n      lastUpPerPointer.set(event.pointerId, event);\r\n    }\r\n    return lastUpPerPointer;\r\n  }\r\n\r\n  private _processMoveAndEmit(entity: Entity): Map<number, PointerEvent> {\r\n    const lastMovePerPointer = new Map<number, PointerEvent>();\r\n    // Loop through move and dispatch to entities\r\n    for (const event of this._receiver.currentFrameMove) {\r\n      if (event.active && entity.active && this.entityCurrentlyUnderPointer(entity, event.pointerId)) {\r\n        // move\r\n        entity.events.emit('pointermove', event as any);\r\n\r\n        if (this._receiver.isDragging(event.pointerId)) {\r\n          entity.events.emit('pointerdragmove', event as any);\r\n        }\r\n      }\r\n      lastMovePerPointer.set(event.pointerId, event);\r\n    }\r\n    return lastMovePerPointer;\r\n  }\r\n\r\n  private _processEnterLeaveAndEmit(entity: Entity, lastUpDownMoveEvents: PointerEvent[]) {\r\n    // up, down, and move are considered for enter and leave\r\n    for (const event of lastUpDownMoveEvents) {\r\n      // enter\r\n      if (event.active && entity.active && this.entered(entity, event.pointerId)) {\r\n        entity.events.emit('pointerenter', event as any);\r\n        if (this._receiver.isDragging(event.pointerId)) {\r\n          entity.events.emit('pointerdragenter', event as any);\r\n        }\r\n        break;\r\n      }\r\n      if (event.active && entity.active &&\r\n          // leave can happen on move\r\n          (this.left(entity, event.pointerId) ||\r\n          // or leave can happen on pointer up\r\n          (this.entityCurrentlyUnderPointer(entity, event.pointerId) && event.type === 'up'))) {\r\n        entity.events.emit('pointerleave', event as any);\r\n        if (this._receiver.isDragging(event.pointerId)) {\r\n          entity.events.emit('pointerdragleave', event as any);\r\n        }\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  private _processCancelAndEmit(entity: Entity) {\r\n    // cancel\r\n    for (const event of this._receiver.currentFrameCancel) {\r\n      if (event.active && entity.active && this.entityCurrentlyUnderPointer(entity, event.pointerId)){\r\n        entity.events.emit('pointercancel', event as any);\r\n      }\r\n    }\r\n  }\r\n\r\n  private _processWheelAndEmit(entity: Entity) {\r\n    // wheel\r\n    for (const event of this._receiver.currentFrameWheel) {\r\n      // Currently the wheel only fires under the primary pointer '0'\r\n      if (event.active && entity.active && this.entityCurrentlyUnderPointer(entity, 0)) {\r\n        entity.events.emit('pointerwheel', event as any);\r\n      }\r\n    }\r\n  }\r\n\r\n  private _dispatchEvents(entities: Entity[]) {\r\n    const lastFrameEntities = new Set(this.lastFrameEntityToPointers.keys());\r\n    const currentFrameEntities = new Set(this.currentFrameEntityToPointers.keys());\r\n    // Filter preserves z order\r\n    const entitiesWithEvents = entities.filter(e => lastFrameEntities.has(e.id) || currentFrameEntities.has(e.id));\r\n    let lastMovePerPointer: Map<number, PointerEvent>;\r\n    let lastUpPerPointer: Map<number, PointerEvent>;\r\n    let lastDownPerPointer: Map<number, PointerEvent>;\r\n    // Dispatch events in entity z order\r\n    for (const entity of entitiesWithEvents) {\r\n      lastDownPerPointer = this._processDownAndEmit(entity);\r\n\r\n      lastUpPerPointer = this._processUpAndEmit(entity);\r\n\r\n      lastMovePerPointer = this._processMoveAndEmit(entity);\r\n\r\n      const lastUpDownMoveEvents = [\r\n        ...lastMovePerPointer.values(),\r\n        ...lastDownPerPointer.values(),\r\n        ...lastUpPerPointer.values()\r\n      ];\r\n      this._processEnterLeaveAndEmit(entity, lastUpDownMoveEvents);\r\n\r\n      this._processCancelAndEmit(entity);\r\n\r\n      this._processWheelAndEmit(entity);\r\n    }\r\n  }\r\n}","import { Entity } from '../EntityComponentSystem';\r\nimport { AddedEntity, isAddedSystemEntity, RemovedEntity, System, SystemType } from '../EntityComponentSystem/System';\r\nimport { ActionsComponent } from './ActionsComponent';\r\n\r\n\r\nexport class ActionsSystem extends System<ActionsComponent> {\r\n  public readonly types = ['ex.actions'] as const;\r\n  systemType = SystemType.Update;\r\n  priority = -1;\r\n\r\n  private _actions: ActionsComponent[] = [];\r\n  public notify(entityAddedOrRemoved: AddedEntity | RemovedEntity): void {\r\n    if (isAddedSystemEntity(entityAddedOrRemoved)) {\r\n      const action = entityAddedOrRemoved.data.get(ActionsComponent);\r\n      this._actions.push(action);\r\n    } else {\r\n      const action = entityAddedOrRemoved.data.get(ActionsComponent);\r\n      const index = this._actions.indexOf(action);\r\n      if (index > -1) {\r\n        this._actions.splice(index, 1);\r\n      }\r\n    }\r\n  }\r\n\r\n  update(_entities: Entity[], delta: number): void {\r\n    for (const actions of this._actions) {\r\n      actions.update(delta);\r\n    }\r\n  }\r\n}","import { Component } from '../EntityComponentSystem/Component';\r\nimport { IsometricMap } from './IsometricMap';\r\n\r\nexport class IsometricEntityComponent extends Component<'ex.isometricentity'> {\r\n  public readonly type = 'ex.isometricentity';\r\n  /**\r\n   * Vertical \"height\" in the isometric world\r\n   */\r\n  public elevation: number = 0;\r\n\r\n  public map: IsometricMap;\r\n\r\n  /**\r\n   * Specify the isometric map to use to position this entity's z-index\r\n   * @param map\r\n   */\r\n  constructor(map: IsometricMap) {\r\n    super();\r\n    this.map = map;\r\n  }\r\n}","import { System, SystemType } from '../EntityComponentSystem/System';\r\nimport { Entity } from '../EntityComponentSystem/Entity';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { IsometricEntityComponent } from './IsometricEntityComponent';\r\n\r\n\r\nexport class IsometricEntitySystem extends System<TransformComponent | IsometricEntityComponent> {\r\n  public readonly types = ['ex.transform', 'ex.isometricentity'] as const;\r\n  public readonly systemType = SystemType.Update;\r\n  priority: number = 99;\r\n  update(entities: Entity[], _delta: number): void {\r\n    let transform: TransformComponent;\r\n    let iso: IsometricEntityComponent;\r\n    for (const entity of entities) {\r\n      transform = entity.get(TransformComponent);\r\n      iso = entity.get(IsometricEntityComponent);\r\n\r\n      const maxZindexPerElevation = Math.max(iso.map.columns * iso.map.tileWidth, iso.map.rows * iso.map.tileHeight);\r\n\r\n      const newZ = maxZindexPerElevation * iso.elevation + transform.pos.y;\r\n      transform.z = newZ;\r\n    }\r\n  }\r\n}","import { GraphicsComponent } from './GraphicsComponent';\r\nimport { EnterViewPortEvent, ExitViewPortEvent } from '../Events';\r\nimport { Scene } from '../Scene';\r\nimport { Entity } from '../EntityComponentSystem/Entity';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { Camera } from '../Camera';\r\nimport { System, SystemType } from '../EntityComponentSystem/System';\r\nimport { ParallaxComponent } from './ParallaxComponent';\r\nimport { Vector } from '../Math/vector';\r\nimport { CoordPlane } from '../Math/coord-plane';\r\n\r\nexport class OffscreenSystem extends System<TransformComponent | GraphicsComponent> {\r\n  public readonly types = ['ex.transform', 'ex.graphics'] as const;\r\n  public systemType = SystemType.Draw;\r\n  priority: number = -1;\r\n  private _camera: Camera;\r\n\r\n  public initialize(scene: Scene): void {\r\n    this._camera = scene.camera;\r\n  }\r\n\r\n  update(entities: Entity[]): void {\r\n    let transform: TransformComponent;\r\n    let graphics: GraphicsComponent;\r\n    let maybeParallax: ParallaxComponent;\r\n\r\n    for (const entity of entities) {\r\n      graphics = entity.get(GraphicsComponent);\r\n      transform = entity.get(TransformComponent);\r\n      maybeParallax = entity.get(ParallaxComponent);\r\n\r\n      let parallaxOffset: Vector;\r\n      if (maybeParallax) {\r\n        // We use the Tiled formula\r\n        // https://doc.mapeditor.org/en/latest/manual/layers/#parallax-scrolling-factor\r\n        // cameraPos * (1 - parallaxFactor)\r\n        const oneMinusFactor = Vector.One.sub(maybeParallax.parallaxFactor);\r\n        parallaxOffset = this._camera.pos.scale(oneMinusFactor);\r\n      }\r\n\r\n      // Figure out if entities are offscreen\r\n      const entityOffscreen = this._isOffscreen(transform, graphics, parallaxOffset);\r\n      if (entityOffscreen && !entity.hasTag('ex.offscreen')) {\r\n        entity.eventDispatcher.emit('exitviewport', new ExitViewPortEvent(entity));\r\n        entity.addTag('ex.offscreen');\r\n      }\r\n\r\n      if (!entityOffscreen && entity.hasTag('ex.offscreen')) {\r\n        entity.eventDispatcher.emit('enterviewport', new EnterViewPortEvent(entity));\r\n        entity.removeTag('ex.offscreen');\r\n      }\r\n    }\r\n  }\r\n\r\n  private _isOffscreen(transform: TransformComponent, graphics: GraphicsComponent, parallaxOffset: Vector) {\r\n    if (transform.coordPlane === CoordPlane.World) {\r\n      let bounds = graphics.localBounds;\r\n      if (parallaxOffset) {\r\n        bounds = bounds.translate(parallaxOffset);\r\n      }\r\n      const transformedBounds = bounds.transform(transform.get().matrix);\r\n      const graphicsOffscreen = !this._camera.viewport.overlaps(transformedBounds);\r\n      return graphicsOffscreen;\r\n    } else {\r\n      // TODO screen coordinates\r\n      return false;\r\n    }\r\n  }\r\n\r\n}","import { isScreenElement, ScreenElement } from './ScreenElement';\r\nimport {\r\n  InitializeEvent,\r\n  ActivateEvent,\r\n  DeactivateEvent,\r\n  PreUpdateEvent,\r\n  PostUpdateEvent,\r\n  PreDrawEvent,\r\n  PostDrawEvent,\r\n  PreDebugDrawEvent,\r\n  PostDebugDrawEvent,\r\n  GameEvent\r\n} from './Events';\r\nimport { Logger } from './Util/Log';\r\nimport { Timer } from './Timer';\r\nimport { Engine } from './Engine';\r\nimport { TileMap } from './TileMap';\r\nimport { Camera } from './Camera';\r\nimport { Actor } from './Actor';\r\nimport { Class } from './Class';\r\nimport { CanInitialize, CanActivate, CanDeactivate, CanUpdate, CanDraw, SceneActivationContext } from './Interfaces/LifecycleEvents';\r\nimport * as Util from './Util/Util';\r\nimport * as Events from './Events';\r\nimport { Trigger } from './Trigger';\r\nimport { SystemType } from './EntityComponentSystem/System';\r\nimport { World } from './EntityComponentSystem/World';\r\nimport { MotionSystem } from './Collision/MotionSystem';\r\nimport { CollisionSystem } from './Collision/CollisionSystem';\r\nimport { Entity } from './EntityComponentSystem/Entity';\r\nimport { GraphicsSystem } from './Graphics/GraphicsSystem';\r\nimport { DebugSystem } from './Debug/DebugSystem';\r\nimport { PointerSystem } from './Input/PointerSystem';\r\nimport { ActionsSystem } from './Actions/ActionsSystem';\r\nimport { IsometricEntitySystem } from './TileMap/IsometricEntitySystem';\r\nimport { OffscreenSystem } from './Graphics/OffscreenSystem';\r\nimport { ExcaliburGraphicsContext } from './Graphics';\r\n/**\r\n * [[Actor|Actors]] are composed together into groupings called Scenes in\r\n * Excalibur. The metaphor models the same idea behind real world\r\n * actors in a scene. Only actors in scenes will be updated and drawn.\r\n *\r\n * Typical usages of a scene include: levels, menus, loading screens, etc.\r\n */\r\nexport class Scene<TActivationData = unknown>\r\n  extends Class\r\n  implements CanInitialize, CanActivate<TActivationData>, CanDeactivate, CanUpdate, CanDraw {\r\n  private _logger: Logger = Logger.getInstance();\r\n  /**\r\n   * Gets or sets the current camera for the scene\r\n   */\r\n  public camera: Camera = new Camera();\r\n\r\n  /**\r\n   * The ECS world for the scene\r\n   */\r\n  public world = new World(this);\r\n\r\n  /**\r\n   * The actors in the current scene\r\n   */\r\n  public get actors(): readonly Actor[] {\r\n    return this.world.entityManager.entities.filter((e) => {\r\n      return e instanceof Actor;\r\n    }) as Actor[];\r\n  }\r\n\r\n  /**\r\n   * The entities in the current scene\r\n   */\r\n  public get entities(): readonly Entity[] {\r\n    return this.world.entityManager.entities;\r\n  }\r\n\r\n  /**\r\n   * The triggers in the current scene\r\n   */\r\n  public get triggers(): readonly Trigger[] {\r\n    return this.world.entityManager.entities.filter((e) => {\r\n      return e instanceof Trigger;\r\n    }) as Trigger[];\r\n  }\r\n\r\n  /**\r\n   * The [[TileMap]]s in the scene, if any\r\n   */\r\n  public get tileMaps(): readonly TileMap[] {\r\n    return this.world.entityManager.entities.filter((e) => {\r\n      return e instanceof TileMap;\r\n    }) as TileMap[];\r\n  }\r\n\r\n  /**\r\n   * Access to the Excalibur engine\r\n   */\r\n  public engine: Engine;\r\n\r\n  private _isInitialized: boolean = false;\r\n  private _timers: Timer[] = [];\r\n  public get timers(): readonly Timer[] {\r\n    return this._timers;\r\n  }\r\n  private _cancelQueue: Timer[] = [];\r\n\r\n  constructor() {\r\n    super();\r\n    // Initialize systems\r\n\r\n    // Update\r\n    this.world.add(new ActionsSystem());\r\n    this.world.add(new MotionSystem());\r\n    this.world.add(new CollisionSystem());\r\n    this.world.add(new PointerSystem());\r\n    this.world.add(new IsometricEntitySystem());\r\n    // Draw\r\n    this.world.add(new OffscreenSystem());\r\n    this.world.add(new GraphicsSystem());\r\n    this.world.add(new DebugSystem());\r\n  }\r\n\r\n  public on(eventName: Events.initialize, handler: (event: InitializeEvent<Scene>) => void): void;\r\n  public on(eventName: Events.activate, handler: (event: ActivateEvent) => void): void;\r\n  public on(eventName: Events.deactivate, handler: (event: DeactivateEvent) => void): void;\r\n  public on(eventName: Events.preupdate, handler: (event: PreUpdateEvent<Scene>) => void): void;\r\n  public on(eventName: Events.postupdate, handler: (event: PostUpdateEvent<Scene>) => void): void;\r\n  public on(eventName: Events.predraw, handler: (event: PreDrawEvent) => void): void;\r\n  public on(eventName: Events.postdraw, handler: (event: PostDrawEvent) => void): void;\r\n  public on(eventName: Events.predebugdraw, handler: (event: PreDebugDrawEvent) => void): void;\r\n  public on(eventName: Events.postdebugdraw, handler: (event: PostDebugDrawEvent) => void): void;\r\n  public on(eventName: string, handler: (event: GameEvent<any>) => void): void;\r\n  public on(eventName: string, handler: (event: any) => void): void {\r\n    super.on(eventName, handler);\r\n  }\r\n\r\n  public once(eventName: Events.initialize, handler: (event: InitializeEvent<Scene>) => void): void;\r\n  public once(eventName: Events.activate, handler: (event: ActivateEvent) => void): void;\r\n  public once(eventName: Events.deactivate, handler: (event: DeactivateEvent) => void): void;\r\n  public once(eventName: Events.preupdate, handler: (event: PreUpdateEvent<Scene>) => void): void;\r\n  public once(eventName: Events.postupdate, handler: (event: PostUpdateEvent<Scene>) => void): void;\r\n  public once(eventName: Events.predraw, handler: (event: PreDrawEvent) => void): void;\r\n  public once(eventName: Events.postdraw, handler: (event: PostDrawEvent) => void): void;\r\n  public once(eventName: Events.predebugdraw, handler: (event: PreDebugDrawEvent) => void): void;\r\n  public once(eventName: Events.postdebugdraw, handler: (event: PostDebugDrawEvent) => void): void;\r\n  public once(eventName: string, handler: (event: GameEvent<any>) => void): void;\r\n  public once(eventName: string, handler: (event: any) => void): void {\r\n    super.once(eventName, handler);\r\n  }\r\n\r\n  public off(eventName: Events.initialize, handler?: (event: InitializeEvent<Scene>) => void): void;\r\n  public off(eventName: Events.activate, handler?: (event: ActivateEvent) => void): void;\r\n  public off(eventName: Events.deactivate, handler?: (event: DeactivateEvent) => void): void;\r\n  public off(eventName: Events.preupdate, handler?: (event: PreUpdateEvent<Scene>) => void): void;\r\n  public off(eventName: Events.postupdate, handler?: (event: PostUpdateEvent<Scene>) => void): void;\r\n  public off(eventName: Events.predraw, handler?: (event: PreDrawEvent) => void): void;\r\n  public off(eventName: Events.postdraw, handler?: (event: PostDrawEvent) => void): void;\r\n  public off(eventName: Events.predebugdraw, handler?: (event: PreDebugDrawEvent) => void): void;\r\n  public off(eventName: Events.postdebugdraw, handler?: (event: PostDebugDrawEvent) => void): void;\r\n  public off(eventName: string, handler?: (event: GameEvent<any>) => void): void;\r\n  public off(eventName: string, handler?: (event: any) => void): void {\r\n    super.off(eventName, handler);\r\n  }\r\n\r\n  /**\r\n   * This is called before the first update of the [[Scene]]. Initializes scene members like the camera. This method is meant to be\r\n   * overridden. This is where initialization of child actors should take place.\r\n   */\r\n  public onInitialize(_engine: Engine): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * This is called when the scene is made active and started. It is meant to be overridden,\r\n   * this is where you should setup any DOM UI or event handlers needed for the scene.\r\n   */\r\n  public onActivate(_context: SceneActivationContext<TActivationData>): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * This is called when the scene is made transitioned away from and stopped. It is meant to be overridden,\r\n   * this is where you should cleanup any DOM UI or event handlers needed for the scene.\r\n   */\r\n  public onDeactivate(_context: SceneActivationContext): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPreUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPreUpdate` is called directly before a scene is updated.\r\n   */\r\n  public onPreUpdate(_engine: Engine, _delta: number): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPostUpdate` is called directly after a scene is updated.\r\n   */\r\n  public onPostUpdate(_engine: Engine, _delta: number): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPreDraw lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPreDraw` is called directly before a scene is drawn.\r\n   *\r\n   */\r\n  public onPreDraw(_ctx: ExcaliburGraphicsContext, _delta: number): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostDraw lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPostDraw` is called directly after a scene is drawn.\r\n   *\r\n   */\r\n  public onPostDraw(_ctx: ExcaliburGraphicsContext, _delta: number): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * Initializes actors in the scene\r\n   */\r\n  private _initializeChildren(): void {\r\n    for (const child of this.entities) {\r\n      child._initialize(this.engine);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets whether or not the [[Scene]] has been initialized\r\n   */\r\n  public get isInitialized(): boolean {\r\n    return this._isInitialized;\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Initializes the scene before the first update, meant to be called by engine not by users of\r\n   * Excalibur\r\n   * @internal\r\n   */\r\n  public _initialize(engine: Engine) {\r\n    if (!this.isInitialized) {\r\n      this.engine = engine;\r\n      // Initialize camera first\r\n      this.camera._initialize(engine);\r\n\r\n      this.world.systemManager.initialize();\r\n\r\n      // This order is important! we want to be sure any custom init that add actors\r\n      // fire before the actor init\r\n      this.onInitialize.call(this, engine);\r\n      this._initializeChildren();\r\n\r\n      this._logger.debug('Scene.onInitialize', this, engine);\r\n      this.eventDispatcher.emit('initialize', new InitializeEvent(engine, this));\r\n      this._isInitialized = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Activates the scene with the base behavior, then calls the overridable `onActivate` implementation.\r\n   * @internal\r\n   */\r\n  public _activate(context: SceneActivationContext<TActivationData>): void {\r\n    this._logger.debug('Scene.onActivate', this);\r\n    this.onActivate(context);\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Deactivates the scene with the base behavior, then calls the overridable `onDeactivate` implementation.\r\n   * @internal\r\n   */\r\n  public _deactivate(context: SceneActivationContext<never>): void {\r\n    this._logger.debug('Scene.onDeactivate', this);\r\n    this.onDeactivate(context);\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for [[onPreUpdate]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _preupdate(_engine: Engine, delta: number): void {\r\n    this.emit('preupdate', new PreUpdateEvent(_engine, delta, this));\r\n    this.onPreUpdate(_engine, delta);\r\n  }\r\n\r\n  /**\r\n   *  It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for [[onPostUpdate]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _postupdate(_engine: Engine, delta: number): void {\r\n    this.emit('postupdate', new PostUpdateEvent(_engine, delta, this));\r\n    this.onPostUpdate(_engine, delta);\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _predraw handler for [[onPreDraw]] lifecycle event\r\n   *\r\n   * @internal\r\n   */\r\n  public _predraw(_ctx: ExcaliburGraphicsContext, _delta: number): void {\r\n    this.emit('predraw', new PreDrawEvent(_ctx, _delta, this));\r\n    this.onPreDraw(_ctx, _delta);\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _postdraw handler for [[onPostDraw]] lifecycle event\r\n   *\r\n   * @internal\r\n   */\r\n  public _postdraw(_ctx: ExcaliburGraphicsContext, _delta: number): void {\r\n    this.emit('postdraw', new PostDrawEvent(_ctx, _delta, this));\r\n    this.onPostDraw(_ctx, _delta);\r\n  }\r\n\r\n  /**\r\n   * Updates all the actors and timers in the scene. Called by the [[Engine]].\r\n   * @param engine  Reference to the current Engine\r\n   * @param delta   The number of milliseconds since the last update\r\n   */\r\n  public update(engine: Engine, delta: number) {\r\n    this._preupdate(engine, delta);\r\n\r\n    // TODO differed entity removal for timers\r\n    let i: number, len: number;\r\n    // Remove timers in the cancel queue before updating them\r\n    for (i = 0, len = this._cancelQueue.length; i < len; i++) {\r\n      this.removeTimer(this._cancelQueue[i]);\r\n    }\r\n    this._cancelQueue.length = 0;\r\n\r\n    // Cycle through timers updating timers\r\n    for (const timer of this._timers) {\r\n      timer.update(delta);\r\n    }\r\n\r\n    this.world.update(SystemType.Update, delta);\r\n\r\n    // Camera last keeps renders smooth that are based on entity/actor\r\n    if (this.camera) {\r\n      this.camera.update(engine, delta);\r\n    }\r\n\r\n    this._collectActorStats(engine);\r\n\r\n    this._postupdate(engine, delta);\r\n  }\r\n\r\n  /**\r\n   * Draws all the actors in the Scene. Called by the [[Engine]].\r\n   *\r\n   * @param ctx    The current rendering context\r\n   * @param delta  The number of milliseconds since the last draw\r\n   */\r\n  public draw(ctx: ExcaliburGraphicsContext, delta: number) {\r\n    this._predraw(ctx, delta);\r\n\r\n    this.world.update(SystemType.Draw, delta);\r\n\r\n    if (this.engine?.isDebug) {\r\n      this.debugDraw(ctx);\r\n    }\r\n    this._postdraw(ctx, delta);\r\n  }\r\n\r\n  /**\r\n   * Draws all the actors' debug information in the Scene. Called by the [[Engine]].\r\n   * @param ctx  The current rendering context\r\n   */\r\n  /* istanbul ignore next */\r\n  public debugDraw(ctx: ExcaliburGraphicsContext) {\r\n    this.emit('predebugdraw', new PreDebugDrawEvent(ctx, this));\r\n    // pass\r\n    this.emit('postdebugdraw', new PostDebugDrawEvent(ctx, this));\r\n  }\r\n\r\n  /**\r\n   * Checks whether an actor is contained in this scene or not\r\n   */\r\n  public contains(actor: Actor): boolean {\r\n    return this.actors.indexOf(actor) > -1;\r\n  }\r\n\r\n  /**\r\n   * Adds a [[Timer]] to the current [[Scene]].\r\n   * @param timer  The timer to add to the current [[Scene]].\r\n   */\r\n  public add(timer: Timer): void;\r\n\r\n  /**\r\n   * Adds a [[TileMap]] to the [[Scene]], once this is done the [[TileMap]] will be drawn and updated.\r\n   */\r\n  public add(tileMap: TileMap): void;\r\n\r\n  /**\r\n   * Adds a [[Trigger]] to the [[Scene]], once this is done the [[Trigger]] will listen for interactions with other actors.\r\n   * @param trigger\r\n   */\r\n  public add(trigger: Trigger): void;\r\n\r\n  /**\r\n   * Adds an actor to the scene, once this is done the [[Actor]] will be drawn and updated.\r\n   * @param actor  The actor to add to the current scene\r\n   */\r\n  public add(actor: Actor): void;\r\n\r\n  public add(entity: Entity): void;\r\n\r\n  /**\r\n   * Adds a [[ScreenElement]] to the scene.\r\n   * @param screenElement  The ScreenElement to add to the current scene\r\n   */\r\n  public add(screenElement: ScreenElement): void;\r\n  public add(entity: any): void {\r\n    this.emit('entityadded', { target: entity } as any);\r\n    this.world.add(entity);\r\n    entity.scene = this;\r\n    if (entity instanceof Timer) {\r\n      if (!Util.contains(this._timers, entity)) {\r\n        this.addTimer(entity);\r\n      }\r\n      return;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes a [[Timer]] from the current scene, it will no longer be updated.\r\n   * @param timer  The timer to remove to the current scene.\r\n   */\r\n  public remove(timer: Timer): void;\r\n\r\n  /**\r\n   * Removes a [[TileMap]] from the scene, it will no longer be drawn or updated.\r\n   * @param tileMap {TileMap}\r\n   */\r\n  public remove(tileMap: TileMap): void;\r\n\r\n  /**\r\n   * Removes an actor from the scene, it will no longer be drawn or updated.\r\n   * @param actor  The actor to remove from the current scene.\r\n   */\r\n  public remove(actor: Actor): void;\r\n\r\n  public remove(entity: Entity): void;\r\n\r\n  /**\r\n   * Removes a [[ScreenElement]] to the scene, it will no longer be drawn or updated\r\n   * @param screenElement  The ScreenElement to remove from the current scene\r\n   */\r\n  public remove(screenElement: ScreenElement): void;\r\n  public remove(entity: any): void {\r\n    if (entity instanceof Entity) {\r\n      this.emit('entityremoved', { target: entity } as any);\r\n      this.world.remove(entity);\r\n    }\r\n    if (entity instanceof Timer) {\r\n      this.removeTimer(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes all entities and timers from the scene, optionally indicate whether deferred should or shouldn't be used.\r\n   *\r\n   * By default entities use deferred removal\r\n   * @param deferred\r\n   */\r\n  public clear(deferred: boolean = true): void {\r\n    for (const entity of this.entities) {\r\n      this.world.remove(entity, deferred);\r\n    }\r\n    for (const timer of this.timers) {\r\n      this.removeTimer(timer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adds a [[Timer]] to the scene\r\n   * @param timer  The timer to add\r\n   */\r\n  public addTimer(timer: Timer): Timer {\r\n    this._timers.push(timer);\r\n    timer.scene = this;\r\n    return timer;\r\n  }\r\n\r\n  /**\r\n   * Removes a [[Timer]] from the scene.\r\n   * @warning Can be dangerous, use [[cancelTimer]] instead\r\n   * @param timer  The timer to remove\r\n   */\r\n  public removeTimer(timer: Timer): Timer {\r\n    const i = this._timers.indexOf(timer);\r\n    if (i !== -1) {\r\n      this._timers.splice(i, 1);\r\n    }\r\n    return timer;\r\n  }\r\n\r\n  /**\r\n   * Cancels a [[Timer]], removing it from the scene nicely\r\n   * @param timer  The timer to cancel\r\n   */\r\n  public cancelTimer(timer: Timer): Timer {\r\n    this._cancelQueue.push(timer);\r\n    return timer;\r\n  }\r\n\r\n  /**\r\n   * Tests whether a [[Timer]] is active in the scene\r\n   */\r\n  public isTimerActive(timer: Timer): boolean {\r\n    return this._timers.indexOf(timer) > -1 && !timer.complete;\r\n  }\r\n\r\n  public isCurrentScene(): boolean {\r\n    if (this.engine) {\r\n      return this.engine.currentScene === this;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  private _collectActorStats(engine: Engine) {\r\n    const screenElements = this.actors.filter((a) => a instanceof ScreenElement) as ScreenElement[];\r\n    for (const _ui of screenElements) {\r\n      engine.stats.currFrame.actors.ui++;\r\n    }\r\n\r\n    for (const actor of this.actors) {\r\n      engine.stats.currFrame.actors.alive++;\r\n      for (const child of actor.children) {\r\n        if (isScreenElement(child as Actor)) {\r\n          // TODO not true\r\n          engine.stats.currFrame.actors.ui++;\r\n        } else {\r\n          engine.stats.currFrame.actors.alive++;\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Shader } from '../Context/shader';\r\nimport { VertexBuffer } from '../Context/vertex-buffer';\r\nimport { VertexLayout } from '../Context/vertex-layout';\r\n\r\n/**\r\n * Helper that defines a whole screen renderer, just provide a fragment source!\r\n *\r\n * Currently supports 1 varying\r\n * - vec2 a_texcoord between 0-1 which corresponds to screen position\r\n */\r\nexport class ScreenShader {\r\n  private _shader: Shader;\r\n  private _buffer: VertexBuffer;\r\n  private _layout: VertexLayout;\r\n  constructor(fragmentSource: string) {\r\n    this._shader = new Shader({\r\n      vertexSource: `#version 300 es\r\n      in vec2 a_position;\r\n      in vec2 a_texcoord;\r\n      out vec2 v_texcoord;\r\n\r\n      void main() {\r\n        gl_Position = vec4(a_position, 0.0, 1.0);\r\n        // Pass the texcoord to the fragment shader.\r\n        v_texcoord = a_texcoord;\r\n      }`,\r\n      fragmentSource: fragmentSource\r\n    });\r\n    this._shader.compile();\r\n    // Setup memory layout\r\n    this._buffer = new VertexBuffer({\r\n      type: 'static',\r\n      // clip space quad + uv since we don't need a camera\r\n      data: new Float32Array([\r\n        -1, -1,          0, 0,\r\n        -1, 1,           0, 1,\r\n        1, -1,           1, 0,\r\n\r\n        1, -1,            1, 0,\r\n        -1, 1,           0, 1,\r\n        1, 1,            1, 1\r\n      ])\r\n    });\r\n    this._layout = new VertexLayout({\r\n      shader: this._shader,\r\n      vertexBuffer: this._buffer,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_texcoord', 2]\r\n      ]\r\n    });\r\n    this._buffer.upload();\r\n  }\r\n\r\n  public getShader() {\r\n    return this._shader;\r\n  }\r\n  public getLayout() {\r\n    return this._layout;\r\n  }\r\n}","import colorBlindCorrectSource from './color-blind-fragment.glsl';\r\nimport { PostProcessor } from './PostProcessor';\r\nimport { ColorBlindnessMode } from './ColorBlindnessMode';\r\nimport { Shader } from '../Context/shader';\r\nimport { VertexLayout } from '../Context/vertex-layout';\r\nimport { ScreenShader } from './ScreenShader';\r\n\r\nexport class ColorBlindnessPostProcessor implements PostProcessor {\r\n  private _shader: ScreenShader;\r\n  private _simulate = false;\r\n  constructor(private _colorBlindnessMode: ColorBlindnessMode, simulate = false) {\r\n    this._simulate = simulate;\r\n  }\r\n\r\n  initialize(_gl: WebGLRenderingContext): void {\r\n    this._shader = new ScreenShader(colorBlindCorrectSource);\r\n    this.simulate = this._simulate;\r\n    this.colorBlindnessMode = this._colorBlindnessMode;\r\n  }\r\n\r\n  getShader(): Shader {\r\n    return this._shader.getShader();\r\n  }\r\n\r\n  getLayout(): VertexLayout {\r\n    return this._shader.getLayout();\r\n  }\r\n\r\n  set colorBlindnessMode(colorBlindMode: ColorBlindnessMode) {\r\n    this._colorBlindnessMode = colorBlindMode;\r\n    if (this._shader) {\r\n      const shader = this._shader.getShader();\r\n      shader.use();\r\n      if (this._colorBlindnessMode === ColorBlindnessMode.Protanope) {\r\n        shader.setUniformInt('u_type', 0);\r\n      } else if (this._colorBlindnessMode === ColorBlindnessMode.Deuteranope) {\r\n        shader.setUniformInt('u_type', 1);\r\n      } else if (this._colorBlindnessMode === ColorBlindnessMode.Tritanope) {\r\n        shader.setUniformInt('u_type', 2);\r\n      }\r\n    }\r\n  }\r\n\r\n  get colorBlindnessMode(): ColorBlindnessMode {\r\n    return this._colorBlindnessMode;\r\n  }\r\n\r\n  set simulate(value: boolean) {\r\n    this._simulate = value;\r\n    if (this._shader) {\r\n\r\n      const shader = this._shader.getShader();\r\n      shader.use();\r\n      shader.setUniformBoolean('u_simulate', value);\r\n    }\r\n  }\r\n\r\n  get simulate(): boolean {\r\n    return this._simulate;\r\n  }\r\n}\r\n","export default \"#version 300 es\\r\\nprecision mediump float;\\r\\n// our texture\\r\\nuniform sampler2D u_image;\\r\\n// the texCoords passed in from the vertex shader.\\r\\nin vec2 v_texcoord;\\r\\n\\r\\n// color blind type\\r\\nuniform int u_type;\\r\\n\\r\\n// simulation?\\r\\nuniform bool u_simulate;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main() {\\r\\n  vec4 o =  texture(u_image, v_texcoord);\\r\\n  // RGB to LMS matrix conversion\\r\\n  float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);\\r\\n  float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);\\r\\n  float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);\\r\\n  // Simulate color blindness\\r\\n  float l;\\r\\n  float m;\\r\\n  float s;\\r\\n  //MODE CODE//\\r\\n  if (u_type == 0) {\\r\\n    // Protanope\\r\\n    l = 0.0 * L + 2.02344 * M + -2.52581 * S;\\r\\n    m = 0.0 * L + 1.0 * M + 0.0 * S;\\r\\n    s = 0.0 * L + 0.0 * M + 1.0 * S;;\\r\\n  } else if (u_type == 1) {\\r\\n    // Deuteranope\\r\\n    l = 1.0 * L + 0.0 * M + 0.0 * S;\\r\\n    m = 0.494207 * L + 0.0 * M + 1.24827 * S;\\r\\n    s = 0.0 * L + 0.0 * M + 1.0 * S;\\r\\n  } else if (u_type == 2) {\\r\\n    // Tritanope\\r\\n    l = 1.0 * L + 0.0 * M + 0.0 * S;\\r\\n    m = 0.0 * L + 1.0 * M + 0.0 * S;\\r\\n    s = -0.395913 * L + 0.801109 * M + 0.0 * S;\\r\\n  }\\r\\n\\r\\n  // LMS to RGB matrix conversion\\r\\n  vec4 error; // simulate the colors\\r\\n  error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);\\r\\n  error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);\\r\\n  error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);\\r\\n  error.a = 1.0;\\r\\n  vec4 diff = o - error;\\r\\n  vec4 correction; // correct the colors\\r\\n  correction.r = 0.0;\\r\\n  correction.g =  (diff.r * 0.7) + (diff.g * 1.0);\\r\\n  correction.b =  (diff.r * 0.7) + (diff.b * 1.0);\\r\\n  correction = o + correction;\\r\\n  correction.a = o.a;\\r\\n  //SIMULATE//\\r\\n\\r\\n  // sim \\r\\n  if (u_simulate) {\\r\\n    fragColor = error.rgba;\\r\\n  } else {\\r\\n    fragColor = correction.rgba;\\r\\n  }\\r\\n}\";","import { ColorBlindnessMode } from '../Graphics/PostProcessor/ColorBlindnessMode';\r\nimport { ColorBlindnessPostProcessor } from '../Graphics/PostProcessor/ColorBlindnessPostProcessor';\r\nimport { Engine } from '../Engine';\r\nimport { ExcaliburGraphicsContextWebGL } from '..';\r\n\r\nexport interface DebugFlags {\r\n  colorBlindMode: ColorBlindFlags;\r\n}\r\n\r\nexport class ColorBlindFlags {\r\n  private _engine: Engine;\r\n  private _colorBlindPostProcessor: ColorBlindnessPostProcessor;\r\n\r\n  constructor(engine: Engine) {\r\n    this._engine = engine;\r\n    this._colorBlindPostProcessor = new ColorBlindnessPostProcessor(ColorBlindnessMode.Protanope);\r\n  }\r\n\r\n  /**\r\n   * Correct colors for a specified color blindness\r\n   * @param colorBlindness\r\n   */\r\n  public correct(colorBlindness: ColorBlindnessMode) {\r\n    if (this._engine.graphicsContext instanceof ExcaliburGraphicsContextWebGL) {\r\n      this.clear();\r\n      this._colorBlindPostProcessor.colorBlindnessMode = colorBlindness;\r\n      this._colorBlindPostProcessor.simulate = false;\r\n      this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Simulate colors for a specified color blindness\r\n   * @param colorBlindness\r\n   */\r\n  public simulate(colorBlindness: ColorBlindnessMode) {\r\n    if (this._engine.graphicsContext instanceof ExcaliburGraphicsContextWebGL) {\r\n      this.clear();\r\n      this._colorBlindPostProcessor.colorBlindnessMode = colorBlindness;\r\n      this._colorBlindPostProcessor.simulate = true;\r\n      this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove color blindness post processor\r\n   */\r\n  public clear() {\r\n    this._engine.graphicsContext.removePostProcessor(this._colorBlindPostProcessor);\r\n  }\r\n}\r\n","import { DebugFlags, ColorBlindFlags } from './DebugFlags';\r\nimport { Engine } from '../Engine';\r\nimport { Color } from '../Color';\r\nimport { CollisionContact } from '../Collision/Detection/CollisionContact';\r\nimport { StandardClock, TestClock } from '..';\r\n\r\n/**\r\n * Debug stats containing current and previous frame statistics\r\n */\r\nexport interface DebugStats {\r\n  currFrame: FrameStats;\r\n  prevFrame: FrameStats;\r\n}\r\n\r\n/**\r\n * Represents a frame's individual statistics\r\n */\r\nexport interface FrameStatistics {\r\n  /**\r\n   * The number of the frame\r\n   */\r\n  id: number;\r\n\r\n  /**\r\n   * Gets the frame's delta (time since last frame scaled by [[Engine.timescale]]) (in ms)\r\n   */\r\n  delta: number;\r\n\r\n  /**\r\n   * Gets the frame's frames-per-second (FPS)\r\n   */\r\n  fps: number;\r\n\r\n  /**\r\n   * Duration statistics (in ms)\r\n   */\r\n  duration: FrameDurationStats;\r\n\r\n  /**\r\n   * Actor statistics\r\n   */\r\n  actors: FrameActorStats;\r\n\r\n  /**\r\n   * Physics statistics\r\n   */\r\n  physics: PhysicsStatistics;\r\n\r\n  /**\r\n   * Graphics statistics\r\n   */\r\n  graphics: GraphicsStatistics;\r\n}\r\n\r\n/**\r\n * Represents actor stats for a frame\r\n */\r\nexport interface FrameActorStats {\r\n  /**\r\n   * Gets the frame's number of actors (alive)\r\n   */\r\n  alive: number;\r\n\r\n  /**\r\n   * Gets the frame's number of actors (killed)\r\n   */\r\n  killed: number;\r\n\r\n  /**\r\n   * Gets the frame's number of remaining actors (alive - killed)\r\n   */\r\n  remaining: number;\r\n\r\n  /**\r\n   * Gets the frame's number of UI actors\r\n   */\r\n  ui: number;\r\n\r\n  /**\r\n   * Gets the frame's number of total actors (remaining + UI)\r\n   */\r\n  total: number;\r\n}\r\n\r\n/**\r\n * Represents duration stats for a frame\r\n */\r\nexport interface FrameDurationStats {\r\n  /**\r\n   * Gets the frame's total time to run the update function (in ms)\r\n   */\r\n  update: number;\r\n\r\n  /**\r\n   * Gets the frame's total time to run the draw function (in ms)\r\n   */\r\n  draw: number;\r\n\r\n  /**\r\n   * Gets the frame's total render duration (update + draw duration) (in ms)\r\n   */\r\n  total: number;\r\n}\r\n\r\n/**\r\n * Represents physics stats for the current frame\r\n */\r\nexport interface PhysicsStatistics {\r\n  /**\r\n   * Gets the number of broadphase collision pairs which\r\n   */\r\n  pairs: number;\r\n\r\n  /**\r\n   * Gets the number of actual collisions\r\n   */\r\n  collisions: number;\r\n\r\n  /**\r\n   * Copy of the current frame contacts (only updated if debug is toggled on)\r\n   */\r\n  contacts: Map<string, CollisionContact>;\r\n\r\n  /**\r\n   * Gets the number of fast moving bodies using raycast continuous collisions in the scene\r\n   */\r\n  fastBodies: number;\r\n\r\n  /**\r\n   * Gets the number of bodies that had a fast body collision resolution\r\n   */\r\n  fastBodyCollisions: number;\r\n\r\n  /**\r\n   * Gets the time it took to calculate the broadphase pairs\r\n   */\r\n  broadphase: number;\r\n\r\n  /**\r\n   * Gets the time it took to calculate the narrowphase\r\n   */\r\n  narrowphase: number;\r\n}\r\n\r\nexport interface GraphicsStatistics {\r\n  drawCalls: number;\r\n  drawnImages: number;\r\n}\r\n\r\n/**\r\n * Debug statistics and flags for Excalibur. If polling these values, it would be\r\n * best to do so on the `postupdate` event for [[Engine]], after all values have been\r\n * updated during a frame.\r\n */\r\nexport class Debug implements DebugFlags {\r\n  private _engine: Engine;\r\n\r\n  constructor(engine: Engine) {\r\n    this._engine = engine;\r\n\r\n    this.colorBlindMode = new ColorBlindFlags(this._engine);\r\n  }\r\n\r\n  /**\r\n   * Switch the current excalibur clock with the [[TestClock]] and return\r\n   * it in the same running state.\r\n   *\r\n   * This is useful when you need to debug frame by frame.\r\n   */\r\n  public useTestClock(): TestClock {\r\n    const clock = this._engine.clock;\r\n    const wasRunning = clock.isRunning();\r\n    clock.stop();\r\n\r\n    const testClock = clock.toTestClock();\r\n    if (wasRunning) {\r\n      testClock.start();\r\n    }\r\n    this._engine.clock = testClock;\r\n    return testClock;\r\n  }\r\n\r\n  /**\r\n   * Switch the current excalibur clock with the [[StandardClock]] and\r\n   * return it in the same running state.\r\n   *\r\n   * This is useful when you need to switch back to normal mode after\r\n   * debugging.\r\n   */\r\n  public useStandardClock(): StandardClock {\r\n    const currentClock = this._engine.clock;\r\n    const wasRunning = currentClock.isRunning();\r\n    currentClock.stop();\r\n\r\n    const standardClock = currentClock.toStandardClock();\r\n    if (wasRunning) {\r\n      standardClock.start();\r\n    }\r\n    this._engine.clock = standardClock;\r\n    return standardClock;\r\n  }\r\n\r\n  /**\r\n   * Performance statistics\r\n   */\r\n  public stats: DebugStats = {\r\n    /**\r\n     * Current frame statistics. Engine reuses this instance, use [[FrameStats.clone]] to copy frame stats.\r\n     * Best accessed on [[postframe]] event. See [[FrameStats]]\r\n     */\r\n    currFrame: new FrameStats(),\r\n\r\n    /**\r\n     * Previous frame statistics. Engine reuses this instance, use [[FrameStats.clone]] to copy frame stats.\r\n     * Best accessed on [[preframe]] event. Best inspected on engine event `preframe`. See [[FrameStats]]\r\n     */\r\n    prevFrame: new FrameStats()\r\n  };\r\n\r\n  /**\r\n   * Correct or simulate color blindness using [[ColorBlindnessPostProcessor]].\r\n   * @warning Will reduce FPS.\r\n   */\r\n  public colorBlindMode: ColorBlindFlags;\r\n\r\n  /**\r\n   * Filter debug context to named entities or entity ids\r\n   */\r\n  public filter: { useFilter: boolean; nameQuery: string; ids: number[] } = {\r\n    /**\r\n     * Toggle filter on or off (default off) must be on for DebugDraw to use filters\r\n     */\r\n    useFilter: false,\r\n    /**\r\n     * Query for entities by name, if the entity name contains `nameQuery` it will be included\r\n     */\r\n    nameQuery: '',\r\n    /**\r\n     * Query for Entity ids, if the id matches it will be included\r\n     */\r\n    ids: []\r\n  };\r\n\r\n  /**\r\n   * Entity debug settings\r\n   */\r\n  public entity = {\r\n    showAll: false,\r\n    showId: true,\r\n    showName: false\r\n  };\r\n\r\n  /**\r\n   * Transform component debug settings\r\n   */\r\n  public transform = {\r\n    showAll: false,\r\n\r\n    showPosition: false,\r\n    showPositionLabel: false,\r\n    positionColor: Color.Yellow,\r\n\r\n    showZIndex: false,\r\n\r\n    showScale: false,\r\n    scaleColor: Color.Green,\r\n\r\n    showRotation: false,\r\n    rotationColor: Color.Blue\r\n  };\r\n\r\n  /**\r\n   * Graphics component debug settings\r\n   */\r\n  public graphics = {\r\n    showAll: false,\r\n\r\n    showBounds: true,\r\n    boundsColor: Color.Yellow\r\n  };\r\n\r\n  /**\r\n   * Collider component debug settings\r\n   */\r\n  public collider = {\r\n    showAll: false,\r\n\r\n    showBounds: true,\r\n    boundsColor: Color.Blue,\r\n\r\n    showOwner: false,\r\n\r\n    showGeometry: true,\r\n    geometryColor: Color.Green\r\n  };\r\n\r\n  /**\r\n   * Physics simulation debug settings\r\n   */\r\n  public physics = {\r\n    showAll: false,\r\n\r\n    showBroadphaseSpacePartitionDebug: false,\r\n\r\n    showCollisionNormals: false,\r\n    collisionNormalColor: Color.Cyan,\r\n\r\n    showCollisionContacts: true,\r\n    collisionContactColor: Color.Red\r\n  };\r\n\r\n  /**\r\n   * Motion component debug settings\r\n   */\r\n  public motion = {\r\n    showAll: false,\r\n\r\n    showVelocity: false,\r\n    velocityColor: Color.Yellow,\r\n\r\n    showAcceleration: false,\r\n    accelerationColor: Color.Red\r\n  };\r\n\r\n  /**\r\n   * Body component debug settings\r\n   */\r\n  public body = {\r\n    showAll: false,\r\n\r\n    showCollisionGroup: false,\r\n    showCollisionType: false,\r\n    showSleeping: false,\r\n    showMotion: false,\r\n    showMass: false\r\n  };\r\n\r\n  /**\r\n   * Camera debug settings\r\n   */\r\n  public camera = {\r\n    showAll: false,\r\n\r\n    showFocus: false,\r\n    focusColor: Color.Red,\r\n\r\n    showZoom: false\r\n  };\r\n}\r\n\r\n/**\r\n * Implementation of a frame's stats. Meant to have values copied via [[FrameStats.reset]], avoid\r\n * creating instances of this every frame.\r\n */\r\nexport class FrameStats implements FrameStatistics {\r\n  private _id: number = 0;\r\n  private _delta: number = 0;\r\n  private _fps: number = 0;\r\n  private _actorStats: FrameActorStats = {\r\n    alive: 0,\r\n    killed: 0,\r\n    ui: 0,\r\n    get remaining() {\r\n      return this.alive - this.killed;\r\n    },\r\n    get total() {\r\n      return this.remaining + this.ui;\r\n    }\r\n  };\r\n  private _durationStats: FrameDurationStats = {\r\n    update: 0,\r\n    draw: 0,\r\n    get total() {\r\n      return this.update + this.draw;\r\n    }\r\n  };\r\n\r\n  private _physicsStats: PhysicsStats = new PhysicsStats();\r\n\r\n  private _graphicsStats: GraphicsStatistics = {\r\n    drawCalls: 0,\r\n    drawnImages: 0\r\n  };\r\n\r\n  /**\r\n   * Zero out values or clone other IFrameStat stats. Allows instance reuse.\r\n   *\r\n   * @param [otherStats] Optional stats to clone\r\n   */\r\n  public reset(otherStats?: FrameStatistics) {\r\n    if (otherStats) {\r\n      this.id = otherStats.id;\r\n      this.delta = otherStats.delta;\r\n      this.fps = otherStats.fps;\r\n      this.actors.alive = otherStats.actors.alive;\r\n      this.actors.killed = otherStats.actors.killed;\r\n      this.actors.ui = otherStats.actors.ui;\r\n      this.duration.update = otherStats.duration.update;\r\n      this.duration.draw = otherStats.duration.draw;\r\n      this._physicsStats.reset(otherStats.physics);\r\n      this.graphics.drawCalls = otherStats.graphics.drawCalls;\r\n      this.graphics.drawnImages = otherStats.graphics.drawnImages;\r\n    } else {\r\n      this.id = this.delta = this.fps = 0;\r\n      this.actors.alive = this.actors.killed = this.actors.ui = 0;\r\n      this.duration.update = this.duration.draw = 0;\r\n      this._physicsStats.reset();\r\n      this.graphics.drawnImages = this.graphics.drawCalls = 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Provides a clone of this instance.\r\n   */\r\n  public clone(): FrameStats {\r\n    const fs = new FrameStats();\r\n\r\n    fs.reset(this);\r\n\r\n    return fs;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's id\r\n   */\r\n  public get id() {\r\n    return this._id;\r\n  }\r\n\r\n  /**\r\n   * Sets the frame's id\r\n   */\r\n  public set id(value: number) {\r\n    this._id = value;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's delta (time since last frame)\r\n   */\r\n  public get delta() {\r\n    return this._delta;\r\n  }\r\n\r\n  /**\r\n   * Sets the frame's delta (time since last frame). Internal use only.\r\n   * @internal\r\n   */\r\n  public set delta(value: number) {\r\n    this._delta = value;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's frames-per-second (FPS)\r\n   */\r\n  public get fps() {\r\n    return this._fps;\r\n  }\r\n\r\n  /**\r\n   * Sets the frame's frames-per-second (FPS). Internal use only.\r\n   * @internal\r\n   */\r\n  public set fps(value: number) {\r\n    this._fps = value;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's actor statistics\r\n   */\r\n  public get actors() {\r\n    return this._actorStats;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's duration statistics\r\n   */\r\n  public get duration() {\r\n    return this._durationStats;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's physics statistics\r\n   */\r\n  public get physics() {\r\n    return this._physicsStats;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's graphics statistics\r\n   */\r\n  public get graphics() {\r\n    return this._graphicsStats;\r\n  }\r\n}\r\n\r\nexport class PhysicsStats implements PhysicsStatistics {\r\n  private _pairs: number = 0;\r\n  private _collisions: number = 0;\r\n  private _contacts: Map<string, CollisionContact> = new Map();\r\n  private _fastBodies: number = 0;\r\n  private _fastBodyCollisions: number = 0;\r\n  private _broadphase: number = 0;\r\n  private _narrowphase: number = 0;\r\n\r\n  /**\r\n   * Zero out values or clone other IPhysicsStats stats. Allows instance reuse.\r\n   *\r\n   * @param [otherStats] Optional stats to clone\r\n   */\r\n  public reset(otherStats?: PhysicsStatistics) {\r\n    if (otherStats) {\r\n      this.pairs = otherStats.pairs;\r\n      this.collisions = otherStats.collisions;\r\n      this.contacts = otherStats.contacts;\r\n      this.fastBodies = otherStats.fastBodies;\r\n      this.fastBodyCollisions = otherStats.fastBodyCollisions;\r\n      this.broadphase = otherStats.broadphase;\r\n      this.narrowphase = otherStats.narrowphase;\r\n    } else {\r\n      this.pairs = this.collisions = this.fastBodies = 0;\r\n      this.fastBodyCollisions = this.broadphase = this.narrowphase = 0;\r\n      this.contacts.clear();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Provides a clone of this instance.\r\n   */\r\n  public clone(): PhysicsStatistics {\r\n    const ps = new PhysicsStats();\r\n\r\n    ps.reset(this);\r\n\r\n    return ps;\r\n  }\r\n\r\n  public get pairs(): number {\r\n    return this._pairs;\r\n  }\r\n\r\n  public set pairs(value: number) {\r\n    this._pairs = value;\r\n  }\r\n\r\n  public get collisions(): number {\r\n    return this._collisions;\r\n  }\r\n\r\n  public set collisions(value: number) {\r\n    this._collisions = value;\r\n  }\r\n\r\n  public get contacts(): Map<string, CollisionContact> {\r\n    return this._contacts;\r\n  }\r\n\r\n  public set contacts(contacts: Map<string, CollisionContact>) {\r\n    this._contacts = contacts;\r\n  }\r\n\r\n  public get fastBodies(): number {\r\n    return this._fastBodies;\r\n  }\r\n\r\n  public set fastBodies(value: number) {\r\n    this._fastBodies = value;\r\n  }\r\n\r\n  public get fastBodyCollisions(): number {\r\n    return this._fastBodyCollisions;\r\n  }\r\n\r\n  public set fastBodyCollisions(value: number) {\r\n    this._fastBodyCollisions = value;\r\n  }\r\n\r\n  public get broadphase(): number {\r\n    return this._broadphase;\r\n  }\r\n\r\n  public set broadphase(value: number) {\r\n    this._broadphase = value;\r\n  }\r\n\r\n  public get narrowphase(): number {\r\n    return this._narrowphase;\r\n  }\r\n\r\n  public set narrowphase(value: number) {\r\n    this._narrowphase = value;\r\n  }\r\n}\r\n","/**\r\n * Determines the scope of handling mouse/touch events.\r\n */\r\n\r\nexport enum PointerScope {\r\n  /**\r\n   * Handle events on the `canvas` element only. Events originating outside the\r\n   * `canvas` will not be handled.\r\n   */\r\n  Canvas = 'Canvas',\r\n\r\n  /**\r\n   * Handles events on the entire document. All events will be handled by Excalibur.\r\n   */\r\n  Document = 'Document'\r\n}\r\n","import { Logger } from '../Util/Log';\r\nimport { Class } from '../Class';\r\nimport * as Events from '../Events';\r\n\r\n/**\r\n * Enum representing physical input key codes\r\n */\r\nexport enum Keys {\r\n  // NUMPAD\r\n  Num0 = 'Numpad0',\r\n  Num1 = 'Numpad1',\r\n  Num2 = 'Numpad2',\r\n  Num3 = 'Numpad3',\r\n  Num4 = 'Numpad4',\r\n  Num5 = 'Numpad5',\r\n  Num6 = 'Numpad6',\r\n  Num7 = 'Numpad7',\r\n  Num8 = 'Numpad8',\r\n  Num9 = 'Numpad9',\r\n  NumAdd = 'NumpadAdd',\r\n  NumSubtract = 'NumpadSubtract',\r\n  NumMultiply = 'NumpadMultiply',\r\n  NumDivide = 'NumpadDivide',\r\n  // NumComma = 'NumpadComma', // not x-browser\r\n  NumDecimal = 'NumpadDecimal',\r\n  Numpad0 = 'Numpad0',\r\n  Numpad1 = 'Numpad1',\r\n  Numpad2 = 'Numpad2',\r\n  Numpad3 = 'Numpad3',\r\n  Numpad4 = 'Numpad4',\r\n  Numpad5 = 'Numpad5',\r\n  Numpad6 = 'Numpad6',\r\n  Numpad7 = 'Numpad7',\r\n  Numpad8 = 'Numpad8',\r\n  Numpad9 = 'Numpad9',\r\n  NumpadAdd = 'NumpadAdd',\r\n  NumpadSubtract = 'NumpadSubtract',\r\n  NumpadMultiply = 'NumpadMultiply',\r\n  NumpadDivide = 'NumpadDivide',\r\n  // NumpadComma = 'NumpadComma', // not x-browser\r\n  NumpadDecimal = 'NumpadDecimal',\r\n\r\n  // MODIFIERS\r\n  NumLock = 'NumLock',\r\n  ShiftLeft = 'ShiftLeft',\r\n  ShiftRight = 'ShiftRight',\r\n  AltLeft = 'AltLeft',\r\n  AltRight = 'AltRight',\r\n  ControlLeft = 'ControlLeft',\r\n  ControlRight = 'ControlRight',\r\n  MetaLeft = 'MetaLeft',\r\n  MetaRight = 'MetaRight',\r\n\r\n  // NUMBERS\r\n  Key0 = 'Digit0',\r\n  Key1 = 'Digit1',\r\n  Key2 = 'Digit2',\r\n  Key3 = 'Digit3',\r\n  Key4 = 'Digit4',\r\n  Key5 = 'Digit5',\r\n  Key6 = 'Digit6',\r\n  Key7 = 'Digit7',\r\n  Key8 = 'Digit8',\r\n  Key9 = 'Digit9',\r\n  Digit0 = 'Digit0',\r\n  Digit1 = 'Digit1',\r\n  Digit2 = 'Digit2',\r\n  Digit3 = 'Digit3',\r\n  Digit4 = 'Digit4',\r\n  Digit5 = 'Digit5',\r\n  Digit6 = 'Digit6',\r\n  Digit7 = 'Digit7',\r\n  Digit8 = 'Digit8',\r\n  Digit9 = 'Digit9',\r\n\r\n  // FUNCTION KEYS\r\n  F1 = 'F1',\r\n  F2 = 'F2',\r\n  F3 = 'F3',\r\n  F4 = 'F4',\r\n  F5 = 'F5',\r\n  F6 = 'F6',\r\n  F7 = 'F7',\r\n  F8 = 'F8',\r\n  F9 = 'F9',\r\n  F10 = 'F10',\r\n  F11 = 'F11',\r\n  F12 = 'F12',\r\n\r\n  // LETTERS\r\n  A = 'KeyA',\r\n  B = 'KeyB',\r\n  C = 'KeyC',\r\n  D = 'KeyD',\r\n  E = 'KeyE',\r\n  F = 'KeyF',\r\n  G = 'KeyG',\r\n  H = 'KeyH',\r\n  I = 'KeyI',\r\n  J = 'KeyJ',\r\n  K = 'KeyK',\r\n  L = 'KeyL',\r\n  M = 'KeyM',\r\n  N = 'KeyN',\r\n  O = 'KeyO',\r\n  P = 'KeyP',\r\n  Q = 'KeyQ',\r\n  R = 'KeyR',\r\n  S = 'KeyS',\r\n  T = 'KeyT',\r\n  U = 'KeyU',\r\n  V = 'KeyV',\r\n  W = 'KeyW',\r\n  X = 'KeyX',\r\n  Y = 'KeyY',\r\n  Z = 'KeyZ',\r\n  KeyA = 'KeyA',\r\n  KeyB = 'KeyB',\r\n  KeyC = 'KeyC',\r\n  KeyD = 'KeyD',\r\n  KeyE = 'KeyE',\r\n  KeyF = 'KeyF',\r\n  KeyG = 'KeyG',\r\n  KeyH = 'KeyH',\r\n  KeyI = 'KeyI',\r\n  KeyJ = 'KeyJ',\r\n  KeyK = 'KeyK',\r\n  KeyL = 'KeyL',\r\n  KeyM = 'KeyM',\r\n  KeyN = 'KeyN',\r\n  KeyO = 'KeyO',\r\n  KeyP = 'KeyP',\r\n  KeyQ = 'KeyQ',\r\n  KeyR = 'KeyR',\r\n  KeyS = 'KeyS',\r\n  KeyT = 'KeyT',\r\n  KeyU = 'KeyU',\r\n  KeyV = 'KeyV',\r\n  KeyW = 'KeyW',\r\n  KeyX = 'KeyX',\r\n  KeyY = 'KeyY',\r\n  KeyZ = 'KeyZ',\r\n\r\n  // SYMBOLS\r\n  Semicolon = 'Semicolon',\r\n  Quote = 'Quote',\r\n  Comma = 'Comma',\r\n  Minus = 'Minus',\r\n  Period = 'Period',\r\n  Slash = 'Slash',\r\n  Equal = 'Equal',\r\n  BracketLeft = 'BracketLeft',\r\n  Backslash = 'Backslash',\r\n  BracketRight = 'BracketRight',\r\n  Backquote = 'Backquote',\r\n\r\n  // DIRECTIONS\r\n  Up = 'ArrowUp',\r\n  Down = 'ArrowDown',\r\n  Left = 'ArrowLeft',\r\n  Right = 'ArrowRight',\r\n  ArrowUp = 'ArrowUp',\r\n  ArrowDown = 'ArrowDown',\r\n  ArrowLeft = 'ArrowLeft',\r\n  ArrowRight = 'ArrowRight',\r\n\r\n  // OTHER\r\n  Space = 'Space',\r\n  Backspace = 'Backspace',\r\n  Delete = 'Delete',\r\n  Esc = 'Escape',\r\n  Escape = 'Escape',\r\n  Enter = 'Enter',\r\n  NumpadEnter = 'NumpadEnter',\r\n  ContextMenu = 'ContextMenu'\r\n}\r\n\r\n/**\r\n * Event thrown on a game object for a key event\r\n */\r\nexport class KeyEvent extends Events.GameEvent<any> {\r\n  /**\r\n   * @param key  The key responsible for throwing the event\r\n   * @param value The key's typed value the browser detected\r\n   * @param originalEvent The original keyboard event that Excalibur handled\r\n   */\r\n  constructor(public key: Keys, public value?: string, public originalEvent?: KeyboardEvent) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * Provides keyboard support for Excalibur.\r\n */\r\nexport class Keyboard extends Class {\r\n  private _keys: Keys[] = [];\r\n  private _keysUp: Keys[] = [];\r\n  private _keysDown: Keys[] = [];\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n\r\n  public on(eventName: Events.press, handler: (event: KeyEvent) => void): void;\r\n  public on(eventName: Events.release, handler: (event: KeyEvent) => void): void;\r\n  public on(eventName: Events.hold, handler: (event: KeyEvent) => void): void;\r\n  public on(eventName: string, handler: (event: Events.GameEvent<any>) => void): void;\r\n  public on(eventName: string, handler: (event: any) => void): void {\r\n    super.on(eventName, handler);\r\n  }\r\n\r\n  /**\r\n   * Initialize Keyboard event listeners\r\n   */\r\n  init(global?: GlobalEventHandlers): void {\r\n    if (!global) {\r\n      try {\r\n        // Try and listen to events on top window frame if within an iframe.\r\n        //\r\n        // See https://github.com/excaliburjs/Excalibur/issues/1294\r\n        //\r\n        // Attempt to add an event listener, which triggers a DOMException on\r\n        // cross-origin iframes\r\n        const noop = () => {\r\n          return;\r\n        };\r\n        window.top.addEventListener('blur', noop);\r\n        window.top.removeEventListener('blur', noop);\r\n\r\n        // this will be the same as window if not embedded within an iframe\r\n        global = window.top;\r\n      } catch {\r\n        // fallback to current frame\r\n        global = window;\r\n\r\n        Logger.getInstance().warn(\r\n          'Failed to bind to keyboard events to top frame. ' +\r\n            'If you are trying to embed Excalibur in a cross-origin iframe, keyboard events will not fire.'\r\n        );\r\n      }\r\n    }\r\n\r\n    global.addEventListener('blur', () => {\r\n      this._keys.length = 0; // empties array efficiently\r\n    });\r\n\r\n    // key up is on window because canvas cannot have focus\r\n    global.addEventListener('keyup', this._handleKeyUp);\r\n\r\n    // key down is on window because canvas cannot have focus\r\n    global.addEventListener('keydown', this._handleKeyDown);\r\n  }\r\n\r\n  private _handleKeyDown = (ev: KeyboardEvent) => {\r\n    const code = ev.code as Keys;\r\n    if (this._keys.indexOf(code) === -1) {\r\n      this._keys.push(code);\r\n      this._keysDown.push(code);\r\n      const keyEvent = new KeyEvent(code, ev.key, ev);\r\n      this.eventDispatcher.emit('down', keyEvent);\r\n      this.eventDispatcher.emit('press', keyEvent);\r\n    }\r\n  };\r\n\r\n  private _handleKeyUp = (ev: KeyboardEvent) => {\r\n    const code = ev.code as Keys;\r\n    const key = this._keys.indexOf(code);\r\n    this._keys.splice(key, 1);\r\n    this._keysUp.push(code);\r\n    const keyEvent = new KeyEvent(code, ev.key, ev);\r\n\r\n    // alias the old api, we may want to deprecate this in the future\r\n    this.eventDispatcher.emit('up', keyEvent);\r\n    this.eventDispatcher.emit('release', keyEvent);\r\n  };\r\n\r\n  public update() {\r\n    // Reset keysDown and keysUp after update is complete\r\n    this._keysDown.length = 0;\r\n    this._keysUp.length = 0;\r\n\r\n    // Emit synthetic \"hold\" event\r\n    for (let i = 0; i < this._keys.length; i++) {\r\n      this.eventDispatcher.emit('hold', new KeyEvent(this._keys[i]));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets list of keys being pressed down\r\n   */\r\n  public getKeys(): Keys[] {\r\n    return this._keys;\r\n  }\r\n\r\n  /**\r\n   * Tests if a certain key was just pressed this frame. This is cleared at the end of the update frame.\r\n   * @param key Test whether a key was just pressed\r\n   */\r\n  public wasPressed(key: Keys): boolean {\r\n    return this._keysDown.indexOf(key) > -1;\r\n  }\r\n\r\n  /**\r\n   * Tests if a certain key is held down. This is persisted between frames.\r\n   * @param key  Test whether a key is held down\r\n   */\r\n  public isHeld(key: Keys): boolean {\r\n    return this._keys.indexOf(key) > -1;\r\n  }\r\n\r\n  /**\r\n   * Tests if a certain key was just released this frame. This is cleared at the end of the update frame.\r\n   * @param key  Test whether a key was just released\r\n   */\r\n  public wasReleased(key: Keys): boolean {\r\n    return this._keysUp.indexOf(key) > -1;\r\n  }\r\n\r\n  /**\r\n   * Trigger a manual key event\r\n   * @param type\r\n   * @param key\r\n   * @param character\r\n   */\r\n  public triggerEvent(type: 'down' | 'up', key: Keys, character?: string) {\r\n    if (type === 'down') {\r\n      this._handleKeyDown(new KeyboardEvent('keydown', {\r\n        code: key,\r\n        key: character ?? null\r\n      }));\r\n    }\r\n    if (type === 'up') {\r\n      this._handleKeyUp(new KeyboardEvent('keyup', {\r\n        code: key,\r\n        key: character ?? null\r\n      }));\r\n    }\r\n  }\r\n}\r\n","import { Class } from './../Class';\r\nimport { GameEvent, GamepadConnectEvent, GamepadDisconnectEvent, GamepadButtonEvent, GamepadAxisEvent } from '../Events';\r\nimport * as Events from '../Events';\r\n\r\n/**\r\n * Excalibur leverages the HTML5 Gamepad API [where it is supported](http://caniuse.com/#feat=gamepad)\r\n * to provide controller support for your games.\r\n */\r\nexport class Gamepads extends Class {\r\n  /**\r\n   * Whether or not to poll for Gamepad input (default: `false`)\r\n   */\r\n  public enabled = false;\r\n\r\n  /**\r\n   * Whether or not Gamepad API is supported\r\n   */\r\n  public supported = !!(<any>navigator).getGamepads;\r\n\r\n  /**\r\n   * The minimum value an axis has to move before considering it a change\r\n   */\r\n  public static MinAxisMoveThreshold = 0.05;\r\n\r\n  private _gamePadTimeStamps = [0, 0, 0, 0];\r\n  private _oldPads: Gamepad[] = [];\r\n  private _pads: Gamepad[] = [];\r\n  private _initSuccess: boolean = false;\r\n  private _navigator: NavigatorGamepads = <any>navigator;\r\n  private _minimumConfiguration: GamepadConfiguration = null;\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n\r\n  public init() {\r\n    if (!this.supported) {\r\n      return;\r\n    }\r\n    if (this._initSuccess) {\r\n      return;\r\n    }\r\n\r\n    // In Chrome, this will return 4 undefined items until a button is pressed\r\n    // In FF, this will not return any items until a button is pressed\r\n    this._oldPads = this._clonePads(this._navigator.getGamepads());\r\n    if (this._oldPads.length && this._oldPads[0]) {\r\n      this._initSuccess = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Sets the minimum gamepad configuration, for example {axis: 4, buttons: 4} means\r\n   * this game requires at minimum 4 axis inputs and 4 buttons, this is not restrictive\r\n   * all other controllers with more axis or buttons are valid as well. If no minimum\r\n   * configuration is set all pads are valid.\r\n   */\r\n  public setMinimumGamepadConfiguration(config: GamepadConfiguration): void {\r\n    this._enableAndUpdate(); // if config is used, implicitly enable\r\n    this._minimumConfiguration = config;\r\n  }\r\n\r\n  /**\r\n   * When implicitly enabled, set the enabled flag and run an update so information is updated\r\n   */\r\n  private _enableAndUpdate() {\r\n    if (!this.enabled) {\r\n      this.enabled = true;\r\n      this.update();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Checks a navigator gamepad against the minimum configuration if present.\r\n   */\r\n  private _isGamepadValid(pad: NavigatorGamepad): boolean {\r\n    if (!this._minimumConfiguration) {\r\n      return true;\r\n    }\r\n    if (!pad) {\r\n      return false;\r\n    }\r\n    const axesLength = pad.axes.filter((value) => {\r\n      return typeof value !== undefined;\r\n    }).length;\r\n\r\n    const buttonLength = pad.buttons.filter((value) => {\r\n      return typeof value !== undefined;\r\n    }).length;\r\n    return axesLength >= this._minimumConfiguration.axis && buttonLength >= this._minimumConfiguration.buttons && pad.connected;\r\n  }\r\n\r\n  public on(eventName: Events.connect, handler: (event: GamepadConnectEvent) => void): void;\r\n  public on(eventName: Events.disconnect, handler: (event: GamepadDisconnectEvent) => void): void;\r\n  public on(eventName: Events.button, handler: (event: GamepadButtonEvent) => void): void;\r\n  public on(eventName: Events.axis, handler: (event: GamepadAxisEvent) => void): void;\r\n  public on(eventName: string, handler: (event: GameEvent<any>) => void): void;\r\n  public on(eventName: string, handler: (event: any) => void): void {\r\n    this._enableAndUpdate(); // implicitly enable\r\n    super.on(eventName, handler);\r\n  }\r\n\r\n  public off(eventName: string, handler?: (event: GameEvent<any>) => void) {\r\n    this._enableAndUpdate(); // implicitly enable\r\n    super.off(eventName, handler);\r\n  }\r\n\r\n  /**\r\n   * Updates Gamepad state and publishes Gamepad events\r\n   */\r\n  public update() {\r\n    if (!this.enabled || !this.supported) {\r\n      return;\r\n    }\r\n    this.init();\r\n\r\n    const gamepads = this._navigator.getGamepads();\r\n\r\n    for (let i = 0; i < gamepads.length; i++) {\r\n      if (!gamepads[i]) {\r\n        const gamepad = this.at(i);\r\n        // If was connected, but now isn't emit the disconnect event\r\n        if (gamepad.connected) {\r\n          this.eventDispatcher.emit('disconnect', new GamepadDisconnectEvent(i, gamepad));\r\n        }\r\n        // Reset connection status\r\n        gamepad.connected = false;\r\n        continue;\r\n      } else {\r\n        if (!this.at(i).connected && this._isGamepadValid(gamepads[i])) {\r\n          this.eventDispatcher.emit('connect', new GamepadConnectEvent(i, this.at(i)));\r\n        }\r\n        // Set connection status\r\n        this.at(i).connected = true;\r\n      }\r\n\r\n      // Only supported in Chrome\r\n      if (gamepads[i].timestamp && gamepads[i].timestamp === this._gamePadTimeStamps[i]) {\r\n        continue;\r\n      }\r\n\r\n      this._gamePadTimeStamps[i] = gamepads[i].timestamp;\r\n\r\n      // Add reference to navigator gamepad\r\n      this.at(i).navigatorGamepad = gamepads[i];\r\n\r\n      // Buttons\r\n      let b: string, bi: number, a: string, ai: number, value: number;\r\n\r\n      for (b in Buttons) {\r\n        bi = <any>Buttons[b];\r\n        if (typeof bi === 'number') {\r\n          if (gamepads[i].buttons[bi]) {\r\n            value = gamepads[i].buttons[bi].value;\r\n            if (value !== this._oldPads[i].getButton(bi)) {\r\n              if (gamepads[i].buttons[bi].pressed) {\r\n                this.at(i).updateButton(bi, value);\r\n                this.at(i).eventDispatcher.emit('button', new GamepadButtonEvent(bi, value, this.at(i)));\r\n              } else {\r\n                this.at(i).updateButton(bi, 0);\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      // Axes\r\n      for (a in Axes) {\r\n        ai = <any>Axes[a];\r\n        if (typeof ai === 'number') {\r\n          value = gamepads[i].axes[ai];\r\n          if (value !== this._oldPads[i].getAxes(ai)) {\r\n            this.at(i).updateAxes(ai, value);\r\n            this.at(i).eventDispatcher.emit('axis', new GamepadAxisEvent(ai, value, this.at(i)));\r\n          }\r\n        }\r\n      }\r\n\r\n      this._oldPads[i] = this._clonePad(gamepads[i]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Safely retrieves a Gamepad at a specific index and creates one if it doesn't yet exist\r\n   */\r\n  public at(index: number): Gamepad {\r\n    this._enableAndUpdate(); // implicitly enable gamepads when at() is called\r\n    if (index >= this._pads.length) {\r\n      // Ensure there is a pad to retrieve\r\n      for (let i = this._pads.length - 1, max = index; i < max; i++) {\r\n        this._pads.push(new Gamepad());\r\n        this._oldPads.push(new Gamepad());\r\n      }\r\n    }\r\n\r\n    return this._pads[index];\r\n  }\r\n\r\n  /**\r\n   * Returns a list of all valid gamepads that meet the minimum configuration requirement.\r\n   */\r\n  public getValidGamepads(): Gamepad[] {\r\n    this._enableAndUpdate();\r\n    const result: Gamepad[] = [];\r\n    for (let i = 0; i < this._pads.length; i++) {\r\n      if (this._isGamepadValid(this.at(i).navigatorGamepad) && this.at(i).connected) {\r\n        result.push(this.at(i));\r\n      }\r\n    }\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Gets the number of connected gamepads\r\n   */\r\n  public count() {\r\n    return this._pads.filter((p) => p.connected).length;\r\n  }\r\n\r\n  private _clonePads(pads: NavigatorGamepad[]): Gamepad[] {\r\n    const arr = [];\r\n    for (let i = 0, len = pads.length; i < len; i++) {\r\n      arr.push(this._clonePad(pads[i]));\r\n    }\r\n    return arr;\r\n  }\r\n\r\n  /**\r\n   * Fastest way to clone a known object is to do it yourself\r\n   */\r\n  private _clonePad(pad: NavigatorGamepad): Gamepad {\r\n    let i, len;\r\n    const clonedPad = new Gamepad();\r\n\r\n    if (!pad) {\r\n      return clonedPad;\r\n    }\r\n\r\n    for (i = 0, len = pad.buttons.length; i < len; i++) {\r\n      if (pad.buttons[i]) {\r\n        clonedPad.updateButton(i, pad.buttons[i].value);\r\n      }\r\n    }\r\n    for (i = 0, len = pad.axes.length; i < len; i++) {\r\n      clonedPad.updateAxes(i, pad.axes[i]);\r\n    }\r\n\r\n    return clonedPad;\r\n  }\r\n}\r\n\r\n/**\r\n * Gamepad holds state information for a connected controller. See [[Gamepads]]\r\n * for more information on handling controller input.\r\n */\r\nexport class Gamepad extends Class {\r\n  public connected = false;\r\n  public navigatorGamepad: NavigatorGamepad;\r\n  private _buttons: number[] = new Array(16);\r\n  private _axes: number[] = new Array(4);\r\n\r\n  constructor() {\r\n    super();\r\n\r\n    for (let i = 0; i < this._buttons.length; i++) {\r\n      this._buttons[i] = 0;\r\n    }\r\n    for (let i = 0; i < this._axes.length; i++) {\r\n      this._axes[i] = 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Whether or not the given button is pressed\r\n   * @param button     The button to query\r\n   * @param threshold  The threshold over which the button is considered to be pressed\r\n   */\r\n  public isButtonPressed(button: Buttons, threshold: number = 1) {\r\n    return this._buttons[button] >= threshold;\r\n  }\r\n\r\n  /**\r\n   * Gets the given button value between 0 and 1\r\n   */\r\n  public getButton(button: Buttons) {\r\n    return this._buttons[button];\r\n  }\r\n\r\n  /**\r\n   * Gets the given axis value between -1 and 1. Values below\r\n   * [[MinAxisMoveThreshold]] are considered 0.\r\n   */\r\n  public getAxes(axes: Axes) {\r\n    const value = this._axes[axes];\r\n\r\n    if (Math.abs(value) < Gamepads.MinAxisMoveThreshold) {\r\n      return 0;\r\n    } else {\r\n      return value;\r\n    }\r\n  }\r\n\r\n  public updateButton(buttonIndex: number, value: number) {\r\n    this._buttons[buttonIndex] = value;\r\n  }\r\n\r\n  public updateAxes(axesIndex: number, value: number) {\r\n    this._axes[axesIndex] = value;\r\n  }\r\n}\r\n\r\n/**\r\n * Gamepad Buttons enumeration\r\n */\r\nexport enum Buttons {\r\n  /**\r\n   * Face 1 button (e.g. A)\r\n   */\r\n  Face1 = 0,\r\n  /**\r\n   * Face 2 button (e.g. B)\r\n   */\r\n  Face2 = 1,\r\n  /**\r\n   * Face 3 button (e.g. X)\r\n   */\r\n  Face3 = 2,\r\n  /**\r\n   * Face 4 button (e.g. Y)\r\n   */\r\n  Face4 = 3,\r\n  /**\r\n   * Left bumper button\r\n   */\r\n  LeftBumper = 4,\r\n  /**\r\n   * Right bumper button\r\n   */\r\n  RightBumper = 5,\r\n  /**\r\n   * Left trigger button\r\n   */\r\n  LeftTrigger = 6,\r\n  /**\r\n   * Right trigger button\r\n   */\r\n  RightTrigger = 7,\r\n  /**\r\n   * Select button\r\n   */\r\n  Select = 8,\r\n  /**\r\n   * Start button\r\n   */\r\n  Start = 9,\r\n  /**\r\n   * Left analog stick press (e.g. L3)\r\n   */\r\n  LeftStick = 10,\r\n  /**\r\n   * Right analog stick press (e.g. R3)\r\n   */\r\n  RightStick = 11,\r\n  /**\r\n   * D-pad up\r\n   */\r\n  DpadUp = 12,\r\n  /**\r\n   * D-pad down\r\n   */\r\n  DpadDown = 13,\r\n  /**\r\n   * D-pad left\r\n   */\r\n  DpadLeft = 14,\r\n  /**\r\n   * D-pad right\r\n   */\r\n  DpadRight = 15\r\n}\r\n\r\n/**\r\n * Gamepad Axes enumeration\r\n */\r\nexport enum Axes {\r\n  /**\r\n   * Left analogue stick X direction\r\n   */\r\n  LeftStickX = 0,\r\n  /**\r\n   * Left analogue stick Y direction\r\n   */\r\n  LeftStickY = 1,\r\n  /**\r\n   * Right analogue stick X direction\r\n   */\r\n  RightStickX = 2,\r\n  /**\r\n   * Right analogue stick Y direction\r\n   */\r\n  RightStickY = 3\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport interface NavigatorGamepads {\r\n  getGamepads(): NavigatorGamepad[];\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport interface NavigatorGamepad {\r\n  axes: number[];\r\n  buttons: NavigatorGamepadButton[];\r\n  connected: boolean;\r\n  id: string;\r\n  index: number;\r\n  mapping: string;\r\n  timestamp: number;\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport interface NavigatorGamepadButton {\r\n  pressed: boolean;\r\n  value: number;\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport interface NavigatorGamepadEvent {\r\n  gamepad: NavigatorGamepad;\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport interface GamepadConfiguration {\r\n  axis: number;\r\n  buttons: number;\r\n}\r\n","\r\nexport enum WheelDeltaMode {\r\n  Pixel = 'Pixel',\r\n  Line = 'Line',\r\n  Page = 'Page'\r\n}\r\n","/**\r\n * Native browser button enumeration\r\n */\r\nexport enum NativePointerButton {\r\n  NoButton = -1,\r\n  Left = 0,\r\n  Middle = 1,\r\n  Right = 2,\r\n  Unknown = 3\r\n}\r\n","/**\r\n * The mouse button being pressed.\r\n */\r\nexport enum PointerButton {\r\n  Left = 'Left',\r\n  Middle = 'Middle',\r\n  Right = 'Right',\r\n  Unknown = 'Unknown',\r\n  NoButton = 'NoButton'\r\n}\r\n","/**\r\n * The type of pointer for a [[PointerEvent]].\r\n */\r\nexport enum PointerType {\r\n  Touch = 'Touch',\r\n  Mouse = 'Mouse',\r\n  Pen = 'Pen',\r\n  Unknown = 'Unknown'\r\n}\r\n","export interface NativeEventable {\r\n  addEventListener(name: string, handler: (...any: any[]) => any): any;\r\n  removeEventListener(name: string, handler: (...any: any[]) => any): any;\r\n}\r\n\r\nexport class BrowserComponent<T extends NativeEventable> {\r\n  private _paused = false;\r\n  private _nativeHandlers: { [key: string]: (handler: any) => void } = {};\r\n\r\n  on(eventName: string, handler: (evt: any) => void): void {\r\n    if (this._nativeHandlers[eventName]) {\r\n      this.off(eventName, this._nativeHandlers[eventName]);\r\n    }\r\n    this._nativeHandlers[eventName] = this._decorate(handler);\r\n    this.nativeComponent.addEventListener(eventName, this._nativeHandlers[eventName]);\r\n  }\r\n  off(eventName: string, handler?: (event: any) => void): void {\r\n    if (!handler) {\r\n      handler = this._nativeHandlers[eventName];\r\n    }\r\n    this.nativeComponent.removeEventListener(eventName, handler);\r\n    this._nativeHandlers[eventName] = null;\r\n  }\r\n\r\n  private _decorate(handler: (evt: any) => void): (evt: any) => void {\r\n    return (evt: any) => {\r\n      if (!this._paused) {\r\n        handler(evt);\r\n      }\r\n    };\r\n  }\r\n\r\n  public pause() {\r\n    this._paused = true;\r\n  }\r\n\r\n  public resume() {\r\n    this._paused = false;\r\n  }\r\n\r\n  public clear() {\r\n    for (const event in this._nativeHandlers) {\r\n      this.off(event);\r\n    }\r\n  }\r\n\r\n  constructor(public nativeComponent: T) {}\r\n}\r\n\r\nexport class BrowserEvents {\r\n  private _windowComponent: BrowserComponent<Window>;\r\n  private _documentComponent: BrowserComponent<Document>;\r\n  constructor(private _windowGlobal: Window, private _documentGlobal: Document) {\r\n    this._windowComponent = new BrowserComponent(this._windowGlobal);\r\n    this._documentComponent = new BrowserComponent(this._documentGlobal);\r\n  }\r\n\r\n  public get window(): BrowserComponent<Window> {\r\n    return this._windowComponent;\r\n  }\r\n\r\n  public get document(): BrowserComponent<Document> {\r\n    return this._documentComponent;\r\n  }\r\n\r\n  public pause() {\r\n    this.window.pause();\r\n    this.document.pause();\r\n  }\r\n\r\n  public resume() {\r\n    this.window.resume();\r\n    this.document.resume();\r\n  }\r\n\r\n  public clear() {\r\n    this.window.clear();\r\n    this.document.clear();\r\n  }\r\n}\r\n","import { Engine } from '../Engine';\r\nimport { Vector } from './vector';\r\n\r\nexport class GlobalCoordinates {\r\n  public static fromPagePosition(x: number, y: number, engine: Engine): GlobalCoordinates;\r\n  public static fromPagePosition(pos: Vector, engine: Engine): GlobalCoordinates;\r\n  public static fromPagePosition(xOrPos: number | Vector, yOrEngine: number | Engine, engineOrUndefined?: Engine): GlobalCoordinates {\r\n    let pageX: number;\r\n    let pageY: number;\r\n    let pagePos: Vector;\r\n    let engine: Engine;\r\n\r\n    if (arguments.length === 3) {\r\n      pageX = <number>xOrPos;\r\n      pageY = <number>yOrEngine;\r\n      pagePos = new Vector(pageX, pageY);\r\n      engine = engineOrUndefined;\r\n    } else {\r\n      pagePos = <Vector>xOrPos;\r\n      pageX = pagePos.x;\r\n      pageY = pagePos.y;\r\n      engine = <Engine>yOrEngine;\r\n    }\r\n\r\n    const screenPos = engine.screen.pageToScreenCoordinates(pagePos);\r\n    const worldPos = engine.screen.screenToWorldCoordinates(screenPos);\r\n\r\n    return new GlobalCoordinates(worldPos, pagePos, screenPos);\r\n  }\r\n\r\n  constructor(public worldPos: Vector, public pagePos: Vector, public screenPos: Vector) {}\r\n}\r\n","import { GlobalCoordinates } from '../Math/global-coordinates';\r\nimport { Vector } from '../Math/vector';\r\nimport { PointerButton } from './PointerButton';\r\nimport { PointerType } from './PointerType';\r\n\r\nexport class PointerEvent {\r\n  public active = true;\r\n  public cancel() {\r\n    this.active = false;\r\n  }\r\n\r\n  get pagePos(): Vector {\r\n    return this.coordinates.pagePos;\r\n  }\r\n\r\n  get screenPos(): Vector {\r\n    return this.coordinates.screenPos;\r\n  }\r\n\r\n  get worldPos(): Vector {\r\n    return this.coordinates.worldPos;\r\n  }\r\n\r\n  constructor(\r\n    public type: 'down' | 'up' | 'move' | 'cancel',\r\n    public pointerId: number,\r\n    public button: PointerButton,\r\n    public pointerType: PointerType,\r\n    public coordinates: GlobalCoordinates,\r\n    public nativeEvent: Event) { };\r\n}\r\n","import { WheelDeltaMode } from './WheelDeltaMode';\r\n\r\n\r\nexport class WheelEvent {\r\n  public active = true;\r\n  public cancel() {\r\n    this.active = false;\r\n  }\r\n  constructor(\r\n    public x: number,\r\n    public y: number,\r\n    public pageX: number,\r\n    public pageY: number,\r\n    public screenX: number,\r\n    public screenY: number,\r\n    public index: number,\r\n    public deltaX: number,\r\n    public deltaY: number,\r\n    public deltaZ: number,\r\n    public deltaMode: WheelDeltaMode,\r\n    public ev: Event\r\n  ) { }\r\n}\r\n","import { Class } from '../Class';\r\nimport { Vector } from '../Math/vector';\r\nimport { WheelEvent } from './WheelEvent';\r\nimport { PointerEvent } from './PointerEvent';\r\n\r\nexport class PointerAbstraction extends Class {\r\n\r\n  /**\r\n   * The last position on the document this pointer was at. Can be `null` if pointer was never active.\r\n   */\r\n  public lastPagePos: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * The last position on the screen this pointer was at. Can be `null` if pointer was never active.\r\n   */\r\n  public lastScreenPos: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * The last position in the game world coordinates this pointer was at. Can be `null` if pointer was never active.\r\n   */\r\n  public lastWorldPos: Vector = Vector.Zero;\r\n\r\n  constructor() {\r\n    super();\r\n    this.on('move', this._onPointerMove);\r\n    this.on('down', this._onPointerDown);\r\n  }\r\n\r\n  on(event: 'move', handler: (event: PointerEvent) => void): void;\r\n  on(event: 'down', handler: (event: PointerEvent) => void): void;\r\n  on(event: 'up', handler: (event: PointerEvent) => void): void;\r\n  on(event: 'wheel', handler: (event: WheelEvent) => void): void;\r\n  on(event: string, handler: (event: any) => void): void {\r\n    super.on(event, handler);\r\n  }\r\n\r\n  once(event: 'move', handler: (event: PointerEvent) => void): void;\r\n  once(event: 'down', handler: (event: PointerEvent) => void): void;\r\n  once(event: 'up', handler: (event: PointerEvent) => void): void;\r\n  once(event: 'wheel', handler: (event: WheelEvent) => void): void;\r\n  once(event: string, handler: (event: any) => void): void {\r\n    super.once(event, handler);\r\n  }\r\n\r\n  off(event: 'move', handler?: (event: PointerEvent) => void): void;\r\n  off(event: 'down', handler?: (event: PointerEvent) => void): void;\r\n  off(event: 'up', handler?: (event: PointerEvent) => void): void;\r\n  off(event: 'wheel', handler?: (event: WheelEvent) => void): void;\r\n  off(event: string, handler?: (event: any) => void): void {\r\n    super.off(event, handler);\r\n  }\r\n\r\n  private _onPointerMove = (ev: PointerEvent): void => {\r\n    this.lastPagePos = new Vector(ev.pagePos.x, ev.pagePos.y);\r\n    this.lastScreenPos = new Vector(ev.screenPos.x, ev.screenPos.y);\r\n    this.lastWorldPos = new Vector(ev.worldPos.x, ev.worldPos.y);\r\n  };\r\n\r\n  private _onPointerDown = (ev: PointerEvent): void => {\r\n    this.lastPagePos = new Vector(ev.pagePos.x, ev.pagePos.y);\r\n    this.lastScreenPos = new Vector(ev.screenPos.x, ev.screenPos.y);\r\n    this.lastWorldPos = new Vector(ev.worldPos.x, ev.worldPos.y);\r\n  };\r\n}\r\n","import { Class } from '../Class';\r\nimport { Engine, ScrollPreventionMode } from '../Engine';\r\nimport { GlobalCoordinates } from '../Math/global-coordinates';\r\nimport { vec, Vector } from '../Math/vector';\r\nimport { PointerEvent } from './PointerEvent';\r\nimport { WheelEvent } from './WheelEvent';\r\nimport { PointerAbstraction } from './PointerAbstraction';\r\n\r\nimport { WheelDeltaMode } from './WheelDeltaMode';\r\nimport { PointerSystem } from './PointerSystem';\r\nimport { NativePointerButton } from './NativePointerButton';\r\nimport { PointerButton } from './PointerButton';\r\nimport { fail } from '../Util/Util';\r\nimport { PointerType } from './PointerType';\r\n\r\n\r\nexport type NativePointerEvent = globalThis.PointerEvent;\r\nexport type NativeMouseEvent = globalThis.MouseEvent;\r\nexport type NativeTouchEvent = globalThis.TouchEvent;\r\nexport type NativeWheelEvent = globalThis.WheelEvent;\r\n\r\n/**\r\n * Is this event a native touch event?\r\n */\r\nfunction isTouchEvent(value: any): value is NativeTouchEvent {\r\n  // Guard for Safari <= 13.1\r\n  return globalThis.TouchEvent && value instanceof globalThis.TouchEvent;\r\n}\r\n\r\n/**\r\n * Is this event a native pointer event\r\n */\r\nfunction isPointerEvent(value: any): value is NativePointerEvent {\r\n  // Guard for Safari <= 13.1\r\n  return globalThis.PointerEvent && value instanceof globalThis.PointerEvent;\r\n}\r\n\r\n/**\r\n * The PointerEventProcessor is responsible for collecting all the events from the canvas and transforming them into GlobalCoordinates\r\n */\r\nexport class PointerEventReceiver extends Class {\r\n  public primary: PointerAbstraction = new PointerAbstraction();\r\n\r\n  private _activeNativePointerIdsToNormalized = new Map<number, number>();\r\n  public lastFramePointerCoords = new Map<number, GlobalCoordinates>();\r\n  public currentFramePointerCoords = new Map<number, GlobalCoordinates>();\r\n\r\n  public currentFramePointerDown = new Map<number, boolean>();\r\n  public lastFramePointerDown = new Map<number, boolean>();\r\n\r\n  public currentFrameDown: PointerEvent[] = [];\r\n  public currentFrameUp: PointerEvent[] = [];\r\n  public currentFrameMove: PointerEvent[] = [];\r\n  public currentFrameCancel: PointerEvent[] = [];\r\n  public currentFrameWheel: WheelEvent[] = [];\r\n\r\n  constructor(public readonly target: GlobalEventHandlers & EventTarget, public engine: Engine) {\r\n    super();\r\n  }\r\n\r\n  /**\r\n   * Creates a new PointerEventReceiver with a new target and engine while preserving existing pointer event\r\n   * handlers.\r\n   * @param target\r\n   * @param engine\r\n   */\r\n  public recreate(target: GlobalEventHandlers & EventTarget, engine: Engine) {\r\n    const eventReceiver = new PointerEventReceiver(target, engine);\r\n    eventReceiver.primary = this.primary;\r\n    eventReceiver._pointers = this._pointers;\r\n    return eventReceiver;\r\n  }\r\n\r\n  private _pointers: PointerAbstraction[] = [this.primary];\r\n  /**\r\n   * Locates a specific pointer by id, creates it if it doesn't exist\r\n   * @param index\r\n   */\r\n  public at(index: number): PointerAbstraction {\r\n    if (index >= this._pointers.length) {\r\n      // Ensure there is a pointer to retrieve\r\n      for (let i = this._pointers.length - 1, max = index; i < max; i++) {\r\n        this._pointers.push(new PointerAbstraction());\r\n      }\r\n    }\r\n    return this._pointers[index];\r\n  }\r\n\r\n  /**\r\n   * The number of pointers currently being tracked by excalibur\r\n   */\r\n  public count(): number {\r\n    return this._pointers.length;\r\n  }\r\n\r\n  /**\r\n   * Is the specified pointer id down this frame\r\n   * @param pointerId\r\n   */\r\n  public isDown(pointerId: number) {\r\n    return this.currentFramePointerDown.get(pointerId) ?? false;\r\n  }\r\n\r\n  /**\r\n   * Was the specified pointer id down last frame\r\n   * @param pointerId\r\n   */\r\n  public wasDown(pointerId: number) {\r\n    return this.lastFramePointerDown.get(pointerId) ?? false;\r\n  }\r\n\r\n  /**\r\n   * Whether the Pointer is currently dragging.\r\n   */\r\n  public isDragging(pointerId: number): boolean {\r\n    return this.isDown(pointerId);\r\n  }\r\n\r\n  /**\r\n   * Whether the Pointer just started dragging.\r\n   */\r\n  public isDragStart(pointerId: number): boolean {\r\n    return this.isDown(pointerId) && !this.wasDown(pointerId);\r\n  }\r\n\r\n  /**\r\n   * Whether the Pointer just ended dragging.\r\n   */\r\n  public isDragEnd(pointerId: number): boolean {\r\n    return !this.isDown(pointerId) && this.wasDown(pointerId);\r\n  }\r\n\r\n  on(event: 'move', handler: (event: PointerEvent) => void): void;\r\n  on(event: 'down', handler: (event: PointerEvent) => void): void;\r\n  on(event: 'up', handler: (event: PointerEvent) => void): void;\r\n  on(event: 'wheel', handler: (event: WheelEvent) => void): void;\r\n  on(event: string, handler: (event: any) => void): void {\r\n    super.on(event, handler);\r\n  }\r\n\r\n  once(event: 'move', handler: (event: PointerEvent) => void): void;\r\n  once(event: 'down', handler: (event: PointerEvent) => void): void;\r\n  once(event: 'up', handler: (event: PointerEvent) => void): void;\r\n  once(event: 'wheel', handler: (event: WheelEvent) => void): void;\r\n  once(event: string, handler: (event: any) => void): void {\r\n    super.once(event, handler);\r\n  }\r\n\r\n  off(event: 'move', handler?: (event: PointerEvent) => void): void;\r\n  off(event: 'down', handler?: (event: PointerEvent) => void): void;\r\n  off(event: 'up', handler?: (event: PointerEvent) => void): void;\r\n  off(event: 'wheel', handler?: (event: WheelEvent) => void): void;\r\n  off(event: string, handler?: (event: any) => void): void {\r\n    super.off(event, handler);\r\n  }\r\n\r\n  /**\r\n   * Called internally by excalibur\r\n   *\r\n   * Updates the current frame pointer info and emits raw pointer events\r\n   *\r\n   * This does not emit events to entities, see PointerSystem\r\n   */\r\n  public update() {\r\n    this.lastFramePointerDown = new Map(this.currentFramePointerDown);\r\n    this.lastFramePointerCoords = new Map(this.currentFramePointerCoords);\r\n\r\n    for (const event of this.currentFrameDown) {\r\n      this.emit('down', event);\r\n      const pointer = this.at(event.pointerId);\r\n      pointer.emit('down', event);\r\n      this.primary.emit('pointerdown', event);\r\n    }\r\n\r\n    for (const event of this.currentFrameUp) {\r\n      this.emit('up', event);\r\n      const pointer = this.at(event.pointerId);\r\n      pointer.emit('up', event);\r\n    }\r\n\r\n    for (const event of this.currentFrameMove) {\r\n      this.emit('move', event);\r\n      const pointer = this.at(event.pointerId);\r\n      pointer.emit('move', event);\r\n    }\r\n\r\n    for (const event of this.currentFrameCancel) {\r\n      this.emit('cancel', event);\r\n      const pointer = this.at(event.pointerId);\r\n      pointer.emit('cancel', event);\r\n    }\r\n\r\n    for (const event of this.currentFrameWheel) {\r\n      this.emit('wheel', event);\r\n      this.primary.emit('pointerwheel', event);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clears the current frame event and pointer data\r\n   */\r\n  public clear() {\r\n    for (const event of this.currentFrameUp) {\r\n      this.currentFramePointerCoords.delete(event.pointerId);\r\n      const ids = this._activeNativePointerIdsToNormalized.entries();\r\n      for (const [native, normalized] of ids) {\r\n        if (normalized === event.pointerId) {\r\n          this._activeNativePointerIdsToNormalized.delete(native);\r\n        }\r\n      }\r\n    }\r\n    this.currentFrameDown.length = 0;\r\n    this.currentFrameUp.length = 0;\r\n    this.currentFrameMove.length = 0;\r\n    this.currentFrameCancel.length = 0;\r\n    this.currentFrameWheel.length = 0;\r\n  }\r\n\r\n  private _boundHandle = this._handle.bind(this);\r\n  private _boundWheel = this._handleWheel.bind(this);\r\n  /**\r\n   * Initializes the pointer event receiver so that it can start listening to native\r\n   * browser events.\r\n   */\r\n  public init() {\r\n    // Disabling the touch action avoids browser/platform gestures from firing on the canvas\r\n    // It is important on mobile to have touch action 'none'\r\n    // https://stackoverflow.com/questions/48124372/pointermove-event-not-working-with-touch-why-not\r\n    if (this.target === this.engine.canvas) {\r\n      this.engine.canvas.style.touchAction = 'none';\r\n    } else {\r\n      document.body.style.touchAction = 'none';\r\n    }\r\n    // Preferred pointer events\r\n    if (window.PointerEvent) {\r\n      this.target.addEventListener('pointerdown', this._boundHandle);\r\n      this.target.addEventListener('pointerup', this._boundHandle);\r\n      this.target.addEventListener('pointermove', this._boundHandle);\r\n      this.target.addEventListener('pointercancel', this._boundHandle);\r\n    } else {\r\n      // Touch Events\r\n      this.target.addEventListener('touchstart', this._boundHandle);\r\n      this.target.addEventListener('touchend', this._boundHandle);\r\n      this.target.addEventListener('touchmove', this._boundHandle);\r\n      this.target.addEventListener('touchcancel', this._boundHandle);\r\n\r\n      // Mouse Events\r\n      this.target.addEventListener('mousedown', this._boundHandle);\r\n      this.target.addEventListener('mouseup', this._boundHandle);\r\n      this.target.addEventListener('mousemove', this._boundHandle);\r\n    }\r\n\r\n    // MDN MouseWheelEvent\r\n    const wheelOptions = {\r\n      passive: !(\r\n        this.engine.pageScrollPreventionMode === ScrollPreventionMode.All ||\r\n        this.engine.pageScrollPreventionMode === ScrollPreventionMode.Canvas\r\n      )\r\n    };\r\n    if ('onwheel' in document.createElement('div')) {\r\n      // Modern Browsers\r\n      this.target.addEventListener('wheel', this._boundWheel, wheelOptions);\r\n    } else if (document.onmousewheel !== undefined) {\r\n      // Webkit and IE\r\n      this.target.addEventListener('mousewheel', this._boundWheel, wheelOptions);\r\n    } else {\r\n      // Remaining browser and older Firefox\r\n      this.target.addEventListener('MozMousePixelScroll', this._boundWheel, wheelOptions);\r\n    }\r\n  }\r\n\r\n  public detach() {\r\n    // Preferred pointer events\r\n    if (window.PointerEvent) {\r\n      this.target.removeEventListener('pointerdown', this._boundHandle);\r\n      this.target.removeEventListener('pointerup', this._boundHandle);\r\n      this.target.removeEventListener('pointermove', this._boundHandle);\r\n      this.target.removeEventListener('pointercancel', this._boundHandle);\r\n    } else {\r\n      // Touch Events\r\n      this.target.removeEventListener('touchstart', this._boundHandle);\r\n      this.target.removeEventListener('touchend', this._boundHandle);\r\n      this.target.removeEventListener('touchmove', this._boundHandle);\r\n      this.target.removeEventListener('touchcancel', this._boundHandle);\r\n\r\n      // Mouse Events\r\n      this.target.removeEventListener('mousedown', this._boundHandle);\r\n      this.target.removeEventListener('mouseup', this._boundHandle);\r\n      this.target.removeEventListener('mousemove', this._boundHandle);\r\n    }\r\n\r\n    if ('onwheel' in document.createElement('div')) {\r\n      // Modern Browsers\r\n      this.target.removeEventListener('wheel', this._boundWheel);\r\n    } else if (document.onmousewheel !== undefined) {\r\n      // Webkit and IE\r\n      this.target.addEventListener('mousewheel', this._boundWheel);\r\n    } else {\r\n      // Remaining browser and older Firefox\r\n      this.target.addEventListener('MozMousePixelScroll', this._boundWheel);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Take native pointer id and map it to index in active pointers\r\n   * @param nativePointerId\r\n   */\r\n  private _normalizePointerId(nativePointerId: number) {\r\n    // Add to the the native pointer set id\r\n    this._activeNativePointerIdsToNormalized.set(nativePointerId, -1);\r\n\r\n    // Native pointer ids in ascending order\r\n    const currentPointerIds = Array.from(this._activeNativePointerIdsToNormalized.keys()).sort((a, b) => a - b);\r\n\r\n    // The index into sorted ids will be the new id, will always have an id\r\n    const id = currentPointerIds.findIndex(p => p === nativePointerId);\r\n\r\n    // Save the mapping so we can reverse it later\r\n    this._activeNativePointerIdsToNormalized.set(nativePointerId, id);\r\n\r\n    // ignore pointer because game isn't watching\r\n    return id;\r\n  }\r\n\r\n  /**\r\n   * Responsible for handling and parsing pointer events\r\n   */\r\n  private _handle(ev: NativeTouchEvent | NativePointerEvent | NativeMouseEvent) {\r\n    ev.preventDefault();\r\n    const eventCoords = new Map<number, GlobalCoordinates>();\r\n    let button: PointerButton;\r\n    let pointerType: PointerType;\r\n    if (isTouchEvent(ev)) {\r\n      button = PointerButton.Unknown;\r\n      pointerType = PointerType.Touch;\r\n      // https://developer.mozilla.org/en-US/docs/Web/API/TouchEvent\r\n      for (let i = 0; i < ev.changedTouches.length; i++) {\r\n        const touch = ev.changedTouches[i];\r\n        const coordinates = GlobalCoordinates.fromPagePosition(touch.pageX, touch.pageY, this.engine);\r\n        const nativePointerId = i + 1;\r\n        const pointerId = this._normalizePointerId(nativePointerId);\r\n        this.currentFramePointerCoords.set(pointerId, coordinates);\r\n        eventCoords.set(pointerId, coordinates);\r\n      }\r\n    } else {\r\n      button = this._nativeButtonToPointerButton(ev.button);\r\n      pointerType = PointerType.Mouse;\r\n      const coordinates = GlobalCoordinates.fromPagePosition(ev.pageX, ev.pageY, this.engine);\r\n      let nativePointerId = 1;\r\n      if (isPointerEvent(ev)) {\r\n        nativePointerId = ev.pointerId;\r\n        pointerType = this._stringToPointerType(ev.pointerType);\r\n      }\r\n      const pointerId = this._normalizePointerId(nativePointerId);\r\n      this.currentFramePointerCoords.set(pointerId, coordinates);\r\n      eventCoords.set(pointerId, coordinates);\r\n    }\r\n\r\n    for (const [pointerId, coord] of eventCoords.entries()) {\r\n      switch (ev.type) {\r\n        case 'mousedown':\r\n        case 'pointerdown':\r\n        case 'touchstart':\r\n          this.currentFrameDown.push(new PointerEvent('down', pointerId, button, pointerType, coord, ev));\r\n          this.currentFramePointerDown.set(pointerId, true);\r\n          break;\r\n        case 'mouseup':\r\n        case 'pointerup':\r\n        case 'touchend':\r\n          this.currentFrameUp.push(new PointerEvent('up', pointerId, button, pointerType, coord, ev));\r\n          this.currentFramePointerDown.set(pointerId, false);\r\n          break;\r\n        case 'mousemove':\r\n        case 'pointermove':\r\n        case 'touchmove':\r\n          this.currentFrameMove.push(new PointerEvent('move', pointerId, button, pointerType, coord, ev));\r\n          break;\r\n        case 'touchcancel':\r\n        case 'pointercancel':\r\n          this.currentFrameCancel.push(new PointerEvent('cancel', pointerId, button, pointerType, coord, ev));\r\n          break;\r\n      }\r\n    }\r\n  }\r\n\r\n  private _handleWheel(ev: NativeWheelEvent) {\r\n    // Should we prevent page scroll because of this event\r\n    if (\r\n      this.engine.pageScrollPreventionMode === ScrollPreventionMode.All ||\r\n      (this.engine.pageScrollPreventionMode === ScrollPreventionMode.Canvas && ev.target === this.engine.canvas)\r\n    ) {\r\n      ev.preventDefault();\r\n    }\r\n    const screen = this.engine.screen.pageToScreenCoordinates(vec(ev.pageX, ev.pageY));\r\n    const world = this.engine.screen.screenToWorldCoordinates(screen);\r\n\r\n    /**\r\n     * A constant used to normalize wheel events across different browsers\r\n     *\r\n     * This normalization factor is pulled from\r\n     * https://developer.mozilla.org/en-US/docs/Web/Events/wheel#Listening_to_this_event_across_browser\r\n     */\r\n    const ScrollWheelNormalizationFactor = -1 / 40;\r\n\r\n    const deltaX = ev.deltaX || ev.wheelDeltaX * ScrollWheelNormalizationFactor || 0;\r\n    const deltaY =\r\n        ev.deltaY || ev.wheelDeltaY * ScrollWheelNormalizationFactor || ev.wheelDelta * ScrollWheelNormalizationFactor || ev.detail || 0;\r\n    const deltaZ = ev.deltaZ || 0;\r\n    let deltaMode = WheelDeltaMode.Pixel;\r\n\r\n    if (ev.deltaMode) {\r\n      if (ev.deltaMode === 1) {\r\n        deltaMode = WheelDeltaMode.Line;\r\n      } else if (ev.deltaMode === 2) {\r\n        deltaMode = WheelDeltaMode.Page;\r\n      }\r\n    }\r\n\r\n    const we = new WheelEvent(world.x, world.y, ev.pageX, ev.pageY, screen.x, screen.y, 0, deltaX, deltaY, deltaZ, deltaMode, ev);\r\n    this.currentFrameWheel.push(we);\r\n  }\r\n\r\n  /**\r\n   * Triggers an excalibur pointer event in a world space pos\r\n   *\r\n   * Useful for testing pointers in excalibur\r\n   * @param type\r\n   * @param pos\r\n   */\r\n  public triggerEvent(type: 'down' | 'up' | 'move' | 'cancel', pos: Vector) {\r\n    const page = this.engine.screen.worldToPageCoordinates(pos);\r\n    // Send an event to the event receiver\r\n    if (window.PointerEvent) {\r\n      this._handle(new window.PointerEvent('pointer' + type, {\r\n        pointerId: 0,\r\n        clientX: page.x,\r\n        clientY: page.y\r\n      }));\r\n    } else {\r\n      // Safari hack\r\n      this._handle(new window.MouseEvent('mouse' + type, {\r\n        clientX: page.x,\r\n        clientY: page.y\r\n      }));\r\n    }\r\n\r\n    // Force update pointer system\r\n    const pointerSystem = this.engine.currentScene.world.systemManager.get(PointerSystem);\r\n    const transformEntities = this.engine.currentScene.world.queryManager.createQuery(pointerSystem.types);\r\n    pointerSystem.preupdate();\r\n    pointerSystem.update(transformEntities.getEntities());\r\n  }\r\n\r\n  private _nativeButtonToPointerButton(s: NativePointerButton): PointerButton {\r\n    switch (s) {\r\n      case NativePointerButton.NoButton:\r\n        return PointerButton.NoButton;\r\n      case NativePointerButton.Left:\r\n        return PointerButton.Left;\r\n      case NativePointerButton.Middle:\r\n        return PointerButton.Middle;\r\n      case NativePointerButton.Right:\r\n        return PointerButton.Right;\r\n      case NativePointerButton.Unknown:\r\n        return PointerButton.Unknown;\r\n      default:\r\n        return fail(s);\r\n    }\r\n  }\r\n\r\n  private _stringToPointerType(s: string) {\r\n    switch (s) {\r\n      case 'touch':\r\n        return PointerType.Touch;\r\n      case 'mouse':\r\n        return PointerType.Mouse;\r\n      case 'pen':\r\n        return PointerType.Pen;\r\n      default:\r\n        return PointerType.Unknown;\r\n    }\r\n  }\r\n}","export interface FpsSamplerOptions {\r\n  /**\r\n   * Specify the sampling period in milliseconds (default 100)\r\n   */\r\n  samplePeriod?: number;\r\n  /**\r\n   * Specify the initial FPS\r\n   */\r\n  initialFps: number;\r\n\r\n  /**\r\n   * Specify the function used to return the current time (in milliseconds)\r\n   */\r\n  nowFn: () => number;\r\n}\r\n\r\nexport class FpsSampler {\r\n  private _fps: number;\r\n  private _samplePeriod: number = 100;\r\n  private _currentFrameTime: number = 0;\r\n  private _frames: number = 0;\r\n  private _previousSampleTime: number = 0;\r\n  private _beginFrameTime: number = 0;\r\n  private _nowFn: () => number;\r\n\r\n  constructor(options: FpsSamplerOptions) {\r\n    this._fps = options.initialFps;\r\n    this._samplePeriod = options.samplePeriod ?? this._samplePeriod;\r\n    this._currentFrameTime = 1000/options.initialFps;\r\n    this._nowFn = options.nowFn;\r\n    this._previousSampleTime = this._nowFn();\r\n  }\r\n\r\n  /**\r\n   * Start of code block to sample FPS for\r\n   */\r\n  start() {\r\n    this._beginFrameTime = this._nowFn();\r\n  }\r\n\r\n  /**\r\n   * End of code block to sample FPS for\r\n   */\r\n  end() {\r\n    this._frames++;\r\n    const time = this._nowFn();\r\n\r\n    this._currentFrameTime = time - this._beginFrameTime;\r\n\r\n    if (time >= this._previousSampleTime + this._samplePeriod) {\r\n      this._fps = (this._frames * 1000) / (time - this._previousSampleTime);\r\n      this._previousSampleTime = time;\r\n      this._frames = 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Return the currently sampled fps over the last sample period, by default every 100ms\r\n   */\r\n  get fps() {\r\n    return this._fps;\r\n  }\r\n\r\n  /**\r\n   * Return the instantaneous fps, this can be less useful because it will fluctuate given the current frames time\r\n   */\r\n  get instant() {\r\n    return 1000 / this._currentFrameTime;\r\n  }\r\n}","import { Logger } from '..';\r\nimport { FpsSampler } from './Fps';\r\n\r\nexport interface ClockOptions {\r\n  /**\r\n   * Define the function you'd like the clock to tick when it is started\r\n   */\r\n  tick: (elapsedMs: number) => any;\r\n  /**\r\n   * Optionally define the fatal exception handler, used if an error is thrown in tick\r\n   */\r\n  onFatalException?: (e: unknown) => any;\r\n  /**\r\n   * Optionally limit the maximum FPS of the clock\r\n   */\r\n  maxFps?: number;\r\n}\r\n\r\n\r\n/**\r\n * Abstract Clock is the base type of all Clocks\r\n *\r\n * It has a few opinions\r\n * 1. It manages the calculation of what \"elapsed\" time means and thus maximum fps\r\n * 2. The default timing api is implemented in now()\r\n *\r\n * To implement your own clock, extend Clock and override start/stop to start and stop the clock, then call update() with whatever\r\n * method is unique to your clock implementation.\r\n */\r\nexport abstract class Clock {\r\n  protected tick: (elapsedMs: number) => any;\r\n  private _onFatalException: (e: unknown) => any = () => { /* default nothing */ };\r\n  private _maxFps: number = Infinity;\r\n  private _lastTime: number = 0;\r\n  public fpsSampler: FpsSampler;\r\n  private _options: ClockOptions;\r\n  private _elapsed: number = 1;\r\n  private _scheduledCbs: [cb: () => any, scheduledTime: number][] = [];\r\n  private _totalElapsed: number = 0;\r\n  constructor(options: ClockOptions) {\r\n    this._options = options;\r\n    this.tick = options.tick;\r\n    this._lastTime = this.now() ?? 0;\r\n    this._maxFps = options.maxFps ?? this._maxFps;\r\n    this._onFatalException = options.onFatalException ?? this._onFatalException;\r\n    this.fpsSampler = new FpsSampler({\r\n      initialFps: 60,\r\n      nowFn: () => this.now()\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get the elapsed time for the last completed frame\r\n   */\r\n  public elapsed(): number {\r\n    return this._elapsed;\r\n  }\r\n\r\n  /**\r\n   * Get the current time in milliseconds\r\n   */\r\n  public now(): number {\r\n    return performance.now();\r\n  }\r\n\r\n  public toTestClock() {\r\n    const testClock = new TestClock({\r\n      ...this._options,\r\n      defaultUpdateMs: 16.6\r\n    });\r\n    return testClock;\r\n  }\r\n\r\n  public toStandardClock() {\r\n    const clock = new StandardClock({\r\n      ...this._options\r\n    });\r\n    return clock;\r\n  }\r\n\r\n  public setFatalExceptionHandler(handler: (e: unknown) => any) {\r\n    this._onFatalException = handler;\r\n  }\r\n\r\n  /**\r\n   * Schedule a callback to fire given a timeout in milliseconds using the excalibur [[Clock]]\r\n   *\r\n   * This is useful to use over the built in browser `setTimeout` because callbacks will be tied to the\r\n   * excalibur update clock, instead of browser time, this means that callbacks wont fire if the game is\r\n   * stopped or paused.\r\n   *\r\n   * @param cb callback to fire\r\n   * @param timeoutMs Optionally specify a timeout in milliseconds from now, default is 0ms which means the next possible tick\r\n   */\r\n  public schedule(cb: () => any, timeoutMs: number = 0) {\r\n    // Scheduled based on internal elapsed time\r\n    const scheduledTime = this._totalElapsed + timeoutMs;\r\n    this._scheduledCbs.push([cb, scheduledTime]);\r\n  }\r\n\r\n  private _runScheduledCbs() {\r\n    // walk backwards to delete items as we loop\r\n    for (let i = this._scheduledCbs.length - 1; i > -1; i--) {\r\n      if (this._scheduledCbs[i][1] <= this._totalElapsed) {\r\n        this._scheduledCbs[i][0]();\r\n        this._scheduledCbs.splice(i, 1);\r\n      }\r\n    }\r\n  }\r\n\r\n  protected update(overrideUpdateMs?: number): void {\r\n    try {\r\n      this.fpsSampler.start();\r\n      // Get the time to calculate time-elapsed\r\n      const now = this.now();\r\n      let elapsed = now - this._lastTime || 1; // first frame\r\n\r\n      // Constrain fps\r\n      const fpsInterval = (1000 / this._maxFps);\r\n\r\n      // only run frame if enough time has elapsed\r\n      if (elapsed >= fpsInterval) {\r\n        let leftover = 0;\r\n        if (fpsInterval !== 0) {\r\n          leftover = (elapsed % fpsInterval);\r\n          elapsed = elapsed - leftover; // shift elapsed to be \"in phase\" with the current loop fps\r\n        }\r\n\r\n        // Resolves issue #138 if the game has been paused, or blurred for\r\n        // more than a 200 milliseconds, reset elapsed time to 1. This improves reliability\r\n        // and provides more expected behavior when the engine comes back\r\n        // into focus\r\n        if (elapsed > 200) {\r\n          elapsed = 1;\r\n        }\r\n\r\n        // tick the mainloop and run scheduled callbacks\r\n        this._elapsed = overrideUpdateMs || elapsed;\r\n        this._totalElapsed += this._elapsed;\r\n        this._runScheduledCbs();\r\n        this.tick(overrideUpdateMs || elapsed);\r\n\r\n        if (fpsInterval !== 0) {\r\n          this._lastTime = now - leftover;\r\n        } else {\r\n          this._lastTime = now;\r\n        }\r\n        this.fpsSampler.end();\r\n      }\r\n    } catch (e) {\r\n      this._onFatalException(e);\r\n      this.stop();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns if the clock is currently running\r\n   */\r\n  public abstract isRunning(): boolean;\r\n\r\n  /**\r\n   * Start the clock, it will then periodically call the tick(elapsedMilliseconds) since the last tick\r\n   */\r\n  public abstract start(): void;\r\n\r\n  /**\r\n   * Stop the clock, tick() is no longer called\r\n   */\r\n  public abstract stop(): void;\r\n}\r\n\r\n\r\n/**\r\n * The [[StandardClock]] implements the requestAnimationFrame browser api to run the tick()\r\n */\r\nexport class StandardClock extends Clock {\r\n\r\n  private _running = false;\r\n  private _requestId: number;\r\n  constructor(options: ClockOptions) {\r\n    super(options);\r\n  }\r\n\r\n  public isRunning(): boolean {\r\n    return this._running;\r\n  }\r\n\r\n  public start(): void {\r\n    if (this._running) {\r\n      return;\r\n    }\r\n    this._running = true;\r\n    const mainloop = () => {\r\n      // stop the loop\r\n      if (!this._running) {\r\n        return;\r\n      }\r\n      try {\r\n        // request next loop\r\n        this._requestId = window.requestAnimationFrame(mainloop);\r\n        this.update();\r\n      } catch (e) {\r\n        window.cancelAnimationFrame(this._requestId);\r\n        throw e;\r\n      }\r\n    };\r\n\r\n    // begin the first frame\r\n    mainloop();\r\n  }\r\n\r\n  public stop(): void {\r\n    this._running = false;\r\n  }\r\n}\r\n\r\nexport interface TestClockOptions {\r\n  /**\r\n   * Specify the update milliseconds to use for each manual step()\r\n   */\r\n  defaultUpdateMs: number;\r\n}\r\n\r\n/**\r\n * The TestClock is meant for debugging interactions in excalibur that require precise timing to replicate or test\r\n */\r\nexport class TestClock extends Clock {\r\n  private _logger = Logger.getInstance();\r\n  private _updateMs: number;\r\n  private _running: boolean = false;\r\n  private _currentTime = 0;\r\n  constructor(options: ClockOptions & TestClockOptions) {\r\n    super({\r\n      ...options\r\n    });\r\n    this._updateMs = options.defaultUpdateMs;\r\n  }\r\n\r\n  /**\r\n   * Get the current time in milliseconds\r\n   */\r\n  public override now() {\r\n    return this._currentTime ?? 0;\r\n  }\r\n\r\n  public isRunning(): boolean {\r\n    return this._running;\r\n  }\r\n  public start(): void {\r\n    this._running = true;\r\n  }\r\n  public stop(): void {\r\n    this._running = false;\r\n  }\r\n\r\n  /**\r\n   * Manually step the clock forward 1 tick, optionally specify an elapsed time in milliseconds\r\n   * @param overrideUpdateMs\r\n   */\r\n  step(overrideUpdateMs?: number): void {\r\n    const time = overrideUpdateMs ?? this._updateMs;\r\n\r\n    if (this._running) {\r\n      // to be comparable to RAF this needs to be a full blown Task\r\n      // For example, images cannot decode synchronously in a single step\r\n      this.update(time);\r\n      this._currentTime += time;\r\n    } else {\r\n      this._logger.warn('The clock is not running, no step will be performed');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Run a number of steps that tick the clock, optionally specify an elapsed time in milliseconds\r\n   * @param numberOfSteps\r\n   * @param overrideUpdateMs\r\n   */\r\n  run(numberOfSteps: number, overrideUpdateMs?: number): void {\r\n    for (let i = 0; i < numberOfSteps; i++) {\r\n      this.step(overrideUpdateMs ?? this._updateMs);\r\n    }\r\n  }\r\n}","import { EX_VERSION } from './';\r\nimport { Flags } from './Flags';\r\nimport { polyfill } from './Polyfill';\r\npolyfill();\r\nimport { CanUpdate, CanDraw, CanInitialize } from './Interfaces/LifecycleEvents';\r\nimport { Loadable } from './Interfaces/Loadable';\r\nimport { Vector } from './Math/vector';\r\nimport { Screen, DisplayMode, ScreenDimension, Resolution } from './Screen';\r\nimport { ScreenElement } from './ScreenElement';\r\nimport { Actor } from './Actor';\r\nimport { Timer } from './Timer';\r\nimport { TileMap } from './TileMap';\r\nimport { Loader } from './Loader';\r\nimport { Detector } from './Util/Detector';\r\nimport {\r\n  VisibleEvent,\r\n  HiddenEvent,\r\n  GameStartEvent,\r\n  GameStopEvent,\r\n  PreUpdateEvent,\r\n  PostUpdateEvent,\r\n  PreFrameEvent,\r\n  PostFrameEvent,\r\n  GameEvent,\r\n  DeactivateEvent,\r\n  ActivateEvent,\r\n  PreDrawEvent,\r\n  PostDrawEvent,\r\n  InitializeEvent\r\n} from './Events';\r\nimport { Logger, LogLevel } from './Util/Log';\r\nimport { Color } from './Color';\r\nimport { Scene } from './Scene';\r\nimport { Entity } from './EntityComponentSystem/Entity';\r\nimport { Debug, DebugStats } from './Debug/Debug';\r\nimport { Class } from './Class';\r\nimport * as Input from './Input/Index';\r\nimport * as Events from './Events';\r\nimport { BrowserEvents } from './Util/Browser';\r\nimport { ExcaliburGraphicsContext, ExcaliburGraphicsContext2DCanvas, ExcaliburGraphicsContextWebGL, TextureLoader } from './Graphics';\r\nimport { PointerEventReceiver } from './Input/PointerEventReceiver';\r\nimport { Clock, StandardClock } from './Util/Clock';\r\nimport { ImageFiltering } from './Graphics/Filtering';\r\nimport { GraphicsDiagnostics } from './Graphics/GraphicsDiagnostics';\r\nimport { Toaster } from './Util/Toaster';\r\n\r\n/**\r\n * Enum representing the different mousewheel event bubble prevention\r\n */\r\nexport enum ScrollPreventionMode {\r\n  /**\r\n   * Do not prevent any page scrolling\r\n   */\r\n  None,\r\n  /**\r\n   * Prevent page scroll if mouse is over the game canvas\r\n   */\r\n  Canvas,\r\n  /**\r\n   * Prevent all page scrolling via mouse wheel\r\n   */\r\n  All\r\n}\r\n\r\n/**\r\n * Defines the available options to configure the Excalibur engine at constructor time.\r\n */\r\nexport interface EngineOptions {\r\n  /**\r\n   * Optionally configure the width of the viewport in css pixels\r\n   */\r\n  width?: number;\r\n\r\n  /**\r\n   * Optionally configure the height of the viewport in css pixels\r\n   */\r\n  height?: number;\r\n\r\n  /**\r\n   * Optionally configure the width & height of the viewport in css pixels.\r\n   * Use `viewport` instead of [[EngineOptions.width]] and [[EngineOptions.height]], or vice versa.\r\n   */\r\n  viewport?: ScreenDimension;\r\n\r\n  /**\r\n   * Optionally specify the size the logical pixel resolution, if not specified it will be width x height.\r\n   * See [[Resolution]] for common presets.\r\n   */\r\n  resolution?: ScreenDimension;\r\n\r\n  /**\r\n   * Optionally specify antialiasing (smoothing), by default true (smooth pixels)\r\n   *\r\n   *  * `true` - useful for high resolution art work you would like smoothed, this also hints excalibur to load images\r\n   * with [[ImageFiltering.Blended]]\r\n   *\r\n   *  * `false` - useful for pixel art style art work you would like sharp, this also hints excalibur to load images\r\n   * with [[ImageFiltering.Pixel]]\r\n   */\r\n  antialiasing?: boolean;\r\n\r\n  /**\r\n   * Optionally upscale the number of pixels in the canvas. Normally only useful if you need a smoother look to your assets, especially\r\n   * [[Text]].\r\n   *\r\n   * **WARNING** It is recommended you try using `antialiasing: true` before adjusting pixel ratio. Pixel ratio will consume more memory\r\n   * and on mobile may break if the internal size of the canvas exceeds 4k pixels in width or height.\r\n   *\r\n   * Default is based the display's pixel ratio, for example a HiDPI screen might have the value 2;\r\n   */\r\n  pixelRatio?: number;\r\n\r\n  /**\r\n   * Optionally configure the native canvas transparent backdrop\r\n   */\r\n  enableCanvasTransparency?: boolean;\r\n\r\n  /**\r\n   * Optionally specify the target canvas DOM element to render the game in\r\n   */\r\n  canvasElementId?: string;\r\n\r\n  /**\r\n   * Optionally specify the target canvas DOM element directly\r\n   */\r\n  canvasElement?: HTMLCanvasElement;\r\n\r\n  /**\r\n   * Optionally snap graphics to nearest pixel, default is false\r\n   */\r\n  snapToPixel?: boolean;\r\n\r\n  /**\r\n   * The [[DisplayMode]] of the game, by default [[DisplayMode.FitScreen]] with aspect ratio 4:3 (800x600).\r\n   * Depending on this value, [[width]] and [[height]] may be ignored.\r\n   */\r\n  displayMode?: DisplayMode;\r\n\r\n  /**\r\n   * Configures the pointer scope. Pointers scoped to the 'Canvas' can only fire events within the canvas viewport; whereas, 'Document'\r\n   * (default) scoped will fire anywhere on the page.\r\n   */\r\n  pointerScope?: Input.PointerScope;\r\n\r\n  /**\r\n   * Suppress boot up console message, which contains the \"powered by Excalibur message\"\r\n   */\r\n  suppressConsoleBootMessage?: boolean;\r\n\r\n  /**\r\n   * Suppress minimum browser feature detection, it is not recommended users of excalibur switch this off. This feature ensures that\r\n   * the currently running browser meets the minimum requirements for running excalibur. This can be useful if running on non-standard\r\n   * browsers or if there is a bug in excalibur preventing execution.\r\n   */\r\n  suppressMinimumBrowserFeatureDetection?: boolean;\r\n\r\n  /**\r\n   * Suppress HiDPI auto detection and scaling, it is not recommended users of excalibur switch off this feature. This feature detects\r\n   * and scales the drawing canvas appropriately to accommodate HiDPI screens.\r\n   */\r\n  suppressHiDPIScaling?: boolean;\r\n\r\n  /**\r\n   * Suppress play button, it is not recommended users of excalibur switch this feature. Some browsers require a user gesture (like a click)\r\n   * for certain browser features to work like web audio.\r\n   */\r\n  suppressPlayButton?: boolean;\r\n\r\n  /**\r\n   * Scroll prevention method.\r\n   */\r\n  scrollPreventionMode?: ScrollPreventionMode;\r\n\r\n  /**\r\n   * Optionally set the background color\r\n   */\r\n  backgroundColor?: Color;\r\n\r\n  /**\r\n   * Optionally set the maximum fps if not set Excalibur will go as fast as the device allows.\r\n   *\r\n   * You may want to constrain max fps if your game cannot maintain fps consistently, it can look and feel better to have a 30fps game than\r\n   * one that bounces between 30fps and 60fps\r\n   */\r\n  maxFps?: number;\r\n\r\n  /**\r\n   * Optionally configure a fixed update fps, this can be desireable if you need the physics simulation to be very stable. When set\r\n   * the update step and physics will use the same elapsed time for each tick even if the graphical framerate drops. In order for the\r\n   * simulation to be correct, excalibur will run multiple updates in a row (at the configured update elapsed) to catch up, for example\r\n   * there could be X updates and 1 draw each clock step.\r\n   *\r\n   * **NOTE:** This does come at a potential perf cost because each catch-up update will need to be run if the fixed rate is greater than\r\n   * the current instantaneous framerate, or perf gain if the fixed rate is less than the current framerate.\r\n   *\r\n   * By default is unset and updates will use the current instantaneous framerate with 1 update and 1 draw each clock step.\r\n   */\r\n  fixedUpdateFps?: number\r\n\r\n  /**\r\n   * Default `true`, optionally configure excalibur to use optimal draw call sorting, to opt out set this to `false`.\r\n   *\r\n   * Excalibur will automatically sort draw calls by z and priority into renderer batches for maximal draw performance,\r\n   * this can disrupt a specific desired painter order.\r\n   */\r\n  useDrawSorting?: boolean;\r\n\r\n  /**\r\n   * Optionally configure how excalibur handles poor performance on a player's browser\r\n   */\r\n  configurePerformanceCanvas2DFallback?: {\r\n    /**\r\n     * By default `true`, this will switch the internal graphics context to Canvas2D which can improve performance on non hardware\r\n     * accelerated browsers.\r\n     */\r\n    allow: boolean;\r\n    /**\r\n     * By default `false`, if set to `true` a dialogue will be presented to the player about their browser and how to potentially\r\n     * address any issues.\r\n     */\r\n    showPlayerMessage?: boolean;\r\n    /**\r\n     * Default `{ numberOfFrames: 100, fps: 20 }`, optionally configure excalibur to fallback to the 2D Canvas renderer\r\n     * if bad performance is detected.\r\n     *\r\n     * In this example of the default if excalibur is running at 20fps or less for 100 frames it will trigger the fallback to the 2D\r\n     * Canvas renderer.\r\n     */\r\n    threshold?: { numberOfFrames: number, fps: number };\r\n  }\r\n}\r\n\r\n/**\r\n * The Excalibur Engine\r\n *\r\n * The [[Engine]] is the main driver for a game. It is responsible for\r\n * starting/stopping the game, maintaining state, transmitting events,\r\n * loading resources, and managing the scene.\r\n */\r\nexport class Engine extends Class implements CanInitialize, CanUpdate, CanDraw {\r\n  /**\r\n   * Excalibur browser events abstraction used for wiring to native browser events safely\r\n   */\r\n  public browser: BrowserEvents;\r\n\r\n  /**\r\n   * Screen abstraction\r\n   */\r\n  public screen: Screen;\r\n\r\n  /**\r\n   * Direct access to the engine's canvas element\r\n   */\r\n  public canvas: HTMLCanvasElement;\r\n\r\n  /**\r\n   * Direct access to the ExcaliburGraphicsContext used for drawing things to the screen\r\n   */\r\n  public graphicsContext: ExcaliburGraphicsContext;\r\n\r\n  /**\r\n   * Direct access to the canvas element ID, if an ID exists\r\n   */\r\n  public canvasElementId: string;\r\n\r\n  /**\r\n   * Optionally set the maximum fps if not set Excalibur will go as fast as the device allows.\r\n   *\r\n   * You may want to constrain max fps if your game cannot maintain fps consistently, it can look and feel better to have a 30fps game than\r\n   * one that bounces between 30fps and 60fps\r\n   */\r\n  public maxFps: number = Number.POSITIVE_INFINITY;\r\n\r\n  /**\r\n   * Optionally configure a fixed update fps, this can be desireable if you need the physics simulation to be very stable. When set\r\n   * the update step and physics will use the same elapsed time for each tick even if the graphical framerate drops. In order for the\r\n   * simulation to be correct, excalibur will run multiple updates in a row (at the configured update elapsed) to catch up, for example\r\n   * there could be X updates and 1 draw each clock step.\r\n   *\r\n   * **NOTE:** This does come at a potential perf cost because each catch-up update will need to be run if the fixed rate is greater than\r\n   * the current instantaneous framerate, or perf gain if the fixed rate is less than the current framerate.\r\n   *\r\n   * By default is unset and updates will use the current instantaneous framerate with 1 update and 1 draw each clock step.\r\n   */\r\n  public fixedUpdateFps?: number;\r\n\r\n  /**\r\n   * Direct access to the excalibur clock\r\n   */\r\n  public clock: Clock;\r\n\r\n  /**\r\n   * The width of the game canvas in pixels (physical width component of the\r\n   * resolution of the canvas element)\r\n   */\r\n  public get canvasWidth(): number {\r\n    return this.screen.canvasWidth;\r\n  }\r\n\r\n  /**\r\n   * Returns half width of the game canvas in pixels (half physical width component)\r\n   */\r\n  public get halfCanvasWidth(): number {\r\n    return this.screen.halfCanvasWidth;\r\n  }\r\n\r\n  /**\r\n   * The height of the game canvas in pixels, (physical height component of\r\n   * the resolution of the canvas element)\r\n   */\r\n  public get canvasHeight(): number {\r\n    return this.screen.canvasHeight;\r\n  }\r\n\r\n  /**\r\n   * Returns half height of the game canvas in pixels (half physical height component)\r\n   */\r\n  public get halfCanvasHeight(): number {\r\n    return this.screen.halfCanvasHeight;\r\n  }\r\n\r\n  /**\r\n   * Returns the width of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get drawWidth(): number {\r\n    return this.screen.drawWidth;\r\n  }\r\n\r\n  /**\r\n   * Returns half the width of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get halfDrawWidth(): number {\r\n    return this.screen.halfDrawWidth;\r\n  }\r\n\r\n  /**\r\n   * Returns the height of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get drawHeight(): number {\r\n    return this.screen.drawHeight;\r\n  }\r\n\r\n  /**\r\n   * Returns half the height of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get halfDrawHeight(): number {\r\n    return this.screen.halfDrawHeight;\r\n  }\r\n\r\n  /**\r\n   * Returns whether excalibur detects the current screen to be HiDPI\r\n   */\r\n  public get isHiDpi(): boolean {\r\n    return this.screen.isHiDpi;\r\n  }\r\n\r\n  /**\r\n   * Access engine input like pointer, keyboard, or gamepad\r\n   */\r\n  public input: Input.EngineInput;\r\n\r\n  /**\r\n   * Access Excalibur debugging functionality.\r\n   *\r\n   * Useful when you want to debug different aspects of built in engine features like\r\n   *   * Transform\r\n   *   * Graphics\r\n   *   * Colliders\r\n   */\r\n  public debug: Debug;\r\n\r\n  /**\r\n   * Access [[stats]] that holds frame statistics.\r\n   */\r\n  public get stats(): DebugStats {\r\n    return this.debug.stats;\r\n  }\r\n\r\n  /**\r\n   * The current [[Scene]] being drawn and updated on screen\r\n   */\r\n  public currentScene: Scene;\r\n\r\n  /**\r\n   * The default [[Scene]] of the game, use [[Engine.goToScene]] to transition to different scenes.\r\n   */\r\n  public readonly rootScene: Scene;\r\n\r\n  /**\r\n   * Contains all the scenes currently registered with Excalibur\r\n   */\r\n  public readonly scenes: { [key: string]: Scene } = {};\r\n\r\n  /**\r\n   * Indicates whether the engine is set to fullscreen or not\r\n   */\r\n  public get isFullscreen(): boolean {\r\n    return this.screen.isFullScreen;\r\n  }\r\n\r\n  /**\r\n   * Indicates the current [[DisplayMode]] of the engine.\r\n   */\r\n  public get displayMode(): DisplayMode {\r\n    return this.screen.displayMode;\r\n  }\r\n\r\n  private _suppressPlayButton: boolean = false;\r\n  /**\r\n   * Returns the calculated pixel ration for use in rendering\r\n   */\r\n  public get pixelRatio(): number {\r\n    return this.screen.pixelRatio;\r\n  }\r\n\r\n  /**\r\n   * Indicates whether audio should be paused when the game is no longer visible.\r\n   */\r\n  public pauseAudioWhenHidden: boolean = true;\r\n\r\n  /**\r\n   * Indicates whether the engine should draw with debug information\r\n   */\r\n  private _isDebug: boolean = false;\r\n  public get isDebug(): boolean {\r\n    return this._isDebug;\r\n  }\r\n\r\n  /**\r\n   * Sets the background color for the engine.\r\n   */\r\n  public backgroundColor: Color;\r\n\r\n  /**\r\n   * Sets the Transparency for the engine.\r\n   */\r\n  public enableCanvasTransparency: boolean = true;\r\n\r\n  /**\r\n   * Hints the graphics context to truncate fractional world space coordinates\r\n   */\r\n  public get snapToPixel(): boolean {\r\n    return this.graphicsContext.snapToPixel;\r\n  };\r\n\r\n  public set snapToPixel(shouldSnapToPixel: boolean) {\r\n    this.graphicsContext.snapToPixel = shouldSnapToPixel;\r\n  };\r\n\r\n  /**\r\n   * The action to take when a fatal exception is thrown\r\n   */\r\n  public onFatalException = (e: any) => {\r\n    Logger.getInstance().fatal(e);\r\n  };\r\n\r\n  /**\r\n   * The mouse wheel scroll prevention mode\r\n   */\r\n  public pageScrollPreventionMode: ScrollPreventionMode;\r\n\r\n  private _logger: Logger;\r\n\r\n  private _toaster: Toaster = new Toaster();\r\n\r\n  // this determines whether excalibur is compatible with your browser\r\n  private _compatible: boolean;\r\n\r\n  private _timescale: number = 1.0;\r\n\r\n  // loading\r\n  private _loader: Loader;\r\n\r\n  private _isInitialized: boolean = false;\r\n\r\n  private _deferredGoTo: string = null;\r\n\r\n  public on(eventName: 'fallbackgraphicscontext', handler: (event: ExcaliburGraphicsContext2DCanvas) => void): void;\r\n  public on(eventName: Events.initialize, handler: (event: Events.InitializeEvent<Engine>) => void): void;\r\n  public on(eventName: Events.visible, handler: (event: VisibleEvent) => void): void;\r\n  public on(eventName: Events.hidden, handler: (event: HiddenEvent) => void): void;\r\n  public on(eventName: Events.start, handler: (event: GameStartEvent) => void): void;\r\n  public on(eventName: Events.stop, handler: (event: GameStopEvent) => void): void;\r\n  public on(eventName: Events.preupdate, handler: (event: PreUpdateEvent<Engine>) => void): void;\r\n  public on(eventName: Events.postupdate, handler: (event: PostUpdateEvent<Engine>) => void): void;\r\n  public on(eventName: Events.preframe, handler: (event: PreFrameEvent) => void): void;\r\n  public on(eventName: Events.postframe, handler: (event: PostFrameEvent) => void): void;\r\n  public on(eventName: Events.predraw, handler: (event: PreDrawEvent) => void): void;\r\n  public on(eventName: Events.postdraw, handler: (event: PostDrawEvent) => void): void;\r\n  public on(eventName: string, handler: (event: GameEvent<any>) => void): void;\r\n  public on(eventName: string, handler: (event: any) => void): void {\r\n    super.on(eventName, handler);\r\n  }\r\n\r\n  public once(eventName: 'fallbackgraphicscontext', handler: (event: ExcaliburGraphicsContext2DCanvas) => void): void;\r\n  public once(eventName: Events.initialize, handler: (event: Events.InitializeEvent<Engine>) => void): void;\r\n  public once(eventName: Events.visible, handler: (event: VisibleEvent) => void): void;\r\n  public once(eventName: Events.hidden, handler: (event: HiddenEvent) => void): void;\r\n  public once(eventName: Events.start, handler: (event: GameStartEvent) => void): void;\r\n  public once(eventName: Events.stop, handler: (event: GameStopEvent) => void): void;\r\n  public once(eventName: Events.preupdate, handler: (event: PreUpdateEvent<Engine>) => void): void;\r\n  public once(eventName: Events.postupdate, handler: (event: PostUpdateEvent<Engine>) => void): void;\r\n  public once(eventName: Events.preframe, handler: (event: PreFrameEvent) => void): void;\r\n  public once(eventName: Events.postframe, handler: (event: PostFrameEvent) => void): void;\r\n  public once(eventName: Events.predraw, handler: (event: PreDrawEvent) => void): void;\r\n  public once(eventName: Events.postdraw, handler: (event: PostDrawEvent) => void): void;\r\n  public once(eventName: string, handler: (event: GameEvent<any>) => void): void;\r\n  public once(eventName: string, handler: (event: any) => void): void {\r\n    super.once(eventName, handler);\r\n  }\r\n\r\n  public off(eventName: 'fallbackgraphicscontext', handler?: (event: ExcaliburGraphicsContext2DCanvas) => void): void;\r\n  public off(eventName: Events.initialize, handler?: (event: Events.InitializeEvent<Engine>) => void): void;\r\n  public off(eventName: Events.visible, handler?: (event: VisibleEvent) => void): void;\r\n  public off(eventName: Events.hidden, handler?: (event: HiddenEvent) => void): void;\r\n  public off(eventName: Events.start, handler?: (event: GameStartEvent) => void): void;\r\n  public off(eventName: Events.stop, handler?: (event: GameStopEvent) => void): void;\r\n  public off(eventName: Events.preupdate, handler?: (event: PreUpdateEvent<Engine>) => void): void;\r\n  public off(eventName: Events.postupdate, handler?: (event: PostUpdateEvent<Engine>) => void): void;\r\n  public off(eventName: Events.preframe, handler?: (event: PreFrameEvent) => void): void;\r\n  public off(eventName: Events.postframe, handler?: (event: PostFrameEvent) => void): void;\r\n  public off(eventName: Events.predraw, handler?: (event: PreDrawEvent) => void): void;\r\n  public off(eventName: Events.postdraw, handler?: (event: PostDrawEvent) => void): void;\r\n  public off(eventName: string, handler?: (event: GameEvent<any>) => void): void;\r\n  public off(eventName: string, handler?: (event: any) => void): void {\r\n    super.off(eventName, handler);\r\n  }\r\n\r\n  /**\r\n   * Default [[EngineOptions]]\r\n   */\r\n  private static _DEFAULT_ENGINE_OPTIONS: EngineOptions = {\r\n    width: 0,\r\n    height: 0,\r\n    enableCanvasTransparency: true,\r\n    useDrawSorting: true,\r\n    configurePerformanceCanvas2DFallback: {\r\n      allow: true,\r\n      showPlayerMessage: false,\r\n      threshold: { fps: 20, numberOfFrames: 100 }\r\n    },\r\n    canvasElementId: '',\r\n    canvasElement: undefined,\r\n    snapToPixel: false,\r\n    pointerScope: Input.PointerScope.Canvas,\r\n    suppressConsoleBootMessage: null,\r\n    suppressMinimumBrowserFeatureDetection: null,\r\n    suppressHiDPIScaling: null,\r\n    suppressPlayButton: null,\r\n    scrollPreventionMode: ScrollPreventionMode.Canvas,\r\n    backgroundColor: Color.fromHex('#2185d0') // Excalibur blue\r\n  };\r\n\r\n  private _originalOptions: EngineOptions = {};\r\n  public readonly _originalDisplayMode: DisplayMode;\r\n\r\n  /**\r\n   * Creates a new game using the given [[EngineOptions]]. By default, if no options are provided,\r\n   * the game will be rendered full screen (taking up all available browser window space).\r\n   * You can customize the game rendering through [[EngineOptions]].\r\n   *\r\n   * Example:\r\n   *\r\n   * ```js\r\n   * var game = new ex.Engine({\r\n   *   width: 0, // the width of the canvas\r\n   *   height: 0, // the height of the canvas\r\n   *   enableCanvasTransparency: true, // the transparencySection of the canvas\r\n   *   canvasElementId: '', // the DOM canvas element ID, if you are providing your own\r\n   *   displayMode: ex.DisplayMode.FullScreen, // the display mode\r\n   *   pointerScope: ex.Input.PointerScope.Document, // the scope of capturing pointer (mouse/touch) events\r\n   *   backgroundColor: ex.Color.fromHex('#2185d0') // background color of the engine\r\n   * });\r\n   *\r\n   * // call game.start, which is a Promise\r\n   * game.start().then(function () {\r\n   *   // ready, set, go!\r\n   * });\r\n   * ```\r\n   */\r\n  constructor(options?: EngineOptions) {\r\n    super();\r\n\r\n    options = { ...Engine._DEFAULT_ENGINE_OPTIONS, ...options };\r\n    this._originalOptions = options;\r\n\r\n    Flags.freeze();\r\n\r\n    // Initialize browser events facade\r\n    this.browser = new BrowserEvents(window, document);\r\n\r\n    // Check compatibility\r\n    const detector = new Detector();\r\n    if (!options.suppressMinimumBrowserFeatureDetection && !(this._compatible = detector.test())) {\r\n      const message = document.createElement('div');\r\n      message.innerText = 'Sorry, your browser does not support all the features needed for Excalibur';\r\n      document.body.appendChild(message);\r\n\r\n      detector.failedTests.forEach(function (test) {\r\n        const testMessage = document.createElement('div');\r\n        testMessage.innerText = 'Browser feature missing ' + test;\r\n        document.body.appendChild(testMessage);\r\n      });\r\n\r\n      if (options.canvasElementId) {\r\n        const canvas = document.getElementById(options.canvasElementId);\r\n        if (canvas) {\r\n          canvas.parentElement.removeChild(canvas);\r\n        }\r\n      }\r\n\r\n      return;\r\n    } else {\r\n      this._compatible = true;\r\n    }\r\n\r\n    // Use native console API for color fun\r\n    // eslint-disable-next-line no-console\r\n    if (console.log && !options.suppressConsoleBootMessage) {\r\n      // eslint-disable-next-line no-console\r\n      console.log(\r\n        `%cPowered by Excalibur.js (v${EX_VERSION})`,\r\n        'background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;'\r\n      );\r\n      // eslint-disable-next-line no-console\r\n      console.log('\\n\\\r\n      /| ________________\\n\\\r\nO|===|* >________________>\\n\\\r\n      \\\\|');\r\n      // eslint-disable-next-line no-console\r\n      console.log('Visit', 'http://excaliburjs.com', 'for more information');\r\n    }\r\n\r\n    // Suppress play button\r\n    if (options.suppressPlayButton) {\r\n      this._suppressPlayButton = true;\r\n    }\r\n\r\n    this._logger = Logger.getInstance();\r\n\r\n    // If debug is enabled, let's log browser features to the console.\r\n    if (this._logger.defaultLevel === LogLevel.Debug) {\r\n      detector.logBrowserFeatures();\r\n    }\r\n\r\n    this._logger.debug('Building engine...');\r\n\r\n    this.canvasElementId = options.canvasElementId;\r\n\r\n    if (options.canvasElementId) {\r\n      this._logger.debug('Using Canvas element specified: ' + options.canvasElementId);\r\n      this.canvas = <HTMLCanvasElement>document.getElementById(options.canvasElementId);\r\n    } else if (options.canvasElement) {\r\n      this._logger.debug('Using Canvas element specified:', options.canvasElement);\r\n      this.canvas = options.canvasElement;\r\n    } else {\r\n      this._logger.debug('Using generated canvas element');\r\n      this.canvas = <HTMLCanvasElement>document.createElement('canvas');\r\n    }\r\n\r\n    let displayMode = options.displayMode ?? DisplayMode.Fixed;\r\n    if ((options.width && options.height) || options.viewport) {\r\n      if (options.displayMode === undefined) {\r\n        displayMode = DisplayMode.Fixed;\r\n      }\r\n      this._logger.debug('Engine viewport is size ' + options.width + ' x ' + options.height);\r\n    } else if (!options.displayMode) {\r\n      this._logger.debug('Engine viewport is fit');\r\n      displayMode = DisplayMode.FitScreen;\r\n    }\r\n\r\n    this._originalDisplayMode = displayMode;\r\n\r\n    // Canvas 2D fallback can be flagged on\r\n    let useCanvasGraphicsContext = Flags.isEnabled('use-canvas-context');\r\n    if (!useCanvasGraphicsContext) {\r\n      // Attempt webgl first\r\n      try {\r\n        this.graphicsContext = new ExcaliburGraphicsContextWebGL({\r\n          canvasElement: this.canvas,\r\n          enableTransparency: this.enableCanvasTransparency,\r\n          smoothing: options.antialiasing,\r\n          backgroundColor: options.backgroundColor,\r\n          snapToPixel: options.snapToPixel,\r\n          useDrawSorting: options.useDrawSorting\r\n        });\r\n      } catch (e) {\r\n        this._logger.warn(\r\n          `Excalibur could not load webgl for some reason (${(e as Error).message}) and loaded a Canvas 2D fallback. ` +\r\n          `Some features of Excalibur will not work in this mode. \\n\\n` +\r\n          'Read more about this issue at https://excaliburjs.com/docs/webgl'\r\n        );\r\n        // fallback to canvas in case of failure\r\n        useCanvasGraphicsContext = true;\r\n      }\r\n    }\r\n\r\n    if (useCanvasGraphicsContext) {\r\n      this.graphicsContext = new ExcaliburGraphicsContext2DCanvas({\r\n        canvasElement: this.canvas,\r\n        enableTransparency: this.enableCanvasTransparency,\r\n        smoothing: options.antialiasing,\r\n        backgroundColor: options.backgroundColor,\r\n        snapToPixel: options.snapToPixel,\r\n        useDrawSorting: options.useDrawSorting\r\n      });\r\n    }\r\n\r\n    this.screen = new Screen({\r\n      canvas: this.canvas,\r\n      context: this.graphicsContext,\r\n      antialiasing: options.antialiasing ?? true,\r\n      browser: this.browser,\r\n      viewport: options.viewport ?? (options.width && options.height ? { width: options.width, height: options.height } : Resolution.SVGA),\r\n      resolution: options.resolution,\r\n      displayMode,\r\n      pixelRatio: options.suppressHiDPIScaling ? 1 : (options.pixelRatio ?? null)\r\n    });\r\n\r\n    // Set default filtering based on antialiasing\r\n    TextureLoader.filtering = options.antialiasing ? ImageFiltering.Blended : ImageFiltering.Pixel;\r\n\r\n    if (options.backgroundColor) {\r\n      this.backgroundColor = options.backgroundColor.clone();\r\n    }\r\n\r\n    this.maxFps = options.maxFps ?? this.maxFps;\r\n    this.fixedUpdateFps = options.fixedUpdateFps ?? this.fixedUpdateFps;\r\n\r\n    this.clock = new StandardClock({\r\n      maxFps: this.maxFps,\r\n      tick: this._mainloop.bind(this),\r\n      onFatalException: (e) => this.onFatalException(e)\r\n    });\r\n\r\n    this.enableCanvasTransparency = options.enableCanvasTransparency;\r\n\r\n    this._loader = new Loader();\r\n    this._loader.wireEngine(this);\r\n    this.debug = new Debug(this);\r\n\r\n    this._initialize(options);\r\n\r\n    this.rootScene = this.currentScene = new Scene();\r\n\r\n    this.addScene('root', this.rootScene);\r\n    (window as any).___EXCALIBUR_DEVTOOL = this;\r\n  }\r\n\r\n  private _performanceThresholdTriggered = false;\r\n  private _fpsSamples: number[] = [];\r\n  private _monitorPerformanceThresholdAndTriggerFallback() {\r\n    const { allow } = this._originalOptions.configurePerformanceCanvas2DFallback;\r\n    let { threshold, showPlayerMessage } = this._originalOptions.configurePerformanceCanvas2DFallback;\r\n    if (threshold === undefined) {\r\n      threshold = Engine._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.threshold;\r\n    }\r\n    if (showPlayerMessage === undefined) {\r\n      showPlayerMessage = Engine._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.showPlayerMessage;\r\n    }\r\n    if (!Flags.isEnabled('use-canvas-context') && allow && this.ready && !this._performanceThresholdTriggered) {\r\n      // Calculate Average fps for last X number of frames after start\r\n      if (this._fpsSamples.length === threshold.numberOfFrames) {\r\n        this._fpsSamples.splice(0, 1);\r\n      }\r\n      this._fpsSamples.push(this.clock.fpsSampler.fps);\r\n      let total = 0;\r\n      for (let i = 0; i < this._fpsSamples.length; i++) {\r\n        total += this._fpsSamples[i];\r\n      }\r\n      const average = total / this._fpsSamples.length;\r\n\r\n      if (this._fpsSamples.length === threshold.numberOfFrames) {\r\n        if (average <= threshold.fps) {\r\n          this._performanceThresholdTriggered = true;\r\n          this._logger.warn(\r\n            `Switching to browser 2D Canvas fallback due to performance. Some features of Excalibur will not work in this mode.\\n` +\r\n            'this might mean your browser doesn\\'t have webgl enabled or hardware acceleration is unavailable.\\n\\n' +\r\n            'If in Chrome:\\n' +\r\n            '  * Visit Settings > Advanced > System, and ensure \"Use Hardware Acceleration\" is checked.\\n'+\r\n            '  * Visit chrome://flags/#ignore-gpu-blocklist and ensure \"Override software rendering list\" is \"enabled\"\\n' +\r\n            'If in Firefox, visit about:config\\n' +\r\n            '  * Ensure webgl.disabled = false\\n' +\r\n            '  * Ensure webgl.force-enabled = true\\n' +\r\n            '  * Ensure layers.acceleration.force-enabled = true\\n\\n' +\r\n            'Read more about this issue at https://excaliburjs.com/docs/performance'\r\n          );\r\n\r\n          if (showPlayerMessage) {\r\n            this._toaster.toast(\r\n              'Excalibur is encountering performance issues. '+\r\n              'It\\'s possible that your browser doesn\\'t have hardware acceleration enabled. ' +\r\n              'Visit [LINK] for more information and potential solutions.',\r\n              'https://excaliburjs.com/docs/performance'\r\n            );\r\n          }\r\n          this.useCanvas2DFallback();\r\n          this.emit('fallbackgraphicscontext', this.graphicsContext);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Switches the engine's graphics context to the 2D Canvas.\r\n   * @warning Some features of Excalibur will not work in this mode.\r\n   */\r\n  public useCanvas2DFallback() {\r\n    // Swap out the canvas\r\n    const newCanvas = this.canvas.cloneNode(false) as HTMLCanvasElement;\r\n    this.canvas.parentNode.replaceChild(newCanvas, this.canvas);\r\n    this.canvas = newCanvas;\r\n\r\n    const options = this._originalOptions;\r\n    const displayMode = this._originalDisplayMode;\r\n\r\n    // New graphics context\r\n    this.graphicsContext = new ExcaliburGraphicsContext2DCanvas({\r\n      canvasElement: this.canvas,\r\n      enableTransparency: this.enableCanvasTransparency,\r\n      smoothing: options.antialiasing,\r\n      backgroundColor: options.backgroundColor,\r\n      snapToPixel: options.snapToPixel,\r\n      useDrawSorting: options.useDrawSorting\r\n    });\r\n\r\n    // Reset screen\r\n    if (this.screen) {\r\n      this.screen.dispose();\r\n    }\r\n\r\n    this.screen = new Screen({\r\n      canvas: this.canvas,\r\n      context: this.graphicsContext,\r\n      antialiasing: options.antialiasing ?? true,\r\n      browser: this.browser,\r\n      viewport: options.viewport ?? (options.width && options.height ? { width: options.width, height: options.height } : Resolution.SVGA),\r\n      resolution: options.resolution,\r\n      displayMode,\r\n      pixelRatio: options.suppressHiDPIScaling ? 1 : (options.pixelRatio ?? null)\r\n    });\r\n    this.screen.setCurrentCamera(this.currentScene.camera);\r\n\r\n    // Reset pointers\r\n    this.input.pointers.detach();\r\n    const pointerTarget = options && options.pointerScope === Input.PointerScope.Document ? document : this.canvas;\r\n    this.input.pointers = this.input.pointers.recreate(pointerTarget, this);\r\n    this.input.pointers.init();\r\n  }\r\n\r\n  /**\r\n   * Returns a BoundingBox of the top left corner of the screen\r\n   * and the bottom right corner of the screen.\r\n   */\r\n  public getWorldBounds() {\r\n    return this.screen.getWorldBounds();\r\n  }\r\n\r\n  /**\r\n   * Gets the current engine timescale factor (default is 1.0 which is 1:1 time)\r\n   */\r\n  public get timescale() {\r\n    return this._timescale;\r\n  }\r\n\r\n  /**\r\n   * Sets the current engine timescale factor. Useful for creating slow-motion effects or fast-forward effects\r\n   * when using time-based movement.\r\n   */\r\n  public set timescale(value: number) {\r\n    if (value <= 0) {\r\n      Logger.getInstance().error('Cannot set engine.timescale to a value of 0 or less than 0.');\r\n      return;\r\n    }\r\n\r\n    this._timescale = value;\r\n  }\r\n\r\n  /**\r\n   * Adds a [[Timer]] to the [[currentScene]].\r\n   * @param timer  The timer to add to the [[currentScene]].\r\n   */\r\n  public addTimer(timer: Timer): Timer {\r\n    return this.currentScene.addTimer(timer);\r\n  }\r\n\r\n  /**\r\n   * Removes a [[Timer]] from the [[currentScene]].\r\n   * @param timer  The timer to remove to the [[currentScene]].\r\n   */\r\n  public removeTimer(timer: Timer): Timer {\r\n    return this.currentScene.removeTimer(timer);\r\n  }\r\n\r\n  /**\r\n   * Adds a [[Scene]] to the engine, think of scenes in Excalibur as you\r\n   * would levels or menus.\r\n   *\r\n   * @param key  The name of the scene, must be unique\r\n   * @param scene The scene to add to the engine\r\n   */\r\n  public addScene(key: string, scene: Scene) {\r\n    if (this.scenes[key]) {\r\n      this._logger.warn('Scene', key, 'already exists overwriting');\r\n    }\r\n    this.scenes[key] = scene;\r\n  }\r\n\r\n  /**\r\n   * Removes a [[Scene]] instance from the engine\r\n   * @param scene  The scene to remove\r\n   */\r\n  public removeScene(scene: Scene): void;\r\n  /**\r\n   * Removes a scene from the engine by key\r\n   * @param key  The scene key to remove\r\n   */\r\n  public removeScene(key: string): void;\r\n  /**\r\n   * @internal\r\n   */\r\n  public removeScene(entity: any): void {\r\n    if (entity instanceof Scene) {\r\n      // remove scene\r\n      for (const key in this.scenes) {\r\n        if (this.scenes.hasOwnProperty(key)) {\r\n          if (this.scenes[key] === entity) {\r\n            delete this.scenes[key];\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if (typeof entity === 'string') {\r\n      // remove scene\r\n      delete this.scenes[entity];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adds a [[Scene]] to the engine, think of scenes in Excalibur as you\r\n   * would levels or menus.\r\n   * @param sceneKey  The key of the scene, must be unique\r\n   * @param scene     The scene to add to the engine\r\n   */\r\n  public add(sceneKey: string, scene: Scene): void;\r\n  /**\r\n   * Adds a [[Timer]] to the [[currentScene]].\r\n   * @param timer  The timer to add to the [[currentScene]].\r\n   */\r\n  public add(timer: Timer): void;\r\n  /**\r\n   * Adds a [[TileMap]] to the [[currentScene]], once this is done the TileMap\r\n   * will be drawn and updated.\r\n   */\r\n  public add(tileMap: TileMap): void;\r\n  /**\r\n   * Adds an actor to the [[currentScene]] of the game. This is synonymous\r\n   * to calling `engine.currentScene.add(actor)`.\r\n   *\r\n   * Actors can only be drawn if they are a member of a scene, and only\r\n   * the [[currentScene]] may be drawn or updated.\r\n   *\r\n   * @param actor  The actor to add to the [[currentScene]]\r\n   */\r\n  public add(actor: Actor): void;\r\n\r\n  public add(entity: Entity): void;\r\n\r\n  /**\r\n   * Adds a [[ScreenElement]] to the [[currentScene]] of the game,\r\n   * ScreenElements do not participate in collisions, instead the\r\n   * remain in the same place on the screen.\r\n   * @param screenElement  The ScreenElement to add to the [[currentScene]]\r\n   */\r\n  public add(screenElement: ScreenElement): void;\r\n  public add(entity: any): void {\r\n    if (arguments.length === 2) {\r\n      this.addScene(<string>arguments[0], <Scene>arguments[1]);\r\n      return;\r\n    }\r\n    if (this._deferredGoTo && this.scenes[this._deferredGoTo]) {\r\n      this.scenes[this._deferredGoTo].add(entity);\r\n    } else {\r\n      this.currentScene.add(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes a scene instance from the engine\r\n   * @param scene  The scene to remove\r\n   */\r\n  public remove(scene: Scene): void;\r\n  /**\r\n   * Removes a scene from the engine by key\r\n   * @param sceneKey  The scene to remove\r\n   */\r\n  public remove(sceneKey: string): void;\r\n  /**\r\n   * Removes a [[Timer]] from the [[currentScene]].\r\n   * @param timer  The timer to remove to the [[currentScene]].\r\n   */\r\n  public remove(timer: Timer): void;\r\n  /**\r\n   * Removes a [[TileMap]] from the [[currentScene]], it will no longer be drawn or updated.\r\n   */\r\n  public remove(tileMap: TileMap): void;\r\n  /**\r\n   * Removes an actor from the [[currentScene]] of the game. This is synonymous\r\n   * to calling `engine.currentScene.removeChild(actor)`.\r\n   * Actors that are removed from a scene will no longer be drawn or updated.\r\n   *\r\n   * @param actor  The actor to remove from the [[currentScene]].\r\n   */\r\n  public remove(actor: Actor): void;\r\n  /**\r\n   * Removes a [[ScreenElement]] to the scene, it will no longer be drawn or updated\r\n   * @param screenElement  The ScreenElement to remove from the [[currentScene]]\r\n   */\r\n  public remove(screenElement: ScreenElement): void;\r\n  public remove(entity: any): void {\r\n    if (entity instanceof Entity) {\r\n      this.currentScene.remove(entity);\r\n    }\r\n\r\n    if (entity instanceof Scene) {\r\n      this.removeScene(entity);\r\n    }\r\n\r\n    if (typeof entity === 'string') {\r\n      this.removeScene(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Changes the currently updating and drawing scene to a different,\r\n   * named scene. Calls the [[Scene]] lifecycle events.\r\n   * @param key  The key of the scene to transition to.\r\n   * @param data Optional data to send to the scene's onActivate method\r\n   */\r\n  public goToScene<TData = undefined>(key: string, data?: TData): void {\r\n    // if not yet initialized defer goToScene\r\n    if (!this.isInitialized) {\r\n      this._deferredGoTo = key;\r\n      return;\r\n    }\r\n\r\n    if (this.scenes[key]) {\r\n      const previousScene = this.currentScene;\r\n      const nextScene = this.scenes[key];\r\n\r\n      this._logger.debug('Going to scene:', key);\r\n\r\n      // only deactivate when initialized\r\n      if (this.currentScene.isInitialized) {\r\n        const context = { engine: this, previousScene, nextScene };\r\n        this.currentScene._deactivate.apply(this.currentScene, [context, nextScene]);\r\n        this.currentScene.eventDispatcher.emit('deactivate', new DeactivateEvent(context, this.currentScene));\r\n      }\r\n\r\n      // set current scene to new one\r\n      this.currentScene = nextScene;\r\n      this.screen.setCurrentCamera(nextScene.camera);\r\n\r\n      // initialize the current scene if has not been already\r\n      this.currentScene._initialize(this);\r\n\r\n      const context = { engine: this, previousScene, nextScene, data };\r\n      this.currentScene._activate.apply(this.currentScene, [context, nextScene]);\r\n      this.currentScene.eventDispatcher.emit('activate', new ActivateEvent(context, this.currentScene));\r\n    } else {\r\n      this._logger.error('Scene', key, 'does not exist!');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Transforms the current x, y from screen coordinates to world coordinates\r\n   * @param point  Screen coordinate to convert\r\n   */\r\n  public screenToWorldCoordinates(point: Vector): Vector {\r\n    return this.screen.screenToWorldCoordinates(point);\r\n  }\r\n\r\n  /**\r\n   * Transforms a world coordinate, to a screen coordinate\r\n   * @param point  World coordinate to convert\r\n   */\r\n  public worldToScreenCoordinates(point: Vector): Vector {\r\n    return this.screen.worldToScreenCoordinates(point);\r\n  }\r\n\r\n  /**\r\n   * Initializes the internal canvas, rendering context, display mode, and native event listeners\r\n   */\r\n  private _initialize(options?: EngineOptions) {\r\n    this.pageScrollPreventionMode = options.scrollPreventionMode;\r\n\r\n    // initialize inputs\r\n    const pointerTarget = options && options.pointerScope === Input.PointerScope.Document ? document : this.canvas;\r\n    this.input = {\r\n      keyboard: new Input.Keyboard(),\r\n      pointers: new PointerEventReceiver(pointerTarget, this),\r\n      gamepads: new Input.Gamepads()\r\n    };\r\n    this.input.keyboard.init();\r\n    this.input.pointers.init();\r\n    this.input.gamepads.init();\r\n\r\n    // Issue #385 make use of the visibility api\r\n    // https://developer.mozilla.org/en-US/docs/Web/Guide/User_experience/Using_the_Page_Visibility_API\r\n\r\n    let hidden: keyof HTMLDocument, visibilityChange: string;\r\n    if (typeof document.hidden !== 'undefined') {\r\n      // Opera 12.10 and Firefox 18 and later support\r\n      hidden = 'hidden';\r\n      visibilityChange = 'visibilitychange';\r\n    } else if ('msHidden' in document) {\r\n      hidden = <keyof HTMLDocument>'msHidden';\r\n      visibilityChange = 'msvisibilitychange';\r\n    } else if ('webkitHidden' in document) {\r\n      hidden = <keyof HTMLDocument>'webkitHidden';\r\n      visibilityChange = 'webkitvisibilitychange';\r\n    }\r\n\r\n    this.browser.document.on(visibilityChange, () => {\r\n      if (document[hidden]) {\r\n        this.eventDispatcher.emit('hidden', new HiddenEvent(this));\r\n        this._logger.debug('Window hidden');\r\n      } else {\r\n        this.eventDispatcher.emit('visible', new VisibleEvent(this));\r\n        this._logger.debug('Window visible');\r\n      }\r\n    });\r\n\r\n    if (!this.canvasElementId && !options.canvasElement) {\r\n      document.body.appendChild(this.canvas);\r\n    }\r\n  }\r\n\r\n  public onInitialize(_engine: Engine) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * If supported by the browser, this will set the antialiasing flag on the\r\n   * canvas. Set this to `false` if you want a 'jagged' pixel art look to your\r\n   * image resources.\r\n   * @param isSmooth  Set smoothing to true or false\r\n   */\r\n  public setAntialiasing(isSmooth: boolean) {\r\n    this.screen.antialiasing = isSmooth;\r\n  }\r\n\r\n  /**\r\n   * Return the current smoothing status of the canvas\r\n   */\r\n  public getAntialiasing(): boolean {\r\n    return this.screen.antialiasing;\r\n  }\r\n\r\n  /**\r\n   * Gets whether the actor is Initialized\r\n   */\r\n  public get isInitialized(): boolean {\r\n    return this._isInitialized;\r\n  }\r\n\r\n  private _overrideInitialize(engine: Engine) {\r\n    if (!this.isInitialized) {\r\n      this.onInitialize(engine);\r\n      super.emit('initialize', new InitializeEvent(engine, this));\r\n      this._isInitialized = true;\r\n      if (this._deferredGoTo) {\r\n        const deferredScene = this._deferredGoTo;\r\n        this._deferredGoTo = null;\r\n        this.goToScene(deferredScene);\r\n      } else {\r\n        this.goToScene('root');\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Updates the entire state of the game\r\n   * @param delta  Number of milliseconds elapsed since the last update.\r\n   */\r\n  private _update(delta: number) {\r\n    if (!this.ready) {\r\n      // suspend updates until loading is finished\r\n      this._loader.update(this, delta);\r\n      // Update input listeners\r\n      this.input.keyboard.update();\r\n      this.input.gamepads.update();\r\n      return;\r\n    }\r\n\r\n\r\n    // Publish preupdate events\r\n    this._preupdate(delta);\r\n\r\n    // process engine level events\r\n    this.currentScene.update(this, delta);\r\n\r\n    // Publish update event\r\n    this._postupdate(delta);\r\n\r\n    // Update input listeners\r\n    this.input.keyboard.update();\r\n    this.input.gamepads.update();\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  public _preupdate(delta: number) {\r\n    this.emit('preupdate', new PreUpdateEvent(this, delta, this));\r\n    this.onPreUpdate(this, delta);\r\n  }\r\n\r\n  public onPreUpdate(_engine: Engine, _delta: number) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  public _postupdate(delta: number) {\r\n    this.emit('postupdate', new PostUpdateEvent(this, delta, this));\r\n    this.onPostUpdate(this, delta);\r\n  }\r\n\r\n  public onPostUpdate(_engine: Engine, _delta: number) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Draws the entire game\r\n   * @param delta  Number of milliseconds elapsed since the last draw.\r\n   */\r\n  private _draw(delta: number) {\r\n    this.graphicsContext.beginDrawLifecycle();\r\n    this.graphicsContext.clear();\r\n    this._predraw(this.graphicsContext, delta);\r\n\r\n    // Drawing nothing else while loading\r\n    if (!this._isReady) {\r\n      this._loader.canvas.draw(this.graphicsContext, 0, 0);\r\n      this.graphicsContext.flush();\r\n      return;\r\n    }\r\n\r\n    this.graphicsContext.backgroundColor = this.backgroundColor;\r\n\r\n    this.currentScene.draw(this.graphicsContext, delta);\r\n\r\n    this._postdraw(this.graphicsContext, delta);\r\n\r\n    // Flush any pending drawings\r\n    this.graphicsContext.flush();\r\n    this.graphicsContext.endDrawLifecycle();\r\n\r\n    this._checkForScreenShots();\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  public _predraw(_ctx: ExcaliburGraphicsContext, delta: number) {\r\n    this.emit('predraw', new PreDrawEvent(_ctx, delta, this));\r\n    this.onPreDraw(_ctx, delta);\r\n  }\r\n\r\n  public onPreDraw(_ctx: ExcaliburGraphicsContext, _delta: number) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  public _postdraw(_ctx: ExcaliburGraphicsContext, delta: number) {\r\n    this.emit('postdraw', new PostDrawEvent(_ctx, delta, this));\r\n    this.onPostDraw(_ctx, delta);\r\n  }\r\n\r\n  public onPostDraw(_ctx: ExcaliburGraphicsContext, _delta: number) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Enable or disable Excalibur debugging functionality.\r\n   * @param toggle a value that debug drawing will be changed to\r\n   */\r\n  public showDebug(toggle: boolean): void {\r\n    this._isDebug = toggle;\r\n  }\r\n\r\n  /**\r\n   * Toggle Excalibur debugging functionality.\r\n   */\r\n  public toggleDebug(): boolean {\r\n    this._isDebug = !this._isDebug;\r\n    return this._isDebug;\r\n  }\r\n\r\n  private _loadingComplete: boolean = false;\r\n\r\n  /**\r\n   * Returns true when loading is totally complete and the player has clicked start\r\n   */\r\n  public get loadingComplete() {\r\n    return this._loadingComplete;\r\n  }\r\n\r\n  private _isReady = false;\r\n  public get ready() {\r\n    return this._isReady;\r\n  }\r\n  private _isReadyResolve: () => any;\r\n  private _isReadyPromise = new Promise<void>(resolve => {\r\n    this._isReadyResolve = resolve;\r\n  });\r\n  public isReady(): Promise<void> {\r\n    return this._isReadyPromise;\r\n  }\r\n\r\n\r\n  /**\r\n   * Starts the internal game loop for Excalibur after loading\r\n   * any provided assets.\r\n   * @param loader  Optional [[Loader]] to use to load resources. The default loader is [[Loader]], override to provide your own\r\n   * custom loader.\r\n   *\r\n   * Note: start() only resolves AFTER the user has clicked the play button\r\n   */\r\n  public async start(loader?: Loader): Promise<void> {\r\n    if (!this._compatible) {\r\n      throw new Error('Excalibur is incompatible with your browser');\r\n    }\r\n\r\n    // Wire loader if we have it\r\n    if (loader) {\r\n      // Push the current user entered resolution/viewport\r\n      this.screen.pushResolutionAndViewport();\r\n\r\n      // Configure resolution for loader, it expects resolution === viewport\r\n      this.screen.resolution = this.screen.viewport;\r\n      this.screen.applyResolutionAndViewport();\r\n      this._loader = loader;\r\n      this._loader.suppressPlayButton = this._suppressPlayButton || this._loader.suppressPlayButton;\r\n      this._loader.wireEngine(this);\r\n    }\r\n\r\n    // Start the excalibur clock which drives the mainloop\r\n    // has started is a slight misnomer, it's really mainloop started\r\n    this._logger.debug('Starting game clock...');\r\n    this.browser.resume();\r\n    this.clock.start();\r\n    this._logger.debug('Game clock started');\r\n\r\n    if (loader) {\r\n      await this.load(this._loader);\r\n      this._loadingComplete = true;\r\n\r\n      // reset back to previous user resolution/viewport\r\n      this.screen.popResolutionAndViewport();\r\n      this.screen.applyResolutionAndViewport();\r\n    }\r\n\r\n    this._loadingComplete = true;\r\n\r\n    // Initialize before ready\r\n    this._overrideInitialize(this);\r\n\r\n    this._isReady = true;\r\n\r\n    this._isReadyResolve();\r\n    this.emit('start', new GameStartEvent(this));\r\n    return this._isReadyPromise;\r\n  }\r\n\r\n  /**\r\n   * Returns the current frames elapsed milliseconds\r\n   */\r\n  public currentFrameElapsedMs = 0;\r\n\r\n  /**\r\n   * Returns the current frame lag when in fixed update mode\r\n   */\r\n  public currentFrameLagMs = 0;\r\n\r\n  private _lagMs = 0;\r\n  private _mainloop(elapsed: number) {\r\n    this.emit('preframe', new PreFrameEvent(this, this.stats.prevFrame));\r\n    const delta = elapsed * this.timescale;\r\n    this.currentFrameElapsedMs = delta;\r\n\r\n    // reset frame stats (reuse existing instances)\r\n    const frameId = this.stats.prevFrame.id + 1;\r\n    this.stats.currFrame.reset();\r\n    this.stats.currFrame.id = frameId;\r\n    this.stats.currFrame.delta = delta;\r\n    this.stats.currFrame.fps = this.clock.fpsSampler.fps;\r\n    GraphicsDiagnostics.clear();\r\n\r\n    const beforeUpdate = this.clock.now();\r\n    const fixedTimestepMs = 1000 / this.fixedUpdateFps;\r\n    if (this.fixedUpdateFps) {\r\n      this._lagMs += delta;\r\n      while (this._lagMs >= fixedTimestepMs) {\r\n        this._update(fixedTimestepMs);\r\n        this._lagMs -= fixedTimestepMs;\r\n      }\r\n    } else {\r\n      this._update(delta);\r\n    }\r\n    const afterUpdate = this.clock.now();\r\n    this.currentFrameLagMs = this._lagMs;\r\n    this._draw(delta);\r\n    const afterDraw = this.clock.now();\r\n\r\n    this.stats.currFrame.duration.update = afterUpdate - beforeUpdate;\r\n    this.stats.currFrame.duration.draw = afterDraw - afterUpdate;\r\n    this.stats.currFrame.graphics.drawnImages = GraphicsDiagnostics.DrawnImagesCount;\r\n    this.stats.currFrame.graphics.drawCalls = GraphicsDiagnostics.DrawCallCount;\r\n\r\n    this.emit('postframe', new PostFrameEvent(this, this.stats.currFrame));\r\n    this.stats.prevFrame.reset(this.stats.currFrame);\r\n\r\n    this._monitorPerformanceThresholdAndTriggerFallback();\r\n  }\r\n\r\n  /**\r\n   * Stops Excalibur's main loop, useful for pausing the game.\r\n   */\r\n  public stop() {\r\n    if (this.clock.isRunning()) {\r\n      this.emit('stop', new GameStopEvent(this));\r\n      this.browser.pause();\r\n      this.clock.stop();\r\n      this._logger.debug('Game stopped');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns the Engine's running status, Useful for checking whether engine is running or paused.\r\n   */\r\n  public isRunning() {\r\n    return this.clock.isRunning();\r\n  }\r\n\r\n\r\n  private _screenShotRequests: { preserveHiDPIResolution: boolean, resolve: (image: HTMLImageElement) => void }[] = [];\r\n  /**\r\n   * Takes a screen shot of the current viewport and returns it as an\r\n   * HTML Image Element.\r\n   * @param preserveHiDPIResolution in the case of HiDPI return the full scaled backing image, by default false\r\n   */\r\n  public screenshot(preserveHiDPIResolution = false): Promise<HTMLImageElement> {\r\n    const screenShotPromise = new Promise<HTMLImageElement>((resolve) => {\r\n      this._screenShotRequests.push({preserveHiDPIResolution, resolve});\r\n    });\r\n    return screenShotPromise;\r\n  }\r\n\r\n  private _checkForScreenShots() {\r\n    // We must grab the draw buffer before we yield to the browser\r\n    // the draw buffer is cleared after compositing\r\n    // the reason for the asynchrony is setting `preserveDrawingBuffer: true`\r\n    // forces the browser to copy buffers which can have a mass perf impact on mobile\r\n    for (const request of this._screenShotRequests) {\r\n      const finalWidth = request.preserveHiDPIResolution ? this.canvas.width : this.screen.resolution.width;\r\n      const finalHeight = request.preserveHiDPIResolution ? this.canvas.height : this.screen.resolution.height;\r\n      const screenshot = document.createElement('canvas');\r\n      screenshot.width = finalWidth;\r\n      screenshot.height = finalHeight;\r\n      const ctx = screenshot.getContext('2d');\r\n      ctx.drawImage(this.canvas, 0, 0, finalWidth, finalHeight);\r\n\r\n      const result = new Image();\r\n      const raw = screenshot.toDataURL('image/png');\r\n      result.src = raw;\r\n      request.resolve(result);\r\n    }\r\n    // Reset state\r\n    this._screenShotRequests.length = 0;\r\n  }\r\n\r\n  /**\r\n   * Another option available to you to load resources into the game.\r\n   * Immediately after calling this the game will pause and the loading screen\r\n   * will appear.\r\n   * @param loader  Some [[Loadable]] such as a [[Loader]] collection, [[Sound]], or [[Texture]].\r\n   */\r\n  public async load(loader: Loadable<any>): Promise<void> {\r\n    try {\r\n      await loader.load();\r\n    } catch (e) {\r\n      this._logger.error('Error loading resources, things may not behave properly', e);\r\n      await Promise.resolve();\r\n    }\r\n  }\r\n}","import toasterCss from './Toaster.css';\r\n\r\n/**\r\n * The Toaster is only meant to be called from inside Excalibur to display messages to players\r\n */\r\nexport class Toaster {\r\n  private _styleBlock: HTMLStyleElement;\r\n  private _container: HTMLDivElement;\r\n  private _toasterCss: string = toasterCss.toString();\r\n\r\n  private _isInitialized = false;\r\n  private _initialize() {\r\n    if (!this._isInitialized) {\r\n      this._container = document.createElement('div');\r\n      this._container.id = 'ex-toast-container';\r\n      document.body.appendChild(this._container);\r\n      this._isInitialized = true;\r\n\r\n      this._styleBlock = document.createElement('style');\r\n      this._styleBlock.textContent = this._toasterCss;\r\n      document.head.appendChild(this._styleBlock);\r\n    }\r\n  }\r\n\r\n  public dispose() {\r\n    this._container.parentElement.removeChild(this._container);\r\n\r\n    this._styleBlock.parentElement.removeChild(this._styleBlock);\r\n\r\n    this._isInitialized = false;\r\n  }\r\n\r\n  private _createFragment(message: string) {\r\n    const toastMessage = document.createElement('span');\r\n    toastMessage.innerText = message;\r\n    return toastMessage;\r\n  }\r\n\r\n  /**\r\n   * Display a toast message to a player\r\n   * @param message Text of the message, messages may have a single \"[LINK]\" to influence placement\r\n   * @param linkTarget Optionally specify a link location\r\n   * @param linkName Optionally specify a name for that link location\r\n   */\r\n  public toast(message: string, linkTarget?: string, linkName?: string) {\r\n    this._initialize();\r\n    const toast = document.createElement('div');\r\n    toast.className = 'ex-toast-message';\r\n\r\n    const messageFragments: HTMLElement[] = message.split('[LINK]').map(message => this._createFragment(message));\r\n\r\n    if (linkTarget) {\r\n      const link = document.createElement('a');\r\n      link.href = linkTarget;\r\n      if (linkName) {\r\n        link.innerText = linkName;\r\n      } else {\r\n        link.innerText = linkTarget;\r\n      }\r\n      messageFragments.splice(1, 0, link);\r\n    }\r\n\r\n    // Assembly message\r\n    const finalMessage = document.createElement('div');\r\n    messageFragments.forEach(message => {\r\n      finalMessage.appendChild(message);\r\n    });\r\n    toast.appendChild(finalMessage);\r\n\r\n    // Dismiss button\r\n    const dismissBtn = document.createElement('button');\r\n    dismissBtn.innerText = 'x';\r\n    dismissBtn.addEventListener('click', () => {\r\n      this._container.removeChild(toast);\r\n    });\r\n    toast.appendChild(dismissBtn);\r\n\r\n    // Escape to dismiss\r\n    const keydownHandler = (evt: KeyboardEvent) => {\r\n      if (evt.key === 'Escape') {\r\n        try {\r\n          this._container.removeChild(toast);\r\n        } catch {\r\n          // pass\r\n        }\r\n      }\r\n      document.removeEventListener('keydown', keydownHandler);\r\n    };\r\n    document.addEventListener('keydown', keydownHandler);\r\n\r\n    // Insert into container\r\n    const first = this._container.firstChild;\r\n    this._container.insertBefore(toast, first);\r\n  }\r\n}","import { Engine } from './Engine';\r\nimport { Color } from './Color';\r\nimport { vec, Vector } from './Math/vector';\r\nimport { Text } from './Graphics/Text';\r\nimport { GraphicsComponent, SpriteFont } from './Graphics';\r\nimport { Font } from './Graphics/Font';\r\nimport { Actor } from './Actor';\r\nimport { ActorArgs } from '.';\r\n\r\n/**\r\n * Option for creating a label\r\n */\r\nexport interface LabelOptions {\r\n  /**\r\n   * Specify the label text\r\n   */\r\n  text?: string;\r\n  /**\r\n   * Specify the color of the text (does not apply to SpriteFonts)\r\n   */\r\n  color?: Color;\r\n  x?: number;\r\n  y?: number;\r\n  pos?: Vector;\r\n  /**\r\n   * Optionally specify a sprite font, will take precedence over any other [[Font]]\r\n   */\r\n  spriteFont?: SpriteFont;\r\n  /**\r\n   * Specify a custom font\r\n   */\r\n  font?: Font\r\n}\r\n\r\n/**\r\n * Labels are the way to draw small amounts of text to the screen. They are\r\n * actors and inherit all of the benefits and capabilities.\r\n */\r\nexport class Label extends Actor {\r\n  private _font: Font = new Font();\r\n  private _text: Text = new Text({ text: '', font: this._font });\r\n\r\n  public get font(): Font {\r\n    return this._font;\r\n  }\r\n\r\n  public set font(newFont: Font) {\r\n    this._font = newFont;\r\n    this._text.font = newFont;\r\n  }\r\n\r\n  /**\r\n   * The text to draw.\r\n   */\r\n  public get text(): string {\r\n    return this._text.text;\r\n  }\r\n\r\n  public set text(text: string) {\r\n    this._text.text = text;\r\n  }\r\n\r\n  public override get color(): Color {\r\n    return this._text.color;\r\n  }\r\n\r\n  public override set color(color: Color) {\r\n    if (this._text) {\r\n      this._text.color = color;\r\n    }\r\n  }\r\n\r\n  public get opacity(): number {\r\n    return this._text.opacity;\r\n  }\r\n\r\n  public set opacity(opacity: number) {\r\n    this._text.opacity = opacity;\r\n  }\r\n\r\n  private _spriteFont: SpriteFont;\r\n  /**\r\n   * The [[SpriteFont]] to use, if any. Overrides [[Font|font]] if present.\r\n   */\r\n  public get spriteFont(): SpriteFont {\r\n    return this._spriteFont;\r\n  }\r\n\r\n  public set spriteFont(sf: SpriteFont) {\r\n    if (sf) {\r\n      this._spriteFont = sf;\r\n      this._text.font = this._spriteFont;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Build a new label\r\n   * @param options\r\n   */\r\n  constructor(options?: LabelOptions & ActorArgs) {\r\n    super(options);\r\n    const {text, pos, x, y, spriteFont, font, color} = options;\r\n\r\n    this.pos = pos ?? (x && y ? vec(x, y) : this.pos);\r\n    this.text = text ?? this.text;\r\n    this.font = font ?? this.font;\r\n    this.spriteFont = spriteFont ?? this.spriteFont;\r\n    this._text.color = color ?? this.color;\r\n    const gfx = this.get(GraphicsComponent);\r\n    gfx.anchor = Vector.Zero;\r\n    gfx.use(this._text);\r\n  }\r\n\r\n  public _initialize(engine: Engine) {\r\n    super._initialize(engine);\r\n  }\r\n\r\n  /**\r\n   * Returns the width of the text in the label (in pixels);\r\n   */\r\n  public getTextWidth(): number {\r\n    return this._text.width;\r\n  }\r\n}\r\n","import { BodyComponent, BoundingBox, Collider, ColliderComponent, CollisionType, Color, CompositeCollider, vec, Vector } from '..';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity } from '../EntityComponentSystem/Entity';\r\nimport { DebugGraphicsComponent, ExcaliburGraphicsContext, Graphic, GraphicsComponent } from '../Graphics';\r\nimport { IsometricEntityComponent } from './IsometricEntityComponent';\r\n\r\nexport class IsometricTile extends Entity {\r\n  /**\r\n   * Indicates whether this tile is solid\r\n   */\r\n  public solid: boolean = false;\r\n\r\n  private _gfx: GraphicsComponent;\r\n  private _tileBounds = new BoundingBox();\r\n  private _graphics: Graphic[] = [];\r\n  public getGraphics(): readonly Graphic[] {\r\n    return this._graphics;\r\n  }\r\n  /**\r\n   * Tile graphics\r\n   */\r\n  public addGraphic(graphic: Graphic) {\r\n    this._graphics.push(graphic);\r\n    this._gfx.visible = true;\r\n    this._gfx.localBounds = this._recalculateBounds();\r\n  }\r\n\r\n  private _recalculateBounds(): BoundingBox {\r\n    let bounds = this._tileBounds.clone();\r\n    for (const graphic of this._graphics) {\r\n      const offset = vec(\r\n        this.map.graphicsOffset.x - this.map.tileWidth / 2,\r\n        this.map.graphicsOffset.y - (this.map.renderFromTopOfGraphic ? 0 : (graphic.height - this.map.tileHeight)));\r\n      bounds = bounds.combine(graphic.localBounds.translate(offset));\r\n    }\r\n    return bounds;\r\n  }\r\n\r\n  public removeGraphic(graphic: Graphic) {\r\n    const index = this._graphics.indexOf(graphic);\r\n    if (index > -1) {\r\n      this._graphics.splice(index, 1);\r\n    }\r\n    this._gfx.localBounds = this._recalculateBounds();\r\n  }\r\n\r\n  public clearGraphics() {\r\n    this._graphics.length = 0;\r\n    this._gfx.visible = false;\r\n    this._gfx.localBounds = this._recalculateBounds();\r\n  }\r\n\r\n  /**\r\n   * Tile colliders\r\n   */\r\n  private _colliders: Collider[] = [];\r\n  public getColliders(): readonly Collider[] {\r\n    return this._colliders;\r\n  }\r\n\r\n  /**\r\n   * Adds a collider to the IsometricTile\r\n   *\r\n   * **Note!** the [[Tile.solid]] must be set to true for it to act as a \"fixed\" collider\r\n   * @param collider\r\n   */\r\n  public addCollider(collider: Collider) {\r\n    this._colliders.push(collider);\r\n    this.map.flagCollidersDirty();\r\n  }\r\n\r\n  /**\r\n   * Removes a collider from the IsometricTile\r\n   * @param collider\r\n   */\r\n  public removeCollider(collider: Collider) {\r\n    const index = this._colliders.indexOf(collider);\r\n    if (index > -1) {\r\n      this._colliders.splice(index, 1);\r\n    }\r\n    this.map.flagCollidersDirty();\r\n  }\r\n\r\n  /**\r\n   * Clears all colliders from the IsometricTile\r\n   */\r\n  public clearColliders(): void {\r\n    this._colliders.length = 0;\r\n    this.map.flagCollidersDirty();\r\n  }\r\n\r\n  /**\r\n   * Integer tile x coordinate\r\n   */\r\n  public readonly x: number;\r\n  /**\r\n   * Integer tile y coordinate\r\n   */\r\n  public readonly y: number;\r\n  /**\r\n   * Reference to the [[IsometricMap]] this tile is part of\r\n   */\r\n  public readonly map: IsometricMap;\r\n\r\n  private _transform: TransformComponent;\r\n  private _isometricEntityComponent: IsometricEntityComponent;\r\n\r\n  /**\r\n   * Returns the top left corner of the [[IsometricTile]] in world space\r\n   */\r\n  public get pos(): Vector {\r\n    return this.map.tileToWorld(vec(this.x, this.y));\r\n  }\r\n\r\n  /**\r\n   * Returns the center of the [[IsometricTile]]\r\n   */\r\n  public get center(): Vector {\r\n    return this.pos.add(vec(0, this.map.tileHeight / 2));\r\n  }\r\n\r\n  /**\r\n   * Construct a new IsometricTile\r\n   * @param x tile coordinate in x (not world position)\r\n   * @param y tile coordinate in y (not world position)\r\n   * @param graphicsOffset offset that tile should be shifted by (default (0, 0))\r\n   * @param map reference to owning IsometricMap\r\n   */\r\n  constructor(x: number, y: number, graphicsOffset: Vector | null, map: IsometricMap) {\r\n    super([\r\n      new TransformComponent(),\r\n      new GraphicsComponent({\r\n        offset: graphicsOffset ?? Vector.Zero,\r\n        onPostDraw: (gfx, elapsed) => this.draw(gfx, elapsed)\r\n      }),\r\n      new IsometricEntityComponent(map)\r\n    ]);\r\n    this.x = x;\r\n    this.y = y;\r\n    this.map = map;\r\n    this._transform = this.get(TransformComponent);\r\n    this._isometricEntityComponent = this.get(IsometricEntityComponent);\r\n\r\n    const halfTileWidth = this.map.tileWidth / 2;\r\n    const halfTileHeight = this.map.tileHeight / 2;\r\n    // See https://clintbellanger.net/articles/isometric_math/ for formula\r\n    // The x position shifts left with every y step\r\n    const xPos = (this.x - this.y) * halfTileWidth;\r\n    // The y position needs to go down with every x step\r\n    const yPos = (this.x + this.y) * halfTileHeight;\r\n    this._transform.pos = vec(xPos, yPos);\r\n    this._isometricEntityComponent.elevation = 0;\r\n\r\n    this._gfx = this.get(GraphicsComponent);\r\n    this._gfx.visible = false; // start not visible\r\n    const totalWidth = this.map.tileWidth;\r\n    const totalHeight = this.map.tileHeight;\r\n\r\n    // initial guess at gfx bounds based on the tile\r\n    const offset = vec(0, (this.map.renderFromTopOfGraphic ? totalHeight : 0));\r\n    this._gfx.localBounds = this._tileBounds = new BoundingBox({\r\n      left: -totalWidth / 2,\r\n      top: -totalHeight,\r\n      right: totalWidth / 2,\r\n      bottom: totalHeight\r\n    }).translate(offset);\r\n  }\r\n\r\n  draw(gfx: ExcaliburGraphicsContext, _elapsed: number) {\r\n    const halfTileWidth = this.map.tileWidth / 2;\r\n    gfx.save();\r\n    // shift left origin to corner of map, not the left corner of the first sprite\r\n    gfx.translate(-halfTileWidth, 0);\r\n    for (const graphic of this._graphics) {\r\n      graphic.draw(\r\n        gfx,\r\n        this.map.graphicsOffset.x,\r\n        this.map.graphicsOffset.y - (this.map.renderFromTopOfGraphic ? 0 : (graphic.height - this.map.tileHeight)));\r\n    }\r\n    gfx.restore();\r\n  }\r\n}\r\n\r\nexport interface IsometricMapOptions {\r\n  /**\r\n   * Optionally name the isometric tile map\r\n   */\r\n  name?: string;\r\n  /**\r\n   * Optionally specify the position of the isometric tile map\r\n   */\r\n  pos?: Vector;\r\n  /**\r\n   * Optionally render from the top of the graphic, by default tiles are rendered from the bottom\r\n   */\r\n  renderFromTopOfGraphic?: boolean;\r\n  /**\r\n   * Optionally present a graphics offset, this can be useful depending on your tile graphics\r\n   */\r\n  graphicsOffset?: Vector;\r\n  /**\r\n   * Width of an individual tile in pixels, this should be the width of the parallelogram of the base of the tile art asset.\r\n   */\r\n  tileWidth: number;\r\n  /**\r\n   * Height of an individual tile in pixels, this should be the height of the parallelogram of the base of the tile art asset.\r\n   */\r\n  tileHeight: number;\r\n  /**\r\n   * The number of tile columns, or the number of tiles wide\r\n   */\r\n  columns: number;\r\n  /**\r\n   * The number of tile  rows, or the number of tiles high\r\n   */\r\n  rows: number;\r\n}\r\n\r\n/**\r\n * The IsometricMap is a special tile map that provides isometric rendering support to Excalibur\r\n *\r\n * The tileWidth and tileHeight should be the height and width in pixels of the parallelogram of the base of the tile art asset.\r\n * The tileWidth and tileHeight is not necessarily the same as your graphic pixel width and height.\r\n *\r\n * Please refer to the docs https://excaliburjs.com for more details calculating what your tile width and height should be given\r\n * your art assets.\r\n */\r\nexport class IsometricMap extends Entity {\r\n  /**\r\n   * Width of individual tile in pixels\r\n   */\r\n  public readonly tileWidth: number;\r\n  /**\r\n   * Height of individual tile in pixels\r\n   */\r\n  public readonly tileHeight: number;\r\n  /**\r\n   * Number of tiles wide\r\n   */\r\n  public readonly columns: number;\r\n  /**\r\n   * Number of tiles high\r\n   */\r\n  public readonly rows: number;\r\n  /**\r\n   * List containing all of the tiles in IsometricMap\r\n   */\r\n  public readonly tiles: IsometricTile[];\r\n\r\n  /**\r\n   * Render the tile graphic from the top instead of the bottom\r\n   *\r\n   * default is `false` meaning rendering from the bottom\r\n   */\r\n  public renderFromTopOfGraphic: boolean = false;\r\n  public graphicsOffset: Vector = vec(0, 0);\r\n\r\n  /**\r\n   * Isometric map [[TransformComponent]]\r\n   */\r\n  public transform: TransformComponent;\r\n\r\n  /**\r\n   * Isometric map [[ColliderComponent]]\r\n   */\r\n  public collider: ColliderComponent;\r\n\r\n  private _composite: CompositeCollider;\r\n\r\n  constructor(options: IsometricMapOptions) {\r\n    super([\r\n      new TransformComponent(),\r\n      new BodyComponent({\r\n        type: CollisionType.Fixed\r\n      }),\r\n      new ColliderComponent(),\r\n      new DebugGraphicsComponent((ctx) => this.debug(ctx), false)\r\n    ], options.name);\r\n    const { pos, tileWidth, tileHeight, columns: width, rows: height, renderFromTopOfGraphic, graphicsOffset } = options;\r\n\r\n    this.transform = this.get(TransformComponent);\r\n    if (pos) {\r\n      this.transform.pos = pos;\r\n    }\r\n\r\n    this.collider = this.get(ColliderComponent);\r\n    if (this.collider) {\r\n      this.collider.set(this._composite = new CompositeCollider([]));\r\n    }\r\n\r\n\r\n    this.renderFromTopOfGraphic = renderFromTopOfGraphic ?? this.renderFromTopOfGraphic;\r\n    this.graphicsOffset = graphicsOffset ?? this.graphicsOffset;\r\n\r\n    this.tileWidth = tileWidth;\r\n    this.tileHeight = tileHeight;\r\n    this.columns = width;\r\n    this.rows = height;\r\n\r\n    this.tiles = new Array(width * height);\r\n\r\n    // build up tile representation\r\n    for (let y = 0; y < height; y++) {\r\n      for (let x = 0; x < width; x++) {\r\n        const tile = new IsometricTile(x, y, this.graphicsOffset, this);\r\n        this.tiles[x + y * width] = tile;\r\n        this.addChild(tile);\r\n        // TODO row/columns helpers\r\n      }\r\n    }\r\n  }\r\n\r\n  public update(): void {\r\n    if (this._collidersDirty) {\r\n      this.updateColliders();\r\n      this._collidersDirty = false;\r\n    }\r\n  }\r\n\r\n  private _collidersDirty = false;\r\n  public flagCollidersDirty() {\r\n    this._collidersDirty = true;\r\n  }\r\n\r\n  private _originalOffsets = new WeakMap<Collider, Vector>();\r\n  private _getOrSetColliderOriginalOffset(collider: Collider): Vector {\r\n    if (!this._originalOffsets.has(collider)) {\r\n      const originalOffset = collider.offset;\r\n      this._originalOffsets.set(collider, originalOffset);\r\n      return originalOffset;\r\n    } else {\r\n      return this._originalOffsets.get(collider);\r\n    }\r\n  }\r\n  public updateColliders() {\r\n    this._composite.clearColliders();\r\n    const pos = this.get(TransformComponent).pos;\r\n    for (const tile of this.tiles) {\r\n      if (tile.solid) {\r\n        for (const collider of tile.getColliders()) {\r\n          const originalOffset = this._getOrSetColliderOriginalOffset(collider);\r\n          collider.offset = this.tileToWorld(vec(tile.x, tile.y))\r\n            .sub(pos)\r\n            .add(originalOffset)\r\n            .sub(vec(this.tileWidth / 2, this.tileHeight)); // We need to unshift height based on drawing\r\n          collider.owner = this;\r\n          this._composite.addCollider(collider);\r\n        }\r\n      }\r\n    }\r\n    this.collider.update();\r\n  }\r\n\r\n  /**\r\n   * Convert world space coordinates to the tile x, y coordinate\r\n   * @param worldCoordinate\r\n   */\r\n  public worldToTile(worldCoordinate: Vector): Vector {\r\n    worldCoordinate = worldCoordinate.sub(this.transform.globalPos);\r\n\r\n    const halfTileWidth = this.tileWidth / 2;\r\n    const halfTileHeight = this.tileHeight / 2;\r\n    // See https://clintbellanger.net/articles/isometric_math/ for formula\r\n    return vec(\r\n      ~~((worldCoordinate.x / halfTileWidth + (worldCoordinate.y / halfTileHeight)) / 2),\r\n      ~~((worldCoordinate.y / halfTileHeight - (worldCoordinate.x / halfTileWidth)) / 2));\r\n  }\r\n\r\n  /**\r\n   * Given a tile coordinate, return the top left corner in world space\r\n   * @param tileCoordinate\r\n   */\r\n  public tileToWorld(tileCoordinate: Vector): Vector {\r\n    const halfTileWidth = this.tileWidth / 2;\r\n    const halfTileHeight = this.tileHeight / 2;\r\n    // The x position shifts left with every y step\r\n    const xPos = (tileCoordinate.x - tileCoordinate.y) * halfTileWidth;\r\n    // The y position needs to go down with every x step\r\n    const yPos = (tileCoordinate.x + tileCoordinate.y) * halfTileHeight;\r\n    return vec(xPos, yPos).add(this.transform.pos);\r\n  }\r\n\r\n  /**\r\n   * Returns the [[IsometricTile]] by its x and y coordinates\r\n   */\r\n  public getTile(x: number, y: number): IsometricTile | null {\r\n    if (x < 0 || y < 0 || x >= this.columns || y >= this.rows) {\r\n      return null;\r\n    }\r\n    return this.tiles[x + y * this.columns];\r\n  }\r\n\r\n  /**\r\n   * Returns the [[IsometricTile]] by testing a point in world coordinates,\r\n   * returns `null` if no Tile was found.\r\n   */\r\n  public getTileByPoint(point: Vector): IsometricTile | null {\r\n    const tileCoord = this.worldToTile(point);\r\n    const tile = this.getTile(tileCoord.x, tileCoord.y);\r\n    return tile;\r\n  }\r\n\r\n  private _getMaxZIndex(): number {\r\n    let maxZ = Number.NEGATIVE_INFINITY;\r\n    for (const tile of this.tiles) {\r\n      const currentZ = tile.get(TransformComponent).z;\r\n      if (currentZ > maxZ) {\r\n        maxZ =  currentZ;\r\n      }\r\n    }\r\n    return maxZ;\r\n  }\r\n\r\n  /**\r\n   * Debug draw for IsometricMap, called internally by excalibur when debug mode is toggled on\r\n   * @param gfx\r\n   */\r\n  public debug(gfx: ExcaliburGraphicsContext) {\r\n    gfx.save();\r\n    gfx.z = this._getMaxZIndex() + 0.5;\r\n    for (let y = 0; y < this.rows + 1; y++) {\r\n      const left = this.tileToWorld(vec(0, y));\r\n      const right = this.tileToWorld(vec(this.columns, y));\r\n      gfx.drawLine(left, right, Color.Red, 2);\r\n    }\r\n\r\n    for (let x = 0; x < this.columns + 1; x++) {\r\n      const top = this.tileToWorld(vec(x, 0));\r\n      const bottom = this.tileToWorld(vec(x, this.rows));\r\n      gfx.drawLine(top, bottom, Color.Red, 2);\r\n    }\r\n\r\n    for (const tile of this.tiles) {\r\n      gfx.drawCircle(this.tileToWorld(vec(tile.x, tile.y)), 3, Color.Yellow);\r\n    }\r\n    gfx.restore();\r\n  }\r\n}","import { Entity } from '../../EntityComponentSystem';\r\nimport { Action } from '../Action';\r\nimport { ActionContext } from '../ActionContext';\r\nimport { ActionQueue } from '../ActionQueue';\r\n\r\n/**\r\n * Action that can represent a sequence of actions, this can be useful in conjunction with\r\n * [[ParallelActions]] to run multiple sequences in parallel.\r\n */\r\nexport class ActionSequence implements Action {\r\n  private _actionQueue: ActionQueue;\r\n  private _stopped: boolean = false;\r\n  private _sequenceContext: ActionContext;\r\n  private _sequenceBuilder: (actionContext: ActionContext) => any;\r\n  constructor(entity: Entity, actionBuilder: (actionContext: ActionContext) => any) {\r\n    this._sequenceBuilder = actionBuilder;\r\n    this._sequenceContext = new ActionContext(entity);\r\n    this._actionQueue = this._sequenceContext.getQueue();\r\n    this._sequenceBuilder(this._sequenceContext);\r\n  }\r\n\r\n  public update(delta: number): void {\r\n    this._actionQueue.update(delta);\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._actionQueue.isComplete();\r\n  }\r\n\r\n  public stop(): void {\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._stopped = false;\r\n    this._actionQueue.reset();\r\n  }\r\n\r\n  public clone(entity: Entity) {\r\n    return new ActionSequence(entity, this._sequenceBuilder);\r\n  }\r\n}","import { Entity } from '../../EntityComponentSystem';\r\nimport { Action } from '../Action';\r\n\r\n\r\n/**\r\n * Action that can run multiple [[Action]]s or [[ActionSequence]]s at the same time\r\n */\r\nexport class ParallelActions implements Action {\r\n  private _actions: Action[];\r\n\r\n  constructor(parallelActions: Action[]) {\r\n    this._actions = parallelActions;\r\n  }\r\n\r\n  update(delta: number): void {\r\n    for (let i = 0; i < this._actions.length; i++) {\r\n      this._actions[i].update(delta);\r\n    }\r\n  }\r\n  isComplete(entity: Entity): boolean {\r\n    return this._actions.every(a => a.isComplete(entity));\r\n  }\r\n  reset(): void {\r\n    this._actions.forEach(a => a.reset());\r\n  }\r\n  stop(): void {\r\n    this._actions.forEach(a => a.stop());\r\n  }\r\n}","import { CollisionGroup } from './CollisionGroup';\r\n\r\n/**\r\n * Static class for managing collision groups in excalibur, there is a maximum of 32 collision groups possible in excalibur\r\n */\r\nexport class CollisionGroupManager {\r\n  // using bitmasking the maximum number of groups is 32, because that is the highest 32bit integer that JS can present.\r\n  private static _STARTING_BIT = 0b1 | 0;\r\n  private static _MAX_GROUPS = 32;\r\n  private static _CURRENT_GROUP = 1;\r\n  private static _CURRENT_BIT = CollisionGroupManager._STARTING_BIT;\r\n  private static _GROUPS: Map<string, CollisionGroup> = new Map<string, CollisionGroup>();\r\n\r\n  /**\r\n   * Create a new named collision group up to a max of 32.\r\n   * @param name Name for the collision group\r\n   * @param mask Optionally provide your own 32-bit mask, if none is provide the manager will generate one\r\n   */\r\n  public static create(name: string, mask?: number) {\r\n    if (this._CURRENT_GROUP > this._MAX_GROUPS) {\r\n      throw new Error(`Cannot have more than ${this._MAX_GROUPS} collision groups`);\r\n    }\r\n    if (this._GROUPS.get(name)) {\r\n      throw new Error(`Collision group ${name} already exists`);\r\n    }\r\n    const group = new CollisionGroup(name, this._CURRENT_BIT, mask !== undefined ? mask : ~this._CURRENT_BIT);\r\n    this._CURRENT_BIT = (this._CURRENT_BIT << 1) | 0;\r\n    this._CURRENT_GROUP++;\r\n    this._GROUPS.set(name, group);\r\n    return group;\r\n  }\r\n\r\n  /**\r\n   * Get all collision groups currently tracked by excalibur\r\n   */\r\n  public static get groups(): CollisionGroup[] {\r\n    return Array.from(this._GROUPS.values());\r\n  }\r\n\r\n  /**\r\n   * Get a collision group by it's name\r\n   * @param name\r\n   */\r\n  public static groupByName(name: string) {\r\n    return this._GROUPS.get(name);\r\n  }\r\n\r\n  /**\r\n   * Resets the managers internal group management state\r\n   */\r\n  public static reset() {\r\n    this._GROUPS = new Map<string, CollisionGroup>();\r\n    this._CURRENT_BIT = this._STARTING_BIT;\r\n    this._CURRENT_GROUP = 1;\r\n  }\r\n}\r\n","import { Engine } from './../Engine';\r\nimport * as Events from './../Events';\r\nimport { Scene } from '../Scene';\r\nimport { ExcaliburGraphicsContext } from '../Graphics';\r\n\r\n// eslint-disable-next-line @typescript-eslint/naming-convention\r\nexport interface _initialize {\r\n  _initialize(engine: Engine): void;\r\n}\r\n\r\n/**\r\n * Type guard checking for internal initialize method\r\n * @internal\r\n * @param a\r\n */\r\nexport function has_initialize(a: any): a is _initialize {\r\n  return !!a._initialize;\r\n}\r\n\r\nexport interface OnInitialize {\r\n  onInitialize(engine: Engine): void;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function hasOnInitialize(a: any): a is OnInitialize {\r\n  return !!a.onInitialize;\r\n}\r\n\r\n// eslint-disable-next-line @typescript-eslint/naming-convention\r\nexport interface _preupdate {\r\n  _preupdate(engine: Engine, delta: number): void;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function has_preupdate(a: any): a is _preupdate {\r\n  return !!a._preupdate;\r\n}\r\n\r\nexport interface OnPreUpdate {\r\n  onPreUpdate(engine: Engine, delta: number): void;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function hasOnPreUpdate(a: any): a is OnPreUpdate {\r\n  return !!a.onPreUpdate;\r\n}\r\n\r\n// eslint-disable-next-line @typescript-eslint/naming-convention\r\nexport interface _postupdate {\r\n  _postupdate(engine: Engine, delta: number): void;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function has_postupdate(a: any): a is _postupdate {\r\n  return !!a.onPostUpdate;\r\n}\r\n\r\nexport interface OnPostUpdate {\r\n  onPostUpdate(engine: Engine, delta: number): void;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function hasOnPostUpdate(a: any): a is OnPostUpdate {\r\n  return !!a.onPostUpdate;\r\n}\r\n\r\nexport interface CanInitialize {\r\n  /**\r\n   * Overridable implementation\r\n   */\r\n  onInitialize(_engine: Engine): void;\r\n\r\n  /**\r\n   * Event signatures\r\n   */\r\n  on(eventName: Events.initialize, handler: (event: Events.InitializeEvent<any>) => void): void;\r\n  once(eventName: Events.initialize, handler: (event: Events.InitializeEvent<any>) => void): void;\r\n  off(eventName: Events.initialize, handler?: (event: Events.InitializeEvent<any>) => void): void;\r\n}\r\n\r\nexport interface SceneActivationContext<TData = undefined> {\r\n  data?: TData;\r\n  previousScene: Scene;\r\n  nextScene: Scene;\r\n  engine: Engine;\r\n}\r\n\r\nexport interface CanActivate<TData = undefined> {\r\n  /**\r\n   * Overridable implementation\r\n   */\r\n  onActivate(context: SceneActivationContext<TData>): void;\r\n\r\n  /**\r\n   * Event signatures\r\n   */\r\n  on(eventName: Events.activate, handler: (event: Events.ActivateEvent) => void): void;\r\n  once(eventName: Events.activate, handler: (event: Events.ActivateEvent) => void): void;\r\n  off(eventName: Events.activate, handler?: (event: Events.ActivateEvent) => void): void;\r\n}\r\n\r\nexport interface CanDeactivate {\r\n  /**\r\n   * Overridable implementation\r\n   */\r\n  onDeactivate(context: SceneActivationContext<never>): void;\r\n\r\n  /**\r\n   * Event signature\r\n   */\r\n  on(eventName: Events.deactivate, handler: (event: Events.DeactivateEvent) => void): void;\r\n  once(eventName: Events.deactivate, handler: (event: Events.DeactivateEvent) => void): void;\r\n  off(eventName: Events.deactivate, handler?: (event: Events.DeactivateEvent) => void): void;\r\n}\r\n\r\nexport interface CanUpdate {\r\n  /**\r\n   * Overridable implementation\r\n   */\r\n  onPreUpdate(_engine: Engine, _delta: number): void;\r\n\r\n  /**\r\n   * Event signature\r\n   */\r\n  on(eventName: Events.preupdate, handler: (event: Events.PreUpdateEvent<any>) => void): void;\r\n  once(eventName: Events.preupdate, handler: (event: Events.PreUpdateEvent<any>) => void): void;\r\n  off(eventName: Events.preupdate, handler?: (event: Events.PreUpdateEvent<any>) => void): void;\r\n\r\n  /**\r\n   * Overridable implementation\r\n   */\r\n  onPostUpdate(_engine: Engine, _delta: number): void;\r\n\r\n  /**\r\n   * Event signatures\r\n   */\r\n  on(eventName: Events.postupdate, handler: (event: Events.PostUpdateEvent<any>) => void): void;\r\n  once(eventName: Events.postupdate, handler: (event: Events.PostUpdateEvent<any>) => void): void;\r\n  off(eventName: Events.postupdate, handler?: (event: Events.PostUpdateEvent<any>) => void): void;\r\n}\r\n\r\nexport interface OnPreDraw {\r\n  /**\r\n   * Overridable implementation\r\n   */\r\n  onPreDraw(_ctx: ExcaliburGraphicsContext, _delta: number): void;\r\n\r\n  /**\r\n   * Event signatures\r\n   */\r\n  on(eventName: Events.predraw, handler: (event: Events.PreDrawEvent) => void): void;\r\n  once(eventName: Events.predraw, handler: (event: Events.PreDrawEvent) => void): void;\r\n  off(eventName: Events.predraw, handler?: (event: Events.PreDrawEvent) => void): void;\r\n}\r\n\r\nexport interface OnPostDraw {\r\n  /**\r\n   * Overridable implementation\r\n   */\r\n  onPostDraw(_ctx: ExcaliburGraphicsContext, _delta: number): void;\r\n\r\n  /**\r\n   * Event signatures\r\n   */\r\n  on(eventName: Events.postdraw, handler: (event: Events.PostDrawEvent) => void): void;\r\n  once(eventName: Events.postdraw, handler: (event: Events.PostDrawEvent) => void): void;\r\n  off(eventName: Events.postdraw, handler?: (event: Events.PostDrawEvent) => void): void;\r\n}\r\n\r\nexport interface CanDraw extends OnPreDraw, OnPostDraw {\r\n  on(eventName: Events.predraw, handler: (event: Events.PreDrawEvent) => void): void;\r\n  on(eventName: Events.postdraw, handler: (event: Events.PostDrawEvent) => void): void;\r\n\r\n  once(eventName: Events.predraw, handler: (event: Events.PreDrawEvent) => void): void;\r\n  once(eventName: Events.postdraw, handler: (event: Events.PostDrawEvent) => void): void;\r\n\r\n  off(eventName: Events.predraw, handler?: (event: Events.PreDrawEvent) => void): void;\r\n  off(eventName: Events.postdraw, handler?: (event: Events.PostDrawEvent) => void): void;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function hasPreDraw(a: any): a is OnPreDraw {\r\n  return !!a.onPreDraw;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function hasPostDraw(a: any): a is OnPostDraw {\r\n  return !!a.onPostDraw;\r\n}\r\n\r\nexport interface CanBeKilled {\r\n  /**\r\n   * Overridable implementation\r\n   */\r\n  onPreKill(_scene: Scene): void;\r\n\r\n  /**\r\n   * Event signatures\r\n   */\r\n  on(eventName: Events.prekill, handler: (event: Events.PreKillEvent) => void): void;\r\n  once(eventName: Events.prekill, handler: (event: Events.PreKillEvent) => void): void;\r\n  off(eventName: Events.prekill, handler: (event: Events.PreKillEvent) => void): void;\r\n\r\n  /**\r\n   * Overridable implementation\r\n   */\r\n  onPostKill(_scene: Scene): void;\r\n\r\n  /**\r\n   * Event signatures\r\n   */\r\n  on(eventName: Events.postkill, handler: (event: Events.PostKillEvent) => void): void;\r\n  once(eventName: Events.postkill, handler: (event: Events.PostKillEvent) => void): void;\r\n  off(eventName: Events.postkill, handler: (event: Events.PostKillEvent) => void): void;\r\n}\r\n","import { Resource } from './Resource';\r\nimport { Sprite } from '../Graphics/Sprite';\r\nimport { Color } from '../Color';\r\nimport { SpriteSheet } from '../Graphics/SpriteSheet';\r\nimport { Animation } from '../Graphics/Animation';\r\nimport { Loadable } from '../Interfaces/Index';\r\nimport { ImageSource } from '../Graphics/ImageSource';\r\nimport { range } from '../Math/util';\r\n/**\r\n * The [[Texture]] object allows games built in Excalibur to load image resources.\r\n * [[Texture]] is an [[Loadable]] which means it can be passed to a [[Loader]]\r\n * to pre-load before starting a level or game.\r\n */\r\nexport class Gif implements Loadable<ImageSource[]> {\r\n  private _resource: Resource<ArrayBuffer>;\r\n\r\n  /**\r\n   * The width of the texture in pixels\r\n   */\r\n  public width: number;\r\n\r\n  /**\r\n   * The height of the texture in pixels\r\n   */\r\n  public height: number;\r\n\r\n\r\n  private _stream: Stream = null;\r\n  private _gif: ParseGif = null;\r\n  private _textures: ImageSource[] = [];\r\n  private _animation: Animation = null;\r\n  private _transparentColor: Color = null;\r\n\r\n  public data: ImageSource[];\r\n\r\n  /**\r\n   * @param path       Path to the image resource\r\n   * @param color      Optionally set the color to treat as transparent the gif, by default [[Color.Magenta]]\r\n   * @param bustCache  Optionally load texture with cache busting\r\n   */\r\n  constructor(public path: string, public color: Color = Color.Magenta, public bustCache = true) {\r\n    this._resource = new Resource(path, 'arraybuffer', bustCache);\r\n    this._transparentColor = color;\r\n  }\r\n\r\n  /**\r\n   * Begins loading the texture and returns a promise to be resolved on completion\r\n   */\r\n  public async load(): Promise<ImageSource[]> {\r\n    const arraybuffer = await this._resource.load();\r\n    this._stream = new Stream(arraybuffer);\r\n    this._gif = new ParseGif(this._stream, this._transparentColor);\r\n    const images = this._gif.images.map(i => new ImageSource(i.src, false));\r\n\r\n    // Load all textures\r\n    await Promise.all(images.map(t => t.load()));\r\n    return this.data = this._textures = images;\r\n  }\r\n\r\n  public isLoaded() {\r\n    return !!this.data;\r\n  }\r\n\r\n  /**\r\n   * Return a frame of the gif as a sprite by id\r\n   * @param id\r\n   */\r\n  public toSprite(id: number = 0): Sprite {\r\n    const sprite = this._textures[id].toSprite();\r\n    return sprite;\r\n  }\r\n\r\n  /**\r\n   * Return the gif as a spritesheet\r\n   */\r\n  public toSpriteSheet(): SpriteSheet {\r\n    const sprites: Sprite[] = this._textures.map((image) => {\r\n      return image.toSprite();\r\n    });\r\n    return new SpriteSheet({ sprites });\r\n  }\r\n\r\n  /**\r\n   * Transform the GIF into an animation with duration per frame\r\n   */\r\n  public toAnimation(durationPerFrameMs: number): Animation {\r\n    const spriteSheet: SpriteSheet = this.toSpriteSheet();\r\n    const length = spriteSheet.sprites.length;\r\n    this._animation = Animation.fromSpriteSheet(spriteSheet, range(0, length), durationPerFrameMs);\r\n    return this._animation;\r\n  }\r\n\r\n  public get readCheckBytes(): number[] {\r\n    return this._gif.checkBytes;\r\n  }\r\n}\r\n\r\nexport interface GifFrame {\r\n  sentinel: number;\r\n  type: string;\r\n  leftPos: number;\r\n  topPos: number;\r\n  width: number;\r\n  height: number;\r\n  lctFlag: boolean;\r\n  interlaced: boolean;\r\n  sorted: boolean;\r\n  reserved: boolean[];\r\n  lctSize: number;\r\n  lzwMinCodeSize: number;\r\n  pixels: number[];\r\n}\r\n\r\nconst bitsToNum = (ba: any) => {\r\n  return ba.reduce(function (s: number, n: number) {\r\n    return s * 2 + n;\r\n  }, 0);\r\n};\r\n\r\nconst byteToBitArr = (bite: any) => {\r\n  const a = [];\r\n  for (let i = 7; i >= 0; i--) {\r\n    a.push(!!(bite & (1 << i)));\r\n  }\r\n  return a;\r\n};\r\n\r\nexport class Stream {\r\n  data: any = null;\r\n  len: number = 0;\r\n  position: number = 0;\r\n\r\n  constructor(dataArray: ArrayBuffer) {\r\n    this.data = new Uint8Array(dataArray);\r\n    this.len = this.data.byteLength;\r\n    if (this.len === 0) {\r\n      throw new Error('No data loaded from file');\r\n    }\r\n  }\r\n\r\n  public readByte = () => {\r\n    if (this.position >= this.data.byteLength) {\r\n      throw new Error('Attempted to read past end of stream.');\r\n    }\r\n    return this.data[this.position++];\r\n  };\r\n\r\n  public readBytes = (n: number) => {\r\n    const bytes = [];\r\n    for (let i = 0; i < n; i++) {\r\n      bytes.push(this.readByte());\r\n    }\r\n    return bytes;\r\n  };\r\n\r\n  public read = (n: number) => {\r\n    let s = '';\r\n    for (let i = 0; i < n; i++) {\r\n      s += String.fromCharCode(this.readByte());\r\n    }\r\n    return s;\r\n  };\r\n\r\n  public readUnsigned = () => {\r\n    // Little-endian.\r\n    const a = this.readBytes(2);\r\n    return (a[1] << 8) + a[0];\r\n  };\r\n}\r\n\r\nconst lzwDecode = function (minCodeSize: number, data: any) {\r\n  // TODO: Now that the GIF parser is a bit different, maybe this should get an array of bytes instead of a String?\r\n  let pos = 0; // Maybe this streaming thing should be merged with the Stream?\r\n\r\n  const readCode = function (size: number) {\r\n    let code = 0;\r\n    for (let i = 0; i < size; i++) {\r\n      if (data.charCodeAt(pos >> 3) & (1 << (pos & 7))) {\r\n        code |= 1 << i;\r\n      }\r\n      pos++;\r\n    }\r\n    return code;\r\n  };\r\n\r\n  const output: any[] = [];\r\n\r\n  const clearCode = 1 << minCodeSize;\r\n  const eoiCode = clearCode + 1;\r\n\r\n  let codeSize = minCodeSize + 1;\r\n\r\n  let dict: any[] = [];\r\n\r\n  const clear = function () {\r\n    dict = [];\r\n    codeSize = minCodeSize + 1;\r\n    for (let i = 0; i < clearCode; i++) {\r\n      dict[i] = [i];\r\n    }\r\n    dict[clearCode] = [];\r\n    dict[eoiCode] = null;\r\n  };\r\n\r\n  let code;\r\n  let last;\r\n\r\n  while (true) {\r\n    last = code;\r\n    code = readCode(codeSize);\r\n    if (code === clearCode) {\r\n      clear();\r\n      continue;\r\n    }\r\n    if (code === eoiCode) {\r\n      break;\r\n    }\r\n\r\n    if (code < dict.length) {\r\n      if (last !== clearCode) {\r\n        dict.push(dict[last].concat(dict[code][0]));\r\n      }\r\n    } else {\r\n      if (code !== dict.length) {\r\n        throw new Error('Invalid LZW code.');\r\n      }\r\n      dict.push(dict[last].concat(dict[last][0]));\r\n    }\r\n    output.push.apply(output, dict[code]);\r\n\r\n    if (dict.length === 1 << codeSize && codeSize < 12) {\r\n      // If we're at the last code and codeSize is 12, the next code will be a clearCode, and it'll be 12 bits long.\r\n      codeSize++;\r\n    }\r\n  }\r\n\r\n  // I don't know if this is technically an error, but some GIFs do it.\r\n  //if (Math.ceil(pos / 8) !== data.length) throw new Error('Extraneous LZW bytes.');\r\n  return output;\r\n};\r\n\r\n// The actual parsing; returns an object with properties.\r\nexport class ParseGif {\r\n  private _st: Stream = null;\r\n  private _handler: any = {};\r\n  private _transparentColor: Color = null;\r\n  public frames: GifFrame[] = [];\r\n  public images: HTMLImageElement[] = [];\r\n  public globalColorTable: any[] = [];\r\n  public checkBytes: number[] = [];\r\n\r\n  constructor(stream: Stream, color: Color = Color.Magenta) {\r\n    this._st = stream;\r\n    this._handler = {};\r\n    this._transparentColor = color;\r\n    this.parseHeader();\r\n    this.parseBlock();\r\n  }\r\n\r\n  // LZW (GIF-specific)\r\n  parseColorTable = (entries: any) => {\r\n    // Each entry is 3 bytes, for RGB.\r\n    const ct = [];\r\n    for (let i = 0; i < entries; i++) {\r\n      const rgb: number[] = this._st.readBytes(3);\r\n      const rgba =\r\n        '#' +\r\n        rgb\r\n          .map((x: any) => {\r\n            const hex = x.toString(16);\r\n            return hex.length === 1 ? '0' + hex : hex;\r\n          })\r\n          .join('');\r\n      ct.push(rgba);\r\n    }\r\n    return ct;\r\n  };\r\n\r\n  readSubBlocks = () => {\r\n    let size, data;\r\n    data = '';\r\n    do {\r\n      size = this._st.readByte();\r\n      data += this._st.read(size);\r\n    } while (size !== 0);\r\n    return data;\r\n  };\r\n\r\n  parseHeader = () => {\r\n    const hdr: any = {\r\n      sig: null,\r\n      ver: null,\r\n      width: null,\r\n      height: null,\r\n      colorRes: null,\r\n      globalColorTableSize: null,\r\n      gctFlag: null,\r\n      sorted: null,\r\n      globalColorTable: [],\r\n      bgColor: null,\r\n      pixelAspectRatio: null // if not 0, aspectRatio = (pixelAspectRatio + 15) / 64\r\n    };\r\n\r\n    hdr.sig = this._st.read(3);\r\n    hdr.ver = this._st.read(3);\r\n    if (hdr.sig !== 'GIF') {\r\n      throw new Error('Not a GIF file.'); // XXX: This should probably be handled more nicely.\r\n    }\r\n\r\n    hdr.width = this._st.readUnsigned();\r\n    hdr.height = this._st.readUnsigned();\r\n\r\n    const bits = byteToBitArr(this._st.readByte());\r\n    hdr.gctFlag = bits.shift();\r\n    hdr.colorRes = bitsToNum(bits.splice(0, 3));\r\n    hdr.sorted = bits.shift();\r\n    hdr.globalColorTableSize = bitsToNum(bits.splice(0, 3));\r\n\r\n    hdr.bgColor = this._st.readByte();\r\n    hdr.pixelAspectRatio = this._st.readByte(); // if not 0, aspectRatio = (pixelAspectRatio + 15) / 64\r\n\r\n    if (hdr.gctFlag) {\r\n      hdr.globalColorTable = this.parseColorTable(1 << (hdr.globalColorTableSize + 1));\r\n      this.globalColorTable = hdr.globalColorTable;\r\n    }\r\n    if (this._handler.hdr && this._handler.hdr(hdr)) {\r\n      this.checkBytes.push(this._handler.hdr);\r\n    }\r\n  };\r\n\r\n  parseExt = (block: any) => {\r\n    const parseGCExt = (block: any) => {\r\n      this.checkBytes.push(this._st.readByte()); // Always 4\r\n\r\n      const bits = byteToBitArr(this._st.readByte());\r\n      block.reserved = bits.splice(0, 3); // Reserved; should be 000.\r\n      block.disposalMethod = bitsToNum(bits.splice(0, 3));\r\n      block.userInput = bits.shift();\r\n      block.transparencyGiven = bits.shift();\r\n\r\n      block.delayTime = this._st.readUnsigned();\r\n\r\n      block.transparencyIndex = this._st.readByte();\r\n\r\n      block.terminator = this._st.readByte();\r\n\r\n      if (this._handler.gce && this._handler.gce(block)) {\r\n        this.checkBytes.push(this._handler.gce);\r\n      }\r\n    };\r\n\r\n    const parseComExt = (block: any) => {\r\n      block.comment = this.readSubBlocks();\r\n      if (this._handler.com && this._handler.com(block)) {\r\n        this.checkBytes.push(this._handler.com);\r\n      }\r\n    };\r\n\r\n    const parsePTExt = (block: any) => {\r\n      this.checkBytes.push(this._st.readByte()); // Always 12\r\n      block.ptHeader = this._st.readBytes(12);\r\n      block.ptData = this.readSubBlocks();\r\n      if (this._handler.pte && this._handler.pte(block)) {\r\n        this.checkBytes.push(this._handler.pte);\r\n      }\r\n    };\r\n\r\n    const parseAppExt = (block: any) => {\r\n      const parseNetscapeExt = (block: any) => {\r\n        this.checkBytes.push(this._st.readByte()); // Always 3\r\n        block.unknown = this._st.readByte(); // Q: Always 1? What is this?\r\n        block.iterations = this._st.readUnsigned();\r\n        block.terminator = this._st.readByte();\r\n        if (this._handler.app && this._handler.app.NETSCAPE && this._handler.app.NETSCAPE(block)) {\r\n          this.checkBytes.push(this._handler.app);\r\n        }\r\n      };\r\n\r\n      const parseUnknownAppExt = (block: any) => {\r\n        block.appData = this.readSubBlocks();\r\n        // FIXME: This won't work if a handler wants to match on any identifier.\r\n        if (this._handler.app && this._handler.app[block.identifier] && this._handler.app[block.identifier](block)) {\r\n          this.checkBytes.push(this._handler.app[block.identifier]);\r\n        }\r\n      };\r\n\r\n      this.checkBytes.push(this._st.readByte()); // Always 11\r\n      block.identifier = this._st.read(8);\r\n      block.authCode = this._st.read(3);\r\n      switch (block.identifier) {\r\n        case 'NETSCAPE':\r\n          parseNetscapeExt(block);\r\n          break;\r\n        default:\r\n          parseUnknownAppExt(block);\r\n          break;\r\n      }\r\n    };\r\n\r\n    const parseUnknownExt = (block: any) => {\r\n      block.data = this.readSubBlocks();\r\n      if (this._handler.unknown && this._handler.unknown(block)) {\r\n        this.checkBytes.push(this._handler.unknown);\r\n      }\r\n    };\r\n\r\n    block.label = this._st.readByte();\r\n    switch (block.label) {\r\n      case 0xf9:\r\n        block.extType = 'gce';\r\n        parseGCExt(block);\r\n        break;\r\n      case 0xfe:\r\n        block.extType = 'com';\r\n        parseComExt(block);\r\n        break;\r\n      case 0x01:\r\n        block.extType = 'pte';\r\n        parsePTExt(block);\r\n        break;\r\n      case 0xff:\r\n        block.extType = 'app';\r\n        parseAppExt(block);\r\n        break;\r\n      default:\r\n        block.extType = 'unknown';\r\n        parseUnknownExt(block);\r\n        break;\r\n    }\r\n  };\r\n\r\n  parseImg = (img: any) => {\r\n    const deinterlace = (pixels: any, width: any) => {\r\n      // Of course this defeats the purpose of interlacing. And it's *probably*\r\n      // the least efficient way it's ever been implemented. But nevertheless...\r\n\r\n      const newPixels = new Array(pixels.length);\r\n      const rows = pixels.length / width;\r\n      const cpRow = (toRow: any, fromRow: any) => {\r\n        const fromPixels = pixels.slice(fromRow * width, (fromRow + 1) * width);\r\n        newPixels.splice.apply(newPixels, [toRow * width, width].concat(fromPixels));\r\n      };\r\n\r\n      const offsets = [0, 4, 2, 1];\r\n      const steps = [8, 8, 4, 2];\r\n\r\n      let fromRow = 0;\r\n      for (let pass = 0; pass < 4; pass++) {\r\n        for (let toRow = offsets[pass]; toRow < rows; toRow += steps[pass]) {\r\n          cpRow(toRow, fromRow);\r\n          fromRow++;\r\n        }\r\n      }\r\n\r\n      return newPixels;\r\n    };\r\n\r\n    img.leftPos = this._st.readUnsigned();\r\n    img.topPos = this._st.readUnsigned();\r\n    img.width = this._st.readUnsigned();\r\n    img.height = this._st.readUnsigned();\r\n\r\n    const bits = byteToBitArr(this._st.readByte());\r\n    img.lctFlag = bits.shift();\r\n    img.interlaced = bits.shift();\r\n    img.sorted = bits.shift();\r\n    img.reserved = bits.splice(0, 2);\r\n    img.lctSize = bitsToNum(bits.splice(0, 3));\r\n\r\n    if (img.lctFlag) {\r\n      img.lct = this.parseColorTable(1 << (img.lctSize + 1));\r\n    }\r\n\r\n    img.lzwMinCodeSize = this._st.readByte();\r\n\r\n    const lzwData = this.readSubBlocks();\r\n\r\n    img.pixels = lzwDecode(img.lzwMinCodeSize, lzwData);\r\n\r\n    if (img.interlaced) {\r\n      // Move\r\n      img.pixels = deinterlace(img.pixels, img.width);\r\n    }\r\n\r\n    this.frames.push(img);\r\n    this.arrayToImage(img);\r\n    if (this._handler.img && this._handler.img(img)) {\r\n      this.checkBytes.push(this._handler);\r\n    }\r\n  };\r\n\r\n  public parseBlock = () => {\r\n    const block = {\r\n      sentinel: this._st.readByte(),\r\n      type: ''\r\n    };\r\n    const blockChar = String.fromCharCode(block.sentinel);\r\n    switch (blockChar) {\r\n      case '!':\r\n        block.type = 'ext';\r\n        this.parseExt(block);\r\n        break;\r\n      case ',':\r\n        block.type = 'img';\r\n        this.parseImg(block);\r\n        break;\r\n      case ';':\r\n        block.type = 'eof';\r\n        if (this._handler.eof && this._handler.eof(block)) {\r\n          this.checkBytes.push(this._handler.eof);\r\n        }\r\n        break;\r\n      default:\r\n        throw new Error('Unknown block: 0x' + block.sentinel.toString(16));\r\n    }\r\n\r\n    if (block.type !== 'eof') {\r\n      this.parseBlock();\r\n    }\r\n  };\r\n\r\n  arrayToImage = (frame: GifFrame) => {\r\n    let count = 0;\r\n    const c = document.createElement('canvas');\r\n    c.id = count.toString();\r\n    c.width = frame.width;\r\n    c.height = frame.height;\r\n    count++;\r\n    const context = c.getContext('2d');\r\n    const pixSize = 1;\r\n    let y = 0;\r\n    let x = 0;\r\n    for (let i = 0; i < frame.pixels.length; i++) {\r\n      if (x % frame.width === 0) {\r\n        y++;\r\n        x = 0;\r\n      }\r\n      if (this.globalColorTable[frame.pixels[i]] === this._transparentColor.toHex()) {\r\n        context.fillStyle = `rgba(0, 0, 0, 0)`;\r\n      } else {\r\n        context.fillStyle = this.globalColorTable[frame.pixels[i]];\r\n      }\r\n\r\n      context.fillRect(x, y, pixSize, pixSize);\r\n      x++;\r\n    }\r\n    const img = new Image();\r\n    img.src = c.toDataURL();\r\n    this.images.push(img);\r\n  };\r\n}\r\n","import { BoundingBox } from '../Collision/BoundingBox';\r\nimport { Color } from '../Color';\r\nimport { Vector } from '../Math/vector';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { Graphic } from './Graphic';\r\n\r\nexport interface LineOptions {\r\n  start: Vector;\r\n  end: Vector;\r\n  color?: Color;\r\n  thickness?: number;\r\n}\r\nexport class Line extends Graphic {\r\n  readonly start: Vector;\r\n  readonly end: Vector;\r\n  color: Color = Color.Black;\r\n  thickness: number = 1;\r\n  constructor(options: LineOptions) {\r\n    super();\r\n    const { start, end, color, thickness } = options;\r\n    this.start = start;\r\n    this.end = end;\r\n    this.color = color ?? this.color;\r\n    this.thickness = thickness ?? this.thickness;\r\n    const { width, height } = BoundingBox.fromPoints([start, end]);\r\n    this.width = width;\r\n    this.height = height;\r\n  }\r\n\r\n  protected _drawImage(ctx: ExcaliburGraphicsContext, _x: number, _y: number): void {\r\n    ctx.drawLine(this.start, this.end, this.color, this.thickness);\r\n  }\r\n\r\n  clone(): Line {\r\n    return new Line({\r\n      start: this.start,\r\n      end: this.end,\r\n      color: this.color,\r\n      thickness: this.thickness\r\n    });\r\n  }\r\n}","import { ImageFiltering } from '.';\r\nimport { Vector, vec } from '../Math/vector';\r\nimport { Raster, RasterOptions } from './Raster';\r\n\r\nexport interface PolygonOptions {\r\n  points: Vector[];\r\n}\r\n\r\n/**\r\n * A polygon [[Graphic]] for drawing arbitrary polygons to the [[ExcaliburGraphicsContext]]\r\n *\r\n * Polygons default to [[ImageFiltering.Blended]]\r\n */\r\nexport class Polygon extends Raster {\r\n  private _points: Vector[];\r\n  public get points(): Vector[] {\r\n    return this._points;\r\n  }\r\n  public set points(points: Vector[]) {\r\n    this._points = points;\r\n    const min = this.minPoint;\r\n    this.width = this._points.reduce((max, p) => Math.max(p.x, max), 0) - min.x;\r\n    this.height = this._points.reduce((max, p) => Math.max(p.y, max), 0) - min.y;\r\n    this.flagDirty();\r\n  }\r\n\r\n  public get minPoint() {\r\n    const minX = this._points.reduce((min, p) => Math.min(p.x, min), Infinity);\r\n    const minY = this._points.reduce((min, p) => Math.min(p.y, min), Infinity);\r\n    return vec(minX, minY);\r\n  }\r\n\r\n  constructor(options: RasterOptions & PolygonOptions) {\r\n    super(options);\r\n    this.points = options.points;\r\n    this.filtering = ImageFiltering.Blended;\r\n    this.rasterize();\r\n  }\r\n\r\n  public clone(): Polygon {\r\n    return new Polygon({\r\n      points: this.points.map((p) => p.clone()),\r\n      ...this.cloneGraphicOptions(),\r\n      ...this.cloneRasterOptions()\r\n    });\r\n  }\r\n\r\n  execute(ctx: CanvasRenderingContext2D): void {\r\n    if (this.points && this.points.length) {\r\n      ctx.beginPath();\r\n      // Iterate through the supplied points and construct a 'polygon'\r\n      const min = this.minPoint.negate();\r\n      const firstPoint = this.points[0].add(min);\r\n      ctx.moveTo(firstPoint.x, firstPoint.y);\r\n      this.points.forEach((point) => {\r\n        ctx.lineTo(point.x + min.x, point.y + min.y);\r\n      });\r\n      ctx.lineTo(firstPoint.x, firstPoint.y);\r\n      ctx.closePath();\r\n      if (this.color) {\r\n        ctx.fill();\r\n      }\r\n      if (this.strokeColor) {\r\n        ctx.stroke();\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Future } from './Future';\r\n\r\nclass AsyncWaitQueue<T> {\r\n  // Code from StephenCleary https://gist.github.com/StephenCleary/ba50b2da419c03b9cba1d20cb4654d5e\r\n  private _queue: Future<T>[] = [];\r\n\r\n  public get length(): number {\r\n    return this._queue.length;\r\n  }\r\n\r\n  public enqueue(): Promise<T> {\r\n    const future = new Future<T>();\r\n    this._queue.push(future);\r\n    return future.promise;\r\n  }\r\n\r\n  public dequeue(value: T): void {\r\n    const future = this._queue.shift();\r\n    future.resolve(value);\r\n  }\r\n}\r\n\r\n/**\r\n * Semaphore allows you to limit the amount of async calls happening between `enter()` and `exit()`\r\n *\r\n * This can be useful when limiting the number of http calls, browser api calls, etc either for performance or to work\r\n * around browser limitations like max Image.decode() calls in chromium being 256.\r\n */\r\nexport class Semaphore {\r\n  private _waitQueue = new AsyncWaitQueue();\r\n  constructor(private _count: number) { }\r\n\r\n  public get count() {\r\n    return this._count;\r\n  }\r\n\r\n  public get waiting() {\r\n    return this._waitQueue.length;\r\n  }\r\n\r\n  public async enter() {\r\n    if (this._count !== 0) {\r\n      this._count--;\r\n      return Promise.resolve();\r\n    }\r\n    return this._waitQueue.enqueue();\r\n  }\r\n\r\n  public exit(count: number = 1) {\r\n    if (count === 0) {\r\n      return;\r\n    }\r\n    while (count !== 0 && this._waitQueue.length !== 0) {\r\n      this._waitQueue.dequeue(null);\r\n      count--;\r\n    }\r\n    this._count += count;\r\n  }\r\n}","/**\r\n * The current Excalibur version string\r\n * @description `process.env.__EX_VERSION` gets replaced by Webpack on build\r\n */\r\nexport const EX_VERSION = process.env.__EX_VERSION;\r\nimport { polyfill } from './Polyfill';\r\npolyfill();\r\n\r\n// This file is used as the bundle entry point and exports everything\r\n// that will be exposed as the `ex` global variable.\r\nexport * from './Flags';\r\nexport * from './Id';\r\nexport * from './Engine';\r\nexport * from './Screen';\r\nexport { Actor, ActorArgs } from './Actor';\r\nexport * from './Math/Index';\r\nexport * from './Camera';\r\nexport * from './Class';\r\nexport * from './Configurable';\r\nexport * from './Debug/index';\r\nexport * from './EventDispatcher';\r\nexport * from './Events/MediaEvents';\r\nexport * from './Events';\r\nexport * from './Label';\r\nexport { FontStyle, FontUnit, TextAlign, BaseAlign } from './Graphics/FontCommon';\r\nexport * from './Loader';\r\nexport { Particle, ParticleEmitter, ParticleArgs, ParticleEmitterArgs, EmitterType } from './Particles';\r\nexport * from './Collision/Physics';\r\nexport * from './Scene';\r\n\r\nexport * from './TileMap/index';\r\n\r\nexport * from './Timer';\r\nexport * from './Trigger';\r\nexport * from './ScreenElement';\r\n\r\nexport * from './Actions/Index';\r\nexport * from './Collision/Index';\r\n\r\nexport * from './Interfaces/Index';\r\nexport * from './Resources/Index';\r\n\r\nexport * from './EntityComponentSystem/index';\r\n\r\nexport * from './Color';\r\n\r\nexport * from './Graphics/index';\r\n\r\n// ex.Events namespace\r\nimport * as events from './Events';\r\nexport { events as Events };\r\n\r\n// ex.Input namespace\r\nimport * as input from './Input/Index';\r\nexport { input as Input };\r\nexport { PointerComponent } from './Input/Index';\r\nexport { PointerSystem } from './Input/PointerSystem';\r\n\r\n// ex.Util namespaces\r\nimport * as util from './Util/Index';\r\nexport { util as Util };\r\n\r\nexport * from './Util/Browser';\r\nexport * from './Util/Decorators';\r\nexport * from './Util/Detector';\r\nexport * from './Util/EasingFunctions';\r\nexport * from './Util/Observable';\r\nexport * from './Util/Log';\r\nexport * from './Util/Pool';\r\nexport * from './Util/Fps';\r\nexport * from './Util/Clock';\r\nexport * from './Util/WebAudio';\r\nexport * from './Util/Toaster';\r\nexport * from './Util/StateMachine';\r\nexport * from './Util/Future';\r\nexport * from './Util/Semaphore';\r\n\r\n// ex.Deprecated\r\n// import * as deprecated from './Deprecated';\r\n// export { deprecated as Deprecated };\r\n// export * from './Deprecated';\r\n"],"names":["root","factory","exports","module","define","amd","self","entryUnbind","path","Object","keys","isCallable","tryToString","$TypeError","TypeError","argument","isObject","$String","String","toIndexedObject","toAbsoluteIndex","lengthOfArrayLike","createMethod","IS_INCLUDES","$this","el","fromIndex","value","O","length","index","includes","indexOf","fails","METHOD_NAME","method","call","createProperty","$Array","Array","max","Math","start","end","k","fin","undefined","result","n","arraySlice","floor","mergeSort","array","comparefn","middle","insertionSort","merge","element","j","i","left","right","llength","rlength","lindex","rindex","uncurryThis","toString","stringSlice","slice","it","TO_STRING_TAG_SUPPORT","classofRaw","TO_STRING_TAG","wellKnownSymbol","$Object","CORRECT_ARGUMENTS","arguments","tag","key","error","tryGet","callee","hasOwn","ownKeys","getOwnPropertyDescriptorModule","definePropertyModule","target","source","exceptions","defineProperty","f","getOwnPropertyDescriptor","DESCRIPTORS","createPropertyDescriptor","object","bitmap","enumerable","configurable","writable","toPropertyKey","propertyKey","makeBuiltIn","defineGlobalProperty","options","simple","name","global","unsafe","nonConfigurable","nonWritable","P","get","document","EXISTS","createElement","firefox","match","UA","test","getBuiltIn","version","userAgent","process","Deno","versions","v8","split","webkit","CONSTRUCTOR","METHOD","prototype","createNonEnumerableProperty","defineBuiltIn","copyConstructorProperties","isForced","targetProperty","sourceProperty","descriptor","TARGET","GLOBAL","STATIC","stat","dontCallGetSet","forced","sham","exec","bind","hasOwnProperty","NATIVE_BIND","Function","apply","FunctionPrototype","getDescriptor","PROPER","CONFIGURABLE","fn","aFunction","namespace","aCallable","V","func","check","globalThis","window","g","this","toObject","a","classof","propertyIsEnumerable","store","functionToString","inspectSource","set","has","NATIVE_WEAK_MAP","shared","sharedKey","hiddenKeys","OBJECT_ALREADY_INITIALIZED","WeakMap","state","wmget","wmhas","wmset","metadata","facade","STATE","enforce","getterFor","TYPE","type","replacement","feature","detection","data","normalize","POLYFILL","NATIVE","string","replace","toLowerCase","isPrototypeOf","USE_SYMBOL_AS_UID","$Symbol","toLength","obj","CONFIGURABLE_FUNCTION_NAME","InternalStateModule","enforceInternalState","getInternalState","CONFIGURABLE_LENGTH","TEMPLATE","getter","setter","arity","constructor","join","ceil","trunc","x","V8_VERSION","getOwnPropertySymbols","symbol","Symbol","IE8_DOM_DEFINE","V8_PROTOTYPE_DEFINE_BUG","anObject","$defineProperty","$getOwnPropertyDescriptor","ENUMERABLE","WRITABLE","Attributes","current","propertyIsEnumerableModule","internalObjectKeys","concat","getOwnPropertyNames","push","names","enumBugKeys","$propertyIsEnumerable","NASHORN_BUG","input","pref","val","valueOf","getOwnPropertyNamesModule","getOwnPropertySymbolsModule","uid","SHARED","IS_PURE","mode","copyright","license","toIntegerOrInfinity","min","integer","IndexedObject","requireObjectCoercible","number","isSymbol","getMethod","ordinaryToPrimitive","TO_PRIMITIVE","exoticToPrim","toPrimitive","id","postfix","random","NATIVE_SYMBOL","iterator","WellKnownSymbolsStore","symbolFor","createWellKnownSymbol","withoutSetter","description","$","deletePropertyOrThrow","internalSort","arrayMethodIsStrict","FF","IE_OR_EDGE","V8","WEBKIT","un$Sort","sort","FAILS_ON_UNDEFINED","FAILS_ON_NULL","STRICT_METHOD","STABLE_SORT","code","chr","fromCharCode","v","b","charAt","proto","itemsLength","items","arrayLength","y","getSortCompare","nativeKeys","___CSS_LOADER_EXPORT___","cssWithMappingToString","list","map","item","content","needLayer","modules","media","dedupe","supports","layer","alreadyImportedModules","_k","cssMapping","btoa","base64","unescape","encodeURIComponent","JSON","stringify","sourceMapping","sourceURLs","sources","sourceRoot","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","__esModule","d","definition","o","e","prop","r","toStringTag","polyfill","audioContext","requestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","callback","setInterval","cancelAnimationFrame","webkitCancelAnimationFrame","mozCancelAnimationFrame","AudioContext","webkitAudioContext","replaceMe","decodeAudioData","arrayBuffer","Promise","resolve","reject","mozAudioContext","msAudioContext","oAudioContext","devicePixelRatio","Flags","static","enable","_FROZEN","_FLAGS","flagName","Error","createId","BITMASK32","Random","seed","_lowerMask","_upperMask","_w","_n","_m","_a","_u","_s","_b","_t","_c","_l","_f","_mt","Date","now","s","_index","_twist","mag01","nextInt","next","floating","bool","likelihood","pickOne","pickSet","numPicks","allowDuplicates","_pickSetWithDuplicates","_pickSetWithoutDuplicates","currentPick","tempArray","splice","shuffle","swap","randomIndex","range","d4","d6","d8","d10","d12","d20","TwoPI","PI","frac","sign","clamp","canonicalizeAngle","angle","tmpAngle","toDegrees","radians","toRadians","degrees","from","to","_x","randomInRange","randomIntInRange","round","Vector","_y","Zero","One","Half","Up","Down","Left","Right","cos","sin","vec","isNaN","Infinity","vec1","vec2","sqrt","pow","setTo","equals","vector","tolerance","abs","distance","deltaX","deltaY","squareDistance","clampMagnitude","magnitude","newSize","size","newLength","scale","average","add","sizeOrScale","dest","sub","addEqual","subEqual","scaleEqual","dot","cross","num","perpendicular","normal","negate","toAngle","atan2","rotate","anchor","sinAngle","cosAngle","clone","fixed","toFixed","LogLevel","Side","MatrixLocations","EventTypes","ImageFiltering","Logger","_appenders","defaultLevel","Info","_INSTANCE","addAppender","ConsoleAppender","appender","clearAppenders","_log","level","args","len","log","debug","Debug","info","warn","Warn","fatal","Fatal","console","consoleArgs","unshift","ScreenAppender","width","height","_messages","_canvas","innerWidth","innerHeight","style","position","_ctx","getContext","body","appendChild","message","clearRect","pos","opacity","fillStyle","fillText","Color","parseInt","parseFloat","hex","h","l","HSLColor","toRGBA","lighten","factor","temp","fromRGBA","darken","saturate","desaturate","multiply","color","newR","newG","newB","newA","screen","color1","invert","color2","equal","format","toHSLA","toHex","_componentToHex","c","Black","fromHex","White","Gray","LightGray","DarkGray","Yellow","Orange","Red","Vermilion","Rose","Magenta","Violet","Blue","Azure","Cyan","Viridian","Green","Chartreuse","Transparent","ExcaliburBlue","p","q","t","hue2rgb","getOpposite","side","Top","Bottom","None","fromDirection","direction","directions","directionEnum","Number","MAX_VALUE","maxIndex","BoundingBox","leftOrOptions","top","bottom","intersection","points","minX","minY","maxX","maxY","hasZeroDimensions","center","translate","point","getPoints","fromPoints","shifted","transform","matrix","xa1","xa2","xb1","xb2","ya1","ya2","yb1","yb2","matrixPos","getPosition","getPerimeter","results","rayCast","ray","farClipDistance","tmin","tmax","xinv","dir","yinv","tx1","tx2","ty1","ty2","rayCastTime","contains","combine","other","dimensions","overlaps","epsilon","totalBoundingBox","intersect","overlapX","overlapY","intersectWithSide","bb","getSideFromIntersection","draw","ex","drawRect","Future","_isCompleted","promise","_resolver","_rejecter","isCompleted","oLeft","oTop","calcOffsetLeft","parent","offsetLeft","offsetParent","calcOffsetTop","offsetTop","addItemToArray","removeItemFromArray","fail","delay","milliseconds","clock","future","schedule","setTimeout","Matrix","Float32Array","_scaleX","_scaleSignX","_scaleY","_scaleSignY","near","far","mat","toDOMMatrix","DOMMatrix","reset","identity","sx","sy","angleRadians","vectorOrMatrix","resultX","resultY","a11","a21","a31","a41","a12","a22","a32","a42","a13","a23","a33","a43","a14","a24","a34","a44","b11","b21","b31","b41","b12","b22","b32","b42","b13","b23","b33","b43","b14","b24","b34","b44","getScale","setPosition","sine","cosine","setRotation","currentScale","getRotation","getScaleY","getScaleX","xscale","yscale","setScaleX","setScaleY","setScale","getBasisDeterminant","getAffineInverse","inverseDet","m","tx","ty","isIdentity","AffineMatrix","Float64Array","_scale","determinant","inverse","to4x4","TransformStack","_transforms","_currentTransform","save","restore","pop","StateStack","_states","_currentState","_getDefaultState","z","tint","_cloneState","GameEvent","_bubbles","bubbles","stopPropagation","KillEvent","super","PreKillEvent","PostKillEvent","GameStartEvent","GameStopEvent","PreDrawEvent","ctx","delta","PostDrawEvent","PreDebugDrawEvent","PostDebugDrawEvent","PreUpdateEvent","engine","PostUpdateEvent","PreFrameEvent","prevStats","PostFrameEvent","stats","GamepadConnectEvent","gamepad","GamepadDisconnectEvent","GamepadButtonEvent","button","GamepadAxisEvent","axis","VisibleEvent","HiddenEvent","PreCollisionEvent","actor","PostCollisionEvent","ContactStartEvent","contact","ContactEndEvent","CollisionPreSolveEvent","CollisionPostSolveEvent","CollisionStartEvent","CollisionEndEvent","InitializeEvent","ActivateEvent","context","DeactivateEvent","ExitViewPortEvent","EnterViewPortEvent","EnterTriggerEvent","ExitTriggerEvent","EventDispatcher","_handlers","_wiredEventDispatchers","_deferedHandlerRemovals","clear","_processDeferredHandlerRemovals","eventHandler","_removeHandler","handler","emit","eventName","event","on","off","eventHandlers","once","metaHandler","ev","wire","eventDispatcher","unwire","Resource","responseType","bustCache","logger","getInstance","events","isLoaded","_cacheBust","uri","load","request","XMLHttpRequest","open","addEventListener","status","response","statusText","send","watch","change","__isProxy","Proxy","watchAny","Graphic","_ID","_transformStale","showDebug","_flipHorizontal","_flipVertical","_rotation","_origin","_width","_height","origin","flipHorizontal","flipVertical","rotation","isStale","cloneGraphicOptions","localBounds","fromDimension","_preDraw","_drawImage","_postDraw","_rotate","_flip","scaleDirX","scaleDirY","Sprite","_logger","_dirty","_logNotLoadedWarning","image","sourceView","destSize","_updateSpriteDimensions","ready","then","newWidth","newHeight","nativeWidth","nativeHeight","drawImage","TextureLoader","_GL","_MAX_TEXTURE_SIZE","getParameter","MAX_TEXTURE_SIZE","_TEXTURE_MAP","filtering","forceUpdate","gl","tex","bindTexture","TEXTURE_2D","texImage2D","RGBA","UNSIGNED_BYTE","createTexture","checkImageSizeSupportedAndLog","pixelStorei","UNPACK_PREMULTIPLY_ALPHA_WEBGL","texParameteri","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","filterMode","TEXTURE_MIN_FILTER","Pixel","NEAREST","LINEAR","TEXTURE_MAG_FILTER","deleteTexture","originalSrc","dataset","_LOGGER","Blended","Map","ImageSource","Image","_readyFuture","_resource","_filtering","endsWith","naturalWidth","naturalHeight","_src","src","async","url","blob","URL","createObjectURL","loadedFuture","onload","setAttribute","toSprite","unload","SpriteSheet","sprites","rows","columns","getSprite","spriteIndex","sourceViews","spacing","grid","cols","spriteWidth","spriteHeight","originOffset","margin","offsetDefaults","marginDefaults","SpriteFont","_text","alphabet","shadow","caseInsensitive","_alreadyWarnedAlphabet","_alreadyWarnedSpriteSheet","spriteSheet","_getCharacterSprites","text","textToRender","toLocaleLowerCase","letterIndex","letter","letterSprite","measureText","lines","maxWidthLine","reduce","sprite","xCursor","yCursor","line","render","_color","bounds","offset","DebugText","fontSheet","_imageSource","_spriteSheet","fromImageSource","_spriteFont","write","RenderSource","_gl","_texture","use","activeTexture","TEXTURE0","disable","RenderTarget","_setupFramebuffer","setResolution","_frameTexture","frameBuffer","_frameBuffer","frameTexture","attachmentPoint","COLOR_ATTACHMENT0","createFramebuffer","bindFramebuffer","FRAMEBUFFER","framebufferTexture2D","toRenderSource","viewport","ExcaliburWebGLContextAccessor","getGlTypeSizeBytes","FLOAT","SHORT","UNSIGNED_SHORT","BYTE","getAttributeComponentSize","LOW_FLOAT","HIGH_FLOAT","FLOAT_VEC2","FLOAT_VEC3","FLOAT_VEC4","getAttributePointerType","Shader","uniforms","attributes","_compiled","vertexSource","fragmentSource","compiled","useProgram","program","_ACTIVE_SHADER_INSTANCE","isCurrentlyBound","compile","vertexShader","_compileShader","VERTEX_SHADER","fragmentShader","FRAGMENT_SHADER","_createProgram","getAttributes","attribute","getUniforms","uniform","uniformCount","getProgramParameter","ACTIVE_UNIFORMS","getActiveUniform","uniformLocation","getUniformLocation","glType","location","attributeCount","ACTIVE_ATTRIBUTES","getActiveAttrib","attributeLocation","getAttribLocation","normalized","setTexture","slotNumber","texture","setUniformInt","setUniform","setUniformIntArray","setUniformBoolean","setUniformFloat","setUniformFloatArray","setUniformFloatVector","setUniformMatrix","uniformType","createProgram","attachShader","linkProgram","LINK_STATUS","getProgramInfoLog","typeName","shader","createShader","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","errorInfo","getShaderInfoLog","_processSourceForError","errorLineStart","search","errorLineEnd","_","error2","VertexBuffer","buffer","createBuffer","bufferData","bindBuffer","ARRAY_BUFFER","STATIC_DRAW","DYNAMIC_DRAW","upload","count","bufferSubData","VertexLayout","_layout","_attributes","_vertexTotalSizeBytes","vertexBuffer","_vertexBuffer","_shader","initialize","totalVertexSizeBytes","shaderAttributes","attrib","componentsPerVertex","vertAttribute","typeSize","uploadBuffer","vert","vertexAttribPointer","enableVertexAttribArray","GraphicsDiagnostics","DrawCallCount","DrawnImagesCount","LineRenderer","priority","_maxLines","_vertexIndex","_lineCount","_context","ortho","_isFull","flush","getTransform","finalStart","finalEnd","hasPendingDraws","drawArrays","LINES","PointRenderer","_maxPoints","_pointCount","_buffer","snapToPixel","finalPoint","pixelSnapEpsilon","POINTS","ScreenPassPainter","renderWithPostProcessor","postprocessor","getShader","getLayout","TRIANGLES","renderToScreen","QuadIndexBuffer","numberOfQuads","useUint16","ELEMENT_ARRAY_BUFFER","totalVertices","maxUint16","maxUint16Index","bufferGlType","Uint16Array","Uint32Array","currentQuad","ImageRenderer","_maxImages","_maxTextures","_imageCount","_textures","MAX_TEXTURE_IMAGE_UNITS","transformedFrag","_transformFragmentSource","_quads","maxTextures","newSource","texturePickerBuilder","_addImageAsTexture","_bindTextures","_getTextureIdForImage","swidth","sheight","dx","dy","dwidth","dheight","view","sw","sh","topLeft","topRight","bottomLeft","bottomRight","textureId","imageWidth","imageHeight","uvx0","uvy0","uvx1","uvy1","drawElements","RectangleRenderer","_maxRectangles","_rectangleCount","drawLine","drawRectangle","thickness","halfThick","startTop","startBottom","endTop","endBottom","stroke","strokeThickness","CircleRenderer","_maxCircles","_circleCount","radius","Pool","builder","recycler","maxObjects","totalAllocations","objects","disableWarnings","preallocate","using","done","borrow","poolIndex","DrawCall","ExcaliburGraphicsContextWebGLDebug","_webglCtx","_debugText","rectOptions","lineOptions","drawPoint","pointOptions","drawText","ExcaliburGraphicsContextWebGL","_renderers","_isDrawLifecycle","useDrawSorting","_drawCallPool","instance","renderer","_drawCalls","_postProcessTargets","_postprocessors","_transform","_state","smoothing","backgroundColor","_alreadyWarnedDrawLifecycle","canvasElement","enableTransparency","__gl","antialias","premultipliedAlpha","alpha","depth","powerPreference","register","_init","canvas","_ortho","checkIfResolutionSupported","dim","supported","clearColor","COLOR_BUFFER_BIT","BLEND","blendEquation","FUNC_ADD","blendFunc","ONE","ONE_MINUS_SRC_ALPHA","blendEquationSeparate","blendFuncSeparate","_screenRenderer","_renderTarget","rendererName","_isCurrentRenderer","_currentRenderer","beginDrawLifecycle","endDrawLifecycle","drawCall","resetTransform","updateViewport","resolution","trace","drawCircle","addPostProcessor","removePostProcessor","clearPostProcessors","originalSort","firstIndex","findIndex","dc","zIndex","originalSortOrder","oldTransform","oldState","currentRendererName","currentRenderer","values","ExcaliburGraphicsContext2DCanvasDebug","_ex","__ctx","strokeStyle","strokeRect","beginPath","moveTo","lineTo","lineWidth","closePath","arc","fill","ExcaliburGraphicsContext2DCanvas","imageSmoothingEnabled","_resolution","globalAlpha","filter","fillRect","setTransform","_postprocessor","DisplayMode","Resolution","SVGA","Standard","Atari2600","GameBoy","GameBoyAdvance","NintendoDS","NES","SNES","Screen","_antialiasing","_resolutionStack","_viewportStack","_pixelRatioOverride","_isFullScreen","_isDisposed","_fullscreenChangeHandler","_pixelRatioChangeHandler","_listenForPixelRatio","_devicePixelRatio","_calculateDevicePixelRatio","applyResolutionAndViewport","_resizeHandler","_setResolutionAndViewportByDisplayMode","_alreadyWarned","_contentArea","_contentResolution","_displayMode","displayMode","Fixed","graphicsContext","antialiasing","_browser","browser","pixelRatio","_applyDisplayMode","_mediaQueryList","removeListener","nativeComponent","matchMedia","addListener","dispose","_resizeObserver","disconnect","removeEventListener","isHiDpi","FillContainer","FitContainer","FitContainerAndFill","FitContainerAndZoom","parentElement","_viewport","aspectRatio","scaledWidth","scaledHeight","setCurrentCamera","camera","_camera","pushResolutionAndViewport","peekViewport","peekResolution","popResolutionAndViewport","imageRendering","isSmooth","isFullScreen","goFullScreen","elementId","maybeElement","getElementById","requestFullscreen","exitFullScreen","exitFullscreen","pageToScreenCoordinates","newX","newY","screenHeight","screenWidth","screenToPageCoordinates","screenMarginY","screenMarginX","screenToWorldCoordinates","worldToScreenCoordinates","pageToWorldCoordinates","worldToPageCoordinates","getWorldBounds","drawWidth","drawHeight","canvasWidth","halfCanvasWidth","canvasHeight","halfCanvasHeight","zoom","halfDrawWidth","halfDrawHeight","contentArea","_computeFit","overflow","aspect","adjustedWidth","adjustedHeight","_computeFitScreenAndFill","vw","vh","_computeFitAndFill","_computeFitContainerAndFill","clientWidth","clientHeight","clip","_computeFitScreenAndZoom","_computeFitAndZoom","_computeFitContainerAndZoom","scaleX","scaleY","maxScaleFactor","zoomedWidth","zoomedHeight","_computeFitContainer","Window","ResizeObserver","observe","FillScreen","FitScreen","FitScreenAndFill","FitScreenAndZoom","AudioContextFactory","WebAudio","_UNLOCKED","create","unlockTimeoutTimer","resume","createBufferSource","ended","connect","destination","onended","playbackState","isLegacyWebAudioSource","currentTime","PLAYING_STATE","FINISHED_STATE","clearTimeout","Class","eventObject","x1","y1","x2","y2","cap","lineCap","roundRect","br","tl","tr","bl","defaultRadius","quadraticCurveTo","circle","Raster","quality","_smoothing","flagDirty","_lineWidth","_lineDash","_padding","strokeColor","lineDash","padding","_bitmap","bitmapWidth","bitmapHeight","maybeCtx","cloneRasterOptions","dirty","_getTotalWidth","_originalWidth","_getTotalHeight","_originalHeight","_strokeColor","rasterize","_applyRasterProperties","execute","setLineDash","getLineDash","Canvas","_options","cache","ExResponse","any","json","arraybuffer","StateMachine","states","currentState","machineDescription","machine","stateName","transitionState","transitions","startState","in","go","eventData","potentialNewState","onExit","onEnter","onState","update","elapsedMs","onUpdate","saveKey","localStorage","setItem","parse","getItem","WebAudioInstance","_audioContext","_volumeNode","createGain","_playingPromise","_playingResolve","_stateMachine","PLAYING","_createNewBufferSource","_handleEnd","_instance","pausedAt","_playbackRate","duration","startedAt","_playStarted","stop","SEEK","STOPPED","PAUSED","_volume","_loop","loop","playbackRate","volume","gain","setTargetAtTime","_duration","getTotalPlaybackDuration","isPlaying","isPaused","play","playStarted","pause","seek","getPlaybackPosition","MediaEvent","_name","_value","_path","_val","action","propagate","layPath","_actor","NativeSoundEvent","track","NativeSoundProcessedEvent","_processedData","canPlayFile","file","Audio","filetype","canPlayType","Sound","paths","_isStopped","_tracks","_wasPlayingOnHidden","instances","audiobuffer","decodeAudio","wireEngine","_engine","pauseAudioWhenHidden","instanceCount","some","_resumePlayback","_startPlayback","forEach","trackId","_getTrackInstance","getTrackId","resumed","all","complete","newTrack","Loader","loadables","_resourceList","_playButtonShown","_resourceCount","_numLoaded","_progressCounts","_totalCounts","logo","logoWidth","logoHeight","loadingBarColor","suppressPlayButton","_playButtonStyles","playButtonText","startButtonFactory","buttonElement","textContent","display","_loadingFuture","addResources","_image","_imageElement","playButtonRootElement","_playButtonRootElement","playButtonElement","_playButtonElement","_playButton","existingRoot","_styleBlock","head","addResource","loadable","resizeHandler","_positionPlayButton","evt","click","playButtonClicked","startButtonHandler","hidePlayButton","removeChild","_delta","areResourcesLoaded","decode","finally","resource","showPlayButton","unlock","markResourceComplete","progress","buttonWidth","buttonHeight","playButtonPosition","logoY","logoX","logoPosition","oldAntialias","getAntialiasing","setAntialiasing","loadingX","loadingY","loadingBarPosition","progressWidth","REPORTED_FEATURES","webgl","webaudio","gamepadapi","Detector","_features","failedTests","_criticalTests","canvasSupport","elem","arrayBufferSupport","xhr","dataUrlSupport","toDataURL","objectUrlSupport","rgbaSupport","cssText","_warningTest","webAudioSupport","webglSupport","_loadBrowserFeatures","getBrowserFeatures","logBrowserFeatures","msg","dataurl","objecturl","rgba","navigator","getGamepads","failedCritical","warning","CollisionType","maxMessages","obsoleteMessage","resetObsoleteCounter","logMessage","suppressObsoleteMessages","isEnabled","showStackTrace","obsolete","alternateMethod","property","SyntaxError","DecoratedClass","CollisionResolutionStrategy","BroadphaseStrategy","Integrator","CoordPlane","Physics","gravity","acc","collisionResolutionStrategy","Arcade","Realistic","dynamicTreeVelocityMultiplyer","dynamicTreeVelocityMultiplier","enabled","broadphaseStrategy","DynamicAABBTree","defaultMass","integrator","Euler","boundsPadding","positionIterations","velocityIterations","slop","steeringFactor","warmStart","bodiesCanSleepByDefault","surfaceEpsilon","sleepEpsilon","wakeThreshold","sleepBias","checkForFastBodies","disableMinimumSpeedForFastBody","VectorView","_getX","getX","_getY","getY","_setX","setX","_setY","setY","WatchVector","original","Transform","_parent","_children","_pos","_isDirty","_isInverseDirty","_matrix","_inverse","children","globalPos","localPos","canonRotation","globalRotation","inverseRotation","globalScale","inverseScale","globalScaleX","globalScaleY","_calculateMatrix","applyInverse","Component","owner","newComponent","TagComponent","Observable","observers","subscriptions","observer","subscribe","unregister","unsubscribe","notifyAll","observersLength","notify","subscriptionsLength","TransformComponent","_addChildTransform","child","childTxComponent","zIndexChanged$","_z","coordPlane","World","onAdd","childrenAdded$","childrenRemoved$","onRemove","_previousOwner","oldz","MotionComponent","vel","scaleFactor","angularVelocity","torque","inertia","CollisionGroup","category","mask","_category","_mask","canCollide","collisionGroups","combinedName","combinedCategory","All","Pair","colliderA","colliderB","calculatePairHash","bodyA","BodyComponent","bodyB","group","collisionType","PreventCollision","active","collide","hasCollider","collider","idA","idB","Projection","projection","getOverlap","TreeNode","isLeaf","DynamicTree","worldBounds","nodes","_insert","leaf","leafAABB","currentRoot","area","combinedArea","cost","inheritanceCost","leftCost","leftCombined","newArea","oldArea","rightCost","rightCombined","oldParent","newParent","currentNode","_balance","_remove","grandParent","sibling","trackCollider","node","updateCollider","untrackCollider","multdx","multdy","balance","getHeight","query","helper","rayCastQuery","getNodes","Ray","numerator","begin","getSlope","divisor","u","getLength","intersectPoint","time","getPoint","DynamicTreeCollisionProcessor","_dynamicCollisionTree","_pairs","Set","_collisionPairCache","_colliders","getColliders","CompositeCollider","colliders","untrack","_pairExists","hash","broadphase","targets","seconds","potentialColliders","pair","physics","pairs","Active","updateDistance","minDimension","fastBodies","updateVec","oldPos","centerPoint","furthestPoint","getFurthestPoint","minCollider","minTranslate","hitPoint","isValid","shift","fastBodyCollisions","narrowphase","contacts","newContacts","collisions","updated","Collider","__compositeColliderId","touching","_collisionProcessor","_dynamicAABBTree","addCollider","clearColliders","removeCollider","worldPos","axes","furthestPoints","bestPoint","maxDistance","getInertia","mass","totalInertia","otherColliders","potentialCollider","getClosestLineBetween","maybeLine","minLength","minLine","minPoint","minDistance","project","projs","proj","newProjection","LineSegment","slope","intercept","_normal","_dir","_slope","getEdge","_length","midpoint","flip","below","sideVector","clipTime","distanceToPoint","signed","x0","y0","findVectorToPoint","aMinusP","findPoint","hasPoint","currPoint","threshold","dxc","dyc","dx1","dy1","ClosestLine","p0","q0","w0","denom","sDenom","tDenom","tClosestParallel","sClosest","tClosest","ClosestLineJumpTable","PolygonPolygonClosestLine","polygonA","polygonB","otherWorldPos","otherDirection","thisDirection","rayTowardsOther","rayTowardsThis","thisPoint","otherPoint","thisFace","getClosestFace","otherFace","face","PolygonEdgeClosestLine","polygon","edge","edgeLine","asLine","PolygonCircleClosestLine","circlex","circley","CircleCircleClosestLine","circleA","circleB","CircleEdgeClosestLine","circleWorlPos","EdgeEdgeClosestLine","edgeA","edgeB","edgeLineA","edgeLineB","CircleCollider","_globalMatrix","_naturalRadius","orig","discriminant","toi","toi1","toi2","positiveToi","mintoi","shape","PolygonCollider","EdgeCollider","CollisionJumpTable","CollideCircleCircle","CollideCirclePolygon","CollideCircleEdge","getFurthestLocalPoint","scalars","dotProduct","CollisionContact","mtv","tangent","localPoints","_canceled","matchAwake","sleeping","sleepMotion","setSleeping","isCanceled","cancel","SeparatingAxis","polyA","polyB","bestSeparation","bestSide","bestAxis","bestSideIndex","bestOtherPoint","sides","getSides","localSides","getLocalSides","vertB","vertSeparation","separation","localSide","sideId","localPoint","polyDir","closestPointOnPoly","minOverlap","minAxis","minIndex","proj1","proj2","overlap","circleAPos","circleBPos","combinedRadius","mvt","local","findCirclePolygonSeparation","samedir","findSide","findLocalSide","cc","edgeWorld","asLocalLine","da","dda","db","ddb","den","pointOnEdge","dd","CollideEdgeEdge","CollidePolygonEdge","pc","linePoly","CollidePolygonPolygon","separationA","findPolygonPolygonSeparation","separationB","incident","reference","refDir","clipRight","clipLeft","xf","FindContactSeparation","shapeA","txA","shapeB","txB","worldPoint","circlePoint","dist","_getTransformedBegin","_getTransformedEnd","transformedBegin","transformedEnd","_boundsFromBeginEnd","edgeNormal","_transformedPoints","_sides","_localSides","_transformedPointsDirty","_sidesDirty","_localSidesDirty","_localBoundsDirty","_isCounterClockwiseWinding","reverse","isConvex","_calculateTransformation","_points","sum","oldPoint","newPoint","oldDirection","orientation","angleSum","entries","tessellate","polygons","Shape","Polygon","triangulate","isPointInTriangle","ab","bc","ca","ap","bp","cp","cross1","cross2","cross3","triangles","vertices","indices","va","vb","vc","leftArm","isEar","vertIndex","getTransformedPoints","currentSide","mostDirection","testRay","accum","pts","POSITIVE_INFINITY","faceIndex","_localBounds","_cachedMass","_cachedInertia","denominator","iplusone","crossTerm","minContactTime","contactIndex","contactTime","scalar","firstPoint","Circle","Box","ColliderComponent","$colliderAdded","$colliderRemoved","_collider","flipped","entity","precollision","postcollision","useBoxCollider","usePolygonCollider","poly","useCircleCollider","useEdgeCollider","Edge","useCompositeCollider","DegreeOfFreedom","RotationType","FontUnit","TextAlign","BaseAlign","FontStyle","Direction","Axis","dependencies","_oldTransform","__oldTransformCaptured","enableFixedUpdateInterpolate","_mass","canSleep","_sleeping","bounciness","friction","useGravity","limitDegreeOfFreedom","oldVel","oldAcc","newMass","_cachedInverseInertia","inverseMass","updateMotion","currentMotion","bias","maybeCollider","inverseInertia","motion","oldRotation","oldScale","applyImpulse","impulse","finalImpulse","X","Y","Rotation","distanceFromCenter","applyLinearImpulse","applyAngularImpulse","captureOldTransform","AddedComponent","isAddedComponent","RemovedComponent","isRemovedComponent","Entity","components","_componentsToRemove","_componentTypeToInstance","_componentStringToInstance","_tagsMemo","_typesMemo","componentAdded$","componentRemoved$","_isInitialized","_setName","component","addComponent","kill","isKilled","tags","hasTag","addTag","removeTag","force","removeComponent","types","_rebuildMemos","getComponents","_notifyAddComponent","added","_notifyRemoveComponent","removed","unparent","addChild","getAncestors","removeAllChildren","getDescendants","queue","curr","newEntity","addTemplate","templateEntity","ctor","constuctorType","componentOrType","_removeComponentByType","delete","processComponentRemoval","isInitialized","_initialize","onInitialize","_preupdate","onPreUpdate","_postupdate","onPostUpdate","hasGraphicsTick","graphic","tick","GraphicsLayer","_graphics","graphics","hide","nameOrGraphic","gfx","getGraphic","recalculateBounds","show","copyGraphics","getNames","order","currentKeys","GraphicsLayers","_component","_layers","_layerMap","default","_maybeAddLayer","_getLayer","graphicsLayerKeys","GraphicsComponent","visible","onPreDraw","onPostDraw","layers","graphicToSet","offsetX","offsetY","elapsed","idempotencyToken","Rectangle","_radius","PointerComponent","useColliderShape","useGraphicsBounds","EasingFunctions","easing","Linear","CreateReversibleEasingFunction","startValue","endValue","EaseInQuad","EaseOutQuad","EaseInOutQuad","EaseInCubic","EaseOutCubic","EaseInOutCubic","ActionQueue","_actions","_completedActions","_entity","remove","clearActions","_currentAction","getActions","hasNext","isComplete","Repeat","repeatBuilder","repeat","_stopped","_repeatBuilder","_repeatContext","ActionContext","_actionQueue","getQueue","_repeat","_originalRepeat","RepeatForever","MoveBy","speed","_started","_tx","_motion","_speed","_offset","_start","_end","_distance","MoveTo","destx","desty","RotateTo","rotationType","_rotationType","ShortestPath","_currentNonCannonAngle","distance1","distance2","_shortDistance","_longDistance","_shortestPathIsPositive","_direction","LongestPath","Clockwise","CounterClockwise","distanceTraveled","RotateBy","angleRadiansOffset","ScaleTo","speedX","speedY","_endX","_endY","_speedX","_speedY","_startX","_startY","_distanceX","_distanceY","directionX","directionY","ScaleBy","scaleOffsetX","scaleOffsetY","_startScale","_endScale","_directionX","_directionY","CallMethod","_method","_hasBeenCalled","EaseTo","easingFcn","_currentLerpTime","_lerpDuration","_lerpStart","_lerpEnd","_initialized","EaseBy","Blink","timeVisible","timeNotVisible","numBlinks","_timeVisible","_timeNotVisible","_elapsedTime","_totalTime","Fade","endOpacity","_multiplier","_endOpacity","_ogspeed","Delay","_delay","Die","ActionsComponent","Follow","entityToFollow","followDistance","_followTx","_followMotion","_current","_maximumDistance","_distanceBetween","actorToFollowSpeed","Meet","actorToMeet","_speedWasSpecified","_meetTx","_meetMotion","actorToMeetSpeed","_queue","runAction","easeTo","easeBy","xOrPos","yOrSpeed","speedOrUndefined","moveBy","xOffsetOrVector","yOffsetOrSpeed","xOffset","yOffset","rotateTo","rotateBy","scaleTo","sizeXOrVector","sizeYOrSpeed","speedXOrUndefined","speedYOrUndefined","sizeX","sizeY","scaleBy","sizeOffsetXOrVector","sizeOffsetYOrSpeed","sizeOffsetX","sizeOffsetY","blink","fade","die","callMethod","times","repeatForever","follow","meet","toPromise","Font","family","Normal","bold","unit","Px","textAlign","baseAlign","Alphabetic","LeftToRight","_textBounds","_cachedTextMeasurement","_bitmapToTextMeasurement","_textToBitmap","_bitmapUsage","_textFragments","blur","fontString","measurementDirty","cached","rasterProps","_getRasterPropertiesHash","_getTextBitmap","_applyFont","metrics","textHeight","actualBoundingBoxAscent","actualBoundingBoxDescent","lineAdjustedHeight","bottomBounds","measurement","actualBoundingBoxLeft","actualBoundingBoxRight","_setDimension","textBounds","textBaseline","font","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY","_drawText","colorOverride","lineHeight","strokeText","textAndHash","_splitTextBitmap","textImages","currentX","currentY","clearCache","checkAndClearCache","isNewBitmap","frag","performance","cacheSize","Text","_textWidth","_textHeight","_font","_calculateDimension","Actor","config","_anchor","_handleAnchorChange","scene","_draggable","_dragging","_pointerDragStartHandler","_pointerDragEndHandler","_pointerDragMoveHandler","pe","_pointerDragLeaveHandler","collisionGroup","defaults","Passive","pointer","actions","thePos","theVel","theAcc","theAngle","isOffScreen","draggable","isDraggable","currentGraphic","_prekill","_scene","onPreKill","_postkill","onPostKill","unkill","newZ","getGlobalPos","localCenter","getGlobalScale","getGlobalRotation","recurse","geom","containment","within","otherCollider","me","isScreenElement","ScreenElement","useWorld","coords","Timer","fcn","interval","repeats","numberOfRepeats","randomRange","_totalTimeAlive","_running","_numberOfTicks","maxNumberOfRepeats","_baseInterval","_generateRandomInterval","_complete","_MAX_ID","_callbacks","newInterval","newNumberOfRepeats","timesRepeated","getTimeRunning","timeToNextAction","timeElapsedTowardNextAction","isRunning","cancelTimer","ParallaxComponent","parallaxFactor","DebugGraphicsComponent","useTransform","TileMap","_token","_onScreenXStart","_onScreenXEnd","_onScreenYStart","_onScreenYEnd","tiles","_rows","_cols","renderFromTopOfGraphic","_collidersDirty","_originalOffsets","_composite","_oldPos","tileWidth","tileHeight","currentCol","cd","Tile","flagCollidersDirty","_getOrSetColliderOriginalOffset","originalOffset","_updateColliders","tile","solid","prev","getTileByIndex","getTile","getTileByPoint","getRows","getColumns","worldCoordsUpperLeft","worldCoordsLowerRight","maybeParallax","parallaxOffset","oneMinusFactor","currentScene","xEnd","yEnd","graphicsIndex","graphicsLen","getGraphics","grayish","_posDirty","_solid","_recalculate","addGraphic","removeGraphic","clearGraphics","_bounds","StrategyContainer","lockToActor","addStrategy","LockCameraToActorStrategy","lockToActorAxis","LockCameraToActorAxisStrategy","elasticToActor","cameraElasticity","cameraFriction","ElasticToActorStrategy","radiusAroundActor","RadiusAroundActorStrategy","limitCameraBounds","box","LimitCameraBoundsStrategy","_cam","_eng","cam","currentFocus","getFocus","focus","cameraVel","stretch","boundSizeChecked","focusX","focusY","Camera","_cameraStrategies","strategy","dz","az","_angularVelocity","_posChanged","_cameraMoving","_isShaking","_shakeMagnitudeX","_shakeMagnitudeY","_shakeDuration","_elapsedShakeTime","_xShake","_yShake","_isZooming","_zoomStart","_zoomEnd","_currentZoomTime","_zoomDuration","_zoomEasing","_easing","_halfWidth","_halfHeight","_follow","ax","ay","move","easingFn","_lerpPromise","_lerpResolve","shake","magnitudeX","magnitudeY","zoomOverTime","_zoomPromise","_zoomResolve","cameraStrategy","removeStrategy","clearAllStrategies","_screen","currentRes","loadingComplete","res","updateTransform","runStrategies","newZoom","zoomEasing","lerpPoint","CreateVectorEasingFunction","moveEasing","_isDoneShaking","newCanvasWidth","newCanvasHeight","cameraPos","triggerDefaults","Trigger","opts","_dispatchAction","_target","SystemType","System","_entityAddedOrRemoved","AddedEntity","isAddedSystemEntity","RemovedEntity","isRemoveSystemEntity","EntityManager","_world","entities","_entityIndex","_entitiesToRemove","updateEntities","removeEntity","findEntitiesForRemoval","queryManager","addEntity","idOrEntity","deferred","currFrame","actors","killed","processEntityRemovals","processComponentRemovals","getById","getByName","buildTypeKey","localeCompare","Query","_entities","T","_key","getEntities","matches","typesOrEntity","contain","QueryManager","_queries","_addQuery","entityManager","maybeRemoveQuery","queryType","createQuery","maybeExistingQuery","getQuery","SystemManager","systems","initialized","systemType","find","addSystem","system","removeSystem","updateSystems","preupdate","Scene","postupdate","systemManager","Update","entityOrSystem","clearEntities","clearSystems","EulerIntegrator","totalAcc","_ACC","_VEL","_POS","_VEL_ACC","_SCALE_FACTOR","_SCALE","MotionSystem","optionalBody","integrate","ArcadeSolver","directionMap","distanceMap","solve","preSolve","solvePosition","solveVelocity","postSolve","opposite","velAdj","ContactConstraintPoint","normalImpulse","tangentImpulse","normalMass","tangentMass","aToContact","bToContact","originalVelocityAndRestitution","aToContactNormal","bToContactNormal","aToContactTangent","bToContactTangent","getRelativeVelocity","velA","RealisticSolver","lastFrameContacts","idToContactConstraint","getContactConstraints","finishedContactIds","contactPoints","pointIndex","restitution","relativeVelocity","constraints","maxCorrection","steeringForce","impulseForce","impulseDelta","maxFriction","newImpulse","normalVelocity","CollisionSystem","_realisticSolver","_arcadeSolver","_processor","_lastFrameContacts","_currentFrameContacts","_trackCollider","_untrackCollider","colliderComponent","colliderComp","compositeColliders","getSolver","compositeId","substring","runContactStartEnd","AnimationDirection","AnimationStrategy","EmitterType","ColorBlindnessMode","Animation","frames","Loop","frameDuration","timeScale","_idempotencyToken","_firstTick","_currentFrame","_timeLeftInFrame","_done","_playing","_reversed","totalDuration","goToFrame","maybeFrame","currentFrame","frameIndices","durationPerFrameMs","invalidIndices","currentFrameIndex","Backward","Forward","canFinish","End","Freeze","frameNumber","_nextFrame","PingPong","elapsedMilliseconds","GraphicsGroup","members","_updateDimensions","_isAnimationOrGroup","member","maybeAnimation","Configurable","base","assign","props","ParticleImpl","emitterOrConfig","life","beginColor","endColor","velocity","acceleration","startSize","endSize","particleRotationalVelocity","currentRotation","focusAccel","fadeFlag","_rRate","_gRate","_bRate","_aRate","_currentColor","emitter","particleSize","particleSprite","sizeRate","elapsedMultiplier","isOffscreen","ParticleEmitter","tmpColor","removeParticle","accel","Particle","_particlesToEmit","numParticles","isEmitting","particles","deadParticles","minVel","maxVel","minAngle","maxAngle","emitRate","particleLife","minSize","maxSize","_sprite","emitterType","randomRotation","particle","emitParticles","particleCount","_createParticle","world","clearParticles","ranX","ranY","GraphicsSystem","Draw","_sortedTransforms","_zHasChanged","_zIndexUpdate","sortedTransforms","_graphicsContext","entityAddedOrRemoved","parallax","_applyTransform","particleOpacity","_drawGraphicsComponent","graphicsComponent","isDebug","showBounds","boundsColor","ancestors","ancestor","interpolatedPos","interpolatedScale","interpolatedRotation","fixedUpdateFps","blend","currentFrameLagMs","DebugSystem","_collisionSystem","filterSettings","entitySettings","txSettings","motionSettings","colliderSettings","physicsSettings","graphicsSettings","debugDraw","bodySettings","cameraSettings","useFilter","ids","nameQuery","cursor","_pushCameraTransform","showAll","showPosition","positionColor","showPositionLabel","showZIndex","showId","showName","showRotation","fromAngle","rotationColor","showScale","scaleColor","showCollisionGroup","showCollisionType","showMass","showMotion","showSleeping","showVelocity","velocityColor","showAcceleration","accelerationColor","showGeometry","geometryColor","showOwner","_popCameraTransform","showBroadphaseSpacePartitionDebug","showCollisionContacts","showCollisionNormals","collisionContactColor","collisionNormalColor","showFocus","focusColor","showZoom","PointerSystem","overrideUseColliderShape","overrideUseGraphicsBounds","lastFrameEntityToPointers","currentFrameEntityToPointers","_sortedEntities","_receiver","pointers","entityCurrentlyUnderPointer","pointerId","entityWasUnderPointer","entered","addPointerToEntity","_processPointerToEntity","_dispatchEvents","currentFramePointerCoords","screenPos","graphicBounds","_processDownAndEmit","lastDownPerPointer","currentFrameDown","isDragStart","_processUpAndEmit","lastUpPerPointer","currentFrameUp","isDragEnd","_processMoveAndEmit","lastMovePerPointer","currentFrameMove","isDragging","_processEnterLeaveAndEmit","lastUpDownMoveEvents","_processCancelAndEmit","currentFrameCancel","_processWheelAndEmit","currentFrameWheel","lastFrameEntities","currentFrameEntities","entitiesWithEvents","ActionsSystem","IsometricEntityComponent","elevation","IsometricEntitySystem","iso","OffscreenSystem","entityOffscreen","_isOffscreen","transformedBounds","_timers","_cancelQueue","triggers","tileMaps","timers","onActivate","onDeactivate","_initializeChildren","_activate","_deactivate","_predraw","_postdraw","removeTimer","timer","_collectActorStats","addTimer","isTimerActive","isCurrentScene","screenElements","_ui","ui","alive","ScreenShader","ColorBlindnessPostProcessor","_colorBlindnessMode","simulate","_simulate","colorBlindnessMode","colorBlindMode","Protanope","Deuteranope","Tritanope","ColorBlindFlags","_colorBlindPostProcessor","correct","colorBlindness","FrameStats","prevFrame","useTestClock","wasRunning","testClock","toTestClock","useStandardClock","currentClock","standardClock","toStandardClock","_id","_fps","_actorStats","remaining","total","_durationStats","_physicsStats","PhysicsStats","_graphicsStats","drawCalls","drawnImages","otherStats","fps","fs","_collisions","_contacts","_fastBodies","_fastBodyCollisions","_broadphase","_narrowphase","ps","PointerScope","Keys","Buttons","Axes","WheelDeltaMode","NativePointerButton","PointerButton","PointerType","KeyEvent","originalEvent","Keyboard","_keys","_keysUp","_keysDown","_handleKeyDown","keyEvent","_handleKeyUp","init","noop","getKeys","wasPressed","isHeld","wasReleased","triggerEvent","character","KeyboardEvent","Gamepads","_gamePadTimeStamps","_oldPads","_pads","_initSuccess","_navigator","_minimumConfiguration","_clonePads","setMinimumGamepadConfiguration","_enableAndUpdate","_isGamepadValid","pad","axesLength","buttonLength","buttons","connected","gamepads","at","timestamp","bi","ai","navigatorGamepad","getButton","pressed","updateButton","getAxes","updateAxes","_clonePad","Gamepad","getValidGamepads","pads","arr","clonedPad","MinAxisMoveThreshold","_buttons","_axes","isButtonPressed","buttonIndex","axesIndex","BrowserComponent","_paused","_nativeHandlers","_decorate","BrowserEvents","_windowGlobal","_documentGlobal","_windowComponent","_documentComponent","GlobalCoordinates","pagePos","yOrEngine","engineOrUndefined","pageX","pageY","PointerEvent","pointerType","coordinates","nativeEvent","WheelEvent","screenX","screenY","deltaZ","deltaMode","PointerAbstraction","lastPagePos","lastScreenPos","lastWorldPos","_onPointerMove","_onPointerDown","PointerEventReceiver","primary","_activeNativePointerIdsToNormalized","lastFramePointerCoords","currentFramePointerDown","lastFramePointerDown","_pointers","_boundHandle","_handle","_boundWheel","_handleWheel","recreate","eventReceiver","isDown","wasDown","native","touchAction","wheelOptions","passive","pageScrollPreventionMode","ScrollPreventionMode","onmousewheel","detach","_normalizePointerId","nativePointerId","preventDefault","eventCoords","TouchEvent","Unknown","Touch","changedTouches","touch","fromPagePosition","_nativeButtonToPointerButton","Mouse","isPointerEvent","_stringToPointerType","coord","ScrollWheelNormalizationFactor","wheelDeltaX","wheelDeltaY","wheelDelta","detail","Line","Page","we","page","clientX","clientY","MouseEvent","pointerSystem","transformEntities","NoButton","Middle","Pen","FpsSampler","_samplePeriod","_currentFrameTime","_frames","_previousSampleTime","_beginFrameTime","initialFps","samplePeriod","_nowFn","nowFn","instant","Clock","_onFatalException","_maxFps","_lastTime","_elapsed","_scheduledCbs","_totalElapsed","maxFps","onFatalException","fpsSampler","TestClock","defaultUpdateMs","StandardClock","setFatalExceptionHandler","cb","timeoutMs","scheduledTime","_runScheduledCbs","overrideUpdateMs","fpsInterval","leftover","mainloop","_requestId","_currentTime","_updateMs","step","run","numberOfSteps","Toaster","_toasterCss","_container","_createFragment","toastMessage","innerText","toast","linkTarget","linkName","className","messageFragments","link","href","finalMessage","dismissBtn","keydownHandler","first","firstChild","insertBefore","Engine","scenes","_suppressPlayButton","_isDebug","enableCanvasTransparency","_toaster","_timescale","_deferredGoTo","_originalOptions","_performanceThresholdTriggered","_fpsSamples","_loadingComplete","_isReady","_isReadyPromise","_isReadyResolve","currentFrameElapsedMs","_lagMs","_screenShotRequests","_DEFAULT_ENGINE_OPTIONS","freeze","detector","suppressMinimumBrowserFeatureDetection","_compatible","testMessage","canvasElementId","suppressConsoleBootMessage","EX_VERSION","_originalDisplayMode","useCanvasGraphicsContext","suppressHiDPIScaling","_mainloop","_loader","rootScene","addScene","___EXCALIBUR_DEVTOOL","isFullscreen","shouldSnapToPixel","_monitorPerformanceThresholdAndTriggerFallback","allow","configurePerformanceCanvas2DFallback","showPlayerMessage","numberOfFrames","useCanvas2DFallback","newCanvas","cloneNode","parentNode","replaceChild","pointerTarget","pointerScope","timescale","removeScene","goToScene","previousScene","nextScene","scrollPreventionMode","hidden","visibilityChange","keyboard","_overrideInitialize","deferredScene","_update","_draw","_checkForScreenShots","toggle","toggleDebug","isReady","loader","frameId","beforeUpdate","fixedTimestepMs","afterUpdate","afterDraw","screenshot","preserveHiDPIResolution","finalWidth","finalHeight","raw","Label","spriteFont","newFont","sf","getTextWidth","IsometricTile","graphicsOffset","_tileBounds","_isometricEntityComponent","halfTileWidth","halfTileHeight","xPos","yPos","_gfx","totalWidth","totalHeight","_recalculateBounds","tileToWorld","IsometricMap","updateColliders","worldToTile","worldCoordinate","tileCoordinate","tileCoord","_getMaxZIndex","maxZ","NEGATIVE_INFINITY","currentZ","ActionSequence","actionBuilder","_sequenceBuilder","_sequenceContext","ParallelActions","parallelActions","every","CollisionGroupManager","_CURRENT_GROUP","_MAX_GROUPS","_GROUPS","_CURRENT_BIT","groups","_STARTING_BIT","has_initialize","hasOnInitialize","has_preupdate","hasOnPreUpdate","has_postupdate","hasOnPostUpdate","hasPreDraw","hasPostDraw","Gif","_stream","_gif","_animation","_transparentColor","Stream","ParseGif","images","toSpriteSheet","toAnimation","fromSpriteSheet","readCheckBytes","checkBytes","bitsToNum","ba","byteToBitArr","bite","dataArray","readByte","byteLength","readBytes","bytes","read","readUnsigned","Uint8Array","stream","_st","_handler","globalColorTable","parseColorTable","ct","readSubBlocks","parseHeader","hdr","sig","ver","colorRes","globalColorTableSize","gctFlag","sorted","bgColor","pixelAspectRatio","bits","parseExt","block","parseGCExt","reserved","disposalMethod","userInput","transparencyGiven","delayTime","transparencyIndex","terminator","gce","parseComExt","comment","com","parsePTExt","ptHeader","ptData","pte","parseAppExt","parseNetscapeExt","unknown","iterations","app","NETSCAPE","parseUnknownAppExt","appData","identifier","authCode","parseUnknownExt","label","extType","parseImg","img","leftPos","topPos","lctFlag","interlaced","lctSize","lct","lzwMinCodeSize","lzwData","pixels","minCodeSize","readCode","charCodeAt","output","clearCode","eoiCode","codeSize","dict","last","lzwDecode","newPixels","cpRow","toRow","fromRow","fromPixels","offsets","steps","pass","deinterlace","arrayToImage","parseBlock","sentinel","eof","frame","AsyncWaitQueue","enqueue","dequeue","Semaphore","_count","_waitQueue","waiting","exit"],"sourceRoot":""}